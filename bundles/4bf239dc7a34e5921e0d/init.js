(window.webpackJsonp=window.webpackJsonp||[]).push([[18],[,,function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.JoinCall="io.element.join",e.HangupCall="im.vector.hangup",e.CallParticipants="io.element.participants",e.MuteAudio="io.element.mute_audio",e.UnmuteAudio="io.element.unmute_audio",e.MuteVideo="io.element.mute_video",e.UnmuteVideo="io.element.unmute_video",e.StartLiveStream="im.vector.start_live_stream",e.ScreenshareRequest="io.element.screenshare_request",e.ScreenshareStart="io.element.screenshare_start",e.ScreenshareStop="io.element.screenshare_stop",e.TileLayout="io.element.tile_layout",e.SpotlightLayout="io.element.spotlight_layout",e.OpenIntegrationManager="integration_manager_open",e.ViewRoom="io.element.view_room"}(i||(i={}))},,,,,,,,,,function(e,t,n){"use strict";async function i(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";""===e||e.endsWith("/")||(e+="/");const t=s(`${e}config.${document.domain}.json`),n=s(e+"config.json");try{const e=await t;if(0===Object.keys(e).length)throw new Error;return e}catch(e){return n}}async function s(e){const t=new URL(e,window.location.href);t.searchParams.set("cachebuster",Date.now().toString());const n=await fetch(t,{cache:"no-cache",method:"GET"});return 404===n.status||0===n.status?{}:n.ok?n.json():void 0}n.d(t,"a",(function(){return i}))},,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{constructor(e){this.obj=e}get(e,t){const n=this.obj[e];return void 0!==n?n:this.obj[null!=t?t:(i=e,i.replace(/._./g,(e=>`${e[0]}${e[2].toUpperCase()}`)))];var i}toJSON(){return this.obj}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.r(t),n.d(t,"rageshakePromise",(function(){return Q})),n.d(t,"preparePlatform",(function(){return X})),n.d(t,"setupLogStorage",(function(){return Z})),n.d(t,"loadConfig",(function(){return ee})),n.d(t,"loadOlm",(function(){return te})),n.d(t,"loadLanguage",(function(){return ne})),n.d(t,"loadTheme",(function(){return ie})),n.d(t,"loadApp",(function(){return se})),n.d(t,"showError",(function(){return oe})),n.d(t,"showIncompatibleBrowser",(function(){return re})),n.d(t,"loadModules",(function(){return ae})),n.d(t,"_t",(function(){return ce}));var i=n(1004),s=n(1005),o=n.n(s),r=n(188),a=n(120),c=n.n(a),l=n(121),d=n(126),u=n(156),h=n(132),m=n(464),p=n(1),g=n(354),v=n(315),f=n.n(v),b=n(349),y=n(125),S=n(606),E=n(128),w=n(216),_=n(135),C=n(225),O=n(129),I=n(690),R=n(194),k=n(232),x=n(646);var T=e=>{let{description:t,acceptLabel:n,dismissLabel:i,onAccept:s,onDismiss:o,toastKey:r,numSeconds:a}=e;const l=()=>{o&&o(),R.a.sharedInstance().dismissToast(r)},d=Object(x.a)(l,1e3,a);let u=i;return d>0&&(u+=` (${d})`),c.a.createElement(k.a,{description:t,acceptLabel:n,onAccept:s,rejectLabel:u,onReject:l})},j=n(12),P=n(1580);class D extends b.e{constructor(){super(...arguments),f()(this,"_favicon",void 0)}async getConfig(){return Object(j.a)()}getHumanReadableName(){return"Vector Base Platform"}get favicon(){return this._favicon||(this._favicon=new P.a),this._favicon}updateFavicon(){let e="#d00",t=this.notificationCount;this.errorDidOccur&&(t=t||"×",e="#f00"),this.favicon.badge(t,{bgColor:e})}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),this.updateFavicon())}setErrorStatus(e){this.errorDidOccur!==e&&(super.setErrorStatus(e),this.updateFavicon())}startUpdater(){}getDefaultDeviceDisplayName(){return Object(l.a)("Unknown device")}}class N{async supportsEventIndexing(){return!0}async initEventIndex(e,t){throw new Error("Unimplemented")}async addEventToIndex(e,t){throw new Error("Unimplemented")}async deleteEvent(e){throw new Error("Unimplemented")}async isEventIndexEmpty(){throw new Error("Unimplemented")}indexIsEmpty(){throw new Error("Unimplemented")}isRoomIndexed(e){throw new Error("Unimplemented")}async getStats(){throw new Error("Unimplemented")}async getUserVersion(){throw new Error("Unimplemented")}async setUserVersion(e){throw new Error("Unimplemented")}async commitLiveEvents(){throw new Error("Unimplemented")}async searchEventIndex(e){throw new Error("Unimplemented")}async addHistoricEvents(e,t,n){throw new Error("Unimplemented")}async addCrawlerCheckpoint(e){throw new Error("Unimplemented")}async removeCrawlerCheckpoint(e){throw new Error("Unimplemented")}async loadCheckpoints(){throw new Error("Unimplemented")}async loadFileEvents(e){throw new Error("Unimplemented")}async closeEventIndex(){throw new Error("Unimplemented")}async deleteEventIndex(){throw new Error("Unimplemented")}}var M=n(16);class A{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ipcCall",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"ipcReply";this.sendChannel=e,this.recvChannel=t,f()(this,"pendingIpcCalls",{}),f()(this,"nextIpcCallId",0),f()(this,"onIpcReply",((e,t)=>{if(void 0===t.id)return void p.a.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void p.a.warn("Unknown IPC payload ID: "+t.id);const n=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?n.reject(t.error):n.resolve(t.reply)})),window.electron.on(this.recvChannel,this.onIpcReply)}async call(e){const t=++this.nextIpcCallId,n=Object(M.m)();this.pendingIpcCalls[t]=n;for(var i=arguments.length,s=new Array(i>1?i-1:0),o=1;o<i;o++)s[o-1]=arguments[o];return window.electron.send(this.sendChannel,{id:t,name:e,args:s}),n.promise}}class L extends N{constructor(){super(...arguments),f()(this,"ipc",new A("seshat","seshatReply"))}async supportsEventIndexing(){return this.ipc.call("supportsEventIndexing")}async initEventIndex(e,t){return this.ipc.call("initEventIndex",e,t)}async addEventToIndex(e,t){return this.ipc.call("addEventToIndex",e,t)}async deleteEvent(e){return this.ipc.call("deleteEvent",e)}async isEventIndexEmpty(){return this.ipc.call("isEventIndexEmpty")}async isRoomIndexed(e){return this.ipc.call("isRoomIndexed",e)}async commitLiveEvents(){return this.ipc.call("commitLiveEvents")}async searchEventIndex(e){return this.ipc.call("searchEventIndex",e)}async addHistoricEvents(e,t,n){return this.ipc.call("addHistoricEvents",e,t,n)}async addCrawlerCheckpoint(e){return this.ipc.call("addCrawlerCheckpoint",e)}async removeCrawlerCheckpoint(e){return this.ipc.call("removeCrawlerCheckpoint",e)}async loadFileEvents(e){return this.ipc.call("loadFileEvents",e)}async loadCheckpoints(){return this.ipc.call("loadCheckpoints")}async closeEventIndex(){return this.ipc.call("closeEventIndex")}async getStats(){return this.ipc.call("getStats")}async getUserVersion(){return this.ipc.call("getUserVersion")}async setUserVersion(e){return this.ipc.call("setUserVersion",e)}async deleteEventIndex(){return this.ipc.call("deleteEventIndex")}}function U(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const F=navigator.platform.toUpperCase().includes("MAC");function B(e){["call_state"].includes(e.action)&&window.electron.send("app_onAction",e)}class V extends D{constructor(){super(),f()(this,"ipc",new A("ipcCall","ipcReply")),f()(this,"eventIndexManager",new L),f()(this,"ssoID",Object(C.b)(32)),f()(this,"onUpdateDownloaded",(async(e,t)=>{let{releaseNotes:n,releaseName:i}=t;y.a.dispatch({action:O.a.CheckUpdates,status:b.d.Ready}),this.shouldShowUpdate(i)&&Object(I.b)(await this.getAppVersion(),i,n)})),y.a.register(B),window.electron.on("check_updates",((e,t)=>{y.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?U(Object(n),!0).forEach((function(t){f()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):U(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({action:O.a.CheckUpdates},function(e){return!0===e?{status:b.d.Downloading}:!1===e?{status:b.d.NotAvailable}:{status:b.d.Error,detail:e}}(t)))})),window.electron.on("before-quit",(function(){p.a.log("element-desktop closing"),S.b()})),window.electron.on("update-downloaded",this.onUpdateDownloaded),window.electron.on("preferences",(()=>{y.a.fire(O.a.ViewUserSettings)})),window.electron.on("userDownloadCompleted",((e,t)=>{let{id:n,name:i}=t;const s=`DOWNLOAD_TOAST_${n}`;R.a.sharedInstance().addOrReplaceToast({key:s,title:Object(l.a)("Download Completed"),props:{description:i,acceptLabel:Object(l.a)("Open"),onAccept:()=>{window.electron.send("userDownloadAction",{id:n,open:!0}),R.a.sharedInstance().dismissToast(s)},dismissLabel:Object(l.a)("Dismiss"),onDismiss:()=>{window.electron.send("userDownloadAction",{id:n})},numSeconds:10},component:T,priority:99})})),this.ipc.call("startSSOFlow",this.ssoID)}async getConfig(){return this.ipc.call("getConfig")}getHumanReadableName(){return"Electron Platform"}supportsSpellCheckSettings(){return!0}allowOverridingNativeContextMenus(){return!0}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),window.electron.send("setBadgeCount",e))}supportsNotifications(){return!0}maySendNotifications(){return!0}displayNotification(e,t,n,i,s){navigator.userAgent.includes("Linux")&&(t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;"));const o=super.displayNotification(e,t,n,i,s),r=o.onclick;return o.onclick=()=>{null==r||r(),this.ipc.call("focusWindow")},o}loudNotification(e,t){window.electron.send("loudNotification")}needsUrlTooltips(){return!0}async getAppVersion(){return this.ipc.call("getAppVersion")}supportsSetting(e){switch(e){case"Electron.showTrayIcon":case"Electron.alwaysShowMenuBar":return!F;default:return!0}}getSettingValue(e){return this.ipc.call("getSettingValue",e)}setSettingValue(e,t){return this.ipc.call("setSettingValue",e,t)}async canSelfUpdate(){const e=await this.ipc.call("getUpdateFeedUrl");return Boolean(e)}startUpdateCheck(){super.startUpdateCheck(),window.electron.send("check_updates")}installUpdate(){window.electron.send("install_update")}getDefaultDeviceDisplayName(){const e=h.b.get().brand;return Object(l.a)("%(brand)s Desktop: %(platformName)s",{brand:e,platformName:navigator.userAgent.includes("Macintosh")?"macOS":navigator.userAgent.includes("FreeBSD")?"FreeBSD":navigator.userAgent.includes("OpenBSD")?"OpenBSD":navigator.userAgent.includes("SunOS")?"SunOS":navigator.userAgent.includes("Windows")?"Windows":navigator.userAgent.includes("Linux")?"Linux":"Unknown"})}requestNotificationPermission(){return Promise.resolve("granted")}reload(){window.location.reload()}getEventIndexingManager(){return this.eventIndexManager}async setLanguage(e){return this.ipc.call("setLanguage",e)}setSpellCheckEnabled(e){this.ipc.call("setSpellCheckEnabled",e).catch((e=>{p.a.log("Failed to send setSpellCheckEnabled IPC to Electron"),p.a.error(e)}))}async getSpellCheckEnabled(){return this.ipc.call("getSpellCheckEnabled")}setSpellCheckLanguages(e){this.ipc.call("setSpellCheckLanguages",e).catch((e=>{p.a.log("Failed to send setSpellCheckLanguages IPC to Electron"),p.a.error(e)}))}async getSpellCheckLanguages(){return this.ipc.call("getSpellCheckLanguages")}async getDesktopCapturerSources(e){return this.ipc.call("getDesktopCapturerSources",e)}supportsDesktopCapturer(){return!0}supportsJitsiScreensharing(){return!1}async getAvailableSpellCheckLanguages(){return this.ipc.call("getAvailableSpellCheckLanguages")}getSSOCallbackUrl(e){const t=super.getSSOCallbackUrl(e);return t.protocol="element",t.searchParams.set("element-desktop-ssoid",this.ssoID),t}startSingleSignOn(e,t,n,i){super.startSingleSignOn(e,t,n,i),E.b.createDialog(w.a,{title:Object(l.a)("Go to your browser to complete Sign In"),description:c.a.createElement(_.a,null)})}navigateForwardBack(e){this.ipc.call(e?"navigateBack":"navigateForward")}overrideBrowserShortcuts(){return!0}async getPickleKey(e,t){try{return await this.ipc.call("getPickleKey",e,t)}catch(e){return null}}async createPickleKey(e,t){try{return await this.ipc.call("createPickleKey",e,t)}catch(e){return null}}async destroyPickleKey(e,t){try{await this.ipc.call("destroyPickleKey",e,t)}catch(e){}}}var K=n(1581),$=n.n(K),H=n(32);function W(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function q(e){return/^v\d+.\d+.\d+(-.+)?$/.test(e)?e.substring(1):e}class G extends D{constructor(){super(),f()(this,"pollForUpdate",((e,t)=>this.getMostRecentVersion().then((n=>{const i=q("1.11.26-sc.1");return i!==n?(this.shouldShowUpdate(n)?(console.log("Update available to "+n+", will notify user"),e(i,n)):console.log("Update available to "+n+" but won't be shown"),{status:b.d.Ready}):(console.log("No update available, already on "+n),null==t||t(),{status:b.d.NotAvailable})}),(e=>(p.a.error("Failed to poll for update",e),{status:b.d.Error,detail:e.message||e.status?e.status.toString():"Unknown Error"}))))),"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js")}getHumanReadableName(){return"Web Platform"}supportsNotifications(){return Boolean(window.Notification)}maySendNotifications(){return"granted"===window.Notification.permission}requestNotificationPermission(){return new Promise((function(e){window.Notification.requestPermission((t=>{e(t)}))}))}async getMostRecentVersion(){const e=await fetch("version",{method:"GET",cache:"no-cache"});if(e.ok){return q((await e.text()).trim())}return Promise.reject({status:e.status})}getAppVersion(){return Promise.resolve(q("1.11.26-sc.1"))}startUpdater(){console.log("startUpdater, current version is "+q("1.11.26-sc.1")),this.pollForUpdate(((e,t)=>{if(Object(H.a)(location).updated)return console.log("Update reloaded but still on an old version, stopping"),void Object(I.b)(e,t);const n=new URL(window.location.href);n.searchParams.set("updated",t),console.log("Update reloading to "+n.toString()),window.location.href=n.toString()})),setInterval((()=>this.pollForUpdate(I.b,I.a)),6e5)}async canSelfUpdate(){return!0}startUpdateCheck(){super.startUpdateCheck(),this.pollForUpdate(I.b,I.a).then((e=>{y.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?W(Object(n),!0).forEach((function(t){f()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):W(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({action:O.a.CheckUpdates},e))}))}installUpdate(){window.location.reload()}getDefaultDeviceDisplayName(){const e=new URL(window.location.href),t=[e.host,e.pathname.replace(/\/$/,"")].join(""),n=new $.a,i=n.getBrowser().name||"unknown browser";let s=n.getOS().name||"unknown OS";return"Mac OS"===s&&(s="macOS"),Object(l.a)("%(appName)s: %(browserName)s on %(osName)s",{appName:t,browserName:i,osName:s})}reload(){window.location.reload()}}class z extends G{setNotificationCount(e){if(!navigator.setAppBadge)return super.setNotificationCount(e);this.notificationCount!==e&&(this.notificationCount=e,navigator.setAppBadge(e).catch((e=>{p.a.error("Failed to update PWA app badge",e)})))}}var J=n(393);window.mxSendRageshake=function(e,t){const n=h.b.get().bug_report_endpoint_url;n?(void 0===t&&(t=!0),e&&e.trim()?Object(J.a)(n,{userText:e,sendLogs:t,progressCallback:p.a.log.bind(console)}).then((()=>{p.a.log("Bug report sent!")}),(e=>{p.a.error(e)})):p.a.error("Cannot send a rageshake without a message - please tell us what went wrong")):p.a.error("Cannot send a rageshake - no bug_report_endpoint_url configured")};const Y=[],Q=function(){const e=S.d(!1);return e.then((()=>{p.a.log("Initialised rageshake."),p.a.log("To fix line numbers in Chrome: Meatball menu → Settings → Ignore list → Add /rageshake\\.js$"),window.addEventListener("beforeunload",(()=>{p.a.log("element-web closing"),S.b()})),S.a()}),(e=>{p.a.error("Failed to initialise rageshake: "+e)})),e}();function X(){window.electron?(p.a.log("Using Electron platform"),u.a.set(new V)):window.matchMedia("(display-mode: standalone)").matches?(p.a.log("Using PWA platform"),u.a.set(new z)):(p.a.log("Using Web platform"),u.a.set(new G))}function Z(){return h.b.get().bug_report_endpoint_url?S.e():(p.a.warn("No bug report endpoint set - logs will not be persisted"),Promise.resolve())}async function ee(){const e=await u.a.get().getConfig();e?h.b.put(e):h.b.unset()}function te(){return o.a.init({locateFile:()=>i.a}).then((()=>{p.a.log("Using WebAssembly Olm")})).catch((e=>(p.a.log("Failed to load Olm: trying legacy version",e),new Promise(((e,t)=>{const n=document.createElement("script");n.src="olm_legacy.js",n.onload=e,n.onerror=t,document.body.appendChild(n)})).then((()=>window.Olm.init())).then((()=>{p.a.log("Using legacy Olm")})).catch((e=>{p.a.log("Both WebAssembly and asm.js Olm failed!",e)})))))}async function ne(){const e=d.b.getValue("language",null,!0);let t=[];e?t=[e]:l.f().forEach((e=>{t.push(...l.g(e))}));try{await l.l(t),document.documentElement.setAttribute("lang",l.e())}catch(e){p.a.error("Unable to set language",e)}}async function ie(){Object(m.d)()}async function se(e){const t=await Promise.all([n.e(11),n.e(9),n.e(29),n.e(16)]).then(n.bind(null,1728));window.matrixChat=r.render(await t.loadApp(e),document.getElementById("matrixchat"))}async function oe(e,t){const i=(await n.e(17).then(n.bind(null,1722))).default;window.matrixChat=r.render(a.createElement(i,{title:e,messages:t}),document.getElementById("matrixchat"))}async function re(e){const t=(await n.e(15).then(n.bind(null,1723))).default;window.matrixChat=r.render(a.createElement(t,{onAccept:e}),document.getElementById("matrixchat"))}async function ae(){for(const e of Y)g.a.instance.registerModule((t=>new e(t)))}const ce=l.a},,function(e,t,n){"use strict";n.d(t,"i",(function(){return E})),n.d(t,"h",(function(){return w})),n.d(t,"c",(function(){return _})),n.d(t,"a",(function(){return R})),n.d(t,"b",(function(){return k})),n.d(t,"k",(function(){return x})),n.d(t,"l",(function(){return P})),n.d(t,"d",(function(){return D})),n.d(t,"f",(function(){return N})),n.d(t,"g",(function(){return M})),n.d(t,"e",(function(){return L})),n.d(t,"j",(function(){return U}));var i=n(122),s=n.n(i),o=n(1011),r=n.n(o),a=n(120),c=n.n(a),l=n(1),d=n(16),u=n(126),h=n(156),m=n(138),p=n(400),g=n(132),v=n(354),f=n.p+"i18n/languages.e7499df.json";function b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?b(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const S="i18n/";r.a.setSeparator("|");function E(e,t){const n=new Error(e);return n.translatedMessage=R(e,t),n}function w(){const e=u.b.getValue("language",null,!0);return e||A(N()[0])}function _(e){return e}r.a.setFallbackLocale("en");const C=(e,t)=>{const n=r.a.translate(e,y(y({},t),{},{fallbackLocale:r.a.getLocale()}));if(!n||n.startsWith("missing translation:")){const n=r.a.translate(e,y(y({},t),{},{locale:"en"}));return!n||n.startsWith("missing translation:")?{translated:e,isFallback:!0}:{translated:n,isFallback:!0}}return{translated:n}};function O(e,t){const n=y(y({},t),{},{interpolate:!1});return n&&"object"==typeof n&&Object.keys(n).forEach((e=>{void 0===n[e]&&(l.a.warn("safeCounterpartTranslate called with undefined interpolation name: "+e),n[e]="undefined"),null===n[e]&&(l.a.warn("safeCounterpartTranslate called with null interpolation name: "+e),n[e]="null")})),C(e,n)}const I=(e,t)=>e;function R(e,t,n){const{translated:i}=O(e,t),s=T(i,t,n);return I(s,e)}function k(e,t,n){const{translated:i,isFallback:s}=O(e,t),o=T(i,t,n);return I(s?c.a.createElement("span",{lang:"en"},o):o,e)}function x(e){return e.replace(/%\(([^)]*)\)/g,"% ($1)")}function T(e,t,n){let i=e;if(void 0!==t){const e={};for(const n in t)e[`%\\(${n}\\)s`]=t[n];i=j(i,e)}if(void 0!==n){const e={};for(const t in n)e[`(<${t}>(.*?)<\\/${t}>|<${t}>|<${t}\\s*\\/>)`]=n[t];i=j(i,e)}return i}function j(e,t){const n=[e];let i=!1;for(const s in t){const o=new RegExp(s,"g");let r=!1;for(let e=0;e<n.length;e++){const a=n[e];if("string"!=typeof a)continue;let c=o.exec(a);if(!c)continue;r=!0;const l=a.slice(0,c.index),d=[];let u;for(;c;){u=c;const e=c.slice(2);let n,r;if(n=t[s]instanceof Function?t[s](...e):t[s],"object"==typeof n&&(i=!0),"string"==typeof n&&""===n||d.push(n),c=o.exec(a),c){const e=u.index+u[0].length;r=a.slice(e,c.index)}else r=a.slice(u.index+u[0].length);r&&d.push(r)}n.splice(e,1,...d),""!==l&&n.splice(e,0,l)}r||"%\\(count\\)s"!==s&&l.a.log(`Could not find ${o} in ${e}`)}return i?c.a.createElement("span",null,...n):n.join("")}function P(e){Array.isArray(e)||(e=[e]);const t=h.a.get();let n,i;return t&&t.setLanguage(e),F().then((t=>{i=t;for(let t=0;t<e.length;++t)if(i.hasOwnProperty(e[t])){n=e[t];break}return n||(n="en",l.a.error("Unable to find an appropriate language")),B(S+i[n].fileName)})).then((async e=>{if(r.a.registerTranslations(n,e),await W(),r.a.setLocale(n),await u.b.setValue("language",null,m.a.DEVICE,n),l.a.log("set language to "+n),"en"!==n)return B(S+i.en.fileName)})).then((async e=>{e&&r.a.registerTranslations("en",e),await W()}))}function D(){return F().then((e=>{const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push({value:n,label:e[n].label});return t}))}function N(){return navigator.languages&&navigator.languages.length?navigator.languages:navigator.language?[navigator.language]:[navigator.userLanguage||"en"]}function M(e){const t=[],n=A(e),i=n.split("-");return 2===i.length&&i[0]===i[1]?t.push(i[0]):(t.push(n),2===i.length&&t.push(i[0])),t}function A(e){return e.toLowerCase().replace("_","-")}function L(){return r.a.getLocale()}function U(e){const t=L(),n=e.map(A);{const i=n.indexOf(t);if(i>-1)return e[i]}{const i=n.findIndex((e=>e.slice(0,2)===t.slice(0,2)));if(i>-1)return e[i]}{const t=n.findIndex((e=>e.startsWith("en")));if(t>-1)return e[t]}return e[0]}async function F(){let e;e="string"==typeof f?f:S+"languages.json";const t=await fetch(e,{method:"GET"});if(!t.ok)throw new Error(`Failed to load ${e}, got ${t.status}`);return t.json()}async function B(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return Object(p.a)((()=>async function(e){const t=await fetch(e,{method:"GET"});if(!t.ok)throw new Error(`Failed to load ${e}, got ${t.status}`);return t.json()}(e)),t,(t=>(l.a.log("Failed to load i18n",e),l.a.error(t),!0)))}let V=null,K=0;class ${constructor(){}}function H(e){const t=new d.b((()=>({})));for(const[n,i]of Object.entries(e))for(const[e,s]of Object.entries(i))Object(d.L)(t.getOrCreate(e),n,s);for(const[e,n]of t)r.a.registerTranslations(e,n)}async function W(){H(v.a.instance.allTranslations);const e=g.b.get().custom_translations_url;if(e)try{let t;if(Date.now()>=K?(t=$.lookupFn?$.lookupFn(e):await(await fetch(e)).json(),V=t,K=Date.now()+3e5):t=V,!t)return;H(t)}catch(e){l.a.warn("Ignoring error while registering custom translations: ",e),K=Date.now()+3e5}}s()($,"lookupFn",void 0)},,function(e,t,n){"use strict";n.d(t,"a",(function(){return X}));var i=n(122),s=n.n(i),o=n(137),r=n(358),a=n(16),c=n(180),l=n(360),d=n(175),u=n(429),h=n(1),m=n(990),p=n(126),g=n(149),v=n(144),f=n(141),b=n(152),y=n(125);function S(e,t,n){return{action:"MatrixActions.sync",state:t,prevState:n,matrixClient:e}}function E(e,t){return{action:"MatrixActions.accountData",event:t,event_type:t.getType(),event_content:t.getContent()}}function w(e,t,n){return{action:"MatrixActions.Room.accountData",event:t,event_type:t.getType(),event_content:t.getContent(),room:n}}function _(e,t){return{action:"MatrixActions.Room",room:t}}function C(e,t,n){return{action:"MatrixActions.Room.tags",room:n}}function O(e,t,n){return{action:"MatrixActions.Room.receipt",event:t,room:n,matrixClient:e}}function I(e,t,n,i,s,o){return{action:"MatrixActions.Room.timeline",event:t,isLiveEvent:o.liveEvent,isLiveUnfilteredRoomTimelineEvent:o.timeline.getTimelineSet()===(null==n?void 0:n.getUnfilteredTimelineSet()),room:n}}function R(e,t,n,i){return{action:"MatrixActions.RoomState.events",event:t,state:n,lastStateEvent:i}}function k(e,t,n,i){return{action:"MatrixActions.Room.myMembership",room:t,membership:n,oldMembership:i}}function x(e,t){return{action:"MatrixActions.Event.decrypted",event:t}}let T=[];function j(e,t,n){const i=function(){for(var t=arguments.length,i=new Array(t),s=0;s<t;s++)i[s]=arguments[s];const o=n(e,...i);o&&y.a.dispatch(o,!1)};e.on(t,i),T.push((()=>{e.removeListener(t,i)}))}var P={start(e){j(e,g.b.Sync,S),j(e,g.b.AccountData,E),j(e,f.d.AccountData,w),j(e,g.b.Room,_),j(e,f.d.Tags,C),j(e,f.d.Receipt,O),j(e,f.d.Timeline,I),j(e,f.d.MyMembership,k),j(e,v.c.Decrypted,x),j(e,b.b.Events,R)},stop(){T.forEach((e=>e())),T=[]}},D=n(128),N=n(444),M=n(445),A=n(292),L=n(254),U=n(295),F=n(543),B=n(120),V=n.n(B),K=n(121),$=n(132),H=n(136),W=n(146),q=n(157);var G=e=>{const t=$.b.get().brand,n=Object(K.a)("You've previously used a newer version of %(brand)s with this session. To use this version again with end to end encryption, you will need to sign out and back in again.",{brand:t});return V.a.createElement(H.a,{className:"mx_CryptoStoreTooNewDialog",contentId:"mx_Dialog_content",title:Object(K.a)("Incompatible Database"),hasCancel:!1,onFinished:e.onFinished},V.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},n),V.a.createElement(W.a,{primaryButton:Object(K.a)("Continue With Encryption Disabled"),hasCancel:!1,onPrimaryButtonClick:()=>e.onFinished(!1)},V.a.createElement("button",{onClick:()=>{D.b.createDialog(q.a,{title:Object(K.a)("Sign out"),description:Object(K.a)("To avoid losing your chat history, you must export your room keys before logging out. You will need to go back to the newer version of %(brand)s to do this",{brand:t}),button:Object(K.a)("Sign out"),focus:!1,onFinished:t=>{t&&(y.a.dispatch({action:"logout"}),e.onFinished(!0))}})}},Object(K.a)("Sign out"))))},z=n(138),J=n(737);function Y(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Q(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Y(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Y(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const X=new class{constructor(){s()(this,"opts",{initialSyncLimit:20}),s()(this,"matrixClient",null),s()(this,"justRegisteredUserId",null),s()(this,"currentClientCreds",void 0)}get(){return this.matrixClient}unset(){this.matrixClient=null,P.stop()}setJustRegisteredUserId(e){if(this.justRegisteredUserId=e,e){const e=Date.now().toString();window.localStorage.setItem("mx_registration_time",e)}}currentUserIsJustRegistered(){return this.matrixClient&&this.matrixClient.credentials.userId===this.justRegisteredUserId}userRegisteredWithinLastHours(e){if(e<=0)return!1;try{const t=parseInt(window.localStorage.getItem("mx_registration_time"),10);return(Date.now()-t)/36e5<=e}catch(e){return!1}}userRegisteredAfter(e){try{const t=parseInt(window.localStorage.getItem("mx_registration_time"),10);return e.getTime()<=t}catch(e){return!1}}replaceUsingCreds(e){this.currentClientCreds=e,this.createClient(e)}async assign(){for(const e of["indexeddb","memory"])try{const e=this.matrixClient.store.startup();h.a.log("MatrixClientPeg: waiting for MatrixClient store to initialise"),await e;break}catch(t){if("indexeddb"!==e)throw h.a.error("Failed to start memory store!",t),t;h.a.error("Error starting matrixclient store - falling back to memory store",t),this.matrixClient.store=new r.a({localStorage:localStorage})}p.b.getValue("lowBandwidth")||await this.initClientCrypto();const e=a.k(this.opts);if(e.pendingEventOrdering=o.PendingEventOrdering.Detached,e.lazyLoadMembers=!0,e.clientWellKnownPollPeriod=7200,e.threadSupport=!0,p.b.getValue("feature_sliding_sync")){const t=p.b.getValue("feature_sliding_sync_proxy_url");t?h.a.log("Activating sliding sync using proxy at ",t):h.a.log("Activating sliding sync"),e.slidingSync=F.a.instance.configure(this.matrixClient,t||this.matrixClient.baseUrl),F.a.instance.startSpidering(100,50)}return P.start(this.matrixClient),N.a.matrixClient=this.matrixClient,J.a.matrixClient=this.matrixClient,e}async initClientCrypto(){const e=p.b.getValue("feature_rust_crypto");if(await p.b.setValue("feature_rust_crypto",null,z.a.DEVICE,e),e)await this.matrixClient.initRustCrypto();else try{this.matrixClient.initCrypto&&(await this.matrixClient.initCrypto(),this.matrixClient.setCryptoTrustCrossSignedDevices(!p.b.getValue("e2ee.manuallyVerifyAllSessions")),await Object(L.f)(this.matrixClient),M.e(!0))}catch(e){e instanceof Error&&"InvalidCryptoStoreError"===e.name&&D.b.createDialog(G),h.a.warn("Unable to initialise e2e",e)}}async start(){const e=await this.assign();h.a.log("MatrixClientPeg: really starting MatrixClient"),await this.get().startClient(e),h.a.log("MatrixClientPeg: MatrixClient started")}getCredentials(){var e,t,n,i;let s=this.currentClientCreds;return(null===(e=this.currentClientCreds)||void 0===e?void 0:e.userId)!==(null===(t=this.matrixClient)||void 0===t||null===(n=t.credentials)||void 0===n?void 0:n.userId)&&(s=null),Q(Q({},null!==(i=s)&&void 0!==i?i:{}),{},{homeserverUrl:this.matrixClient.baseUrl,identityServerUrl:this.matrixClient.idBaseUrl,userId:this.matrixClient.credentials.userId,deviceId:this.matrixClient.getDeviceId(),accessToken:this.matrixClient.getAccessToken(),guest:this.matrixClient.isGuest()})}getHomeserverName(){const e=/^@[^:]+:(.+)$/.exec(this.matrixClient.credentials.userId);if(null===e||e.length<1)throw new Error("Failed to derive homeserver name from user ID!");return e[1]}namesToRoomName(e,t){const n=t-1;return e.length?1===e.length&&n<=1?e[0]:void 0:Object(K.a)("Empty room")}memberNamesToRoomName(e,t){const n=this.namesToRoomName(e,t);return n||(2===e.length&&2===t?Object(K.a)("%(user1)s and %(user2)s",{user1:e[0],user2:e[1]}):Object(K.a)("%(user)s and %(count)s others",{user:e[0],count:t-1}))}inviteeNamesToRoomName(e,t){const n=this.namesToRoomName(e,t);return n||(2===e.length&&2===t?Object(K.a)("Inviting %(user1)s and %(user2)s",{user1:e[0],user2:e[1]}):Object(K.a)("Inviting %(user)s and %(count)s others",{user:e[0],count:t-1}))}createClient(e){const t={baseUrl:e.homeserverUrl,idBaseUrl:e.identityServerUrl,accessToken:e.accessToken,userId:e.userId,deviceId:e.deviceId,pickleKey:e.pickleKey,timelineSupport:!0,forceTURN:!p.b.getValue("webRtcAllowPeerToPeer"),fallbackICEServerAllowed:!!p.b.getValue("fallbackICEServerAllowed"),iceCandidatePoolSize:20,verificationMethods:[d.e.SAS,u.e,d.e.RECIPROCATE_QR_CODE],identityServer:new A.a,cryptoCallbacks:Q({},L.c),roomNameGenerator:(e,t)=>{switch(t.type){case o.RoomNameType.Generated:return"Inviting"===t.subtype?this.inviteeNamesToRoomName(t.names,t.count):this.memberNamesToRoomName(t.names,t.count);case o.RoomNameType.EmptyRoom:return t.oldName?Object(K.a)("Empty room (was %(oldName)s)",{oldName:t.oldName}):Object(K.a)("Empty room");default:return null}}};U.a.getDehydrationKey&&(t.cryptoCallbacks.getDehydrationKey=U.a.getDehydrationKey),this.matrixClient=Object(m.a)(t),this.matrixClient.setMaxListeners(500),this.matrixClient.setGuest(Boolean(e.guest));const n=new l.b(void 0,{timelineSupport:!0,pendingEvents:!1});n.getLiveTimeline().setPaginationToken("",c.b.BACKWARDS),this.matrixClient.setNotifTimelineSet(n)}};window.mxMatrixClientPeg||(window.mxMatrixClientPeg=X)},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(134),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a),l=n(153),d=n(143);const u=["element","onClick","children","kind","disabled","inputRef","className","onKeyDown","onKeyUp","triggerOnMouseDown"];function h(e){let{element:t,onClick:n,children:i,kind:o,disabled:a,inputRef:h,className:m,onKeyDown:p,onKeyUp:g,triggerOnMouseDown:v}=e;const f=s()(e,u);return a?(f["aria-disabled"]=!0,f.disabled=!0):(v?f.onMouseDown=null!=n?n:void 0:f.onClick=null!=n?n:void 0,f.onKeyDown=e=>{switch(Object(l.a)().getAccessibilityAction(e)){case d.h.Enter:return e.stopPropagation(),e.preventDefault(),null==n?void 0:n(e);case d.h.Space:e.stopPropagation(),e.preventDefault();break;default:null==p||p(e)}},f.onKeyUp=e=>{switch(Object(l.a)().getAccessibilityAction(e)){case d.h.Enter:e.stopPropagation(),e.preventDefault();break;case d.h.Space:return e.stopPropagation(),e.preventDefault(),null==n?void 0:n(e);default:null==g||g(e)}}),f.ref=h,f.className=c()("mx_AccessibleButton",m,{mx_AccessibleButton_hasKind:o,[`mx_AccessibleButton_kind_${o}`]:o,mx_AccessibleButton_disabled:a}),r.a.createElement(t,f,i)}h.defaultProps={element:"div",role:"button",tabIndex:0},h.displayName="AccessibleButton"},function(e,t,n){"use strict";n.d(t,"b",(function(){return r}));var i=n(1089),s=n(721);class o extends i.Dispatcher{dispatch(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e instanceof s.a?e.fn((e=>{this.dispatch(e,t)})):t?super.dispatch(e):window.setTimeout(super.dispatch.bind(this,e),0)}fire(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.dispatch({action:e},t)}}const r=new o;window.mxDispatcher||(window.mxDispatcher=r),t.a=r},function(e,t,n){"use strict";n.d(t,"a",(function(){return G})),n.d(t,"b",(function(){return J}));var i=n(122),s=n.n(i),o=n(1),r=n(123),a=n(138),c=n(330),l=n(544);class d extends l.a{constructor(e,t){super(),this.featureNames=e,this.watchers=t}getValue(e,t){if(this.featureNames.includes(e))return this.readFeature(e);if("notificationsEnabled"===e)return this.getBoolean("notifications_enabled");if("notificationBodyEnabled"===e)return this.getBoolean("notifications_body_enabled");if("audioNotificationsEnabled"===e)return this.getBoolean("audio_notifications_enabled");if("theme_in_use"===e){const t=this.getSettings()||{};return t.use_system_theme?c.a.System:t[e]}if("light_theme"===e||"dark_theme"===e){const t=this.getSettings()||{},n=t.theme;return n&&!t.use_system_theme?n:t[e]}return(this.getSettings()||{})[e]}setValue(e,t,n){if(this.featureNames.includes(e))return this.writeFeature(e,n),Promise.resolve();if("notificationsEnabled"===e)return this.setBoolean("notifications_enabled",n),this.watchers.notifyUpdate(e,null,a.a.DEVICE,n),Promise.resolve();if("notificationBodyEnabled"===e)return this.setBoolean("notifications_body_enabled",n),this.watchers.notifyUpdate(e,null,a.a.DEVICE,n),Promise.resolve();if("audioNotificationsEnabled"===e)return this.setBoolean("audio_notifications_enabled",n),this.watchers.notifyUpdate(e,null,a.a.DEVICE,n),Promise.resolve();if("layout"===e){const t=this.getSettings()||{};return delete t.useBubbleLayout,delete t.useIRCLayout,t.layout=n,this.setObject("mx_local_settings",t),this.watchers.notifyUpdate(e,null,a.a.DEVICE,n),Promise.resolve()}if("theme_in_use"===e){const e=this.getSettings()||{};return e.theme&&!e.use_system_theme&&(e.dark_theme=e.theme,e.light_theme=e.theme),delete e.use_system_theme,delete e.theme,e.theme_in_use=n,localStorage.setItem("mx_local_settings",JSON.stringify(e)),this.watchers.notifyUpdate("theme_in_use",null,a.a.DEVICE,e.theme_in_use),this.watchers.notifyUpdate("light_theme",null,a.a.DEVICE,e.light_theme),this.watchers.notifyUpdate("dark_theme",null,a.a.DEVICE,e.dark_theme),Promise.resolve()}if("light_theme"===e||"dark_theme"===e){const t=this.getSettings()||{};return t.theme&&!t.use_system_theme&&("light_theme"===e&&(t.dark_theme=t.theme),"dark_theme"===e&&(t.light_theme=t.theme)),delete t.use_system_theme,delete t.theme,t[e]=n,localStorage.setItem("mx_local_settings",JSON.stringify(t)),this.watchers.notifyUpdate("theme_in_use",null,a.a.DEVICE,t.theme_in_use),this.watchers.notifyUpdate("light_theme",null,a.a.DEVICE,t.light_theme),this.watchers.notifyUpdate("dark_theme",null,a.a.DEVICE,t.dark_theme),Promise.resolve()}const i=this.getSettings()||{};return i[e]=n,this.setObject("mx_local_settings",i),this.watchers.notifyUpdate(e,null,a.a.DEVICE,n),Promise.resolve()}canSetValue(e,t){return!0}watchSetting(e,t,n){this.watchers.watchSetting(e,t,n)}unwatchSetting(e){this.watchers.unwatchSetting(e)}getSettings(){return this.getObject("mx_local_settings")}readFeature(e){return(!r.a.get()||!r.a.get().isGuest())&&this.getBoolean("mx_labs_feature_"+e)}writeFeature(e,t){this.setBoolean("mx_labs_feature_"+e,t),this.watchers.notifyUpdate(e,null,a.a.DEVICE,t)}}var u=n(16);class h extends l.a{constructor(e){super(),this.watchers=e}getValue(e,t){if("blacklistUnverifiedDevices"===e){const e=this.read("mx_local_settings");if(null!=e&&e.blacklistUnverifiedDevicesPerRoom)return e.blacklistUnverifiedDevicesPerRoom[t]}const n=this.read(this.getKey(e,t));return n?n.value:null}setValue(e,t,n){if("blacklistUnverifiedDevices"===e){let i=this.read("mx_local_settings");return i||(i={}),i.blacklistUnverifiedDevicesPerRoom||(i.blacklistUnverifiedDevicesPerRoom={}),Object(u.L)(i.blacklistUnverifiedDevicesPerRoom,t,n),this.setObject("mx_local_settings",i),this.watchers.notifyUpdate(e,t,a.a.ROOM_DEVICE,n),Promise.resolve()}return null===n?this.removeItem(this.getKey(e,t)):this.setObject(this.getKey(e,t),{value:n}),this.watchers.notifyUpdate(e,t,a.a.ROOM_DEVICE,n),Promise.resolve()}canSetValue(e,t){return!0}read(e){return this.getObject(e)}getKey(e,t){return"mx_setting_"+e+"_"+t}}var m=n(329);class p extends m.a{constructor(e,t){super(),this.defaults=e,this.invertedDefaults=t}getValue(e,t){let n=this.defaults[e];return void 0===n&&(n=this.invertedDefaults[e]),n}async setValue(e,t,n){throw new Error("Cannot set values on the default level handler")}canSetValue(e,t){return!1}isSupported(){return!0}}var g=n(141),v=n(444),f=n(187);const b="im.vector.setting.allowed_widgets",y="im.vector.web.settings";class S extends v.a{constructor(e){super(),this.watchers=e,s()(this,"onAccountData",((e,t,n)=>{const i=t.roomId;if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",i,a.a.ROOM_ACCOUNT,t)}else if(e.getType()===y){const t=n?n.getContent():{},s=Object(f.d)(t,e.getContent());for(const t of s){const n=e.getContent()[t];this.watchers.notifyUpdate(t,i,a.a.ROOM_ACCOUNT,n)}}else e.getType()===b&&this.watchers.notifyUpdate("allowedWidgets",i,a.a.ROOM_ACCOUNT,e.getContent())}))}initMatrixClient(e,t){e&&e.removeListener(g.d.AccountData,this.onAccountData),t.on(g.d.AccountData,this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("allowedWidgets"===e)return this.getSettings(t,b);return(this.getSettings(t)||{})[e]}async setRoomAccountData(e,t,n,i){let s;null===n?s=i:(s=this.getSettings(e,t)||{},s[n]=i),await this.client.setRoomAccountData(e,t,s);const o=Object(u.m)(),r=(s,a)=>{a.roomId===e&&s.getType()===t&&(null!==n&&s.getContent()[n]!==i||(this.client.off(g.d.AccountData,r),o.resolve()))};this.client.on(g.d.AccountData,r),await o.promise}setValue(e,t,n){switch(e){case"urlPreviewsEnabled":return this.setRoomAccountData(t,"org.matrix.room.preview_urls","disable",!n);case"allowedWidgets":return this.setRoomAccountData(t,b,null,n);default:return this.setRoomAccountData(t,y,e,n)}}canSetValue(e,t){return!!this.client.getRoom(t)}isSupported(){return this.client&&!this.client.isGuest()}getSettings(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y;const i=null===(t=this.client.getRoom(e))||void 0===t?void 0:t.getAccountData(n);return i&&i.getContent()?Object(f.a)(i.getContent()):null}}var E=n(149);const w="im.vector.riot.breadcrumb_rooms",_="im.vector.setting.breadcrumbs",C=[w,_],O="io.element.recent_emoji",I="im.vector.setting.integration_provisioning",R="im.vector.analytics",k="im.vector.web.settings";class x extends v.a{constructor(e){super(),this.watchers=e,s()(this,"onAccountData",((e,t)=>{if("org.matrix.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",null,a.a.ACCOUNT,t)}else if(e.getType()===k||e.getType()===R){var n;const i=null!==(n=null==t?void 0:t.getContent())&&void 0!==n?n:{},s=Object(f.d)(i,e.getContent());for(const t of s){const n=e.getContent()[t];this.watchers.notifyUpdate(t,null,a.a.ACCOUNT,n)}}else if(C.includes(e.getType()))this.notifyBreadcrumbsUpdate(e);else if(e.getType()===I){const t=e.getContent().enabled;this.watchers.notifyUpdate("integrationProvisioning",null,a.a.ACCOUNT,t)}else if(e.getType()===O){const t=e.getContent().enabled;this.watchers.notifyUpdate("recent_emoji",null,a.a.ACCOUNT,t)}}))}get level(){return a.a.ACCOUNT}initMatrixClient(e,t){null==e||e.removeListener(E.b.AccountData,this.onAccountData),t.on(E.b.AccountData,this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings("org.matrix.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("breadcrumb_rooms"===e){let e=this.getSettings(_);return e&&e.recent_rooms||(e=this.getSettings(w),e&&(e.recent_rooms=e.rooms)),e&&e.recent_rooms?e.recent_rooms:[]}if("recent_emoji"===e){const e=this.getSettings(O);return e?e.recent_emoji:null}if("integrationProvisioning"===e){const e=this.getSettings(I);return e?e.enabled:null}if("pseudonymousAnalyticsOptIn"===e){const t=this.getSettings(R)||{};return"boolean"!=typeof t[e]?null:t[e]}if("MessageComposerInput.insertTrailingColon"===e){const n=(this.getSettings()||{})[e];return null==n?(this.setValue(e,t,!0),!0):n}const n=this.getSettings()||{};let i=n[e];return null==i&&("hideAvatarChanges"!==e&&"hideDisplaynameChanges"!==e||(i=n.hideAvatarDisplaynameChanges)),i}async setAccountData(e,t,n,i){var s;let o=this.getSettings(e);!i||null!==(s=o)&&void 0!==s&&s[t]||(o=this.getSettings(i)),o||(o={}),o[t]=n;const r=Object(u.m)(),a=i=>{i.getType()===e&&i.getContent()[t]===n&&(this.client.off(E.b.AccountData,a),r.resolve())};this.client.on(E.b.AccountData,a),await this.client.setAccountData(e,o),await r.promise}setValue(e,t,n){switch(e){case"urlPreviewsEnabled":return this.setAccountData("org.matrix.preview_urls","disable",!n);case"breadcrumb_rooms":return this.setAccountData(_,"recent_rooms",n,w);case"recent_emoji":return this.setAccountData(O,"recent_emoji",n);case"integrationProvisioning":return this.setAccountData(I,"enabled",n);case"pseudonymousAnalyticsOptIn":return this.setAccountData(R,"pseudonymousAnalyticsOptIn",n);default:return this.setAccountData(k,e,n)}}canSetValue(e,t){return!0}isSupported(){return this.client&&!this.client.isGuest()}getSettings(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"im.vector.web.settings";if(!this.client)return null;const t=this.client.getAccountData(e);return t&&t.getContent()?Object(f.a)(t.getContent()):null}notifyBreadcrumbsUpdate(e){let t=[];if(e.getType()===w){const n=this.getSettings(_);t=n?n.recent_rooms:e.getContent().rooms}else{if(e.getType()!==_)return;t=e.getContent().recent_rooms}this.watchers.notifyUpdate("breadcrumb_rooms",null,a.a.ACCOUNT,t||[])}}var T=n(152);const j="im.vector.web.settings";class P extends v.a{constructor(e){super(),this.watchers=e,s()(this,"onEvent",((e,t,n)=>{const i=e.getRoomId(),s=this.client.getRoom(i);if(s&&(!s||t===s.currentState))if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",i,a.a.ROOM,t)}else if(e.getType()===j){const t=n?n.getContent():{},s=Object(f.d)(t,e.getContent());for(const t of s)this.watchers.notifyUpdate(t,i,a.a.ROOM,e.getContent()[t])}}))}initMatrixClient(e,t){e&&e.removeListener(T.b.Events,this.onEvent),t.on(T.b.Events,this.onEvent)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}return(this.getSettings(t)||{})[e]}async sendStateEvent(e,t,n,i){const s=this.getSettings(e,t)||{};s[n]=i;const{event_id:o}=await this.client.sendStateEvent(e,t,s),r=Object(u.m)(),a=e=>{e.getId()===o&&(this.client.off(T.b.Events,a),r.resolve())};this.client.on(T.b.Events,a),await r.promise}setValue(e,t,n){return"urlPreviewsEnabled"===e?this.sendStateEvent(t,"org.matrix.room.preview_urls","disable",!n):this.sendStateEvent(t,j,e,n)}canSetValue(e,t){var n;const i=this.client.getRoom(t);let s=j;return"urlPreviewsEnabled"===e&&(s="org.matrix.room.preview_urls"),null!==(n=null==i?void 0:i.currentState.maySendStateEvent(s,this.client.getUserId()))&&void 0!==n&&n}isSupported(){return!!this.client}getSettings(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:j;const i=null===(t=this.client.getRoom(e))||void 0===t?void 0:t.currentState.getStateEvents(n,"");return null!=i&&i.getContent()?Object(f.a)(i.getContent()):null}}var D=n(132),N=n(19);class M extends m.a{constructor(e){super(),this.featureNames=e}getValue(e,t){const n=new N.a(D.b.get());if(this.featureNames.includes(e)){const t=(n.get("features")||{})[e];return Object(u.u)(t)?null:!0===t||!1===t?t:"enable"===t||"disable"!==t&&null}const i=n.get("default_theme");if("theme_in_use"===e&&i){if("light"===i)return c.a.Light;if("dark"===i)return c.a.Dark;"system"===i&&c.a.System}const s=n.get("setting_defaults");return!s||Object(u.u)(s[e])?null:s[e]}async setValue(e,t,n){throw new Error("Cannot change settings at the config level")}canSetValue(e,t){return!1}isSupported(){return!0}}var A=n(121),L=n(125),U=n(318);class F extends m.a{constructor(e,t){super(),this.handler=e,this.level=t,s()(this,"cache",{})}getValue(e,t){const n=null!=t?t:"UNDEFINED",i=this.cache[e];return null!=i&&i.hasOwnProperty(n)?i[n]:this.handler.getValue(e,t)}async setValue(e,t,n){var i;this.cache[e]||(this.cache[e]={});const s=this.cache[e],o=null!=t?t:"UNDEFINED";s[o]=n;const r=this.handler.getValue(e,t),a=this.handler.setValue(e,t,n);null===(i=this.handler.watchers)||void 0===i||i.notifyUpdate(e,t,this.level,n);try{await a}catch(n){var c;null===(c=this.handler.watchers)||void 0===c||c.notifyUpdate(e,t,this.level,r)}finally{s[o]===n&&delete s[o]}}canSetValue(e,t){return this.handler.canSetValue(e,t)}isSupported(){return this.handler.isSupported()}}var B=n(129),V=n(156);class K extends m.a{constructor(){super(),s()(this,"store",{}),s()(this,"onAction",(e=>{e.action===B.a.PlatformSet&&(this.store={},Object.entries(U.c).forEach((t=>{var n;let[i,s]=t;null!==(n=s.supportedLevels)&&void 0!==n&&n.includes(a.a.PLATFORM)&&e.platform.supportsSetting(i)&&e.platform.getSettingValue(i).then((e=>{this.store[i]=e}))})))})),L.a.register(this.onAction)}canSetValue(e,t){var n,i;return null!==(n=null===(i=V.a.get())||void 0===i?void 0:i.supportsSetting(e))&&void 0!==n&&n}getValue(e,t){return this.store[e]}async setValue(e,t,n){var i;this.store[e]=n,await(null===(i=V.a.get())||void 0===i?void 0:i.setSettingValue(e,n))}isSupported(){var e,t;return null!==(e=null===(t=V.a.get())||void 0===t?void 0:t.supportsSetting())&&void 0!==e&&e}}const $={},H={},W=[];for(const e in U.c){const t=U.c[e];$[e]=t.default,t.isFeature&&W.push(e),t.invertedSettingName&&(H[t.invertedSettingName]=!t.default)}const q={[a.a.DEVICE]:new d(W,U.d),[a.a.ROOM_DEVICE]:new h(U.d),[a.a.ROOM_ACCOUNT]:new F(new S(U.d),a.a.ROOM_ACCOUNT),[a.a.ACCOUNT]:new F(new x(U.d),a.a.ACCOUNT),[a.a.ROOM]:new F(new P(U.d),a.a.ROOM),[a.a.PLATFORM]:new F(new K,a.a.PLATFORM),[a.a.CONFIG]:new M(W),[a.a.DEFAULT]:new p($,H)},G=[a.a.DEVICE,a.a.ROOM_DEVICE,a.a.ROOM_ACCOUNT,a.a.ACCOUNT,a.a.ROOM,a.a.CONFIG,a.a.DEFAULT];function z(e){return e.supportedLevelsAreOrdered||1===e.supportedLevels.length?[...e.supportedLevels]:G}class J{static getFeatureSettingNames(){return Object.keys(U.c).filter((e=>J.isFeature(e)))}static watchSetting(e,t,n){const i=U.c[e],s=e;if(!i)throw new Error(`${e} is not a setting`);i.invertedSettingName&&(e=i.invertedSettingName);const r=`${(new Date).getTime()}_${J.watcherCount++}_${e}_${t}`,a=(e,t,i)=>{var r;if(!J.doesSettingSupportLevel(s,t))return void o.a.warn(`Setting handler notified for an update of an invalid setting level: ${s}@${t} - this likely means a weird setting value made it into the level's storage. The notification will be ignored.`);const a=J.getValue(s),c=null!==(r=J.getValueAt(t,s))&&void 0!==r?r:i;n(s,e,t,c,a)};return J.watchers.set(r,a),U.d.watchSetting(e,t,a),r}static unwatchSetting(e){J.watchers.has(e)?(U.d.unwatchSetting(J.watchers.get(e)),J.watchers.delete(e)):o.a.warn(`Ending non-existent watcher ID ${e}`)}static monitorSetting(e,t){t=t||null,this.monitors.has(e)||this.monitors.set(e,new Map);const n=()=>{this.monitors.get(e).set(t,J.watchSetting(e,t,((e,t,n,i,s)=>{L.a.dispatch({action:B.a.SettingUpdated,settingName:e,roomId:t,level:n,newValueAtLevel:i,newValue:s})})))},i=Array.from(this.monitors.get(e).keys());i.find((e=>e===t||null===e))?null===t&&(i.forEach((t=>{J.unwatchSetting(this.monitors.get(e).get(t))})),this.monitors.get(e).clear(),n()):n()}static getDisplayName(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.a.DEFAULT;if(!U.c[e]||!U.c[e].displayName)return null;let n=U.c[e].displayName;return n instanceof Object&&(n=n[t]?n[t]:n.default),Object(A.a)(n)}static getDescription(e){var t;const n=null===(t=U.c[e])||void 0===t?void 0:t.description;return n?"string"!=typeof n?n():Object(A.a)(n):null}static isFeature(e){return!!U.c[e]&&!!U.c[e].isFeature}static shouldHaveWarning(e){var t;return!!U.c[e]&&(null!==(t=U.c[e].shouldWarn)&&void 0!==t&&t)}static getBetaInfo(e){var t;if(J.isFeature(e)&&!1!==J.getValueAt(a.a.CONFIG,e,null,!0,!0))return null===(t=U.c[e])||void 0===t?void 0:t.betaInfo}static getLabGroup(e){if(J.isFeature(e))return U.c[e].labsGroup}static isEnabled(e){var t,n;return!!U.c[e]&&(null===(t=!(null!==(n=U.c[e].controller)&&void 0!==n&&n.settingDisabled))||void 0===t||t)}static getValue(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!U.c[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");const i=z(U.c[e]);return J.getValueAt(i[0],e,t,!1,n)}static getValueAt(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const o=U.c[t];if(!o)throw new Error("Setting '"+t+"' does not appear to be a setting.");const r=z(o);r.includes(a.a.DEFAULT)||r.push(a.a.DEFAULT);const c=r.indexOf(e);if(-1===c)throw new Error(`Level "${e}" for setting "${t}" is not prioritized`);const l=J.getHandlers(t);if(o.invertedSettingName&&(t=o.invertedSettingName),i){const i=l[e];if(!i)return J.getFinalValue(o,e,n,null,null);const s=i.getValue(t,n);return J.getFinalValue(o,e,n,s,e)}for(let i=c;i<r.length;i++){const a=l[r[i]];if(!a)continue;if(s&&"default"===r[i])continue;const c=a.getValue(t,n);if(null!=c)return J.getFinalValue(o,e,n,c,r[i])}return J.getFinalValue(o,e,n,null,null)}static getDefaultValue(e){if(!U.c[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");return U.c[e].default}static getFinalValue(e,t,n,i,s){let o=i;if(e.controller){const r=e.controller.getValueOverride(t,n,i,s);null!=r&&(o=r)}return e.invertedSettingName&&(o=!o),o}static async setValue(e,t,n,i){var s;const o=U.c[e];if(!o)throw new Error("Setting '"+e+"' does not appear to be a setting.");const r=J.getHandler(e,n);if(!r)throw new Error("Setting "+e+" does not have a handler for "+n);if(o.invertedSettingName&&(e=o.invertedSettingName,i=!i),!r.canSetValue(e,t))throw new Error("User cannot set "+e+" at "+n+" in "+t);o.controller&&!await o.controller.beforeChange(n,t,i)||(await r.setValue(e,t,i),null===(s=o.controller)||void 0===s||s.onChange(n,t,i))}static canSetValue(e,t,n){var i;if(!U.c[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");if(!J.isEnabled(e))return!1;if(J.isFeature(e)&&(null===(i=U.c[e])||void 0===i||!i.betaInfo)){const n=J.getValueAt(a.a.CONFIG,e,t,!0,!0);if(!0===n||!1===n)return!1}const s=J.getHandler(e,n);return!!s&&s.canSetValue(e,t)}static isLevelSupported(e){return!!q[e]&&q[e].isSupported()}static doesSettingSupportLevel(e,t){var n;const i=U.c[e];if(!i)throw new Error("Setting '"+e+"' does not appear to be a setting.");return t===a.a.DEFAULT||!(null===(n=i.supportedLevels)||void 0===n||!n.includes(t))}static firstSupportedLevel(e){const t=U.c[e];if(!t)throw new Error("Setting '"+e+"' does not appear to be a setting.");const n=z(t);n.includes(a.a.DEFAULT)||n.push(a.a.DEFAULT);const i=J.getHandlers(e);for(const e of n){if(i[e])return e}return null}static runMigrations(){J.migrateHiddenReadReceipts()}static migrateHiddenReadReceipts(){if(r.a.get().isGuest())return;const e=L.a.register((t=>{if("MatrixActions.sync"===t.action){L.a.unregister(e);if("boolean"!=typeof J.getValue("sendReadReceipts",null,!0)){const e=q[a.a.DEVICE].readFeature("feature_hidden_read_receipts");if("boolean"==typeof e){const t=!e;console.log(`Setting sendReadReceipts to ${t} because of previously-set labs flag`),J.setValue("sendReadReceipts",null,a.a.ACCOUNT,t)}}}}))}static debugSetting(e,t){o.a.log(`--- DEBUG ${e}`);const n=U.c[e];o.a.log(`--- definition: ${n?JSON.stringify(n):"<NOT_FOUND>"}`),o.a.log(`--- default level order: ${JSON.stringify(G)}`),o.a.log(`--- registered handlers: ${JSON.stringify(Object.keys(q))}`);const i=e=>{for(const n of Object.keys(q)){const i=q[n];try{const s=i.getValue(e,t);o.a.log(`---     ${n}@${t||"<no_room>"} = ${JSON.stringify(s)}`)}catch(e){o.a.log(`---     ${i.constructor.name}@${t||"<no_room>"} THREW ERROR: ${e.message}`),o.a.error(e)}if(t)try{const t=i.getValue(e,null);o.a.log(`---     ${n}@<no_room> = ${JSON.stringify(t)}`)}catch(e){o.a.log(`---     ${i.constructor.name}@<no_room> THREW ERROR: ${e.message}`),o.a.error(e)}}o.a.log("--- calculating as returned by SettingsStore"),o.a.log("--- these might not match if the setting uses a controller - be warned!");try{const n=J.getValue(e,t);o.a.log(`---     SettingsStore#generic@${t||"<no_room>"}  = ${JSON.stringify(n)}`)}catch(e){o.a.log(`---     SettingsStore#generic@${t||"<no_room>"} THREW ERROR: ${e.message}`),o.a.error(e)}if(t)try{const t=J.getValue(e,null);o.a.log(`---     SettingsStore#generic@<no_room>  = ${JSON.stringify(t)}`)}catch(e){o.a.log(`---     SettingsStore#generic@$<no_room> THREW ERROR: ${e.message}`),o.a.error(e)}for(const n of G){try{const i=J.getValueAt(n,e,t);o.a.log(`---     SettingsStore#${n}@${t||"<no_room>"} = ${JSON.stringify(i)}`)}catch(e){o.a.log(`---     SettingsStore#${n}@${t||"<no_room>"} THREW ERROR: ${e.message}`),o.a.error(e)}if(t)try{const t=J.getValueAt(n,e,null);o.a.log(`---     SettingsStore#${n}@<no_room> = ${JSON.stringify(t)}`)}catch(e){o.a.log(`---     SettingsStore#${n}@$<no_room> THREW ERROR: ${e.message}`),o.a.error(e)}}};i(e),n.invertedSettingName&&(o.a.log("--- TESTING INVERTED SETTING NAME"),o.a.log(`--- inverted: ${n.invertedSettingName}`),i(n.invertedSettingName)),o.a.log("--- END DEBUG")}static getHandler(e,t){const n=J.getHandlers(e);return n[t]?n[t]:null}static getHandlers(e){if(!U.c[e])return{};const t={};for(const n of U.c[e].supportedLevels){if(!q[n])throw new Error("Unexpected level "+n);J.isLevelSupported(n)&&(t[n]=q[n])}return t.default||(t.default=q.default),t}}s()(J,"watchers",new Map),s()(J,"monitors",new Map),s()(J,"watcherCount",1),window.mxSettingsStore=J},,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return y}));var i=n(131),s=n.n(i),o=n(122),r=n.n(o),a=n(120),c=n.n(a),l=n(188),d=n.n(l),u=n(127),h=n.n(u),m=n(16),p=n(159),g=n(125),v=n(1091);const f="mx_Dialog_Container",b="mx_Dialog_StaticContainer";let y;!function(e){e.Opened="opened"}(y||(y={}));class S extends p.b{constructor(){super(...arguments),r()(this,"counter",0),r()(this,"priorityModal",null),r()(this,"staticModal",null),r()(this,"modals",[]),r()(this,"onBackgroundClick",(()=>{const e=this.getCurrentModal();e&&(e.closeReason="backgroundClick",e.close(),e.closeReason=void 0)}))}static getOrCreateContainer(){let e=document.getElementById(f);return e||(e=document.createElement("div"),e.id=f,document.body.appendChild(e)),e}static getOrCreateStaticContainer(){let e=document.getElementById(b);return e||(e=document.createElement("div"),e.id=b,document.body.appendChild(e)),e}toggleCurrentDialogVisibility(){const e=this.getCurrentModal();e&&(e.hidden=!e.hidden)}hasDialogs(){return!!this.priorityModal||!!this.staticModal||this.modals.length>0}createDialog(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};return this.createDialogAsync(Promise.resolve(e),t,n,i,s,o)}appendDialog(e,t,n){return this.appendDialogAsync(Promise.resolve(e),t,n)}closeCurrentModal(e){const t=this.getCurrentModal();t&&(t.closeReason=e,t.close())}buildModal(e,t,n,i){const o={onFinished:null==t?void 0:t.onFinished,onBeforeClose:null==i?void 0:i.onBeforeClose,className:n,elem:null},[r,a]=this.getCloseFn(o,t),l=this.counter++;return o.elem=c.a.createElement(v.a,s()({key:l,prom:e},t,{onFinished:r})),o.close=r,{modal:o,closeDialog:r,onFinishedProm:a}}getCloseFn(e,t){var n=this;const i=Object(m.m)();return[async function(){if(e.beforeClosePromise)await e.beforeClosePromise;else if(e.onBeforeClose){e.beforeClosePromise=e.onBeforeClose(e.closeReason);const t=await e.beforeClosePromise;if(e.beforeClosePromise=void 0,!t)return}for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];i.resolve(o),null!=t&&t.onFinished&&t.onFinished.apply(null,o);const a=n.modals.indexOf(e);a>=0&&n.modals.splice(a,1),n.priorityModal===e&&(n.priorityModal=null,n.modals=[]),n.staticModal===e&&(n.staticModal=null,n.modals=[]),n.reRender()},i.promise]}createDialogAsync(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};const r=this.getCurrentModal(),{modal:a,closeDialog:c,onFinishedProm:l}=this.buildModal(e,t,n,o);return i?this.priorityModal=a:s?this.staticModal=a:this.modals.unshift(a),this.reRender(),this.emitIfChanged(r),{close:c,finished:l}}appendDialogAsync(e,t,n){const i=this.getCurrentModal(),{modal:s,closeDialog:o,onFinishedProm:r}=this.buildModal(e,t,n,{});return this.modals.push(s),this.reRender(),this.emitIfChanged(i),{close:o,finished:r}}emitIfChanged(e){e!==this.getCurrentModal()&&this.emit(y.Opened)}getCurrentModal(){return this.priorityModal?this.priorityModal:this.modals[0]||this.staticModal}async reRender(){if(await Object(m.N)(0),0===this.modals.length&&!this.priorityModal&&!this.staticModal)return g.a.dispatch({action:"aria_unhide_main_app"}),d.a.unmountComponentAtNode(S.getOrCreateContainer()),void d.a.unmountComponentAtNode(S.getOrCreateStaticContainer());if(g.a.dispatch({action:"aria_hide_main_app"}),this.staticModal){const e=h()("mx_Dialog_wrapper mx_Dialog_staticWrapper",this.staticModal.className),t=c.a.createElement("div",{className:e},c.a.createElement("div",{className:"mx_Dialog"},this.staticModal.elem),c.a.createElement("div",{"data-testid":"dialog-background",className:"mx_Dialog_background mx_Dialog_staticBackground",onClick:this.onBackgroundClick}));d.a.render(t,S.getOrCreateStaticContainer())}else d.a.unmountComponentAtNode(S.getOrCreateStaticContainer());const t=this.getCurrentModal();if(t===this.staticModal||t.hidden)d.a.unmountComponentAtNode(S.getOrCreateContainer());else{const n=h()("mx_Dialog_wrapper",t.className,{mx_Dialog_wrapperWithStaticUnder:this.staticModal}),i=c.a.createElement("div",{className:n},c.a.createElement("div",{className:"mx_Dialog"},t.elem),c.a.createElement("div",{"data-testid":"dialog-background",className:"mx_Dialog_background",onClick:this.onBackgroundClick}));e((()=>d.a.render(i,S.getOrCreateContainer())))}}}window.singletonModalManager||(window.singletonModalManager=new S),t.b=window.singletonModalManager}).call(this,n(54).setImmediate)},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.ViewUser="view_user",e.ViewUserSettings="view_user_settings",e.ViewUserDeviceSettings="view_user_device_settings",e.ViewRoomDirectory="view_room_directory",e.ViewRoomError="view_room_error",e.ViewHomePage="view_home_page",e.RecheckTheme="recheck_theme",e.CheckUpdates="check_updates",e.FocusSendMessageComposer="focus_send_message_composer",e.ClearAndFocusSendMessageComposer="clear_focus_send_message_composer",e.FocusEditMessageComposer="focus_edit_message_composer",e.FocusAComposer="focus_a_composer",e.ToggleUserMenu="toggle_user_menu",e.ToggleSpacePanel="toggle_space_panel",e.UpdateFontSize="update_font_size",e.UpdateSystemFont="update_system_font",e.ViewRoom="view_room",e.ViewThread="view_thread",e.ViewRoomDelta="view_room_delta",e.OpenDialPad="open_dial_pad",e.DialNumber="dial_number",e.PstnSupportUpdated="pstn_support_updated",e.VirtualRoomSupportUpdated="virtual_room_support_updated",e.UploadStarted="upload_started",e.UploadProgress="upload_progress",e.UploadFinished="upload_finished",e.UploadFailed="upload_failed",e.UploadCanceled="upload_canceled",e.JoinRoom="join_room",e.JoinRoomReady="join_room_ready",e.JoinRoomError="join_room_error",e.BulkRedactStart="bulk_redact_start",e.BulkRedactEnd="bulk_redact_end",e.ComposerInsert="composer_insert",e.SwitchSpace="switch_space",e.UpdateSpaceHierarchy="update_space_hierarchy",e.SettingUpdated="setting_updated",e.EditEvent="edit_event",e.PseudonymousAnalyticsAccept="pseudonymous_analytics_accept",e.PseudonymousAnalyticsReject="pseudonymous_analytics_reject",e.ReportKeyBackupNotEnabled="report_key_backup_not_enabled",e.AfterLeaveRoom="after_leave_room",e.DoAfterSyncPrepared="do_after_sync_prepared",e.ViewStartChatOrReuse="view_start_chat_or_reuse",e.ActiveRoomChanged="active_room_changed",e.OpenForwardDialog="open_forward_dialog",e.OpenReportEventDialog="open_report_event_dialog",e.TriggerLogout="trigger_logout",e.OpenSpacePreferences="open_space_preferences",e.OpenSpaceSettings="open_space_settings",e.OpenInviteDialog="open_invite_dialog",e.OpenAddToExistingSpaceDialog="open_add_to_existing_space_dialog",e.DumpDebugLogs="dump_debug_logs",e.ShowRoomTopic="show_room_topic",e.OnLoggedOut="on_logged_out",e.OnLoggedIn="on_logged_in",e.OverwriteLogin="overwrite_login",e.PlatformSet="platform_set",e.ShowThread="show_thread"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"h",(function(){return o})),n.d(t,"e",(function(){return r})),n.d(t,"i",(function(){return a})),n.d(t,"j",(function(){return c})),n.d(t,"k",(function(){return l})),n.d(t,"o",(function(){return d})),n.d(t,"n",(function(){return u})),n.d(t,"r",(function(){return h})),n.d(t,"q",(function(){return m})),n.d(t,"p",(function(){return p})),n.d(t,"m",(function(){return g})),n.d(t,"d",(function(){return v})),n.d(t,"l",(function(){return f})),n.d(t,"a",(function(){return b})),n.d(t,"g",(function(){return y})),n.d(t,"f",(function(){return S})),n.d(t,"c",(function(){return E}));var i=n(15);let s,o,r;!function(e){e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomPredecessor="org.matrix.msc3946.room_predecessor",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",e.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.KeyVerificationKey="m.key.verification.key",e.KeyVerificationAccept="m.key.verification.accept",e.KeyVerificationReady="m.key.verification.ready",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.PollStart="org.matrix.msc3381.poll.start",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy",e.GroupCallPrefix="org.matrix.msc3401.call",e.GroupCallMemberPrefix="org.matrix.msc3401.call.member"}(s||(s={})),function(e){e.Annotation="m.annotation",e.Replace="m.replace",e.Reference="m.reference",e.Thread="m.thread"}(o||(o={})),function(e){e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video",e.KeyVerificationRequest="m.key.verification.request"}(r||(r={}));const a="type";let c;!function(e){e.Space="m.space",e.UnstableCall="org.matrix.msc3417.call",e.ElementVideo="io.element.video"}(c||(c={}));const l="org.matrix.msgid",d=new i.c("m.room.purpose","org.matrix.msc3088.purpose"),u=new i.c("m.enabled","org.matrix.msc3088.enabled"),h=new i.c("m.data_tree","org.matrix.msc3089.data_tree"),m=new i.c("m.leaf","org.matrix.msc3089.leaf"),p=new i.c("m.branch","org.matrix.msc3089.branch"),g=new i.c("m.room.marker","org.matrix.msc2716.marker"),v=new i.c("with_relations","org.matrix.msc3912.with_relations"),f=new i.c("io.element.functional_members","io.element.functional_members"),b=new i.c("m.visibility","org.matrix.msc3531.visibility"),y=new i.c("enabled","org.matrix.msc3881.enabled"),S=new i.c("device_id","org.matrix.msc3881.device_id"),E=new i.c("m.local_notification_settings","org.matrix.msc3890.local_notification_settings")},,function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"c",(function(){return d}));var i=n(122),s=n.n(i),o=n(19);function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const c={brand:"SchildiChat",integrations_ui_url:"https://scalar.vector.im/",integrations_rest_url:"https://scalar.vector.im/api",uisi_autorageshake_app:"element-auto-uisi",jitsi:{preferred_domain:"meet.jit.si"},element_call:{url:"https://call.element.io",use_exclusively:!1,participant_limit:8,brand:"Element Call"},desktopBuilds:{available:!0,logo:n(1092).default,url:"https://schildi.chat/desktop"},voice_broadcast:{chunk_length:120,max_length:14400}};class l{static setInstance(e){l.instance=e,l.fallback=new o.a(e),window.mxReactSdkConfig=e}static get(e,t){return void 0===e?l.instance||{}:l.fallback.get(e,t)}static getObject(e,t){const n=l.get(e,t);return null!=n?new o.a(n):void 0===n?void 0:null}static put(e){l.setInstance(a(a({},c),e))}static unset(){l.setInstance({})}static add(e){l.put(a(a({},l.get()),e))}}function d(e){return e.sso_redirect_options?e.sso_redirect_options:e.sso_immediate_redirect?{immediate:!0}:{}}s()(l,"instance",void 0),s()(l,"fallback",void 0)},function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return l}));var i=n(131),s=n.n(i),o=n(120),r=n.n(o);const a=Object(o.createContext)(void 0);function c(){return Object(o.useContext)(a)}a.displayName="MatrixClientContext",t.a=a;const l=e=>{const t=e;return Object(o.forwardRef)(((e,n)=>{const i=Object(o.useContext)(a);return r.a.createElement(t,s()({ref:n},e,{mxClient:i}))}))}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(735);class c extends r.a.PureComponent{render(){return r.a.createElement("div",{className:"mx_Spinner"},this.props.message&&r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_Spinner_Msg"},this.props.message)," "),r.a.createElement(a.a,{w:this.props.w,h:this.props.h,className:"mx_Spinner_icon","data-testid":"spinner"}))}}s()(c,"defaultProps",{w:32,h:32})},function(e,t,n){"use strict";n.d(t,"a",(function(){return y}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(439),c=n.n(a),l=n(127),d=n.n(l),u=n(124),h=n(123),m=n(121),p=n(133),g=n(176),v=n(162),f=n(153),b=n(143);class y extends r.a.Component{constructor(e){super(e),s()(this,"matrixClient",void 0),s()(this,"onKeyDown",(e=>{var t,n;null===(t=(n=this.props).onKeyDown)||void 0===t||t.call(n,e);switch(Object(f.a)().getAccessibilityAction(e)){case b.h.Escape:if(!this.props.hasCancel)break;e.stopPropagation(),e.preventDefault(),this.props.onFinished()}})),s()(this,"onCancelClick",(()=>{this.props.onFinished()})),this.matrixClient=h.a.get()}render(){let e,t;this.props.hasCancel&&(e=r.a.createElement(u.a,{onClick:this.onCancelClick,className:"mx_Dialog_cancelButton","aria-label":Object(m.a)("Close dialog")})),this.props.headerImage&&(t=r.a.createElement("img",{className:"mx_Dialog_titleImage",src:this.props.headerImage,alt:""}));const n={onKeyDown:this.onKeyDown,role:"dialog","aria-describedby":this.props.contentId};return this.props["aria-label"]?n["aria-label"]=this.props["aria-label"]:n["aria-labelledby"]="mx_BaseDialog_title",r.a.createElement(p.a.Provider,{value:this.matrixClient},r.a.createElement(v.a,{screenName:this.props.screenName}),r.a.createElement(c.a,{returnFocus:!0,lockProps:n,className:d()({[this.props.className]:!0,mx_Dialog_fixedWidth:this.props.fixedWidth})},this.props.top,r.a.createElement("div",{className:d()("mx_Dialog_header",{mx_Dialog_headerWithButton:!!this.props.headerButton,mx_Dialog_headerWithCancel:!!e})},r.a.createElement(g.a,{size:"h2",className:d()("mx_Dialog_title",this.props.titleClass),id:"mx_BaseDialog_title"},t,this.props.title),this.props.headerButton,e),this.props.children))}}s()(y,"defaultProps",{hasCancel:!0,fixedWidth:!0})},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"setCryptoStoreFactory",(function(){return L})),n.d(t,"createClient",(function(){return F})),n.d(t,"createRoomWidgetClient",(function(){return B}));var i=n(357),s=n(358),o=n(434),r=n(149),a=n(527);n.d(t,"CRYPTO_ENABLED",(function(){return r.a})),n.d(t,"UNSTABLE_MSC3852_LAST_SEEN_UA",(function(){return r.g})),n.d(t,"PendingEventOrdering",(function(){return r.e})),n.d(t,"RoomVersionStability",(function(){return r.f})),n.d(t,"M_AUTHENTICATION",(function(){return r.c})),n.d(t,"ClientEvent",(function(){return r.b})),n.d(t,"MatrixClient",(function(){return r.d})),n.d(t,"fixNotificationCountOnDecryption",(function(){return r.h})),n.d(t,"RoomWidgetClient",(function(){return a.a}));var c=n(196);n.d(t,"HttpApiEvent",(function(){return c.d})),n.d(t,"ClientPrefix",(function(){return c.a})),n.d(t,"IdentityPrefix",(function(){return c.e})),n.d(t,"MediaPrefix",(function(){return c.h})),n.d(t,"HTTPError",(function(){return c.c})),n.d(t,"MatrixError",(function(){return c.f})),n.d(t,"ConnectionError",(function(){return c.b})),n.d(t,"Method",(function(){return c.i})),n.d(t,"timeoutSignal",(function(){return c.m})),n.d(t,"anySignal",(function(){return c.j})),n.d(t,"parseErrorResponse",(function(){return c.k})),n.d(t,"retryNetworkOperation",(function(){return c.l})),n.d(t,"MatrixHttpApi",(function(){return c.g}));var l=n(326);n.d(t,"AutoDiscoveryAction",(function(){return l.b})),n.d(t,"AutoDiscovery",(function(){return l.a}));var d=n(535);n.d(t,"Category",(function(){return d.a})),n.d(t,"SyncAccumulator",(function(){return d.b}));var u=n(291);n.d(t,"InvalidStoreState",(function(){return u.d})),n.d(t,"InvalidStoreError",(function(){return u.c})),n.d(t,"InvalidCryptoStoreState",(function(){return u.b})),n.d(t,"InvalidCryptoStoreError",(function(){return u.a})),n.d(t,"KeySignatureUploadError",(function(){return u.e}));var h=n(362);n.d(t,"BeaconEvent",(function(){return h.b})),n.d(t,"isTimestampInDuration",(function(){return h.d})),n.d(t,"getBeaconInfoIdentifier",(function(){return h.c})),n.d(t,"Beacon",(function(){return h.a}));var m=n(144);n.d(t,"EventStatus",(function(){return m.a})),n.d(t,"MatrixEventEvent",(function(){return m.c})),n.d(t,"MatrixEvent",(function(){return m.b}));var p=n(141);n.d(t,"KNOWN_SAFE_ROOM_VERSION",(function(){return p.a})),n.d(t,"NotificationCountType",(function(){return p.b})),n.d(t,"RoomEvent",(function(){return p.d})),n.d(t,"Room",(function(){return p.c})),n.d(t,"RoomNameType",(function(){return p.e}));var g=n(180);n.d(t,"Direction",(function(){return g.a})),n.d(t,"EventTimeline",(function(){return g.b}));var v=n(360);n.d(t,"DuplicateStrategy",(function(){return v.a})),n.d(t,"EventTimelineSet",(function(){return v.b}));var f=n(420);n.d(t,"PollEvent",(function(){return f.b})),n.d(t,"Poll",(function(){return f.a}));var b=n(186);n.d(t,"RoomMemberEvent",(function(){return b.b})),n.d(t,"RoomMember",(function(){return b.a}));var y=n(152);n.d(t,"RoomStateEvent",(function(){return y.b})),n.d(t,"RoomState",(function(){return y.a}));var S=n(224);n.d(t,"UserEvent",(function(){return S.b})),n.d(t,"User",(function(){return S.a})),n.d(t,"MatrixScheduler",(function(){return o.a}));var E=n(320);n.d(t,"Filter",(function(){return E.a}));var w=n(536);n.d(t,"TimelineWindow",(function(){return w.b})),n.d(t,"TimelineIndex",(function(){return w.a}));var _=n(436);n.d(t,"AuthType",(function(){return _.a})),n.d(t,"InteractiveAuth",(function(){return _.b}));var C=n(276);n.d(t,"SERVICE_TYPES",(function(){return C.a})),n.d(t,"MemoryStore",(function(){return s.a}));var O=n(504);n.d(t,"IndexedDBStore",(function(){return O.a})),n.d(t,"MemoryCryptoStore",(function(){return i.a}));var I=n(227);n.d(t,"IndexedDBCryptoStore",(function(){return I.a}));var R=n(359);n.d(t,"getHttpUriForMxc",(function(){return R.a}));var k=n(130);n.d(t,"EventType",(function(){return k.b})),n.d(t,"RelationType",(function(){return k.h})),n.d(t,"MsgType",(function(){return k.e})),n.d(t,"RoomCreateTypeField",(function(){return k.i})),n.d(t,"RoomType",(function(){return k.j})),n.d(t,"ToDeviceMessageId",(function(){return k.k})),n.d(t,"UNSTABLE_MSC3088_PURPOSE",(function(){return k.o})),n.d(t,"UNSTABLE_MSC3088_ENABLED",(function(){return k.n})),n.d(t,"UNSTABLE_MSC3089_TREE_SUBTYPE",(function(){return k.r})),n.d(t,"UNSTABLE_MSC3089_LEAF",(function(){return k.q})),n.d(t,"UNSTABLE_MSC3089_BRANCH",(function(){return k.p})),n.d(t,"UNSTABLE_MSC2716_MARKER",(function(){return k.m})),n.d(t,"MSC3912_RELATION_BASED_REDACTIONS_PROP",(function(){return k.d})),n.d(t,"UNSTABLE_ELEMENT_FUNCTIONAL_USERS",(function(){return k.l})),n.d(t,"EVENT_VISIBILITY_CHANGE_TYPE",(function(){return k.a})),n.d(t,"PUSHER_ENABLED",(function(){return k.g})),n.d(t,"PUSHER_DEVICE_ID",(function(){return k.f})),n.d(t,"LOCAL_NOTIFICATION_SETTINGS_PREFIX",(function(){return k.c}));var x=n(235);n.d(t,"PushRuleActionName",(function(){return x.d})),n.d(t,"TweakName",(function(){return x.g})),n.d(t,"ConditionOperator",(function(){return x.b})),n.d(t,"DMMemberCountCondition",(function(){return x.c})),n.d(t,"isDmMemberCountCondition",(function(){return x.h})),n.d(t,"ConditionKind",(function(){return x.a})),n.d(t,"PushRuleKind",(function(){return x.e})),n.d(t,"RuleId",(function(){return x.f}));var T=n(161);n.d(t,"Visibility",(function(){return T.f})),n.d(t,"Preset",(function(){return T.d})),n.d(t,"JoinRule",(function(){return T.c})),n.d(t,"RestrictedAllowType",(function(){return T.e})),n.d(t,"GuestAccess",(function(){return T.a})),n.d(t,"HistoryVisibility",(function(){return T.b}));n(720);var j=n(433);n.d(t,"SearchOrderBy",(function(){return j.a}));var P=n(517);n.d(t,"RoomSummary",(function(){return P.a}));var D=n(274);n.d(t,"ContentHelpers",(function(){return D}));var N=n(190);n.d(t,"createNewMatrixCall",(function(){return N.h}));var M=n(226);n.d(t,"GroupCallEvent",(function(){return M.c})),n.d(t,"GroupCallIntent",(function(){return M.d})),n.d(t,"GroupCallState",(function(){return M.e})),n.d(t,"GroupCallType",(function(){return M.f}));let A=()=>new i.a;function L(e){A=e}function U(t){var n,i,r;return t.store=null!==(n=t.store)&&void 0!==n?n:new s.a({localStorage:e.localStorage}),t.scheduler=null!==(i=t.scheduler)&&void 0!==i?i:new o.a,t.cryptoStore=null!==(r=t.cryptoStore)&&void 0!==r?r:A(),t}function F(e){return new r.d(U(e))}function B(e,t,n,i){return new a.a(e,t,n,U(i))}}.call(this,n(14))},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.DEVICE="device",e.ROOM_DEVICE="room-device",e.ROOM_ACCOUNT="room-account",e.ACCOUNT="account",e.ROOM="room",e.PLATFORM="platform",e.CONFIG="config",e.DEFAULT="default"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"c",(function(){return a}));var i=n(120),s=n(177);let o;!function(e){e.Room="Room",e.Thread="Thread",e.ThreadsList="ThreadsList",e.File="File",e.Notification="Notification",e.Search="Search",e.Pinned="Pinned"}(o||(o={}));const r=Object(i.createContext)({roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!1,numUnreadMessages:0,canPeek:!1,showApps:!1,isPeeking:!1,showRightPanel:!0,joining:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canSelfRedact:!1,canSendMessages:!1,resizing:!1,layout:s.a.Group,singleSideBubbles:!1,adaptiveSideBubbles:!1,lowBandwidth:!1,alwaysShowTimestamps:!1,showTwelveHourTimestamps:!1,readMarkerInViewThresholdMs:3e3,readMarkerOutOfViewThresholdMs:3e4,showHiddenEvents:!1,showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:!1,showUrlPreview:!1,timelineRenderingType:o.Room,threadId:void 0,liveTimeline:void 0,narrow:!1,activeCall:null,msc3946ProcessDynamicPredecessor:!1});function a(){return Object(i.useContext)(r)}r.displayName="RoomContext",t.b=r},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i=n(134),s=n.n(i),o=n(122),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l),u=n(150),h=n(163);const m=["element","inputRef","prefixComponent","postfixComponent","className","onValidate","children","tooltipContent","forceValidity","tooltipClassName","list","validateOnBlur","validateOnChange","validateOnFocus","usePlaceholderAsHint","forceTooltipVisible"];function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const v="mx_Field";let f=1;class b extends c.a.PureComponent{constructor(e){super(e),r()(this,"id",void 0),r()(this,"inputRef",void 0),r()(this,"validateOnChange",Object(u.debounce)((()=>{this.validate({focused:!0})}),200)),r()(this,"onFocus",(e=>{var t,n;this.setState({focused:!0}),this.props.validateOnFocus&&this.validate({focused:!0}),null===(t=(n=this.props).onFocus)||void 0===t||t.call(n,e)})),r()(this,"onChange",(e=>{var t,n;this.props.validateOnChange&&this.validateOnChange(),null===(t=(n=this.props).onChange)||void 0===t||t.call(n,e)})),r()(this,"onBlur",(e=>{var t,n;this.setState({focused:!1}),this.props.validateOnBlur&&this.validate({focused:!1}),null===(t=(n=this.props).onBlur)||void 0===t||t.call(n,e)})),this.state={feedbackVisible:!1,focused:!1},this.id=this.props.id||`${v}_${f++}`}focus(){var e;null===(e=this.inputRef.current)||void 0===e||e.focus(),this.setState({focused:!0})}async validate(e){var t,n;let{focused:i,allowEmpty:s=!0}=e;if(!this.props.onValidate)return;const o=null!==(t=null===(n=this.inputRef.current)||void 0===n?void 0:n.value)&&void 0!==t?t:null,{valid:r,feedback:a}=await this.props.onValidate({value:o,focused:i,allowEmpty:s});return this.state.focused&&a?this.setState({valid:r,feedback:a,feedbackVisible:!0}):this.setState({valid:r,feedbackVisible:!1}),r}render(){var e;const t=this.props,{element:n,inputRef:i,prefixComponent:o,postfixComponent:r,className:a,onValidate:l,children:u,tooltipContent:p,forceValidity:v,tooltipClassName:f,list:b,validateOnBlur:y,validateOnChange:S,validateOnFocus:E,usePlaceholderAsHint:w,forceTooltipVisible:_}=t,C=s()(t,m);this.inputRef=i||c.a.createRef(),C.placeholder=null!==(e=C.placeholder)&&void 0!==e?e:C.label,C.id=this.id,C.onFocus=this.onFocus,C.onChange=this.onChange,C.onBlur=this.onBlur;const O=g(g({},C),{},{ref:this.inputRef,list:b}),I=c.a.createElement(this.props.element,O,u);let R,k;o&&(R=c.a.createElement("span",{className:"mx_Field_prefix"},o)),r&&(k=c.a.createElement("span",{className:"mx_Field_postfix"},r));const x=null!=v,T=d()("mx_Field",`mx_Field_${this.props.element}`,a,{mx_Field_labelAlwaysTopLeft:o||w,mx_Field_placeholderIsHint:w,mx_Field_valid:x?v:l&&!0===this.state.valid,mx_Field_invalid:x?!v:l&&!1===this.state.valid});let j;return(p||this.state.feedback)&&(j=c.a.createElement(h.b,{tooltipClassName:d()("mx_Field_tooltip","mx_Tooltip_noMargin",f),visible:this.state.focused&&_||this.state.feedbackVisible,label:p||this.state.feedback,alignment:h.b.Alignment.Right})),c.a.createElement("div",{className:T},R,I,c.a.createElement("label",{htmlFor:this.id},this.props.label),k,j)}}r()(b,"defaultProps",{element:"input",type:"text",validateOnFocus:!0,validateOnBlur:!0,validateOnChange:!0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return k})),n.d(t,"b",(function(){return T})),n.d(t,"d",(function(){return j})),n.d(t,"c",(function(){return P})),n.d(t,"e",(function(){return N}));var i=n(13),s=n.n(i),o=n(10),r=n(360),a=n(180),c=n(359),l=n(16),d=n(144),u=n(419),h=n(186),m=n(517),p=n(1),g=n(290),v=n(130),f=n(149),b=n(320),y=n(152),S=n(362),E=n(171),w=n(18),_=n(699),C=n(700),O=n(420);function I(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function R(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?I(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):I(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const k="9",x=["1","2","3","4","5","6","7","8","9"];let T,j;!function(e){e.Highlight="highlight",e.Total="total"}(T||(T={})),function(e){e.MyMembership="Room.myMembership",e.Tags="Room.tags",e.AccountData="Room.accountData",e.Receipt="Room.receipt",e.Name="Room.name",e.Redaction="Room.redaction",e.RedactionCancelled="Room.redactionCancelled",e.LocalEchoUpdated="Room.localEchoUpdated",e.Timeline="Room.timeline",e.TimelineReset="Room.timelineReset",e.TimelineRefresh="Room.TimelineRefresh",e.OldStateUpdated="Room.OldStateUpdated",e.CurrentStateUpdated="Room.CurrentStateUpdated",e.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",e.UnreadNotifications="Room.UnreadNotifications"}(j||(j={}));class P extends C.a{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};super(),this.roomId=e,this.client=t,this.myUserId=n,this.opts=i,s()(this,"reEmitter",void 0),s()(this,"txnToEvent",new Map),s()(this,"notificationCounts",{}),s()(this,"threadNotifications",new Map),s()(this,"cachedThreadReadReceipts",new Map),s()(this,"oldestThreadedReceiptTs",1/0),s()(this,"unthreadedReceipts",new Map),s()(this,"timelineSets",void 0),s()(this,"polls",new Map),s()(this,"threadsTimelineSets",[]),s()(this,"filteredTimelineSets",{}),s()(this,"timelineNeedsRefresh",!1),s()(this,"pendingEventList",void 0),s()(this,"blacklistUnverifiedDevices",void 0),s()(this,"selfMembership",void 0),s()(this,"summaryHeroes",null),s()(this,"getTypeWarning",!1),s()(this,"getVersionWarning",!1),s()(this,"membersPromise",void 0),s()(this,"name",void 0),s()(this,"normalizedName",void 0),s()(this,"tags",{}),s()(this,"accountData",new Map),s()(this,"summary",null),s()(this,"timeline",void 0),s()(this,"oldState",void 0),s()(this,"currentState",void 0),s()(this,"relations",new _.a(this.client,this)),s()(this,"threads",new Map),s()(this,"lastThread",void 0),s()(this,"visibilityEvents",new Map),s()(this,"threadTimelineSetsPromise",null),s()(this,"threadsReady",!1),s()(this,"updateThreadRootEvents",((e,t,n)=>{var i,s;e.length&&(this.updateThreadRootEvent(null===(i=this.threadsTimelineSets)||void 0===i?void 0:i[0],e,t,n),e.hasCurrentUserParticipated&&this.updateThreadRootEvent(null===(s=this.threadsTimelineSets)||void 0===s?void 0:s[1],e,t,n))})),s()(this,"updateThreadRootEvent",((e,t,n,i)=>{e&&t.rootEvent&&(i&&e.removeEvent(t.id),E.e.hasServerSideSupport?e.addLiveEvent(t.rootEvent,{duplicateStrategy:r.a.Replace,fromCache:!1,roomState:this.currentState}):e.addEventToTimeline(t.rootEvent,e.getLiveTimeline(),{toStartOfTimeline:n}))})),s()(this,"applyRedaction",(e=>{if(e.isRedaction()){const t=e.event.redacts,n=t?this.findEventById(t):void 0;if(n){if(n.makeRedacted(e),n.isState()){const e=this.currentState.getStateEvents(n.getType(),n.getStateKey());(null==e?void 0:e.getId())===n.getId()&&this.currentState.setStateEvents([n])}this.emit(j.Redaction,e,this),this.visibilityEvents.delete(t),n.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}}})),this.setMaxListeners(100),this.reEmitter=new g.b(this),i.pendingEventOrdering=i.pendingEventOrdering||f.e.Chronological,this.name=e,this.normalizedName=e,this.timelineSets=[new r.b(this,i)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[j.Timeline,j.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===f.e.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then((e=>{const n=this.client.getEventMapper({toDevice:!1,decrypt:!1});e.forEach((async e=>{const i=n(e);await t.decryptEventIfNeeded(i),i.setStatus(u.a.NOT_SENT),this.addPendingEvent(i,i.getTxnId())}))}))),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}async createThreadsTimelineSets(){var e;if(this.threadTimelineSetsPromise)return this.threadTimelineSetsPromise;if(null!==(e=this.client)&&void 0!==e&&e.supportsThreads())try{this.threadTimelineSetsPromise=Promise.all([this.createThreadTimelineSet(),this.createThreadTimelineSet(E.g.My)]);const e=await this.threadTimelineSetsPromise;return this.threadsTimelineSets.push(...e),e}catch(e){return this.threadTimelineSetsPromise=null,null}return null}async decryptCriticalEvents(){if(!this.client.isCryptoEnabled())return;const e=this.getEventReadUpTo(this.client.getUserId(),!0),t=this.getLiveTimeline().getEvents(),n=t.findIndex((t=>t.event.event_id===e)),i=t.slice(n).reverse().map((e=>this.client.decryptEventIfNeeded(e,{isRetry:!0})));await Promise.allSettled(i)}async decryptAllEvents(){if(!this.client.isCryptoEnabled())return;const e=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map((e=>this.client.decryptEventIfNeeded(e,{isRetry:!0})));await Promise.allSettled(e)}getCreator(){var e;const t=this.currentState.getStateEvents(v.b.RoomCreate,"");return null!==(e=null==t?void 0:t.getContent().creator)&&void 0!==e?e:null}getVersion(){var e;const t=this.currentState.getStateEvents(v.b.RoomCreate,"");return t?null!==(e=t.getContent().room_version)&&void 0!==e?e:"1":(this.getVersionWarning||(p.a.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}shouldUpgradeToVersion(){return x.includes(this.getVersion())?null:k}async getRecommendedVersion(){let e=(await this.client.getCapabilities())["m.room_versions"];if(!e){e={default:k,available:{}};for(const t of x)e.available[t]=f.f.Stable}let t=this.checkVersionAgainstCapability(e);if(t.urgent&&t.needsUpgrade){p.a.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");if(e=(await this.client.getCapabilities(!0))["m.room_versions"],!e)return p.a.warn("No room version capability - assuming upgrade required."),t;t=this.checkVersionAgainstCapability(e)}return t}checkVersionAgainstCapability(e){const t=this.getVersion();p.a.log(`[${this.roomId}] Current version: ${t}`),p.a.log(`[${this.roomId}] Version capability: `,e);const n={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return n;return Object.keys(e.available).filter((t=>"stable"===e.available[t])).includes(t)||(n.version=e.default,n.needsUpgrade=!0,n.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),n.urgent?p.a.warn(`URGENT upgrade required on ${this.roomId}`):p.a.warn(`Non-urgent upgrade required on ${this.roomId}`)),n}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(v.b.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);const t=l.I(this.pendingEventList,(function(t){return t.getId()==e}),!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,n;return null!==(t=null===(n=this.pendingEventList)||void 0===n?void 0:n.some((t=>t.getId()===e)))&&void 0!==t&&t}getPendingEvent(e){var t,n;return null!==(t=null===(n=this.pendingEventList)||void 0===n?void 0:n.find((t=>t.getId()===e)))&&void 0!==t?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}getLastActiveTimestamp(){const e=this.getLiveTimeline().getEvents();if(e.length){return e[e.length-1].getTs()}return Number.MIN_SAFE_INTEGER}getMyMembership(){var e;return null!==(e=this.selfMembership)&&void 0!==e?e:"leave"}getDMInviter(){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if("invite"===this.selfMembership){var t;if(2===this.getInvitedAndJoinedMemberCount())return null===(t=this.summaryHeroes)||void 0===t?void 0:t[0]}}guessDMUserId(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];const t=this.currentState.getMembers().find((e=>e.userId!==this.myUserId));return t?t.userId:this.myUserId}getAvatarFallbackMember(){if(this.getInvitedAndJoinedMemberCount()>2)return;const e=Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length;if(e){const e=this.summaryHeroes.map((e=>this.getMember(e))).find((e=>!!e));if(e)return e}const t=this.currentState.getMembers();if(t.length<=2){const e=t.find((e=>e.userId!==this.myUserId));if(e)return e}if(e){const e=this.summaryHeroes.map((e=>this.client.getUser(e))).find((e=>!!e));if(e){const t=new h.a(this.roomId,e.userId);return t.user=e,t}}}updateMyMembership(e){const t=this.selfMembership;this.selfMembership=e,t!==e&&("leave"===e&&this.cleanupAfterLeaving(),this.emit(j.MyMembership,this,e,t))}async loadMembersFromServer(){const e=this.client.store.getSyncToken();return(await this.client.members(this.roomId,void 0,"leave",null!=e?e:void 0)).chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);(null===t||this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId))&&(e=!0,t=await this.loadMembersFromServer(),p.a.log(`LL: got ${t.length} members from server for room ${this.roomId}`));return{memberEvents:t.filter(l.A).map(this.client.getEventMapper()),fromServer:e}}membersLoaded(){return!this.opts.lazyLoadMembers||this.currentState.outOfBandMembersReady()}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this.loadMembers().then((e=>(this.currentState.setOutOfBandMembers(e.memberEvents),e.fromServer))).catch((e=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),e}));return e.then((e=>{if(e){const e=this.currentState.getMembers().filter((e=>e.isOutOfBand())).map((e=>{var t;return null===(t=e.events.member)||void 0===t?void 0:t.event}));p.a.log(`LL: telling store to write ${e.length} members for room ${this.roomId}`);return this.client.store.setOutOfBandMembers(this.roomId,e).catch((e=>{p.a.log("LL: storing OOB room members failed, oh well",e)}))}})).catch((e=>{p.a.error(e)})),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=void 0)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch((e=>{p.a.error(`error after clearing loaded members from room ${this.roomId} after leaving`),p.a.log(e)}))}async refreshLiveTimeline(){const e=this.getLiveTimeline(),t=e.getPaginationToken(a.b.FORWARDS),n=e.getPaginationToken(a.b.BACKWARDS),i=e.getEvents(),s=i[i.length-1];p.a.log(`[refreshLiveTimeline for ${this.roomId}] at mostRecentEventInTimeline=${s&&s.getId()} liveTimelineBefore=${e.toString()} forwardPaginationToken=${t} backwardPaginationToken=${n}`);const o=this.getUnfilteredTimelineSet();let r;s?(this.resetLiveTimeline(null,null),this.emit(j.TimelineRefresh,this,o),r=await this.client.getEventTimeline(o,s.getId())):r=await this.client.getLatestTimeline(o);const c=o.getLiveTimeline();!c||null===c.getPaginationToken(a.a.Forward)&&null===c.getPaginationToken(a.a.Backward)&&0===c.getEvents().length?(p.a.log(`[refreshLiveTimeline for ${this.roomId}] using our new live timeline`),r.setPaginationToken(t,a.b.FORWARDS),o.setLiveTimeline(r),this.fixUpLegacyTimelineFields()):p.a.log(`[refreshLiveTimeline for ${this.roomId}] \`/sync\` or some other request beat us to creating a new live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history.`),this.setTimelineNeedsRefresh(!1),this.emit(j.TimelineRefresh,this,o)}resetLiveTimeline(e,t){for(const n of this.timelineSets)n.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);for(const n of this.threads.values())n.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){const e=this.oldState,t=this.currentState;this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(a.b.BACKWARDS),this.currentState=this.getLiveTimeline().getState(a.b.FORWARDS),e!==this.oldState&&this.emit(j.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(j.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[y.b.Events,y.b.Members,y.b.NewMember,y.b.Update,y.b.Marker,S.b.New,S.b.Update,S.b.Destroy,S.b.LivenessChange]),this.reEmitter.reEmit(this.currentState,[y.b.Events,y.b.Members,y.b.NewMember,y.b.Update,y.b.Marker,S.b.New,S.b.Update,S.b.Destroy,S.b.LivenessChange]))}async hasUnverifiedDevices(){if(!this.client.isRoomEncrypted(this.roomId))return!1;const e=await this.getEncryptionTargetMembers();for(const t of e){if(this.client.getStoredDevicesForUser(t.userId).some((e=>e.isUnverified())))return!0}return!1}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){const t=this.findEventById(e),n=this.findThreadForEvent(t);return n?n.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){let t=this.getUnfilteredTimelineSet().findEventById(e);if(!t){const n=this.getThreads();for(let i=0;i<n.length;i++){if(t=n[i].findEventById(e),t)return t}}return t}getUnreadNotificationCount(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:T.Total,t=this.getRoomUnreadNotificationCount(e);for(const i of this.threadNotifications.values()){var n;t+=null!==(n=i[e])&&void 0!==n?n:0}return t}getUnreadCountForEventContext(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:T.Total,n=arguments.length>1?arguments[1]:void 0;return null!==(e=!!n.threadRootId&&!n.isThreadRoot?this.getThreadUnreadNotificationCount(n.threadRootId,t):this.getRoomUnreadNotificationCount(t))&&void 0!==e?e:0}getRoomUnreadNotificationCount(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:T.Total;return null!==(e=this.notificationCounts[t])&&void 0!==e?e:0}getThreadUnreadNotificationCount(e){var t,n;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:T.Total;return null!==(t=null===(n=this.threadNotifications.get(e))||void 0===n?void 0:n[i])&&void 0!==t?t:0}hasThreadUnreadNotification(){for(const n of this.threadNotifications.values()){var e,t;if((null!==(e=n.highlight)&&void 0!==e?e:0)>0||(null!==(t=n.total)&&void 0!==t?t:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,n){var i,s;const o=R({highlight:null===(i=this.threadNotifications.get(e))||void 0===i?void 0:i.highlight,total:null===(s=this.threadNotifications.get(e))||void 0===s?void 0:s.total},{[t]:n});this.threadNotifications.set(e,o),this.emit(j.UnreadNotifications,o,e)}get threadsAggregateNotificationType(){let e=null;for(const i of this.threadNotifications.values()){var t,n;if((null!==(t=i.highlight)&&void 0!==t?t:0)>0)return T.Highlight;(null!==(n=i.total)&&void 0!==n?n:0)>0&&!e&&(e=T.Total)}return e}resetThreadUnreadNotificationCount(e){if(e)for(const[t]of this.threadNotifications)e.includes(t)||this.threadNotifications.delete(t);else this.threadNotifications.clear();this.emit(j.UnreadNotifications)}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(j.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){const t=e["m.heroes"],n=e["m.joined_member_count"],i=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(i)&&this.currentState.setInvitedMemberCount(i),Array.isArray(t)&&(this.summaryHeroes=t.filter((e=>e!==this.myUserId)))}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return void 0===this.blacklistUnverifiedDevices?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,n,i){let s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];const o=this.currentState.getStateEvents(v.b.RoomAvatar,"");if(!o&&!s)return null;const r=o?o.getContent().url:null;return r?Object(c.a)(e,r,t,n,i):null}getMxcAvatarUrl(){var e,t;return(null===(e=this.currentState.getStateEvents(v.b.RoomAvatar,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.url)||null}getCanonicalAlias(){const e=this.currentState.getStateEvents(v.b.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){const e=this.currentState.getStateEvents(v.b.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,n,i){n.getTimelineSet().addEventsToTimeline(e,t,n,i)}getThread(e){var t;return null!==(t=this.threads.get(e))&&void 0!==t?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership("join")}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),e}shouldEncryptForInvitedMembers(){var e;const t=this.currentState.getStateEvents(v.b.RoomHistoryVisibility,"");return"joined"!==(null==t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){const n=this.getMember(e);return!!n&&n.membership===t}getOrCreateFilteredTimelineSet(e){let{prepopulateTimeline:t=!0,useSyncEvents:n=!0,pendingEvents:i=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];const s=Object.assign({filter:e,pendingEvents:i},this.opts),o=new r.b(this,s);this.reEmitter.reEmit(o,[j.Timeline,j.TimelineReset]),n&&(this.filteredTimelineSets[e.filterId]=o,this.timelineSets.push(o));const c=this.getLiveTimeline();if(t){c.getEvents().forEach((function(e){o.addLiveEvent(e)}));let e=c;for(;e.getNeighbouringTimeline(a.b.BACKWARDS);)e=e.getNeighbouringTimeline(a.b.BACKWARDS);o.getLiveTimeline().setPaginationToken(e.getPaginationToken(a.b.BACKWARDS),a.b.BACKWARDS)}else if(n){const e=c.getPaginationToken(a.a.Forward);o.getLiveTimeline().setPaginationToken(e,a.a.Backward)}return o}async getThreadListFilter(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:E.g.All;const t=this.client.getUserId(),n=new b.a(t),i={room:{timeline:{[E.a.name]:[E.d.name]}}};e===E.g.My&&(i.room.timeline[E.b.name]=[t]),n.setDefinition(i);const s=await this.client.getOrCreateFilter(`THREAD_PANEL_${this.roomId}_${e}`,n);return n.filterId=s,n}async createThreadTimelineSet(e){let t;if(E.e.hasServerSideListSupport)t=new r.b(this,R(R({},this.opts),{},{pendingEvents:!1}),void 0,void 0,null!=e?e:E.g.All),this.reEmitter.reEmit(t,[j.Timeline,j.TimelineReset]);else if(E.e.hasServerSideSupport){const n=await this.getThreadListFilter(e);t=this.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else t=new r.b(this,{pendingEvents:!1}),Array.from(this.threads).forEach((n=>{let[,i]=n;if(0===i.length)return;const s=i.timeline.some((e=>e.getSender()===this.client.getUserId()));(e!==E.g.My||s)&&t.getLiveTimeline().addEvent(i.rootEvent,{toStartOfTimeline:!1})}));return t}processThreadRoots(e,t){for(const n of e)a.b.setEventMetadata(n,this.currentState,t),this.getThread(n.getId())||this.createThread(n.getId(),n,[],t)}async fetchRoomThreads(){if(!this.threadsReady&&this.client.supportsThreads()){if(E.e.hasServerSideListSupport)await Promise.all([this.fetchRoomThreadList(E.g.All),this.fetchRoomThreadList(E.g.My)]);else{const n=await this.getThreadListFilter(),{chunk:i}=await this.client.createMessagesRequest(this.roomId,"",Number.MAX_SAFE_INTEGER,a.a.Backward,n);if(!i.length)return;const s=i.map(this.client.getEventMapper()).sort(((e,t)=>{const n=e.getServerAggregatedRelation(E.d.name),i=t.getServerAggregatedRelation(E.d.name);return n.latest_event.origin_server_ts-i.latest_event.origin_server_ts}));let o;const c=this.getLiveTimeline().getState(a.b.FORWARDS);for(const n of s){var e;const i={duplicateStrategy:r.a.Ignore,fromCache:!1,roomState:c};null===(e=this.threadsTimelineSets[0])||void 0===e||e.addLiveEvent(n,i);const s=n.getServerAggregatedRelation(E.d.name);var t;if(null!=s&&s.current_user_participated)null===(t=this.threadsTimelineSets[1])||void 0===t||t.addLiveEvent(n,i),o=n}this.processThreadRoots(s,!0),this.client.decryptEventIfNeeded(s[s.length-1]),o&&this.client.decryptEventIfNeeded(o)}this.on(E.f.NewReply,this.onThreadNewReply),this.on(E.f.Delete,this.onThreadDelete),this.threadsReady=!0}}async processPollEvents(e){const t=e=>{if(o.M_POLL_START.matches(e.getType()))try{const t=new O.a(e,this.client,this);this.polls.set(e.getId(),t),this.emit(O.b.New,t)}catch{}},n=e=>{const t=e.relationEventId;if(t&&this.polls.has(t)){const n=this.polls.get(t);null==n||n.onNewRelation(e)}},i=e=>{t(e),n(e)};for(const t of e)try{await this.client.decryptEventIfNeeded(t),i(t)}catch{}}async fetchRoomThreadList(e){const t=e===E.g.My?this.threadsTimelineSets[1]:this.threadsTimelineSets[0],{chunk:n,end:i}=await this.client.createThreadListMessagesRequest(this.roomId,null,void 0,a.a.Backward,t.threadListType,t.getFilter());if(t.getLiveTimeline().setPaginationToken(null!=i?i:null,a.a.Backward),!n.length)return;const s=n.map(this.client.getEventMapper());this.processThreadRoots(s,!0);const o=this.getLiveTimeline().getState(a.b.FORWARDS);for(const e of s)t.addLiveEvent(e,{duplicateStrategy:r.a.Replace,fromCache:!1,roomState:o})}onThreadNewReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);const n=this.getTimelineForEvent(e.id),i=null==n||null===(t=n.getEvents())||void 0===t?void 0:t.find((t=>t.getId()===e.id));i?e.clearEventMetadata(i):p.a.debug("onThreadDelete: Could not find root event in room timeline");for(const t of this.threadsTimelineSets)t.removeEvent(e.id)}removeFilteredTimelineSet(e){const t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];const n=this.timelineSets.indexOf(t);n>-1&&this.timelineSets.splice(n,1)}eventShouldLiveIn(e,t,n){var i,s;if(null===(i=this.client)||void 0===i||!i.supportsThreads())return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||null!=n&&n.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};if(e.isRelation(E.d.name))return{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:e.threadRootId};const o=e.getAssociatedId(),r=null!==(s=this.findEventById(o))&&void 0!==s?s:null==t?void 0:t.find((e=>e.getId()===o));return r&&(e.isRelation()||e.isRedaction())?this.eventShouldLiveIn(r,t,n):null!=n&&n.has(e.relationEventId)?{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.relationEventId}:{shouldLiveInRoom:!0,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;const{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.getThread(e);if(!i){var s;const o=null!==(s=this.findEventById(e))&&void 0!==s?s:t.find((t=>t.getId()===e));i=this.createThread(e,o,t,n)}i.addEvents(t,n)}processThreadedEvents(e,t){e.forEach(this.applyRedaction);const n={};for(const t of e){var i;const{threadId:e,shouldLiveInThread:s}=this.eventShouldLiveIn(t);s&&!n[e]&&(n[e]=[]),null===(i=n[e])||void 0===i||i.push(t)}Object.entries(n).map((e=>{let[n,i]=e;return this.addThreadedEvents(n,i,t)}))}createThread(e,t){var n,i,s;let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){const e=this.relations.getAllChildEventsForEvent(t.getId());null!=e&&e.length&&(o=o.concat(e.filter((e=>!e.isRelation(v.h.Replace)))))}const a=new E.e(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:null!==(n=this.cachedThreadReadReceipts.get(e))&&void 0!==n?n:[]});this.cachedThreadReadReceipts.delete(e),this.threads.set(a.id,a),a.addEvents(o,!1),this.reEmitter.reEmit(a,[E.f.Delete,E.f.Update,E.f.NewReply,j.Timeline,j.TimelineReset]);const c=(null===(i=this.lastThread)||void 0===i?void 0:i.rootEvent)&&(null==t?void 0:t.localTimestamp)&&(null===(s=this.lastThread.rootEvent)||void 0===s?void 0:s.localTimestamp)<(null==t?void 0:t.localTimestamp);return this.lastThread&&!c||(this.lastThread=a),this.threadsReady&&this.updateThreadRootEvents(a,r,!1),this.emit(E.f.New,a,r),a}processLiveEvent(e){this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);if(!e.getUnsigned().transaction_id&&e.getSender()===this.myUserId)for(const[t,n]of this.txnToEvent)if(n.getId()===e.getId()){p.a.debug("processLiveEvent: found sent event without txn ID: ",t,e.getId());const n=e.getUnsigned();n.transaction_id=t,e.setUnsigned(n);break}}addLiveEvent(e,t){const{duplicateStrategy:n,timelineWasEmpty:i,fromCache:s}=t;for(const t of this.timelineSets)t.addLiveEvent(e,{duplicateStrategy:n,fromCache:s,timelineWasEmpty:i});e.sender&&e.getType()!==v.b.RoomRedaction&&this.addReceipt(Object(C.b)(e.sender.userId,e,w.b.Read),!0)}addPendingEvent(e,t){if(e.status!==u.a.SENDING&&e.status!==u.a.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(a.b.setEventMetadata(e,this.getLiveTimeline().getState(a.b.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some((e=>e.status===u.a.NOT_SENT))&&(p.a.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(u.a.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){const t=e.event.redacts;let n=this.pendingEventList.find((e=>e.getId()===t));!n&&t&&(n=this.findEventById(t)),n&&(n.markLocallyRedacted(e),this.emit(j.Redaction,e,this))}}else for(const t of this.timelineSets)t.getFilter()?t.getFilter().filterRoomTimeline([e]).length&&t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1}):t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1});this.emit(j.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){const e=this.pendingEventList.map((e=>R(R({},e.event),{},{txn_id:e.getTxnId()}))).filter((e=>{const t=e.type===v.b.RoomMessageEncrypted,n=this.client.isRoomEncrypted(this.roomId);return t||!n}));this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){const n=t.getId(),i=e.getId(),s=t.status;p.a.debug(`Got remote echo for event ${n} -> ${i} old status ${s}`),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(n),t.handleRemoteEcho(e.event);const{shouldLiveInRoom:o,threadId:r}=this.eventShouldLiveIn(e),a=r?this.getThread(r):null;if(null==a||a.setEventMetadata(t),null==a||a.timelineSet.handleRemoteEcho(t,n,i),o)for(const e of this.timelineSets)e.handleRemoteEcho(t,n,i);this.emit(j.LocalEchoUpdated,t,this,n,s)}updatePendingEvent(e,t,n){if(p.a.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${n}`),t==u.a.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==u.a.SENT){if(this.getTimelineForEvent(n)){const t=this.findEventById(n);if(!(null==t?void 0:t.getUnsigned().transaction_id)&&t){const n=t.getUnsigned();n.transaction_id=e.getTxnId(),t.setUnsigned(n),this.removeEvent(t.getId()),this.handleRemoteEcho(t,e)}return}}const i=e.status,s=e.getId();if(!i)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const o=D[i];if(null==o||!o.includes(t))throw new Error(`Invalid EventStatus transition ${i}->${t}`);if(e.setStatus(t),t==u.a.SENT){e.replaceLocalEventId(n);const{shouldLiveInRoom:t,threadId:i}=this.eventShouldLiveIn(e),o=i?this.getThread(i):void 0;if(null==o||o.setEventMetadata(e),null==o||o.timelineSet.replaceEventId(s,n),t)for(const e of this.timelineSets)e.replaceEventId(s,n)}else if(t==u.a.CANCELLED){if(this.pendingEventList){const e=this.getPendingEvent(s);this.removePendingEvent(s),null!=e&&e.isRedaction()&&this.revertRedactionLocalEcho(e)}this.removeEvent(s)}this.savePendingEvents(),this.emit(j.LocalEchoUpdated,e,this,s,i)}revertRedactionLocalEcho(e){const t=e.event.redacts;if(!t)return;const n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit(j.RedactionCancelled,e,this),n.isRelation()&&this.aggregateNonLiveRelation(n))}addLiveEvents(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t,s=!1;if("object"==typeof t?({duplicateStrategy:i,fromCache:n=!1,timelineWasEmpty:s}=t):void 0!==t&&p.a.warn("Overload deprecated: `Room.addLiveEvents(events, duplicateStrategy?, fromCache?)` is deprecated in favor of the overload with `Room.addLiveEvents(events, IAddLiveEventOptions)`"),i&&-1===["replace","ignore"].indexOf(i))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let e=0;e<this.timelineSets.length;e++){const t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(a.b.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(a.b.FORWARDS)+")");if(t.getNeighbouringTimeline(a.b.FORWARDS))throw new Error(`live timeline ${e} is no longer live - it has a neighbouring timeline`)}const o=this.findThreadRoots(e),r={},c={duplicateStrategy:i,fromCache:n,timelineWasEmpty:s};for(const t of e){var l;if(this.processLiveEvent(t),t.getUnsigned().transaction_id){const e=this.txnToEvent.get(t.getUnsigned().transaction_id);if(e){this.handleRemoteEcho(t,e);continue}}const{shouldLiveInRoom:n,shouldLiveInThread:i,threadId:s}=this.eventShouldLiveIn(t,e,o);i&&!r[null!=s?s:""]&&(r[null!=s?s:""]=[]),null===(l=r[null!=s?s:""])||void 0===l||l.push(t),n&&this.addLiveEvent(t,c)}Object.entries(r).forEach((e=>{let[t,n]=e;this.addThreadedEvents(t,n,!1)}))}partitionThreadedEvents(e){if(this.client.supportsThreads()){const t=this.findThreadRoots(e);return e.reduce(((n,i)=>{const{shouldLiveInRoom:s,shouldLiveInThread:o,threadId:r}=this.eventShouldLiveIn(i,e,t);return s&&n[0].push(i),o&&(i.setThreadId(null!=r?r:""),n[1].push(i)),n}),[[],[]])}return[e,[]]}findThreadRoots(e){const t=new Set;for(const i of e){var n;if(i.isRelation(E.d.name))t.add(null!==(n=i.relationEventId)&&void 0!==n?n:"")}return t}addReceipt(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=e.getContent();Object.keys(n).forEach((e=>{Object.keys(n[e]).forEach((i=>{Object.keys(n[e][i]).forEach((s=>{var o,r,a;const c=n[e][i][s],l=!c.thread_id||c.thread_id===w.a,d=l?this:this.threads.get(null!==(o=c.thread_id)&&void 0!==o?o:"");var u;if(d){if(d.addReceiptToStructure(e,i,s,c,t),this.client.isInitialSyncComplete()&&s===this.client.getUserId()){const t=d.timeline[d.timeline.length-1];t&&e===t.getId()&&s===t.getSender()&&(d.setUnread(T.Total,0),d.setUnread(T.Highlight,0))}}else this.cachedThreadReadReceipts.set(c.thread_id,[...null!==(u=this.cachedThreadReadReceipts.get(c.thread_id))&&void 0!==u?u:[],{eventId:e,receiptType:i,userId:s,receipt:c,synthetic:t}]);s===this.client.getUserId()&&!l&&c.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=c.ts),!c.thread_id&&c.ts>(null!==(r=null===(a=this.unthreadedReceipts.get(s))||void 0===a?void 0:a.ts)&&void 0!==r?r:0)&&this.unthreadedReceipts.set(s,c)}))}))})),this.emit(j.Receipt,e,this)}addEphemeralEvents(e){for(const t of e)t.getType()===v.b.Typing?this.currentState.setTypingEvent(t):t.getType()===v.b.Receipt&&this.addReceipt(t)}removeEvents(e){for(const t of e)this.removeEvent(t)}removeEvent(e){let t=!1;for(const n of this.timelineSets){const i=n.removeEvent(e);i&&(i.isRedaction()&&this.revertRedactionLocalEcho(i),t=!0)}return t}recalculate(){const e=this.currentState.getStateEvents(v.b.RoomMember,this.myUserId);if(e){const t=e.getContent().membership;if(this.updateMyMembership(t),"invite"===t){(e.getUnsigned().invite_room_state||[]).forEach((e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new d.b({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])}))}}const t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=Object(l.B)(this.name),this.summary=new m.a(this.roomId,{title:this.name}),t!==this.name&&this.emit(j.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(j.Tags,e,this)}addAccountData(e){for(const t of e){"m.tag"===t.getType()&&this.addTags(t);const e=t.getType(),n=this.accountData.get(e);this.accountData.set(e,t),this.emit(j.AccountData,t,this,n)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return"join"===this.getMyMembership()&&(this.client.isRoomEncrypted(this.roomId)?this.currentState.maySendEvent(v.b.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(v.b.RoomMessage,this.myUserId))}canInvite(e){let t="join"===this.getMyMembership();const n=this.currentState.getStateEvents(v.b.RoomPowerLevels,""),i=n&&n.getContent(),s=this.getMember(e);return i&&s&&i.invite>s.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){const e=this.currentState.getStateEvents(v.b.RoomCreate,"");if(e)return e.getContent()[v.i];this.getTypeWarning||(p.a.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isSpaceRoom(){return this.getType()===v.j.Space}isCallRoom(){return this.getType()===v.j.UnstableCall}isElementVideoRoom(){return this.getType()===v.j.ElementVideo}findPredecessor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.getLiveTimeline().getState(a.b.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){const t=this.client.roomNameGenerator(this.roomId,e);if(null!==t)return t}switch(e.type){case N.Actual:return e.name;case N.Generated:return"Inviting"===e.subtype?`Inviting ${M(e.names,e.count)}`:M(e.names,e.count);case N.EmptyRoom:return e.oldName?`Empty room (was ${e.oldName})`:"Empty room"}}calculateRoomName(e){if(!(arguments.length>1&&void 0!==arguments[1]&&arguments[1])){const e=this.currentState.getStateEvents(v.b.RoomName,"");if(null!=e&&e.getContent().name)return this.roomNameGenerator({type:N.Actual,name:e.getContent().name})}const t=this.getCanonicalAlias();if(t)return this.roomNameGenerator({type:N.Actual,name:t});let n=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1,i=[];const s=this.currentState.getStateEvents(v.l.name,"");Array.isArray(null==s?void 0:s.getContent().service_members)&&(i=s.getContent().service_members);let o=[];if(this.summaryHeroes)this.summaryHeroes.forEach((e=>{if(i.includes(e))return void n--;const t=this.getMember(e);o.push(t?t.name:e)}));else{let t=this.currentState.getMembers().filter((t=>t.userId!==e&&("invite"===t.membership||"join"===t.membership)));t=t.filter((e=>{let{userId:t}=e;return!i.includes(t)||(n--,!1)})),t.sort(((e,t)=>l.h(e.userId,t.userId))),t=t.slice(0,5),o=t.map((e=>e.name))}if(n)return this.roomNameGenerator({type:N.Generated,names:o,count:n});if("join"==this.getMyMembership()){const e=this.currentState.getStateEvents(v.b.RoomThirdPartyInvite);if(null!=e&&e.length){const t=e.map((e=>e.getContent().display_name));return this.roomNameGenerator({type:N.Generated,subtype:"Inviting",names:t,count:t.length+1})}}let r,a=o;return a.length||(a=this.currentState.getMembers().filter((t=>t.userId!==e&&"invite"!==t.membership&&"join"!==t.membership)).map((e=>e.name))),a.length&&(r=this.roomNameGenerator({type:N.Generated,names:a,count:a.length+1})),this.roomNameGenerator({type:N.EmptyRoom,oldName:r})}applyNewVisibilityEvent(e){const t=e.asVisibilityChange();if(!t)return;const n=e.getSender();if(!n)return;if(!(v.a.name&&this.currentState.maySendStateEvent(v.a.name,n)||v.a.altName&&this.currentState.maySendStateEvent(v.a.altName,n)))return;const i=this.visibilityEvents.get(t.eventId);if(i){let t=i.length-1;const n=Math.max(0,i.length-30);for(;t>=n;--t){if(i[t].getTs()<e.getTs())break}-1===t?i.unshift(e):i.splice(t+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);const s=this.findEventById(t.eventId);s&&s.applyVisibilityEvent(t)}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");const t=e.getRelation(),n=null==t?void 0:t.event_id,i=this.visibilityEvents.get(n);if(!i)return;const s=i.findIndex((t=>t.getId()===e.getId()));if(-1!==s&&(i.splice(s,1),s===i.length)){const e=this.findEventById(n);if(!e)return;if(0===s)this.visibilityEvents.delete(n),e.applyVisibilityEvent();else{const t=i[i.length-1].asVisibilityChange();if(!t)throw new Error("at this stage, visibility changes should be well-formed");e.applyVisibilityEvent(t)}}}applyPendingVisibilityEvents(e){const t=this.visibilityEvents.get(e.getId());if(!t||0==t.length)return;const n=t[t.length-1],i=n.asVisibilityChange();i&&(i.visible,n.getTs()<e.getTs()||e.applyVisibilityEvent(i))}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);const t=this.getThreads().filter((e=>this.getThreadUnreadNotificationCount(e.id,T.Total)>0));for(const n of t)n.fixupNotifications(e)}}const D={[u.a.ENCRYPTING]:[u.a.SENDING,u.a.NOT_SENT,u.a.CANCELLED],[u.a.SENDING]:[u.a.ENCRYPTING,u.a.QUEUED,u.a.NOT_SENT,u.a.SENT],[u.a.QUEUED]:[u.a.SENDING,u.a.NOT_SENT,u.a.CANCELLED],[u.a.SENT]:[],[u.a.NOT_SENT]:[u.a.SENDING,u.a.QUEUED,u.a.CANCELLED],[u.a.CANCELLED]:[]};let N;function M(e,t){const n=t-1;if(e.length){if(1===e.length&&n<=1)return e[0];if(2===e.length&&n<=2)return`${e[0]} and ${e[1]}`;return n>1?`${e[0]} and ${n} others`:`${e[0]} and 1 other`}return"Empty room"}!function(e){e[e.EmptyRoom=0]="EmptyRoom",e[e.Generated=1]="Generated",e[e.Actual=2]="Actual"}(N||(N={}))},function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return o})),n.d(t,"d",(function(){return r})),n.d(t,"b",(function(){return a}));var i=n(120);function s(e,t,n){o(e,t,n)}function o(e,t,n){const s=Object(i.useRef)(n);Object(i.useEffect)((()=>{s.current=n}),[n]),Object(i.useEffect)((()=>{if(!e)return;const n=function(){return s.current(...arguments)};return e.on(t,n),()=>{e.off(t,n)}}),[t,e])}function r(e,t,n){return a(e,t,n)}function a(e,t,n){const[s,r]=Object(i.useState)(n),a=Object(i.useCallback)((function(){r(n(...arguments))}),[n]);return Object(i.useEffect)(a,[e]),o(e,t,a),s}},function(e,t,n){"use strict";n.d(t,"h",(function(){return o})),n.d(t,"c",(function(){return r})),n.d(t,"e",(function(){return a})),n.d(t,"a",(function(){return c})),n.d(t,"g",(function(){return l})),n.d(t,"b",(function(){return d})),n.d(t,"d",(function(){return u})),n.d(t,"i",(function(){return h})),n.d(t,"f",(function(){return m}));var i=n(121),s=n(208);let o,r;!function(e){e.SendMessage="KeyBinding.sendMessageInComposer",e.SelectPrevSendHistory="KeyBinding.previousMessageInComposerHistory",e.SelectNextSendHistory="KeyBinding.nextMessageInComposerHistory",e.EditPrevMessage="KeyBinding.editPreviousMessage",e.EditNextMessage="KeyBinding.editNextMessage",e.CancelReplyOrEdit="KeyBinding.cancelReplyInComposer",e.ShowStickerPicker="KeyBinding.showStickerPicker",e.FormatBold="KeyBinding.toggleBoldInComposer",e.FormatItalics="KeyBinding.toggleItalicsInComposer",e.FormatLink="KeyBinding.FormatLink",e.FormatCode="KeyBinding.FormatCode",e.FormatQuote="KeyBinding.toggleQuoteInComposer",e.EditUndo="KeyBinding.editUndoInComposer",e.EditRedo="KeyBinding.editRedoInComposer",e.NewLine="KeyBinding.newLineInComposer",e.MoveCursorToStart="KeyBinding.jumpToStartInComposer",e.MoveCursorToEnd="KeyBinding.jumpToEndInComposer",e.CompleteAutocomplete="KeyBinding.completeAutocomplete",e.ForceCompleteAutocomplete="KeyBinding.forceCompleteAutocomplete",e.PrevSelectionInAutocomplete="KeyBinding.previousOptionInAutoComplete",e.NextSelectionInAutocomplete="KeyBinding.nextOptionInAutoComplete",e.CancelAutocomplete="KeyBinding.cancelAutoComplete",e.ClearRoomFilter="KeyBinding.clearRoomFilter",e.PrevRoom="KeyBinding.downerRoom",e.NextRoom="KeyBinding.upperRoom",e.SelectRoomInRoomList="KeyBinding.selectRoomInRoomList",e.CollapseRoomListSection="KeyBinding.collapseSectionInRoomList",e.ExpandRoomListSection="KeyBinding.expandSectionInRoomList",e.ScrollUp="KeyBinding.scrollUpInTimeline",e.ScrollDown="KeyBinding.scrollDownInTimeline",e.DismissReadMarker="KeyBinding.dismissReadMarkerAndJumpToBottom",e.JumpToOldestUnread="KeyBinding.jumpToOldestUnreadMessage",e.UploadFile="KeyBinding.uploadFileToRoom",e.SearchInRoom="KeyBinding.searchInRoom",e.JumpToFirstMessage="KeyBinding.jumpToFirstMessageInTimeline",e.JumpToLatestMessage="KeyBinding.jumpToLastMessageInTimeline",e.FilterRooms="KeyBinding.filterRooms",e.ToggleSpacePanel="KeyBinding.toggleSpacePanel",e.ToggleRoomSidePanel="KeyBinding.toggleRightPanel",e.ToggleUserMenu="KeyBinding.toggleTopLeftMenu",e.ShowKeyboardSettings="KeyBinding.showKeyBindingsSettings",e.GoToHome="KeyBinding.goToHomeView",e.SelectPrevRoom="KeyBinding.previousRoom",e.SelectNextRoom="KeyBinding.nextRoom",e.SelectPrevUnreadRoom="KeyBinding.previousUnreadRoom",e.SelectNextUnreadRoom="KeyBinding.nextUnreadRoom",e.SwitchToSpaceByNumber="KeyBinding.switchToSpaceByNumber",e.OpenUserSettings="KeyBinding.openUserSettings",e.PreviousVisitedRoomOrSpace="KeyBinding.PreviousVisitedRoomOrSpace",e.NextVisitedRoomOrSpace="KeyBinding.NextVisitedRoomOrSpace",e.ToggleMicInCall="KeyBinding.toggleMicInCall",e.ToggleWebcamInCall="KeyBinding.toggleWebcamInCall",e.Escape="KeyBinding.escape",e.Enter="KeyBinding.enter",e.Space="KeyBinding.space",e.Backspace="KeyBinding.backspace",e.Delete="KeyBinding.delete",e.Home="KeyBinding.home",e.End="KeyBinding.end",e.ArrowLeft="KeyBinding.arrowLeft",e.ArrowUp="KeyBinding.arrowUp",e.ArrowRight="KeyBinding.arrowRight",e.ArrowDown="KeyBinding.arrowDown",e.Tab="KeyBinding.tab",e.Comma="KeyBinding.comma",e.ToggleHiddenEventVisibility="KeyBinding.toggleHiddenEventVisibility"}(o||(o={})),function(e){e.NAVIGATION="Navigation",e.ACCESSIBILITY="Accessibility",e.CALLS="Calls",e.COMPOSER="Composer",e.ROOM_LIST="Room List",e.ROOM="Room",e.AUTOCOMPLETE="Autocomplete",e.LABS="Labs"}(r||(r={}));const a="digits",c={[s.b.PAGE_UP]:Object(i.c)("Page Up"),[s.b.PAGE_DOWN]:Object(i.c)("Page Down"),[s.b.ESCAPE]:Object(i.c)("Esc"),[s.b.ENTER]:Object(i.c)("Enter"),[s.b.SPACE]:Object(i.c)("Space"),[s.b.HOME]:Object(i.c)("Home"),[s.b.END]:Object(i.c)("End"),[s.b.ALT]:Object(i.c)("Alt"),[s.b.CONTROL]:Object(i.c)("Ctrl"),[s.b.SHIFT]:Object(i.c)("Shift"),[a]:Object(i.c)("[number]")},l={[s.b.ARROW_UP]:"↑",[s.b.ARROW_DOWN]:"↓",[s.b.ARROW_LEFT]:"←",[s.b.ARROW_RIGHT]:"→"};s.a&&(l[s.b.META]="⌘",l[s.b.ALT]="⌥");const d={[r.COMPOSER]:{categoryLabel:Object(i.c)("Composer"),settingNames:[o.SendMessage,o.NewLine,o.FormatBold,o.FormatItalics,o.FormatQuote,o.FormatLink,o.FormatCode,o.EditUndo,o.EditRedo,o.MoveCursorToStart,o.MoveCursorToEnd,o.CancelReplyOrEdit,o.EditNextMessage,o.EditPrevMessage,o.SelectNextSendHistory,o.SelectPrevSendHistory,o.ShowStickerPicker]},[r.CALLS]:{categoryLabel:Object(i.c)("Calls"),settingNames:[o.ToggleMicInCall,o.ToggleWebcamInCall]},[r.ROOM]:{categoryLabel:Object(i.c)("Room"),settingNames:[o.SearchInRoom,o.UploadFile,o.DismissReadMarker,o.JumpToOldestUnread,o.ScrollUp,o.ScrollDown,o.JumpToFirstMessage,o.JumpToLatestMessage]},[r.ROOM_LIST]:{categoryLabel:Object(i.c)("Room List"),settingNames:[o.SelectRoomInRoomList,o.ClearRoomFilter,o.CollapseRoomListSection,o.ExpandRoomListSection,o.NextRoom,o.PrevRoom]},[r.ACCESSIBILITY]:{categoryLabel:Object(i.c)("Accessibility"),settingNames:[o.Escape,o.Enter,o.Space,o.Backspace,o.Delete,o.Home,o.End,o.ArrowLeft,o.ArrowUp,o.ArrowRight,o.ArrowDown,o.Comma]},[r.NAVIGATION]:{categoryLabel:Object(i.c)("Navigation"),settingNames:[o.ToggleUserMenu,o.ToggleRoomSidePanel,o.ToggleSpacePanel,o.ShowKeyboardSettings,o.GoToHome,o.FilterRooms,o.SelectNextUnreadRoom,o.SelectPrevUnreadRoom,o.SelectNextRoom,o.SelectPrevRoom,o.OpenUserSettings,o.SwitchToSpaceByNumber,o.PreviousVisitedRoomOrSpace,o.NextVisitedRoomOrSpace]},[r.AUTOCOMPLETE]:{categoryLabel:Object(i.c)("Autocomplete"),settingNames:[o.CancelAutocomplete,o.NextSelectionInAutocomplete,o.PrevSelectionInAutocomplete,o.CompleteAutocomplete,o.ForceCompleteAutocomplete]},[r.LABS]:{categoryLabel:Object(i.c)("Labs"),settingNames:[o.ToggleHiddenEventVisibility]}},u=[o.OpenUserSettings,o.SwitchToSpaceByNumber,o.PreviousVisitedRoomOrSpace,o.NextVisitedRoomOrSpace],h=[o.OpenUserSettings],m={[o.FormatBold]:{default:{ctrlOrCmdKey:!0,key:s.b.B},displayName:Object(i.c)("Toggle Bold")},[o.FormatItalics]:{default:{ctrlOrCmdKey:!0,key:s.b.I},displayName:Object(i.c)("Toggle Italics")},[o.FormatQuote]:{default:{ctrlOrCmdKey:!0,shiftKey:!0,key:s.b.GREATER_THAN},displayName:Object(i.c)("Toggle Quote")},[o.FormatCode]:{default:{ctrlOrCmdKey:!0,key:s.b.E},displayName:Object(i.c)("Toggle Code Block")},[o.FormatLink]:{default:{ctrlOrCmdKey:!0,shiftKey:!0,key:s.b.L},displayName:Object(i.c)("Toggle Link")},[o.CancelReplyOrEdit]:{default:{key:s.b.ESCAPE},displayName:Object(i.c)("Cancel replying to a message")},[o.EditNextMessage]:{default:{key:s.b.ARROW_DOWN},displayName:Object(i.c)("Navigate to next message to edit")},[o.EditPrevMessage]:{default:{key:s.b.ARROW_UP},displayName:Object(i.c)("Navigate to previous message to edit")},[o.MoveCursorToStart]:{default:{ctrlOrCmdKey:!0,key:s.b.HOME},displayName:Object(i.c)("Jump to start of the composer")},[o.MoveCursorToEnd]:{default:{ctrlOrCmdKey:!0,key:s.b.END},displayName:Object(i.c)("Jump to end of the composer")},[o.SelectNextSendHistory]:{default:{altKey:!0,ctrlKey:!0,key:s.b.ARROW_DOWN},displayName:Object(i.c)("Navigate to next message in composer history")},[o.SelectPrevSendHistory]:{default:{altKey:!0,ctrlKey:!0,key:s.b.ARROW_UP},displayName:Object(i.c)("Navigate to previous message in composer history")},[o.ShowStickerPicker]:{default:{ctrlOrCmdKey:!0,key:s.b.SEMICOLON},displayName:Object(i.c)("Send a sticker")},[o.ToggleMicInCall]:{default:{ctrlOrCmdKey:!0,key:s.b.D},displayName:Object(i.c)("Toggle microphone mute")},[o.ToggleWebcamInCall]:{default:{ctrlOrCmdKey:!0,key:s.b.E},displayName:Object(i.c)("Toggle webcam on/off")},[o.DismissReadMarker]:{default:{key:s.b.ESCAPE},displayName:Object(i.c)("Dismiss read marker and jump to bottom")},[o.JumpToOldestUnread]:{default:{shiftKey:!0,key:s.b.PAGE_UP},displayName:Object(i.c)("Jump to oldest unread message")},[o.UploadFile]:{default:{ctrlOrCmdKey:!0,shiftKey:!0,key:s.b.U},displayName:Object(i.c)("Upload a file")},[o.ScrollUp]:{default:{key:s.b.PAGE_UP},displayName:Object(i.c)("Scroll up in the timeline")},[o.ScrollDown]:{default:{key:s.b.PAGE_DOWN},displayName:Object(i.c)("Scroll down in the timeline")},[o.FilterRooms]:{default:{ctrlOrCmdKey:!0,key:s.b.K},displayName:Object(i.c)("Jump to room search")},[o.SelectRoomInRoomList]:{default:{key:s.b.ENTER},displayName:Object(i.c)("Select room from the room list")},[o.CollapseRoomListSection]:{default:{key:s.b.ARROW_LEFT},displayName:Object(i.c)("Collapse room list section")},[o.ExpandRoomListSection]:{default:{key:s.b.ARROW_RIGHT},displayName:Object(i.c)("Expand room list section")},[o.NextRoom]:{default:{key:s.b.ARROW_DOWN},displayName:Object(i.c)("Navigate down in the room list")},[o.PrevRoom]:{default:{key:s.b.ARROW_UP},displayName:Object(i.c)("Navigate up in the room list")},[o.ToggleUserMenu]:{default:{ctrlOrCmdKey:!0,key:s.b.BACKTICK},displayName:Object(i.c)("Toggle the top left menu")},[o.ToggleRoomSidePanel]:{default:{ctrlOrCmdKey:!0,key:s.b.PERIOD},displayName:Object(i.c)("Toggle right panel")},[o.ShowKeyboardSettings]:{default:{ctrlOrCmdKey:!0,key:s.b.SLASH},displayName:Object(i.c)("Open this settings tab")},[o.GoToHome]:{default:{ctrlOrCmdKey:!0,altKey:!s.a,shiftKey:s.a,key:s.b.H},displayName:Object(i.c)("Go to Home View")},[o.SelectNextUnreadRoom]:{default:{shiftKey:!0,altKey:!0,key:s.b.ARROW_DOWN},displayName:Object(i.c)("Next unread room or DM")},[o.SelectPrevUnreadRoom]:{default:{shiftKey:!0,altKey:!0,key:s.b.ARROW_UP},displayName:Object(i.c)("Previous unread room or DM")},[o.SelectNextRoom]:{default:{altKey:!0,key:s.b.ARROW_DOWN},displayName:Object(i.c)("Next room or DM")},[o.SelectPrevRoom]:{default:{altKey:!0,key:s.b.ARROW_UP},displayName:Object(i.c)("Previous room or DM")},[o.CancelAutocomplete]:{default:{key:s.b.ESCAPE},displayName:Object(i.c)("Cancel autocomplete")},[o.NextSelectionInAutocomplete]:{default:{key:s.b.ARROW_DOWN},displayName:Object(i.c)("Next autocomplete suggestion")},[o.PrevSelectionInAutocomplete]:{default:{key:s.b.ARROW_UP},displayName:Object(i.c)("Previous autocomplete suggestion")},[o.ToggleSpacePanel]:{default:{ctrlOrCmdKey:!0,shiftKey:!0,key:s.b.D},displayName:Object(i.c)("Toggle space panel")},[o.ToggleHiddenEventVisibility]:{default:{ctrlOrCmdKey:!0,shiftKey:!0,key:s.b.H},displayName:Object(i.c)("Toggle hidden event visibility")},[o.JumpToFirstMessage]:{default:{key:s.b.HOME,ctrlKey:!0},displayName:Object(i.c)("Jump to first message")},[o.JumpToLatestMessage]:{default:{key:s.b.END,ctrlKey:!0},displayName:Object(i.c)("Jump to last message")},[o.EditUndo]:{default:{key:s.b.Z,ctrlOrCmdKey:!0},displayName:Object(i.c)("Undo edit")},[o.EditRedo]:{default:{key:s.a?s.b.Z:s.b.Y,ctrlOrCmdKey:!0,shiftKey:s.a},displayName:Object(i.c)("Redo edit")},[o.PreviousVisitedRoomOrSpace]:{default:{metaKey:s.a,altKey:!s.a,key:s.a?s.b.SQUARE_BRACKET_LEFT:s.b.ARROW_LEFT},displayName:Object(i.c)("Previous recently visited room or space")},[o.NextVisitedRoomOrSpace]:{default:{metaKey:s.a,altKey:!s.a,key:s.a?s.b.SQUARE_BRACKET_RIGHT:s.b.ARROW_RIGHT},displayName:Object(i.c)("Next recently visited room or space")},[o.SwitchToSpaceByNumber]:{default:{ctrlOrCmdKey:!0,key:a},displayName:Object(i.c)("Switch to space by number")},[o.OpenUserSettings]:{default:{metaKey:!0,key:s.b.COMMA},displayName:Object(i.c)("Open user settings")},[o.Escape]:{default:{key:s.b.ESCAPE},displayName:Object(i.c)("Close dialog or context menu")},[o.Enter]:{default:{key:s.b.ENTER},displayName:Object(i.c)("Activate selected button")},[o.Space]:{default:{key:s.b.SPACE}},[o.Backspace]:{default:{key:s.b.BACKSPACE}},[o.Delete]:{default:{key:s.b.DELETE}},[o.Home]:{default:{key:s.b.HOME}},[o.End]:{default:{key:s.b.END}},[o.ArrowLeft]:{default:{key:s.b.ARROW_LEFT}},[o.ArrowUp]:{default:{key:s.b.ARROW_UP}},[o.ArrowRight]:{default:{key:s.b.ARROW_RIGHT}},[o.ArrowDown]:{default:{key:s.b.ARROW_DOWN}},[o.Comma]:{default:{key:s.b.COMMA}}}},function(e,t,n){"use strict";n.d(t,"c",(function(){return v})),n.d(t,"b",(function(){return f}));var i=n(13),s=n.n(i),o=n(10),r=n(1),a=n(130),c=n(16),l=n(171),d=n(290),u=n(159),h=n(691),m=n(524),p=n(419);n.d(t,"a",(function(){return p.a}));const g=Object.freeze({visible:!0});let v;!function(e){e.Decrypted="Event.decrypted",e.BeforeRedaction="Event.beforeRedaction",e.VisibilityChange="Event.visibilityChange",e.LocalEventIdReplaced="Event.localEventIdReplaced",e.Status="Event.status",e.Replaced="Event.replaced",e.RelationsCreated="Event.relationsCreated"}(v||(v={}));class f extends u.b{constructor(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.event=t,s()(this,"pushActions",null),s()(this,"_replacingEvent",null),s()(this,"_localRedactionEvent",null),s()(this,"_isCancelled",!1),s()(this,"clearEvent",void 0),s()(this,"visibility",g),s()(this,"_hasCachedExtEv",!1),s()(this,"_cachedExtEv",void 0),s()(this,"senderCurve25519Key",null),s()(this,"claimedEd25519Key",null),s()(this,"forwardingCurve25519KeyChain",[]),s()(this,"untrusted",null),s()(this,"decryptionPromise",null),s()(this,"retryDecryption",!1),s()(this,"txnId",void 0),s()(this,"thread",void 0),s()(this,"threadId",void 0),s()(this,"encryptedDisabledForUnverifiedDevices",!1),s()(this,"localTimestamp",void 0),s()(this,"sender",null),s()(this,"target",null),s()(this,"status",null),s()(this,"error",null),s()(this,"forwardLooking",!0),s()(this,"verificationRequest",void 0),s()(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach((e=>{"string"==typeof t[e]&&(t[e]=Object(c.t)(t[e]))})),["membership","avatar_url","displayname"].forEach((e=>{var n;"string"==typeof(null===(n=t.content)||void 0===n?void 0:n[e])&&(t.content[e]=Object(c.t)(t.content[e]))})),["rel_type"].forEach((e=>{var n,i;"string"==typeof(null===(n=t.content)||void 0===n||null===(i=n["m.relates_to"])||void 0===i?void 0:i[e])&&(t.content["m.relates_to"][e]=Object(c.t)(t.content["m.relates_to"][e]))})),this.txnId=t.txn_id,this.localTimestamp=Date.now()-(null!==(e=this.getAge())&&void 0!==e?e:0),this.reEmitter=new d.b(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=o.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){const e=Object.assign({},this.getContent());if(this.getWireType()===a.b.RoomMessageEncrypted)for(const[t,n]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0===e[t]&&(e[t]=n);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){let e=`id=${this.getId()} type=${this.getWireType()} sender=${this.getSender()}`;const t=this.getRoomId();t&&(e+=` room=${t}`);const n=this.getDate();return n&&(e+=` ts=${n.toISOString()}`),e}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;const t=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];return(null==t?void 0:t.rel_type)===l.d.name?t.event_id:(null===(n=this.getThread())||void 0===n?void 0:n.id)||this.threadId;var n}get isThreadRoot(){var e;return!!this.getServerAggregatedRelation(l.d.name)||(null===(e=this.getThread())||void 0===e?void 0:e.id)===this.getId()}get replyEventId(){var e,t;return null===(e=this.getWireContent()["m.relates_to"])||void 0===e||null===(t=e["m.in_reply_to"])||void 0===t?void 0:t.event_id}get relationEventId(){var e,t;return null===(e=this.getWireContent())||void 0===e||null===(t=e["m.relates_to"])||void 0===t?void 0:t.event_id}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}makeEncrypted(e,t,n,i){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=n,this.claimedEd25519Key=i}isBeingDecrypted(){return null!=this.decryptionPromise}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){var e,t;return"m.bad.encrypted"===(null===(e=this.clearEvent)||void 0===e||null===(t=e.content)||void 0===t?void 0:t.msgtype)}get isEncryptedDisabledForUnverifiedDevices(){return this.isDecryptionFailure()&&this.encryptedDisabledForUnverifiedDevices}shouldAttemptDecryption(){return!this.isRedacted()&&(!this.isBeingDecrypted()&&(!this.clearEvent&&!!this.isEncrypted()))}async attemptDecryption(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");const n=this.clearEvent&&!this.isDecryptionFailure(),i=t.forceRedecryptIfUntrusted&&this.isKeySourceUntrusted();if(n&&!i)throw new Error("Attempt to decrypt event which has already been decrypted");return this.decryptionPromise?(r.a.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this.decryptionPromise):(this.decryptionPromise=this.decryptionLoop(e,t),this.decryptionPromise)}cancelAndResendKeyRequest(e,t){const n=this.getWireContent();return e.requestRoomKey({algorithm:n.algorithm,room_id:this.getRoomId(),session_id:n.session_id,sender_key:n.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){return[{userId:e,deviceId:"*"}]}async decryptionLoop(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(await Promise.resolve();;){let n,i;this.retryDecryption=!1;try{e?(n=await e.decryptEvent(this),!0===t.isRetry&&r.a.info(`Decrypted event on retry (${this.getDetails()})`)):n=this.badEncryptedMessage("Encryption not enabled")}catch(e){const t=e instanceof h.b?e.detailedString:String(e);if(i=e,this.retryDecryption){r.a.log(`Error decrypting event (${this.getDetails()}), but retrying: ${t}`);continue}r.a.warn(`Error decrypting event (${this.getDetails()}): ${t}`),n=this.badEncryptedMessage(String(e))}return this.decryptionPromise=null,this.retryDecryption=!1,this.setClearData(n),this.setPushActions(null),void(!1!==t.emit&&this.emit(v.Decrypted,this,i))}}badEncryptedMessage(e){return{clearEvent:{type:a.b.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}},encryptedDisabledForUnverifiedDevices:e===`DecryptionError: ${m.b["m.unverified"]}`}}setClearData(e){var t,n;this.clearEvent=e.clearEvent,this.senderCurve25519Key=null!==(t=e.senderCurve25519Key)&&void 0!==t?t:null,this.claimedEd25519Key=null!==(n=e.claimedEd25519Key)&&void 0!==n?n:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.encryptedDisabledForUnverifiedDevices=e.encryptedDisabledForUnverifiedDevices||!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===a.b.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(v.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,n;const i=null===(t=null==e?void 0:e.visible)||void 0===t||t,s=null!==(n=null==e?void 0:e.reason)&&void 0!==n?n:null;let o=!1;this.visibility.visible!==i?o=!0:this.visibility.visible||this.visibility.reason===s||(o=!0),o&&(this.visibility=i?g:Object.freeze({visible:!1,reason:s}),this.emit(v.VisibilityChange,this,i))}messageVisibility(){return this.visibility}makeRedacted(e){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(v.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(const e in this.event)this.event.hasOwnProperty(e)&&!b.has(e)&&delete this.event[e];this.isEncrypted()&&(this.clearEvent=void 0);const t=this.getType()in y?y[this.getType()]:{},n=this.getContent();for(const e in n)n.hasOwnProperty(e)&&!t[e]&&delete n[e];this.invalidateExtensibleEvent()}isRedacted(){return Boolean(this.getUnsigned().redacted_because)}isRedaction(){return this.getType()===a.b.RoomRedaction}asVisibilityChange(){if(!a.a.matches(this.getType()))return null;const e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;const t=e.event_id;if(!t)return null;const n=this.getWireContent(),i=!!n.visible,s=n.reason;return s&&"string"!=typeof s?null:{visible:i,reason:s,eventId:t}}isVisibilityEvent(){return a.a.matches(this.getType())}getRedactionEvent(){var e,t,n,i;return this.isRedacted()?null!==(e=this.clearEvent)&&void 0!==e&&e.unsigned?null!==(n=null===(i=this.clearEvent)||void 0===i?void 0:i.unsigned.redacted_because)&&void 0!==n?n:null:null!==(t=this.event.unsigned)&&void 0!==t&&t.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushActions}setPushActions(e){this.pushActions=e}handleRemoteEcho(e){const t=this.getUnsigned(),n=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit(v.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(v.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(v.LocalEventIdReplaced,this)}isRelation(e){var t;const n=null===(t=this.getWireContent())||void 0===t?void 0:t["m.relates_to"];return(!this.isState()||(null==n?void 0:n.rel_type)!==a.h.Replace)&&!(null==n||!n.rel_type||!n.event_id||e&&n.rel_type!==e)}getRelation(){var e;return this.isRelation()&&null!==(e=this.getWireContent()["m.relates_to"])&&void 0!==e?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=null!=e?e:null,this.emit(v.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null===(t=this.getUnsigned()["m.relations"])||void 0===t?void 0:t[e]}replacingEventId(){const e=this.getServerAggregatedRelation(a.h.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){const e=this.getServerAggregatedRelation(a.h.Replace);if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var t;return null!==(t=this._replacingEvent.getDate())&&void 0!==t?t:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){const e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssocation(){return!!this.getAssociatedId()}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){const e=new f(JSON.parse(JSON.stringify(this.event)));for(const[t,n]of Object.entries(this))"event"!==t&&(e[t]=n);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;const t=Object(c.l)(this.event),n=Object(c.l)(e.event);return JSON.stringify(t)===JSON.stringify(n)}toJSON(){const e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.thread&&this.reEmitter.stopReEmitting(this.thread,[l.f.Update]),this.thread=e,this.setThreadId(null==e?void 0:e.id),e&&this.reEmitter.reEmit(e,[l.f.Update])}getThread(){return this.thread}setThreadId(e){this.threadId=e}}const b=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),y={[a.b.RoomMember]:{membership:1},[a.b.RoomCreate]:{creator:1},[a.b.RoomJoinRules]:{join_rule:1},[a.b.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(121),c=n(136);class l extends r.a.Component{constructor(){super(...arguments),s()(this,"onClick",(()=>{this.props.onFinished(!0)}))}render(){return r.a.createElement(c.a,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:this.props.title||Object(a.a)("Error"),headerImage:this.props.headerImage,contentId:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description||Object(a.a)("An error has occurred.")),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{className:"mx_Dialog_primary",onClick:this.onClick,autoFocus:this.props.focus},this.props.button||Object(a.a)("OK"))))}}s()(l,"defaultProps",{focus:!0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(121);class c extends r.a.Component{constructor(){super(...arguments),s()(this,"onCancelClick",(e=>{this.props.onCancel(e)}))}render(){let e,t="mx_Dialog_primary";this.props.primaryButtonClass&&(t+=" "+this.props.primaryButtonClass),(this.props.cancelButton||this.props.hasCancel)&&(e=r.a.createElement("button",{"data-testid":"dialog-cancel-button",type:"button",onClick:this.onCancelClick,className:this.props.cancelButtonClass,disabled:this.props.disabled},this.props.cancelButton||Object(a.a)("Cancel")));let n=null;return this.props.additive&&(n=r.a.createElement("div",{className:"mx_Dialog_buttons_additive"},this.props.additive)),r.a.createElement("div",{className:"mx_Dialog_buttons"},n,r.a.createElement("span",{className:"mx_Dialog_buttons_row"},e,this.props.children,r.a.createElement("button",{type:this.props.primaryIsSubmit?"submit":"button","data-testid":"dialog-primary-button",className:t,onClick:this.props.onPrimaryButtonClick,autoFocus:this.props.focus,disabled:this.props.disabled||this.props.primaryDisabled},this.props.primaryButton)))}}s()(c,"defaultProps",{hasCancel:!0,disabled:!1})},function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"i",(function(){return o})),n.d(t,"g",(function(){return r})),n.d(t,"h",(function(){return a})),n.d(t,"j",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"e",(function(){return d})),n.d(t,"d",(function(){return u})),n.d(t,"a",(function(){return h})),n.d(t,"f",(function(){return m})),n.d(t,"k",(function(){return p})),n.d(t,"o",(function(){return g})),n.d(t,"m",(function(){return v})),n.d(t,"l",(function(){return f})),n.d(t,"n",(function(){return b}));var i=n(293);function s(e,t){if(e.length===t)return e;const n=[];if(e.length>t){const i=Math.round(e.length/t);for(let t=0;t<e.length;t+=i)n.push(e[t])}else{const i=Math.ceil(t/e.length);for(const t of e)n.push(...a(t,i))}return c(n,t,a(e[e.length-1],t))}function o(e,t){if(e.length===t)return e;let n=[];if(e.length>t){for(;n.length>2*t||0===n.length;){n=[];for(let t=1;t<e.length-1;t+=2){const i=(e[t-1]+e[t+1]+e[t])/3;n.push(i)}e=n}return s(n,t)}return s(e,t)}function r(e,t,n){const s=Math.min(...e),o=Math.max(...e);return e.map((e=>Object(i.d)(Object(i.c)(e,s,o),t,n)))}function a(e,t){return new Array(t).fill(e)}function c(e,t,n){return e.length===t?e:e.length>t?e.slice(0,t):e.concat(n.slice(0,t-e.length))}function l(e){return e.slice(0,e.length)}function d(e,t){if(e.length===t.length){for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!0;return!1}return!0}function u(e,t){return e.length!==t.length||(!!t.some((t=>!e.includes(t)))||!!e.some((e=>!t.includes(e))))}function h(e,t){return{added:t.filter((t=>!e.includes(t))),removed:e.filter((e=>!t.includes(e)))}}function m(e,t){return e.filter((e=>t.includes(e)))}function p(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Array.from(t.reduce(((e,t)=>(t.forEach((t=>e.add(t))),e)),new Set))}function g(e,t,n){const i=Array.from(e),[s]=i.splice(t,1);return i.splice(n,0,s),i}const v=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce(((e,t)=>{const n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n}),new Uint8Array(0))};async function f(e,t){for(const n of e)if(!await t(n))return!1;return!0}function b(e){return e.filter(Boolean)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(122),c=n.n(a),l=n(120),d=n.n(l),u=n(124),h=n(163);const m=["title","tooltip","children","tooltipClassName","forceHide","alignment","onHideTooltip"];class p extends d.a.PureComponent{constructor(e){super(e),c()(this,"showTooltip",(()=>{this.props.onHover&&this.props.onHover(!0),this.props.forceHide||this.setState({hover:!0})})),c()(this,"hideTooltip",(e=>{var t,n;this.props.onHover&&this.props.onHover(!1),this.setState({hover:!1}),null===(t=(n=this.props).onHideTooltip)||void 0===t||t.call(n,e)})),c()(this,"onFocus",(e=>{e.relatedTarget&&this.showTooltip()})),this.state={hover:!1}}componentDidUpdate(e){!e.forceHide&&this.props.forceHide&&this.state.hover&&this.setState({hover:!1})}render(){const e=this.props,{title:t,tooltip:n,children:i,tooltipClassName:o,forceHide:a,alignment:c,onHideTooltip:l}=e,p=r()(e,m),g=this.state.hover&&(t||n)&&d.a.createElement(h.b,{tooltipClassName:o,label:n||t,alignment:c});return d.a.createElement(u.a,s()({},p,{onMouseOver:this.showTooltip||p.onMouseOver,onMouseLeave:this.hideTooltip||p.onMouseLeave,onFocus:this.onFocus||p.onFocus,onBlur:this.hideTooltip||p.onBlur,"aria-label":t||p["aria-label"]}),i,this.props.label,(n||t)&&g)}}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return se})),n.d(t,"g",(function(){return ae})),n.d(t,"e",(function(){return ce})),n.d(t,"f",(function(){return le})),n.d(t,"c",(function(){return ue})),n.d(t,"b",(function(){return me})),n.d(t,"d",(function(){return ge})),n.d(t,"h",(function(){return ve}));var i=n(1022),s=n.n(i),o=n(13),r=n.n(o),a=n(219),c=n(144),l=n(1027),d=n(190),u=n(320),h=n(521),m=n(16),p=n(180),g=n(325),v=n(326),f=n(200),b=n(290),y=n(1041),S=n(1),E=n(276),w=n(196),_=n(175),C=n(432),O=n(431),I=n(224),R=n(359),k=n(1719),x=n(709),T=n(1052),j=n(274),P=n(141),D=n(186),N=n(130),M=n(161),A=n(1053),L=n(225),U=n(710),F=n(1720),B=n(433),V=n(235),K=n(226),$=n(1054),H=n(522),W=n(159),q=n(18),G=n(711),z=n(171),J=n(207),Y=n(15),Q=n(1055),X=n(1056),Z=n(423),ee=n(712);const te=["server","limit","since"];function ne(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function ie(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ne(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ne(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const se=Object(_.d)(),oe=216e5,re=6e5,ae=new Y.c("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent");let ce,le;var de;!function(e){e.Chronological="chronological",e.Detached="detached"}(ce||(ce={})),function(e){e.Stable="stable",e.Unstable="unstable"}(le||(le={})),function(e){e.MasterKey="master_key",e.SelfSigningKey="self_signing_key",e.UserSigningKey="user_signing_key"}(de||(de={}));const ue=new Y.c("m.authentication","org.matrix.msc2965.authentication"),he="$";let me;!function(e){e.Sync="sync",e.Event="event",e.ToDeviceEvent="toDeviceEvent",e.AccountData="accountData",e.Room="Room",e.DeleteRoom="deleteRoom",e.SyncUnexpectedError="sync.unexpectedError",e.ClientWellKnown="WellKnown.client",e.ReceivedVoipEvent="received_voip_event",e.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",e.TurnServers="turnServers",e.TurnServersError="turnServers.error"}(me||(me={}));const pe=new Y.c("action","org.matrix.msc3824.action");class ge extends W.b{constructor(e){var t;super(),r()(this,"reEmitter",new b.b(this)),r()(this,"olmVersion",null),r()(this,"usingExternalCrypto",!1),r()(this,"store",void 0),r()(this,"deviceId",void 0),r()(this,"credentials",void 0),r()(this,"pickleKey",void 0),r()(this,"scheduler",void 0),r()(this,"clientRunning",!1),r()(this,"timelineSupport",!1),r()(this,"urlPreviewCache",{}),r()(this,"identityServer",void 0),r()(this,"http",void 0),r()(this,"crypto",void 0),r()(this,"cryptoBackend",void 0),r()(this,"cryptoCallbacks",void 0),r()(this,"callEventHandler",void 0),r()(this,"groupCallEventHandler",void 0),r()(this,"supportsCallTransfer",!1),r()(this,"forceTURN",!1),r()(this,"iceCandidatePoolSize",0),r()(this,"idBaseUrl",void 0),r()(this,"baseUrl",void 0),r()(this,"isVoipWithNoMediaAllowed",void 0),r()(this,"canSupportVoip",!1),r()(this,"peekSync",null),r()(this,"isGuestAccount",!1),r()(this,"ongoingScrollbacks",{}),r()(this,"notifTimelineSet",null),r()(this,"cryptoStore",void 0),r()(this,"verificationMethods",void 0),r()(this,"fallbackICEServerAllowed",!1),r()(this,"roomList",void 0),r()(this,"syncApi",void 0),r()(this,"roomNameGenerator",void 0),r()(this,"pushRules",void 0),r()(this,"syncLeftRoomsPromise",void 0),r()(this,"syncedLeftRooms",!1),r()(this,"clientOpts",void 0),r()(this,"clientWellKnownIntervalID",void 0),r()(this,"canResetTimelineCallback",void 0),r()(this,"canSupport",new Map),r()(this,"pushProcessor",new g.a(this)),r()(this,"serverVersionsPromise",void 0),r()(this,"cachedCapabilities",void 0),r()(this,"clientWellKnown",void 0),r()(this,"clientWellKnownPromise",void 0),r()(this,"turnServers",[]),r()(this,"turnServersExpiry",0),r()(this,"checkTurnServersIntervalID",void 0),r()(this,"exportedOlmDeviceToImport",void 0),r()(this,"txnCtr",0),r()(this,"mediaHandler",new $.a(this)),r()(this,"sessionId",void 0),r()(this,"pendingEventEncryption",new Map),r()(this,"useE2eForGroupCall",!0),r()(this,"toDeviceMessageQueue",void 0),r()(this,"ignoredInvites",void 0),r()(this,"startCallEventHandler",(()=>{this.isInitialSyncComplete()&&(this.callEventHandler.start(),this.groupCallEventHandler.start(),this.off(me.Sync,this.startCallEventHandler))})),r()(this,"fixupRoomNotifications",(()=>{if(this.isInitialSyncComplete()){var e;const t=(null!==(e=this.getRooms())&&void 0!==e?e:[]).filter((e=>e.getUnreadNotificationCount(P.b.Total)>0));for(const e of t){const t=this.getSafeUserId();e.fixupNotifications(t)}this.off(me.Sync,this.fixupRoomNotifications)}})),e.baseUrl=m.p(e.baseUrl),e.idBaseUrl=m.p(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=null!==(t=e.usingExternalCrypto)&&void 0!==t&&t,this.store=e.store||new l.a,this.deviceId=e.deviceId||null,this.sessionId=Object(L.b)(10);const n=e.userId||null;this.credentials={userId:n},this.http=new w.g(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,prefix:w.a.R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader}),e.deviceToImport?this.deviceId?S.a.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?S.a.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):S.a.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((async e=>{const t=this.getRoom(e.getRoomId());e.status!==c.a.SENDING&&this.updatePendingEventStatus(t,e,c.a.SENDING);const n=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,c.a.SENT,n.event_id),n})),Object(d.k)()&&(this.callEventHandler=new h.a(this),this.groupCallEventHandler=new H.a(this),this.canSupportVoip=!0,this.on(me.Sync,this.startCallEventHandler)),this.on(me.Sync,this.fixupRoomNotifications),this.timelineSupport=Boolean(e.timelineSupport),this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,void 0!==e.useE2eForGroupCall&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.roomList=new y.a(this.cryptoStore),this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new Q.a(this),this.on(c.c.Decrypted,(e=>{ve(this,e)})),this.on(P.d.Receipt,((e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){const i=e.getContent();if(!(Object.keys(i).filter((e=>{for(const[t,n]of Object.entries(i[e]))if(m.w(t)&&n&&Object.keys(n).includes(this.getUserId()))return!0;return!1})).length>0))return;const s=20,o=t.getLiveTimeline().getEvents();let r=0;for(let e=o.length-1;e>=0;e--){var n;if(e===o.length-s)return;const i=o[e];if(t.hasUserReadEvent(this.getUserId(),i.getId()))break;const a=this.getPushActionsForEvent(i);r+=null!=a&&null!==(n=a.tweaks)&&void 0!==n&&n.highlight?1:0}t.setUnreadNotificationCount(P.b.Highlight,r)}})),this.ignoredInvites=new X.a(this)}async startClient(e){var t;if(this.clientRunning)return;this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e});const n=this.getUserId();n&&this.store.storeUser(new I.a(n)),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval((()=>{this.checkTurnServers()}),re),this.checkTurnServers()),this.syncApi&&(S.a.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop());try{await this.getVersions();const{threads:e,list:t,fwdPagination:n}=await this.doesServerSupportThread();z.e.setServerSideSupport(e),z.e.setServerSideListSupport(t),z.e.setServerSideFwdPaginationSupport(n)}catch(e){S.a.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",e)}this.clientOpts=null!==(t=e)&&void 0!==t?t:{},this.clientOpts.slidingSync?this.syncApi=new G.a(this.clientOpts.slidingSync,this,this.clientOpts,this.buildSyncApiOptions()):this.syncApi=new a.a(this,this.clientOpts,this.buildSyncApiOptions()),this.clientOpts.hasOwnProperty("experimentalThreadSupport")&&S.a.warn("`experimentalThreadSupport` has been deprecated, use `threadSupport` instead"),!this.clientOpts.hasOwnProperty("threadSupport")&&this.clientOpts.hasOwnProperty("experimentalThreadSupport")&&(this.clientOpts.threadSupport=this.clientOpts.experimentalThreadSupport),this.syncApi.sync(),void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval((()=>{this.fetchClientWellKnown()}),1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown()),this.toDeviceMessageQueue.start()}buildSyncApiOptions(){return{crypto:this.crypto,cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e)}}stopClient(){var t,n,i,s,o;null===(t=this.cryptoBackend)||void 0===t||t.stop(),this.clientRunning&&(S.a.log("stopping MatrixClient"),this.clientRunning=!1,null===(n=this.syncApi)||void 0===n||n.stop(),this.syncApi=void 0,null===(i=this.peekSync)||void 0===i||i.stopPeeking(),null===(s=this.callEventHandler)||void 0===s||s.stop(),null===(o=this.groupCallEventHandler)||void 0===o||o.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,e.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,void 0!==this.clientWellKnownIntervalID&&e.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop())}async rehydrateDevice(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const t=await this.getDehydratedDevice();if(!t)return;if(!t.device_data||!t.device_id)return void S.a.info("no dehydrated device found");const n=new e.Olm.Account;try{const e=t.device_data;if(e.algorithm!==x.a)return void S.a.warn("Wrong algorithm for dehydrated device");S.a.log("unpickling dehydrated device");const i=await this.cryptoCallbacks.getDehydrationKey(e,(t=>{n.unpickle(new Uint8Array(t),e.account)}));n.unpickle(i,e.account),S.a.log("unpickled device");if((await this.http.authedRequest(w.i.Post,"/dehydrated_device/claim",void 0,{device_id:t.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=t.device_id,S.a.info("using dehydrated device");const e=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:n.pickle(e),sessions:[],pickleKey:e},n.free(),this.deviceId}return n.free(),void S.a.info("not using dehydrated device")}catch(e){n.free(),S.a.warn("could not unpickle",e)}}async getDehydratedDevice(){try{return await this.http.authedRequest(w.i.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){return void S.a.info("could not get dehydrated device",e)}}async setDehydrationKey(e,t,n){if(this.crypto)return this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,n);S.a.warn("not dehydrating device if crypto is not enabled")}async createDehydratedDevice(e,t,n){if(this.crypto)return await this.crypto.dehydrationManager.setKey(e,t,n),this.crypto.dehydrationManager.dehydrateDevice();S.a.warn("not dehydrating device if crypto is not enabled")}async exportDevice(){if(this.crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()};S.a.warn("not exporting device if crypto is not enabled")}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const t=[];t.push(this.store.deleteAllData()),this.cryptoStore&&t.push(this.cryptoStore.deleteAllData());return t.push((async()=>{let t;try{t=e.indexedDB}catch(e){return}for(const e of[`${ee.a}::matrix-sdk-crypto`,`${ee.a}::matrix-sdk-crypto-meta`]){const n=new Promise(((n,i)=>{S.a.info(`Removing IndexedDB instance ${e}`);const s=t.deleteDatabase(e);s.onsuccess=t=>{S.a.info(`Removed IndexedDB instance ${e}`),n(0)},s.onerror=t=>{S.a.warn(`Failed to remove IndexedDB instance ${e}:`,t),n(0)},s.onblocked=t=>{S.a.info(`cannot yet remove IndexedDB instance ${e}`)}}));await n}})()),Promise.all(t).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getSafeUserId(){const e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return Object(d.h)(this,e)}async createGroupCall(e,t,n,i,s,o){if(this.getGroupCallForRoom(e))throw new Error(`${e} already has an existing group call`);const r=this.getRoom(e);if(!r)throw new Error(`Cannot find room ${e}`);return new K.a(this,r,t,n,i,void 0,s||this.isVoipWithNoMediaAllowed,o,this.isVoipWithNoMediaAllowed).create()}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.getSyncState())&&void 0!==e?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const e=this.getSyncState();return!!e&&(e===a.b.Prepared||e===a.b.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.retryImmediately())&&void 0!==e&&e}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const n=(new Date).getTime();return this.cachedCapabilities&&!t&&n<this.cachedCapabilities.expiration?(S.a.log("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(w.i.Get,"/capabilities").catch((e=>(S.a.error(e),{}))).then((function(){const t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).capabilities||{},i=Object.keys(t).length?oe:6e4+5e3*Math.random();return e.cachedCapabilities={capabilities:t,expiration:n+i},S.a.log("Caching capabilities: ",t),t}))}async initCrypto(){if(!Object(_.d)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.cryptoBackend)return void S.a.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");S.a.log("Crypto: Starting up crypto store..."),await this.cryptoStore.startup(),S.a.log("Crypto: initialising roomlist..."),await this.roomList.init();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new _.a(this,e,this.deviceId,this.store,this.cryptoStore,this.roomList,this.verificationMethods);this.reEmitter.reEmit(t,[_.b.KeyBackupFailed,_.b.KeyBackupSessionsRemaining,_.b.RoomKeyRequest,_.b.RoomKeyRequestCancellation,_.b.Warning,_.b.DevicesUpdated,_.b.WillUpdateDevices,_.b.DeviceVerificationChanged,_.b.UserTrustStatusChanged,_.b.KeysChanged]),S.a.log("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=_.a.getOlmVersion(),t.registerEventHandlers(this),this.cryptoBackend=this.crypto=t,this.crypto.uploadDeviceKeys().catch((e=>{S.a.error("Error uploading device keys",e)}))}async initRustCrypto(){if(this.cryptoBackend)return void S.a.warn("Attempt to re-initialise e2e encryption on MatrixClient");const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");const t=this.getDeviceId();if(null===t)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const i=await Promise.all([n.e(36),n.e(37)]).then(n.bind(null,1708)),s=await i.initRustCrypto(this.http,e,t);this.cryptoBackend=s,this.on(D.b.Membership,s.onRoomMembership.bind(s))}isCryptoEnabled(){return!!this.cryptoBackend}getDeviceEd25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceEd25519Key())&&void 0!==e?e:null}getDeviceCurve25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceCurve25519Key())&&void 0!==e?e:null}async uploadKeys(){S.a.warn("MatrixClient.uploadKeys is deprecated")}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=this.setDeviceVerification(e,t,n,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),i}setDeviceBlocked(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this.setDeviceVerification(e,t,null,n,null)}setDeviceKnown(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this.setDeviceVerification(e,t,null,null,n)}async setDeviceVerification(e,t,n,i,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,n,i,s)}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,n)}checkSecretStorageKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStorageKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices=e,e}getGlobalBlacklistUnverifiedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalErrorOnUnknownDevices}getCrossSigningId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:T.a.Master;if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,n)}prepareToEncrypt(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.prepareToEncrypt(e)}userHasCrossSigningKeys(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.userHasCrossSigningKeys()}isCrossSigningReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCryptoTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.setCryptoTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.addSecretStorageKey(e,t,n)}hasSecretStorageKey(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.hasSecretStorageKey(e)}storeSecret(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.storeSecret(e,t,n)}getSecret(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getSecret(e)}isSecretStored(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStored(e)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getDefaultSecretStorageKeyId()}setDefaultSecretStorageKeyId(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setDefaultSecretStorageKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}getOutgoingRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");const t=e.getWireContent(),n={session_id:t.session_id,sender_key:t.sender_key,algorithm:t.algorithm,room_id:e.getRoomId()};return n.session_id&&n.sender_key&&n.algorithm&&n.room_id?this.crypto.cryptoStore.getOutgoingRoomKeyRequest(n):Promise.resolve(null)}cancelAndResendEventRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){const t=this.getRoom(e);if(!t)return!1;return!!t.currentState.getStateEvents(N.b.RoomEncryption,"")||this.roomList.isRoomEncrypted(e)}encryptAndSendToDevices(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(e,t)}forceDiscardSession(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");this.crypto.forceDiscardSession(e)}exportRoomKeys(){return this.cryptoBackend?this.cryptoBackend.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.importRoomKeys(e,t)}checkKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.checkKeyBackup()}async getKeyBackupVersion(){let e;try{e=await this.http.authedRequest(w.i.Get,"/room_keys/version",void 0,void 0,{prefix:w.a.V3})}catch(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}return U.a.checkBackupVersion(e),e}isKeyBackupTrusted(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{secureSecretStorage:!1};if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:n,auth_data:i,recovery_key:s,privateKey:o}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.storeSecret("m.megolm_backup.v1",Object(f.encodeBase64)(o)),S.a.info("Key backup private key stored in secret storage")),{algorithm:n,auth_data:i,recovery_key:s}}isKeyBackupKeyStored(){return Promise.resolve(this.isSecretStored("m.megolm_backup.v1"))}async createKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);const t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");const n=await this.http.authedRequest(w.i.Post,"/room_keys/version",void 0,t,{prefix:w.a.V3});return await this.checkKeyBackup(),this.getKeyBackupEnabled()||S.a.error("Key backup not usable even though we just created it"),n}async deleteKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.version&&this.crypto.backupManager.disableKeyBackup();const t=m.o("/room_keys/version/$version",{$version:e});await this.http.authedRequest(w.i.Delete,t,void 0,void 0,{prefix:w.a.V3})}makeKeyBackupPath(e,t,n){let i;i=void 0!==t?m.o("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?m.o("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";return{path:i,queryData:void 0===n?void 0:{version:n}}}async sendKeyBackup(e,t,n,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");const s=this.makeKeyBackupPath(e,t,n);await this.http.authedRequest(w.i.Put,s.path,s.queryData,i,{prefix:w.a.V3})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return Object(C.a)(e),!0}catch(e){return!1}}keyBackupKeyFromPassword(e,t){return Object(O.b)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return Object(C.a)(e)}async restoreKeyBackupWithPassword(e,t,n,i,s){const o=await Object(O.b)(i.auth_data,e);return this.restoreKeyBackup(o,t,n,i,s)}async restoreKeyBackupWithSecretStorage(e,t,n,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");const s=await this.getSecret("m.megolm_backup.v1"),o=Object(_.c)(s);if(o){const e=await this.crypto.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",o,[e[0]])}const r=Object(f.decodeBase64)(o||s);return this.restoreKeyBackup(r,t,n,e,i)}restoreKeyBackupWithRecoveryKey(e,t,n,i,s){const o=Object(C.a)(e);return this.restoreKeyBackup(o,t,n,i,s)}async restoreKeyBackupWithCache(e,t,n,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");const s=await this.crypto.getSessionBackupPrivateKey();if(!s)throw new Error("Couldn't get key");return this.restoreKeyBackup(s,e,t,n,i)}async restoreKeyBackup(e,t,n,i,s){const o=null==s?void 0:s.cacheCompleteCallback,r=null==s?void 0:s.progressCallback;if(!this.crypto)throw new Error("End-to-end encryption disabled");let a=0,c=[];const l=this.makeKeyBackupPath(t,n,i.version),d=await U.a.makeAlgorithm(i,(async()=>e)),u=d.untrusted;try{if(!await d.keyMatches(e))return Promise.reject(new w.f({errcode:ge.RESTORE_BACKUP_ERROR_BAD_KEY}));this.crypto.storeSessionBackupPrivateKey(e).catch((e=>{S.a.warn("Error caching session backup key:",e)})).then(o),r&&r({stage:"fetch"});const i=await this.http.authedRequest(w.i.Get,l.path,l.queryData,void 0,{prefix:w.a.V3});if(i.rooms){const e=i.rooms;for(const[t,n]of Object.entries(e)){if(!n.sessions)continue;a+=Object.keys(n.sessions).length;const e=await d.decryptSessions(n.sessions);for(const n of e)n.room_id=t,c.push(n)}}else if(i.sessions){const e=i.sessions;a=Object.keys(e).length,c=await d.decryptSessions(e);for(const e of c)e.room_id=t}else{a=1;try{const[e]=await d.decryptSessions({[n]:i});e.room_id=t,e.session_id=n,c.push(e)}catch(e){S.a.log("Failed to decrypt megolm session from backup",e)}}}finally{d.free()}return await this.importRoomKeys(c,{progressCallback:r,untrusted:u,source:"backup"}),await this.checkKeyBackup(),{total:a,imported:c.length}}async deleteKeysFromBackup(e,t,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");const i=this.makeKeyBackupPath(e,t,n);await this.http.authedRequest(w.i.Delete,i.path,i.queryData,void 0,{prefix:w.a.V3})}async sendSharedHistoryKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=this.roomList.getRoomEncryption(e);if(!n)return void S.a.error("Unknown room.  Not sharing decryption keys");const i=await this.crypto.downloadKeys(t),s=new Map;for(const[e,t]of i)s.set(e,Array.from(t.values()));const o=this.crypto.getRoomDecryptor(e,n.algorithm);o.sendSharedHistoryInboundSessions?await o.sendSharedHistoryInboundSessions(s):S.a.warn("Algorithm does not support sharing previous keys",n.algorithm)}getMediaConfig(){return this.http.authedRequest(w.i.Get,"/config",void 0,void 0,{prefix:w.h.R0})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.store.getRooms(),n=new Set;for(const s of t){var i;const t=null===(i=s.findPredecessor(e))||void 0===i?void 0:i.roomId;t&&n.add(t)}return t.filter((e=>!e.currentState.getStateEvents(N.b.RoomTombstone,"")||!n.has(e.roomId)))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){const n=m.o("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return Object(w.l)(5,(()=>this.http.authedRequest(w.i.Put,n,void 0,t)))}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=m.o("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(w.i.Get,t)}catch(e){var n;if("M_NOT_FOUND"===(null===(n=e.data)||void 0===n?void 0:n.errcode))return null;throw e}}async deleteAccountData(e){const t=this.canSupport.get(Z.a.AccountDataDeletion);if(t===Z.b.Unsupported)return void await this.setAccountData(e,{});const n=m.o("/user/$userId/account_data/$type",{$userId:this.getSafeUserId(),$type:e}),i=t===Z.b.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return await this.http.authedRequest(w.i.Delete,n,void 0,void 0,i)}getIgnoredUsers(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){const t={ignored_users:{}};return e.forEach((e=>{t.ignored_users[e]={}})),this.setAccountData("m.ignored_user_list",t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};void 0===t.syncRoom&&(t.syncRoom=!0);const n=this.getRoom(e);if(null!=n&&n.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(n);let i=Promise.resolve();if(t.inviteSignUrl){const e=new URL(t.inviteSignUrl);e.searchParams.set("mxid",this.credentials.userId),i=this.http.requestOtherUrl(w.i.Post,e)}const s={};t.viaServers&&(s.server_name=t.viaServers);try{const n={},o=await i;o&&(n.third_party_signed=o);const r=m.o("/join/$roomid",{$roomid:e}),c=(await this.http.authedRequest(w.i.Post,r,s,n)).room_id,l=new a.a(this,this.clientOpts,this.buildSyncApiOptions()).createRoom(c);return t.syncRoom,l}catch(e){throw e}}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,c.a.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![c.a.QUEUED,c.a.NOT_SENT,c.a.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===c.a.ENCRYPTING?this.pendingEventEncryption.delete(e.getId()):this.scheduler&&e.status===c.a.QUEUED&&this.scheduler.removeEventFromQueue(e);const t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,c.a.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,N.b.RoomName,{name:t})}setRoomTopic(e,t,n){const i=j.makeTopicContent(t,n);return this.sendStateEvent(e,N.b.RoomTopic,i)}getRoomTags(e){const t=m.o("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(w.i.Get,t)}setRoomTag(e,t,n){const i=m.o("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(w.i.Put,i,void 0,n)}deleteRoomTag(e,t){const n=m.o("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(w.i.Delete,n)}setRoomAccountData(e,t,n){const i=m.o("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(w.i.Put,i,void 0,n)}setPowerLevel(e,t,n,i){let s={users:{}};(null==i?void 0:i.getType())===N.b.RoomPowerLevels&&(s=m.k(i.getContent()));const o=Array.isArray(t)?t:[t];for(const e of o)null==n?delete s.users[e]:s.users[e]=n;const r=m.o("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this.http.authedRequest(w.i.Put,r,void 0,s)}async unstable_createLiveBeacon(e,t){return this.unstable_setLiveBeacon(e,t)}async unstable_setLiveBeacon(e,t){return this.sendStateEvent(e,J.b.name,t,this.getUserId())}sendEvent(e,t,n,i,s){var o;let r,a,c,l;if(null!=t&&t.startsWith(he)||null===t?(l=s,c=i,a=n,r=t):(l=i,c=n,a=t,r=null),r&&(null===(o=c["m.relates_to"])||void 0===o||!o.rel_type)){var d,u;const t=!(null===(d=c["m.relates_to"])||void 0===d||!d["m.in_reply_to"]);c["m.relates_to"]=ie(ie({},c["m.relates_to"]),{},{rel_type:z.d.name,event_id:r,is_falling_back:!t});const n=null===(u=this.getRoom(e))||void 0===u?void 0:u.getThread(r);var h,m;if(n&&!t)c["m.relates_to"]["m.in_reply_to"]={event_id:null!==(h=null===(m=n.lastReply((e=>e.isRelation(z.d.name)&&!e.status)))||void 0===m?void 0:m.getId())&&void 0!==h?h:r}}return this.sendCompleteEvent(e,r,{type:a,content:c},l)}sendCompleteEvent(e,t,n,i){i||(i=this.makeTxnId());const s=new c.b(Object.assign(n,{event_id:"~"+e+":"+i,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),o=this.getRoom(e),r=t?null==o?void 0:o.getThread(t):void 0;r&&s.setThread(r),this.reEmitter.reEmit(s,[c.c.Replaced,c.c.VisibilityChange]),null==o||o.reEmitter.reEmit(s,[c.c.BeforeRedaction]);const a=s.getAssociatedId();if(null!=a&&a.startsWith("~")){const e=null==o?void 0:o.getPendingEvents().find((e=>e.getId()===a));null==e||e.once(c.c.LocalEventIdReplaced,(()=>{s.updateAssociatedId(e.getId())}))}const l=s.getType();return S.a.log(`sendEvent of type ${l} in ${e} with txnId ${i}`),s.setTxnId(i),s.setStatus(c.a.SENDING),null==o||o.addPendingEvent(s,i),s.status===c.a.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(o,s)}encryptAndSendEvent(e,t){let n=!1;return Promise.resolve().then((()=>{const i=this.encryptEventIfNeeded(t,null!=e?e:void 0);return i?(this.pendingEventEncryption.set(t.getId(),i),this.updatePendingEventStatus(e,t,c.a.ENCRYPTING),i.then((()=>{this.pendingEventEncryption.has(t.getId())?this.updatePendingEventStatus(e,t,c.a.SENDING):n=!0}))):null})).then((()=>{if(n)return{};let i=null;return this.scheduler&&(i=this.scheduler.queueEvent(t),i&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,c.a.QUEUED)),i||(i=this.sendEventHttpRequest(t),e&&(i=i.then((n=>(e.updatePendingEvent(t,c.a.SENT,n.event_id),n))))),i})).catch((n=>{S.a.error("Error sending event",n.stack||n);try{t.error=n,this.updatePendingEventStatus(e,t,c.a.NOT_SENT)}catch(e){S.a.error("Exception in error handler!",e.stack||n)}throw n instanceof w.f&&(n.event=t),n}))}encryptEventIfNeeded(e,t){if(e.isEncrypted())return null;if(e.isRedaction())return null;if(!t||!this.isRoomEncrypted(e.getRoomId()))return null;if(!this.cryptoBackend&&this.usingExternalCrypto)return null;if(e.getType()===N.b.Reaction)return null;if(!this.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return this.cryptoBackend.encryptEvent(e,t)}getEncryptedIfNeededEventType(e,t){return t===N.b.Reaction?t:this.isRoomEncrypted(e)?N.b.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}sendEventHttpRequest(e){let t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));const n={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t};let i;if(e.isState()){let t="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(t="/rooms/$roomId/state/$eventType/$stateKey"),i=m.o(t,n)}else if(e.isRedaction()){const t="/rooms/$roomId/redact/$redactsEventId/$txnId";i=m.o(t,ie({$redactsEventId:e.event.redacts},n))}else i=m.o("/rooms/$roomId/send/$eventType/$txnId",n);return this.http.authedRequest(w.i.Put,i,void 0,e.getWireContent()).then((t=>(S.a.log(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t)))}redactEvent(e,t,n,i,s){var o,r,a,c,l;null!==(o=n)&&void 0!==o&&o.startsWith(he)||(s=i,i=n,n=t,t=null);const d=null===(r=s)||void 0===r?void 0:r.reason;if(null!==(a=s)&&void 0!==a&&a.with_relations&&this.canSupport.get(Z.a.RelationBasedRedactions)===Z.b.Unsupported)throw new Error(`Server does not support relation based redactions roomId ${e} eventId ${n} txnId: ${i} threadId ${t}`);const u=null!==(c=s)&&void 0!==c&&c.with_relations?{[this.canSupport.get(Z.a.RelationBasedRedactions)===Z.b.Stable?N.d.stable:N.d.unstable]:null===(l=s)||void 0===l?void 0:l.with_relations}:{};return this.sendCompleteEvent(e,t,{type:N.b.RoomRedaction,content:ie(ie({},u),{},{reason:d}),redacts:n},i)}sendMessage(e,t,n,i){"string"!=typeof t&&null!==t&&(i=n,n=t,t=null);const s=N.b.RoomMessage,o=n;return this.sendEvent(e,t,s,o,i)}sendTextMessage(e,t,n,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(he)||null===t||(i=n,n=t,t=null);const o=j.makeTextMessage(n);return this.sendMessage(e,t,o,i)}sendNotice(e,t,n,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(he)||null===t||(i=n,n=t,t=null);const o=j.makeNotice(n);return this.sendMessage(e,t,o,i)}sendEmoteMessage(e,t,n,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(he)||null===t||(i=n,n=t,t=null);const o=j.makeEmoteMessage(n);return this.sendMessage(e,t,o,i)}sendImageMessage(e,t,n,i){var s;let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Image";null!==(s=t)&&void 0!==s&&s.startsWith(he)||null===t||(o=i||"Image",i=n,n=t,t=null);const r={msgtype:N.e.Image,url:n,info:i,body:o};return this.sendMessage(e,t,r)}sendStickerMessage(e,t,n,i){var s;let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Sticker";null!==(s=t)&&void 0!==s&&s.startsWith(he)||null===t||(o=i||"Sticker",i=n,n=t,t=null);const r={url:n,info:i,body:o};return this.sendEvent(e,t,N.b.Sticker,r)}sendHtmlMessage(e,t,n,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(he)||null===t||(i=n,n=t,t=null);const o=j.makeHtmlMessage(n,i);return this.sendMessage(e,t,o)}sendHtmlNotice(e,t,n,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(he)||null===t||(i=n,n=t,t=null);const o=j.makeHtmlNotice(n,i);return this.sendMessage(e,t,o)}sendHtmlEmote(e,t,n,i){var s;null!==(s=t)&&void 0!==s&&s.startsWith(he)||null===t||(i=n,n=t,t=null);const o=j.makeHtmlEmote(n,i);return this.sendMessage(e,t,o)}async sendReceipt(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.isGuest())return Promise.resolve({});const s=m.o("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()});if(!i){const t=!!e.threadRootId;n=ie(ie({},n),{},{thread_id:t?e.threadRootId:q.a})}const o=this.http.authedRequest(w.i.Post,s,void 0,n||{}),r=this.getRoom(e.getRoomId());return r&&this.credentials.userId&&r.addLocalEchoReceipt(this.credentials.userId,e,t),o}async sendReadReceipt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:q.b.Read,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e)return;const i=e.getId(),s=this.getRoom(e.getRoomId());if(null!=s&&s.hasPendingEvent(i))throw new Error(`Cannot set read receipt to a pending event (${i})`);return this.sendReceipt(e,t,{},n)}async setRoomReadMarkers(e,t,n,i){const s=this.getRoom(e);if(s&&s.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let o,r;if(n){if(o=n.getId(),null!=s&&s.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);null==s||s.addLocalEchoReceipt(this.credentials.userId,n,q.b.Read)}if(i){if(r=i.getId(),null!=s&&s.hasPendingEvent(r))throw new Error(`Cannot set read receipt to a pending event (${r})`);null==s||s.addLocalEchoReceipt(this.credentials.userId,i,q.b.ReadPrivate)}return await this.setRoomReadMarkersHttpRequest(e,t,o,r)}getUrlPreview(e,t){t=6e4*Math.floor(t/6e4);const n=new URL(e);n.hash="";const i=t+"_"+(e=n.toString()),s=this.urlPreviewCache[i];if(s)return s;const o=this.http.authedRequest(w.i.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:w.h.R0});return this.urlPreviewCache[i]=o,o}sendTyping(e,t,n){if(this.isGuest())return Promise.resolve({});const i=m.o("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),s={typing:t};return t&&(s.timeout=n||2e4),this.http.authedRequest(w.i.Put,i,void 0,s)}getRoomUpgradeHistory(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=this.getRoom(e);if(!i)return[];return[...this.findPredecessorRooms(i,t,n),i,...this.findSuccessorRooms(i,t,n)]}findPredecessorRooms(e,t,n){var i;const s=[];let o=null===(i=e.findPredecessor(n))||void 0===i?void 0:i.roomId;for(;null!==o;){var r;const i=this.getRoom(o);if(null===i)break;if(t){const t=i.currentState.getStateEvents(N.b.RoomTombstone,"");if(!t||t.getContent().replacement_room!==e.roomId)break}s.splice(0,0,i),o=null===(r=(e=i).findPredecessor(n))||void 0===r?void 0:r.roomId}return s}findSuccessorRooms(e,t,n){const i=[];let s=e.currentState.getStateEvents(N.b.RoomTombstone,"");for(;s;){const r=this.getRoom(s.getContent().replacement_room);if(!r)break;if(r.roomId===e.roomId)break;if(t){var o;const t=null===(o=r.findPredecessor(n))||void 0===o?void 0:o.roomId;if(!t||t!==e.roomId)break}i.push(r);if(new Set(i.map((e=>e.roomId))).size<i.length)return i.slice(0,i.length-1);s=(e=r).currentState.getStateEvents(N.b.RoomTombstone,"")}return i}invite(e,t,n){return this.membershipChange(e,t,"invite",n)}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}async inviteByThreePid(e,t,n){var i;const s=m.o("/rooms/$roomId/invite",{$roomId:e}),o=this.getIdentityServerUrl(!0);if(!o)return Promise.reject(new w.f({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const r={id_server:o,medium:t,address:n};if(null!==(i=this.identityServer)&&void 0!==i&&i.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(r.id_access_token=e)}return this.http.authedRequest(w.i.Post,s,void 0,r)}leave(e){return this.membershipChange(e,void 0,"leave")}leaveRoomChain(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=this.getRoomUpgradeHistory(e);let i=n;if(!t){i=[];for(const t of n)if(i.push(t),t.roomId===e)break}const s={},o=[],r=e=>this.leave(e).then((()=>{delete s[e]})).catch((t=>{s[e]=t}));for(const e of i)o.push(r(e.roomId));return Promise.all(o).then((()=>s))}ban(e,t,n){return this.membershipChange(e,t,"ban",n)}forget(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=this.membershipChange(e,void 0,"forget");return t?n.then((t=>(this.store.removeRoom(e),this.emit(me.DeleteRoom,e),t))):n}unban(e,t){const n=m.o("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(w.i.Post,n,void 0,i)}kick(e,t,n){const i=m.o("/rooms/$roomId/kick",{$roomId:e}),s={user_id:t,reason:n};return this.http.authedRequest(w.i.Post,i,void 0,s)}membershipChange(e,t,n,i){const s=m.o("/rooms/$room_id/$membership",{$room_id:e,$membership:n});return this.http.authedRequest(w.i.Post,s,void 0,{user_id:t,reason:i})}getPushActionsForEvent(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e.getPushActions()&&!t||e.setPushActions(this.pushProcessor.actionsForEvent(e)),e.getPushActions()}setProfileInfo(e,t){const n=m.o("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(w.i.Put,n,void 0,t)}async setDisplayName(e){const t=await this.setProfileInfo("displayname",{displayname:e}),n=this.getUser(this.getUserId());return n&&(n.displayName=e,n.emit(I.b.DisplayName,n.events.presence,n)),t}async setAvatarUrl(e){const t=await this.setProfileInfo("avatar_url",{avatar_url:e}),n=this.getUser(this.getUserId());return n&&(n.avatarUrl=e,n.emit(I.b.AvatarUrl,n.events.presence,n)),t}mxcUrlToHttp(e,t,n,i,s){return Object(R.a)(this.baseUrl,e,t,n,i,s)}async setPresence(e){const t=m.o("/presence/$userId/status",{$userId:this.credentials.userId});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);await this.http.authedRequest(w.i.Put,t,void 0,e)}getPresence(e){const t=m.o("/presence/$userId/status",{$userId:e});return this.http.authedRequest(w.i.Get,t)}scrollback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,n=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){const e=Date.now()-i.errorTs;n=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const s=this.store.scrollback(e,t).length;if(s===t)return Promise.resolve(e);t-=s;const o=new Promise(((i,s)=>{Object(m.N)(n).then((()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,p.a.Backward))).then((t=>{var n,s;const o=t.chunk.map(this.getEventMapper());if(t.state){const n=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(n)}const[r,a]=e.partitionThreadedEvents(o);this.processAggregatedTimelineEvents(e,r),e.addEventsToTimeline(r,!0,e.getLiveTimeline()),this.processThreadEvents(e,a,!0),e.oldState.paginationToken=null!==(n=t.end)&&void 0!==n?n:null,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,o,null!==(s=t.end)&&void 0!==s?s:null,!0),delete this.ongoingScrollbacks[e.roomId],i(e)})).catch((t=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},s(t)}))}));return i={promise:o},this.ongoingScrollbacks[e.roomId]=i,o}getEventMapper(e){return Object(A.a)(this,e||{})}async getEventTimeline(e,t){var n,i,s,o;if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(null==e||!e.room)throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&this.supportsThreads())return this.getThreadTimeline(e,t);const r=m.o("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let a;null!==(n=this.clientOpts)&&void 0!==n&&n.lazyLoadMembers&&(a={filter:JSON.stringify(u.a.LAZY_LOADING_MESSAGES_FILTER)});const c=await this.http.authedRequest(w.i.Get,r,a);if(!c.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);const l=this.getEventMapper(),d=l(c.event);if(d.isRelation(z.d.name))return void S.a.warn("Tried loading a regular timeline at the position of a thread event");const h=[...c.events_after.reverse().map(l),d,...c.events_before.map(l)];let g=e.getTimelineForEvent(h[0].getId());g?g.getState(p.b.BACKWARDS).setUnknownStateEvents(c.state.map(l)):(g=e.addTimeline(),g.initialiseState(c.state.map(l)),g.getState(p.b.FORWARDS).paginationToken=c.end);const[v,f]=e.room.partitionThreadedEvents(h);return e.addEventsToTimeline(v,!0,g,c.start),this.processThreadEvents(e.room,f,!0),this.processAggregatedTimelineEvents(e.room,v),null!==(i=null!==(s=e.getTimelineForEvent(t))&&void 0!==s?s:null===(o=e.room.findThreadForEvent(d))||void 0===o?void 0:o.liveTimeline)&&void 0!==i?i:g}async getThreadTimeline(e,t){var n;if(!this.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");const i=m.o("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),s={limit:"0"};null!==(n=this.clientOpts)&&void 0!==n&&n.lazyLoadMembers&&(s.filter=JSON.stringify(u.a.LAZY_LOADING_MESSAGES_FILTER));const o=await this.http.authedRequest(w.i.Get,i,s),r=this.getEventMapper(),a=r(o.event);if(e.canContain(a)&&z.e.hasServerSideSupport){if(z.e.hasServerSideFwdPaginationSupport){var c,l,d;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");const n=e.thread,i=await this.fetchRelations(e.room.roomId,n.id,z.d.name,null,{dir:p.a.Backward,from:o.start}),s=await this.fetchRelations(e.room.roomId,n.id,z.d.name,null,{dir:p.a.Forward,from:o.end}),u=[...s.chunk.reverse().map(r),a,...i.chunk.map(r)];for(const t of u){var h;await(null===(h=e.thread)||void 0===h?void 0:h.processEvent(t))}let m=e.getTimelineForEvent(a.getId());if(m?m.getState(p.b.BACKWARDS).setUnknownStateEvents(o.state.map(r)):(m=e.addTimeline(),m.initialiseState(o.state.map(r))),e.addEventsToTimeline(u,!0,m,s.next_batch),!i.next_batch){const t=await this.fetchRoomEvent(e.room.roomId,n.id);e.addEventsToTimeline([r(t)],!0,m,null)}return m.setPaginationToken(null!==(c=i.next_batch)&&void 0!==c?c:null,p.a.Backward),m.setPaginationToken(null!==(l=s.next_batch)&&void 0!==l?l:null,p.a.Forward),this.processAggregatedTimelineEvents(e.room,u),null!==(d=e.getTimelineForEvent(t))&&void 0!==d?d:m}{var g;const t=e.thread,n=await this.fetchRelations(e.room.roomId,t.id,z.d.name,null,{dir:p.a.Backward,from:o.start}),i=[];let s=o.end;for(;s;){var v;const n=await this.fetchRelations(e.room.roomId,t.id,z.d.name,null,{dir:p.a.Forward,from:s});s=null!==(v=n.next_batch)&&void 0!==v?v:null,i.push(...n.chunk)}const c=[...i.reverse().map(r),a,...n.chunk.map(r)];for(const t of c){var f;await(null===(f=e.thread)||void 0===f?void 0:f.processEvent(t))}const l=e.getLiveTimeline();if(l.getState(p.b.BACKWARDS).setUnknownStateEvents(o.state.map(r)),e.addEventsToTimeline(c,!0,l,null),!n.next_batch){const n=await this.fetchRoomEvent(e.room.roomId,t.id);e.addEventsToTimeline([r(n)],!0,l,null)}return l.setPaginationToken(null!==(g=n.next_batch)&&void 0!==g?g:null,p.a.Backward),l.setPaginationToken(null,p.a.Forward),this.processAggregatedTimelineEvents(e.room,c),l}}}async getLatestTimeline(e){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");let t;if(null!==e.threadListType){var n;t=null===(n=(await this.createThreadListMessagesRequest(e.room.roomId,null,1,p.a.Backward,e.threadListType,e.getFilter())).chunk)||void 0===n?void 0:n[0]}else if(e.thread&&z.e.hasServerSideSupport){var i;t=null===(i=(await this.fetchRelations(e.room.roomId,e.thread.id,z.d.name,null,{dir:p.a.Backward,limit:1})).chunk)||void 0===i?void 0:i[0]}else{var s,o;const n=m.o("/rooms/$roomId/messages",{$roomId:e.room.roomId}),i={dir:"b"};null!==(s=this.clientOpts)&&void 0!==s&&s.lazyLoadMembers&&(i.filter=JSON.stringify(u.a.LAZY_LOADING_MESSAGES_FILTER));t=null===(o=(await this.http.authedRequest(w.i.Get,n,i)).chunk)||void 0===o?void 0:o[0]}if(!t)throw new Error("No message returned when trying to construct getLatestTimeline");return this.getEventTimeline(e,t.event_id)}createMessagesRequest(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,s=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;const r=m.o("/rooms/$roomId/messages",{$roomId:e}),a={limit:i.toString(),dir:s};t&&(a.from=t);let c=null;var l;(null!==(n=this.clientOpts)&&void 0!==n&&n.lazyLoadMembers&&(c=Object.assign({},u.a.LAZY_LOADING_MESSAGES_FILTER)),o)&&(c=c||{},Object.assign(c,null===(l=o.getRoomTimelineFilterComponent())||void 0===l?void 0:l.toJSON()));return c&&(a.filter=JSON.stringify(c)),this.http.authedRequest(w.i.Get,r,a)}createThreadListMessagesRequest(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:p.a.Backward,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:z.g.All,r=arguments.length>5?arguments[5]:void 0;const a=m.o("/rooms/$roomId/threads",{$roomId:e}),c={limit:i.toString(),dir:s,include:Object(z.i)(o)};t&&(c.from=t);let l={};var d;(null!==(n=this.clientOpts)&&void 0!==n&&n.lazyLoadMembers&&(l=ie({},u.a.LAZY_LOADING_MESSAGES_FILTER)),r)&&(l=ie(ie({},l),null===(d=r.getRoomTimelineFilterComponent())||void 0===d?void 0:d.toJSON()));Object.keys(l).length&&(c.filter=JSON.stringify(l));const h={prefix:z.e.hasServerSideListSupport===z.c.Stable?"/_matrix/client/v1":"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(w.i.Get,a,c,void 0,h).then((e=>{var t;return ie(ie({},e),{},{chunk:null===(t=e.chunk)||void 0===t?void 0:t.reverse(),start:e.prev_batch,end:e.next_batch})}))}paginateEventTimeline(e,t){const n=e.getTimelineSet()===this.notifTimelineSet,i=this.getRoom(e.getRoomId()),s=e.getTimelineSet().threadListType,o=e.getTimelineSet().thread,r=(t=t||{}).backwards||!1;if(n&&!r)throw new Error("paginateNotifTimeline can only paginate backwards");const a=r?p.b.BACKWARDS:p.b.FORWARDS,c=e.getPaginationToken(a),l=e.paginationRequests[a];if(l)return l;let d,u,h;var v;if(n)d="/notifications",u={limit:(null!==(v=t.limit)&&void 0!==v?v:30).toString(),only:"highlight"},c&&"end"!==c&&(u.from=c),h=this.http.authedRequest(w.i.Get,"/notifications",u).then((async t=>{const n=t.next_token,i=[];t.notifications=t.notifications.filter(m.A);for(let e=0;e<t.notifications.length;e++){const n=t.notifications[e],s=this.getEventMapper()(n.event);s.setPushActions(g.a.actionListToActionsObject(n.actions)),s.event.room_id=n.room_id,i[e]=s}const s=e.getTimelineSet();return s.addEventsToTimeline(i,r,e,n),this.processAggregatedTimelineEvents(s.room,i),r&&!t.next_token&&e.setPaginationToken(null,a),Boolean(t.next_token)})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=h;else if(null!==s){if(!i)throw new Error("Unknown room "+e.getRoomId());if(!z.e.hasServerSideFwdPaginationSupport&&a===p.a.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");h=this.createThreadListMessagesRequest(e.getRoomId(),c,t.limit,a,s,e.getFilter()).then((t=>{if(t.state){const n=e.getState(a),i=t.state.filter(m.A).map(this.getEventMapper());n.setUnknownStateEvents(i)}const n=t.end,s=t.chunk.filter(m.A).map(this.getEventMapper());return e.getTimelineSet().addEventsToTimeline(s,r,e,n),this.processAggregatedTimelineEvents(i,s),this.processThreadRoots(i,s,r),r&&t.end==t.start&&e.setPaginationToken(null,a),t.end!==t.start})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=h}else if(o){var f,b;const n=this.getRoom(null!==(f=e.getRoomId())&&void 0!==f?f:void 0);if(!n)throw new Error("Unknown room "+e.getRoomId());h=this.fetchRelations(null!==(b=e.getRoomId())&&void 0!==b?b:"",o.id,z.d.name,null,{dir:a,limit:t.limit,from:null!=c?c:void 0}).then((async t=>{const i=this.getEventMapper(),s=t.chunk.filter(m.A).map(i);for(const e of s.slice().reverse()){await(null==o?void 0:o.processEvent(e));const t=e.getSender();r&&null!==(null==o?void 0:o.getEventReadUpTo(t))||n.addLocalEchoReceipt(t,e,q.b.Read)}const c=t.next_batch,l=e.getTimelineSet();if(l.addEventsToTimeline(s,r,e,null!=c?c:null),!c&&r){var d;const t=await this.fetchRoomEvent(null!==(d=e.getRoomId())&&void 0!==d?d:"",o.id);l.addEventsToTimeline([i(t)],!0,e,null)}return this.processAggregatedTimelineEvents(l.room,s),r&&!c&&e.setPaginationToken(null,a),Boolean(c)})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=h}else{if(!i)throw new Error("Unknown room "+e.getRoomId());h=this.createMessagesRequest(e.getRoomId(),c,t.limit,a,e.getFilter()).then((t=>{if(t.state){const n=e.getState(a),i=t.state.filter(m.A).map(this.getEventMapper());n.setUnknownStateEvents(i)}const n=t.end,s=t.chunk.filter(m.A).map(this.getEventMapper()),o=e.getTimelineSet(),[c]=i.partitionThreadedEvents(s);o.addEventsToTimeline(c,r,e,n),this.processAggregatedTimelineEvents(i,c),this.processThreadRoots(i,c.filter((e=>e.getServerAggregatedRelation(z.d.name))),!1);const l=void 0===t.end||t.end===t.start;return r&&l&&e.setPaginationToken(null,a),!l})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=h}return h}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t;return null===(t=this.peekSync)||void 0===t||t.stopPeeking(),this.peekSync=new a.a(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){const n=this.sendStateEvent(e,N.b.RoomGuestAccess,{guest_access:t.allowJoin?"can_join":"forbidden"},"");let i=Promise.resolve(void 0);return t.allowRead&&(i=this.sendStateEvent(e,N.b.RoomHistoryVisibility,{history_visibility:"world_readable"},"")),Promise.all([i,n]).then()}requestRegisterEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestRegisterMsisdnToken(e,t,n,i,s){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:s})}requestAdd3pidEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestAdd3pidMsisdnToken(e,t,n,i,s){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:s})}requestPasswordEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestPasswordMsisdnToken(e,t,n,i,s){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:s})}async requestTokenFromEndpoint(e,t){const n=Object.assign({},t);if(!await this.doesServerSupportSeparateAddAndBind()&&this.idBaseUrl){var i;const e=new URL(this.idBaseUrl);if(n.id_server=e.host,null!==(i=this.identityServer)&&void 0!==i&&i.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(n.id_access_token=e)}}return this.http.request(w.i.Post,e,void 0,n)}getRoomPushRule(e,t){var n,i;if(this.pushRules)return null===(n=this.pushRules[e])||void 0===n||null===(i=n.room)||void 0===i?void 0:i.find((e=>e.rule_id===t));throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,n){let i,s=!1;const o=this.getRoomPushRule(e,t);if(null!=o&&o.actions.includes(V.d.DontNotify)&&(s=!0),n)if(o){if(!s){const n=m.m();this.deletePushRule(e,V.e.RoomSpecific,o.rule_id).then((()=>{this.addPushRule(e,V.e.RoomSpecific,t,{actions:[V.d.DontNotify]}).then((()=>{n.resolve()})).catch((e=>{n.reject(e)}))})).catch((e=>{n.reject(e)})),i=n.promise}}else i=this.addPushRule(e,V.e.RoomSpecific,t,{actions:[V.d.DontNotify]});else s&&(i=this.deletePushRule(e,V.e.RoomSpecific,o.rule_id));if(i)return new Promise(((e,t)=>{i.then((()=>{this.getPushRules().then((t=>{this.pushRules=t,e()})).catch((e=>{t(e)}))})).catch((e=>{this.getPushRules().then((n=>{this.pushRules=n,t(e)})).catch((n=>{t(e)}))}))}))}searchMessageText(e){const t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:B.a.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then((e=>this.processRoomEventsSearch(n,e)))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},n=this.search(t,e.abortSignal).then((t=>this.processRoomEventsSearch(e,t))).finally((()=>{e.pendingRequest=void 0}));return e.pendingRequest=n,n}processRoomEventsSearch(e,t){var n,i;const s=t.search_categories.room_events;e.count=s.count,e.next_batch=s.next_batch;const o=new Set(s.highlights);e.highlights.forEach((e=>{o.add(e)})),e.highlights=Array.from(o);const r=this.getEventMapper(),a=null!==(n=null===(i=s.results)||void 0===i?void 0:i.length)&&void 0!==n?n:0;for(let t=0;t<a;t++){const n=k.a.fromJson(s.results[t],r),i=this.getRoom(n.context.getEvent().getRoomId());if(i)for(const e of n.context.getTimeline()){const t=i.getMember(e.getSender());!e.sender&&t&&(e.sender=t)}e.results.push(n)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const e=new a.a(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then((()=>{S.a.log("Marking success of sync left room request"),this.syncedLeftRooms=!0})).finally((()=>{this.syncLeftRoomsPromise=void 0})),this.syncLeftRoomsPromise}createFilter(e){const t=m.o("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(w.i.Post,t,void 0,e).then((t=>{const n=u.a.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(n),n}))}getFilter(e,t,n){if(n){const n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}const i=m.o("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(w.i.Get,i).then((n=>{const i=u.a.fromJson(e,t,n);return this.store.storeFilter(i),i}))}async getOrCreateFilter(e,t){const n=this.store.getFilterIdByName(e);let i;if(n){try{const e=await this.getFilter(this.credentials.userId,n,!0);if(e){const s=e.getDefinition(),o=t.getDefinition();m.j(s,o)&&(i=n)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}i||this.store.setFilterIdByName(e,void 0)}if(i)return i;const s=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,s.filterId),s.filterId}getOpenIdToken(){const e=m.o("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(w.i.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(w.i.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return void 0!==this.checkTurnServersIntervalID}async checkTurnServers(){if(!this.canSupportVoip)return;let t=!1;const n=this.turnServersExpiry-Date.now();if(n>re)S.a.debug("TURN creds are valid for another "+n+" ms: not fetching new ones."),t=!0;else{S.a.debug("Fetching new TURN credentials");try{const e=await this.turnServer();if(e.uris){S.a.log("Got TURN URIs: "+e.uris+" refresh in "+e.ttl+" secs");const n={urls:e.uris,username:e.username,credential:e.password};this.turnServers=[n],this.turnServersExpiry=Date.now()+1e3*e.ttl,t=!0,this.emit(me.TurnServers,this.turnServers)}}catch(t){S.a.error("Failed to get TURN URIs",t),403===t.httpStatus?(S.a.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&e.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.emit(me.TurnServersError,t,!0)):this.emit(me.TurnServersError,t,!1)}}return t}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const e=m.o("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(w.i.Get,e,void 0,void 0,{prefix:""}).then((e=>e.admin))}whoisSynapseUser(e){const t=m.o("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(w.i.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){const t=m.o("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(w.i.Post,t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){var e;this.clientWellKnownPromise=v.a.getRawClientConfig(null!==(e=this.getDomain())&&void 0!==e?e:void 0),this.clientWellKnown=await this.clientWellKnownPromise,this.emit(me.ClientWellKnown,this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){const e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter((t=>{let[n,i]=t;return e.includes(typeof i)})).reduce(((e,t)=>{let[n,i]=t;return e[n]=i,e}),{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){const t=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666"),n=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666.mutual_rooms");if(!t&&!n)throw Error("Server does not support mutual_rooms API");const i=m.o(`/uk.half-shot.msc2666/user/${n?"mutual_rooms":"shared_rooms"}/$userId`,{$userId:e});return(await this.http.authedRequest(w.i.Get,i,void 0,void 0,{prefix:w.a.Unstable})).joined}async getVersions(){if(this.serverVersionsPromise)return this.serverVersionsPromise;this.serverVersionsPromise=this.http.request(w.i.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch((e=>{throw this.serverVersionsPromise=void 0,e}));const e=await this.serverVersionsPromise;return this.canSupport=await Object(Z.c)(e),this.serverVersionsPromise}async isVersionSupported(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportLazyLoading(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,n=e.unstable_features;return t&&t.includes("r0.5.0")||n&&n["m.lazy_load_members"]}async doesServerRequireIdServerParam(){const e=await this.getVersions();if(!e)return!0;const t=e.versions;if(t&&t.includes("r0.6.0"))return!1;const n=e.unstable_features;return!n||(void 0===n["m.require_identity_server"]||n["m.require_identity_server"])}async doesServerAcceptIdentityAccessToken(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,n=e.unstable_features;return t&&t.includes("r0.6.0")||n&&n["m.id_access_token"]}async doesServerSupportSeparateAddAndBind(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,n=e.unstable_features;return(null==t?void 0:t.includes("r0.6.0"))||(null==n?void 0:n["m.separate_add_and_bind"])}async doesServerSupportUnstableFeature(e){const t=await this.getVersions();if(!t)return!1;const n=t.unstable_features;return n&&!!n[e]}async doesServerForceEncryptionForPreset(e){const t=await this.getVersions();if(!t)return!1;const n=t.unstable_features,i=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n[`io.element.e2ee_forced.${i}`]}async doesServerSupportThread(){if(await this.isVersionSupported("v1.4"))return{threads:z.c.Stable,list:z.c.Stable,fwdPagination:z.c.Stable};try{const[e,t,n,i,s,o]=await Promise.all([this.doesServerSupportUnstableFeature("org.matrix.msc3440"),this.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3856"),this.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3715"),this.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:Object(z.h)(t,e),list:Object(z.h)(i,n),fwdPagination:Object(z.h)(o,s)}}catch(e){return{threads:z.c.None,list:z.c.None,fwdPagination:z.c.None}}}doesServerSupportLogoutDevices(){return this.isVersionSupported("r0.6.1")}hasLazyLoadMembersEnabled(){var e;return!(null===(e=this.clientOpts)||void 0===e||!e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,n,i){var s,o;let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{dir:p.a.Backward};const a=i?this.getEncryptedIfNeededEventType(e,i):null,[c,l]=await Promise.all([this.fetchRoomEvent(e,t),this.fetchRelations(e,t,n,a,r)]),d=this.getEventMapper(),u=c?d(c):void 0;let h=l.chunk.map(d);if(a===N.b.RoomMessageEncrypted){const e=u?h.concat(u):h;await Promise.all(e.map((e=>this.decryptEventIfNeeded(e)))),null!==i&&(h=h.filter((e=>e.getType()===i)))}return u&&n===N.h.Replace&&(h=h.filter((e=>e.getSender()===u.getSender()))),{originalEvent:null!=u?u:null,events:h,nextBatch:null!==(s=l.next_batch)&&void 0!==s?s:null,prevBatch:null!==(o=l.prev_batch)&&void 0!==o?o:null}}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return Object(L.b)(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.isCryptoEnabled()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case E.a.IS:return this.http.getUrl("/terms",void 0,w.e.V2,t);case E.a.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t;return arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&(null!==(e=this.idBaseUrl)&&void 0!==e&&e.startsWith("http://")||null!==(t=this.idBaseUrl)&&void 0!==t&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=m.p(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}setAccessToken(e){this.http.opts.accessToken=e}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(w.i.Get,"/register/available",{username:e}).then((e=>e.available)).catch((e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e)))}register(e,t,n,i,s,o,r){!0===s?s={email:!0}:null!=s&&!1!==s||(s={}),n&&(i.session=n);const a={auth:i,refresh_token:!0};return null!=e&&(a.username=e),null!=t&&(a.password=t),s.email&&(a.bind_email=!0),s.msisdn&&(a.bind_msisdn=!0),null!=o&&(a.guest_access_token=o),null!=r&&(a.inhibit_login=r),null!=t&&(a.x_show_msisdn=!0),this.registerRequest(a)}registerGuest(){let{body:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){const n={};return t&&(n.kind=t),this.http.request(w.i.Post,"/register",n,e)}refreshToken(e){return this.http.authedRequest(w.i.Post,"/refresh",void 0,{refresh_token:e},{prefix:w.a.V1,inhibitLogoutEmit:!0})}loginFlows(){return this.http.request(w.i.Get,"/login")}login(e,t){const n={type:e};return Object.assign(n,t),this.http.authedRequest(w.i.Post,"/login",void 0,n).then((e=>(e.access_token&&e.user_id&&(this.http.opts.accessToken=e.access_token,this.credentials={userId:e.user_id}),e)))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}loginWithSAML2(e){return this.login("m.login.saml2",{relay_state:e})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){let t=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,i="/login/"+(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sso")+"/redirect";t&&(i+="/"+t);const s={redirectUrl:e,[pe.unstable]:n};return this.http.getUrl(i,s,w.a.R0).href}loginWithToken(e){return this.login("m.login.token",{token:e})}async logout(){var e,t;let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(null!==(e=this.crypto)&&void 0!==e&&null!==(t=e.backupManager)&&void 0!==t&&t.getKeyBackupEnabled())try{for(;await this.crypto.backupManager.backupPendingKeys(200)>0;);}catch(e){S.a.error("Key backup request failed when logging out. Some keys may be missing from backup",e)}return n&&(this.stopClient(),this.http.abort()),this.http.authedRequest(w.i.Post,"/logout")}deactivateAccount(e,t){const n={};return e&&(n.auth=e),void 0!==t&&(n.erase=t),this.http.authedRequest(w.i.Post,"/account/deactivate",void 0,n)}requestLoginToken(e){const t={auth:e};return this.http.authedRequest(w.i.Post,"/org.matrix.msc3882/login/token",void 0,t,{prefix:w.a.Unstable})}getFallbackAuthUrl(e,t){const n=m.o("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(n,{session:t},w.a.R0).href}async createRoom(e){var t;const n=(e.invite_3pid||[]).filter((e=>!e.id_access_token));if(n.length>0&&null!==(t=this.identityServer)&&void 0!==t&&t.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();if(e)for(const t of n)t.id_access_token=e}return this.http.authedRequest(w.i.Post,"/createRoom",void 0,e)}fetchRelations(e,t,n,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{dir:p.a.Backward};z.e.hasServerSideFwdPaginationSupport===z.c.Experimental&&(s=Object(m.K)("dir","org.matrix.msc3715.dir",s));const o=m.n(s);let r="/rooms/$roomId/relations/$eventId";null!==n?(r+="/$relationType",null!==i&&(r+="/$eventType")):null!==i&&(S.a.warn(`eventType: ${i} ignored when fetching\n            relations as relationType is null`),i=null);const a=m.o(r+"?"+o,{$roomId:e,$eventId:t,$relationType:n,$eventType:i});return this.http.authedRequest(w.i.Get,a,void 0,void 0,{prefix:w.a.V1})}roomState(e){const t=m.o("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(w.i.Get,t)}fetchRoomEvent(e,t){const n=m.o("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(w.i.Get,n)}members(e,t,n,i){const s={};t&&(s.membership=t),n&&(s.not_membership=n),i&&(s.at=i);const o=m.n(s),r=m.o("/rooms/$roomId/members?"+o,{$roomId:e});return this.http.authedRequest(w.i.Get,r)}upgradeRoom(e,t){const n=m.o("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(w.i.Post,n,void 0,{new_version:t})}getStateEvent(e,t,n){const i={$roomId:e,$eventType:t,$stateKey:n};let s=m.o("/rooms/$roomId/state/$eventType",i);return void 0!==n&&(s=m.o(s+"/$stateKey",i)),this.http.authedRequest(w.i.Get,s)}sendStateEvent(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const o={$roomId:e,$eventType:t,$stateKey:i};let r=m.o("/rooms/$roomId/state/$eventType",o);return void 0!==i&&(r=m.o(r+"/$stateKey",o)),this.http.authedRequest(w.i.Put,r,void 0,n,s)}roomInitialSync(e,t){var n;const i=m.o("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(w.i.Get,i,{limit:null!==(n=null==t?void 0:t.toString())&&void 0!==n?n:"30"})}async setRoomReadMarkersHttpRequest(e,t,n,i){const s=m.o("/rooms/$roomId/read_markers",{$roomId:e}),o={[q.b.FullyRead]:t,[q.b.Read]:n};return(await this.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")||await this.isVersionSupported("v1.4"))&&(o[q.b.ReadPrivate]=i),this.http.authedRequest(w.i.Post,s,void 0,o)}getJoinedRooms(){const e=m.o("/joined_rooms",{});return this.http.authedRequest(w.i.Get,e)}getJoinedRoomMembers(e){const t=m.o("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(w.i.Get,t)}publicRooms(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{server:t,limit:n,since:i}=e,o=s()(e,te);const r={server:t,limit:n,since:i};return 0===Object.keys(o).length?this.http.authedRequest(w.i.Get,"/publicRooms",r):this.http.authedRequest(w.i.Post,"/publicRooms",r,o)}createAlias(e,t){const n=m.o("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(w.i.Put,n,void 0,i)}deleteAlias(e){const t=m.o("/directory/room/$alias",{$alias:e});return this.http.authedRequest(w.i.Delete,t)}getLocalAliases(e){const t=m.o("/rooms/$roomId/aliases",{$roomId:e}),n=w.a.V3;return this.http.authedRequest(w.i.Get,t,void 0,void 0,{prefix:n})}getRoomIdForAlias(e){const t=m.o("/directory/room/$alias",{$alias:e});return this.http.authedRequest(w.i.Get,t)}resolveRoomAlias(e){const t=m.o("/directory/room/$alias",{$alias:e});return this.http.request(w.i.Get,t)}getRoomDirectoryVisibility(e){const t=m.o("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(w.i.Get,t)}setRoomDirectoryVisibility(e,t){const n=m.o("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(w.i.Put,n,void 0,{visibility:t})}setRoomDirectoryVisibilityAppService(e,t,n){const i=m.o("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this.http.authedRequest(w.i.Put,i,void 0,{visibility:n})}searchUserDirectory(e){let{term:t,limit:n}=e;const i={search_term:t};return void 0!==n&&(i.limit=n),this.http.authedRequest(w.i.Post,"/user_directory/search",void 0,i)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){const n=t?m.o("/profile/$userId/$info",{$userId:e,$info:t}):m.o("/profile/$userId",{$userId:e});return this.http.authedRequest(w.i.Get,n)}getThreePids(){return this.http.authedRequest(w.i.Get,"/account/3pid")}addThreePid(e,t){const n={threePidCreds:e,bind:t};return this.http.authedRequest(w.i.Post,"/account/3pid",void 0,n)}async addThreePidOnly(e){const t=await this.isVersionSupported("r0.6.0")?w.a.R0:w.a.Unstable;return this.http.authedRequest(w.i.Post,"/account/3pid/add",void 0,e,{prefix:t})}async bindThreePid(e){const t=await this.isVersionSupported("r0.6.0")?w.a.R0:w.a.Unstable;return this.http.authedRequest(w.i.Post,"/account/3pid/bind",void 0,e,{prefix:t})}async unbindThreePid(e,t){const n={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},i=await this.isVersionSupported("r0.6.0")?w.a.R0:w.a.Unstable;return this.http.authedRequest(w.i.Post,"/account/3pid/unbind",void 0,n,{prefix:i})}deleteThreePid(e,t){return this.http.authedRequest(w.i.Post,"/account/3pid/delete",void 0,{medium:e,address:t})}setPassword(e,t,n){const i={auth:e,new_password:t,logout_devices:n};return this.http.authedRequest(w.i.Post,"/account/password",void 0,i)}getDevices(){return this.http.authedRequest(w.i.Get,"/devices")}getDevice(e){const t=m.o("/devices/$device_id",{$device_id:e});return this.http.authedRequest(w.i.Get,t)}setDeviceDetails(e,t){const n=m.o("/devices/$device_id",{$device_id:e});return this.http.authedRequest(w.i.Put,n,void 0,t)}deleteDevice(e,t){const n=m.o("/devices/$device_id",{$device_id:e}),i={};return t&&(i.auth=t),this.http.authedRequest(w.i.Delete,n,void 0,i)}deleteMultipleDevices(e,t){const n={devices:e};t&&(n.auth=t);return this.http.authedRequest(w.i.Post,"/delete_devices",void 0,n)}async getPushers(){const e=await this.http.authedRequest(w.i.Get,"/pushers");return await this.doesServerSupportUnstableFeature("org.matrix.msc3881")||(e.pushers=e.pushers.map((e=>(e.hasOwnProperty(N.g.name)||(e[N.g.name]=!0),e)))),e}setPusher(e){return this.http.authedRequest(w.i.Post,"/pushers/set",void 0,e)}setLocalNotificationSettings(e,t){const n=`${N.c.name}.${e}`;return this.setAccountData(n,t)}getPushRules(){return this.http.authedRequest(w.i.Get,"/pushrules/").then((e=>(this.setPushRules(e),this.pushRules)))}setPushRules(e){this.pushRules=g.a.rewriteDefaultRules(e),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,n,i){const s=m.o("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(w.i.Put,s,void 0,i)}deletePushRule(e,t,n){const i=m.o("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(w.i.Delete,i)}setPushRuleEnabled(e,t,n,i){const s=m.o("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this.http.authedRequest(w.i.Put,s,void 0,{enabled:i})}setPushRuleActions(e,t,n,i){const s=m.o("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this.http.authedRequest(w.i.Put,s,void 0,{actions:i})}search(e,t){let{body:n,next_batch:i}=e;const s={};return i&&(s.next_batch=i),this.http.authedRequest(w.i.Post,"/search",s,n,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(w.i.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(w.i.Post,"/keys/signatures/upload",void 0,e,{prefix:w.a.V3})}downloadKeysForUsers(e){let{token:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n={device_keys:{}};return void 0!==t&&(n.token=t),e.forEach((e=>{n.device_keys[e]=[]})),this.http.authedRequest(w.i.Post,"/keys/query",void 0,n)}claimOneTimeKeys(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"signed_curve25519",n=arguments.length>2?arguments[2]:void 0;const i={};void 0===t&&(t="signed_curve25519");for(const[n,s]of e){const e=i[n]||{};i[n]=e,e[s]=t}const s={one_time_keys:i};n&&(s.timeout=n);return this.http.authedRequest(w.i.Post,"/keys/claim",void 0,s)}getKeyChanges(e,t){const n={from:e,to:t};return this.http.authedRequest(w.i.Get,"/keys/changes",n)}uploadDeviceSigningKeys(e,t){const n=Object.assign({},t);return e&&Object.assign(n,{auth:e}),this.http.authedRequest(w.i.Post,"/keys/device_signing/upload",void 0,n,{prefix:w.a.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");const t=this.http.getUrl("/account/register",void 0,w.e.V2,this.idBaseUrl);return this.http.requestOtherUrl(w.i.Post,t,e)}requestEmailToken(e,t,n,i,s){const o={client_secret:t,email:e,send_attempt:null==n?void 0:n.toString()};return i&&(o.next_link=i),this.http.idServerRequest(w.i.Post,"/validate/email/requestToken",o,w.e.V2,s)}requestMsisdnToken(e,t,n,i,s,o){const r={client_secret:n,country:e,phone_number:t,send_attempt:null==i?void 0:i.toString()};return s&&(r.next_link=s),this.http.idServerRequest(w.i.Post,"/validate/msisdn/requestToken",r,w.e.V2,o)}submitMsisdnToken(e,t,n,i){const s={sid:e,client_secret:t,token:n};return this.http.idServerRequest(w.i.Post,"/validate/msisdn/submitToken",s,w.e.V2,i)}submitMsisdnTokenOtherUrl(e,t,n,i){const s={sid:t,client_secret:n,token:i};return this.http.requestOtherUrl(w.i.Post,e,s)}getIdentityHashDetails(e){return this.http.idServerRequest(w.i.Get,"/hash_details",void 0,w.e.V2,e)}async identityHashedLookup(t,n){const i={},s=await this.getIdentityHashDetails(n);if(!s||!s.lookup_pepper||!s.algorithms)throw new Error("Unsupported identity server: bad response");i.pepper=s.lookup_pepper;const o={};if(s.algorithms.includes("sha256")){const n=new e.Olm.Utility;i.addresses=t.map((e=>{const t=e[0].toLowerCase(),s=e[1].toLowerCase(),r=n.sha256(`${t} ${s} ${i.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return o[r]=e[0],r})),i.algorithm="sha256"}else{if(!s.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");i.addresses=t.map((e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return o[t]=e[0],t})),i.algorithm="none"}const r=await this.http.idServerRequest(w.i.Post,"/lookup",i,w.e.V2,n);if(null==r||!r.mappings)return[];const a=[];for(const e of Object.keys(r.mappings)){const t=r.mappings[e],n=o[e];if(!n)throw new Error("Identity server returned more results than expected");a.push({address:n,mxid:t})}return a}async lookupThreePid(e,t,n){const i=(await this.identityHashedLookup([[t,e]],n)).find((e=>e.address===t));if(!i)return{};return{address:t,medium:e,mxid:i.mxid}}async bulkLookupThreePids(e,t){const n=await this.identityHashedLookup(e.map((e=>[e[1],e[0]])),t),i=[];for(const t of n){const n=e.find((e=>e[1]===t.address));if(!n)throw new Error("Identity sever returned unexpected results");i.push([n[0],t.address,t.mxid])}return{threepids:i}}getIdentityAccount(e){return this.http.idServerRequest(w.i.Get,"/account",void 0,w.e.V2,e)}sendToDevice(e,t,n){const i=m.o("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),s={messages:m.F(t)},o=new Map;for(const[e,n]of t)o.set(e,Array.from(n.keys()));return S.a.log(`PUT ${i}`,o),this.http.authedRequest(w.i.Put,i,void 0,s)}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(w.i.Get,"/thirdparty/protocols").then((e=>{if(!e||"object"!=typeof e)throw new Error(`/thirdparty/protocols did not return an object: ${e}`);return e}))}getThirdpartyLocation(e,t){const n=m.o("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(w.i.Get,n,t)}getThirdpartyUser(e,t){const n=m.o("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(w.i.Get,n,t)}getTerms(e,t){const n=this.termsUrlForService(e,t);return this.http.requestOtherUrl(w.i.Get,n)}agreeToTerms(e,t,n,i){const s=this.termsUrlForService(e,t),o={Authorization:"Bearer "+n};return this.http.requestOtherUrl(w.i.Post,s,{user_accepts:i},{headers:o})}reportEvent(e,t,n,i){const s=m.o("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(w.i.Post,s,void 0,{score:n,reason:i})}getRoomHierarchy(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4?arguments[4]:void 0;const o=m.o("/rooms/$roomId/hierarchy",{$roomId:e}),r={suggested_only:String(i),max_depth:null==n?void 0:n.toString(),from:s,limit:null==t?void 0:t.toString()};return this.http.authedRequest(w.i.Get,o,r,void 0,{prefix:w.a.V1}).catch((e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(w.i.Get,o,r,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e}))}async unstableCreateFileTree(e){const{room_id:t}=await this.createRoom({name:e,preset:M.d.PrivateChat,power_level_content_override:ie(ie({},F.a),{},{users:{[this.getUserId()]:100}}),creation_content:{[N.i]:N.j.Space},initial_state:[{type:N.o.name,state_key:N.r.name,content:{[N.n.name]:!0}},{type:N.b.RoomEncryption,state_key:"",content:{algorithm:f.MEGOLM_ALGORITHM}}]});return new F.b(this,t)}unstableGetFileTreeSpace(e){var t,n;const i=this.getRoom(e);if("join"!==(null==i?void 0:i.getMyMembership()))return null;const s=i.currentState.getStateEvents(N.b.RoomCreate,""),o=i.currentState.getStateEvents(N.o.name,N.r.name);if(!s)throw new Error("Expected single room create event");return null!=o&&null!==(t=o.getContent())&&void 0!==t&&t[N.n.name]?(null===(n=s.getContent())||void 0===n?void 0:n[N.i])!==N.j.Space?null:new F.b(this,e):null}slidingSync(e,t,n){const i={};e.pos&&(i.pos=e.pos,delete e.pos),e.timeout&&(i.timeout=e.timeout,delete e.timeout);const s=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(w.i.Post,"/sync",i,e,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:t,localTimeoutMs:s,abortSignal:n})}supportsExperimentalThreads(){var e;return S.a.warn("supportsExperimentalThreads() is deprecated, use supportThreads() instead"),(null===(e=this.clientOpts)||void 0===e?void 0:e.experimentalThreadSupport)||!1}supportsThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.threadSupport)||!1}async getRoomSummary(e,t){const n=m.o("/rooms/$roomid/summary",{$roomid:e});return this.http.authedRequest(w.i.Get,n,{via:t},void 0,{prefix:"/_matrix/client/unstable/im.nheko.summary"})}processThreadEvents(e,t,n){e.processThreadedEvents(t,n)}processThreadRoots(e,t,n){e.processThreadRoots(t,n)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){null!=t&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}async whoami(){return this.http.authedRequest(w.i.Get,"/account/whoami")}async timestampToEvent(e,t,n){const i=m.o("/rooms/$roomId/timestamp_to_event",{$roomId:e}),s={ts:t.toString(),dir:n};try{return await this.http.authedRequest(w.i.Get,i,s,void 0,{prefix:w.a.V1})}catch(e){if("M_UNRECOGNIZED"===e.errcode&&(400===e.httpStatus||404===e.httpStatus||405===e.httpStatus))return await this.http.authedRequest(w.i.Get,i,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw e}}}function ve(e,t){var n,i;const s=e.getUserId(),o=t.getId(),r=e.getRoom(t.getRoomId());if(!r||!s||!o)return;const a=t.getPushActions(),c=e.getPushActionsForEvent(t,!0),l=!!t.threadRootId&&!t.isThreadRoot,d=r.getUnreadCountForEventContext(P.b.Highlight,t),u=!(null==a||null===(n=a.tweaks)||void 0===n||!n.highlight),h=!(null==c||null===(i=c.tweaks)||void 0===i||!i.highlight);let m;if(l){const e=r.getThread(t.threadRootId);m=!e||e.hasUserReadEvent(s,o)}else m=r.hasUserReadEvent(s,o);if(m)return;if(u!==h||d>0){let e=d;h&&!u&&e++,!h&&u&&e--,l?r.setThreadUnreadNotificationCount(t.threadRootId,P.b.Highlight,e):r.setUnreadNotificationCount(P.b.Highlight,e)}const p=r.getUnreadCountForEventContext(P.b.Total,t);!(null==c||!c.notify)&&(l?r.setThreadUnreadNotificationCount(t.threadRootId,P.b.Total,p+1):r.setUnreadNotificationCount(P.b.Total,p+1))}r()(ge,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")}).call(this,n(14))},,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return M})),n.d(t,"n",(function(){return A})),n.d(t,"p",(function(){return L})),n.d(t,"o",(function(){return F})),n.d(t,"i",(function(){return B})),n.d(t,"j",(function(){return V})),n.d(t,"l",(function(){return K})),n.d(t,"k",(function(){return $})),n.d(t,"q",(function(){return H})),n.d(t,"m",(function(){return W}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(122),c=n.n(a),l=n(120),d=n.n(l),u=n(188),h=n.n(u),m=n(127),p=n.n(m),g=n(439),v=n.n(g),f=n(198),b=n(170),y=n(143),S=n(153),E=n(128),w=n(573);n.d(t,"b",(function(){return w.a}));var _=n(335);n.d(t,"c",(function(){return _.a}));var C=n(788);n.d(t,"d",(function(){return C.a}));var O=n(789);n.d(t,"e",(function(){return O.a}));var I=n(458);n.d(t,"f",(function(){return I.a}));var R=n(790);n.d(t,"g",(function(){return R.a}));var k=n(791);n.d(t,"h",(function(){return k.a}));const x=["top","bottom","left","right","bottomAligned","rightAligned","menuClassName","menuHeight","menuWidth","menuPaddingLeft","menuPaddingRight","menuPaddingBottom","menuPaddingTop","zIndex","children","focusLock","managed","wrapperClassName","chevronFace","chevronOffset"],T=["hasBackground","onFinished"];function j(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function P(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?j(Object(n),!0).forEach((function(t){c()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):j(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const D="mx_ContextualMenu_Container";function N(){let e=document.getElementById(D);return e||(e=document.createElement("div"),e.id=D,document.body.appendChild(e)),e}let M;!function(e){e.Top="top",e.Bottom="bottom",e.Left="left",e.Right="right",e.None="none"}(M||(M={}));class A extends d.a.PureComponent{constructor(t){super(t),c()(this,"initialFocus",void 0),c()(this,"onModalOpen",(()=>{var e,t;null===(e=(t=this.props).onFinished)||void 0===e||e.call(t)})),c()(this,"collectContextMenuRect",(e=>{if(!e)return;const t=e.querySelector('[role^="menuitem"]')||e.querySelector("[tab-index]");t&&t.focus(),this.setState({contextMenuElem:e})})),c()(this,"onContextMenu",(t=>{if(this.props.onFinished){this.props.onFinished(),t.preventDefault(),t.stopPropagation();const n=t.clientX,i=t.clientY;e((()=>{var e;const t=new MouseEvent("contextmenu",{clientX:n,clientY:i,screenX:0,screenY:0,button:0,relatedTarget:null});null===(e=document.elementFromPoint(n,i))||void 0===e||e.dispatchEvent(t)}))}})),c()(this,"onContextMenuPreventBubbling",(e=>{e.stopPropagation()})),c()(this,"onFinished",(e=>{var t,n;e.stopPropagation(),e.preventDefault(),null===(t=(n=this.props).onFinished)||void 0===t||t.call(n)})),c()(this,"onClick",(e=>{var t,n;(e.stopPropagation(),this.props.closeOnInteraction)&&(null===(t=(n=this.props).onFinished)||void 0===t||t.call(n))})),c()(this,"onKeyDown",(e=>{e.stopPropagation();const t=Object(S.a)().getAccessibilityAction(e);this.props.managed?Object(b.g)(e.target)&&t!==y.h.Escape||[y.h.Escape,y.h.Tab,y.h.ArrowLeft,y.h.ArrowRight].includes(t)&&this.props.onFinished():t===y.h.Escape&&this.props.onFinished()})),this.state={},this.initialFocus=document.activeElement}componentDidMount(){E.b.on(E.a.Opened,this.onModalOpen)}componentWillUnmount(){E.b.off(E.a.Opened,this.onModalOpen),this.initialFocus.focus()}renderMenu(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.props.hasBackground;const t={},n=this.props,{top:i,bottom:o,left:a,right:c,bottomAligned:l,rightAligned:u,menuClassName:h,menuHeight:m,menuWidth:g,menuPaddingLeft:y,menuPaddingRight:S,menuPaddingBottom:E,menuPaddingTop:w,zIndex:_,children:C,focusLock:O,managed:I,wrapperClassName:R,chevronFace:k,chevronOffset:j}=n,D=r()(n,x);let N;i?t.top=i:t.bottom=o,a?(t.left=a,N=M.Left):(t.right=c,N=M.Right);const A=this.state.contextMenuElem?this.state.contextMenuElem.getBoundingClientRect():null,L={};k&&(N=k);const U=N&&N!==M.None;N===M.Top||N===M.Bottom?L.left=j:L.top=j;const{windowWidth:F,windowHeight:B}=f.b.instance;if(A){if(void 0!==t.top){let e=B-10;l||(e-=A.height),t.top=Math.min(t.top,e),void 0!==L.top&&(L.top=j+i-t.top)}else void 0!==t.bottom&&(t.bottom=Math.min(t.bottom,B-A.height-10),void 0!==L.top&&(L.top=j+t.bottom-o));if(void 0!==t.left){let e=F-10;u||(e-=A.width),t.left=Math.min(t.left,e),void 0!==L.left&&(L.left=j+a-t.left)}else void 0!==t.right&&(t.right=Math.min(t.right,F-A.width-10),void 0!==L.left&&(L.left=j+t.right-c))}let V;U&&(V=d.a.createElement("div",{style:L,className:"mx_ContextualMenu_chevron_"+N}));const K=p()({mx_ContextualMenu:!0,mx_ContextualMenu_left:!U&&void 0!==t.left&&!t.right,mx_ContextualMenu_right:!U&&void 0!==t.right&&!t.left,mx_ContextualMenu_top:!U&&void 0!==t.top&&!t.bottom,mx_ContextualMenu_bottom:!U&&void 0!==t.bottom&&!t.top,mx_ContextualMenu_withChevron_left:N===M.Left,mx_ContextualMenu_withChevron_right:N===M.Right,mx_ContextualMenu_withChevron_top:N===M.Top,mx_ContextualMenu_withChevron_bottom:N===M.Bottom,mx_ContextualMenu_rightAligned:!0===u,mx_ContextualMenu_bottomAligned:!0===l},h),$={};g&&($.width=g),m&&($.height=m),isNaN(Number(w))||($.paddingTop=w),isNaN(Number(y))||($.paddingLeft=y),isNaN(Number(E))||($.paddingBottom=E),isNaN(Number(S))||($.paddingRight=S);const H={};let W;isNaN(Number(_))||($.zIndex=_+1,H.zIndex=_),e&&(W=d.a.createElement("div",{className:"mx_ContextualMenu_background",style:H,onClick:this.onFinished,onContextMenu:this.onContextMenu}));let q=d.a.createElement(d.a.Fragment,null,V,C);O&&(q=d.a.createElement(v.a,null,q));const{hasBackground:G,onFinished:z}=D,J=r()(D,T);return d.a.createElement(b.d,{handleHomeEnd:!0,handleUpDown:!0,onKeyDown:this.onKeyDown},(e=>{let{onKeyDownHandler:n}=e;return d.a.createElement("div",{className:p()("mx_ContextualMenu_wrapper",R),style:P(P({},t),H),onClick:this.onClick,onKeyDown:n,onContextMenu:this.onContextMenuPreventBubbling},W,d.a.createElement("div",s()({className:K,style:$,ref:this.collectContextMenuRect,role:I?"menu":void 0},J),q))}))}render(){return this.props.mountAsChild?this.renderMenu():h.a.createPortal(this.renderMenu(),N())}}c()(A,"defaultProps",{hasBackground:!0,managed:!0});const L=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12;const n=e.right+window.scrollX+3;let i=e.top+e.height/2+window.scrollY;return i-=t+8,{left:n,top:i,chevronOffset:t}},U=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12;const n=f.b.instance.windowWidth-e.left+window.scrollX-3;let i=e.top+e.height/2+window.scrollY;return i-=t+8,{right:n,top:i,chevronOffset:t}},F=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12;return e.left>f.b.instance.windowWidth-e.right?U(e,t):L(e,t)},B=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:M.None,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i={chevronFace:t},s=e.right+window.scrollX,o=e.bottom+window.scrollY,r=e.top+window.scrollY;return i.right=f.b.instance.windowWidth-s,o<f.b.instance.windowHeight/2?i.top=o+n:i.bottom=f.b.instance.windowHeight-r+n,i},V=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:M.None,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i={chevronFace:t},s=e.left+window.scrollX,o=e.bottom+window.scrollY,r=e.top+window.scrollY;return i.left=s,o<f.b.instance.windowHeight/2?i.top=o+n:i.bottom=f.b.instance.windowHeight-r+n,i},K=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:M.None,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i={chevronFace:t},s=e.right+window.scrollX,o=e.top+window.scrollY;return i.right=f.b.instance.windowWidth-s,i.bottom=f.b.instance.windowHeight-o+n,i},$=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:M.None,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i={chevronFace:t},s=e.left+window.scrollX,o=e.top+window.scrollY;return i.left=s,i.bottom=f.b.instance.windowHeight-o+n,i},H=e=>{let t=Object(l.useRef)(null);e&&(t=e);const[n,i]=Object(l.useState)(!1);return[!!t.current&&n,t,e=>{null==e||e.preventDefault(),null==e||e.stopPropagation(),i(!0)},e=>{null==e||e.preventDefault(),null==e||e.stopPropagation(),i(!1)},i]};function W(e,t){const n=function(){var e;h.a.unmountComponentAtNode(N());for(var n=arguments.length,i=new Array(n),s=0;s<n;s++)i[s]=arguments[s];null==t||null===(e=t.onFinished)||void 0===e||e.apply(null,i)},i=d.a.createElement(A,s()({},t,{mountAsChild:!0,hasBackground:!1,onFinished:n,windowResize:n}),d.a.createElement(e,s()({},t,{onFinished:n})));return h.a.render(i,N()),{close:n}}}).call(this,n(54).setImmediate)},function(e,t,n){"use strict";n.d(t,"b",(function(){return b})),n.d(t,"a",(function(){return y}));var i,s=n(13),o=n.n(s),r=n(186),a=n(1),c=n(16),l=n(130),d=n(144),u=n(161),h=n(159),m=n(362),p=n(290),g=n(207);function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let b;!function(e){e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Finished=2]="Finished"}(i||(i={})),function(e){e.Events="RoomState.events",e.Members="RoomState.members",e.NewMember="RoomState.newMember",e.Update="RoomState.update",e.BeaconLiveness="RoomState.BeaconLiveness",e.Marker="RoomState.Marker"}(b||(b={}));class y extends h.b{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{status:i.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,o()(this,"reEmitter",new p.b(this)),o()(this,"sentinels",{}),o()(this,"displayNameToUserIds",new Map),o()(this,"userIdsToDisplayNames",{}),o()(this,"tokenToInvite",{}),o()(this,"joinedMemberCount",null),o()(this,"summaryJoinedMemberCount",null),o()(this,"invitedMemberCount",null),o()(this,"summaryInvitedMemberCount",null),o()(this,"modified",-1),o()(this,"members",{}),o()(this,"events",new Map),o()(this,"paginationToken",null),o()(this,"beacons",new Map),o()(this,"_liveBeaconIds",[]),this.updateModifiedTime()}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce(((e,t)=>"join"===t.membership?e+1:e),0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce(((e,t)=>"invite"===t.membership?e+1:e),0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter((t=>!e.includes(t.userId)))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(void 0===t){t=new r.a(this.roomId,e);const n=this.members[e];null!=n&&n.events.member&&t.setMembershipEvent(n.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());const n=this.events.get(e).get(t);return n||null}get hasLiveBeacons(){var e;return!(null===(e=this.liveBeaconIds)||void 0===e||!e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){const e=new y(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=i.NotStarted,Array.from(this.events.values()).forEach((t=>{e.setStateEvents(Array.from(t.values()))})),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==i.Finished&&this.getMembers().forEach((t=>{var n;t.isOutOfBand()&&(null===(n=e.getMember(t.userId))||void 0===n||n.markOutOfBand())})),e}setUnknownStateEvents(e){const t=e.filter((e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey())));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach((e=>{if(e.getRoomId()!==this.roomId||!e.isState())return;g.b.matches(e.getType())&&this.setBeacon(e);const t=this.getStateEventMatching(e);var n;(this.setStateEvent(e),e.getType()===l.b.RoomMember)&&(this.updateDisplayNameCache(e.getStateKey(),null!==(n=e.getContent().displayname)&&void 0!==n?n:""),this.updateThirdPartyTokenCache(e));this.emit(b.Events,e,this,t)})),this.onBeaconLivenessChange(),e.forEach((e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===l.b.RoomMember){const t=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),this.updateMember(n),this.emit(b.Members,e,this,n)}else if(e.getType()===l.b.RoomPowerLevels){if(""!==e.getStateKey())return;Object.values(this.members).forEach((t=>{const n=t.getLastModifiedTime();t.setPowerLevelEvent(e),n!==t.getLastModifiedTime()&&this.emit(b.Members,e,this,t)})),this.sentinels={}}else l.m.matches(e.getType())&&this.emit(b.Marker,e,t)})),this.emit(b.Update,this)}processBeaconEvents(e,t){if(!e.length||!this.beacons.size)return;const n=[...this.beacons.values()].reduce(((e,t)=>f(f({},e),{},{[t.beaconInfoId]:t})),{}),i=(e,t)=>{if(!g.a.matches(t.getType()))return;const i=n[e];i&&i.addLocations([t])};e.forEach((e=>{var s;const o=null===(s=e.getRelation())||void 0===s?void 0:s.event_id;o&&n[o]&&(t.decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure()?e.once(d.c.Decrypted,(async()=>{i(o,e)})):i(o,e))}))}getOrCreateMember(e,t){let n=this.members[e];return n||(n=new r.a(this.roomId,e),this.members[e]=n,this.emit(b.NewMember,t,this,n)),n}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){const t=Object(m.c)(e);if(this.beacons.has(t)){const i=this.beacons.get(t);var n;return e.isRedacted()?void(i.beaconInfoId===(null===(n=e.getRedactionEvent())||void 0===n?void 0:n.redacts)&&(i.destroy(),this.beacons.delete(t))):i.update(e)}if(e.isRedacted())return;const i=new m.a(e);this.reEmitter.reEmit(i,[m.b.New,m.b.Update,m.b.Destroy,m.b.LivenessChange]),this.emit(m.b.New,e,i),i.on(m.b.LivenessChange,this.onBeaconLivenessChange.bind(this)),i.on(m.b.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(i.identifier,i)}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter((e=>e.isLive)).map((e=>e.identifier)),this.emit(b.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,n;return null!==(t=null===(n=this.events.get(e.getType()))||void 0===n?void 0:n.get(e.getStateKey()))&&void 0!==t?t:null}updateMember(e){const t=this.getStateEvents(l.b.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===i.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===i.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===i.NotStarted&&(this.oobMemberFlags.status=i.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===i.InProgress&&(this.oobMemberFlags.status=i.NotStarted)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach((t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])})),a.a.log(`LL: RoomState removed ${e} members...`),this.oobMemberFlags.status=i.NotStarted}setOutOfBandMembers(e){a.a.log(`LL: RoomState about to set ${e.length} OOB members ...`),this.oobMemberFlags.status===i.InProgress&&(a.a.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=i.Finished,e.forEach((e=>this.setOutOfBandMember(e))),this.emit(b.Update,this))}setOutOfBandMember(e){if(e.getType()!==l.b.RoomMember)return;const t=e.getStateKey(),n=this.getMember(t);if(n&&!n.isOutOfBand())return;const i=this.getOrCreateMember(t,e);i.setMembershipEvent(e,this),i.markOutOfBand(),this.updateDisplayNameCache(i.userId,i.name),this.setStateEvent(e),this.updateMember(i),this.emit(b.Members,e,this,i)}setTypingEvent(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return null!==(t=this.displayNameToUserIds.get(c.J(e)))&&void 0!==t?t:[]}maySendRedactionForEvent(e,t){const n=this.getMember(t);if(!n||"leave"===n.membership)return!1;if(e.status||e.isRedacted())return!1;const i=this.maySendEvent(l.b.RoomRedaction,t);return e.getSender()===t?i:this.hasSufficientPowerLevelFor("redact",n.powerLevel)}hasSufficientPowerLevelFor(e,t){const n=this.getStateEvents(l.b.RoomPowerLevels,"");let i={};n&&(i=n.getContent());let s=50;return c.v(i[e])&&(s=i[e]),t>=s}maySendMessage(e){return this.maySendEventOfType(l.b.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!(t.isGuest()||!t.credentials.userId)&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,n){const i=this.getStateEvents(l.b.RoomPowerLevels,"");let s,o={},r=0,a=0,c=0;if(i){s=i.getContent(),o=s.events||{},r=Number.isSafeInteger(s.state_default)?s.state_default:50;const e=s.users&&s.users[t];Number.isSafeInteger(e)?c=e:Number.isSafeInteger(s.users_default)&&(c=s.users_default),Number.isSafeInteger(s.events_default)&&(a=s.events_default)}let d=n?r:a;return Number.isSafeInteger(o[e])&&(d=o[e]),c>=d}mayTriggerNotifOfType(e,t){const n=this.getMember(t);if(!n)return!1;const i=this.getStateEvents(l.b.RoomPowerLevels,"");let s=50;return i&&i.getContent()&&i.getContent().notifications&&c.v(i.getContent().notifications[e])&&(s=i.getContent().notifications[e]),n.powerLevel>=s}getJoinRule(){var e;const t=this.getStateEvents(l.b.RoomJoinRules,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).join_rule||u.c.Invite}getHistoryVisibility(){var e;const t=this.getStateEvents(l.b.RoomHistoryVisibility,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).history_visibility||u.b.Shared}getGuestAccess(){var e;const t=this.getStateEvents(l.b.RoomGuestAccess,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).guest_access||u.a.Forbidden}findPredecessor(){if(arguments.length>0&&void 0!==arguments[0]&&arguments[0]){const e=this.getStateEvents(l.b.RoomPredecessor,"");if(e){const t=e.getContent(),n=t.predecessor_room_id;let i=t.last_known_event_id;if("string"!=typeof i&&(i=void 0),"string"==typeof n)return{roomId:n,eventId:i}}}const e=this.getStateEvents(l.b.RoomCreate,"");if(e){const t=e.getContent().predecessor;if(t){const e=t.room_id;if("string"==typeof e){let n=t.event_id;return"string"==typeof n&&""!==n||(n=void 0),{roomId:e,eventId:n}}}}return null}updateThirdPartyTokenCache(e){if(!e.getContent().third_party_invite)return;const t=(e.getContent().third_party_invite.signed||{}).token;if(!t)return;this.getStateEvents(l.b.RoomThirdPartyInvite,t)&&(this.tokenToInvite[t]=e)}updateDisplayNameCache(e,t){const n=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],n){const t=c.J(n),i=this.displayNameToUserIds.get(t);if(i){const n=i.filter((t=>t!==e));this.displayNameToUserIds.set(t,n)}}this.userIdsToDisplayNames[e]=t;const i=t&&c.J(t);if(i){var s;const t=null!==(s=this.displayNameToUserIds.get(i))&&void 0!==s?s:[];t.push(e),this.displayNameToUserIds.set(i,t)}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(122),s=n.n(i),o=n(208),r=n(126),a=n(132),c=n(143),l=n(722);const d=e=>c.b[e].settingNames.reduce(((e,t)=>{var n;const i=null===(n=Object(l.c)()[t])||void 0===n?void 0:n.default;return i&&e.push({action:t,keyCombo:i}),e}),[]),u={getMessageComposerBindings:()=>{const e=d(c.c.COMPOSER);return r.b.getValue("MessageComposerInput.ctrlEnterToSend")?(e.push({action:c.h.SendMessage,keyCombo:{key:o.b.ENTER,ctrlOrCmdKey:!0}}),e.push({action:c.h.NewLine,keyCombo:{key:o.b.ENTER}}),e.push({action:c.h.NewLine,keyCombo:{key:o.b.ENTER,shiftKey:!0}})):(e.push({action:c.h.SendMessage,keyCombo:{key:o.b.ENTER}}),e.push({action:c.h.NewLine,keyCombo:{key:o.b.ENTER,shiftKey:!0}}),o.a&&e.push({action:c.h.NewLine,keyCombo:{key:o.b.ENTER,altKey:!0}})),e},getAutocompleteBindings:()=>{const e=d(c.c.AUTOCOMPLETE);return e.push({action:c.h.ForceCompleteAutocomplete,keyCombo:{key:o.b.TAB}}),e.push({action:c.h.ForceCompleteAutocomplete,keyCombo:{key:o.b.TAB,ctrlKey:!0}}),e.push({action:c.h.CompleteAutocomplete,keyCombo:{key:o.b.ENTER}}),e.push({action:c.h.CompleteAutocomplete,keyCombo:{key:o.b.ENTER,ctrlKey:!0}}),e},getRoomListBindings:()=>d(c.c.ROOM_LIST),getRoomBindings:()=>{const e=d(c.c.ROOM);return r.b.getValue("ctrlFForSearch")&&e.push({action:c.h.SearchInRoom,keyCombo:{key:o.b.F,ctrlOrCmdKey:!0}}),e},getNavigationBindings:()=>d(c.c.NAVIGATION),getAccessibilityBindings:()=>d(c.c.ACCESSIBILITY),getCallBindings:()=>d(c.c.CALLS),getLabsBindings:()=>a.b.get("show_labs_settings")?d(c.c.LABS):[]};function h(e,t,n){var i,s,o,r,a,c,l,d;if(void 0!==t.key)if(e.shiftKey){if(e.key.toLowerCase()!==t.key.toLowerCase())return!1}else if(e.key!==t.key)return!1;const u=null!==(i=t.ctrlKey)&&void 0!==i&&i,h=null!==(s=t.altKey)&&void 0!==s&&s,m=null!==(o=t.shiftKey)&&void 0!==o&&o,p=null!==(r=t.metaKey)&&void 0!==r&&r,g=null!==(a=e.ctrlKey)&&void 0!==a&&a,v=null!==(c=e.altKey)&&void 0!==c&&c,f=null!==(l=e.shiftKey)&&void 0!==l&&l,b=null!==(d=e.metaKey)&&void 0!==d&&d;if(t.ctrlOrCmdKey){if(n){if(!b||g!==u||v!==h||f!==m)return!1}else if(!g||b!==p||v!==h||f!==m)return!1;return!0}return b===p&&g===u&&v===h&&f===m}const m=new class{constructor(){s()(this,"bindingsProviders",[u])}getAction(e,t){for(const n of e){const e=n().find((e=>h(t,e.keyCombo,o.a)));if(e)return e.action}}getMessageComposerAction(e){return this.getAction(this.bindingsProviders.map((e=>e.getMessageComposerBindings)),e)}getAutocompleteAction(e){return this.getAction(this.bindingsProviders.map((e=>e.getAutocompleteBindings)),e)}getRoomListAction(e){return this.getAction(this.bindingsProviders.map((e=>e.getRoomListBindings)),e)}getRoomAction(e){return this.getAction(this.bindingsProviders.map((e=>e.getRoomBindings)),e)}getNavigationAction(e){return this.getAction(this.bindingsProviders.map((e=>e.getNavigationBindings)),e)}getAccessibilityAction(e){return this.getAction(this.bindingsProviders.map((e=>e.getAccessibilityBindings)),e)}getCallAction(e){return this.getAction(this.bindingsProviders.map((e=>e.getCallBindings)),e)}getLabsAction(e){return this.getAction(this.bindingsProviders.map((e=>e.getLabsBindings)),e)}};function p(){return m}},function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i),o=n(17),r=n(1454),a=n.n(r);const c="update";class l extends o.EventEmitter{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this.dispatcher=e,s()(this,"storeState",void 0),s()(this,"lock",new a.a),s()(this,"dispatcherRef",void 0),this.dispatcherRef=e.register(this.onDispatch.bind(this)),this.storeState=t}get state(){return this.storeState}stop(){this.dispatcherRef&&this.dispatcher.unregister(this.dispatcherRef)}async updateState(e){await this.lock.acquireAsync();try{this.storeState=Object.freeze(Object.assign({},this.storeState,e)),this.emit(c,this)}finally{await this.lock.release()}}async reset(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];await this.lock.acquireAsync();try{this.storeState=Object.freeze(e||{}),t||this.emit(c,this)}finally{await this.lock.release()}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return J})),n.d(t,"b",(function(){return Y}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(125),c=n(185),l=n(191),d=n(543);class u{constructor(){s()(this,"password",void 0),s()(this,"passwordTimeoutId",void 0),s()(this,"clearPassword",(()=>{clearTimeout(this.passwordTimeoutId),this.passwordTimeoutId=void 0,this.password=void 0}))}setPassword(e){this.password=e,clearTimeout(this.passwordTimeoutId),this.passwordTimeoutId=setTimeout(this.clearPassword,3e5)}getPassword(){return this.password}}var h=n(126),m=n(132);const p=/[\x21-\x2F\x3A-\x40\x5B-\x60\x7B-\x7E]+/g;class g{constructor(e){this.stores=e,s()(this,"sortNames",new Map),s()(this,"loadedRooms",new Set),s()(this,"collator",void 0)}async loadMemberList(e,t){if(!this.stores.client)return{joined:[],invited:[]};const n=h.b.getValue("language");this.collator=new Intl.Collator(n,{sensitivity:"base",ignorePunctuation:!1});const i=await this.loadMembers(e),s=this.filterMembers(i,t);return s.joined.sort(((e,t)=>this.sortMembers(e,t))),s.invited.sort(((e,t)=>this.sortMembers(e,t))),{joined:s.joined,invited:s.invited}}async loadMembers(e){const t=this.stores.client.getRoom(e);if(!t)return[];if(!this.isLazyLoadingEnabled(e)||this.loadedRooms.has(e))return this.loadMembersInRoom(t);if(this.isLazyMemberStorageEnabled())try{await t.loadMembersIfNeeded()}catch(e){}else{t.currentState.markOutOfBandMembersStarted();const n=(await this.stores.client.members(e,void 0,"leave")).chunk.map(this.stores.client.getEventMapper());t.currentState.setOutOfBandMembers(n)}return this.loadedRooms.add(e),this.loadMembersInRoom(t)}loadMembersInRoom(e){const t=Object.values(e.currentState.members);return t.forEach((e=>{e.user||(e.user=this.stores.client.getUser(e.userId)||void 0)})),t}isLazyLoadingEnabled(e){return h.b.getValue("feature_sliding_sync")?!this.stores.client.isRoomEncrypted(e):this.stores.client.hasLazyLoadMembersEnabled()}isLazyMemberStorageEnabled(){return!h.b.getValue("feature_sliding_sync")&&this.stores.client.hasLazyLoadMembersEnabled()}isPresenceEnabled(){var e;if(!this.stores.client)return!0;const t=m.b.get("enable_presence_by_hs_url");return null===(e=null==t?void 0:t[this.stores.client.baseUrl])||void 0===e||e}filterMembers(e,t){const n={joined:[],invited:[]};return e.forEach((e=>{if("join"===e.membership||"invite"===e.membership){if(t){t=t.toLowerCase();const n=e.name.toLowerCase().includes(t),i=e.userId.toLowerCase().includes(t);if(!n&&!i)return}switch(e.membership){case"join":n.joined.push(e);break;case"invite":n.invited.push(e)}}})),n}sortMembers(e,t){const n=e.user,i=t.user;if(!n&&!i)return 0;if(n&&!i)return-1;if(!n&&i)return 1;const s=this.isPresenceEnabled();if(e.powerLevel!==t.powerLevel)return t.powerLevel-e.powerLevel;if(s){const e=e=>"unavailable"===e?"online":e,t=t=>{const n=["active","online","offline"],i=n.indexOf(e(t));return-1===i?n.length:i},s=t(n.currentlyActive?"active":n.presence),o=t(i.currentlyActive?"active":i.presence);if(s!==o)return s-o}return s&&n.getLastActiveTs()!==i.getLastActiveTs()?i.getLastActiveTs()-n.getLastActiveTs():this.collator.compare(this.canonicalisedName(e.name),this.canonicalisedName(t.name))}canonicalisedName(e){let t=this.sortNames.get(e);return t||(t=("@"===e[0]?e.slice(1):e).replace(p,""),this.sortNames.set(e,t),t)}}var v=n(218),f=n(174),b=n(16),y=n(1),S=n(161),E=n(17),w=n.n(E),_=n(123),C=n(128),O=n(121),I=n(399),R=n(129),k=n(400),x=n(139),T=n(164),j=n(211),P=n(145),D=n(401),N=n(154),M=n(310),A=n(195),L=n(862);function U(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function F(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?U(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):U(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const B={joining:!1,joinError:null,roomId:null,threadId:null,subscribingRoomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:!1,initialEventScrollIntoView:!0,roomAlias:null,roomLoading:!1,roomLoadError:null,replyingToEvent:null,shouldPeek:!1,viaServers:[],wasContextSwitch:!1,viewingCall:!1};class V extends w.a{constructor(e,t){super(),this.stores=t,s()(this,"state",b.k(B)),s()(this,"dis",void 0),s()(this,"dispatchToken",void 0),s()(this,"onCurrentBroadcastRecordingChanged",(e=>{if(null===e){var t;const e=null===(t=this.stores.client)||void 0===t?void 0:t.getRoom(this.state.roomId||void 0);e&&this.doMaybeSetCurrentVoiceBroadcastPlayback(e)}})),this.resetDispatcher(e),this.stores.voiceBroadcastRecordingsStore.addListener(A.y.CurrentChanged,this.onCurrentBroadcastRecordingChanged)}addRoomListener(e,t){this.on(e,t)}removeRoomListener(e,t){this.off(e,t)}emitForRoom(e,t){this.emit(e,t)}setState(e){let t=!1;for(const n of Object.keys(e))if(this.state[n]!==e[n]){t=!0;break}if(!t)return;var n;e.viewingCall&&(null===(n=this.stores.voiceBroadcastPlaybacksStore.getCurrent())||void 0===n||n.pause(),this.stores.voiceBroadcastRecordingsStore.getCurrent()&&(Object(L.a)(),e.viewingCall=!1));const i=this.state.roomId;this.state=Object.assign(this.state,e),i!==this.state.roomId&&(i&&this.emitForRoom(i,!1),this.state.roomId&&this.emitForRoom(this.state.roomId,!0),this.dis.dispatch({action:R.a.ActiveRoomChanged,oldRoomId:i,newRoomId:this.state.roomId})),this.emit(N.b)}doMaybeSetCurrentVoiceBroadcastPlayback(e){Object(A.G)(e,this.stores.client,this.stores.voiceBroadcastPlaybacksStore,this.stores.voiceBroadcastRecordingsStore)}onRoomStateEvents(e){var t,n;const i=null===(t=e.getRoomId)||void 0===t?void 0:t.call(e);if(!i||i!==this.state.roomId)return;const s=null===(n=this.stores.client)||void 0===n?void 0:n.getRoom(i);s&&this.doMaybeSetCurrentVoiceBroadcastPlayback(s)}onDispatch(e){switch(e.action){case R.a.ViewRoom:this.viewRoom(e);break;case R.a.ViewThread:this.viewThread(e);break;case"view_welcome_page":case R.a.ViewHomePage:this.setState({roomId:null,roomAlias:null,viaServers:[],wasContextSwitch:!1,viewingCall:!1}),Object(A.F)(this.stores.voiceBroadcastPlaybacksStore);break;case"MatrixActions.RoomState.events":this.onRoomStateEvents(e.event);break;case R.a.ViewRoomError:this.viewRoomError(e);break;case"will_join":this.setState({joining:!0});break;case"cancel_join":this.setState({joining:!1});break;case R.a.JoinRoom:this.joinRoom(e);break;case R.a.JoinRoomError:this.joinRoomError(e);break;case R.a.JoinRoomReady:this.state.roomId===e.roomId&&this.setState({shouldPeek:!1}),Object(D.a)(_.a.get(),e.roomId).then((t=>{const n=t.getJoinedMemberCount(),i=n>1e3?"MoreThanAThousand":n>100?"OneHundredAndOneToAThousand":n>10?"ElevenToOneHundred":n>2?"ThreeToTen":n>1?"Two":"One";this.stores.posthogAnalytics.trackEvent({eventName:"JoinedRoom",trigger:e.metricsTrigger,roomSize:i,isDM:!!T.a.shared().getUserIdForRoomId(t.roomId),isSpace:t.isSpaceRoom()})}));break;case"on_client_not_viable":case R.a.OnLoggedOut:this.reset();break;case"reply_to_event":x.a.Thread!==e.context&&(e.event&&e.event.getRoomId()!==this.state.roomId?this.dis.dispatch({action:R.a.ViewRoom,room_id:e.event.getRoomId(),replyingToEvent:e.event,metricsTrigger:void 0}):this.setState({replyingToEvent:e.event}))}}async viewRoom(e){if(e.room_id){var t,n,i,s,o,r,a,c,l;const m=_.a.get().getRoom(e.room_id);if(null!==e.metricsTrigger&&e.room_id!==this.state.roomId){let t;if(this.stores.spaceStore.activeSpace===j.a.Home)t="Home";else if(Object(j.h)(this.stores.spaceStore.activeSpace))t="Meta";else{var d;t=(null===(d=this.stores.spaceStore.activeSpaceRoom)||void 0===d?void 0:d.getJoinRule())===S.c.Public?"Public":"Private"}this.stores.posthogAnalytics.trackEvent({eventName:"ViewRoom",trigger:e.metricsTrigger,viaKeyboard:e.metricsViaKeyboard,isDM:!!T.a.shared().getUserIdForRoomId(e.room_id),isSpace:null==m?void 0:m.isSpaceRoom(),activeSpace:t})}var u;if(h.b.getValue("feature_sliding_sync")&&this.state.roomId!==e.room_id)return this.state.subscribingRoomId&&this.state.subscribingRoomId!==e.room_id&&this.stores.slidingSyncManager.setRoomVisible(this.state.subscribingRoomId,!1),this.setState({subscribingRoomId:e.room_id,roomId:e.room_id,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:null,initialEventScrollIntoView:!0,roomAlias:null,roomLoading:!0,roomLoadError:null,viaServers:e.via_servers,wasContextSwitch:e.context_switch,viewingCall:null!==(u=e.view_call)&&void 0!==u&&u}),await this.stores.slidingSyncManager.setRoomVisible(e.room_id,!0),this.state.subscribingRoomId!==e.room_id?void this.stores.slidingSyncManager.setRoomVisible(e.room_id,!1):void this.dis.dispatch(F({},e));const p={roomId:e.room_id,roomAlias:null!==(t=e.room_alias)&&void 0!==t?t:null,initialEventId:null!==(n=e.event_id)&&void 0!==n?n:null,isInitialEventHighlighted:null!==(i=e.highlighted)&&void 0!==i&&i,initialEventScrollIntoView:null===(s=e.scroll_into_view)||void 0===s||s,roomLoading:!1,roomLoadError:null,shouldPeek:void 0===e.should_peek||e.should_peek,joining:e.joining||!1,replyingToEvent:null,viaServers:null!==(o=e.via_servers)&&void 0!==o?o:[],wasContextSwitch:null!==(r=e.context_switch)&&void 0!==r&&r,viewingCall:null!==(a=e.view_call)&&void 0!==a?a:e.room_id===this.state.roomId?this.state.viewingCall:null!==M.a.instance.getActiveCall(e.room_id)};(null===(c=e.replyingToEvent)||void 0===c?void 0:c.getRoomId())===e.room_id?p.replyingToEvent=e.replyingToEvent:(null===(l=this.state.replyingToEvent)||void 0===l?void 0:l.getRoomId())===e.room_id&&(p.replyingToEvent=this.state.replyingToEvent),this.setState(p),e.auto_join&&this.dis.dispatch(F(F({},e),{},{action:R.a.JoinRoom,roomId:e.room_id,metricsTrigger:e.metricsTrigger})),m&&(((e,t)=>{const n=t.getCurrent();n&&"live"!==(null==n?void 0:n.getLiveness())&&(null==n?void 0:n.infoEvent.getRoomId())!==e.roomId&&(t.clearCurrent(),n.pause())})(m,this.stores.voiceBroadcastPlaybacksStore),this.doMaybeSetCurrentVoiceBroadcastPlayback(m))}else if(e.room_alias){let t=Object(I.a)(e.room_alias);if(!t){var m;this.setState({roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:!1,initialEventScrollIntoView:!0,roomAlias:e.room_alias,roomLoading:!0,roomLoadError:null,viaServers:e.via_servers,wasContextSwitch:e.context_switch,viewingCall:null!==(m=e.view_call)&&void 0!==m&&m});try{const n=await _.a.get().getRoomIdForAlias(e.room_alias);Object(I.b)(e.room_alias,n.room_id),t=n.room_id}catch(t){return y.a.error("RVS failed to get room id for alias: ",t),void this.dis.dispatch({action:R.a.ViewRoomError,room_id:null,room_alias:e.room_alias,err:t})}}this.dis.dispatch(F(F({},e),{},{room_id:t}))}}viewThread(e){this.setState({threadId:e.thread_id})}viewRoomError(e){this.setState({roomId:e.room_id,roomAlias:e.room_alias,roomLoading:!1,roomLoadError:e.err})}async joinRoom(e){this.setState({joining:!0});const t=_.a.get(),{roomAlias:n,roomId:i}=this.state,s=n||i,o=this.state.viaServers||[];try{await Object(k.a)((()=>t.joinRoom(s,F({viaServers:o},e.opts||{}))),5,(e=>504===e.httpStatus)),this.dis.dispatch({action:R.a.JoinRoomReady,roomId:i,metricsTrigger:e.metricsTrigger})}catch(e){this.dis.dispatch({action:R.a.JoinRoomError,roomId:i,err:e})}}getInvitingUserId(e){const t=_.a.get(),n=t.getRoom(e);if("invite"===(null==n?void 0:n.getMyMembership())){const e=n.getMember(t.getUserId()),i=e?e.events.member:null;return i&&i.getSender()}}showJoinRoomError(e,t){let n=e.message?e.message:JSON.stringify(e);if(y.a.log("Failed to join room:",n),"ConnectionError"===e.name)n=Object(O.a)("There was an error joining.");else if("M_INCOMPATIBLE_ROOM_VERSION"===e.errcode)n=r.a.createElement("div",null,Object(O.a)("Sorry, your homeserver is too old to participate here."),r.a.createElement("br",null),Object(O.a)("Please contact your homeserver administrator."));else if(404===e.httpStatus){const e=this.getInvitingUserId(t);e&&(n=e.endsWith(`:${_.a.get().getDomain()}`)?Object(O.a)("The person who invited you has already left."):Object(O.a)("The person who invited you has already left, or their server is offline.")),t===this.state.roomId&&0===this.state.viaServers.length&&(n=r.a.createElement("div",null,Object(O.a)("You attempted to join using a room ID without providing a list of servers to join through. Room IDs are internal identifiers and cannot be used to join a room without additional information."),r.a.createElement("br",null),r.a.createElement("br",null),Object(O.a)("If you know a room address, try joining through that instead.")))}C.b.createDialog(P.a,{title:Object(O.a)("Failed to join"),description:n})}joinRoomError(e){this.setState({joining:!1,joinError:e.err}),e.err&&this.showJoinRoomError(e.err,e.roomId)}reset(){this.state=Object.assign({},B)}resetDispatcher(e){this.dispatchToken&&this.dis.unregister(this.dispatchToken),this.dis=e,e&&(this.dispatchToken=this.dis.register(this.onDispatch.bind(this)))}getRoomId(){return this.state.roomId}getThreadId(){return this.state.threadId}getInitialEventId(){return this.state.initialEventId}isInitialEventHighlighted(){return this.state.isInitialEventHighlighted}initialEventScrollIntoView(){return this.state.initialEventScrollIntoView}getRoomAlias(){return this.state.roomAlias}isRoomLoading(){return this.state.roomLoading}getRoomLoadError(){return this.state.roomLoadError}isJoining(){return this.state.joining}getJoinError(){return this.state.joinError}getQuotingEvent(){return this.state.replyingToEvent}shouldPeek(){return this.state.shouldPeek}getWasContextSwitch(){return this.state.wasContextSwitch}isViewingCall(){return this.state.viewingCall}}var K=n(179),$=n(220),H=n(337);class W{constructor(e){this.context=e,s()(this,"typingStates",void 0),this.reset()}reset(){this.typingStates={}}setSelfTyping(e,t,n){var i;if(Object($.a)(e))return;if(!h.b.getValue("sendTypingNotifications"))return;if(h.b.getValue("lowBandwidth"))return;if(t)return;let s=this.typingStates[e];!n&&!s||s&&s.isTyping===n||(s||(s=this.typingStates[e]={isTyping:n,serverTimer:new H.a(3e4),userTimer:new H.a(1e4)}),s.isTyping=n,n&&(s.serverTimer.isRunning()?s.serverTimer.restart():s.serverTimer.restart().finished().then((()=>{const t=this.typingStates[e];t&&(t.isTyping=!1)})),s.userTimer.isRunning()?s.userTimer.restart():s.userTimer.restart().finished().then((()=>{this.setSelfTyping(e,t,!1)}))),null===(i=this.context.client)||void 0===i||i.sendTyping(e,n,3e4))}}var q=n(210),G=n(625),z=n(239);const J=Object(o.createContext)(void 0);J.displayName="SDKContext";class Y{constructor(){s()(this,"client",void 0),s()(this,"_WidgetPermissionStore",void 0),s()(this,"_MemberListStore",void 0),s()(this,"_RightPanelStore",void 0),s()(this,"_RoomNotificationStateStore",void 0),s()(this,"_RoomViewStore",void 0),s()(this,"_WidgetLayoutStore",void 0),s()(this,"_WidgetStore",void 0),s()(this,"_PosthogAnalytics",void 0),s()(this,"_SlidingSyncManager",void 0),s()(this,"_SpaceStore",void 0),s()(this,"_LegacyCallHandler",void 0),s()(this,"_TypingStore",void 0),s()(this,"_VoiceBroadcastRecordingsStore",void 0),s()(this,"_VoiceBroadcastPreRecordingStore",void 0),s()(this,"_VoiceBroadcastPlaybacksStore",void 0),s()(this,"_AccountPasswordStore",void 0)}constructEagerStores(){this._RoomViewStore=this.roomViewStore}get legacyCallHandler(){return this._LegacyCallHandler||(this._LegacyCallHandler=c.b.instance),this._LegacyCallHandler}get rightPanelStore(){return this._RightPanelStore||(this._RightPanelStore=f.a.instance),this._RightPanelStore}get roomNotificationStateStore(){return this._RoomNotificationStateStore||(this._RoomNotificationStateStore=v.a.instance),this._RoomNotificationStateStore}get roomViewStore(){return this._RoomViewStore||(this._RoomViewStore=new V(a.a,this)),this._RoomViewStore}get widgetLayoutStore(){return this._WidgetLayoutStore||(this._WidgetLayoutStore=q.d.instance),this._WidgetLayoutStore}get widgetPermissionStore(){return this._WidgetPermissionStore||(this._WidgetPermissionStore=new G.b(this)),this._WidgetPermissionStore}get widgetStore(){return this._WidgetStore||(this._WidgetStore=z.a.instance),this._WidgetStore}get posthogAnalytics(){return this._PosthogAnalytics||(this._PosthogAnalytics=l.a.instance),this._PosthogAnalytics}get memberListStore(){return this._MemberListStore||(this._MemberListStore=new g(this)),this._MemberListStore}get slidingSyncManager(){return this._SlidingSyncManager||(this._SlidingSyncManager=d.a.instance),this._SlidingSyncManager}get spaceStore(){return this._SpaceStore||(this._SpaceStore=K.a.instance),this._SpaceStore}get typingStore(){return this._TypingStore||(this._TypingStore=new W(this),window.mxTypingStore=this._TypingStore),this._TypingStore}get voiceBroadcastRecordingsStore(){return this._VoiceBroadcastRecordingsStore||(this._VoiceBroadcastRecordingsStore=new A.x),this._VoiceBroadcastRecordingsStore}get voiceBroadcastPreRecordingStore(){return this._VoiceBroadcastPreRecordingStore||(this._VoiceBroadcastPreRecordingStore=new A.q),this._VoiceBroadcastPreRecordingStore}get voiceBroadcastPlaybacksStore(){return this._VoiceBroadcastPlaybacksStore||(this._VoiceBroadcastPlaybacksStore=new A.n(this.voiceBroadcastRecordingsStore)),this._VoiceBroadcastPlaybacksStore}get accountPasswordStore(){return this._AccountPasswordStore||(this._AccountPasswordStore=new u),this._AccountPasswordStore}}s()(Y,"instance",new Y)},function(e,t,n){"use strict";var i=n(122),s=n.n(i),o=n(125),r=n(129);class a{constructor(){s()(this,"platform",null)}get(){return this.platform}set(e){this.platform=e,o.a.dispatch({action:r.a.PlatformSet,platform:e})}}window.mxPlatformPeg||(window.mxPlatformPeg=new a),t.a=window.mxPlatformPeg},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a),l=n(121),d=n(136),u=n(146);class h extends r.a.Component{constructor(){super(...arguments),s()(this,"onOk",(()=>{this.props.onFinished(!0)})),s()(this,"onCancel",(()=>{this.props.onFinished(!1)}))}render(){let e="";return this.props.danger&&(e="danger"),r.a.createElement(d.a,{className:c()("mx_QuestionDialog",this.props.className),onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",headerImage:this.props.headerImage,hasCancel:this.props.hasCancelButton,fixedWidth:this.props.fixedWidth},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description),r.a.createElement(u.a,{primaryButton:this.props.button||Object(l.a)("OK"),primaryButtonClass:e,primaryDisabled:this.props.buttonDisabled,cancelButton:this.props.cancelButton,hasCancel:this.props.hasCancelButton&&!this.props.quitOnly,onPrimaryButtonClick:this.onOk,focus:this.props.focus,onCancel:this.onCancel},this.props.extraButtons))}}s()(h,"defaultProps",{title:"",description:"",extraButtons:null,focus:!0,hasCancelButton:!0,danger:!1,quitOnly:!1})},function(e,t,n){"use strict";let i,s;n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),function(e){e.AdvancedEncryption="UIFeature.advancedEncryption",e.URLPreviews="UIFeature.urlPreviews",e.Widgets="UIFeature.widgets",e.Voip="UIFeature.voip",e.Feedback="UIFeature.feedback",e.Registration="UIFeature.registration",e.PasswordReset="UIFeature.passwordReset",e.Deactivate="UIFeature.deactivate",e.ShareQRCode="UIFeature.shareQrCode",e.ShareSocial="UIFeature.shareSocial",e.IdentityServer="UIFeature.identityServer",e.ThirdPartyID="UIFeature.thirdPartyId",e.AdvancedSettings="UIFeature.advancedSettings",e.RoomHistorySettings="UIFeature.roomHistorySettings",e.TimelineEnableRelativeDates="UIFeature.timelineEnableRelativeDates",e.YoutubeEmbedPlayer="UIFeature.YoutubeEmbedPlayer",e.BulkUnverifiedSessionsReminder="UIFeature.BulkUnverifiedSessionsReminder"}(i||(i={})),function(e){e.InviteUsers="UIComponent.sendInvites",e.CreateRooms="UIComponent.roomCreation",e.CreateSpaces="UIComponent.spaceCreation",e.ExploreRooms="UIComponent.exploreRooms",e.AddIntegrations="UIComponent.addIntegrations"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var i=n(17);let s;!function(e){e.NewListener="newListener",e.RemoveListener="removeListener",e.Error="error"}(s||(s={}));class o extends i.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}eventNames(){return super.eventNames()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c}));var i=n(122),s=n.n(i),o=n(123);class r{constructor(e,t){if(this.prepared=e,s()(this,"client",void 0),this.client=null!=t?t:o.a.get(),!this.client)throw new Error("No possible MatrixClient for media resolution. Please provide one or log in.")}get isEncrypted(){return!!this.prepared.file}get srcMxc(){return this.prepared.mxc}get thumbnailMxc(){var e;return null===(e=this.prepared.thumbnail)||void 0===e?void 0:e.mxc}get hasThumbnail(){return!!this.thumbnailMxc}get srcHttp(){return this.client.mxcUrlToHttp(this.srcMxc)}get thumbnailHttp(){return this.hasThumbnail?this.client.mxcUrlToHttp(this.thumbnailMxc):null}getThumbnailHttp(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"scale";return this.hasThumbnail?(e=Math.floor(e*window.devicePixelRatio),t=Math.floor(t*window.devicePixelRatio),this.client.mxcUrlToHttp(this.thumbnailMxc,e,t,n)):null}getThumbnailOfSourceHttp(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"scale";return e=Math.floor(e*window.devicePixelRatio),t=Math.floor(t*window.devicePixelRatio),this.client.mxcUrlToHttp(this.srcMxc,e,t,n)}getSquareThumbnailHttp(e){return e=Math.floor(e*window.devicePixelRatio),this.hasThumbnail?this.getThumbnailHttp(e,e,"crop"):this.getThumbnailOfSourceHttp(e,e,"crop")}downloadSource(){return fetch(this.srcHttp)}}function a(e,t){return new r(function(e){var t,n,i,s;let o;if(null!=e&&null!==(t=e.info)&&void 0!==t&&t.thumbnail_url?o={mxc:e.info.thumbnail_url,file:e.info.thumbnail_file}:null!=e&&null!==(n=e.info)&&void 0!==n&&null!==(i=n.thumbnail_file)&&void 0!==i&&i.url&&(o={mxc:e.info.thumbnail_file.url,file:e.info.thumbnail_file}),null!=e&&e.url)return{thumbnail:o,mxc:e.url,file:e.file};if(null!=e&&null!==(s=e.file)&&void 0!==s&&s.url)return{thumbnail:o,mxc:e.file.url,file:e.file};throw new Error("Invalid file provided: cannot determine MXC URI. Has it been redacted?")}(e),t)}function c(e,t){return a({url:e},t)}},function(e,t,n){"use strict";let i,s,o,r,a,c;n.d(t,"f",(function(){return i})),n.d(t,"d",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"e",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c})),function(e){e.Public="public",e.Private="private"}(i||(i={})),function(e){e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat"}(s||(s={})),function(e){e.Public="public",e.Invite="invite",e.Private="private",e.Knock="knock",e.Restricted="restricted"}(o||(o={})),function(e){e.RoomMembership="m.room_membership"}(r||(r={})),function(e){e.CanJoin="can_join",e.Forbidden="forbidden"}(a||(a={})),function(e){e.Invited="invited",e.Joined="joined",e.Shared="shared",e.WorldReadable="world_readable"}(c||(c={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return h}));var i=n(122),s=n.n(i),o=n(120),r=n(438),a=n(369),c=n(191);const l={[a.a.LOADING]:"Loading",[a.a.WELCOME]:"Welcome",[a.a.LOGIN]:"Login",[a.a.REGISTER]:"Register",[a.a.USE_CASE_SELECTION]:"UseCaseSelection",[a.a.FORGOT_PASSWORD]:"ForgotPassword",[a.a.COMPLETE_SECURITY]:"CompleteSecurity",[a.a.E2E_SETUP]:"E2ESetup",[a.a.SOFT_LOGOUT]:"SoftLogout"},d={[r.a.HomePage]:"Home",[r.a.RoomView]:"Room",[r.a.UserView]:"User"};class u{constructor(){s()(this,"view",a.a.LOADING),s()(this,"pageType",void 0),s()(this,"override",void 0)}static get instance(){return u.internalInstance||(u.internalInstance=new u),u.internalInstance}trackPageChange(e,t,n){this.view=e,this.pageType=t,this.override||this.trackPage(n)}trackPage(e){const t=this.view===a.a.LOGGED_IN?d[this.pageType]:l[this.view];c.a.instance.trackEvent({eventName:"$pageview",$current_url:t,durationMs:e})}trackOverride(e){e&&(this.override=e,c.a.instance.trackEvent({eventName:"$pageview",$current_url:e}))}clearOverride(e){e===this.override&&(this.override=void 0,this.trackPage())}static trackInteraction(e,t,n){let i;"click"===(null==t?void 0:t.type)?i="Pointer":null!=t&&t.type.startsWith("key")&&(i="Keyboard"),c.a.instance.trackEvent({eventName:"Interaction",interactionType:i,index:n,name:e})}}s()(u,"internalInstance",void 0);class h extends o.PureComponent{componentDidMount(){u.instance.trackOverride(this.props.screenName)}componentDidUpdate(){u.instance.trackOverride(this.props.screenName)}componentWillUnmount(){u.instance.clearOverride(this.props.screenName)}render(){return null}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return g}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(188),c=n.n(a),l=n(127),d=n.n(l),u=n(198),h=n(187);function m(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}let p;!function(e){e[e.Natural=0]="Natural",e[e.Left=1]="Left",e[e.Right=2]="Right",e[e.Top=3]="Top",e[e.Bottom=4]="Bottom",e[e.InnerBottom=5]="InnerBottom",e[e.TopRight=6]="TopRight"}(p||(p={}));class g extends r.a.PureComponent{constructor(e){super(e),s()(this,"parent",null),s()(this,"updatePosition",(()=>{if(!this.props.visible||!this.parent)return;const e=this.parent.getBoundingClientRect(),t=u.b.instance.windowWidth,n=this.props.maxParentWidth?Math.min(e.width,this.props.maxParentWidth):e.width,i=e.top+window.scrollY,s=e.top+window.scrollY+e.height/2,o=t-e.left-window.scrollX,r=e.right+window.scrollX,a=e.left-window.scrollX+n/2,c={};switch(this.props.alignment){case p.Natural:if(e.right>t/2){c.right=o+6,c.top=s,c.transform="translateY(-50%)";break}case p.Right:c.left=r+6,c.top=s,c.transform="translateY(-50%)";break;case p.Left:c.right=o+6,c.top=s,c.transform="translateY(-50%)";break;case p.Top:c.top=i-6,c.transform=`translate(max(10px, min(calc(${a}px - 50%), calc(100vw - 100% - 10px))), -100%)`;break;case p.Bottom:c.top=i+e.height+6,c.transform=`translate(max(10px, min(calc(${a}px - 50%), calc(100vw - 100% - 10px))))`;break;case p.InnerBottom:c.top=i+e.height-50,c.transform=`translate(max(10px, min(calc(${a}px - 50%), calc(100vw - 100% - 10px))))`;break;case p.TopRight:c.top=i-6,c.right=t-e.right-window.scrollX,c.transform="translateY(-100%)"}this.setState(c)})),this.state={},g.container||(g.container=document.createElement("div"),g.container.className="mx_Tooltip_wrapper",document.body.appendChild(g.container))}componentDidMount(){var e,t;window.addEventListener("scroll",this.updatePosition,{passive:!0,capture:!0}),this.parent=null!==(e=null===(t=c.a.findDOMNode(this))||void 0===t?void 0:t.parentNode)&&void 0!==e?e:null,this.updatePosition()}componentDidUpdate(e){Object(h.c)(e,this.props)&&this.updatePosition()}componentWillUnmount(){window.removeEventListener("scroll",this.updatePosition,{capture:!0})}render(){const e=d()("mx_Tooltip",this.props.tooltipClassName,{mx_Tooltip_visible:this.props.visible,mx_Tooltip_invisible:!this.props.visible}),t=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?m(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):m(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},this.state);t.display=this.props.visible?"block":"none";const n=r.a.createElement("div",{role:"tooltip",className:e,style:t},r.a.createElement("div",{className:"mx_Tooltip_chevron"}),this.props.label);return r.a.createElement("div",{className:this.props.className},c.a.createPortal(n,g.container))}}s()(g,"container",void 0),s()(g,"Alignment",p),s()(g,"defaultProps",{visible:!0,alignment:p.Natural})},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(122),s=n.n(i),o=n(150),r=n(149),a=n(1),c=n(130),l=n(123);function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class h{constructor(e){var t,n;this.matrixClient=e,s()(this,"roomToUser",null),s()(this,"userToRooms",null),s()(this,"hasSentOutPatchDirectAccountDataPatch",void 0),s()(this,"mDirectEvent",void 0),s()(this,"onAccountData",(e=>{e.getType()==c.b.Direct&&(this.mDirectEvent=u({},e.getContent()),this.userToRooms=null,this.roomToUser=null)})),this.hasSentOutPatchDirectAccountDataPatch=!1;const i=null!==(t=null===(n=e.getAccountData(c.b.Direct))||void 0===n?void 0:n.getContent())&&void 0!==t?t:{};this.mDirectEvent=u({},i)}static makeShared(){return h.sharedInstance=new h(l.a.get()),h.sharedInstance}static setShared(e){h.sharedInstance=e}static shared(){return h.sharedInstance}start(){this.populateRoomToUser(),this.matrixClient.on(r.b.AccountData,this.onAccountData)}stop(){this.matrixClient.removeListener(r.b.AccountData,this.onAccountData)}patchUpSelfDMs(e){const t=this.matrixClient.getUserId(),n=e[t];if(n){const i=n.map((e=>{const n=this.matrixClient.getRoom(e);if(n){const i=n.guessDMUserId();if(i&&i!==t)return{userId:i,roomId:e}}})).filter((e=>!!e));return!!i.length&&(e[t]=n.filter((e=>!i.some((t=>t.roomId===e)))),i.forEach((t=>{let{userId:n,roomId:i}=t;const s=e[n];s?(s.push(i),e[n]=Object(o.uniq)(s)):e[n]=[i]})),!0)}return!1}getDMRoomsForUserId(e){return this.getUserToRooms()[e]||[]}getDMRoomForIdentifiers(e){let t=this.getDMRoomsForUserId(e[0]);for(let n=1;n<e.length;n++){const i=this.getDMRoomsForUserId(e[n]);t=t.filter((e=>i.includes(e)))}return t.map((e=>l.a.get().getRoom(e))).filter((e=>e&&"join"===e.getMyMembership()))[0]}getUserIdForRoomId(e){if(null==this.roomToUser&&this.populateRoomToUser(),void 0===this.roomToUser[e]){const t=this.matrixClient.getRoom(e);if(t)return t.getDMInviter()}return this.roomToUser[e]}getUniqueRoomsWithIndividuals(){return this.roomToUser?Object.keys(this.roomToUser).map((e=>({userId:this.getUserIdForRoomId(e),room:this.matrixClient.getRoom(e)}))).filter((e=>e.userId&&e.room&&2===e.room.getInvitedAndJoinedMemberCount())).reduce(((e,t)=>(e[t.userId]=t.room)&&e),{}):{}}getRoomIds(){return Object.values(this.mDirectEvent).reduce(((e,t)=>(t.forEach((t=>e.add(t))),e)),new Set)}getUserToRooms(){if(!this.userToRooms){const e=this.mDirectEvent,t=e[this.matrixClient.getUserId()];if(null!=t&&t.length){const t=this.patchUpSelfDMs(e);a.a.warn("Invalid m.direct account data detected (self-chats that shouldn't be), patching it up."),t&&!this.hasSentOutPatchDirectAccountDataPatch&&(this.hasSentOutPatchDirectAccountDataPatch=!0,this.matrixClient.setAccountData(c.b.Direct,e))}this.userToRooms=e}return this.userToRooms}populateRoomToUser(){this.roomToUser={};for(const e of Object.keys(this.getUserToRooms()))for(const t of this.userToRooms[e])this.roomToUser[t]=e}}s()(h,"sharedInstance",void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return O}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(122),c=n.n(a),l=n(120),d=n.n(l),u=n(152),h=n(127),m=n.n(h),p=n(130),g=n(193),v=n(417),f=n(123),b=n(128),y=n(262),S=n(164),E=n(160),w=n(301),_=n(147);const C=["room","oobData","viewAvatarOnClick","onClick","className"];class O extends d.a.Component{constructor(e){super(e),c()(this,"onRoomStateEvents",(e=>{var t;e.getRoomId()===(null===(t=this.props.room)||void 0===t?void 0:t.roomId)&&e.getType()===p.b.RoomAvatar&&this.setState({urls:O.getImageUrls(this.props)})})),c()(this,"onRoomAvatarClick",(()=>{var e,t;const n={src:y.b(null!==(e=this.props.room)&&void 0!==e?e:null,void 0,void 0,void 0),name:null===(t=this.props.room)||void 0===t?void 0:t.name};b.b.createDialog(v.a,n,"mx_Dialog_lightbox",void 0,!0)})),this.state={urls:O.getImageUrls(this.props)}}componentDidMount(){f.a.get().on(u.b.Events,this.onRoomStateEvents)}componentWillUnmount(){var e;null===(e=f.a.get())||void 0===e||e.removeListener(u.b.Events,this.onRoomStateEvents)}static getDerivedStateFromProps(e){return{urls:O.getImageUrls(e)}}static getImageUrls(e){let t=null;return e.oobData.avatarUrl&&(t=Object(E.b)(e.oobData.avatarUrl).getThumbnailOfSourceHttp(e.width,e.height,e.resizeMethod)),Object(_.n)([t,O.getRoomAvatarUrl(e)])}static getRoomAvatarUrl(e){return e.room?y.b(e.room,e.width,e.height,e.resizeMethod):null}get roomIdName(){var e,t;const n=this.props.room;if(n){const e=S.a.shared().getUserIdForRoomId(n.roomId);if(e)return e;if(n instanceof w.b&&1===n.targets.length)return n.targets[0].userId}return(null===(e=this.props.room)||void 0===e?void 0:e.roomId)||(null===(t=this.props.oobData)||void 0===t?void 0:t.roomId)}render(){var e,t,n,i;const o=this.props,{room:a,oobData:c,viewAvatarOnClick:l,onClick:u,className:h}=o,v=r()(o,C),f=null!==(e=null!==(t=null==a?void 0:a.name)&&void 0!==t?t:c.name)&&void 0!==e?e:"?";return d.a.createElement(g.a,s()({},v,{className:m()(h,{mx_RoomAvatar_isSpaceRoom:(null!==(n=null==a?void 0:a.getType())&&void 0!==n?n:null===(i=this.props.oobData)||void 0===i?void 0:i.roomType)===p.j.Space}),name:f,idName:this.roomIdName,urls:this.state.urls,onClick:l&&this.state.urls[0]?this.onRoomAvatarClick:u}))}}c()(O,"defaultProps",{width:36,height:36,resizeMethod:"crop",oobData:{}})},function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"g",(function(){return l})),n.d(t,"c",(function(){return d})),n.d(t,"h",(function(){return u})),n.d(t,"m",(function(){return h})),n.d(t,"l",(function(){return m})),n.d(t,"n",(function(){return p})),n.d(t,"o",(function(){return f})),n.d(t,"d",(function(){return b})),n.d(t,"e",(function(){return y})),n.d(t,"f",(function(){return S})),n.d(t,"k",(function(){return E})),n.d(t,"b",(function(){return O})),n.d(t,"j",(function(){return I})),n.d(t,"i",(function(){return R}));var i=n(121);function s(){return[Object(i.a)("Sun"),Object(i.a)("Mon"),Object(i.a)("Tue"),Object(i.a)("Wed"),Object(i.a)("Thu"),Object(i.a)("Fri"),Object(i.a)("Sat")]}function o(){return[Object(i.a)("Jan"),Object(i.a)("Feb"),Object(i.a)("Mar"),Object(i.a)("Apr"),Object(i.a)("May"),Object(i.a)("Jun"),Object(i.a)("Jul"),Object(i.a)("Aug"),Object(i.a)("Sep"),Object(i.a)("Oct"),Object(i.a)("Nov"),Object(i.a)("Dec")]}function r(e){return(e<10?"0":"")+e}function a(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e.getHours()%12;const s=r(e.getMinutes()),o=e.getHours()>=12?Object(i.a)("PM"):Object(i.a)("AM");if(n=n||12,t){return`${n}:${s}:${r(e.getSeconds())}${o}`}return`${n}:${s}${o}`}function c(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=new Date,r=s(),a=o();return e.toDateString()===n.toDateString()?h(e,t):n.getTime()-e.getTime()<5184e5?Object(i.a)("%(weekDayName)s %(time)s",{weekDayName:r[e.getDay()],time:h(e,t)}):n.getFullYear()===e.getFullYear()?Object(i.a)("%(weekDayName)s, %(monthName)s %(day)s %(time)s",{weekDayName:r[e.getDay()],monthName:a[e.getMonth()],day:e.getDate(),time:h(e,t)}):d(e,t)}function l(e){const t=s(),n=o();return Object(i.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s",{weekDayName:t[e.getDay()],monthName:n[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear()})}function d(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const r=s(),a=o();return Object(i.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s %(time)s",{weekDayName:r[e.getDay()],monthName:a[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear(),time:n?u(e,t):h(e,t)})}function u(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1]?a(e,!0):r(e.getHours())+":"+r(e.getMinutes())+":"+r(e.getSeconds())}function h(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1]?a(e):r(e.getHours())+":"+r(e.getMinutes())}function m(e){const t=e<0;e=Math.abs(e);const n=Math.floor(e/3600).toFixed(0).padStart(2,"0");let i="";return"00"!==n&&(i+=`${n}:`),i+=`${Math.floor(e%3600/60).toFixed(0).padStart(2,"0")}:${Math.floor(e%3600%60).toFixed(0).padStart(2,"0")}`,t&&(i="-"+i),i}function p(e){const t=Math.floor(e/3600).toFixed(0),n=Math.floor(e%3600/60).toFixed(0),s=Math.floor(e%3600%60).toFixed(0);return"0"!==t?Object(i.a)("%(hours)sh %(minutes)sm %(seconds)ss left",{hours:t,minutes:n,seconds:s}):"0"!==n?Object(i.a)("%(minutes)sm %(seconds)ss left",{minutes:n,seconds:s}):Object(i.a)("%(seconds)ss left",{seconds:s})}const g=864e5;function v(e,t){return Math.abs(e.getTime()-t.getTime())<=g}function f(e,t){return!(!t||!e)&&(!v(e,t)||e.getDay()!==t.getDay())}function b(e){return Object(i.a)("%(date)s at %(time)s",{date:e.toLocaleDateString().replace(/\//g,"-"),time:e.toLocaleTimeString().replace(/:/g,"-")})}function y(e){return e.toISOString()}function S(e){return e.getFullYear()+"/"+r(e.getMonth()+1)+"/"+r(e.getDate())}function E(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=new Date(Date.now());if(v(e,n))return h(e,t);{let t=`${o()[e.getMonth()]} ${e.getDate()}`;return i=n,e.getFullYear()!==i.getFullYear()&&(t+=`, ${e.getFullYear()}`),t}var i}const w=6e4,_=60*w,C=24*_;function O(e){return e>=C?Object(i.a)("%(value)sd",{value:Math.round(e/C)}):e>=_?Object(i.a)("%(value)sh",{value:Math.round(e/_)}):e>=w?Object(i.a)("%(value)sm",{value:Math.round(e/w)}):Object(i.a)("%(value)ss",{value:Math.round(e/1e3)})}function I(e){const t=Math.floor(e/C),n=Math.floor(e%C/_),s=Math.floor(e%_/w),o=Math.floor(e%w/1e3);return t>0?Object(i.a)("%(days)sd %(hours)sh %(minutes)sm %(seconds)ss",{days:t,hours:n,minutes:s,seconds:o}):n>0?Object(i.a)("%(hours)sh %(minutes)sm %(seconds)ss",{hours:n,minutes:s,seconds:o}):s>0?Object(i.a)("%(minutes)sm %(seconds)ss",{minutes:s,seconds:o}):Object(i.a)("%(value)ss",{value:o})}const R=e=>new Intl.DateTimeFormat(void 0,{day:"2-digit",month:"2-digit",year:"2-digit"}).format(e)},function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return r}));var i=n(120),s=n(126);const o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const[o,r]=Object(i.useState)(s.b.getValue(e,t,n));return Object(i.useEffect)((()=>{const i=s.b.watchSetting(e,t,(()=>{r(s.b.getValue(e,t,n))}));return()=>{s.b.unwatchSetting(i)}}),[e,t,n]),o},r=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const[n,o]=Object(i.useState)(s.b.getValue(e,t));return Object(i.useEffect)((()=>{const n=s.b.watchSetting(e,t,(()=>{o(s.b.getValue(e,t))}));return()=>{s.b.unwatchSetting(n)}}),[e,t]),n}},function(e,t,n){"use strict";n.d(t,"a",(function(){return _})),n.d(t,"g",(function(){return C})),n.d(t,"i",(function(){return O})),n.d(t,"h",(function(){return I})),n.d(t,"f",(function(){return R})),n.d(t,"k",(function(){return k})),n.d(t,"l",(function(){return x})),n.d(t,"d",(function(){return T})),n.d(t,"j",(function(){return P})),n.d(t,"e",(function(){return D})),n.d(t,"c",(function(){return N})),n.d(t,"b",(function(){return L}));var i=n(122),s=n.n(i),o=n(1144),r=n.n(o),a=n(16),c=n(1),l=n(152),d=n(130),u=n(123);class h{forEvent(e,t){throw new Error("Not implemented")}forRoom(e){throw new Error("Not implemented")}forUser(e){throw new Error("Not implemented")}forEntity(e){throw new Error("Not implemented")}isPermalinkHost(e){throw new Error("Not implemented")}parsePermalink(e){throw new Error("Not implemented")}}class m{constructor(e,t,n,i){this.roomIdOrAlias=e,this.eventId=t,this.userId=n,this.viaServers=i}static forUser(e){return new m(null,null,e,null)}static forRoom(e){return new m(e,null,null,arguments.length>1&&void 0!==arguments[1]?arguments[1]:[])}static forEvent(e,t){return new m(e,t,null,arguments.length>2&&void 0!==arguments[2]?arguments[2]:[])}get primaryEntityId(){return this.roomIdOrAlias||this.userId}get sigil(){var e;return(null===(e=this.primaryEntityId)||void 0===e?void 0:e[0])||"?"}}const p="matrix.to",g=`https://${p}`,v=`^(?:https?://)?${p.replace(".","\\.")}/#/(.*)`;class f extends h{constructor(){super()}forEvent(e,t,n){return`${g}/#/${e}/${t}${this.encodeServerCandidates(n)}`}forRoom(e,t){return`${g}/#/${e}${this.encodeServerCandidates(t)}`}forUser(e){return`${g}/#/${e}`}forEntity(e){return`${g}/#/${e}`}isPermalinkHost(e){return e===p}encodeServerCandidates(e){return e&&0!==e.length?`?via=${e.map((e=>encodeURIComponent(e))).join("&via=")}`:""}parsePermalink(e){if(!e)throw new Error("Does not appear to be a permalink");const t=[...e.matchAll(new RegExp(v,"gi"))][0];if(!t||t.length<2)throw new Error("Does not appear to be a permalink");const n=t[1].split("/"),i=n[0];if("@"===i[0])return m.forUser(i);if("#"===i[0]||"!"===i[0]){if(1===n.length){const[e,t=""]=i.split("?"),n=t.split(/&?via=/g).filter((e=>!!e));return m.forRoom(e,n)}const e=n.length>1?n.slice(1).join("/"):"",[t,s=""]=e.split("?"),o=s.split(/&?via=/g).filter((e=>!!e));return m.forEvent(i,t,o)}throw new Error("Unknown entity type in permalink")}}class b extends h{constructor(e){if(super(),s()(this,"elementUrl",void 0),this.elementUrl=e,!this.elementUrl.startsWith("http:")&&!this.elementUrl.startsWith("https:"))throw new Error("Element prefix URL does not appear to be an HTTP(S) URL")}forEvent(e,t,n){return`${this.elementUrl}/#/room/${e}/${t}${this.encodeServerCandidates(n)}`}forRoom(e,t){return`${this.elementUrl}/#/room/${e}${this.encodeServerCandidates(t)}`}forUser(e){return`${this.elementUrl}/#/user/${e}`}forEntity(e){if("!"===e[0]||"#"===e[0])return this.forRoom(e);if("@"===e[0])return this.forUser(e);throw new Error("Unrecognized entity")}isPermalinkHost(e){const t=new URL(this.elementUrl);return e===(t.host||t.hostname)}encodeServerCandidates(e){return e&&0!==e.length?`?via=${e.map((e=>encodeURIComponent(e))).join("&via=")}`:""}parsePermalink(e){if(!e||!e.startsWith(this.elementUrl))throw new Error("Does not appear to be a permalink");const t=e.substring(`${this.elementUrl}/#/`.length);return b.parseAppRoute(t)}static parseAppRoute(e){const t=e.split("/");if(t.length<2)throw new Error("URL is missing parts");const[n]=t.splice(-1,1),[i,s=""]=n.split("?");t.push(i);const o=t[0],r=t[1];if("user"===o)return m.forUser(r);if("room"===o){const e=t.length>2?t.slice(2).join("/"):"",n=s.split(/&?via=/).filter((e=>!!e));return m.forEvent(r,e,n)}throw new Error("Unknown entity type in permalink")}}var y=n(132),S=n(374);class E extends h{constructor(){super()}encodeEntity(e){if("!"===e[0])return`roomid/${e.slice(1)}`;if("#"===e[0])return`r/${e.slice(1)}`;if("@"===e[0])return`u/${e.slice(1)}`;if("$"===e[0])return`e/${e.slice(1)}`;throw new Error("Cannot encode entity: "+e)}forEvent(e,t,n){return`matrix:${this.encodeEntity(e)}/${this.encodeEntity(t)}${this.encodeServerCandidates(n)}`}forRoom(e,t){return`matrix:${this.encodeEntity(e)}${this.encodeServerCandidates(t)}`}forUser(e){return`matrix:${this.encodeEntity(e)}`}forEntity(e){return`matrix:${this.encodeEntity(e)}`}isPermalinkHost(e){return""===e}encodeServerCandidates(e){return e&&0!==e.length?`?via=${e.map((e=>encodeURIComponent(e))).join("&via=")}`:""}parsePermalink(e){if(!e||!e.startsWith("matrix:"))throw new Error("Does not appear to be a permalink");const t=e.substring("matrix:".length).split("/"),n=t[0],i=t[1];if("u"===n)return m.forUser(`@${i}`);if("r"===n||"roomid"===n){const e="r"===n?"#":"!";if(2===t.length){const[t,n=""]=i.split("?"),s=n.split(/&?via=/g).filter((e=>!!e));return m.forRoom(`${e}${t}`,s)}if("e"===t[2]){const n=t.length>3?t.slice(3).join("/"):"",[s,o=""]=n.split("?"),r=o.split(/&?via=/g).filter((e=>!!e));return m.forEvent(`${e}${i}`,`$${s}`,r)}throw new Error("Faulty room permalink")}throw new Error("Unknown entity type in permalink")}}const w=/.*/;class _{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.room=e,s()(this,"roomId",void 0),s()(this,"highestPlUserId",null),s()(this,"populationMap",null),s()(this,"bannedHostsRegexps",null),s()(this,"allowedHostsRegexps",null),s()(this,"_serverCandidates",void 0),s()(this,"started",!1),s()(this,"onRoomStateUpdate",(()=>{this.fullUpdate()})),s()(this,"updateServerCandidates",(()=>{const e=new Set;this.highestPlUserId&&e.add(D(this.highestPlUserId));const t=Object.keys(this.populationMap).sort(((e,t)=>this.populationMap[t]-this.populationMap[e]));for(let i=0;i<t.length&&e.size<3;i++){var n;const s=t[i],o=null!==(n=N(s))&&void 0!==n?n:"";e.has(s)||A(o)||M(o,this.bannedHostsRegexps)||!M(o,this.allowedHostsRegexps)||e.add(s)}this._serverCandidates=[...e]})),this.roomId=e?e.roomId:t,!this.roomId)throw new Error("Failed to resolve a roomId for the permalink creator to use")}load(){this.room&&this.room.currentState?this.fullUpdate():c.a.warn("Tried to load a permalink creator with no room state")}start(){this.load(),this.room.currentState.on(l.b.Update,this.onRoomStateUpdate),this.started=!0}stop(){this.room.currentState.removeListener(l.b.Update,this.onRoomStateUpdate),this.started=!1}get serverCandidates(){return this._serverCandidates}isStarted(){return this.started}forEvent(e){return j().forEvent(this.roomId,e,this._serverCandidates)}forShareableRoom(){if(this.room){const e=this.room.getCanonicalAlias();if(e)return j().forRoom(e)}return j().forRoom(this.roomId,this._serverCandidates)}forRoom(){return j().forRoom(this.roomId,this._serverCandidates)}fullUpdate(){this.updateAllowedServers(),this.updateHighestPlUser(),this.updatePopulationMap(),this.updateServerCandidates()}updateHighestPlUser(){const e=this.room.currentState.getStateEvents("m.room.power_levels","");if(e){const t=e.getContent();if(t){const e=t.users;if(e){const t=Object.entries(e).filter((e=>{var t;let[n]=e;const i=this.room.getMember(n);if(!i||"join"!==i.membership)return!1;const s=D(n),o=null!==(t=N(s))&&void 0!==t?t:s;return!A(o)&&!M(o,this.bannedHostsRegexps)&&M(o,this.allowedHostsRegexps)})),n=t.reduce(((e,t)=>t[1]>e[1]?t:e),[null,0]),[i,s]=n;if(null!==i&&s>=50)return void(this.highestPlUserId=i)}}}this.highestPlUserId=null}updateAllowedServers(){const e=[];let t=[w];if(this.room.currentState){const n=this.room.currentState.getStateEvents(d.b.RoomServerAcl,"");if(n&&n.getContent()){const i=e=>new RegExp("^"+a.r(e,!1)+"$");(n.getContent().deny||[]).forEach((t=>e.push(i(t))));const s=n.getContent().allow||[];t=[],s.forEach((e=>t.push(i(e))))}}this.bannedHostsRegexps=e,this.allowedHostsRegexps=t}updatePopulationMap(){const e={};for(const t of this.room.getJoinedMembers()){const n=D(t.userId);e[n]||(e[n]=0),e[n]++}this.populationMap=e}}function C(e){return j().forEntity(e)}function O(e){return j().forUser(e)}function I(e){if(!e)throw new Error("can't permalink a falsy roomId");if("!"!==e[0])return j().forRoom(e,[]);const t=u.a.get().getRoom(e);if(!t)return j().forRoom(e,[]);const n=new _(t);return n.load(),n.forShareableRoom()}function R(e){return!!(new f).isPermalinkHost(e)||j().isPermalinkHost(e)}function k(e){if(!e)return null;if("#"===e[0]||"!"===e[0])return I(e);if("@"===e[0])return O(e);if("matrix:"===e.slice(0,7))try{const t=P(e);if(t){if(t.roomIdOrAlias){const e=t.eventId?`/${t.eventId}`:"";let n=g+`/#/${t.roomIdOrAlias}${e}`;return t.viaServers.length>0&&(n+=(new f).encodeServerCandidates(t.viaServers)),n}if(t.userId)return g+`/#/${t.userId}`}}catch{}return e}function x(e){if(!(e.startsWith("http:")||e.startsWith("https:")||e.startsWith("matrix:")||e.startsWith("vector:")))return e;try{const t=decodeURIComponent(e).match(S.a);if(t)return t[1]}catch(t){return e}try{const t=P(e);if(t)if(t.roomIdOrAlias){const n=t.eventId?`/${t.eventId}`:"";e=`#/room/${t.roomIdOrAlias}${n}`,t.viaServers.length>0&&(e+=(new f).encodeServerCandidates(t.viaServers))}else t.userId&&(e=`#/user/${t.userId}`)}catch(e){}return e}function T(e){try{let t=P(e);if(!t){const n=e.match(S.a);if(n){const e=new b("http://localhost"),i=n[1].split("#").slice(1).join("#");t=e.parsePermalink(`http://localhost/#${i}`)}}if(!t)return null;if(t.userId)return t.userId;if(t.roomIdOrAlias)return t.roomIdOrAlias}catch(e){}return null}function j(){const e=y.b.get("permalink_prefix");return e&&e!==g?new b(e):new f}function P(e){try{const t=y.b.get("permalink_prefix"),n=decodeURIComponent(e);if(new RegExp(v,"i").test(n))return(new f).parsePermalink(n);if(e.startsWith("matrix:"))return(new E).parsePermalink(e);if(t&&e.startsWith(t))return new b(t).parsePermalink(e)}catch(e){c.a.error("Failed to parse permalink",e)}return null}function D(e){return e.split(":").splice(1).join(":")}function N(e){if(!e)return null;try{return new URL(`https://${e}`).hostname}catch(e){return console.error("Error encountered while extracting hostname from server name",e),null}}function M(e,t){if(!e)return!0;if(t.length>0&&!t[0].test)throw new Error(t[0].toString());return t.some((t=>t.test(e)))}function A(e){return!!e&&(e.startsWith("[")&&e.endsWith("]")&&(e=e.substring(1,e.length-1)),r()(e))}const L=e=>{const t=new _(e);return t.load(),t.serverCandidates}},,function(e,t,n){"use strict";n.d(t,"g",(function(){return w})),n.d(t,"c",(function(){return _})),n.d(t,"f",(function(){return C})),n.d(t,"h",(function(){return I})),n.d(t,"d",(function(){return R})),n.d(t,"i",(function(){return k})),n.d(t,"e",(function(){return l})),n.d(t,"a",(function(){return v})),n.d(t,"b",(function(){return y}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(153),c=n(143);const l=e=>{let{children:t,inputRef:n}=e;const[i,s,o]=k(n);return t({onFocus:i,isActive:s,ref:o})};var d=n(131),u=n.n(d),h=n(134),m=n.n(h),p=n(124);const g=["inputRef","onFocus"],v=e=>{let{inputRef:t,onFocus:n}=e,i=m()(e,g);const[s,o,a]=k(t);return r.a.createElement(p.a,u()({},i,{onFocus:e=>{s(),null==n||n(e)},inputRef:a,tabIndex:o?0:-1}))};var f=n(148);const b=["inputRef","onFocus"],y=e=>{let{inputRef:t,onFocus:n}=e,i=m()(e,b);const[s,o,a]=k(t);return r.a.createElement(f.a,u()({},i,{onFocus:e=>{s(),null==n||n(e)},inputRef:a,tabIndex:o?0:-1}))};function S(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?S(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):S(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function w(e){return e.matches('input:not([type="radio"]):not([type="checkbox"]), textarea, select, [contenteditable=true]')}const _=Object(o.createContext)({state:{refs:[]},dispatch:()=>{}});let C;_.displayName="RovingTabIndexContext",function(e){e.Register="REGISTER",e.Unregister="UNREGISTER",e.SetFocus="SET_FOCUS"}(C||(C={}));const O=(e,t)=>{switch(t.type){case C.Register:return e.activeRef||(e.activeRef=t.payload.ref),e.refs.push(t.payload.ref),e.refs.sort(((e,t)=>{if(e===t)return 0;const n=e.current.compareDocumentPosition(t.current);return n&Node.DOCUMENT_POSITION_FOLLOWING||n&Node.DOCUMENT_POSITION_CONTAINED_BY?-1:n&Node.DOCUMENT_POSITION_PRECEDING||n&Node.DOCUMENT_POSITION_CONTAINS?1:0})),E({},e);case C.Unregister:{const s=e.refs.findIndex((e=>e===t.payload.ref));if(-1===s)return e;var n,i;if(e.refs.splice(s,1)[0]===e.activeRef)if(s>=e.refs.length?e.activeRef=I(e.refs,e.refs.length-1,!0):e.activeRef=I(e.refs,s)||I(e.refs,s,!0),document.activeElement===document.body)null===(n=e.activeRef)||void 0===n||null===(i=n.current)||void 0===i||i.focus();return E({},e)}case C.SetFocus:return e.activeRef===t.payload.ref?e:(e.activeRef=t.payload.ref,E({},e));default:return e}},I=function(e,t){if(arguments.length>2&&void 0!==arguments[2]&&arguments[2])for(let i=t;i<e.length&&i>=0;i--){var n;if(null!==(null===(n=e[i].current)||void 0===n?void 0:n.offsetParent))return e[i]}else for(let n=t;n<e.length&&n>=0;n++){var i;if(null!==(null===(i=e[n].current)||void 0===i?void 0:i.offsetParent))return e[n]}},R=e=>{let{children:t,handleHomeEnd:n,handleUpDown:i,handleLeftRight:s,onKeyDown:l}=e;const[d,u]=Object(o.useReducer)(O,{refs:[]}),h=Object(o.useMemo)((()=>({state:d,dispatch:u})),[d]),m=Object(o.useCallback)((e=>{if(l&&(l(e,h.state),e.defaultPrevented))return;let t=!1;const o=Object(a.a)().getAccessibilityAction(e);let r;if(w(e.target)){if(o===c.h.Tab)if(t=!0,h.state.refs.length>0){const t=h.state.refs.indexOf(h.state.activeRef);r=I(h.state.refs,t+(e.shiftKey?-1:1),e.shiftKey)}}else switch(o){case c.h.Home:n&&(t=!0,r=I(h.state.refs,0));break;case c.h.End:n&&(t=!0,r=I(h.state.refs,h.state.refs.length-1,!0));break;case c.h.ArrowDown:case c.h.ArrowRight:if((o===c.h.ArrowDown&&i||o===c.h.ArrowRight&&s)&&(t=!0,h.state.refs.length>0)){const e=h.state.refs.indexOf(h.state.activeRef);r=I(h.state.refs,e+1)}break;case c.h.ArrowUp:case c.h.ArrowLeft:if((o===c.h.ArrowUp&&i||o===c.h.ArrowLeft&&s)&&(t=!0,h.state.refs.length>0)){const e=h.state.refs.indexOf(h.state.activeRef);r=I(h.state.refs,e-1,!0)}}var d;(t&&(e.preventDefault(),e.stopPropagation()),r)&&(null===(d=r.current)||void 0===d||d.focus(),u({type:C.SetFocus,payload:{ref:r}}))}),[h,l,n,i,s]);return r.a.createElement(_.Provider,{value:h},t({onKeyDownHandler:m}))},k=e=>{const t=Object(o.useContext)(_);let n=Object(o.useRef)(null);e&&(n=e),Object(o.useLayoutEffect)((()=>(t.dispatch({type:C.Register,payload:{ref:n}}),()=>{t.dispatch({type:C.Unregister,payload:{ref:n}})})),[]);return[Object(o.useCallback)((()=>{t.dispatch({type:C.SetFocus,payload:{ref:n}})}),[]),t.state.activeRef===n,n]}},function(e,t,n){"use strict";n.d(t,"f",(function(){return b})),n.d(t,"c",(function(){return y})),n.d(t,"h",(function(){return S})),n.d(t,"e",(function(){return E})),n.d(t,"b",(function(){return w})),n.d(t,"a",(function(){return _})),n.d(t,"d",(function(){return C})),n.d(t,"g",(function(){return O})),n.d(t,"i",(function(){return I}));var i=n(13),s=n.n(i),o=n(149),r=n(290),a=n(130),c=n(144),l=n(180),d=n(360),u=n(141),h=n(15),m=n(1),p=n(700),g=n(18);function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let b,y;function S(e,t){return e?y.Stable:t?y.Experimental:y.None}!function(e){e.New="Thread.new",e.Update="Thread.update",e.NewReply="Thread.newReply",e.ViewThread="Thread.viewThread",e.Delete="Thread.delete"}(b||(b={})),function(e){e[e.None=0]="None",e[e.Experimental=1]="Experimental",e[e.Stable=2]="Stable"}(y||(y={}));class E extends p.a{constructor(e,t,n){var i;if(super(),this.id=e,this.rootEvent=t,s()(this,"timelineSet",void 0),s()(this,"timeline",[]),s()(this,"_currentUserParticipated",!1),s()(this,"reEmitter",void 0),s()(this,"lastEvent",void 0),s()(this,"replyCount",0),s()(this,"lastPendingEvent",void 0),s()(this,"pendingReplyCount",0),s()(this,"room",void 0),s()(this,"client",void 0),s()(this,"pendingEventOrdering",void 0),s()(this,"initialEventsFetched",!E.hasServerSideSupport),s()(this,"replayEvents",[]),s()(this,"onBeforeRedaction",((e,t)=>{null!=e&&e.isRelation(C.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(b.Update,this))})),s()(this,"onRedaction",(async e=>{if(e.threadRootId===this.id)if(this.replyCount<=0){for(const e of this.timeline)this.clearEventMetadata(e);this.lastEvent=this.rootEvent,this._currentUserParticipated=!1,this.emit(b.Delete,this)}else await this.updateThreadMetadata()})),s()(this,"onTimelineEvent",((e,t,n)=>{n||t.addLocalEchoReceipt(e.getSender(),e,g.b.Read),this.onEcho(e,null!=n&&n)})),s()(this,"onLocalEcho",(e=>{this.onEcho(e,!1)})),s()(this,"onEcho",(async(e,t)=>{e.threadRootId===this.id&&this.lastEvent!==e&&(await this.updateThreadMetadata(),e.isRelation(C.name)&&(t||this.emit(b.NewReply,this,e)))})),null==n||!n.room)throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.pendingEventOrdering=null!==(i=n.pendingEventOrdering)&&void 0!==i?i:o.e.Chronological,this.timelineSet=new d.b(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new r.b(this),this.reEmitter.reEmit(this.timelineSet,[u.d.Timeline,u.d.TimelineReset]),this.room.on(c.c.BeforeRedaction,this.onBeforeRedaction),this.room.on(u.d.Redaction,this.onRedaction),this.room.on(u.d.LocalEchoUpdated,this.onLocalEcho),this.timelineSet.on(u.d.Timeline,this.onTimelineEvent),this.processReceipts(n.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}async fetchRootEvent(){this.rootEvent=this.room.findEventById(this.id);try{const e=await this.client.fetchRoomEvent(this.roomId,this.id),t=this.client.getEventMapper();this.rootEvent=t(e)}catch(e){m.a.error("Failed to fetch thread root to construct thread with",e)}await this.processEvent(this.rootEvent)}static setServerSideSupport(e){E.hasServerSideSupport=e,e!==y.Stable&&(w.setPreferUnstable(!0),_.setPreferUnstable(!0),C.setPreferUnstable(!0))}static setServerSideListSupport(e){E.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){E.hasServerSideFwdPaginationSupport=e}get roomState(){return this.room.getLiveTimeline().getState(l.b.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||(this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState}),this.timeline=this.events)}addEvents(e,t){e.forEach((e=>this.addEvent(e,t,!1))),this.updateThreadMetadata()}async addEvent(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.setEventMetadata(e);const i=this.lastReply(),s=!i||e.localTimestamp>=i.localTimestamp;if(E.hasServerSideSupport){if(!t&&this.initialEventsFetched&&s)this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e);else if(e.isRelation(a.h.Annotation)||e.isRelation(a.h.Replace)){var o,r,c;if(this.initialEventsFetched)this.addEventToTimeline(e,t);else null===(c=this.replayEvents)||void 0===c||c.push(e);return null===(o=this.timelineSet.relations)||void 0===o||o.aggregateParentEvent(e),void(null===(r=this.timelineSet.relations)||void 0===r||r.aggregateChildEvent(e,this.timelineSet))}}else this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e,{});E.hasServerSideSupport&&this.rootEvent||!e.isRelation(C.name)||this.replyCount++,n&&(this.emit(b.NewReply,this,e),this.updateThreadMetadata())}async processEvent(e){e&&(this.setEventMetadata(e),await this.fetchEditsWhereNeeded(e)),this.timeline=this.events}processReceipts(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(const{eventId:t,receiptType:n,userId:i,receipt:s,synthetic:o}of e)this.addReceiptToStructure(t,n,i,s,o)}getRootEventBundledRelationship(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.rootEvent;return null==e?void 0:e.getServerAggregatedRelation(C.name)}async processRootEvent(){const e=this.getRootEventBundledRelationship();if(E.hasServerSideSupport&&e){this.replyCount=e.count,this._currentUserParticipated=!!e.current_user_participated;const t=this.client.getEventMapper();this.lastEvent=t(f(f({},e.latest_event),{},{room_id:this.roomId})),this.updatePendingReplyCount(),await this.processEvent(this.lastEvent)}}updatePendingReplyCount(){const e=(this.pendingEventOrdering===o.e.Detached?this.room.getPendingEvents():this.events).filter((e=>{var t;return e.threadRootId===this.id&&e.isRelation(C.name)&&null!==e.status&&e.getId()!==(null===(t=this.lastEvent)||void 0===t?void 0:t.getId())}));this.lastPendingEvent=e.length?e[e.length-1]:void 0,this.pendingReplyCount=e.length}async resetLiveTimeline(e,t){const n=this.liveTimeline;this.timelineSet.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);const i=this.liveTimeline;let s,o;if(e){s=(await this.client.createMessagesRequest(this.roomId,e,1,l.a.Forward)).end}if(t){o=(await this.client.createMessagesRequest(this.roomId,t,1,l.a.Backward)).start}var r,a;t&&n.getPaginationToken(l.a.Forward)===t&&n.setPaginationToken(null!==(r=o)&&void 0!==r?r:null,l.a.Forward);e&&i.getPaginationToken(l.a.Backward)===e&&i.setPaginationToken(null!==(a=s)&&void 0!==a?a:null,l.a.Backward)}async updateThreadMetadata(){if(this.updatePendingReplyCount(),E.hasServerSideSupport&&(this.initialEventsFetched||await this.processRootEvent(),await this.fetchRootEvent()),await this.processRootEvent(),!this.initialEventsFetched){this.initialEventsFetched=!0;try{0===this.replyCount&&this.rootEvent?(this.timelineSet.addEventsToTimeline([this.rootEvent],!0,this.liveTimeline,null),this.liveTimeline.setPaginationToken(null,l.a.Backward)):await this.client.paginateEventTimeline(this.liveTimeline,{backwards:!0,limit:Math.max(1,this.length)});for(const e of this.replayEvents)this.addEvent(e,!1);this.replayEvents=null,this.emit(u.d.TimelineReset,this.room,this.timelineSet,!0)}catch(e){m.a.error("Failed to load start of newly created thread: ",e),this.initialEventsFetched=!1}}this.emit(b.Update,this)}async fetchEditsWhereNeeded(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Promise.all(t.filter((e=>e.isEncrypted())).map((e=>{if(!e.isRelation())return this.client.relations(this.roomId,e.getId(),a.h.Replace,e.getType(),{limit:1}).then((t=>{t.events.length&&e.makeReplaced(t.events[0])})).catch((e=>{m.a.error("Failed to load edits for encrypted thread event",e)}))})))}setEventMetadata(e){e&&(l.b.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){var t,n,i;e&&(e.setThread(void 0),null===(t=e.event)||void 0===t||(null===(n=t.unsigned)||void 0===n||(null===(i=n["m.relations"])||void 0===i||delete i[C.name])))}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:()=>!0;for(let t=this.timeline.length-1;t>=0;t--){const n=this.timeline[t];if(e(n))return n}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return null!==(e=null!==(t=this.lastPendingEvent)&&void 0!==t?t:this.lastEvent)&&void 0!==e?e:this.lastReply()}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof c.b}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){const n=e===this.client.getUserId(),i=this.timeline[this.timeline.length-1];if(n&&i){const e=i.getTs()<this.room.getOldestThreadedReceiptTs(),t=i.getId();if(e&&t)return t}const s=super.getEventReadUpTo(e,t);if(i){const t=this.room.getLastUnthreadedReceiptFor(e);if(!t)return s;for(let e=(null===(o=this.timeline)||void 0===o?void 0:o.length)-1;e>=0;--e){var o,r;const n=this.timeline[e];if(n.getId()===s)return s;if(n.getTs()<t.ts)return null!==(r=n.getId())&&void 0!==r?r:s}}return s}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var n,i,s,o,r,a;const t=(null!==(n=null===(i=this.lastReply())||void 0===i?void 0:i.getTs())&&void 0!==n?n:0)<this.room.getOldestThreadedReceiptTs(),c=null!==(s=null===(o=this.room.getLastUnthreadedReceiptFor(e))||void 0===o?void 0:o.ts)&&void 0!==s?s:0,l=(null!==(r=null==this||null===(a=this.lastReply())||void 0===a?void 0:a.getTs())&&void 0!==r?r:0)<c;if(t||l)return!0}return super.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}}s()(E,"hasServerSideSupport",y.None),s()(E,"hasServerSideListSupport",y.None),s()(E,"hasServerSideFwdPaginationSupport",y.None);const w=new h.b("related_by_senders","io.element.relation_senders"),_=new h.b("related_by_rel_types","io.element.relation_types"),C=new h.b("m.thread","io.element.thread");let O;function I(e){return e===O.My?"participated":"all"}!function(e){e[e.My=0]="My",e[e.All=1]="All"}(O||(O={}))},,function(e,t,n){"use strict";n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return b}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(125),d=n(129),u=n(193),h=n(160),m=n(384),p=n(263),g=n(793);const v=["width","height","resizeMethod","viewUserOnClick","forceHistorical","fallbackUserId","hideTitle","member"];function f(e){var t,n;let{width:i,height:o,resizeMethod:f="crop",viewUserOnClick:b,forceHistorical:y,fallbackUserId:S,hideTitle:E,member:w}=e,_=r()(e,v);const C=Object(a.useContext)(m.a),O=Object(g.a)({userId:null==w?void 0:w.userId,member:w,forceHistorical:y}),I=null!==(t=null==O?void 0:O.name)&&void 0!==t?t:S;let R,k=_.title;if(null!=O&&O.name){var x,T,j,P;if(O.getMxcAvatarUrl())R=Object(h.b)(null!==(x=O.getMxcAvatarUrl())&&void 0!==x?x:"").getThumbnailOfSourceHttp(i,o,f);if(!k)k=null!==(T=p.a.getDisplayUserIdentifier(null!==(j=null==O?void 0:O.userId)&&void 0!==j?j:"",{roomId:null!==(P=null==O?void 0:O.roomId)&&void 0!==P?P:""}))&&void 0!==T?T:S}return c.a.createElement(u.a,s()({},_,{width:i,height:o,resizeMethod:f,name:null!=I?I:"",title:E?void 0:k,idName:null!==(n=null==O?void 0:O.userId)&&void 0!==n?n:S,url:R,onClick:b?()=>{l.a.dispatch({action:d.a.ViewUser,member:w,push:C.isCard})}:_.onClick}))}class b extends c.a.Component{render(){return c.a.createElement(f,this.props,this.props.children)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i=n(122),s=n.n(i),o=n(1),r=n(175),a=n(125),c=n(987),l=n(126),d=n(184),u=n(138),h=n(154),m=n(590);function p(e){if(!e)return e;const t=[...e.history].map((e=>function(e){var t,n,i,s,o;const r=null!==(t=e.state)&&void 0!==t?t:{};return{state:{widgetId:r.widgetId,spaceId:r.spaceId,isInitialEventHighlighted:r.isInitialEventHighlighted,initialEventScrollIntoView:r.initialEventScrollIntoView,threadHeadEventId:null!=r&&null!==(n=r.threadHeadEvent)&&void 0!==n&&n.getId()?r.threadHeadEvent.getId():void 0,memberInfoEventId:null!=r&&null!==(i=r.memberInfoEvent)&&void 0!==i&&i.getId()?r.memberInfoEvent.getId():void 0,initialEventId:null!=r&&null!==(s=r.initialEvent)&&void 0!==s&&s.getId()?r.initialEvent.getId():void 0,memberId:null!=r&&null!==(o=r.member)&&void 0!==o&&o.userId?r.member.userId:void 0},phase:e.phase}}(e)));return{isOpen:e.isOpen,history:t}}function g(e,t){if(!e)return e;const n=[...e.history].map((e=>function(e,t){var n;const i=null!==(n=e.state)&&void 0!==n?n:{},s={widgetId:i.widgetId,spaceId:i.spaceId,isInitialEventHighlighted:i.isInitialEventHighlighted,initialEventScrollIntoView:i.initialEventScrollIntoView,threadHeadEvent:null!=i&&i.threadHeadEventId?t.findEventById(i.threadHeadEventId):void 0,memberInfoEvent:null!=i&&i.memberInfoEventId?t.findEventById(i.memberInfoEventId):void 0,initialEvent:null!=i&&i.initialEventId?t.findEventById(i.initialEventId):void 0,member:!(null==i||!i.memberId)&&t.getMember(i.memberId)||void 0};return{state:s,phase:e.phase}}(e,t)));return{history:n,isOpen:e.isOpen}}var v=n(129),f=n(155);class b extends m.a{constructor(){super(a.a),s()(this,"global",void 0),s()(this,"byRoom",void 0),s()(this,"viewedRoomId",void 0),s()(this,"onVerificationRequestUpdate",(()=>{var e;if(null===(e=this.currentCard)||void 0===e||!e.state)return;const{member:t}=this.currentCard.state;if(!t)return;const n=Object(c.b)(t);n&&(this.currentCard.state.verificationRequest=n,this.emitAndUpdateSettings())})),this.reset()}reset(){this.global=void 0,this.byRoom={},this.viewedRoomId=null}async onReady(){var e;this.viewedRoomId=f.b.instance.roomViewStore.getRoomId(),null===(e=this.matrixClient)||void 0===e||e.on(r.b.VerificationRequest,this.onVerificationRequestUpdate),this.loadCacheFromSettings(),this.emitAndUpdateSettings()}async onNotReady(){var e;null===(e=this.matrixClient)||void 0===e||e.off(r.b.VerificationRequest,this.onVerificationRequestUpdate)}onDispatcherAction(e){if(e.action!==v.a.ActiveRoomChanged)return;const t=e;this.handleViewedRoomChange(t.oldRoomId,t.newRoomId)}get isOpen(){var e,t;return null!==(e=null===(t=this.byRoom[this.viewedRoomId])||void 0===t?void 0:t.isOpen)&&void 0!==e&&e}isOpenForRoom(e){var t,n;return null!==(t=null===(n=this.byRoom[e])||void 0===n?void 0:n.isOpen)&&void 0!==t&&t}get roomPhaseHistory(){var e,t;return null!==(e=null===(t=this.byRoom[this.viewedRoomId])||void 0===t?void 0:t.history)&&void 0!==e?e:[]}get currentCard(){const e=this.roomPhaseHistory;return e.length>=1?e[e.length-1]:{state:{},phase:null}}currentCardForRoom(e){var t,n;const i=null!==(t=null===(n=this.byRoom[e])||void 0===n?void 0:n.history)&&void 0!==t?t:[];return i.length>0?i[i.length-1]:{state:{},phase:null}}get previousCard(){const e=this.roomPhaseHistory;return(null==e?void 0:e.length)>=2?e[e.length-2]:{state:{},phase:null}}setCard(e){var t,n,i,s,o;let r=arguments.length>2?arguments[2]:void 0;const a=null!=r?r:this.viewedRoomId,c=this.getVerificationRedirect(e),l=null!==(t=null==c?void 0:c.phase)&&void 0!==t?t:e.phase,d=null!==(n=null==c?void 0:c.state)&&void 0!==n?n:0===Object.keys(null!==(i=e.state)&&void 0!==i?i:{}).length?null:e.state;if(this.isPhaseValid(l,Boolean(a)))if(l===(null===(s=this.currentCardForRoom(a))||void 0===s?void 0:s.phase)&&d){var u,h;const e=null!==(u=null===(h=this.byRoom[a])||void 0===h?void 0:h.history)&&void 0!==u?u:[];e[e.length-1].state=d,this.emitAndUpdateSettings()}else if(l===(null===(o=this.currentCardForRoom(a))||void 0===o?void 0:o.phase)&&this.byRoom[a])this.show(a),this.emitAndUpdateSettings();else{const e=[{phase:l,state:null!=d?d:{}}];this.byRoom[a]={history:e,isOpen:!0},this.emitAndUpdateSettings()}}setCards(e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const n=null!=t?t:this.viewedRoomId,i=e.map((e=>{var t;return{phase:e.phase,state:null!==(t=e.state)&&void 0!==t?t:{}}}));this.byRoom[n]={history:i,isOpen:!0},this.show(n),this.emitAndUpdateSettings()}pushCard(e){var t,n,i;let s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r=null!=o?o:this.viewedRoomId,a=this.getVerificationRedirect(e),c=null!==(t=null==a?void 0:a.phase)&&void 0!==t?t:e.phase,l=null!==(n=null!==(i=null==a?void 0:a.state)&&void 0!==i?i:e.state)&&void 0!==n?n:{};if(!this.isPhaseValid(c,Boolean(r)))return;const d=this.byRoom[r];d?(d.history.push({state:l,phase:c}),d.isOpen=!s||d.isOpen):this.byRoom[r]={history:[{phase:c,state:l}],isOpen:!s},this.show(r),this.emitAndUpdateSettings()}popCard(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const t=null!=e?e:this.viewedRoomId;if(!this.byRoom[t])return;const n=this.byRoom[t].history.pop();return this.emitAndUpdateSettings(),n}togglePanel(e){const t=null!=e?e:this.viewedRoomId;this.byRoom[t]&&(this.byRoom[t].isOpen=!this.byRoom[t].isOpen,this.emitAndUpdateSettings())}show(e){this.isOpenForRoom(null!=e?e:this.viewedRoomId)||this.togglePanel(e)}hide(e){this.isOpenForRoom(null!=e?e:this.viewedRoomId)&&this.togglePanel(e)}loadCacheFromSettings(){if(this.viewedRoomId){var e;const i=null===(e=this.mxClient)||void 0===e?void 0:e.getRoom(this.viewedRoomId);var t,n;if(i)this.global=null!==(t=this.global)&&void 0!==t?t:g(l.b.getValue("RightPanel.phasesGlobal"),i),this.byRoom[this.viewedRoomId]=null!==(n=this.byRoom[this.viewedRoomId])&&void 0!==n?n:g(l.b.getValue("RightPanel.phases",this.viewedRoomId),i);else o.a.warn("Could not restore the right panel after load because there was no associated room object.")}}emitAndUpdateSettings(){this.filterValidCards(this.global);const e=p(this.global);if(l.b.setValue("RightPanel.phasesGlobal",null,u.a.DEVICE,e),this.viewedRoomId){const e=this.byRoom[this.viewedRoomId];this.filterValidCards(e);const t=p(e);l.b.setValue("RightPanel.phases",this.viewedRoomId,u.a.ROOM_DEVICE,t)}this.emit(h.b,null)}filterValidCards(e){null!=e&&e.history&&(e.history=e.history.filter((e=>this.isCardStateValid(e))),e.history.length||(e.isOpen=!1))}isCardStateValid(e){switch(e.phase){case d.a.ThreadView:return e.state.threadHeadEvent||o.a.warn("removed card from right panel because of missing threadHeadEvent in card state"),!!e.state.threadHeadEvent;case d.a.RoomMemberInfo:case d.a.SpaceMemberInfo:case d.a.EncryptionPanel:return e.state.member||o.a.warn("removed card from right panel because of missing member in card state"),!!e.state.member;case d.a.Room3pidMemberInfo:case d.a.Space3pidMemberInfo:return e.state.memberInfoEvent||o.a.warn("removed card from right panel because of missing memberInfoEvent in card state"),!!e.state.memberInfoEvent;case d.a.Widget:return e.state.widgetId||o.a.warn("removed card from right panel because of missing widgetId in card state"),!!e.state.widgetId}return!0}getVerificationRedirect(e){if(e.phase===d.a.RoomMemberInfo&&e.state){const{member:t}=e.state,n=Object(c.b)(t);if(n)return{phase:d.a.EncryptionPanel,state:{verificationRequest:n,member:t}}}return null}isPhaseValid(e,t){return e&&d.a[e]?!!t||(o.a.warn(`Tried to switch right panel to a room phase: ${e}, but we are currently not viewing a room`),!1):(o.a.warn(`Tried to switch right panel to unknown phase: ${e}`),!1)}handleViewedRoomChange(e,t){var n,i;if(this.mxClient){if(this.viewedRoomId=t,this.loadCacheFromSettings(),(null===(n=this.currentCard)||void 0===n?void 0:n.phase)!==d.a.EncryptionPanel){const e=this.byRoom[this.viewedRoomId];null!=e&&e.history&&(e.history=e.history.filter((e=>e.phase!=d.a.RoomMemberInfo&&e.phase!=d.a.Room3pidMemberInfo)))}if(l.b.getValue("feature_right_panel_default_open")&&(null===(i=this.byRoom[this.viewedRoomId])||void 0===i||!i.isOpen)){var s;const e=[{phase:d.a.RoomMemberList}],t=this.viewedRoomId?null===(s=this.mxClient)||void 0===s?void 0:s.getRoom(this.viewedRoomId):void 0;null!=t&&t.isSpaceRoom()||e.unshift({phase:d.a.RoomSummary}),this.byRoom[this.viewedRoomId]={isOpen:!0,history:e}}this.emitAndUpdateSettings()}}static get instance(){return this.internalInstance||(this.internalInstance=new b,this.internalInstance.start()),this.internalInstance}}s()(b,"internalInstance",void 0),window.mxRightPanelStore=b.instance},function(e,t,n){"use strict";(function(e,i){n.d(t,"e",(function(){return H})),n.d(t,"d",(function(){return W})),n.d(t,"b",(function(){return q})),n.d(t,"a",(function(){return G})),n.d(t,"c",(function(){return z}));var s=n(13),o=n.n(s),r=n(426),a=n.n(r),c=n(366),l=n(130),d=n(290),u=n(1),h=n(524),m=n(200),p=n(1043),g=n(365),v=n(691),f=n(367),b=n(1045),y=n(1046),S=n(707),E=n(227),w=n(429),_=n(525),C=n(431),O=n(432),I=n(243),R=n(1049),k=n(1050),x=n(1051),T=n(291),j=n(327),P=n(709),D=n(710),N=n(141),M=n(186),A=n(144),L=n(149),U=n(159),F=n(152),B=n(16);function V(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const K=g.a.DeviceVerification,$={[w.c.NAME]:w.c,[_.a.NAME]:_.a,[w.e]:x.a,[w.d]:x.a},H={RECIPROCATE_QR_CODE:w.c.NAME,SAS:_.a.NAME};function W(){return Boolean(e.Olm)}let q;!function(e){e.DeviceVerificationChanged="deviceVerificationChanged",e.UserTrustStatusChanged="userTrustStatusChanged",e.UserCrossSigningUpdated="userCrossSigningUpdated",e.RoomKeyRequest="crypto.roomKeyRequest",e.RoomKeyRequestCancellation="crypto.roomKeyRequestCancellation",e.KeyBackupStatus="crypto.keyBackupStatus",e.KeyBackupFailed="crypto.keyBackupFailed",e.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",e.KeySignatureUploadFailure="crypto.keySignatureUploadFailure",e.VerificationRequest="crypto.verification.request",e.Warning="crypto.warning",e.WillUpdateDevices="crypto.willUpdateDevices",e.DevicesUpdated="crypto.devicesUpdated",e.KeysChanged="crossSigning.keysChanged"}(q||(q={}));class G extends U.b{static getOlmVersion(){return h.a.getOlmVersion()}constructor(e,t,n,i,s,r,a){var c;if(super(),c=this,this.baseApis=e,this.userId=t,this.deviceId=n,this.clientStore=i,this.cryptoStore=s,this.roomList=r,o()(this,"backupManager",void 0),o()(this,"crossSigningInfo",void 0),o()(this,"olmDevice",void 0),o()(this,"deviceList",void 0),o()(this,"dehydrationManager",void 0),o()(this,"secretStorage",void 0),o()(this,"reEmitter",void 0),o()(this,"verificationMethods",void 0),o()(this,"supportedAlgorithms",void 0),o()(this,"outgoingRoomKeyRequestManager",void 0),o()(this,"toDeviceVerificationRequests",void 0),o()(this,"inRoomVerificationRequests",void 0),o()(this,"trustCrossSignedDevices",!0),o()(this,"lastOneTimeKeyCheck",null),o()(this,"oneTimeKeyCheckInProgress",!1),o()(this,"roomEncryptors",new Map),o()(this,"roomDecryptors",new Map),o()(this,"deviceKeys",{}),o()(this,"globalBlacklistUnverifiedDevices",!1),o()(this,"globalErrorOnUnknownDevices",!0),o()(this,"receivedRoomKeyRequests",[]),o()(this,"receivedRoomKeyRequestCancellations",[]),o()(this,"processingRoomKeyRequests",!1),o()(this,"lazyLoadMembers",!1),o()(this,"roomDeviceTrackingState",{}),o()(this,"lastNewSessionForced",new B.b((()=>new B.b((()=>0))))),o()(this,"sendKeyRequestsImmediately",!1),o()(this,"oneTimeKeyCount",void 0),o()(this,"needsNewFallback",void 0),o()(this,"fallbackCleanup",void 0),o()(this,"onDeviceListUserCrossSigningUpdated",(async e=>{if(e===this.userId){const t=this.deviceList.getStoredCrossSigningForUser(e),n=t?t.getId():null,i=this.crossSigningInfo.getId();i&&n&&!(i!==n)?await this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit(q.KeysChanged,{}),this.emit(q.UserTrustStatusChanged,this.userId,this.checkUserTrust(e)))}else{await this.checkDeviceVerifications(e);const t=this.deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit(q.UserTrustStatusChanged,e,this.checkUserTrust(e))}})),o()(this,"onMembership",((e,t,n)=>{try{this.onRoomMembership(e,t,n)}catch(e){u.a.error("Error handling membership change:",e)}})),o()(this,"onToDeviceEvent",(e=>{try{u.a.log(`received to-device ${e.getType()} from: ${e.getSender()} id: ${e.getContent()[l.k]}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this.onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this.onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this.secretStorage.onRequestReceived(e):"m.secret.send"===e.getType()?this.secretStorage.onSecretReceived(e):"m.room_key.withheld"===e.getType()?this.onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this.onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this.onToDeviceBadEncrypted(e):(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&(e.isBeingDecrypted()||e.attemptDecryption(this),e.once(A.c.Decrypted,(e=>{this.onToDeviceEvent(e)})))}catch(e){u.a.error("Error handling toDeviceEvent:",e)}})),o()(this,"onTimelineEvent",(function(e,t,n,i){let{liveEvent:s=!0}=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(!R.a.validateEvent(e,c.baseApis))return;c.handleVerificationEvent(e,c.inRoomVerificationRequests,(e=>{const t=new R.a(c.baseApis,e.getRoomId());return new I.k(t,c.verificationMethods,c.baseApis)}),s)})),this.reEmitter=new d.b(this),a){this.verificationMethods=new Map;for(const e of a)"string"==typeof e?$[e]&&this.verificationMethods.set(e,$[e]):e.NAME?this.verificationMethods.set(e.NAME,e):u.a.warn(`Excluding unknown verification method ${e}`)}else this.verificationMethods=new Map(Object.entries($));this.backupManager=new D.a(e,(async()=>{const e=await this.getSessionBackupPrivateKey();if(e)return e;const t=await this.getSecret("m.megolm_backup.v1");if(t){const e=z(t);if(e){const t=await this.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",e,[t[0]])}return m.decodeBase64(e||t)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return this.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")})),this.olmDevice=new h.a(s),this.deviceList=new p.a(e,s,this.olmDevice),this.deviceList.on(q.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[q.DevicesUpdated,q.WillUpdateDevices]),this.supportedAlgorithms=Array.from(v.a.keys()),this.outgoingRoomKeyRequestManager=new S.a(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new k.b,this.inRoomVerificationRequests=new R.b;const g=this.baseApis.cryptoCallbacks||{},b=Object(f.d)(s,this.olmDevice);this.crossSigningInfo=new f.a(t,g,b),this.secretStorage=new y.b(e,g,e),this.dehydrationManager=new P.b(this),!g.getCrossSigningKey&&g.getSecretStorageKey&&(g.getCrossSigningKey=async e=>f.a.getFromSecretStorage(e,this.secretStorage))}async init(){let{exportedOlmDevice:t,pickleKey:n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};u.a.log("Crypto: initialising Olm..."),await e.Olm.init(),u.a.log(t?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this.olmDevice.init({fromExportedDevice:t,pickleKey:n}),u.a.log("Crypto: loading device list..."),await this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,u.a.log("Crypto: fetching own devices...");let i=this.deviceList.getRawStoredDevicesForUser(this.userId);if(i||(i={}),!i[this.deviceId]){u.a.log("Crypto: adding this device to the store...");const e={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:K.VERIFIED,known:!0};i[this.deviceId]=e,this.deviceList.storeDevicesForUser(this.userId,i),this.deviceList.saveIfDirty()}await this.cryptoStore.doTxn("readonly",[E.a.STORE_ACCOUNT],(e=>{this.cryptoStore.getCrossSigningKeys(e,(e=>{e&&0!==Object.keys(e).length&&(u.a.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(e))}))})),this.deviceList.startTrackingDeviceList(this.userId),u.a.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setCryptoTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(const e of this.deviceList.getKnownUserIds()){const t=this.deviceList.getRawStoredDevicesForUser(e);for(const n of Object.keys(t)){const t=this.checkDeviceTrust(e,n);if(!t.isLocallyVerified()&&t.isCrossSigningVerified()){const t=this.deviceList.getStoredDevice(e,n);this.emit(q.DeviceVerificationChanged,e,n,t)}}}}async createRecoveryKeyFromPassphrase(t){const n=new e.Olm.PkDecryption;try{const e={};if(t){const i=await Object(C.c)(t);e.passphrase={algorithm:"m.pbkdf2",iterations:i.iterations,salt:i.salt},e.pubkey=n.init_with_private_key(i.key)}else e.pubkey=n.generate_key();const i=n.get_private_key();return{keyInfo:e,encodedPrivateKey:Object(O.b)(i),privateKey:i}}finally{null==n||n.free()}}async userHasCrossSigningKeys(){return await this.downloadKeys([this.userId]),null!==this.deviceList.getStoredCrossSigningForUser(this.userId)}async isCrossSigningReady(){const e=this.crossSigningInfo.getId(),t=await this.crossSigningInfo.isStoredInKeyCache()||await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage);return!(!e||!t)}async isSecretStorageReady(){const e=await this.secretStorage.hasKey(),t=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),n=!this.backupManager.getKeyBackupEnabled()||await this.baseApis.isKeyBackupKeyStored();return!!(e&&t&&n)}async bootstrapCrossSigning(){let{authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};u.a.log("Bootstrapping cross-signing");const n=this.baseApis.cryptoCallbacks,i=new b.a(this.baseApis.store.accountData,n),s=new f.a(this.userId,i.crossSigningCallbacks,i.crossSigningCallbacks),o=async()=>{s.resetKeys(),await this.signObject(s.keys.master),i.addCrossSigningKeys(e,s.keys);const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),n=await s.signDevice(this.userId,t);i.addKeySignature(this.userId,this.deviceId,n),this.backupManager.backupInfo&&(await s.signObject(this.backupManager.backupInfo.auth_data,"master"),i.addSessionBackup(this.backupManager.backupInfo))},r=this.crossSigningInfo.getId(),a=await this.crossSigningInfo.isStoredInKeyCache(),c=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),l=a||c;u.a.log({setupNewCrossSigning:t,publicKeysOnDevice:r,privateKeysInCache:a,privateKeysInStorage:c,privateKeysExistSomewhere:l}),!l||t?(u.a.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await o()):r&&a?u.a.log("Cross-signing public keys trusted and private keys found locally"):c&&(u.a.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const d=i.crossSigningCallbacks.privateKeys;if(d.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){const e=new y.b(i.accountDataClientAdapter,i.ssssCryptoCallbacks,void 0);await e.hasKey()&&(u.a.log("Storing new cross-signing private keys in secret storage"),await f.a.storeInSecretStorage(d,e))}const h=i.buildOperation();await h.apply(this),await i.persist(this),u.a.log("Cross-signing ready")}async bootstrapSecretStorage(){let{createSecretStorageKey:e=(async()=>({})),keyBackupInfo:t,setupNewKeyBackup:n,setupNewSecretStorage:i,getKeyBackupPassphrase:s}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};u.a.log("Bootstrapping Secure Secret Storage");const o=this.baseApis.cryptoCallbacks,r=new b.a(this.baseApis.store.accountData,o),a=new y.b(r.accountDataClientAdapter,r.ssssCryptoCallbacks,void 0);let c=null;const l=async(e,t)=>{t&&(e.key=t);const{keyId:n,keyInfo:i}=await a.addKey(y.a,e);return t&&r.ssssCryptoCallbacks.addPrivateKey(n,i,t),await a.setDefaultKeyId(n),n},d=async(e,t)=>{if(!t.mac){var n,i;const s=await(null===(n=(i=this.baseApis.cryptoCallbacks).getSecretStorageKey)||void 0===n?void 0:n.call(i,{keys:{[e]:t}},""));if(s){const n=s[1];r.ssssCryptoCallbacks.addPrivateKey(e,t,n);const{iv:i,mac:o}=await Object(j.a)(n);t.iv=i,t.mac=o,await r.setAccountData(`m.secret_storage.key.${e}`,t)}}},h=async e=>{if(this.crossSigningInfo.getId()&&await this.crossSigningInfo.isStoredInKeyCache("master"))try{u.a.log("Adding cross-signing signature to key backup"),await this.crossSigningInfo.signObject(e,"master")}catch(e){u.a.error("Signing key backup with cross-signing keys failed",e)}else u.a.warn("Cross-signing keys not available, skipping signature on key backup")},p=await this.getSecretStorageKey(),[g,v]=p||[null,null],S=!i&&v&&v.algorithm===y.a;if(u.a.log({keyBackupInfo:t,setupNewKeyBackup:n,setupNewSecretStorage:i,storageExists:S,oldKeyInfo:v}),S||t)if(!S&&t){u.a.log("Secret storage does not exist, using key backup key");const e=await this.getSessionBackupPrivateKey()||await(null==s?void 0:s()),n={};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(n.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),c=await l(n,e),await a.store("m.megolm_backup.v1",m.encodeBase64(e),[c]),await h(t.auth_data),r.addSessionBackup(t)}else u.a.log("Secret storage exists"),v&&v.algorithm===y.a&&await d(g,v);else{u.a.log("Secret storage does not exist, creating new storage key");const{keyInfo:t={},privateKey:n}=await e();c=await l(t,n)}if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(c||!await this.crossSigningInfo.isStoredInSecretStorage(a))){u.a.log("Copying cross-signing private keys from cache to secret storage");const e=await this.crossSigningInfo.getCrossSigningKeysFromCache();await f.a.storeInSecretStorage(e,a)}if(n&&!t){u.a.log("Creating new message key backup version");const e=await this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=Object(O.a)(e.recovery_key);await a.store("m.megolm_backup.v1",m.encodeBase64(t));const n={algorithm:e.algorithm,auth_data:e.auth_data};await h(n.auth_data),await this.signObject(n.auth_data),r.addSessionBackup(n)}const E=await a.get("m.megolm_backup.v1");if(E){u.a.info("Got session backup key from secret storage: caching");const e=z(E);if(e){const t=c||g;await a.store("m.megolm_backup.v1",e,t?[t]:null)}const t=new Uint8Array(m.decodeBase64(e||E));r.addSessionBackupPrivateKeyToCache(t)}else if(this.backupManager.getKeyBackupEnabled()){const e=await this.getSessionBackupPrivateKey()||await(null==s?void 0:s());if(!e)return void u.a.error("Key backup is enabled but couldn't get key backup key!");u.a.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),await a.store("m.megolm_backup.v1",m.encodeBase64(e))}const w=r.buildOperation();await w.apply(this),await r.persist(this),u.a.log("Secure Secret Storage ready")}addSecretStorageKey(e,t,n){return this.secretStorage.addKey(e,t,n)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,n){return this.secretStorage.store(e,t,n)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(t,n){let i=null;try{i=new e.Olm.PkDecryption;return i.init_with_private_key(t)===n}finally{var s;null===(s=i)||void 0===s||s.free()}}async getSessionBackupPrivateKey(){let e=await new Promise((e=>{this.cryptoStore.doTxn("readonly",[E.a.STORE_ACCOUNT],(t=>{this.cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")}))}));if(e&&"string"==typeof e&&(e=new Uint8Array(m.decodeBase64(z(e)||e)),await this.storeSessionBackupPrivateKey(e)),e&&e.ciphertext){const t=i.from(this.olmDevice.pickleKey),n=await Object(j.b)(e,t,"m.megolm_backup.v1");e=m.decodeBase64(n)}return e}async storeSessionBackupPrivateKey(e){if(!(e instanceof Uint8Array))throw new Error(`storeSessionBackupPrivateKey expects Uint8Array, got ${e}`);const t=i.from(this.olmDevice.pickleKey),n=await Object(j.c)(m.encodeBase64(e),t,"m.megolm_backup.v1");return this.cryptoStore.doTxn("readwrite",[E.a.STORE_ACCOUNT],(e=>{this.cryptoStore.storeSecretStorePrivateKey(e,"m.megolm_backup.v1",n)}))}checkCrossSigningPrivateKey(t,n){let i=null;try{i=new e.Olm.PkSigning;return i.init_with_seed(t)===n}finally{var s;null===(s=i)||void 0===s||s.free()}}async afterCrossSigningLocalKeyChange(){u.a.info("Starting cross-signing key change post-processing");const e=this.deviceList.getStoredDevice(this.userId,this.deviceId),t=await this.crossSigningInfo.signDevice(this.userId,e);u.a.info(`Starting background key sig upload for ${this.deviceId}`);const n=e=>{let{shouldEmit:i=!1}=e;return this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:t}}).then((e=>{const{failures:t}=e||{};if(Object.keys(t||[]).length>0)throw i&&this.baseApis.emit(q.KeySignatureUploadFailure,t,"afterCrossSigningLocalKeyChange",n),new T.e("Key upload failed",{failures:t});u.a.info(`Finished background key sig upload for ${this.deviceId}`)})).catch((e=>{u.a.error(`Error during background key sig upload for ${this.deviceId}`,e)}))};n({shouldEmit:!0});const i=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(i){u.a.info("Starting device verification upgrade");const e={};for(const[t,n]of Object.entries(this.deviceList.crossSigningInfo)){const i=await this.checkForDeviceVerificationUpgrade(t,f.a.fromStorage(n,t));i&&(e[t]=i)}if(Object.keys(e).length>0){u.a.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await i({users:e});if(t)for(const n of t)n in e&&await this.baseApis.setDeviceVerified(n,e[n].crossSigningInfo.getId())}catch(e){u.a.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e)}}u.a.info("Finished device verification upgrade")}u.a.info("Finished cross-signing key change post-processing")}async checkForDeviceVerificationUpgrade(e,t){const n=this.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!n.isVerified()){const n=this.deviceList.getRawStoredDevicesForUser(e),i=await this.checkForValidDeviceSignature(e,t.keys.master,n);if(i.length)return{devices:i.map((e=>g.a.fromStorage(n[e],e))),crossSigningInfo:t}}}async checkForValidDeviceSignature(e,t,n){const i=[];if(n&&t.signatures&&t.signatures[e])for(const s of Object.keys(t.signatures[e])){const[,o]=s.split(":",2);if(o in n&&n[o].verified===K.VERIFIED)try{await m.verifySignature(this.olmDevice,t,e,o,n[o].keys[s]),i.push(o)}catch(e){}}return i}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){const t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new f.c(!1,!1,!1)}checkDeviceTrust(e,t){const n=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,n)}checkDeviceInfoTrust(e,t){const n=!(null==t||!t.isVerified()),i=this.deviceList.getStoredCrossSigningForUser(e);if(t&&i){const s=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(i,t,n,s)}return new f.b(!1,!1,n,!1)}checkIfOwnDeviceCrossSigned(e){var t;const n=this.deviceList.getStoredDevice(this.userId,e);if(!n)return!1;const i=this.deviceList.getStoredCrossSigningForUser(this.userId);return null!==(t=null==i?void 0:i.checkDeviceTrust(i,n,!1,!0).isCrossSigningVerified())&&void 0!==t&&t}async checkOwnCrossSigningTrust(){let{allowPrivateKeyRequests:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this.userId;await this.downloadKeys([this.userId]);const n=await this.crossSigningInfo.getCrossSigningKeysFromCache(),i=this.deviceList.getStoredCrossSigningForUser(t);if(!i)return void u.a.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!");const s=i.getId(),o=this.crossSigningInfo.getId()!==s,r=i.getId()&&!n.has("master");if(o&&u.a.info("Got new master public key",s),e&&(o||r)){u.a.info("Attempting to retrieve cross-signing master private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("master",s))[1],u.a.info("Got cross-signing master private key")}finally{var a;null===(a=e)||void 0===a||a.free()}}const c=this.crossSigningInfo.getId("self_signing"),l=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(i.keys);const d=c!==i.getId("self_signing"),h=l!==i.getId("user_signing"),m=i.getId("self_signing")&&!n.has("self_signing"),p=i.getId("user_signing")&&!n.has("user_signing"),g={};if(d&&u.a.info("Got new self-signing key",i.getId("self_signing")),e&&(d||m)){u.a.info("Attempting to retrieve cross-signing self-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("self_signing",i.getId("self_signing")))[1],u.a.info("Got cross-signing self-signing private key")}finally{var v;null===(v=e)||void 0===v||v.free()}const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),n=await this.crossSigningInfo.signDevice(this.userId,t);g[this.deviceId]=n}if(h&&u.a.info("Got new user-signing key",i.getId("user_signing")),e&&(h||p)){u.a.info("Attempting to retrieve cross-signing user-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("user_signing",i.getId("user_signing")))[1],u.a.info("Got cross-signing user-signing private key")}finally{var f;null===(f=e)||void 0===f||f.free()}}if(o){const e=this.crossSigningInfo.keys.master;await this.signObject(e);const t=e.signatures[this.userId]["ed25519:"+this.deviceId];g[this.crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:t}}})}const b=Object.keys(g);if(b.length){const e=t=>{let{shouldEmit:n=!1}=t;return u.a.info(`Starting background key sig upload for ${b}`),this.baseApis.uploadKeySignatures({[this.userId]:g}).then((t=>{const{failures:i}=t||{};if(u.a.info(`Finished background key sig upload for ${b}`),Object.keys(i||[]).length>0)throw n&&this.baseApis.emit(q.KeySignatureUploadFailure,i,"checkOwnCrossSigningTrust",e),new T.e("Key upload failed",{failures:i})})).catch((e=>{u.a.error(`Error during background key sig upload for ${b}`,e)}))};e({shouldEmit:!0})}this.emit(q.UserTrustStatusChanged,t,this.checkUserTrust(t)),o&&(this.emit(q.KeysChanged,{}),await this.afterCrossSigningLocalKeyChange()),await this.backupManager.checkKeyBackup()}async storeTrustedSelfKeys(e){e?this.crossSigningInfo.setKeys(e):this.crossSigningInfo.clearKeys(),await this.cryptoStore.doTxn("readwrite",[E.a.STORE_ACCOUNT],(e=>{this.cryptoStore.storeCrossSigningKeys(e,this.crossSigningInfo.keys)}))}async checkDeviceVerifications(e){const t=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(u.a.info(`Starting device verification upgrade for ${e}`),this.crossSigningInfo.keys.user_signing){const n=this.deviceList.getStoredCrossSigningForUser(e);if(n){const i=await this.checkForDeviceVerificationUpgrade(e,n);if(i){(await t({users:{[e]:i}})).includes(e)&&await this.baseApis.setDeviceVerified(e,n.getId())}}}u.a.info(`Finished device verification upgrade for ${e}`)}}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on(M.b.Membership,this.onMembership),e.on(L.b.ToDeviceEvent,this.onToDeviceEvent),e.on(N.d.Timeline,this.onTimelineEvent),e.on(A.c.Decrypted,this.onTimelineEvent)}start(){u.a.warn("MatrixClient.crypto.start() is deprecated")}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}uploadDeviceKeys(){const e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then((()=>this.baseApis.uploadKeysRequest({device_keys:e})))}updateOneTimeKeyCount(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this.oneTimeKeyCount=e}setNeedsNewFallback(e){this.needsNewFallback=e}getNeedsNewFallback(){return!!this.needsNewFallback}maybeUploadOneTimeKeys(){if(this.oneTimeKeyCheckInProgress)return;const e=Date.now();if(null!==this.lastOneTimeKeyCheck&&e-this.lastOneTimeKeyCheck<6e4)return;this.lastOneTimeKeyCheck=e;const t=this.olmDevice.maxNumberOfOneTimeKeys(),n=Math.floor(t/2),i=async e=>{for(;n>e||this.getNeedsNewFallback();){if(n>e){u.a.info("generating oneTimeKeys");const t=Math.min(n-e,5);await this.olmDevice.generateOneTimeKeys(t)}if(this.getNeedsNewFallback()){const e=await this.olmDevice.getFallbackKey();e.curve25519&&0!=Object.keys(e.curve25519).length||(u.a.info("generating fallback key"),this.fallbackCleanup&&(clearTimeout(this.fallbackCleanup),delete this.fallbackCleanup),await this.olmDevice.generateFallbackKey())}u.a.info("calling uploadOneTimeKeys");const t=await this.uploadOneTimeKeys();if(!t.one_time_key_counts||!t.one_time_key_counts.signed_curve25519)throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");e=t.one_time_key_counts.signed_curve25519}};this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then((()=>void 0!==this.oneTimeKeyCount?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then((e=>e.one_time_key_counts.signed_curve25519||0)))).then((e=>i(e))).catch((e=>{u.a.error("Error uploading one-time keys",e.stack||e)})).finally((()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1}))}async uploadOneTimeKeys(){const e=[];let t;if(this.getNeedsNewFallback()){t={};const n=await this.olmDevice.getFallbackKey();for(const[i,s]of Object.entries(n.curve25519)){const n={key:s,fallback:!0};t["signed_curve25519:"+i]=n,e.push(this.signObject(n))}this.setNeedsNewFallback(!1)}const n=await this.olmDevice.getOneTimeKeys(),i={};for(const t in n.curve25519)if(n.curve25519.hasOwnProperty(t)){const s={key:n.curve25519[t]};i["signed_curve25519:"+t]=s,e.push(this.signObject(s))}await Promise.all(e);const s={one_time_keys:i};t&&(s["org.matrix.msc2732.fallback_keys"]=t,s.fallback_keys=t);const o=await this.baseApis.uploadKeysRequest(s);return t&&(this.fallbackCleanup=setTimeout((()=>{delete this.fallbackCleanup,this.olmDevice.forgetOldFallbackKey()}),36e5)),await this.olmDevice.markKeysAsPublished(),o}downloadKeys(e,t){return this.deviceList.downloadKeys(e,!!t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}async setDeviceVerification(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5?arguments[5]:void 0;const r=this.deviceList.getStoredCrossSigningForUser(e);if(r&&r.getId()===t){if(null!==i||null!==s)throw new Error("Cannot set blocked or known for a cross-signing key");if(!n)throw new Error("Cannot set a cross-signing key as unverified");const a=o?Object.values(o)[0]:null;if(o&&(1!==Object.values(o).length||a!==r.getId()))throw new Error(`Key did not match expected value: expected ${r.getId()}, got ${a}`);if(this.crossSigningInfo.getId()||e!==this.crossSigningInfo.userId||(this.storeTrustedSelfKeys(r.keys),this.emit(q.UserTrustStatusChanged,this.userId,this.checkUserTrust(e))),e!==this.userId){u.a.info("Master key "+r.getId()+" for "+e+" marked verified. Signing...");const n=await this.crossSigningInfo.signUser(r);if(n){const i=async s=>{let{shouldEmit:o=!1}=s;u.a.info("Uploading signature for "+e+"...");const r=await this.baseApis.uploadKeySignatures({[e]:{[t]:n}}),{failures:a}=r||{};if(Object.keys(a||[]).length>0)throw o&&this.baseApis.emit(q.KeySignatureUploadFailure,a,"setDeviceVerification",i),new T.e("Key upload failed",{failures:a})};await i({shouldEmit:!0})}return n}return r}const a=this.deviceList.getRawStoredDevicesForUser(e);if(!a||!a[t])throw new Error("Unknown device "+e+":"+t);const c=a[t];let l=c.verified;if(n){if(o)for(const[e,t]of Object.entries(o))if(c.keys[e]!==t)throw new Error(`Key did not match expected value: expected ${t}, got ${c.keys[e]}`);l=K.VERIFIED}else null!==n&&l==K.VERIFIED&&(l=K.UNVERIFIED);i?l=K.BLOCKED:null!==i&&l==K.BLOCKED&&(l=K.UNVERIFIED);let d=c.known;if(null!==s&&(d=s),c.verified===l&&c.known===d||(c.verified=l,c.known=d,this.deviceList.storeDevicesForUser(e,a),this.deviceList.saveIfDirty()),n&&e===this.userId){let n;u.a.info("Own device "+t+" marked verified: signing");if(this.checkDeviceTrust(e,t).isCrossSigningVerified()?u.a.log(`Own device ${t} already cross-signing verified`):n=await this.crossSigningInfo.signDevice(e,g.a.fromStorage(c,t)),n){const i=async s=>{let{shouldEmit:o=!1}=s;u.a.info("Uploading signature for "+t);const r=await this.baseApis.uploadKeySignatures({[e]:{[t]:n}}),{failures:a}=r||{};if(Object.keys(a||[]).length>0)throw o&&this.baseApis.emit(q.KeySignatureUploadFailure,a,"setDeviceVerification",i),new T.e("Key upload failed",{failures:a})};await i({shouldEmit:!0})}}const h=g.a.fromStorage(c,t);return this.emit(q.DeviceVerificationChanged,e,t,h),h}findVerificationRequestDMInProgress(e){return this.inRoomVerificationRequests.findRequestInProgress(e)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){const n=this.inRoomVerificationRequests.findRequestInProgress(t);if(n)return Promise.resolve(n);const i=new R.a(this.baseApis,t,e);return this.requestVerificationWithChannel(e,i,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));const n=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(n)return Promise.resolve(n);const i=new k.a(this.baseApis,e,t,k.a.makeTransactionId());return this.requestVerificationWithChannel(e,i,this.toDeviceVerificationRequests)}async requestVerificationWithChannel(e,t,n){let i=new I.k(t,this.verificationMethods,this.baseApis);t.transactionId&&n.setRequestByChannel(t,i),await i.sendRequest();const s=n.getRequestByChannel(t);return s?i=s:(u.a.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),n.setRequestByChannel(t,i)),i}beginKeyVerification(e,t,n){let i,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(s){if(i=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,s),!i)throw new Error(`No request found for user ${t} with transactionId ${s}`)}else{s=k.a.makeTransactionId();const e=new k.a(this.baseApis,t,[n],s,n);i=new I.k(e,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,s,i)}return i.beginKeyVerification(e,{userId:t,deviceId:n})}async legacyDeviceVerification(e,t,n){const i=k.a.makeTransactionId(),s=new k.a(this.baseApis,e,[t],i,t),o=new I.k(s,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,i,o);const r=o.beginKeyVerification(n,{userId:e,deviceId:t});return await Promise.race([r.verify(),o.waitFor((e=>e.started))]),o}async getOlmSessionsForUser(e){const t=this.getStoredDevicesForUser(e)||[],n={};for(const e of t){const t=e.getIdentityKey(),i=await this.olmDevice.getSessionInfoForDevice(t);n[e.deviceId]={deviceIdKey:t,sessions:i}}return n}getEventSenderDeviceInfo(e){const t=e.getSenderKey(),n=e.getWireContent().algorithm;if(!t||!n)return null;if(e.isKeySourceUntrusted())return null;const i=this.deviceList.getDeviceByIdentityKey(n,t);if(null===i)return null;const s=e.getClaimedEd25519Key();return s?s!==i.getFingerprint()?(u.a.warn("Event "+e.getId()+" claims ed25519 key "+s+" but sender device has key "+i.getFingerprint()),null):i:(u.a.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){var t,n;const i={};if(i.senderKey=null!==(t=e.getSenderKey())&&void 0!==t?t:void 0,i.algorithm=e.getWireContent().algorithm,!i.senderKey||!i.algorithm)return i.encrypted=!1,i;i.encrypted=!0,e.isKeySourceUntrusted()?i.authenticated=!1:i.authenticated=!0,i.sender=null!==(n=this.deviceList.getDeviceByIdentityKey(i.algorithm,i.senderKey))&&void 0!==n?n:void 0;const s=e.getClaimedEd25519Key();return s||(u.a.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),i.mismatchedSender=!0),i.sender&&s!==i.sender.getFingerprint()&&(u.a.warn("Event "+e.getId()+" claims ed25519 key "+s+"but sender device has key "+i.sender.getFingerprint()),i.mismatchedSender=!0),i}forceDiscardSession(e){const t=this.roomEncryptors.get(e);if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()}async setRoomEncryption(e,t,n){const i=this.clientStore.getRoom(e);if(!i)throw new Error(`Unable to enable encryption tracking devices in unknown room ${e}`);await this.setRoomEncryptionImpl(i,t),this.lazyLoadMembers||n||this.deviceList.refreshOutdatedDeviceLists()}async setRoomEncryptionImpl(e,t){const n=e.roomId;if(!t.algorithm)return void u.a.log("Ignoring setRoomEncryption with no algorithm");const i=this.roomList.getRoomEncryption(n);if(i&&JSON.stringify(i)!=JSON.stringify(t))return void u.a.error("Ignoring m.room.encryption event which requests a change of config in "+n);if(this.roomEncryptors.get(n))return;let s=null;i||(s=this.roomList.setRoomEncryption(n,t));const o=v.c.get(t.algorithm);if(!o)throw new Error("Unable to encrypt with "+t.algorithm);const r=new o({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:n,config:t});if(this.roomEncryptors.set(n,r),s&&await s,u.a.log(`Enabling encryption in ${n}`),e.membersLoaded())await this.trackRoomDevicesImpl(e);else{const t=i=>{e.off(F.b.Update,t),e.membersLoaded()&&this.trackRoomDevicesImpl(e).catch((e=>{u.a.error(`Error enabling device tracking in ${n}`,e)}))};e.on(F.b.Update,t)}}trackRoomDevices(e){const t=this.clientStore.getRoom(e);if(!t)throw new Error(`Unable to start tracking devices in unknown room ${e}`);return this.trackRoomDevicesImpl(t)}trackRoomDevicesImpl(e){const t=e.roomId,n=async()=>{if(!this.roomEncryptors.has(t))return;u.a.log(`Starting to track devices for room ${t} ...`);(await e.getEncryptionTargetMembers()).forEach((e=>{this.deviceList.startTrackingDeviceList(e.userId)}))};let i=this.roomDeviceTrackingState[t];return i||(i=n(),this.roomDeviceTrackingState[t]=i.catch((e=>{throw delete this.roomDeviceTrackingState[t],e}))),i}ensureOlmSessionsForUsers(e,t){const n=new Map;for(const t of e){const e=[];n.set(t,e);const i=this.getStoredDevicesForUser(t)||[];for(const t of i){t.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(t.verified!=K.BLOCKED&&e.push(t))}}return m.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,n,t)}async exportRoomKeys(){const e=[];return await this.cryptoStore.doTxn("readonly",[E.a.STORE_INBOUND_GROUP_SESSIONS],(t=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(t,(t=>{if(null===t)return;const n=this.olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete n.first_known_index,n.algorithm=m.MEGOLM_ALGORITHM,e.push(n)}))})),e}importRoomKeys(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=0,i=0;const s=e.length;function o(){var e;null===(e=t.progressCallback)||void 0===e||e.call(t,{stage:"load_keys",successes:n,failures:i,total:s})}return Promise.all(e.map((e=>{if(!e.room_id||!e.algorithm)return u.a.warn("ignoring room key entry with missing fields",e),i++,t.progressCallback&&o(),null;return this.getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,t).finally((()=>{n++,t.progressCallback&&o()}))}))).then()}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){const t=this.roomEncryptors.get(e.roomId);t&&t.prepareToEncrypt(e)}async encryptEvent(e,t){const n=e.getRoomId(),i=this.roomEncryptors.get(n);if(!i)throw new Error("Room "+n+" was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");await this.trackRoomDevicesImpl(t);let s=e.getContent();const o=s["m.relates_to"];o&&(s=Object.assign({},s),delete s["m.relates_to"]);const r=s["io.element.performance_metrics"];r&&(s=Object.assign({},s),delete s["io.element.performance_metrics"]);const a=await i.encryptMessage(t,e.getType(),s);o&&(a["m.relates_to"]=o),r&&(a["io.element.performance_metrics"]=r),e.makeEncrypted("m.room.encrypted",a,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)}async decryptEvent(e){if(e.isRedacted()){const t=new A.b(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?V(Object(n),!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):V(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({room_id:e.getRoomId()},e.getUnsigned().redacted_because));let n=e.getUnsigned().redacted_because;if(t.isEncrypted())try{n=(await this.decryptEvent(t)).clearEvent}catch(e){u.a.warn("Decryption of redaction failed. Falling back to unencrypted event.",e)}return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:n}}}}{const t=e.getWireContent();return this.getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)}}async handleDeviceListChanges(e,t){e.oldSyncToken&&await this.evalDeviceListChanges(t)}requestRoomKey(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,n).then((()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()})).catch((e=>{u.a.error("Error requesting key for event",e)}))}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch((e=>{u.a.warn("Error clearing pending room key requests",e)}))}async cancelAndResendAllOutgoingKeyRequests(){await this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}async onCryptoEvent(e,t){const n=t.getContent();await this.setRoomEncryptionImpl(e,n)}async onSyncWillProcess(e){e.oldSyncToken||(u.a.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1}async onSyncCompleted(e){var t;this.deviceList.setSyncToken(null!==(t=e.nextSyncToken)&&void 0!==t?t:null),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)}async evalDeviceListChanges(e){if(Array.isArray(null==e?void 0:e.changed)&&e.changed.forEach((e=>{this.deviceList.invalidateUserDeviceList(e)})),Array.isArray(null==e?void 0:e.left)&&e.left.length){const t=new Set(await this.getTrackedE2eUsers());e.left.forEach((e=>{t.has(e)||this.deviceList.stopTrackingDeviceList(e)}))}}async getTrackedE2eUsers(){const e=[];for(const t of this.getTrackedE2eRooms()){const n=await t.getEncryptionTargetMembers();for(const t of n)e.push(t.userId)}return e}getTrackedE2eRooms(){return this.clientStore.getRooms().filter((e=>{if(!this.roomEncryptors.get(e.roomId))return!1;if(!this.roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return"join"===t||"invite"===t}))}async encryptAndSendToDevices(e,t){const n={eventType:l.b.RoomMessageEncrypted,batch:[]};try{await Promise.all(e.map((async e=>{let{userId:i,deviceInfo:s}=e;const o=s.deviceId,r={algorithm:m.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[l.k]:Object(c.v4)()};n.batch.push({userId:i,deviceId:o,payload:r}),await m.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[i,[s]]])),await m.encryptMessageForDevice(r.ciphertext,this.userId,this.deviceId,this.olmDevice,i,s,t)}))),n.batch=n.batch.filter((e=>Object.keys(e.payload.ciphertext).length>0||(u.a.log(`No ciphertext for device ${e.userId}:${e.deviceId}: pruning`),!1)));try{await this.baseApis.queueToDevice(n)}catch(e){throw u.a.error("sendToDevice failed",e),e}}catch(e){throw u.a.error("encryptAndSendToDevices promises failed",e),e}}async preprocessToDeviceMessages(e){return e.filter((e=>{var t;return!(e.type===l.b.RoomMessageEncrypted&&!["m.olm.v1.curve25519-aes-sha2"].includes(null===(t=e.content)||void 0===t?void 0:t.algorithm))||(u.a.log("Ignoring invalid encrypted to-device event from "+e.sender),!1)}))}onRoomKeyEvent(e){const t=e.getContent();if(!t.room_id||!t.algorithm)return void u.a.error("key event is missing fields");this.backupManager.checkedForBackup||this.backupManager.checkAndStart();this.getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)}onRoomKeyWithheldEvent(e){const t=e.getContent();if(!(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key))return void u.a.error("key withheld event is missing fields");u.a.info(`Got room key withheld event from ${e.getSender()} for ${t.algorithm} session ${t.sender_key}|${t.session_id} in room ${t.room_id} with code ${t.code} (${t.reason})`);const n=this.getRoomDecryptor(t.room_id,t.algorithm);if(n.onRoomKeyWithheldEvent&&n.onRoomKeyWithheldEvent(e),!t.room_id){const e=this.getRoomDecryptors(t.algorithm);for(const n of e)n.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){if(!k.a.validateEvent(e,this.baseApis))return;this.handleVerificationEvent(e,this.toDeviceVerificationRequests,(e=>{if(!k.a.canCreateRequest(k.a.getEventType(e)))return;const t=e.getContent(),n=t&&t.from_device;if(!n)return;const i=e.getSender(),s=new k.a(this.baseApis,i,[n]);return new I.k(s,this.verificationMethods,this.baseApis)}))}async handleVerificationEvent(e,t,n){let i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(e.isSending()&&e.status!=A.a.SENT){let t,n;try{await new Promise(((i,s)=>{t=i,n=()=>{e.status==A.a.CANCELLED&&s(new Error("Event status set to CANCELLED."))},e.once(A.c.LocalEventIdReplaced,t),e.on(A.c.Status,n)}))}catch(e){return void u.a.error("error while waiting for the verification event to be sent: ",e)}finally{e.removeListener(A.c.LocalEventIdReplaced,t),e.removeListener(A.c.Status,n)}}let s=t.getRequest(e),o=!1;if(!s){if(s=n(e),!s)return void u.a.log(`Crypto: could not find VerificationRequest for ${e.getType()}, and could not create one, so ignoring.`);o=!0,t.setRequest(e,s)}e.setVerificationRequest(s);try{await s.channel.handleEvent(e,s,i)}catch(e){u.a.error("error while handling verification event",e)}o&&!s.initiatedByMe&&!s.invalid&&!s.observeOnly&&this.baseApis.emit(q.VerificationRequest,s)}async onToDeviceBadEncrypted(e){const t=e.getWireContent(),n=e.getSender(),i=t.algorithm,s=t.sender_key;this.baseApis.emit(L.b.UndecryptableToDeviceEvent,e);const o=()=>{const e=this.getRoomDecryptors(m.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(s)};if(void 0===n||void 0===s||void 0===s)return;const r=this.lastNewSessionForced.getOrCreate(n),a=r.getOrCreate(s);if(a+36e5>Date.now())return u.a.debug("New session already forced with device "+n+":"+s+" at "+a+": not forcing another"),await this.olmDevice.recordSessionProblem(s,"wedged",!0),void o();let d=this.deviceList.getDeviceByIdentityKey(i,s);if(!d&&(await this.downloadKeys([n],!1),d=this.deviceList.getDeviceByIdentityKey(i,s),!d))return u.a.info("Couldn't find device for identity key "+s+": not re-establishing session"),await this.olmDevice.recordSessionProblem(s,"wedged",!1),void o();const h=new Map([[n,[d]]]);await m.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,h,!0),r.set(s,Date.now());const p={algorithm:m.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[l.k]:Object(c.v4)()};await m.encryptMessageForDevice(p.ciphertext,this.userId,this.deviceId,this.olmDevice,n,d,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(s,"wedged",!0),o(),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[n,new Map([[d.deviceId,p]])]]));const g=await this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,d.deviceId);for(const e of g)this.requestRoomKey(e.requestBody,e.recipients,!0)}onRoomMembership(e,t,n){const i=t.roomId,s=this.roomEncryptors.get(i);if(s){var o;if(i in this.roomDeviceTrackingState)"join"==t.membership?(u.a.log("Join event for "+t.userId+" in "+i),this.deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&null!==(o=this.clientStore.getRoom(i))&&void 0!==o&&o.shouldEncryptForInvitedMembers()&&(u.a.log("Invite event for "+t.userId+" in "+i),this.deviceList.startTrackingDeviceList(t.userId));s.onRoomMembership(e,t,n)}}onRoomKeyRequestEvent(e){const t=e.getContent();if("request"===t.action){const t=new J(e);this.receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new Y(e);this.receivedRoomKeyRequestCancellations.push(t)}}async processReceivedRoomKeyRequests(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{const e=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];const t=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],await Promise.all(e.map((e=>this.processReceivedRoomKeyRequest(e)))),await Promise.all(t.map((e=>this.processReceivedRoomKeyRequestCancellation(e))))}catch(e){u.a.error(`Error processing room key requsts: ${e}`)}finally{this.processingRoomKeyRequests=!1}}}async processReceivedRoomKeyRequest(e){const t=e.userId,n=e.deviceId,i=e.requestBody,s=i.room_id,o=i.algorithm;if(u.a.log(`m.room_key_request from ${t}:${n} for ${s} / ${i.session_id} (id ${e.requestId})`),t!==this.userId){if(!this.roomEncryptors.get(s))return void u.a.debug(`room key request for unencrypted room ${s}`);const e=this.roomEncryptors.get(s),o=this.deviceList.getStoredDevice(t,n);if(!o)return void u.a.debug(`Ignoring keyshare for unknown device ${t}:${n}`);try{await e.reshareKeyWithDevice(i.sender_key,i.session_id,t,o)}catch(e){u.a.warn("Failed to re-share keys for session "+i.session_id+" with device "+t+":"+o.deviceId,e)}return}if(n===this.deviceId)return void u.a.log("Ignoring room key request from ourselves");if(!this.roomDecryptors.has(s))return void u.a.log(`room key request for unencrypted room ${s}`);const r=this.roomDecryptors.get(s).get(o);if(r)if(await r.hasKeysForKeyRequest(e)){if(e.share=()=>{r.shareKeysWithDevice(e)},this.checkDeviceTrust(t,n).isVerified())return u.a.log("device is already verified: sharing keys"),void e.share();this.emit(q.RoomKeyRequest,e)}else u.a.log(`room key request for unknown session ${s} / `+i.session_id);else u.a.log(`room key request for unknown alg ${o} in room ${s}`)}async processReceivedRoomKeyRequestCancellation(e){u.a.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit(q.RoomKeyRequestCancellation,e)}getRoomDecryptor(e,t){let n,i;if(e&&(n=this.roomDecryptors.get(e),n||(n=new Map,this.roomDecryptors.set(e,n)),i=n.get(t),i))return i;const s=v.a.get(t);if(!s)throw new v.b("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return i=new s({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:null!=e?e:void 0}),n&&n.set(t,i),i}getRoomDecryptors(e){const t=[];for(const n of this.roomDecryptors.values())n.has(e)&&t.push(n.get(e));return t}async signObject(e){const t=new Map(Object.entries(e.signatures||{})),n=e.unsigned;delete e.signatures,delete e.unsigned;const i=t.get(this.userId)||{};t.set(this.userId,i),i["ed25519:"+this.deviceId]=await this.olmDevice.sign(a.a.stringify(e)),e.signatures=Object(B.F)(t),void 0!==n&&(e.unsigned=n)}}function z(e){if("string"!=typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),(e=>parseInt(e)));return m.encodeBase64(t)}class J{constructor(e){o()(this,"userId",void 0),o()(this,"deviceId",void 0),o()(this,"requestId",void 0),o()(this,"requestBody",void 0),o()(this,"share",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class Y{constructor(e){o()(this,"userId",void 0),o()(this,"deviceId",void 0),o()(this,"requestId",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}}).call(this,n(14),n(53).Buffer)},function(e,t,n){"use strict";var i=n(122),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l);const u=["size","className","children"];function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}t.a=e=>{let{size:t,className:n,children:i}=e,s=r()(e,u);return c.a.createElement(t||"h1",m(m({},s),{},{className:d()(`mx_Heading_${t}`,n),children:i}))}},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.IRC="irc",e.Group="group",e.Bubble="bubble"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"d",(function(){return f})),n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return y})),n.d(t,"c",(function(){return S}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l),u=n(151),h=n(121);const m=["label","iconClassName","active","className"],p=["label","iconClassName","active","className","words"],g=["label","className","iconClassName","children","isDestructive"],v=["className","children","compact"],f=e=>{let{label:t,iconClassName:n,active:i,className:o}=e,a=r()(e,m);return c.a.createElement(u.f,s()({},a,{className:d()(o,{mx_IconizedContextMenu_item:!0,mx_IconizedContextMenu_active:i}),active:i,label:t}),n&&c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",n)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),i&&c.a.createElement("span",{className:"mx_IconizedContextMenu_icon mx_IconizedContextMenu_checked"}))},b=e=>{let t,{label:n,iconClassName:i,active:o,className:a,words:l}=e,m=r()(e,p);return t=l?c.a.createElement("span",{className:"mx_IconizedContextMenu_activeText"},o?Object(h.a)("On"):Object(h.a)("Off")):c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",{mx_IconizedContextMenu_checked:o,mx_IconizedContextMenu_unchecked:!o})}),c.a.createElement(u.e,s()({},m,{className:d()(a,{mx_IconizedContextMenu_item:!0,mx_IconizedContextMenu_active:o}),active:o,label:n}),c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",i)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},n),t)},y=e=>{let{label:t,className:n,iconClassName:i,children:o,isDestructive:a}=e,l=r()(e,g);return c.a.createElement(u.d,s()({},l,{className:d()(n,{mx_IconizedContextMenu_item:!0,mx_IconizedContextMenu_itemDestructive:a}),label:t}),i&&c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",i)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),o)},S=e=>{let{first:t,red:n,className:i,label:s,children:o}=e;const r=d()("mx_IconizedContextMenu_optionList",i,{mx_IconizedContextMenu_optionList_notFirst:!t,mx_IconizedContextMenu_optionList_red:n});return c.a.createElement("div",{className:r},s&&c.a.createElement("div",null,c.a.createElement("span",{className:"mx_IconizedContextMenu_optionList_label"},s)),o)};t.e=e=>{let{className:t,children:n,compact:i}=e,o=r()(e,v);const a=d()("mx_IconizedContextMenu",t,{mx_IconizedContextMenu_compact:i});return c.a.createElement(u.n,s()({chevronFace:u.a.None},o),c.a.createElement("div",{className:a},n))}},function(e,t,n){"use strict";n.d(t,"b",(function(){return W})),n.d(t,"a",(function(){return z}));var i=n(122),s=n.n(i),o=n(150),r=n(130),a=n(141),c=n(149),l=n(1),d=n(152),u=n(203),h=n(125),m=n(228),p=n(126),g=n(164),v=n(205),f=n(147),b=n(268),y=n(192);class S extends b.a{constructor(e){super(),this.getRoomFn=e,s()(this,"rooms",[]),s()(this,"states",{}),s()(this,"onRoomNotificationStateUpdate",(()=>{this.calculateTotalState()}))}get symbol(){return this._color===v.a.Unsent?"!":null}setRooms(e){const t=this.rooms,n=Object(f.a)(t,e);this.rooms=e;for(const e of n.removed){const t=this.states[e.roomId];t&&(delete this.states[e.roomId],t.off(b.b.Update,this.onRoomNotificationStateUpdate))}for(const e of n.added){const t=this.getRoomFn(e);t.on(b.b.Update,this.onRoomNotificationStateUpdate),this.states[e.roomId]=t}this.calculateTotalState()}getFirstRoomWithNotifications(){var e;return null===(e=Object.values(this.states).find((e=>e.color>=this.color)))||void 0===e?void 0:e.room.roomId}destroy(){super.destroy();for(const e of Object.values(this.states))e.off(b.b.Update,this.onRoomNotificationStateUpdate);this.states={}}calculateTotalState(){const e=this.snapshot();this._count=0,this._color=v.a.None;for(const[e,t]of Object.entries(this.states)){m.c.instance.getTagsForRoom(this.rooms.find((t=>t.roomId===e))).includes(y.a.LowPriority)&&t.color===v.a.Bold||(this._count+=t.count,this._color=Math.max(this.color,t.color))}this.emitIfUpdated(e)}}var E=n(218),w=n(466),_=n(863),C=n(129),O=n(16);function I(e,t,n,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:O.a;const o=Math.min(Math.max(e.length,t.length),i),r=Object(O.c)(e,o,s),a=Object(O.c)(t,o,s),c=Object(O.P)(r,s),l=Object(O.P)(a,s);if(l-c-BigInt(1)<n)return o<i?I(Object(O.c)(r,o+1,s),Object(O.c)(a,o+1,s),n,o+1,s):[];const d=(l-c)/BigInt(n+1),u=BigInt(c+d);return Array(n).fill(void 0).map(((e,t)=>Object(O.e)(u+BigInt(t)*d,s)))}const R=function(e,t,n){var i,s,o,r,a,c;let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:50;if(t<0||n<0||t>e.length||n>e.length||t===n)return[];const d=e.map(((e,t)=>({index:t,order:e}))),u=Object(f.o)(d,t,n),h=void 0===(null===(i=u[n-1])||void 0===i?void 0:i.order);let m=n,p=n,g=!0;const v=void 0!==(null===(s=u[n+1])||void 0===s?void 0:s.order)?Object(O.P)(u[n+1].order):BigInt(Number.MAX_VALUE);for(let e=n-1,t=1;e>=0;e--,t++){var b;if(void 0!==(null===(b=u[e])||void 0===b?void 0:b.order)&&v-Object(O.P)(u[e].order)>t)break;m=e}const y=void 0===u[0].order?void 0:Object(O.P)(u[0].order),S=BigInt(n);0===m&&void 0!==y&&v-y<=S&&y<=S&&(g=!1);const E=!h;let w=E;if(E){var _;const e=void 0!==(null===(_=u[n-1])||void 0===_?void 0:_.order)?Object(O.P)(u[n-1].order):BigInt(Number.MIN_VALUE);for(let t=n+1,i=1;t<u.length;t++,i++){var C;if(void 0===(null===(C=u[t])||void 0===C?void 0:C.order)||Object(O.P)(u[t].order)-e>i)break;p=t}p===u.length-1&&(u[p]?Object(O.P)(u[p].order):BigInt(Number.MAX_VALUE))-e<=p-n&&(w=!1)}const R=g?n-m:Number.MAX_SAFE_INTEGER,k=w?p-n:Number.MAX_SAFE_INTEGER;h||R<k?p=n:m=n;const x=null!==(o=null===(r=u[m-1])||void 0===r?void 0:r.order)&&void 0!==o?o:"";return I(x,null!==(a=null===(c=u[p+1])||void 0===c?void 0:c.order)&&void 0!==a?a:O.a.charAt(O.a.length-1).repeat(x.length||1),1+p-m,l).map(((e,t)=>({index:u[m+t].index,order:e})))};var k=n(995),x=n(211),T=n(399),j=n(246);const P=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;n.add(t);const i=e.get(t);return null==i||i.forEach((t=>{n.has(t)||P(e,t,n)})),n},D=(e,t,n)=>{const i=P(t,n),s=new Set;return i.forEach((t=>{const n=e.get(t);null==n||n.forEach(s.add,s)})),s},N=e=>function(t,n,i){if((!(arguments.length>3&&void 0!==arguments[3])||arguments[3])&&e.has(i))return e.get(i);const s=D(t,n,i);return e.set(i,s),s};var M=n(191),A=n(155);function L(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function U(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?L(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):L(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const F="mx_active_space",B=[x.a.Home,x.a.Favourites,x.a.People,x.a.Orphans],V=20,K=e=>`mx_space_context_${e}`,$=e=>e.reduce(((e,t)=>(e[t.isSpaceRoom()?0:1].push(t),e)),[[],[]]),H=e=>{if("string"==typeof e&&e.length<=50&&Array.from(e).every((e=>{const t=e.charCodeAt(0);return t>=32&&t<=126})))return e},W=(e,t,n,i)=>{var s;return[null!==(s=H(e))&&void 0!==s?s:NaN,null==i?void 0:i.toLowerCase(),t,n]},q=e=>E.a.instance.getRoomState(e);class G extends u.a{constructor(){var e;super(h.a,{}),e=this,s()(this,"rootSpaces",[]),s()(this,"parentMap",new w.a),s()(this,"notificationStateMap",new Map),s()(this,"roomIdsBySpace",new Map),s()(this,"childSpacesBySpace",new Map),s()(this,"userIdsBySpace",new Map),s()(this,"_aggregatedSpaceCache",{roomIdsBySpace:new Map,userIdsBySpace:new Map}),s()(this,"_activeSpace",x.a.Home),s()(this,"_suggestedRooms",[]),s()(this,"_invitedSpaces",new Set),s()(this,"spaceOrderLocalEchoMap",new Map),s()(this,"_allRoomsInHome",!1),s()(this,"_showSpaceDMBadges",!1),s()(this,"_enabledMetaSpaces",[]),s()(this,"fetchSuggestedRooms",(async function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:V;try{const{rooms:i}=await e.matrixClient.getRoomHierarchy(t.roomId,n,1,!0),s=new w.a;return i.forEach((e=>{e.children_state.forEach((e=>{var t;e.type===r.b.SpaceChild&&null!==(t=e.content.via)&&void 0!==t&&t.length&&e.content.via.forEach((t=>{s.getOrCreate(e.state_key,new Set).add(t)}))}))})),i.filter((t=>{var n;return t.room_type!==r.j.Space&&"join"!==(null===(n=e.matrixClient.getRoom(t.room_id))||void 0===n?void 0:n.getMyMembership())})).map((e=>U(U({},e),{},{viaServers:Array.from(s.get(e.room_id)||[])})))}catch(e){l.a.error(e)}return[]})),s()(this,"getSpaceFilteredRoomIds",(function(t){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return t===x.a.Home&&e.allRoomsInHome?new Set(e.matrixClient.getVisibleRooms().map((e=>e.roomId))):!n||Object(x.h)(t)?e.roomIdsBySpace.get(t)||new Set:e.getAggregatedRoomIdsBySpace(e.roomIdsBySpace,e.childSpacesBySpace,t,i)})),s()(this,"getSpaceFilteredUserIds",(function(t){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!(t===x.a.Home&&e.allRoomsInHome||Object(x.h)(t)))return!n||Object(x.h)(t)?e.userIdsBySpace.get(t)||new Set:e.getAggregatedUserIdsBySpace(e.userIdsBySpace,e.childSpacesBySpace,t,i)})),s()(this,"getAggregatedRoomIdsBySpace",N(this._aggregatedSpaceCache.roomIdsBySpace)),s()(this,"getAggregatedUserIdsBySpace",N(this._aggregatedSpaceCache.userIdsBySpace)),s()(this,"markTreeChildren",((e,t)=>{const n=[e];for(;n.length;){const e=n.pop();t.delete(e),this.getChildSpaces(e.roomId).forEach((e=>{t.has(e)&&n.push(e)}))}})),s()(this,"findRootSpaces",(e=>{const t=new Set(e);e.forEach((e=>{this.getChildSpaces(e.roomId).forEach((e=>{t.delete(e)}))}));const n=Array.from(t),i=new Set(Object(o.sortBy)(e,(e=>e.roomId)));return n.forEach((e=>{this.markTreeChildren(e,i)})),Array.from(i).forEach((e=>{i.has(e)&&(n.push(e),this.markTreeChildren(e,i))})),n})),s()(this,"rebuildSpaceHierarchy",(()=>{const e=this.matrixClient.getVisibleRooms().filter((e=>e.isSpaceRoom())),[t,n]=e.reduce(((e,t)=>{let[n,i]=e;switch(Object(j.b)(t.getMyMembership())){case j.a.Join:n.push(t);break;case j.a.Invite:i.push(t)}return[n,i]}),[[],[]]),i=this.findRootSpaces(t),s=this.rootSpaces;this.rootSpaces=this.sortRootSpaces(i),this.onRoomsUpdate(),Object(f.e)(s,this.rootSpaces)&&this.emit(x.f,this.spacePanelSpaces,this.enabledMetaSpaces);const o=this._invitedSpaces;this._invitedSpaces=new Set(this.sortRootSpaces(n)),Object(_.b)(o,this._invitedSpaces)&&this.emit(x.c,this.invitedSpaces)})),s()(this,"rebuildParentMap",(()=>{const e=this.matrixClient.getVisibleRooms().filter((e=>e.isSpaceRoom()&&"join"===e.getMyMembership()));this.parentMap=new w.a,e.forEach((e=>{this.getChildren(e.roomId).forEach((t=>{this.parentMap.getOrCreate(t.roomId,new Set).add(e.roomId)}))})),M.a.instance.setProperty("numSpaces",e.length)})),s()(this,"rebuildHomeSpace",(()=>{if(this.allRoomsInHome)this.roomIdsBySpace.delete(x.a.Home);else{const e=new Set(this.matrixClient.getVisibleRooms().filter(this.showInHomeSpace).map((e=>e.roomId)));this.roomIdsBySpace.set(x.a.Home,e)}this.activeSpace===x.a.Home&&this.switchSpaceIfNeeded()})),s()(this,"rebuildMetaSpaces",(()=>{const e=new Set(this.enabledMetaSpaces),t=this.matrixClient.getVisibleRooms();if(e.has(x.a.Home)?this.rebuildHomeSpace():this.roomIdsBySpace.delete(x.a.Home),e.has(x.a.Favourites)){const e=t.filter((e=>e.tags[y.a.Favourite]));this.roomIdsBySpace.set(x.a.Favourites,new Set(e.map((e=>e.roomId))))}else this.roomIdsBySpace.delete(x.a.Favourites);if(e.has(x.a.Orphans)||e.has(x.a.Home)){const e=t.filter((e=>{var t;return!(null!==(t=this.parentMap.get(e.roomId))&&void 0!==t&&t.size||g.a.shared().getUserIdForRoomId(e.roomId))}));this.roomIdsBySpace.set(x.a.Orphans,new Set(e.map((e=>e.roomId))))}Object(x.h)(this.activeSpace)&&this.switchSpaceIfNeeded()})),s()(this,"updateNotificationStates",(e=>{const t=new Set(this.enabledMetaSpaces),n=this.matrixClient.getVisibleRooms();let i;t.has(x.a.People)?i=x.a.People:t.has(x.a.Home)&&(i=x.a.Home),e||(e=[...this.roomIdsBySpace.keys()],i===x.a.People&&e.push(x.a.People),t.has(x.a.Home)&&!this.allRoomsInHome&&e.push(x.a.Home)),e.forEach((e=>{if(this.allRoomsInHome&&e===x.a.Home)return;const t=this.getSpaceFilteredRoomIds(e,!0);this.getNotificationState(e).setRooms(n.filter((n=>e===x.a.People?this.isRoomInSpace(x.a.People,n.roomId):!(n.isSpaceRoom()||!t.has(n.roomId))&&(!(!this.showSpaceDMBadges&&i&&g.a.shared().getUserIdForRoomId(n.roomId))||e===i))))})),i!==x.a.People&&this.notificationStateMap.delete(x.a.People)})),s()(this,"showInHomeSpace",(e=>{var t;return!!this.allRoomsInHome||!e.isSpaceRoom()&&!(null!==(t=this.parentMap.get(e.roomId))&&void 0!==t&&t.size&&!g.a.shared().getUserIdForRoomId(e.roomId)&&"invite"!==e.getMyMembership())})),s()(this,"onMemberUpdate",((e,t)=>{const n=G.isInSpace(e.getMember(t));var i,s;n?null===(i=this.userIdsBySpace.get(e.roomId))||void 0===i||i.add(t):null===(s=this.userIdsBySpace.get(e.roomId))||void 0===s||s.delete(t);this._aggregatedSpaceCache.userIdsBySpace.clear();const o=this.getKnownParents(e.roomId,!0);this.emit(e.roomId),o.forEach((e=>this.emit(e))),n||this.switchSpaceIfNeeded()})),s()(this,"onRoomsUpdate",(()=>{const e=this.matrixClient.getVisibleRooms(),t=this.roomIdsBySpace,n=this.userIdsBySpace,i=this.childSpacesBySpace;this.roomIdsBySpace=new Map,this.userIdsBySpace=new Map,this.childSpacesBySpace=new Map,this.rebuildParentMap(),this.rebuildMetaSpaces();const s=new w.a;e.forEach((e=>{"join"===e.getMyMembership()&&this.getParents(e.roomId).forEach((t=>{s.getOrCreate(t.roomId,new Set).add(e.roomId)}))})),this.rootSpaces.forEach((e=>{const t=(e,n)=>{var i,o;if(n.has(e))return;if(this.roomIdsBySpace.has(e)&&this.userIdsBySpace.has(e))return[this.roomIdsBySpace.get(e),this.userIdsBySpace.get(e)];const[r,a]=$(this.getChildren(e));this.childSpacesBySpace.set(e,new Set(r.map((e=>e.roomId))));const c=new Set(a.map((e=>e.roomId))),l=null===(i=this.matrixClient)||void 0===i?void 0:i.getRoom(e),d=new Set(null==l?void 0:l.getMembers().filter((e=>"join"===e.membership||"invite"===e.membership)).map((e=>e.userId))),u=new Set(n).add(e);r.forEach((e=>{t(e.roomId,u)})),null===(o=s.get(e))||void 0===o||o.forEach((e=>{c.add(e)}));const h=new Set(Array.from(c).flatMap((e=>this.matrixClient.getRoomUpgradeHistory(e,!0).map((e=>e.roomId)))));return this.roomIdsBySpace.set(e,h),this.userIdsBySpace.set(e,d),[h,d]};t(e.roomId,new Set)}));const o=Object(w.b)(t,this.roomIdsBySpace),r=Object(w.b)(n,this.userIdsBySpace),a=Object(w.b)(i,this.childSpacesBySpace),c=o.changed.filter((e=>Object(_.b)(t.get(e),this.roomIdsBySpace.get(e)))),l=r.changed.filter((e=>Object(_.b)(n.get(e),this.userIdsBySpace.get(e)))),d=a.changed.filter((e=>Object(_.b)(i.get(e),this.childSpacesBySpace.get(e)))),u=new Set([...o.added,...r.added,...a.added,...o.removed,...r.removed,...a.removed,...c,...l,...d]);Array.from(u).flatMap((e=>[...this.getKnownParents(e,!0)])).forEach((e=>u.add(e))),this._aggregatedSpaceCache.roomIdsBySpace.clear(),this._aggregatedSpaceCache.userIdsBySpace.clear(),u.forEach((e=>{this.emit(e)})),u.has(this.activeSpace)&&this.switchSpaceIfNeeded();const h=[...u];this.enabledMetaSpaces.includes(x.a.People)&&r.added.length+r.removed.length+l.length>0&&h.push(x.a.People),this.updateNotificationStates(h)})),s()(this,"switchSpaceIfNeeded",(function(){var t;let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:A.b.instance.roomViewStore.getRoomId();e.isRoomInSpace(e.activeSpace,n)||null!==(t=e.matrixClient.getRoom(n))&&void 0!==t&&t.isSpaceRoom()||e.switchToRelatedSpace(n)})),s()(this,"switchToRelatedSpace",(e=>{var t;if(this.suggestedRooms.find((t=>t.room_id===e)))return;let n=null===(t=this.getCanonicalParent(e))||void 0===t?void 0:t.roomId;var i;n||(n=null===(i=this.rootSpaces.find((t=>this.isRoomInSpace(t.roomId,e))))||void 0===i?void 0:i.roomId);n||(n=[...this.enabledMetaSpaces].reverse().find((t=>this.isRoomInSpace(t,e)))),n?this.setActiveSpace(n,!1):this.goToFirstSpace()})),s()(this,"onRoom",((e,t,n)=>{const i=e.getMyMembership();if(!i)return;const s=t||i;if(e.isSpaceRoom()){if("invite"===s){const t=this._invitedSpaces.size;this._invitedSpaces.add(e),t!==this._invitedSpaces.size&&this.emit(x.c,this.invitedSpaces)}else if("invite"===n&&"join"!==s)this._invitedSpaces.delete(e)&&this.emit(x.c,this.invitedSpaces);else{var o;this.rebuildSpaceHierarchy(),null===(o=this.parentMap.get(e.roomId))||void 0===o||o.forEach((e=>{this.emit(e)})),this.emit(e.roomId)}"join"===s&&e.roomId===A.b.instance.roomViewStore.getRoomId()?this.setActiveSpace(e.roomId,!1):"leave"===s&&e.roomId===this.activeSpace&&this.goToFirstSpace(!0)}else if(this.onRoomsUpdate(),"join"===s){const n=this._suggestedRooms.length;this._suggestedRooms=this._suggestedRooms.filter((t=>t.room_id!==e.roomId)),n!==this._suggestedRooms.length&&this.emit(x.e,this._suggestedRooms),"join"===t&&e.roomId===A.b.instance.roomViewStore.getRoomId()&&this.switchSpaceIfNeeded(e.roomId)}})),s()(this,"onRoomState",(e=>{const t=this.matrixClient.getRoom(e.getRoomId());if(t)switch(e.getType()){case r.b.SpaceChild:{const n=this.matrixClient.getRoom(e.getStateKey());t.isSpaceRoom()&&(null!=n&&n.isSpaceRoom()?(this.rebuildSpaceHierarchy(),this.emit(n.roomId)):this.onRoomsUpdate(),this.emit(t.roomId)),t.roomId===this.activeSpace&&"join"!==(null==n?void 0:n.getMyMembership())&&e.getPrevContent().suggested!==e.getContent().suggested&&this.loadSuggestedRooms(t);break}case r.b.SpaceParent:t.isSpaceRoom()?this.rebuildSpaceHierarchy():this.onRoomsUpdate(),this.emit(t.roomId);break;case r.b.RoomPowerLevels:t.isSpaceRoom()&&this.onRoomsUpdate()}})),s()(this,"onRoomStateMembers",(e=>{const t=this.matrixClient.getRoom(e.getRoomId()),n=e.getStateKey();null!=t&&t.isSpaceRoom()&&g.a.shared().getDMRoomsForUserId(n).length>0&&e.getPrevContent().membership!==e.getContent().membership&&this.onMemberUpdate(t,n)})),s()(this,"onRoomAccountData",((e,t,n)=>{if(t.isSpaceRoom()&&e.getType()===r.b.SpaceOrder){var i,s;this.spaceOrderLocalEchoMap.delete(t.roomId);(null===(i=e.getContent())||void 0===i?void 0:i.order)!==(null==n||null===(s=n.getContent())||void 0===s?void 0:s.order)&&this.notifyIfOrderChanged()}else if(e.getType()===r.b.Tag){var o,a;const i=(null==n||null===(o=n.getContent())||void 0===o?void 0:o.tags)||{},s=(null===(a=e.getContent())||void 0===a?void 0:a.tags)||{};!!i[y.a.Favourite]!=!!s[y.a.Favourite]&&this.onRoomFavouriteChange(t)}})),s()(this,"onAccountData",((e,t)=>{if(e.getType()===r.b.Direct){var n;const i=new Set(Object.values(null!==(n=null==t?void 0:t.getContent())&&void 0!==n?n:{}).flat()),s=new Set(Object.values(e.getContent()).flat()),o=Object(_.a)(i,s);[...o.added,...o.removed].forEach((e=>{var t;const n=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e);n&&this.onRoomDmChange(n,s.has(e))})),o.removed.length>0&&this.switchSpaceIfNeeded()}})),s()(this,"getSpaceTagOrdering",(e=>{var t,n;return this.spaceOrderLocalEchoMap.has(e.roomId)?this.spaceOrderLocalEchoMap.get(e.roomId):H(null===(t=e.getAccountData(r.b.SpaceOrder))||void 0===t||null===(n=t.getContent())||void 0===n?void 0:n.order)})),p.b.monitorSetting("Spaces.allRoomsInHome",null),p.b.monitorSetting("Spaces.showSpaceDMBadges",null),p.b.monitorSetting("Spaces.enabledMetaSpaces",null),p.b.monitorSetting("Spaces.showPeopleInSpace",null)}get invitedSpaces(){return Array.from(this._invitedSpaces)}get enabledMetaSpaces(){return this._enabledMetaSpaces}get spacePanelSpaces(){return this.rootSpaces}get activeSpace(){return this._activeSpace}get activeSpaceRoom(){var e;return Object(x.h)(this._activeSpace)?null:null===(e=this.matrixClient)||void 0===e?void 0:e.getRoom(this._activeSpace)}get suggestedRooms(){return this._suggestedRooms}get allRoomsInHome(){return this._allRoomsInHome}get showSpaceDMBadges(){return this._showSpaceDMBadges}setActiveRoomInSpace(e){var t,n;if(Object(x.h)(e)||null!==(t=this.matrixClient)&&void 0!==t&&null!==(n=t.getRoom(e))&&void 0!==n&&n.isSpaceRoom())if(e!==this.activeSpace&&this.setActiveSpace(e,!1),e){const t=this.getNotificationState(e).getFirstRoomWithNotifications();h.a.dispatch({action:C.a.ViewRoom,room_id:t,context_switch:!0,metricsTrigger:"WebSpacePanelNotificationBadge"})}else{const e=m.c.instance.orderedLists;for(let t=0;t<k.a.length;t++){const n=e[k.a[t]].find((e=>{if(this.showInHomeSpace(e)){return E.a.instance.getRoomState(e).isUnread}}));if(n){h.a.dispatch({action:C.a.ViewRoom,room_id:n.roomId,context_switch:!0,metricsTrigger:"WebSpacePanelNotificationBadge"});break}}}}setActiveSpace(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e||!this.matrixClient||e===this.activeSpace)return;let n=null;var i;if(Object(x.h)(e)){if(!this.enabledMetaSpaces.includes(e))return}else if(n=this.matrixClient.getRoom(e),null===(i=n)||void 0===i||!i.isSpaceRoom())return;if(window.localStorage.setItem(F,this._activeSpace=e),t){var s,o;const t=window.localStorage.getItem(K(e));p.b.getValue("Spaces.returnToPreviouslyOpenedRoom")&&t&&"invite"!==(null===(s=n)||void 0===s?void 0:s.getMyMembership())&&"join"===(null===(o=this.matrixClient.getRoom(t))||void 0===o?void 0:o.getMyMembership())&&this.isRoomInSpace(e,t)?h.a.dispatch({action:C.a.ViewRoom,room_id:t,context_switch:!0,metricsTrigger:"WebSpaceContextSwitch"}):n?h.a.dispatch({action:C.a.ViewRoom,room_id:e,context_switch:!0,metricsTrigger:"WebSpaceContextSwitch"}):h.a.dispatch({action:C.a.ViewHomePage,context_switch:!0})}this.emit(x.d,this.activeSpace),this.emit(x.e,this._suggestedRooms=[]),n&&(this.loadSuggestedRooms(n),z.instance.traverseSpace(e,(e=>{var t;null===(t=this.matrixClient.getRoom(e))||void 0===t||t.loadMembersIfNeeded()}),!1))}async loadSuggestedRooms(e){const t=await this.fetchSuggestedRooms(e);this._activeSpace===e.roomId&&(this._suggestedRooms=t,this.emit(x.e,this._suggestedRooms))}addRoomToSpace(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return this.matrixClient.sendStateEvent(e.roomId,r.b.SpaceChild,{via:n,suggested:i},t)}getChildren(e){var t;const n=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e),i=null==n?void 0:n.currentState.getStateEvents(r.b.SpaceChild).filter((e=>{var t;return null===(t=e.getContent())||void 0===t?void 0:t.via}));return Object(o.sortBy)(i,(e=>{var t,n;return W(e.getContent().order,e.getTs(),e.getStateKey(),null===(t=this.matrixClient)||void 0===t||null===(n=t.getRoom(e.getStateKey()))||void 0===n?void 0:n.name)})).map((e=>{const t=this.matrixClient.getRoomUpgradeHistory(e.getStateKey(),!0);return t[t.length-1]})).filter((e=>"join"===(null==e?void 0:e.getMyMembership())||"invite"===(null==e?void 0:e.getMyMembership())))||[]}getChildRooms(e){return this.getChildren(e).filter((e=>!e.isSpaceRoom()))}getChildSpaces(e){return this.getChildren(e).filter((e=>e.isSpaceRoom()&&"join"===e.getMyMembership()))}getParents(e){var t,n,i;let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const o=null===(t=this.matrixClient)||void 0===t?void 0:t.getUserId(),a=null===(n=this.matrixClient)||void 0===n?void 0:n.getRoom(e),c=null!==(i=null==a?void 0:a.currentState.getStateEvents(r.b.SpaceParent))&&void 0!==i?i:[];return Object(f.n)(c.map((t=>{const n=t.getContent();if(!Array.isArray(n.via)||s&&!n.canonical)return;const i=this.matrixClient.getRoom(t.getStateKey()),a=null==i?void 0:i.currentState.getStateEvents(r.b.SpaceChild,e);return null==i||!i.currentState.maySendStateEvent(r.b.SpaceChild,o)||a&&!Array.isArray(a.getContent().via)?void 0:i})))}getCanonicalParent(e){var t;const n=this.getParents(e,!0);return(null===(t=Object(o.sortBy)(n,(e=>e.roomId)))||void 0===t?void 0:t[0])||null}getKnownParents(e,t){return t?D(this.parentMap,this.parentMap,e):this.parentMap.get(e)||new Set}isRoomInSpace(e,t){var n,i;let s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(e===x.a.Home&&this.allRoomsInHome)return!0;if(null!==(n=this.getSpaceFilteredRoomIds(e,s))&&void 0!==n&&n.has(t))return!0;const o=g.a.shared().getUserIdForRoomId(t);return!!o&&(e===x.a.Home||e===x.a.People||!(Object(x.h)(e)||null===(i=this.getSpaceFilteredUserIds(e,s))||void 0===i||!i.has(o)||!p.b.getValue("Spaces.showPeopleInSpace",e)))}static isInSpace(e){return"join"===(null==e?void 0:e.membership)||"invite"===(null==e?void 0:e.membership)}notifyIfOrderChanged(){const e=this.sortRootSpaces(this.rootSpaces);Object(f.e)(this.rootSpaces,e)&&(this.rootSpaces=e,this.emit(x.f,this.spacePanelSpaces,this.enabledMetaSpaces))}onRoomFavouriteChange(e){this.enabledMetaSpaces.includes(x.a.Favourites)&&(e.tags[y.a.Favourite]?this.roomIdsBySpace.get(x.a.Favourites).add(e.roomId):this.roomIdsBySpace.get(x.a.Favourites).delete(e.roomId),this.emit(x.a.Favourites))}onRoomDmChange(e,t){const n=new Set(this.enabledMetaSpaces);if(!this.allRoomsInHome&&n.has(x.a.Home)){const t=this.roomIdsBySpace.get(x.a.Home);if(this.showInHomeSpace(e))null==t||t.add(e.roomId);else if(!this.roomIdsBySpace.get(x.a.Orphans).has(e.roomId)){var i;null===(i=this.roomIdsBySpace.get(x.a.Home))||void 0===i||i.delete(e.roomId)}this.emit(x.a.Home)}n.has(x.a.People)&&this.emit(x.a.People),(n.has(x.a.Orphans)||n.has(x.a.Home))&&t&&this.roomIdsBySpace.get(x.a.Orphans).delete(e.roomId)&&(this.emit(x.a.Orphans),this.emit(x.a.Home))}async reset(){this.rootSpaces=[],this.parentMap=new w.a,this.notificationStateMap=new Map,this.roomIdsBySpace=new Map,this.userIdsBySpace=new Map,this._aggregatedSpaceCache.roomIdsBySpace.clear(),this._aggregatedSpaceCache.userIdsBySpace.clear(),this._activeSpace=x.a.Home,this._suggestedRooms=[],this._invitedSpaces=new Set,this._enabledMetaSpaces=[]}async onNotReady(){this.matrixClient&&(this.matrixClient.removeListener(c.b.Room,this.onRoom),this.matrixClient.removeListener(a.d.MyMembership,this.onRoom),this.matrixClient.removeListener(a.d.AccountData,this.onRoomAccountData),this.matrixClient.removeListener(d.b.Events,this.onRoomState),this.matrixClient.removeListener(d.b.Members,this.onRoomStateMembers),this.matrixClient.removeListener(c.b.AccountData,this.onAccountData)),await this.reset()}async onReady(){this.matrixClient.on(c.b.Room,this.onRoom),this.matrixClient.on(a.d.MyMembership,this.onRoom),this.matrixClient.on(a.d.AccountData,this.onRoomAccountData),this.matrixClient.on(d.b.Events,this.onRoomState),this.matrixClient.on(d.b.Members,this.onRoomStateMembers),this.matrixClient.on(c.b.AccountData,this.onAccountData);const e=this._enabledMetaSpaces,t=p.b.getValue("Spaces.enabledMetaSpaces");this._enabledMetaSpaces=B.filter((e=>t[e])),this._allRoomsInHome=p.b.getValue("Spaces.allRoomsInHome"),this._showSpaceDMBadges=p.b.getValue("Spaces.showSpaceDMBadges"),this.sendUserProperties(),this.rebuildSpaceHierarchy(),Object(f.d)(e,this._enabledMetaSpaces)&&this.emit(x.f,this.spacePanelSpaces,this.enabledMetaSpaces);const n=window.localStorage.getItem(F);n&&(Object(x.h)(n)?t[n]:this.matrixClient.getRoom(n))?this.setActiveSpace(n,!1):this.switchSpaceIfNeeded()}sendUserProperties(){const e=new Set(this.enabledMetaSpaces);M.a.instance.setProperty("WebMetaSpaceHomeEnabled",e.has(x.a.Home)),M.a.instance.setProperty("WebMetaSpaceHomeAllRooms",this.allRoomsInHome),M.a.instance.setProperty("WebMetaSpacePeopleEnabled",e.has(x.a.People)),M.a.instance.setProperty("WebMetaSpaceFavouritesEnabled",e.has(x.a.Favourites)),M.a.instance.setProperty("WebMetaSpaceOrphansEnabled",e.has(x.a.Orphans))}goToFirstSpace(){var e,t;let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.setActiveSpace(null!==(e=this.enabledMetaSpaces[0])&&void 0!==e?e:null===(t=this.spacePanelSpaces[0])||void 0===t?void 0:t.roomId,n)}async onAction(e){if(this.matrixClient)switch(e.action){case C.a.ViewRoom:{var t;const n=(null===(t=e.justCreatedOpts)||void 0===t?void 0:t.roomType)===r.j.Space;if(e.context_switch||e.justCreatedOpts&&!n)break;let i=e.room_id;if(e.room_alias&&!i&&(i=Object(T.a)(e.room_alias)),!i)return;const s=this.matrixClient.getRoom(i);null!=s&&s.isSpaceRoom()?this.setActiveSpace(s.roomId,!1):this.switchSpaceIfNeeded(i),window.localStorage.setItem(K(this.activeSpace),e.room_id);break}case C.a.ViewHomePage:!e.context_switch&&this.enabledMetaSpaces.includes(x.a.Home)&&(this.setActiveSpace(x.a.Home,!1),window.localStorage.setItem(K(this.activeSpace),""));break;case C.a.AfterLeaveRoom:Object(x.h)(this._activeSpace)||e.room_id!==this._activeSpace||this.goToFirstSpace(!0);break;case C.a.SwitchSpace:{if(e.num<1||e.num>9)break;const t=this.enabledMetaSpaces.length;e.num<=t?this.setActiveSpace(this.enabledMetaSpaces[e.num-1]):this.spacePanelSpaces.length>e.num-t-1&&this.setActiveSpace(this.spacePanelSpaces[e.num-t-1].roomId);break}case C.a.SettingUpdated:switch(e.settingName){case"Spaces.allRoomsInHome":{const e=p.b.getValue("Spaces.allRoomsInHome");this.allRoomsInHome!==e&&(this._allRoomsInHome=e,this.emit(x.b,this.allRoomsInHome),this.enabledMetaSpaces.includes(x.a.Home)&&this.rebuildHomeSpace(),this.sendUserProperties());break}case"Spaces.showSpaceDMBadges":{const e=p.b.getValue("Spaces.showSpaceDMBadges");this.showSpaceDMBadges!==e&&(this._showSpaceDMBadges=e,this.rebuildSpaceHierarchy());break}case"Spaces.enabledMetaSpaces":{const e=p.b.getValue("Spaces.enabledMetaSpaces"),t=B.filter((t=>e[t]));if(Object(f.d)(this._enabledMetaSpaces,t)){const n=this.enabledMetaSpaces.some((e=>e===x.a.Home||e===x.a.People));this._enabledMetaSpaces=t;const i=this.enabledMetaSpaces.some((e=>e===x.a.Home||e===x.a.People));Object(x.h)(this.activeSpace)&&!e[this.activeSpace]&&this.switchSpaceIfNeeded(),this.rebuildMetaSpaces(),n!==i?this.updateNotificationStates():this.updateNotificationStates(t),this.emit(x.f,this.spacePanelSpaces,this.enabledMetaSpaces),this.sendUserProperties()}break}case"Spaces.showPeopleInSpace":this.emit(e.roomId),this.enabledMetaSpaces.some((e=>e===x.a.Home||e===x.a.People))||this.updateNotificationStates([e.roomId])}}}getNotificationState(e){if(this.notificationStateMap.has(e))return this.notificationStateMap.get(e);const t=new S(q);return this.notificationStateMap.set(e,t),t}traverseSpace(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;if(i&&i.has(e))return;t(e);const s=new Set(i).add(e),[o,r]=$(this.getChildren(e));n&&r.forEach((e=>t(e.roomId))),o.forEach((e=>this.traverseSpace(e.roomId,t,n,s)))}sortRootSpaces(e){return Object(o.sortBy)(e,[this.getSpaceTagOrdering,"roomId"])}async setRootSpaceOrder(e,t){this.spaceOrderLocalEchoMap.set(e.roomId,t);try{await this.matrixClient.setRoomAccountData(e.roomId,r.b.SpaceOrder,{order:t})}catch(n){l.a.warn("Failed to set root space order",n),this.spaceOrderLocalEchoMap.get(e.roomId)===t&&this.spaceOrderLocalEchoMap.delete(e.roomId)}}moveRootSpace(e,t){const n=this.rootSpaces.map(this.getSpaceTagOrdering);R(n,e,t).forEach((e=>{let{index:t,order:n}=e;this.setRootSpaceOrder(this.rootSpaces[t],n)})),this.notifyIfOrderChanged()}}class z{static get instance(){return z.internalInstance}}s()(z,"internalInstance",(()=>{const e=new G;return e.start(),e})()),window.mxSpaceStore=z.instance},function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return l}));var i=n(13),s=n.n(i),o=n(1),r=n(152),a=n(130);let c;!function(e){e.Backward="b",e.Forward="f"}(c||(c={}));class l{static setEventMetadata(e,t,n){var i,s,o,r;null!==(i=e.sender)&&void 0!==i&&null!==(s=i.events)&&void 0!==s&&s.member||(e.sender=t.getSentinelMember(e.getSender())),null!==(o=e.target)&&void 0!==o&&null!==(r=o.events)&&void 0!==r&&r.member||e.getType()!==a.b.RoomMember||(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&n&&(e.forwardLooking=!1)}constructor(e){var t,n;this.eventTimelineSet=e,s()(this,"roomId",void 0),s()(this,"name",void 0),s()(this,"events",[]),s()(this,"baseIndex",0),s()(this,"startState",void 0),s()(this,"endState",void 0),s()(this,"startToken",null),s()(this,"endToken",null),s()(this,"prevTimeline",null),s()(this,"nextTimeline",null),s()(this,"paginationRequests",{[c.Backward]:null,[c.Forward]:null}),this.roomId=null!==(t=null===(n=e.room)||void 0===n?void 0:n.roomId)&&void 0!==t?t:null,this.roomId&&(this.startState=new r.a(this.roomId),this.endState=new r.a(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+(new Date).toISOString()}initialiseState(e){var t,n;let{timelineWasEmpty:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");null===(t=this.startState)||void 0===t||t.setStateEvents(e,{timelineWasEmpty:i}),null===(n=this.endState)||void 0===n||n.setStateEvents(e,{timelineWasEmpty:i})}forkLive(e){const t=this.getState(e),n=new l(this.eventTimelineSet);return n.startState=null==t?void 0:t.clone(),n.endState=t,this.endState=null==t?void 0:t.clone(),n}fork(e){const t=this.getState(e),n=new l(this.eventTimelineSet);return n.startState=null==t?void 0:t.clone(),n.endState=null==t?void 0:t.clone(),n}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==l.BACKWARDS)return this.startState;if(e==l.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===c.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===c.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==l.BACKWARDS)return this.prevTimeline;if(e==l.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==l.BACKWARDS)this.prevTimeline=e;else{if(t!=l.FORWARDS)throw new Error("Invalid direction '"+t+"'");this.nextTimeline=e}this.setPaginationToken(null,t)}addEvent(e,t,n){let i,s=!!t;"object"==typeof t?({toStartOfTimeline:s,roomState:n,timelineWasEmpty:i}=t):void 0!==t&&o.a.warn("Overload deprecated: `EventTimeline.addEvent(event, toStartOfTimeline, roomState?)` is deprecated in favor of the overload with `EventTimeline.addEvent(event, IAddEventOptions)`"),n||(n=s?this.startState:this.endState);const r=this.getTimelineSet();var c;r.room&&(l.setEventMetadata(e,n,s),e.isState()&&r.room.getUnfilteredTimelineSet()===r&&(null===(c=n)||void 0===c||c.setStateEvents([e],{timelineWasEmpty:i}),e.sender&&(e.getType()!==a.b.RoomMember||s)||l.setEventMetadata(e,n,s)));let d;d=s?0:this.events.length,this.events.splice(d,0,e),s&&this.baseIndex++}removeEvent(e){for(let t=this.events.length-1;t>=0;t--){const n=this.events[t];if(n.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,n}return null}toString(){return this.name}}s()(l,"BACKWARDS",c.Backward),s()(l,"FORWARDS",c.Forward)},function(e,t,n){"use strict";n.d(t,"a",(function(){return g})),n.d(t,"b",(function(){return v}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(122),c=n.n(a),l=n(120),d=n.n(l),u=n(225),h=n(127),m=n.n(h);const p=["children","className","kind","inputRef"];let g;!function(e){e.Solid="solid",e.Outline="outline"}(g||(g={}));class v extends d.a.PureComponent{constructor(e){super(e),c()(this,"id",void 0),this.id=this.props.id||"checkbox_"+Object(u.b)(10)}render(){const e=this.props,{children:t,className:n,kind:i=g.Solid,inputRef:o}=e,a=r()(e,p),c=m()("mx_Checkbox",n,{mx_Checkbox_hasKind:i,[`mx_Checkbox_kind_${i}`]:i});return d.a.createElement("span",{className:c},d.a.createElement("input",s()({ref:o,id:this.id},a,{type:"checkbox"})),d.a.createElement("label",{htmlFor:this.id},d.a.createElement("div",{className:"mx_Checkbox_background"},d.a.createElement("div",{className:"mx_Checkbox_checkmark"})),!!this.props.children&&d.a.createElement("div",null,this.props.children)))}}c()(v,"defaultProps",{className:""})},function(e,t,n){"use strict";n.d(t,"k",(function(){return f})),n.d(t,"c",(function(){return b})),n.d(t,"g",(function(){return S})),n.d(t,"a",(function(){return E})),n.d(t,"h",(function(){return C})),n.d(t,"m",(function(){return O})),n.d(t,"f",(function(){return I})),n.d(t,"e",(function(){return R})),n.d(t,"b",(function(){return k})),n.d(t,"l",(function(){return x})),n.d(t,"i",(function(){return T})),n.d(t,"d",(function(){return j})),n.d(t,"j",(function(){return P}));var i=n(144),s=n(130),o=n(1),r=n(189),a=n(30),c=n(207),l=n(171),d=n(123),u=n(377),h=n(126),m=n(125),p=n(319),g=n(129),v=n(264);function f(e){const{status:t}=e;var n;if((!t||t===i.a.SENT)&&!e.isRedacted())if("m.room.message"===e.getType()){const t=e.getContent();if(t.msgtype&&"m.bad.encrypted"!==t.msgtype&&t.hasOwnProperty("body"))return!0}else if("m.sticker"===e.getType()||r.e.matches(e.getType())||r.a.matches(e.getType())||c.b.matches(e.getType())||e.getType()===v.b&&(null===(n=e.getContent())||void 0===n?void 0:n.state)===v.c.Started)return!0;return!1}function b(e){if(!(e.getType()===s.b.RoomMessage||r.e.matches(e.getType()))||e.status===i.a.CANCELLED||e.isRedacted()||e.isRelation(s.h.Replace)||e.getSender()!==d.a.get().getUserId())return!1;const{msgtype:t,body:n}=e.getOriginalContent();return r.e.matches(e.getType())||(t===s.e.Text||t===s.e.Emote)&&!!n&&"string"==typeof n}const y=100;function S(e){let{events:t,isForward:n,fromEventId:i}=e;if(!t.length)return;const s=t.length-1,o=n?1:-1,r=n?0:s;let a=n?s:0;i||(a=Math.min(Math.max(0,r+o*y),s));let c=!i;for(let e=r;e!==a+o;e+=o){const n=t[e];if(c||n.getId()!==i){if(c&&!Object(u.a)(n)&&b(n))return n}else c=!0,a=Math.min(Math.max(0,e+o*y),s)}}let E;!function(e){e.VISIBLE_FOR_ALL="VISIBLE_FOR_ALL",e.HIDDEN_TO_CURRENT_USER="HIDDEN_TO_CURRENT_USER",e.SEE_THROUGH_FOR_CURRENT_USER="SEE_THROUGH_FOR_CURRENT_USER"}(E||(E={}));let w=null;const _=()=>(null===w&&(w=h.b.getValue("feature_msc3531_hide_messages_pending_moderation")),w);function C(e,t){var n,i;if(t=null!==(n=t)&&void 0!==n?n:d.a.get(),!_())return E.VISIBLE_FOR_ALL;if(e.messageVisibility().visible)return E.VISIBLE_FOR_ALL;if((null===(i=e.sender)||void 0===i?void 0:i.userId)===t.getUserId())return E.SEE_THROUGH_FOR_CURRENT_USER;const o=t.getRoom(e.getRoomId());return s.a.name&&null!=o&&o.currentState.maySendStateEvent(s.a.name,t.getUserId())||s.a.altName&&null!=o&&o.currentState.maySendStateEvent(s.a.altName,t.getUserId())?E.SEE_THROUGH_FOR_CURRENT_USER:E.HIDDEN_TO_CURRENT_USER}function O(e){const t=e.getContent();return!!t["org.matrix.msc2516.voice"]||!!t["org.matrix.msc3245.voice"]}async function I(e,t,n){var s;let r;try{const s=await e.fetchRoomEvent(t,n);r=new i.b(s)}catch(e){o.a.warn("Could not find initial event: "+n),r=null}if(e.supportsThreads()&&null!==(s=r)&&void 0!==s&&s.isRelation(l.d.name)&&!r.getThread()){var a;const n=r.threadRootId,i=e.getRoom(t),s=e.getEventMapper(),c=null!==(a=null==i?void 0:i.findEventById(n))&&void 0!==a?a:s(await e.fetchRoomEvent(t,n));try{null==i||i.createThread(n,c,[r],!0)}catch(e){o.a.warn("Could not find root event: "+n)}}return r}function R(e,t,n){b(e)&&(r.e.matches(e.getType())?Object(p.g)(e,n):m.a.dispatch({action:g.a.EditEvent,event:e,timelineRenderingType:t}))}function k(e){return e===i.a.QUEUED||e===i.a.NOT_SENT||e===i.a.ENCRYPTING}const x=e=>{const t=e.getType();return a.c.matches(t)||t===s.b.RoomMessage&&a.c.matches(e.getContent().msgtype)};function T(e){var t;return e.isThreadRoot&&!(null===(t=e.getThread())||void 0===t||!t.length)&&!!e.getThread().replyToEvent}function j(e){return!c.b.matches(e.getType())}const P=(e,t)=>{m.a.dispatch({action:g.a.ViewRoom,event_id:t,highlighted:!0,room_id:e,metricsTrigger:void 0})}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return y}));var i=n(259),s=n(812),o=n(1),r=n(137),a=n(190),c=n(225),l=n(123),d=n(156),u=n(132),h=n(125),m=n(388),p=n(286),g=n(202),v=n(589),f=n(187),b=n(121);class y{static canUserModifyWidgets(e){if(!e)return o.a.warn("No room ID specified"),!1;const t=l.a.get();if(!t)return o.a.warn("User must be be logged in"),!1;const n=t.getRoom(e);if(!n)return o.a.warn(`Room ID ${e} is not recognised`),!1;const i=t.credentials.userId;return i?"join"!==n.getMyMembership()?(o.a.warn(`User ${i} is not in room ${e}`),!1):n.currentState.maySendStateEvent("im.vector.modular.widgets",i):(o.a.warn("Failed to get user ID"),!1)}static isScalarUrl(e){if(!e)return o.a.error("Scalar URL check failed. No URL specified"),!1;const t=i.parse(e);let n=u.b.get().integrations_widgets_urls;if(!n||0===n.length){const e=p.a.sharedInstance().getPrimaryManager();n=e?[e.apiUrl]:[]}for(let e=0;e<n.length;e++){const o=i.parse(n[e]);var s;if(t&&o)if(t.protocol===o.protocol&&t.host===o.host&&null!==(s=t.pathname)&&void 0!==s&&s.startsWith(o.pathname))return!0}return!1}static waitForUserWidget(e,t){return new Promise(((n,i)=>{function s(n){return!!n&&(t?void 0!==n.getContent()[e]:void 0===n.getContent()[e])}if(s(l.a.get().getAccountData("m.widgets")))return void n();function o(e){s(l.a.get().getAccountData("m.widgets"))&&(l.a.get().removeListener(r.ClientEvent.AccountData,o),clearTimeout(a),n())}const a=window.setTimeout((()=>{l.a.get().removeListener(r.ClientEvent.AccountData,o),i(new Error("Timed out waiting for widget ID "+e+" to appear"))}),2e4);l.a.get().on(r.ClientEvent.AccountData,o)}))}static waitForRoomWidget(e,t,n){return new Promise(((i,s)=>{function o(t){const i=null==t?void 0:t.some((t=>t.getContent()&&t.getContent().id===e));return n?!!i:!i}const a=l.a.get().getRoom(t);if(o(null==a?void 0:a.currentState.getStateEvents("im.vector.modular.widgets")))return void i();function c(e){if(e.getRoomId()!==t||"im.vector.modular.widgets"!==e.getType())return;o(null==a?void 0:a.currentState.getStateEvents("im.vector.modular.widgets"))&&(l.a.get().removeListener(r.RoomStateEvent.Events,c),clearTimeout(d),i())}const d=window.setTimeout((()=>{l.a.get().removeListener(r.RoomStateEvent.Events,c),s(new Error("Timed out waiting for widget ID "+e+" to appear"))}),2e4);l.a.get().on(r.RoomStateEvent.Events,c)}))}static setUserWidget(e,t,n,i,s){const r={type:t.preferred,url:n,name:i,data:s},a=l.a.get(),c=Object(f.a)(y.getUserWidgets());try{delete c[e]}catch(e){o.a.error("$widgetId is non-configurable")}const d=Boolean(n);return d&&(c[e]={content:r,sender:a.getUserId(),state_key:e,type:"m.widget",id:e}),a.setAccountData("m.widgets",c).then((()=>y.waitForUserWidget(e,d))).then((()=>{h.a.dispatch({action:"user_widget_updated"})}))}static setRoomWidget(e,t,n,i,s,o,r){let a;return a=Boolean(i)?{type:null==n?void 0:n.legacy,url:i,name:s,data:o,avatar_url:r}:{},y.setRoomWidgetContent(e,t,a)}static setRoomWidgetContent(e,t,n){const i=!!n.url;m.a.setRoomWidgetEcho(e,t,n);return l.a.get().sendStateEvent(e,"im.vector.modular.widgets",n,t).then((()=>y.waitForRoomWidget(t,e,i))).finally((()=>{m.a.removeRoomWidgetEcho(e,t)}))}static getRoomWidgets(e){const t=e.currentState.getStateEvents("im.vector.modular.widgets");return t?t.filter((e=>e.getContent().type&&e.getContent().url)):[]}static getUserWidgets(){const e=l.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");return t&&t.getContent()?t.getContent():{}}static getUserWidgetsArray(){return Object.values(y.getUserWidgets())}static getStickerpickerWidgets(){return y.getUserWidgetsArray().filter((e=>e.content&&"m.stickerpicker"===e.content.type))}static getIntegrationManagerWidgets(){return y.getUserWidgetsArray().filter((e=>e.content&&"m.integration_manager"===e.content.type))}static getRoomWidgetsOfType(e,t){return(y.getRoomWidgets(e)||[]).filter((e=>{const n=e.getContent();return n.url&&t.matches(n.type)}))}static async removeIntegrationManagerWidgets(){const e=l.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const n=t.getContent()||{};Object.entries(n).forEach((e=>{let[t,i]=e;i.content&&"m.integration_manager"===i.content.type&&delete n[t]})),await e.setAccountData("m.widgets",n)}static addIntegrationManagerWidget(e,t,n){return y.setUserWidget("integration_manager_"+(new Date).getTime(),g.a.INTEGRATION_MANAGER,t,"Integration manager: "+e,{api_url:n})}static async removeStickerpickerWidgets(){const e=l.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const n=t.getContent()||{};Object.entries(n).forEach((e=>{let[t,i]=e;i.content&&"m.stickerpicker"===i.content.type&&delete n[t]})),await e.setAccountData("m.widgets",n)}static async addJitsiWidget(t,n,i,o,r){var d;const u=v.a.getInstance().preferredDomain,h=await v.a.getInstance().getJitsiAuth(),m=Object(c.b)(24);let p;p="openidtoken-jwt"===h?s.base32.stringify(e.from(t),{pad:!1}):`Jitsi${Object(c.c)(1)}${Object(c.a)(23)}`;const f=new URL(y.getLocalJitsiWrapperUrl({auth:h}));f.search="",f.searchParams.set("confId",p),await y.setRoomWidget(t,m,g.a.JITSI,f.toString(),i,{conferenceId:p,roomName:null!=r?r:null===(d=l.a.get().getRoom(t))||void 0===d?void 0:d.name,isAudioOnly:n===a.g.Voice,isVideoChannel:o,domain:u,auth:h})}static makeAppConfig(e,t,n,i,s){if(!n)throw new Error("Widgets must be created by someone - provide a senderUserId");return t.creatorUserId=n,t.id=e,t.roomId=i,t.eventId=s,t.name=t.name||t.type,t}static getLocalJitsiWrapperUrl(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const n=["conferenceDomain=$domain","conferenceId=$conferenceId","isAudioOnly=$isAudioOnly","isVideoChannel=$isVideoChannel","displayName=$matrix_display_name","avatarUrl=$matrix_avatar_url","userId=$matrix_user_id","roomId=$matrix_room_id","theme=$theme","roomName=$roomName",`supportsScreensharing=${null===(e=d.a.get())||void 0===e?void 0:e.supportsJitsiScreensharing()}`,"language=$org.matrix.msc2873.client_language"];t.auth&&n.push(`auth=${t.auth}`);const i=n.join("&");let s=window.location.href;"https:"===window.location.protocol||t.forLocalRender||(s="https://app.element.io/");return new URL("jitsi.html#"+i,s).href}static getWidgetName(e){var t;return(null==e||null===(t=e.name)||void 0===t?void 0:t.trim())||Object(b.a)("Unknown App")}static getWidgetDataTitle(e){var t,n;return(null==e||null===(t=e.data)||void 0===t||null===(n=t.title)||void 0===n?void 0:n.trim())||""}static getWidgetUid(e){return e?y.calcWidgetUid(e.id,e.roomId):""}static calcWidgetUid(e,t){return t?`room_${t}_${e}`:`user_${e}`}static editWidget(e,t){var n;null===(n=p.a.sharedInstance().getPrimaryManager())||void 0===n||n.open(e,"type_"+t.type,t.id)}static isManagedByManager(e){if(y.isScalarUrl(e.url)){const e=p.a.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();return y.isScalarUrl(null==t?void 0:t.apiUrl)}}return!1}}}).call(this,n(53).Buffer)},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var i=n(121);let s;function o(e){switch(e){case s.ThreadPanel:return Object(i.a)("Threads");case s.Timeline:return Object(i.a)("Back to chat");case s.RoomSummary:return Object(i.a)("Room information");case s.RoomMemberList:return Object(i.a)("Room members");case s.ThreadView:return Object(i.a)("Back to thread")}return null}!function(e){e.RoomMemberList="RoomMemberList",e.FilePanel="FilePanel",e.NotificationPanel="NotificationPanel",e.RoomMemberInfo="RoomMemberInfo",e.EncryptionPanel="EncryptionPanel",e.RoomSummary="RoomSummary",e.Widget="Widget",e.PinnedMessages="PinnedMessages",e.Timeline="Timeline",e.Room3pidMemberInfo="Room3pidMemberInfo",e.SpaceMemberList="SpaceMemberList",e.SpaceMemberInfo="SpaceMemberInfo",e.Space3pidMemberInfo="Space3pidMemberInfo",e.ThreadView="ThreadView",e.ThreadPanel="ThreadPanel"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return se})),n.d(t,"b",(function(){return oe}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(190),c=n(1),l=n(17),d=n.n(l),u=n(235),h=n(325),m=n(219),p=n(521),g=n(123),v=n(128),f=n(121),b=n(125),y=n(183),S=n(126),E=n(202),w=n(138),_=n(157),C=n(145),O=n(239),I=n(270),R=n(2),k=n(158),x=n(129),T=n(397),j=n(245),P=n(210),D=n(388),N=n(132);function M(){var e;return N.b.get().widget_build_url?N.b.get().widget_build_url:null===(e=Object(j.b)())||void 0===e?void 0:e.widget_build_url}var A=n(221),L=n(127),U=n.n(L),F=n(165),B=n(148),V=n(124);class K extends r.a.Component{constructor(e){super(e),s()(this,"componentDidMount",(()=>{oe.instance.addListener(se.SilencedCallsChanged,this.onSilencedCallsChanged)})),s()(this,"onSilencedCallsChanged",(()=>{this.setState({silenced:oe.instance.isCallSilenced(this.props.call.callId)})})),s()(this,"onAnswerClick",(e=>{e.stopPropagation(),oe.instance.answerCall(oe.instance.roomIdForCall(this.props.call))})),s()(this,"onRejectClick",(e=>{e.stopPropagation(),oe.instance.hangupOrReject(oe.instance.roomIdForCall(this.props.call),!0)})),s()(this,"onSilenceClick",(e=>{e.stopPropagation();const t=this.props.call.callId;this.state.silenced?oe.instance.unSilenceCall(t):oe.instance.silenceCall(t)})),this.state={silenced:oe.instance.isCallSilenced(this.props.call.callId)}}componentWillUnmount(){oe.instance.removeListener(se.SilencedCallsChanged,this.onSilencedCallsChanged)}render(){const e=this.props.call,t=g.a.get().getRoom(oe.instance.roomIdForCall(e)),n=e.type===a.g.Voice,i=oe.instance.isForcedSilent();let s=this.state.silenced?Object(f.a)("Sound on"):Object(f.a)("Silence call");i&&(s=Object(f.a)("Notifications silenced"));const o=U()("mx_IncomingLegacyCallToast_content",{mx_IncomingLegacyCallToast_content_voice:n,mx_IncomingLegacyCallToast_content_video:!n}),c=U()("mx_IncomingLegacyCallToast_iconButton",{mx_IncomingLegacyCallToast_unSilence:this.state.silenced,mx_IncomingLegacyCallToast_silence:!this.state.silenced});return r.a.createElement(r.a.Fragment,null,r.a.createElement(F.a,{room:null!=t?t:void 0,height:32,width:32}),r.a.createElement("div",{className:o},r.a.createElement("span",{className:"mx_LegacyCallEvent_caller"},t?t.name:Object(f.a)("Unknown caller")),r.a.createElement("div",{className:"mx_LegacyCallEvent_type"},r.a.createElement("div",{className:"mx_LegacyCallEvent_type_icon"}),n?Object(f.a)("Voice call"):Object(f.a)("Video call")),r.a.createElement("div",{className:"mx_IncomingLegacyCallToast_buttons"},r.a.createElement(V.a,{className:"mx_IncomingLegacyCallToast_button mx_IncomingLegacyCallToast_button_decline",onClick:this.onRejectClick,kind:"danger"},r.a.createElement("span",null," ",Object(f.a)("Decline")," ")),r.a.createElement(V.a,{className:"mx_IncomingLegacyCallToast_button mx_IncomingLegacyCallToast_button_accept",onClick:this.onAnswerClick,kind:"primary"},r.a.createElement("span",null," ",Object(f.a)("Accept")," ")))),r.a.createElement(B.a,{className:c,disabled:i,onClick:this.onSilenceClick,title:s}))}}var $=n(194),H=n(459),W=n(624),q=n(309),G=n(860),z=n(398),J=n(155),Y=n(862);const Q="m.protocol.pstn",X="im.vector.protocol.pstn",Z="im.vector.protocol.sip_native",ee="im.vector.protocol.sip_virtual",te=["error","emptied","stalled","suspend","waiting"],ne=[...te,"play","pause","playing","ended","loadeddata","loadedmetadata","canplay","canplaythrough","volumechange"];let ie;!function(e){e.Ring="ringAudio",e.Ringback="ringbackAudio",e.CallEnd="callendAudio",e.Busy="busyAudio"}(ie||(ie={}));let se;!function(e){e.CallsChanged="calls_changed",e.CallChangeRoom="call_change_room",e.SilencedCallsChanged="silenced_calls_changed",e.CallState="call_state"}(se||(se={}));class oe extends d.a{constructor(){super(...arguments),s()(this,"calls",new Map),s()(this,"transferees",new Map),s()(this,"audioPromises",new Map),s()(this,"audioElementsWithListeners",new Map),s()(this,"supportsPstnProtocol",null),s()(this,"pstnSupportPrefixed",null),s()(this,"supportsSipNativeVirtual",null),s()(this,"assertedIdentityNativeUsers",new Map),s()(this,"silencedCalls",new Set),s()(this,"onCallIncoming",(e=>{if(!g.a.get().supportsVoip())return;const t=oe.instance.roomIdForCall(e);if(this.getCallForRoom(t))return void c.a.log("Got incoming call for room "+t+" but there's already a call for this room: ignoring");this.addCallForRoom(t,e),this.setCallListeners(e),this.onCallStateChanged(e.state,null,e);const n=g.a.get();n.prepareToEncrypt(n.getRoom(e.roomId))})),s()(this,"onCallStateChanged",((e,t,n)=>{if(!this.matchesCallForThisRoom(n))return;const i=this.roomIdForCall(n);switch(this.setCallState(n,e),b.a.dispatch({action:"call_state",room_id:i,state:e}),t){case a.f.Ringing:this.pause(ie.Ring);break;case a.f.InviteSent:this.pause(ie.Ringback)}switch(e!==a.f.Ringing&&this.silencedCalls.delete(n.callId),e){case a.f.Ringing:{const e=new h.a(g.a.get()).getPushRuleById(u.f.IncomingCall),t=null==e?void 0:e.enabled,i=null==e?void 0:e.actions.some((e=>e.set_tweak===u.g.Sound&&"ring"===e.value));t&&i&&!this.isForcedSilent()?this.play(ie.Ring):this.silenceCall(n.callId);break}case a.f.InviteSent:this.play(ie.Ringback);break;case a.f.Ended:{const e=n.hangupReason;if(this.removeCallForRoom(i),t===a.f.InviteSent&&n.hangupParty===a.e.Remote){if(this.play(ie.Busy),!e||[a.c.UserHangup,"user hangup"].includes(e))break;let t,i;n.hangupReason===a.c.UserBusy?(t=Object(f.a)("User Busy"),i=Object(f.a)("The user you called is busy.")):(t=Object(f.a)("Call Failed"),i=Object(f.a)("The call could not be established")),v.b.createDialog(C.a,{title:t,description:i})}else e===a.c.AnsweredElsewhere&&t===a.f.Connecting?v.b.createDialog(C.a,{title:Object(f.a)("Answered Elsewhere"),description:Object(f.a)("The call was answered on another device.")}):t!==a.f.Fledgling&&t!==a.f.Ringing&&this.play(ie.CallEnd);this.logCallStats(n,i);break}}}))}static get instance(){return window.mxLegacyCallHandler||(window.mxLegacyCallHandler=new oe),window.mxLegacyCallHandler}roomIdForCall(e){var t,n;if(!e)return null;if(this.shouldObeyAssertedfIdentity()){const t=this.assertedIdentityNativeUsers.get(e.callId);if(t){const e=Object(q.a)(g.a.get(),t);if(e)return e.roomId}}return null!==(t=null!==(n=T.a.sharedInstance().nativeRoomForVirtualRoom(e.roomId))&&void 0!==n?n:e.roomId)&&void 0!==t?t:null}start(){navigator.mediaSession&&(navigator.mediaSession.setActionHandler("play",(function(){})),navigator.mediaSession.setActionHandler("pause",(function(){})),navigator.mediaSession.setActionHandler("seekbackward",(function(){})),navigator.mediaSession.setActionHandler("seekforward",(function(){})),navigator.mediaSession.setActionHandler("previoustrack",(function(){})),navigator.mediaSession.setActionHandler("nexttrack",(function(){}))),S.b.getValue(k.b.Voip)&&g.a.get().on(p.b.Incoming,this.onCallIncoming),this.checkProtocols(3),Object.values(ie).forEach((e=>{const t=document.getElementById(e);t?this.addEventListenersForAudioElement(t):c.a.warn(`LegacyCallHandler: missing <audio id="${e}"> from page`)}))}stop(){const e=g.a.get();e&&e.removeListener(p.b.Incoming,this.onCallIncoming),Array.from(this.audioElementsWithListeners.keys()).forEach((e=>{this.removeEventListenersForAudioElement(e)}))}addEventListenersForAudioElement(e){this.audioElementsWithListeners.get(e)||ne.forEach((t=>{e.addEventListener(t,this),this.audioElementsWithListeners.set(e,!0)}))}removeEventListenersForAudioElement(e){ne.forEach((t=>{e.removeEventListener(t,this)}))}handleEvent(e){const t=e.target,n=null==t?void 0:t.id;te.includes(e.type)?c.a.error(`LegacyCallHandler: encountered "${e.type}" event with <audio id="${n}">`,e):ne.includes(e.type)&&function(){if(S.b.getValue("debug_legacy_call_handler")){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];c.a.log.call(console,"LegacyCallHandler debuglog:",...t)}}(`encountered "${e.type}" event with <audio id="${n}">`,e)}isForcedSilent(){const e=g.a.get();return Object(z.e)(e)}silenceCall(e){this.silencedCalls.add(e),this.emit(se.SilencedCallsChanged,this.silencedCalls),this.areAnyCallsUnsilenced()||this.pause(ie.Ring)}unSilenceCall(e){this.isForcedSilent()||(this.silencedCalls.delete(e),this.emit(se.SilencedCallsChanged,this.silencedCalls),this.play(ie.Ring))}isCallSilenced(e){return this.isForcedSilent()||this.silencedCalls.has(e)}areAnyCallsUnsilenced(){for(const e of this.calls.values())if(e.state===a.f.Ringing&&!this.isCallSilenced(e.callId))return!0;return!1}async checkProtocols(e){try{const e=await g.a.get().getThirdpartyProtocols();void 0!==e[Q]?(this.supportsPstnProtocol=Boolean(e[Q]),this.supportsPstnProtocol&&(this.pstnSupportPrefixed=!1)):void 0!==e[X]?(this.supportsPstnProtocol=Boolean(e[X]),this.supportsPstnProtocol&&(this.pstnSupportPrefixed=!0)):this.supportsPstnProtocol=null,b.a.dispatch({action:x.a.PstnSupportUpdated}),void 0!==e[Z]&&void 0!==e[ee]&&(this.supportsSipNativeVirtual=Boolean(e[Z]&&e[ee])),b.a.dispatch({action:x.a.VirtualRoomSupportUpdated})}catch(t){1===e?c.a.log("Failed to check for protocol support and no retries remain: assuming no support",t):(c.a.log("Failed to check for protocol support: will retry",t),window.setTimeout((()=>{this.checkProtocols(e-1)}),1e4))}}shouldObeyAssertedfIdentity(){var e;return!(null===(e=N.b.getObject("voip"))||void 0===e||!e.get("obey_asserted_identity"))}getSupportsPstnProtocol(){return this.supportsPstnProtocol}getSupportsVirtualRooms(){return this.supportsSipNativeVirtual}async pstnLookup(e){try{return await g.a.get().getThirdpartyUser(this.pstnSupportPrefixed?X:Q,{"m.id.phone":e})}catch(e){return c.a.warn("Failed to lookup user from phone number",e),Promise.resolve([])}}async sipVirtualLookup(e){try{return await g.a.get().getThirdpartyUser(ee,{native_mxid:e})}catch(e){return c.a.warn("Failed to query SIP identity for user",e),Promise.resolve([])}}async sipNativeLookup(e){try{return await g.a.get().getThirdpartyUser(Z,{virtual_mxid:e})}catch(e){return c.a.warn("Failed to query identity for SIP user",e),Promise.resolve([])}}getCallById(e){for(const t of this.calls.values())if(t.callId===e)return t;return null}getCallForRoom(e){return this.calls.get(e)||null}getAnyActiveCall(){for(const e of this.calls.values())if(e.state!==a.f.Ended)return e;return null}getAllActiveCalls(){const e=[];for(const t of this.calls.values())t.state!==a.f.Ended&&t.state!==a.f.Ringing&&e.push(t);return e}getAllActiveCallsNotInRoom(e){const t=[];for(const[n,i]of this.calls.entries())n!==e&&i.state!==a.f.Ended&&t.push(i);return t}getAllActiveCallsForPip(e){const t=g.a.get().getRoom(e);return P.d.instance.hasMaximisedWidget(t)?this.getAllActiveCalls():this.getAllActiveCallsNotInRoom(e)}getTransfereeForCallId(e){return this.transferees.get(e)}play(e){const t=`LegacyCallHandler.play(${e}):`;c.a.debug(`${t} beginning of function`);const n=document.getElementById(e);if(n){this.addEventListenersForAudioElement(n);const i=async()=>{try{n.muted&&(c.a.error(`${t} <audio> element was unexpectedly muted but we recovered gracefully by unmuting it`),n.muted=!1),c.a.debug(`${t} attempting to play audio at volume=${n.volume}`),await n.play(),c.a.debug(`${t} playing audio successfully`)}catch(e){c.a.warn(`${t} unable to play audio clip`,e)}};this.audioPromises.has(e)?this.audioPromises.set(e,this.audioPromises.get(e).then((()=>(n.load(),i())))):this.audioPromises.set(e,i())}else c.a.warn(`${t} unable to find <audio> element for ${e}`)}pause(e){const t=`LegacyCallHandler.pause(${e}):`;c.a.debug(`${t} beginning of function`);const n=document.getElementById(e),i=()=>{c.a.debug(`${t} pausing audio`),n.pause()};n?this.audioPromises.has(e)?this.audioPromises.set(e,this.audioPromises.get(e).then(i)):i():c.a.warn(`${t} unable to find <audio> element for ${e}`)}matchesCallForThisRoom(e){const t=this.roomIdForCall(e),n=this.getCallForRoom(t);return!!n&&e.callId===n.callId}setCallListeners(e){let t=this.roomIdForCall(e);e.on(a.d.Error,(t=>{this.matchesCallForThisRoom(e)&&(c.a.error("Call error:",t),t.code!==a.c.NoUserMedia?0!==g.a.get().getTurnServers().length||null!==S.b.getValue("fallbackICEServerAllowed")?v.b.createDialog(C.a,{title:Object(f.a)("Call Failed"),description:t.message}):this.showICEFallbackPrompt():this.showMediaCaptureError(e))})),e.on(a.d.Hangup,(()=>{this.matchesCallForThisRoom(e)&&this.removeCallForRoom(t)})),e.on(a.d.State,((t,n)=>{this.onCallStateChanged(t,n,e)})),e.on(a.d.Replaced,(n=>{this.matchesCallForThisRoom(e)&&(c.a.log(`Call ID ${e.callId} is being replaced by call ID ${n.callId}`),e.state===a.f.Ringing?this.pause(ie.Ring):e.state===a.f.InviteSent&&this.pause(ie.Ringback),this.removeCallForRoom(t),this.addCallForRoom(t,n),this.setCallListeners(n),this.setCallState(n,n.state))})),e.on(a.d.AssertedIdentityChanged,(async()=>{var n;if(!this.matchesCallForThisRoom(e))return;if(c.a.log(`Call ID ${e.callId} got new asserted identity:`,e.getRemoteAssertedIdentity()),!this.shouldObeyAssertedfIdentity())return void c.a.log("asserted identity not enabled in config: ignoring");const i=null===(n=e.getRemoteAssertedIdentity())||void 0===n?void 0:n.id;let s=i;if(i){const e=await this.sipNativeLookup(i);e.length&&e[0].fields.lookup_success&&(s=e[0].userid)}if(c.a.log(`Asserted identity ${i} mapped to ${s}`),s){this.assertedIdentityNativeUsers.set(e.callId,s),await Object(A.c)(g.a.get(),s);const n=this.roomIdForCall(e);c.a.log(`Old room ID: ${t}, new room ID: ${n}`),n!==t&&(this.removeCallForRoom(t),t=n,c.a.log("Moving call to room "+t),this.addCallForRoom(t,e,!0))}}))}async logCallStats(e,t){const n=await e.getCurrentCallStats();if(c.a.debug(`Call completed. Call ID: ${e.callId}, virtual room ID: ${e.roomId}, user-facing room ID: ${t}, direction: ${e.direction}, our Party ID: ${e.ourPartyId}, hangup party: ${e.hangupParty}, hangup reason: ${e.hangupReason}`),n){c.a.debug("Local candidates:");for(const e of n.filter((e=>"local-candidate"===e.type))){const t=e.address||e.ip;c.a.debug(`${e.id} - type: ${e.candidateType}, address: ${t}, port: ${e.port}, protocol: ${e.protocol}, relay protocol: ${e.relayProtocol}, network type: ${e.networkType}`)}c.a.debug("Remote candidates:");for(const e of n.filter((e=>"remote-candidate"===e.type))){const t=e.address||e.ip;c.a.debug(`${e.id} - type: ${e.candidateType}, address: ${t}, port: ${e.port}, protocol: ${e.protocol}`)}c.a.debug("Candidate pairs:");for(const e of n.filter((e=>"candidate-pair"===e.type)))c.a.debug(`${e.localCandidateId} / ${e.remoteCandidateId} - state: ${e.state}, nominated: ${e.nominated}, requests sent ${e.requestsSent}, requests received  ${e.requestsReceived},  responses received: ${e.responsesReceived}, responses sent: ${e.responsesSent}, bytes received: ${e.bytesReceived}, bytes sent: ${e.bytesSent}, `);c.a.debug("Outbound RTP:");for(const e of n.filter((e=>"outbound-rtp"===e.type)))c.a.debug(e);c.a.debug("Inbound RTP:");for(const e of n.filter((e=>"inbound-rtp"===e.type)))c.a.debug(e)}else c.a.debug("Call statistics are undefined. The call has probably failed before a peerConn was established")}setCallState(e,t){const n=oe.instance.roomIdForCall(e);c.a.log(`Call state in ${n} changed to ${t}`);const i=`call_${e.callId}`;t===a.f.Ringing?$.a.sharedInstance().addOrReplaceToast({key:i,priority:100,component:K,bodyClassName:"mx_IncomingLegacyCallToast",props:{call:e}}):$.a.sharedInstance().dismissToast(i),this.emit(se.CallState,n,t)}removeCallForRoom(e){c.a.log("Removing call for room ",e),this.calls.delete(e),this.emit(se.CallsChanged,this.calls)}showICEFallbackPrompt(){const e=g.a.get(),t=e=>r.a.createElement("code",null,e);v.b.createDialog(_.a,{title:Object(f.a)("Call failed due to misconfigured server"),description:r.a.createElement("div",null,r.a.createElement("p",null,Object(f.a)("Please ask the administrator of your homeserver (<code>%(homeserverDomain)s</code>) to configure a TURN server in order for calls to work reliably.",{homeserverDomain:e.getDomain()},{code:t})),r.a.createElement("p",null,Object(f.a)("Alternatively, you can try to use the public server at <code>turn.matrix.org</code>, but this will not be as reliable, and it will share your IP address with that server. You can also manage this in Settings.",void 0,{code:t}))),button:Object(f.a)("Try using turn.matrix.org"),cancelButton:Object(f.a)("OK"),onFinished:t=>{S.b.setValue("fallbackICEServerAllowed",null,w.a.DEVICE,t),e.setFallbackICEServerAllowed(t)}},void 0,!0)}showMediaCaptureError(e){let t,n;e.type===a.g.Voice?(t=Object(f.a)("Unable to access microphone"),n=r.a.createElement("div",null,Object(f.a)("Call failed because microphone could not be accessed. Check that a microphone is plugged in and set up correctly."))):e.type===a.g.Video&&(t=Object(f.a)("Unable to access webcam / microphone"),n=r.a.createElement("div",null,Object(f.a)("Call failed because webcam or microphone could not be accessed. Check that:"),r.a.createElement("ul",null,r.a.createElement("li",null,Object(f.a)("A microphone and webcam are plugged in and set up correctly")),r.a.createElement("li",null,Object(f.a)("Permission is granted to use the webcam")),r.a.createElement("li",null,Object(f.a)("No other application is using the webcam"))))),v.b.createDialog(C.a,{title:t,description:n},void 0,!0)}async placeMatrixCall(e,t,n){const i=await T.a.sharedInstance().getOrCreateVirtualRoomForRoom(e)||e;if(c.a.debug("Mapped real room "+e+" to room ID "+i),i!==e){const e=g.a.get().getRoom(i);e.getPendingEvents().length>0&&H.a.cancelUnsentEvents(e)}const s=g.a.get().getTurnServersExpiry()-Date.now();c.a.log("Current turn creds expire in "+s+" ms");const o=g.a.get().createCall(i);try{this.addCallForRoom(e,o)}catch(e){return void v.b.createDialog(C.a,{title:Object(f.a)("Already in call"),description:Object(f.a)("You're already in a call with this person.")})}n&&this.transferees.set(o.callId,n),this.setCallListeners(o),this.setActiveCallRoomId(e),t===a.g.Voice?o.placeVoiceCall():"video"===t?o.placeVideoCall():c.a.error("Unknown conf call type: "+t)}async placeCall(e,t,n){var i;if(null===(i=J.b.instance.voiceBroadcastPlaybacksStore.getCurrent())||void 0===i||i.pause(),J.b.instance.voiceBroadcastRecordingsStore.getCurrent())return void Object(Y.a)();if(M())return void await async function(e){const t=g.a.get().getRoom(e);if(!t)return;if(!y.a.canUserModifyWidgets(e))return void c.a.error(`User not allowed to modify widgets in ${e}`);const n=M();if(!n)return;let i;try{const t=await fetch(`${n}?roomId=${e}`);i=await t.json()}catch(t){return void c.a.error(`Managed hybrid widget builder failed for room ${e}`,t)}if(!i)return;const{widget_id:s,widget:o,layout:r}=i;let a=O.a.instance.getApps(e);if(a.some((e=>e.id===s))||D.a.roomHasPendingWidgets(e,[]))return void c.a.error(`Managed hybrid widget already present in room ${e}`);try{await y.a.setRoomWidgetContent(e,s,o)}catch(t){return void c.a.error(`Unable to add managed hybrid widget in room ${e}`,t)}if(!P.d.instance.canCopyLayoutToRoom(t))return;a=O.a.instance.getApps(e);const l=a.find((e=>e.id===s));l&&(P.d.instance.moveToContainer(t,l,r.container),P.d.instance.setContainerHeight(t,r.container,r.height),P.d.instance.copyLayoutToRoom(t))}(e);if(!g.a.get().supportsVoip())return void v.b.createDialog(C.a,{title:Object(f.a)("Calls are unsupported"),description:Object(f.a)("You cannot place calls in this browser.")});if(g.a.get().getSyncState()===m.b.Error)return void v.b.createDialog(C.a,{title:Object(f.a)("Connectivity to the server has been lost"),description:Object(f.a)("You cannot place calls without a connection to the server.")});if(this.getAllActiveCalls().length>1)return void v.b.createDialog(C.a,{title:Object(f.a)("Too Many Calls"),description:Object(f.a)("You've reached the maximum number of simultaneous calls.")});const s=g.a.get().getRoom(e);if(!s)return void c.a.error(`Room ${e} does not exist.`);const o=Object(G.a)(s);o.length<=1?v.b.createDialog(C.a,{description:Object(f.a)("You cannot place a call with yourself.")}):2===o.length?(c.a.info(`Place ${t} call in ${e}`),await this.placeMatrixCall(e,t,n)):await this.placeJitsiCall(e,t)}hangupAllCalls(){for(const e of this.calls.values())this.stopRingingIfPossible(e.callId),e.hangup(a.c.UserHangup,!1)}hangupOrReject(e,t){const n=this.calls.get(e);n&&(this.stopRingingIfPossible(n.callId),t?n.reject():n.hangup(a.c.UserHangup,!1))}answerCall(e){if(!this.calls.has(e))return;const t=this.calls.get(e);this.stopRingingIfPossible(t.callId),this.getAllActiveCalls().length>1?v.b.createDialog(C.a,{title:Object(f.a)("Too Many Calls"),description:Object(f.a)("You've reached the maximum number of simultaneous calls.")}):(t.answer(),this.setActiveCallRoomId(e),b.a.dispatch({action:x.a.ViewRoom,room_id:e,metricsTrigger:"WebAcceptCall"}))}stopRingingIfPossible(e){this.silencedCalls.delete(e),this.areAnyCallsUnsilenced()||this.pause(ie.Ring)}async dialNumber(e,t){const n=await this.pstnLookup(e);if(!n||0===n.length||!n[0].userid)return void v.b.createDialog(C.a,{title:Object(f.a)("Unable to look up phone number"),description:Object(f.a)("There was an error looking up the phone number")});const i=n[0].userid;let s;if(this.getSupportsVirtualRooms()){const t=await this.sipNativeLookup(i);s=t.length>0&&t[0].fields.lookup_success?t[0].userid:i,c.a.log("Looked up "+e+" to "+i+" and mapped to native user "+s)}else s=i;const o=await Object(A.c)(g.a.get(),s);b.a.dispatch({action:x.a.ViewRoom,room_id:o,metricsTrigger:"WebDialPad"}),await this.placeMatrixCall(o,a.g.Voice,t)}async startTransferToPhoneNumber(e,t,n){if(n)return void this.dialNumber(t,e);const i=await this.pstnLookup(t);i&&0!==i.length&&i[0].userid?await this.startTransferToMatrixID(e,i[0].userid,n):v.b.createDialog(C.a,{title:Object(f.a)("Unable to transfer call"),description:Object(f.a)("There was an error looking up the phone number")})}async startTransferToMatrixID(e,t,n){if(n){const n=await Object(A.c)(g.a.get(),t);this.placeCall(n,e.type,e),b.a.dispatch({action:x.a.ViewRoom,room_id:n,should_peek:!1,joining:!1,metricsTrigger:void 0})}else try{await e.transfer(t)}catch(e){c.a.log("Failed to transfer call",e),v.b.createDialog(C.a,{title:Object(f.a)("Transfer Failed"),description:Object(f.a)("Failed to transfer call")})}}setActiveCallRoomId(e){c.a.info("Setting call in room "+e+" active");for(const[t,n]of this.calls.entries())n.state!==a.f.Ended&&(t===e?n.setRemoteOnHold(!1):(c.a.info("Holding call in room "+t+" because another call is being set active"),n.setRemoteOnHold(!0)))}hasAnyUnheldCall(){for(const e of this.calls.values())if(e.state!==a.f.Ended&&!e.isRemoteOnHold())return!0;return!1}async placeJitsiCall(e,t){const n=g.a.get();c.a.info(`Place conference call in ${e}`),b.a.dispatch({action:"appsDrawer",show:!0});const i=O.a.instance.getApps(e).find((e=>E.a.JITSI.matches(e.type)));if(i)P.d.instance.moveToContainer(n.getRoom(e),i,P.a.Top);else try{await y.a.addJitsiWidget(e,t,"Jitsi",!1),c.a.log("Jitsi widget added")}catch(e){"M_FORBIDDEN"===e.errcode&&v.b.createDialog(C.a,{title:Object(f.a)("Permission Required"),description:Object(f.a)("You do not have permission to start a conference call in this room")}),c.a.error(e)}}hangupCallApp(e){c.a.info("Leaving conference call in "+e);const t=O.a.instance.getRoom(e);if(!t)return;t.widgets.filter((e=>E.a.JITSI.matches(e.type))).forEach((e=>{const t=I.a.instance.getMessagingForUid(y.a.getWidgetUid(e));t&&t.transport.send(R.a.HangupCall,{})}))}showTransferDialog(e){e.setRemoteOnHold(!0),b.a.dispatch({action:x.a.OpenInviteDialog,kind:W.a.CallTransfer,call:e,analyticsName:"Transfer Call",className:"mx_InviteDialog_transferWrapper",onFinishedCallback:t=>{0!==t.length&&!1!==t[0]||e.setRemoteOnHold(!1)}})}addCallForRoom(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.calls.has(e))throw c.a.log(`Couldn't add call to room ${e}: already have a call for this room`),new Error("Already have a call for room "+e);c.a.log("setting call for room "+e),this.calls.set(e,t),n?this.emit(se.CallChangeRoom,t):this.emit(se.CallsChanged,this.calls)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return u}));var i=n(13),s=n.n(i),o=n(359),r=n(16),a=n(1),c=n(159),l=n(130);let d;!function(e){e.Membership="RoomMember.membership",e.Name="RoomMember.name",e.PowerLevel="RoomMember.powerLevel",e.Typing="RoomMember.typing"}(d||(d={}));class u extends c.b{constructor(e,t){super(),this.roomId=e,this.userId=t,s()(this,"_isOutOfBand",!1),s()(this,"modified",-1),s()(this,"requestedProfileInfo",!1),s()(this,"typing",!1),s()(this,"name",void 0),s()(this,"rawDisplayName",void 0),s()(this,"powerLevel",0),s()(this,"powerLevelNorm",0),s()(this,"user",void 0),s()(this,"membership",void 0),s()(this,"disambiguate",!1),s()(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var n,i;const s=null!==(n=e.getDirectionalContent().displayname)&&void 0!==n?n:"";if(e.getType()!==l.b.RoomMember)return;this._isOutOfBand=!1,this.events.member=e;const o=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&a.a.trace(`membership event with membership undefined (forwardLooking: ${e.forwardLooking})!`,e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=function(e,t,n){if(!t||t===e)return!1;if(!r.J(t))return!1;if(!n)return!1;if(h.test(t))return!0;if(m.test(t))return!0;const i=n.getUserIdsWithDisplayName(t);return!!i.some((t=>t!==e))}(this.userId,s,t);const c=this.name;this.name=function(e,t,n){return t&&t!==e?n?r.H(t)+" ("+e+")":r.J(t)?r.H(t):e:e}(this.userId,s,this.disambiguate),this.rawDisplayName=r.H(null!==(i=e.getDirectionalContent().displayname)&&void 0!==i?i:""),this.rawDisplayName&&r.J(this.rawDisplayName)||(this.rawDisplayName=this.userId),o!==this.membership&&(this.updateModifiedTime(),this.emit(d.Membership,e,this,o)),c!==this.name&&(this.updateModifiedTime(),this.emit(d.Name,e,this,c))}setPowerLevelEvent(e){if(e.getType()!==l.b.RoomPowerLevels||""!==e.getStateKey())return;const t=e.getDirectionalContent();let n=t.users_default||0;const i=t.users||{};Object.values(i).forEach((e=>{n=Math.max(n,e)}));const s=this.powerLevel,o=this.powerLevelNorm;void 0!==i[this.userId]&&Number.isInteger(i[this.userId])?this.powerLevel=i[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,n>0&&(this.powerLevelNorm=100*this.powerLevel/n),s===this.powerLevel&&o===this.powerLevelNorm||(this.updateModifiedTime(),this.emit(d.PowerLevel,e,this))}setTypingEvent(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const n=e.getContent().user_ids;Array.isArray(n)&&(-1!==n.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(d.Typing,e,this)))}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return"leave"===this.membership&&void 0!==this.events.member&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){const e=this.events.member;let t=e.getContent(),n=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return n}}getAvatarUrl(e,t,n,i){let s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],r=arguments.length>5?arguments[5]:void 0;const a=this.getMxcAvatarUrl();if(!a&&!s)return null;const c=Object(o.a)(e,a,t,n,i,r);return c||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:void 0}}const h=/@.+:.+/,m=/[\u200E\u200F\u202A-\u202F]/},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"f",(function(){return o})),n.d(t,"e",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"d",(function(){return c})),n.d(t,"a",(function(){return l}));var i=n(147);function s(e,t){const n=new Map(Object.entries(e));for(const e of t)n.delete(e);return Array.from(n.entries()).reduce(((e,t)=>{let[n,i]=t;return e[n]=i,e}),{})}function o(e,t){const n=Object.keys(e),o=Object(i.a)(n,t);return 0===o.removed.length?r(e):s(e,o.removed)}function r(e,t){const n={};for(const[i,s]of Object.entries(e))n[i]=s,t&&(n[i]=t(i,s));return n}function a(e,t){if(e===t)return!1;const n=Object.keys(e),s=Object.keys(t);if(n.length!==s.length)return!0;const o=Object(i.f)(n,s);return o.length!==n.length||o.some((n=>e[n]!==t[n]))}function c(e,t){const n=function(e,t){const n=Object.keys(e),s=Object.keys(t),o=Object(i.a)(n,s);return{changed:Object(i.f)(n,s).filter((n=>e[n]!==t[n])),added:o.added,removed:o.removed}}(e,t);return Object(i.k)(n.removed,n.added,n.changed)}function l(e){return JSON.parse(JSON.stringify(e))}},,function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"e",(function(){return r})),n.d(t,"d",(function(){return a})),n.d(t,"a",(function(){return c}));var i=n(10);const s=new i.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),o=new i.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),r=new i.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),a=new i.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),c=new i.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end")},function(e,t,n){"use strict";n.d(t,"f",(function(){return E})),n.d(t,"g",(function(){return w})),n.d(t,"a",(function(){return _})),n.d(t,"e",(function(){return C})),n.d(t,"d",(function(){return O})),n.d(t,"c",(function(){return I})),n.d(t,"b",(function(){return R})),n.d(t,"i",(function(){return k})),n.d(t,"j",(function(){return P})),n.d(t,"k",(function(){return D})),n.d(t,"h",(function(){return N}));var i,s,o=n(13),r=n.n(o),a=n(366),c=n(1028),l=n(1),d=n(16),u=n(130),h=n(225),m=n(364),p=n(509),g=n(159),v=n(365),f=n(226),b=n(196);function y(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function S(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?y(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):y(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let E,w,_,C,O,I;!function(e){e.AUDIO="audio",e.VIDEO="video"}(i||(i={})),function(e){e.OPUS="opus"}(s||(s={})),function(e){e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended"}(E||(E={})),function(e){e.Voice="voice",e.Video="video"}(w||(w={})),function(e){e.Inbound="inbound",e.Outbound="outbound"}(_||(_={})),function(e){e.Local="local",e.Remote="remote"}(C||(C={})),function(e){e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed",e.LengthChanged="length_changed",e.DataChannel="datachannel",e.SendVoipEvent="send_voip_event"}(O||(O={})),function(e){e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.CreateOffer="create_offer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transferred="transferred",e.NewSession="new_session"}(I||(I={}));class R extends Error{constructor(e,t,n){super(t+": "+n),r()(this,"code",void 0),this.code=e}}function k(){return Date.now().toString()+Object(h.b)(16)}function x(e){return[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:e?12e3:void 0}]}function T(e,t){return e+":"+t}class j extends g.b{constructor(e){var t;if(super(),r()(this,"roomId",void 0),r()(this,"callId",void 0),r()(this,"invitee",void 0),r()(this,"hangupParty",void 0),r()(this,"hangupReason",void 0),r()(this,"direction",void 0),r()(this,"ourPartyId",void 0),r()(this,"peerConn",void 0),r()(this,"toDeviceSeq",0),r()(this,"isPtt",!1),r()(this,"_state",E.Fledgling),r()(this,"client",void 0),r()(this,"forceTURN",void 0),r()(this,"turnServers",void 0),r()(this,"candidateSendQueue",[]),r()(this,"candidateSendTries",0),r()(this,"candidatesEnded",!1),r()(this,"feeds",[]),r()(this,"transceivers",new Map),r()(this,"inviteOrAnswerSent",!1),r()(this,"waitForLocalAVStream",!1),r()(this,"successor",void 0),r()(this,"opponentMember",void 0),r()(this,"opponentVersion",void 0),r()(this,"opponentPartyId",void 0),r()(this,"opponentCaps",void 0),r()(this,"iceDisconnectedTimeout",void 0),r()(this,"inviteTimeout",void 0),r()(this,"removeTrackListeners",new Map),r()(this,"remoteOnHold",!1),r()(this,"callStatsAtEnd",void 0),r()(this,"makingOffer",!1),r()(this,"ignoreOffer",!1),r()(this,"responsePromiseChain",void 0),r()(this,"remoteCandidateBuffer",new Map),r()(this,"remoteAssertedIdentity",void 0),r()(this,"remoteSDPStreamMetadata",void 0),r()(this,"callLengthInterval",void 0),r()(this,"callStartTime",void 0),r()(this,"opponentDeviceId",void 0),r()(this,"opponentDeviceInfo",void 0),r()(this,"opponentSessionId",void 0),r()(this,"groupCallId",void 0),r()(this,"stopVideoTrackTimer",void 0),r()(this,"isOnlyDataChannelAllowed",void 0),r()(this,"gotLocalIceCandidate",(e=>{if(e.candidate){if(this.candidatesEnded)return void l.a.warn(`Call ${this.callId} gotLocalIceCandidate() got candidate after candidates have ended - ignoring!`);if(l.a.debug(`Call ${this.callId} got local ICE ${e.candidate.sdpMid} ${e.candidate.candidate}`),this.callHasEnded())return;""===e.candidate.candidate?this.queueCandidate(null):this.queueCandidate(e.candidate)}})),r()(this,"onIceGatheringStateChange",(e=>{var t;l.a.debug(`Call ${this.callId} onIceGatheringStateChange() ice gathering state changed to ${this.peerConn.iceGatheringState}`),"complete"===(null===(t=this.peerConn)||void 0===t?void 0:t.iceGatheringState)&&this.queueCandidate(null)})),r()(this,"getLocalOfferFailed",(e=>{l.a.error(`Call ${this.callId} getLocalOfferFailed() running`,e),this.emit(O.Error,new R(I.LocalOfferFailed,"Failed to get local offer!",e)),this.terminate(C.Local,I.LocalOfferFailed,!1)})),r()(this,"getUserMediaFailed",(e=>{this.successor?this.successor.getUserMediaFailed(e):(l.a.warn(`Call ${this.callId} getUserMediaFailed() failed to get user media - ending call`,e),this.emit(O.Error,new R(I.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e)),this.terminate(C.Local,I.NoUserMedia,!1))})),r()(this,"onIceConnectionStateChanged",(()=>{var e,t,n,i,s;if(!this.callHasEnded()){if(l.a.debug(`Call ${this.callId} onIceConnectionStateChanged() running (state=${null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState})`),["connected","completed"].includes(null!==(t=null===(n=this.peerConn)||void 0===n?void 0:n.iceConnectionState)&&void 0!==t?t:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.state=E.Connected,this.callLengthInterval||this.callStartTime||(this.callStartTime=Date.now(),this.callLengthInterval=setInterval((()=>{this.emit(O.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3))}),1e3));else if("failed"==(null===(i=this.peerConn)||void 0===i?void 0:i.iceConnectionState)){var o;null!==(o=this.peerConn)&&void 0!==o&&o.restartIce?(this.candidatesEnded=!1,this.peerConn.restartIce()):(l.a.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)`),this.hangup(I.IceFailed,!1))}else"disconnected"==(null===(s=this.peerConn)||void 0===s?void 0:s.iceConnectionState)&&(this.iceDisconnectedTimeout=setTimeout((()=>{l.a.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)`),this.hangup(I.IceFailed,!1)}),3e4),this.state=E.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(const e of this.getRemoteFeeds())e.setAudioVideoMuted(!0,!0)}})),r()(this,"onSignallingStateChanged",(()=>{var e;l.a.debug(`Call ${this.callId} onSignallingStateChanged() running (state=${null===(e=this.peerConn)||void 0===e?void 0:e.signalingState})`)})),r()(this,"onTrack",(e=>{if(0===e.streams.length)return void l.a.warn(`Call ${this.callId} onTrack() called with streamless track streamless (kind=${e.track.kind})`);const t=e.streams[0];if(this.pushRemoteFeed(t),!this.removeTrackListeners.has(t)){const e=()=>{0===t.getTracks().length&&(l.a.info(`Call ${this.callId} onTrack() removing track (streamId=${t.id})`),this.deleteFeedByStream(t),t.removeEventListener("removetrack",e),this.removeTrackListeners.delete(t))};t.addEventListener("removetrack",e),this.removeTrackListeners.set(t,e)}})),r()(this,"onDataChannel",(e=>{this.emit(O.DataChannel,e.channel)})),r()(this,"onNegotiationNeeded",(async()=>{l.a.info(`Call ${this.callId} onNegotiationNeeded() negotiation is needed!`),this.state===E.CreateOffer||0!==this.opponentVersion?this.queueGotLocalOffer():l.a.info(`Call ${this.callId} onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event`)})),r()(this,"onHangupReceived",(e=>{l.a.debug(`Call ${this.callId} onHangupReceived() running`),this.partyIdMatches(e)||this.state===E.Ringing?this.terminate(C.Remote,e.reason||I.UserHangup,!0):l.a.info(`Call ${this.callId} onHangupReceived() ignoring message from party ID ${e.party_id}: our partner is ${this.opponentPartyId}`)})),r()(this,"onRejectReceived",(e=>{l.a.debug(`Call ${this.callId} onRejectReceived() running`);[E.InviteSent,E.Ringing].includes(this.state)||this.state===E.Fledgling&&this.direction===_.Inbound?this.terminate(C.Remote,e.reason||I.UserHangup,!0):l.a.debug(`Call ${this.callId} onRejectReceived() called in wrong state (state=${this.state})`)})),r()(this,"onAnsweredElsewhere",(e=>{l.a.debug(`Call ${this.callId} onAnsweredElsewhere() running`),this.terminate(C.Remote,I.AnsweredElsewhere,!0)})),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=null!==(t=e.forceTURN)&&void 0!==t&&t,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]});for(const e of this.turnServers)d.f(e,["urls"]);this.callId=k(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}async placeVoiceCall(){await this.placeCall(!0,!1)}async placeVideoCall(){await this.placeCall(!0,!0)}createDataChannel(e,t){const n=this.peerConn.createDataChannel(e,t);return this.emit(O.DataChannel,n),n}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(O.State,e,t)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?w.Video:w.Voice}get hasLocalUserMediaVideoTrack(){var e;return!(null===(e=this.localUsermediaStream)||void 0===e||!e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some((e=>{var t;return e.purpose===m.b.Usermedia&&(null===(t=e.stream)||void 0===t?void 0:t.getVideoTracks().length)}))}get hasLocalUserMediaAudioTrack(){var e;return!(null===(e=this.localUsermediaStream)||void 0===e||!e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some((e=>{var t;return e.purpose===m.b.Usermedia&&!(null===(t=e.stream)||void 0===t||!t.getAudioTracks().length)}))}get hasUserMediaAudioSender(){var e;return Boolean(null===(e=this.transceivers.get(T(m.b.Usermedia,"audio")))||void 0===e?void 0:e.sender)}get hasUserMediaVideoSender(){var e;return Boolean(null===(e=this.transceivers.get(T(m.b.Usermedia,"video")))||void 0===e?void 0:e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find((e=>e.purpose===m.b.Usermedia))}get localScreensharingFeed(){return this.getLocalFeeds().find((e=>e.purpose===m.b.Screenshare))}get localUsermediaStream(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.stream}get localScreensharingStream(){var e;return null===(e=this.localScreensharingFeed)||void 0===e?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find((e=>e.purpose===m.b.Usermedia))}get remoteScreensharingFeed(){return this.getRemoteFeeds().find((e=>e.purpose===m.b.Screenshare))}get remoteUsermediaStream(){var e;return null===(e=this.remoteUsermediaFeed)||void 0===e?void 0:e.stream}get remoteScreensharingStream(){var e;return null===(e=this.remoteScreensharingFeed)||void 0===e?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find((t=>t.stream.id===e))}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter((e=>e.isLocal()))}getRemoteFeeds(){return this.feeds.filter((e=>!e.isLocal()))}async initOpponentCrypto(){var e,t;if(!this.opponentDeviceId)return;if(!this.client.getUseE2eForGroupCall())return;if(!this.client.isCryptoEnabled())return void(this.opponentDeviceInfo=new v.a(this.opponentDeviceId));if(!this.client.crypto)throw new Error("Crypto is not initialised.");const n=this.invitee||(null===(e=this.getOpponentMember())||void 0===e?void 0:e.userId);if(!n)throw new Error("Couldn't find opponent user ID to init crypto");const i=await this.client.crypto.deviceList.downloadKeys([n],!1);if(this.opponentDeviceInfo=null===(t=i.get(n))||void 0===t?void 0:t.get(this.opponentDeviceId),void 0===this.opponentDeviceInfo)throw new f.g(n)}getLocalSDPStreamMetadata(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t={};for(const n of this.getLocalFeeds())e&&(n.sdpMetadataStreamId=n.stream.id),t[n.sdpMetadataStreamId]={purpose:n.purpose,audio_muted:n.isAudioMuted(),video_muted:n.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some((e=>!e.isLocal()))}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata())return void this.pushRemoteFeedWithoutMetadata(e);const t=this.getOpponentMember().userId,n=this.remoteSDPStreamMetadata[e.id].purpose,i=this.remoteSDPStreamMetadata[e.id].audio_muted,s=this.remoteSDPStreamMetadata[e.id].video_muted;n?this.getFeedByStreamId(e.id)?l.a.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=${e.id})`):(this.feeds.push(new p.a({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n,audioMuted:i,videoMuted:s})),this.emit(O.FeedsChanged,this.feeds),l.a.info(`Call ${this.callId} pushRemoteFeed() pushed stream (streamId=${e.id}, active=${e.active}, purpose=${n})`)):l.a.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=${e.id})`)}pushRemoteFeedWithoutMetadata(e){var t;const n=this.getOpponentMember().userId,i=m.b.Usermedia,s=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;s&&e.id!==s.id?l.a.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=${e.id})`):this.getFeedByStreamId(e.id)?l.a.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=${e.id})`):(this.feeds.push(new p.a({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:i})),this.emit(O.FeedsChanged,this.feeds),l.a.info(`Call ${this.callId} pushRemoteFeedWithoutMetadata() pushed stream (streamId=${e.id}, active=${e.active})`))}pushNewLocalFeed(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=this.client.getUserId();P(e.getAudioTracks(),!0),P(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)?l.a.warn(`Call ${this.callId} pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=${e.id})`):this.pushLocalFeed(new p.a({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:i,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),n)}pushLocalFeed(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.feeds.some((t=>e.stream.id===t.stream.id)))l.a.info(`Call ${this.callId} pushLocalFeed() ignoring duplicate local stream (streamId=${e.stream.id})`);else{if(this.feeds.push(e),t)for(const t of e.stream.getTracks()){l.a.info(`Call ${this.callId} pushLocalFeed() adding track to peer connection (id=${t.id}, kind=${t.kind}, streamId=${e.stream.id}, streamPurpose=${e.purpose}, enabled=${t.enabled})`);const n=T(e.purpose,t.kind);if(this.transceivers.has(n)){const i=this.transceivers.get(n);i.sender.setStreams&&i.sender.setStreams(e.stream),i.sender.replaceTrack(t),i.direction="inactive"===i.direction?"sendonly":"sendrecv"}else{const i=this.peerConn.addTrack(t,e.stream),s=this.peerConn.getTransceivers().find((e=>e.sender===i));s?this.transceivers.set(n,s):l.a.warn(`Call ${this.callId} pushLocalFeed() didn't find a matching transceiver after adding track!`)}}l.a.info(`Call ${this.callId} pushLocalFeed() pushed stream (id=${e.stream.id}, active=${e.stream.active}, purpose=${e.purpose})`),this.emit(O.FeedsChanged,this.feeds)}}removeLocalFeed(e){const t=T(e.purpose,"audio"),n=T(e.purpose,"video");for(const e of[t,n])if(this.transceivers.has(e)){const t=this.transceivers.get(e);t.sender&&this.peerConn.removeTrack(t.sender)}e.purpose===m.b.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(const e of this.feeds)e.isLocal()&&this.groupCallId||e.dispose();this.feeds=[],this.emit(O.FeedsChanged,this.feeds)}deleteFeedByStream(e){const t=this.getFeedByStreamId(e.id);t?this.deleteFeed(t):l.a.warn(`Call ${this.callId} deleteFeedByStream() didn't find the feed to delete (streamId=${e.id})`)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(O.FeedsChanged,this.feeds)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;const e=await this.peerConn.getStats(),t=[];return e.forEach((e=>{t.push(e)})),t}async initWithInvite(e){var t;const n=e.getContent();this.direction=_.Inbound;await this.client.checkTurnServers()||l.a.warn(`Call ${this.callId} initWithInvite() failed to get TURN credentials! Proceeding with call anyway...`);const i=n[m.a];i?this.updateRemoteSDPStreamMetadata(i):l.a.debug(`Call ${this.callId} initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams`),this.peerConn=this.createPeerConnection(),this.chooseOpponent(e),await this.initOpponentCrypto();try{await this.peerConn.setRemoteDescription(n.offer),await this.addBufferedIceCandidates()}catch(e){return l.a.debug(`Call ${this.callId} initWithInvite() failed to set remote description`,e),void this.terminate(C.Local,I.SetRemoteDescription,!1)}const s=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;if(!(this.isOnlyDataChannelAllowed||s&&0!==s.getTracks().length))return l.a.error(`Call ${this.callId} initWithInvite() no remote stream or no tracks after setting remote description!`),void this.terminate(C.Local,I.SetRemoteDescription,!1);if(this.state=E.Ringing,e.getLocalAge()){const t=setTimeout((()=>{this.state==E.Ringing&&(l.a.debug(`Call ${this.callId} initWithInvite() invite has expired. Hanging up.`),this.hangupParty=C.Remote,this.state=E.Ended,this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit(O.Hangup,this))}),n.lifetime-e.getLocalAge()),i=e=>{e!==E.Ringing&&(clearTimeout(t),this.off(O.State,i))};this.on(O.State,i)}}initWithHangup(e){this.state=E.Ended}shouldAnswerWithMediaType(e,t,n){return e&&!t?(l.a.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${n} because the other side isn't sending it either.`),!1):d.u(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!=e?e:t:(l.a.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${n}=${e} because the other side doesn't support it. Answering with ${n}=${t}.`),t)}async answer(e,t){if(!this.inviteOrAnswerSent){if(!1===e&&!1===t)throw new Error("You CANNOT answer a call without media");if(this.localUsermediaStream||this.waitForLocalAVStream)this.waitForLocalAVStream&&(this.state=E.WaitLocalMedia);else{const i=this.state,s=this.shouldAnswerWithMediaType(e,this.hasRemoteUserMediaAudioTrack,"audio"),o=this.shouldAnswerWithMediaType(t,this.hasRemoteUserMediaVideoTrack,"video");this.state=E.WaitLocalMedia,this.waitForLocalAVStream=!0;try{var n;const e=await this.client.getMediaHandler().getUserMediaStream(s,o);this.waitForLocalAVStream=!1;const t=[new p.a({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:null!==(n=this.client.getDeviceId())&&void 0!==n?n:void 0,stream:e,purpose:m.b.Usermedia,audioMuted:!1,videoMuted:!1})];this.localScreensharingFeed&&t.push(this.localScreensharingFeed),this.answerWithCallFeeds(t)}catch(e){if(!o)return void this.getUserMediaFailed(e);l.a.warn(`Call ${this.callId} answer() failed to getUserMedia(), trying to getUserMedia() without video`),this.state=i,this.waitForLocalAVStream=!1,await this.answer(s,!1)}}}}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){l.a.debug(`Call ${this.callId} replacedBy() running (newCallId=${e.callId})`),this.state===E.WaitLocalMedia?(l.a.debug(`Call ${this.callId} replacedBy() telling new call to wait for local media (newCallId=${e.callId})`),e.waitForLocalAVStream=!0):[E.CreateOffer,E.InviteSent].includes(this.state)&&(e.direction===_.Outbound?e.queueGotCallFeedsForAnswer([]):(l.a.debug(`Call ${this.callId} replacedBy() handing local stream to new call(newCallId=${e.callId})`),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map((e=>e.clone()))))),this.successor=e,this.emit(O.Replaced,e),this.hangup(I.Replaced,!0)}hangup(e,t){if(this.callHasEnded())return;if(l.a.debug(`Call ${this.callId} hangup() ending call (reason=${e})`),this.terminate(C.Local,e,!t),[E.Fledgling,E.WaitLocalMedia].includes(this.state))return;const n={};(this.opponentVersion&&0!==this.opponentVersion||e!==I.UserHangup)&&(n.reason=e),this.sendVoipEvent(u.b.CallHangup,n)}reject(){if(this.state!==E.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(0===this.opponentVersion)return l.a.info(`Call ${this.callId} reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=${this.opponentVersion})`),void this.hangup(I.UserHangup,!0);l.a.debug("Rejecting call: "+this.callId),this.terminate(C.Local,I.UserHangup,!0),this.sendVoipEvent(u.b.CallReject,{})}async upgradeCall(e,t){if((e||t)&&this.opponentSupportsSDPStreamMetadata())try{l.a.debug(`Call ${this.callId} upgradeCall() upgrading call (audio=${e}, video=${t})`);const n=e||this.hasLocalUserMediaAudioTrack,i=t||this.hasLocalUserMediaVideoTrack,s=await this.client.getMediaHandler().getUserMediaStream(n,i,!1);await this.updateLocalUsermediaStream(s,e,t)}catch(e){l.a.error(`Call ${this.callId} upgradeCall() failed to upgrade the call`,e),this.emit(O.Error,new R(I.NoUserMedia,"Failed to get camera access: ",e))}}opponentSupportsSDPStreamMetadata(){return Boolean(this.remoteSDPStreamMetadata)}isScreensharing(){return Boolean(this.localScreensharingStream)}async setScreensharingEnabled(e,t){if(e&&this.isScreensharing())return l.a.warn(`Call ${this.callId} setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!`),!0;if(!e&&!this.isScreensharing())return l.a.warn(`Call ${this.callId} setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!`),!1;if(!this.opponentSupportsSDPStreamMetadata())return this.setScreensharingEnabledWithoutMetadataSupport(e,t);if(l.a.debug(`Call ${this.callId} setScreensharingEnabled() running (enabled=${e})`),!e){const e=this.transceivers.get(T(m.b.Screenshare,"audio")),t=this.transceivers.get(T(m.b.Screenshare,"video"));for(const n of[e,t])n&&n.sender&&this.peerConn.removeTrack(n.sender);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);return!!e&&(this.pushNewLocalFeed(e,m.b.Screenshare),!0)}catch(e){return l.a.error(`Call ${this.callId} setScreensharingEnabled() failed to get screen-sharing stream:`,e),!1}}async setScreensharingEnabledWithoutMetadataSupport(e,t){if(l.a.debug(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() running (enabled=${e})`),!e){var n,i;const e=null===(n=this.localUsermediaStream)||void 0===n?void 0:n.getTracks().find((e=>"video"===e.kind)),t=null===(i=this.transceivers.get(T(m.b.Usermedia,"video")))||void 0===i?void 0:i.sender;return null==t||t.replaceTrack(null!=e?e:null),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{var s;const e=await this.client.getMediaHandler().getScreensharingStream(t);if(!e)return!1;const n=e.getTracks().find((e=>"video"===e.kind)),i=null===(s=this.transceivers.get(T(m.b.Usermedia,"video")))||void 0===s?void 0:s.sender;return null==i||i.replaceTrack(null!=n?n:null),this.pushNewLocalFeed(e,m.b.Screenshare,!1),!0}catch(e){return l.a.error(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:`,e),!1}}async updateLocalUsermediaStream(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=this.localUsermediaFeed,s=t||!i.isAudioMuted()&&!this.remoteOnHold,o=n||!i.isVideoMuted()&&!this.remoteOnHold;l.a.log(`Call ${this.callId} updateLocalUsermediaStream() running (streamId=${e.id}, audio=${s}, video=${o})`),P(e.getAudioTracks(),s),P(e.getVideoTracks(),o);for(const e of this.localUsermediaStream.getTracks())this.localUsermediaStream.removeTrack(e),e.stop();for(const t of e.getTracks())this.localUsermediaStream.addTrack(t);for(const t of e.getTracks()){const n=T(m.b.Usermedia,t.kind),s=this.transceivers.get(n),o=null==s?void 0:s.sender;let r=!1;if(o)try{l.a.info(`Call ${this.callId} updateLocalUsermediaStream() replacing track (id=${t.id}, kind=${t.kind}, streamId=${e.id}, streamPurpose=${i.purpose})`),await o.replaceTrack(t),s.direction="inactive"===s.direction?"sendonly":"sendrecv",r=!0}catch(e){l.a.warn(`Call ${this.callId} updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead`,e)}if(!r){l.a.info(`Call ${this.callId} updateLocalUsermediaStream() adding track to peer connection (id=${t.id}, kind=${t.kind}, streamId=${e.id}, streamPurpose=${i.purpose})`);const s=this.peerConn.addTrack(t,this.localUsermediaStream),o=this.peerConn.getTransceivers().find((e=>e.sender===s));o?this.transceivers.set(n,o):l.a.warn(`Call ${this.callId} updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!`)}}}async setLocalVideoMuted(e){var t;if(l.a.log(`Call ${this.callId} setLocalVideoMuted() running ${e}`),e||void 0===this.stopVideoTrackTimer||(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0),!await this.client.getMediaHandler().hasVideoDevice())return this.isLocalVideoMuted();if(!this.hasUserMediaVideoSender&&!e)return await this.upgradeCall(!1,!0),this.isLocalVideoMuted();if(!e&&0===this.localUsermediaStream.getVideoTracks().length){const e=await this.client.getMediaHandler().getUserMediaStream(!0,!0);await this.updateLocalUsermediaStream(e)}return null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioVideoMuted(null,e),this.updateMuteStatus(),await this.sendMetadataUpdate(),e&&(this.stopVideoTrackTimer=setTimeout((()=>{for(const e of this.localUsermediaStream.getVideoTracks())e.stop(),this.localUsermediaStream.removeTrack(e)}),120)),this.isLocalVideoMuted()}isLocalVideoMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isVideoMuted())&&void 0!==e&&e}async setMicrophoneMuted(e){var t;return l.a.log(`Call ${this.callId} setMicrophoneMuted() running ${e}`),await this.client.getMediaHandler().hasAudioDevice()?e||this.hasUserMediaAudioSender&&this.hasLocalUserMediaAudioTrack?(null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioVideoMuted(e,null),this.updateMuteStatus(),await this.sendMetadataUpdate(),this.isMicrophoneMuted()):(await this.upgradeCall(!0,!1),this.isMicrophoneMuted()):this.isMicrophoneMuted()}isMicrophoneMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isAudioMuted())&&void 0!==e&&e}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(const t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(O.RemoteHoldUnhold,this.remoteOnHold)}}isLocalOnHold(){if(this.state!==E.Connected)return!1;let e=!0;for(const t of this.peerConn.getTransceivers()){["inactive","recvonly"].includes(t.currentDirection)||(e=!1)}return e}sendDtmfDigit(e){for(const n of this.peerConn.getSenders()){var t;if("audio"===(null===(t=n.track)||void 0===t?void 0:t.kind)&&n.dtmf)return void n.dtmf.insertDTMF(e)}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){const e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;l.a.log(`Call ${this.callId} updateMuteStatus stream ${this.localUsermediaStream.id} micShouldBeMuted ${e} vidShouldBeMuted ${t}`),P(this.localUsermediaStream.getAudioTracks(),!e),P(this.localUsermediaStream.getVideoTracks(),!t)}async sendMetadataUpdate(){await this.sendVoipEvent(u.b.CallSDPStreamMetadataChangedPrefix,{[m.a]:this.getLocalSDPStreamMetadata()})}gotCallFeedsForInvite(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.successor)this.successor.queueGotCallFeedsForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{for(const t of e)this.pushLocalFeed(t);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=E.CreateOffer,l.a.debug(`Call ${this.callId} gotUserMediaForInvite() run`)}}async sendAnswer(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[m.a]:this.getLocalSDPStreamMetadata(!0)};e.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1};const t=this.discardDuplicateCandidates();l.a.info(`Call ${this.callId} sendAnswer() discarding ${t} candidates that will be sent in answer`);try{await this.sendVoipEvent(u.b.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(e){this.state=E.Ringing,e instanceof b.f&&e.event&&this.client.cancelPendingEvent(e.event);let t=I.SendAnswer,n="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=I.UnknownDevices,n="Unknown devices present in the room"),this.emit(O.Error,new R(t,n,e)),e}this.sendCandidateQueue()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then((()=>this.gotCallFeedsForAnswer(e))):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){const n=Object(c.parse)(e.sdp);n.media.forEach((e=>{const n=new Map,i=new Map;for(const t of e.rtp)n.set(t.payload,t.codec),i.set(t.codec,t.payload);for(const s of t){if(s.mediaType!==e.type)continue;if(!i.has(s.codec)){l.a.info(`Call ${this.callId} mungeSdp() ignoring SDP modifications for ${s.codec} as it's not present.`);continue}const t=[];void 0!==s.enableDtx&&t.push("usedtx="+(s.enableDtx?"1":"0")),void 0!==s.maxAverageBitrate&&t.push(`maxaveragebitrate=${s.maxAverageBitrate}`);let o=!1;for(const i of e.fmtp)n.get(i.payload)===s.codec&&(o=!0,i.config+=";"+t.join(";"));o||e.fmtp.push({payload:i.get(s.codec),config:t.join(";")})}})),e.sdp=Object(c.write)(n)}async createOffer(){const e=await this.peerConn.createOffer();return this.mungeSdp(e,x(this.isPtt)),e}async createAnswer(){const e=await this.peerConn.createAnswer();return this.mungeSdp(e,x(this.isPtt)),e}async gotCallFeedsForAnswer(e){if(this.callHasEnded())return;this.waitForLocalAVStream=!1;for(const t of e)this.pushLocalFeed(t);let t;this.state=E.CreateAnswer;try{this.getRidOfRTXCodecs(),t=await this.createAnswer()}catch(e){return l.a.debug(`Call ${this.callId} gotCallFeedsForAnswer() failed to create answer: `,e),void this.terminate(C.Local,I.CreateAnswer,!0)}try{if(await this.peerConn.setLocalDescription(t),this.callHasEnded())return;if(this.state=E.Connecting,await new Promise((e=>{setTimeout(e,200)})),this.callHasEnded())return;this.sendAnswer()}catch(e){return l.a.debug(`Call ${this.callId} gotCallFeedsForAnswer() error setting local description!`,e),void this.terminate(C.Local,I.SetLocalDescription,!0)}}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;const t=e.getContent(),n=t.candidates;if(!n)return void l.a.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!`);const i=0===t.version?null:t.party_id||null;if(void 0!==this.opponentPartyId)this.partyIdMatches(t)?await this.addIceCandidates(n):l.a.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates from party ID ${t.party_id}: we have chosen party ID ${this.opponentPartyId}`);else if(i){l.a.info(`Call ${this.callId} onRemoteIceCandidatesReceived() buffering ${n.length} candidates until we pick an opponent`);const e=this.remoteCandidateBuffer.get(i)||[];e.push(...n),this.remoteCandidateBuffer.set(i,e)}}async onAnswerReceived(e){const t=e.getContent();if(l.a.debug(`Call ${this.callId} onAnswerReceived() running (hangupParty=${t.party_id})`),this.callHasEnded())return void l.a.debug(`Call ${this.callId} onAnswerReceived() ignoring answer because call has ended`);if(void 0!==this.opponentPartyId)return void l.a.info(`Call ${this.callId} onAnswerReceived() ignoring answer from party ID ${t.party_id}: we already have an answer/reject from ${this.opponentPartyId}`);this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.state=E.Connecting;const n=t[m.a];n?this.updateRemoteSDPStreamMetadata(n):l.a.warn(`Call ${this.callId} onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams`);try{await this.peerConn.setRemoteDescription(t.answer)}catch(e){return l.a.debug(`Call ${this.callId} onAnswerReceived() failed to set remote description`,e),void this.terminate(C.Local,I.SetRemoteDescription,!1)}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(u.b.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(e){l.a.warn(`Call ${this.callId} onAnswerReceived() failed to send select_answer event`,e)}}async onSelectAnswerReceived(e){if(this.direction!==_.Inbound)return void l.a.warn(`Call ${this.callId} onSelectAnswerReceived() got select_answer for an outbound call: ignoring`);const t=e.getContent().selected_party_id;null!=t?t!==this.ourPartyId&&(l.a.info(`Call ${this.callId} onSelectAnswerReceived() got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),await this.terminate(C.Remote,I.AnsweredElsewhere,!0)):l.a.warn(`Call ${this.callId} onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring`)}async onNegotiateReceived(e){const t=e.getContent(),n=t.description;if(!n||!n.sdp||!n.type)return void l.a.info(`Call ${this.callId} onNegotiateReceived() ignoring invalid m.call.negotiate event`);const i=this.direction===_.Inbound,s="offer"===n.type&&(this.makingOffer||"stable"!==this.peerConn.signalingState);if(this.ignoreOffer=!i&&s,this.ignoreOffer)return void l.a.info(`Call ${this.callId} onNegotiateReceived() ignoring colliding negotiate event because we're impolite`);const o=this.isLocalOnHold(),r=t[m.a];r?this.updateRemoteSDPStreamMetadata(r):l.a.warn(`Call ${this.callId} onNegotiateReceived() received negotiation event without SDPStreamMetadata!`);try{if(await this.peerConn.setRemoteDescription(n),"offer"===n.type){var a;let e;try{this.getRidOfRTXCodecs(),e=await this.createAnswer()}catch(e){return l.a.debug(`Call ${this.callId} onNegotiateReceived() failed to create answer: `,e),void this.terminate(C.Local,I.CreateAnswer,!0)}await this.peerConn.setLocalDescription(e),this.sendVoipEvent(u.b.CallNegotiate,{description:null===(a=this.peerConn.localDescription)||void 0===a?void 0:a.toJSON(),[m.a]:this.getLocalSDPStreamMetadata(!0)})}}catch(e){l.a.warn(`Call ${this.callId} onNegotiateReceived() failed to complete negotiation`,e)}const c=this.isLocalOnHold();o!==c&&(this.emit(O.LocalHoldUnhold,c),this.emit(O.HoldUnhold,c))}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=d.G(this.remoteSDPStreamMetadata||{},e,!0);for(const e of this.getRemoteFeeds()){var t;const n=e.stream.id,i=this.remoteSDPStreamMetadata[n];e.setAudioVideoMuted(null==i?void 0:i.audio_muted,null==i?void 0:i.video_muted),e.purpose=null===(t=this.remoteSDPStreamMetadata[n])||void 0===t?void 0:t.purpose}}onSDPStreamMetadataChangedReceived(e){const t=e.getContent()[m.a];this.updateRemoteSDPStreamMetadata(t)}async onAssertedIdentityReceived(e){const t=e.getContent();t.asserted_identity&&(this.remoteAssertedIdentity={id:t.asserted_identity.id,displayName:t.asserted_identity.display_name},this.emit(O.AssertedIdentityChanged))}callHasEnded(){return this.state===E.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then((()=>this.wrappedGotLocalOffer())):this.responsePromiseChain=this.wrappedGotLocalOffer()}async wrappedGotLocalOffer(){this.makingOffer=!0;try{await this.gotLocalOffer()}catch(e){return void this.getLocalOfferFailed(e)}finally{this.makingOffer=!1}}async gotLocalOffer(){if(l.a.debug(`Call ${this.callId} gotLocalOffer() running`),this.callHasEnded())return void l.a.debug(`Call ${this.callId} gotLocalOffer() ignoring newly created offer because the call has ended"`);let e;try{this.getRidOfRTXCodecs(),e=await this.createOffer()}catch(e){return l.a.debug(`Call ${this.callId} gotLocalOffer() failed to create offer: `,e),void this.terminate(C.Local,I.CreateOffer,!0)}try{await this.peerConn.setLocalDescription(e)}catch(e){return l.a.debug(`Call ${this.callId} gotLocalOffer() error setting local description!`,e),void this.terminate(C.Local,I.SetLocalDescription,!0)}if("gathering"===this.peerConn.iceGatheringState&&await new Promise((e=>{setTimeout(e,200)})),this.callHasEnded())return;const t=this.state===E.CreateOffer?u.b.CallInvite:u.b.CallNegotiate,n={lifetime:6e4};var i,s;(t===u.b.CallInvite&&this.invitee&&(n.invitee=this.invitee),this.state===E.CreateOffer)?n.offer=null===(i=this.peerConn.localDescription)||void 0===i?void 0:i.toJSON():n.description=null===(s=this.peerConn.localDescription)||void 0===s?void 0:s.toJSON();n.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},n[m.a]=this.getLocalSDPStreamMetadata(!0);const o=this.discardDuplicateCandidates();l.a.info(`Call ${this.callId} gotLocalOffer() discarding ${o} candidates that will be sent in offer`);try{await this.sendVoipEvent(t,n)}catch(e){l.a.error(`Call ${this.callId} gotLocalOffer() failed to send invite`,e),e instanceof b.f&&e.event&&this.client.cancelPendingEvent(e.event);let t=I.SignallingFailed,n="Signalling failed";return this.state===E.CreateOffer&&(t=I.SendInvite,n="Failed to send invite"),"UnknownDeviceError"==e.name&&(t=I.UnknownDevices,n="Unknown devices present in the room"),this.emit(O.Error,new R(t,n,e)),void this.terminate(C.Local,t,!1)}this.sendCandidateQueue(),this.state===E.CreateOffer&&(this.inviteOrAnswerSent=!0,this.state=E.InviteSent,this.inviteTimeout=setTimeout((()=>{this.inviteTimeout=void 0,this.state===E.InviteSent&&this.hangup(I.InviteTimeout,!1)}),6e4))}getRidOfRTXCodecs(){if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const e=RTCRtpReceiver.getCapabilities("video").codecs,t=[...RTCRtpSender.getCapabilities("video").codecs,...e];for(const e of t)if("video/rtx"===e.mimeType){const n=t.indexOf(e);t.splice(n,1)}const n=this.transceivers.get(T(m.b.Screenshare,"video"));n&&n.setCodecPreferences(t)}async sendVoipEvent(e,t){const n=Object.assign({},t,{version:"1",call_id:this.callId,party_id:this.ourPartyId,conf_id:this.groupCallId});if(this.opponentDeviceId){var i;const t=this.toDeviceSeq++,s=S(S({},n),{},{device_id:this.client.deviceId,sender_session_id:this.client.getSessionId(),dest_session_id:this.opponentSessionId,seq:t,[u.k]:Object(a.v4)()});this.emit(O.SendVoipEvent,{type:"toDevice",eventType:e,userId:this.invitee||(null===(i=this.getOpponentMember())||void 0===i?void 0:i.userId),opponentDeviceId:this.opponentDeviceId,content:s});const o=this.invitee||this.getOpponentMember().userId;if(this.client.getUseE2eForGroupCall()){if(!this.opponentDeviceInfo)return void l.a.warn(`Call ${this.callId} sendVoipEvent() failed: we do not have opponentDeviceInfo`);await this.client.encryptAndSendToDevices([{userId:o,deviceInfo:this.opponentDeviceInfo}],{type:e,content:s})}else await this.client.sendToDevice(e,new Map([[o,new Map([[this.opponentDeviceId,s]])]]))}else{var s;this.emit(O.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:this.roomId,content:n,userId:this.invitee||(null===(s=this.getOpponentMember())||void 0===s?void 0:s.userId)}),await this.client.sendEvent(this.roomId,e,n)}}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,this.state===E.Ringing||!this.inviteOrAnswerSent)return;const t=this.direction===_.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout((()=>{this.sendCandidateQueue()}),t)}discardDuplicateCandidates(){let e=0;const t=[];for(let n=0;n<this.candidateSendQueue.length;n++){const i=this.candidateSendQueue[n];""===i.candidate?t.push(i):e++}return this.candidateSendQueue=t,e}async transfer(e){const t=await this.client.getProfileInfo(e),n=k(),i={replacement_id:k(),target_user:{id:e,display_name:t.displayname,avatar_url:t.avatar_url},create_call:n};await this.sendVoipEvent(u.b.CallReplaces,i),await this.terminate(C.Local,I.Transferred,!0)}async transferToCall(e){var t,n;const i=null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId,s=i?await this.client.getProfileInfo(i):void 0,o=null===(n=this.getOpponentMember())||void 0===n?void 0:n.userId,r=o?await this.client.getProfileInfo(o):void 0,a=k(),c={replacement_id:k(),target_user:{id:o,display_name:null==r?void 0:r.displayname,avatar_url:null==r?void 0:r.avatar_url},await_call:a};await e.sendVoipEvent(u.b.CallReplaces,c);const l={replacement_id:k(),target_user:{id:i,display_name:null==s?void 0:s.displayname,avatar_url:null==s?void 0:s.avatar_url},create_call:a};await this.sendVoipEvent(u.b.CallReplaces,l),await this.terminate(C.Local,I.Transferred,!0),await e.terminate(C.Local,I.Transferred,!0)}async terminate(e,t,n){if(!this.callHasEnded()){this.hangupParty=e,this.hangupReason=t,this.state=E.Ended,this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=void 0),void 0!==this.iceDisconnectedTimeout&&(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=void 0),void 0!==this.stopVideoTrackTimer&&(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0);for(const[e,t]of this.removeTrackListeners)e.removeEventListener("removetrack",t);this.removeTrackListeners.clear(),this.callStatsAtEnd=await this.collectCallStats(),this.stopAllMedia(),this.deleteAllFeeds(),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),n&&this.emit(O.Hangup,this),this.client.callEventHandler.calls.delete(this.callId)}}stopAllMedia(){l.a.debug(`Call ${this.callId} stopAllMedia() running`);for(const e of this.feeds)if(e.isLocal()&&e.purpose===m.b.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===m.b.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){l.a.debug(`Call ${this.callId} stopAllMedia() stopping stream (streamId=${e.stream.id})`);for(const t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(0===this.listeners(g.a.Error).length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length||this.callHasEnded())return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e.map((e=>e.toJSON()))};this.candidatesEnded&&t.candidates.push({candidate:""}),l.a.debug(`Call ${this.callId} sendCandidateQueue() attempting to send ${e.length} candidates`);try{await this.sendVoipEvent(u.b.CallCandidates,t),this.candidateSendTries=0,this.sendCandidateQueue()}catch(t){if(t instanceof b.f&&t.event&&this.client.cancelPendingEvent(t.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){l.a.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates on attempt ${this.candidateSendTries}. Giving up on this call.`,t);const e=I.SignallingFailed,n="Signalling failed";return this.emit(O.Error,new R(e,n,t)),void this.hangup(e,!1)}const n=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,l.a.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates. Retrying in ${n}ms`,t),setTimeout((()=>{this.sendCandidateQueue()}),n)}}async placeCall(e,t){if(!e)throw new Error("You CANNOT start a call without audio");this.state=E.WaitLocalMedia;try{var n;const i=await this.client.getMediaHandler().getUserMediaStream(e,t);P(i.getAudioTracks(),!0),P(i.getVideoTracks(),!0);const s=new p.a({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:null!==(n=this.client.getDeviceId())&&void 0!==n?n:void 0,stream:i,purpose:m.b.Usermedia,audioMuted:!1,videoMuted:!1});await this.placeCallWithCallFeeds([s])}catch(e){return void this.getUserMediaFailed(e)}}async placeCallWithCallFeeds(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.checkForErrorListener(),this.direction=_.Outbound,await this.initOpponentCrypto(),this.client.callEventHandler.calls.set(this.callId,this);await this.client.checkTurnServers()||l.a.warn(`Call ${this.callId} placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...`),this.peerConn=this.createPeerConnection(),this.gotCallFeedsForInvite(e,t)}createPeerConnection(){const e=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});return e.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),e.addEventListener("signalingstatechange",this.onSignallingStateChanged),e.addEventListener("icecandidate",this.gotLocalIceCandidate),e.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.addEventListener("track",this.onTrack),e.addEventListener("negotiationneeded",this.onNegotiationNeeded),e.addEventListener("datachannel",this.onDataChannel),e}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){var t;const n=e.getContent();l.a.debug(`Call ${this.callId} chooseOpponent() running (partyId=${n.party_id})`),this.opponentVersion=n.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=n.party_id||null,this.opponentCaps=n.capabilities||{},this.opponentMember=null!==(t=this.client.getRoom(this.roomId).getMember(e.getSender()))&&void 0!==t?t:void 0}async addBufferedIceCandidates(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(l.a.info(`Call ${this.callId} addBufferedIceCandidates() adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(e)),this.remoteCandidateBuffer.clear()}async addIceCandidates(e){for(const t of e){null!==t.sdpMid&&void 0!==t.sdpMid||null!==t.sdpMLineIndex&&void 0!==t.sdpMLineIndex?l.a.debug(`Call ${this.callId} addIceCandidates() got remote ICE candidate (sdpMid=${t.sdpMid}, candidate=${t.candidate})`):l.a.debug(`Call ${this.callId} addIceCandidates() got remote ICE end-of-candidates`);try{await this.peerConn.addIceCandidate(t)}catch(e){this.ignoreOffer||l.a.info(`Call ${this.callId} addIceCandidates() failed to add remote ICE candidate`,e)}}}get hasPeerConnection(){return Boolean(this.peerConn)}}function P(e,t){for(const n of e)n.enabled=t}function D(){if("undefined"==typeof window||"undefined"==typeof document)return!1;try{if(!Boolean(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return l.a.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return l.a.error("Exception thrown when trying to access WebRTC",e),!1}return!0}function N(e,t,n){if(!D())return null;const i=!!n&&n.forceTURN,s={client:e,roomId:t,invitee:null==n?void 0:n.invitee,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||i,opponentDeviceId:null==n?void 0:n.opponentDeviceId,opponentSessionId:null==n?void 0:n.opponentSessionId,groupCallId:null==n?void 0:n.groupCallId},o=new j(s);return e.reEmitter.reEmit(o,Object.values(O)),o}},function(e,t,n){"use strict";n.d(t,"a",(function(){return w}));var i=n(134),s=n.n(i),o=n(122),r=n.n(o),a=n(1093),c=n.n(a),l=n(1),d=n(156),u=n(132),h=n(123),m=n(126),p=n(129),g=n(125),v=n(177);const f=["eventName"];function b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?b(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let S;!function(e){e[e.Disabled=0]="Disabled",e[e.Anonymous=1]="Anonymous",e[e.Pseudonymous=2]="Pseudonymous"}(S||(S={}));const E=new Set(["register","login","forgot_password","soft_logout","new","settings","welcome","home","start","directory","start_sso","start_cas","complete_security","post_registration","room","user"]);class w{static get instance(){return this._instance||(this._instance=new w(c.a)),this._instance}constructor(e){this.posthog=e,r()(this,"anonymity",S.Disabled),r()(this,"enabled",!1),r()(this,"platformSuperProperties",{}),r()(this,"propertiesForNextEvent",{}),r()(this,"userPropertyCache",{}),r()(this,"authenticationType","Other"),r()(this,"onLayoutUpdated",(()=>{let e;switch(m.b.getValue("layout")){case v.a.IRC:e="IRC";break;case v.a.Bubble:e="Bubble";break;case v.a.Group:e=m.b.getValue("useCompactLayout")?"Compact":"Group"}this.setProperty("WebLayout",e)})),r()(this,"onAction",(e=>{if(e.action!==p.a.SettingUpdated)return;["layout","useCompactLayout"].includes(e.settingName)&&this.onLayoutUpdated()})),r()(this,"lastScreen","Loading"),r()(this,"sanitizeProperties",((e,t)=>("$pageview"===t&&(this.lastScreen=e.$current_url),e.$current_url=this.lastScreen,this.anonymity==S.Anonymous&&(e.$referrer=null,e.$referring_domain=null,e.$initial_referrer=null,e.$initial_referring_domain=null,e.$device_id=null),e)));const t=u.b.getObject("posthog");t?(this.posthog.init(t.get("project_api_key"),{api_host:t.get("api_host"),autocapture:!1,mask_all_text:!0,mask_all_element_attributes:!0,capture_pageview:!1,sanitize_properties:this.sanitizeProperties,respect_dnt:!0,advanced_disable_decide:!0}),this.enabled=!0):this.enabled=!1,g.a.register(this.onAction),m.b.monitorSetting("layout",null),m.b.monitorSetting("useCompactLayout",null),this.onLayoutUpdated()}registerSuperProperties(e){this.enabled&&this.posthog.register(e)}static async getPlatformProperties(){const e=d.a.get();let t;try{t=await(null==e?void 0:e.getAppVersion())}catch(e){t="unknown"}return{appVersion:t,appPlatform:null==e?void 0:e.getHumanReadableName()}}capture(e,t,n){if(!this.enabled)return;const{origin:i,hash:s,pathname:o}=window.location;t.redactedCurrentUrl=function(e,t,n){let i;if(e.startsWith("file://")&&(n="/<redacted_file_scheme_url>/"),""==t)i="";else{let[e,n]=t.split("/");E.has(n)||(n="<redacted_screen_name>"),i=`${e}/${n}/<redacted>`}return e+n+i}(i,s,o),this.posthog.capture(e,y(y({},this.propertiesForNextEvent),t)),this.propertiesForNextEvent={}}isEnabled(){return this.enabled}setAnonymity(e){!this.enabled||e!=S.Disabled&&e!=S.Anonymous||(this.posthog.reset(),this.registerSuperProperties(this.platformSuperProperties)),this.anonymity=e}static getRandomAnalyticsId(){return[...crypto.getRandomValues(new Uint8Array(16))].map((e=>e.toString(16))).join("")}async identifyUser(e,t){if(this.anonymity==S.Pseudonymous)try{const n=await e.getAccountDataFromServer(w.ANALYTICS_EVENT_TYPE);let i=null==n?void 0:n.id;i||(i=t(),await e.setAccountData(w.ANALYTICS_EVENT_TYPE,Object.assign({id:i},n))),this.posthog.identify(i)}catch(e){l.a.log("Unable to identify user for tracking"+e.toString())}}getAnonymity(){return this.anonymity}logout(){this.enabled&&this.posthog.reset(),this.setAnonymity(S.Disabled)}trackEvent(e,t){let{eventName:n}=e,i=s()(e,f);this.anonymity!=S.Disabled&&this.anonymity!=S.Anonymous&&this.capture(n,i,t)}setProperty(e,t){this.userPropertyCache[e]!==t&&(this.userPropertyCache[e]=t,this.propertiesForNextEvent.$set||(this.propertiesForNextEvent.$set={}),this.propertiesForNextEvent.$set[e]=t)}setPropertyOnce(e,t){this.userPropertyCache[e]||(this.userPropertyCache[e]=t,this.propertiesForNextEvent.$set_once||(this.propertiesForNextEvent.$set_once={}),this.propertiesForNextEvent.$set_once[e]=t)}async updatePlatformSuperProperties(){this.platformSuperProperties=await w.getPlatformProperties(),this.registerSuperProperties(this.platformSuperProperties)}async updateAnonymityFromSettings(e){const t=e?S.Pseudonymous:S.Disabled;this.setAnonymity(t),t===S.Pseudonymous&&(await this.identifyUser(h.a.get(),w.getRandomAnalyticsId),h.a.currentUserIsJustRegistered()&&this.trackNewUserEvent()),t!==S.Disabled&&await w.instance.updatePlatformSuperProperties()}startListeningToSettingsChanges(){m.b.watchSetting("pseudonymousAnalyticsOptIn",null,((e,t,n,i,s)=>{this.updateAnonymityFromSettings(!!s)}))}setAuthenticationType(e){this.authenticationType=e}trackNewUserEvent(){const e={},t=parseInt(window.localStorage.getItem("mx_registration_time"),10);return isNaN(t)||(e.timestamp=new Date(t)),this.trackEvent({eventName:"Signup",authenticationType:this.authenticationType},e)}}r()(w,"_instance",null),r()(w,"ANALYTICS_EVENT_TYPE","im.vector.analytics")},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return o})),function(e){e.Invite="im.vector.fake.invite",e.Untagged="im.vector.fake.recent",e.Archived="im.vector.fake.archived",e.LowPriority="m.lowpriority",e.Favourite="m.favourite",e.DM="im.vector.fake.direct",e.Unified="de.spiritcroc.fake.unified",e.ServerNotice="m.server_notice",e.Suggested="im.vector.fake.suggested",e.SavedItems="im.vector.fake.saved_items"}(i||(i={}));const s=[i.Invite,i.Favourite,i.SavedItems,i.Unified,i.DM,i.Untagged,i.LowPriority,i.ServerNotice,i.Suggested,i.Archived];let o;!function(e){e.Timeline="TIMELINE",e.PossibleTagChange="POSSIBLE_TAG_CHANGE",e.ReadReceipt="READ_RECEIPT",e.NewRoom="NEW_ROOM",e.RoomRemoved="ROOM_REMOVED"}(o||(o={}))},function(e,t,n){"use strict";var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l),u=n(149),h=n(262),m=n(126),p=n(124),g=n(139),v=n(133),f=n(142),b=n(575),y=n(121);const S=["name","idName","title","url","urls","width","height","resizeMethod","defaultToInitialLetter","onClick","inputRef","className"],E=function(e,t){let n=[];return arguments.length>2&&void 0!==arguments[2]&&arguments[2]||(n=t||[],e&&(n=[e,...n])),Array.from(new Set(n))};t.a=e=>{const{name:t,idName:n,title:i,url:o,urls:l,width:w=40,height:_=40,resizeMethod:C="crop",defaultToInitialLetter:O=!0,onClick:I,inputRef:R,className:k}=e,x=r()(e,S),[T,j]=(e=>{let{url:t,urls:n}=e;const i=Object(a.useContext)(g.b),s=i?i.lowBandwidth:m.b.getValue("lowBandwidth"),[o,r]=Object(a.useState)(E(t,n,s)),[c,l]=Object(a.useState)(0),d=Object(a.useCallback)((()=>{l((e=>e+1))}),[]);Object(a.useEffect)((()=>{r(E(t,n,s)),l(0)}),[t,JSON.stringify(n)]);const h=Object(a.useContext)(v.a),p=Object(a.useCallback)(((e,t)=>{"ERROR"!==e&&t!==e&&l(0)}),[]);return Object(f.c)(h,u.b.Sync,p),[o[c],d]})({url:o,urls:l});if(!T&&O&&t){const e=h.e(t),o=c.a.createElement("span",{className:"mx_BaseAvatar_initial","aria-hidden":"true",style:{fontSize:Object(b.a)(.65*w),width:Object(b.a)(w),lineHeight:Object(b.a)(_)}},e),r=c.a.createElement("img",{className:"mx_BaseAvatar_image",src:h.d(n||t),alt:"",title:i,onError:j,style:{width:Object(b.a)(w),height:Object(b.a)(_)},"aria-hidden":"true","data-testid":"avatar-img"});return I?c.a.createElement(p.a,s()({"aria-label":Object(y.a)("Avatar"),"aria-live":"off"},x,{element:"span",className:d()("mx_BaseAvatar",k),onClick:I,inputRef:R}),o,r):c.a.createElement("span",s()({className:d()("mx_BaseAvatar",k),ref:R},x,{role:"presentation"}),o,r)}return I?c.a.createElement(p.a,s()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",k),element:"img",src:T,onClick:I,onError:j,style:{width:Object(b.a)(w),height:Object(b.a)(_)},title:i,alt:Object(y.a)("Avatar"),inputRef:R,"data-testid":"avatar-img"},x)):c.a.createElement("img",s()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",k),src:T,onError:j,style:{width:Object(b.a)(w),height:Object(b.a)(_)},title:i,alt:"",ref:R,"data-testid":"avatar-img"},x))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(17),r=n.n(o);class a extends r.a{constructor(){super(...arguments),s()(this,"toasts",[]),s()(this,"countSeen",0)}static sharedInstance(){return window.mxToastStore||(window.mxToastStore=new a),window.mxToastStore}reset(){this.toasts=[],this.countSeen=0}addOrReplaceToast(e){const t=this.toasts.findIndex((t=>t.key===e.key));if(-1===t){let t=this.toasts.length;for(;t>0&&this.toasts[t-1].priority<e.priority;)--t;this.toasts.splice(t,0,e)}else this.toasts[t]=e;this.emit("update")}dismissToast(e){this.toasts[0]&&this.toasts[0].key===e&&this.countSeen++;const t=this.toasts.length;this.toasts=this.toasts.filter((t=>t.key!==e)),t!==this.toasts.length&&(0===this.toasts.length&&(this.countSeen=0),this.emit("update"))}getToasts(){return this.toasts}getCountSeen(){return this.countSeen}}},function(e,t,n){"use strict";n.d(t,"g",(function(){return i.b})),n.d(t,"c",(function(){return i.a})),n.d(t,"h",(function(){return i.c})),n.d(t,"m",(function(){return E})),n.d(t,"l",(function(){return w})),n.d(t,"i",(function(){return _})),n.d(t,"o",(function(){return P})),n.d(t,"v",(function(){return L})),n.d(t,"s",(function(){return U})),n.d(t,"r",(function(){return $})),n.d(t,"E",(function(){return G})),n.d(t,"b",(function(){return Y})),n.d(t,"a",(function(){return ee})),n.d(t,"d",(function(){return ne})),n.d(t,"e",(function(){return re})),n.d(t,"f",(function(){return Se})),n.d(t,"k",(function(){return Re})),n.d(t,"u",(function(){return ke})),n.d(t,"A",(function(){return xe})),n.d(t,"O",(function(){return De})),n.d(t,"j",(function(){return qe})),n.d(t,"B",(function(){return Ge})),n.d(t,"p",(function(){return rt})),n.d(t,"t",(function(){return at})),n.d(t,"w",(function(){return vt})),n.d(t,"Q",(function(){return ft})),n.d(t,"R",(function(){return bt})),n.d(t,"S",(function(){return St})),n.d(t,"T",(function(){return lt})),n.d(t,"n",(function(){return Et.a})),n.d(t,"q",(function(){return wt})),n.d(t,"y",(function(){return _t})),n.d(t,"x",(function(){return Ct})),n.d(t,"C",(function(){return T})),n.d(t,"D",(function(){return Ot})),n.d(t,"F",(function(){return It})),n.d(t,"G",(function(){return Rt})),n.d(t,"H",(function(){return jt})),n.d(t,"I",(function(){return Pt})),n.d(t,"J",(function(){return yt})),n.d(t,"K",(function(){return Dt})),n.d(t,"L",(function(){return Nt})),n.d(t,"M",(function(){return Mt})),n.d(t,"N",(function(){return At})),n.d(t,"P",(function(){return Ft})),n.d(t,"z",(function(){return Bt}));var i=n(264),s=n(122),o=n.n(s),r=n(137),a=n(159),c=n(204),l=n(1),d=n(16),u=n(255),h=n(513),m=n(154),p=n(512),g=n(361);let v;!function(e){e.Add="add"}(v||(v={}));class f extends a.b{constructor(e,t,n,i){super(),this.event=e,this.relationType=t,this.relationEventType=n,this.client=i,o()(this,"relations",void 0),o()(this,"eventId",void 0),o()(this,"roomId",void 0),o()(this,"setUpRelations",(()=>{this.setRelations(),this.relations?this.relations.on(g.b.Add,this.onRelationsAdd):this.event.once(r.MatrixEventEvent.RelationsCreated,this.onRelationsCreated)})),o()(this,"onRelationsCreated",(()=>{this.setRelations(),this.relations?(this.relations.on(g.b.Add,this.onRelationsAdd),this.emitCurrent()):this.event.once(r.MatrixEventEvent.RelationsCreated,this.onRelationsCreated)})),o()(this,"onRelationsAdd",(e=>{this.emit(v.Add,e)}));const s=e.getId();if(!s)throw new Error("unable to create RelationsHelper: missing event ID");const a=e.getRoomId();if(!a)throw new Error("unable to create RelationsHelper: missing room ID");this.eventId=s,this.roomId=a,this.setUpRelations()}setRelations(){var e,t;const n=this.client.getRoom(this.event.getRoomId());this.relations=null==n||null===(e=n.getUnfilteredTimelineSet())||void 0===e||null===(t=e.relations)||void 0===t?void 0:t.getChildEventsForEvent(this.eventId,this.relationType,this.relationEventType)}emitCurrent(){var e,t;null===(e=this.relations)||void 0===e||null===(t=e.getRelations())||void 0===t||t.forEach((e=>this.emit(v.Add,e)))}getCurrent(){var e;return(null===(e=this.relations)||void 0===e?void 0:e.getRelations())||[]}async emitFetchCurrent(){let e;do{const t=await this.client.relations(this.roomId,this.eventId,this.relationType,this.relationEventType,{from:e,limit:50});e=null==t?void 0:t.nextBatch,null==t||t.events.forEach((e=>this.emit(v.Add,e)))}while(e)}destroy(){this.removeAllListeners(),this.event.off(r.MatrixEventEvent.RelationsCreated,this.onRelationsCreated),this.relations&&this.relations.off(g.b.Add,this.onRelationsAdd)}}class b{constructor(){o()(this,"events",[]),o()(this,"addOrReplaceEvent",(e=>(this.events=this.events.filter((t=>!this.equalByTxnIdOrId(e,t))),this.events.push(e),!0))),o()(this,"compareBySequence",((e,t)=>{var n,s,o,r;return((null===(n=e.getContent())||void 0===n||null===(s=n[i.a])||void 0===s?void 0:s.sequence)||0)-((null===(o=t.getContent())||void 0===o||null===(r=o[i.a])||void 0===r?void 0:r.sequence)||0)})),o()(this,"compareByTimestamp",((e,t)=>e.getTs()-t.getTs()))}getEvents(){return[...this.events]}getNext(e){return this.events[this.events.indexOf(e)+1]}addEvent(e){this.addOrReplaceEvent(e)&&this.sort()}addEvents(e){e.reduce(((e,t)=>this.addOrReplaceEvent(t)||e),!1)&&this.sort()}includes(e){return!!this.events.find((t=>this.equalByTxnIdOrId(e,t)))}getLength(){return this.events.reduce(((e,t)=>e+this.calculateChunkLength(t)),0)}getLengthSeconds(){return this.getLength()/1e3}getLengthTo(e){let t=0;for(let n=0;n<this.events.indexOf(e);n++)t+=this.calculateChunkLength(this.events[n]);return t}findByTime(e){let t=0;for(let n=0;n<this.events.length;n++)if(t+=this.calculateChunkLength(this.events[n]),t>=e)return this.events[n];return null}isLast(e){return this.events.indexOf(e)>=this.events.length-1}getSequenceForEvent(e){var t,n;const s=parseInt(null===(t=e.getContent())||void 0===t||null===(n=t[i.a])||void 0===n?void 0:n.sequence,10);return isNaN(s)?this.events.includes(e)?this.events.indexOf(e)+1:null:s}getNumberOfEvents(){return this.events.length}calculateChunkLength(e){var t,n,i,s;return(null===(t=e.getContent())||void 0===t||null===(n=t["org.matrix.msc1767.audio"])||void 0===n?void 0:n.duration)||(null===(i=e.getContent())||void 0===i||null===(s=i.info)||void 0===s?void 0:s.duration)||0}equalByTxnIdOrId(e,t){return e.getTxnId()&&t.getTxnId()&&e.getTxnId()===t.getTxnId()||e.getId()===t.getId()}sort(){const e=this.allHaveSequence()?this.compareBySequence:this.compareByTimestamp;this.events.sort(e)}allHaveSequence(){return!this.events.some((e=>{var t,n;const s=null===(t=e.getContent())||void 0===t||null===(n=t[i.a])||void 0===n?void 0:n.sequence;return parseInt(s,10)!==s}))}}const y=new Map([["started","live"],["resumed","live"],["paused","grey"],["stopped","not-live"]]);var S=n(121);let E,w;!function(e){e.Paused="pause",e.Playing="playing",e.Stopped="stopped",e.Buffering="buffering",e.Error="error"}(E||(E={})),function(e){e.TimesChanged="times_changed",e.LivenessChanged="liveness_changed",e.StateChanged="state_changed",e.InfoStateChanged="info_state_changed"}(w||(w={}));class _ extends a.b{constructor(e,t,n){super(),this.infoEvent=e,this.client=t,this.recordings=n,o()(this,"state",E.Stopped),o()(this,"chunkEvents",new b),o()(this,"utdChunkEvents",new Map),o()(this,"playbacks",new Map),o()(this,"currentlyPlaying",null),o()(this,"duration",0),o()(this,"position",0),o()(this,"liveData",new c.SimpleObservable),o()(this,"liveness","not-live"),o()(this,"infoState",void 0),o()(this,"lastInfoEvent",void 0),o()(this,"chunkRelationHelper",void 0),o()(this,"infoRelationHelper",void 0),o()(this,"skipToNext",void 0),o()(this,"skipToDeferred",void 0),o()(this,"addChunkEvent",(async e=>{var t;return!(!e.getId()&&!e.getTxnId())&&(e.isDecryptionFailure()?(this.onChunkEventDecryptionFailure(e),!1):(null===(t=e.getContent())||void 0===t?void 0:t.msgtype)===r.MsgType.Audio&&(this.chunkEvents.addEvent(e),this.setDuration(this.chunkEvents.getLength()),this.getState()===E.Buffering&&await this.startOrPlayNext(),!0))})),o()(this,"onChunkEventDecryptionFailure",(e=>{const t=e.getId();t?(this.utdChunkEvents.has(t)||e.once(r.MatrixEventEvent.Decrypted,this.onChunkEventDecrypted),this.utdChunkEvents.set(t,e),this.setError()):l.a.warn("Broadcast chunk decryption failure for event without Id",{broadcast:this.infoEvent.getId()})})),o()(this,"onChunkEventDecrypted",(async e=>{const t=e.getId();t?(this.utdChunkEvents.delete(t),await this.addChunkEvent(e),0===this.utdChunkEvents.size&&this.setState(E.Paused)):l.a.warn("Broadcast chunk decrypted for event without Id",{broadcast:this.infoEvent.getId()})})),o()(this,"startOrPlayNext",(async()=>this.currentlyPlaying?this.playNext():await this.start())),o()(this,"addInfoEvent",(e=>{var t;if(this.lastInfoEvent&&this.lastInfoEvent.getTs()>=e.getTs())return;const n=null===(t=e.getContent())||void 0===t?void 0:t.state;Object.values(i.c).includes(n)&&(this.lastInfoEvent=e,this.setInfoState(n))})),o()(this,"onBeforeRedaction",(()=>{this.getState()!==E.Stopped&&(this.stop(),this.destroy())})),o()(this,"onPlaybackPositionUpdate",((e,t)=>{if(e!==this.currentlyPlaying)return;const n=this.chunkEvents.getLengthTo(e)+1e3*t;n<this.position||this.setPosition(n)})),o()(this,"onPlaybackStateChange",(async(e,t)=>{e===this.currentlyPlaying&&t===u.d.Stopped&&(await this.playNext(),this.unloadPlayback(e))})),this.addInfoEvent(this.infoEvent),this.infoEvent.on(r.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.setUpRelationsHelper()}async setUpRelationsHelper(){if(this.infoRelationHelper=new f(this.infoEvent,r.RelationType.Reference,i.b,this.client),this.infoRelationHelper.getCurrent().forEach(this.addInfoEvent),this.infoState!==i.c.Stopped){this.infoRelationHelper.on(v.Add,this.addInfoEvent);try{await this.infoRelationHelper.emitFetchCurrent()}catch(e){l.a.warn("error fetching server side relation for voice broadcast info",e),this.infoRelationHelper.emitCurrent()}}this.chunkRelationHelper=new f(this.infoEvent,r.RelationType.Reference,r.EventType.RoomMessage,this.client),this.chunkRelationHelper.on(v.Add,this.addChunkEvent);try{await this.chunkRelationHelper.emitFetchCurrent()}catch(e){l.a.warn("error fetching server side relation for voice broadcast chunks",e),this.chunkRelationHelper.emitCurrent()}}async tryLoadPlayback(e){try{return await this.loadPlayback(e)}catch(t){l.a.warn("Unable to load broadcast playback",{message:t.message,broadcastId:this.infoEvent.getId(),chunkId:e.getId()}),this.setError()}}async loadPlayback(e){const t=e.getId();if(!t)throw new Error("Broadcast chunk event without Id occurred");const n=new p.a(e),i=await n.sourceBlob.value,s=await i.arrayBuffer(),o=h.a.instance.createPlaybackInstance(s);await o.prepare(),o.clockInfo.populatePlaceholdersFrom(e),this.playbacks.set(t,o),o.on(m.b,(t=>this.onPlaybackStateChange(e,t))),o.clockInfo.liveData.onUpdate((t=>{let[n]=t;this.onPlaybackPositionUpdate(e,n)}))}unloadPlayback(e){const t=this.playbacks.get(e.getId());t&&(t.destroy(),this.playbacks.delete(e.getId()))}setDuration(e){this.duration!==e&&(this.duration=e,this.emitTimesChanged(),this.liveData.update([this.timeSeconds,this.durationSeconds]))}setPosition(e){this.position!==e&&(this.position=e,this.emitTimesChanged(),this.liveData.update([this.timeSeconds,this.durationSeconds]))}emitTimesChanged(){this.emit(w.TimesChanged,{duration:this.durationSeconds,position:this.timeSeconds,timeLeft:this.timeLeftSeconds})}async playNext(){if(!this.currentlyPlaying)return;const e=this.chunkEvents.getNext(this.currentlyPlaying);if(e)return this.playEvent(e);this.getInfoState()===i.c.Stopped&&this.chunkEvents.getSequenceForEvent(this.currentlyPlaying)===this.lastChunkSequence?this.stop():this.setState(E.Buffering)}get lastChunkSequence(){var e;return(null===(e=this.lastInfoEvent.getContent())||void 0===e?void 0:e.last_chunk_sequence)||this.chunkEvents.getNumberOfEvents()}async playEvent(e){this.setState(E.Playing),this.currentlyPlaying=e;const t=await this.tryGetOrLoadPlaybackForEvent(e);null==t||t.play()}async tryGetOrLoadPlaybackForEvent(e){try{return await this.getOrLoadPlaybackForEvent(e)}catch(t){l.a.warn("Unable to load broadcast playback",{message:t.message,broadcastId:this.infoEvent.getId(),chunkId:e.getId()}),this.setError()}}async getOrLoadPlaybackForEvent(e){const t=e.getId();if(!t)throw new Error("Broadcast chunk event without Id occurred");if(!this.playbacks.has(t)){const t=this.getState();this.setState(E.Buffering),await this.loadPlayback(e),this.setState(t)}const n=this.playbacks.get(t);if(!n)throw new Error(`Unable to find playback for event ${e.getId()}`);const i=this.chunkEvents.getNext(e);return i&&this.tryLoadPlayback(i),n}getCurrentPlayback(){if(this.currentlyPlaying)return this.playbacks.get(this.currentlyPlaying.getId())}getLiveness(){return this.liveness}setLiveness(e){this.liveness!==e&&(this.liveness=e,this.emit(w.LivenessChanged,e))}get currentState(){return u.d.Playing}get timeSeconds(){return this.position/1e3}get durationSeconds(){return this.duration/1e3}get timeLeftSeconds(){return Math.max(0,Math.round(this.durationSeconds)-this.timeSeconds)}async skipTo(e){if(this.skipToNext=e,this.skipToDeferred)return this.skipToDeferred.promise;for(this.skipToDeferred=Object(d.m)();void 0!==this.skipToNext;){const e=this.skipToNext;this.skipToNext=void 0,await this.doSkipTo(e)}this.skipToDeferred.resolve(),this.skipToDeferred=void 0}async doSkipTo(e){const t=1e3*e,n=this.chunkEvents.findByTime(t);if(!n)return void l.a.warn("voice broadcast chunk event to skip to not found");const i=this.getCurrentPlayback(),s=await this.tryGetOrLoadPlaybackForEvent(n),o=this.currentlyPlaying;if(!s)return void l.a.warn("voice broadcast chunk to skip to not found",n);this.currentlyPlaying=n,i&&o&&i!==s&&(i.off(m.b,this.onPlaybackStateChange),await i.stop(),i.on(m.b,this.onPlaybackStateChange),this.unloadPlayback(o));const r=t-this.chunkEvents.getLengthTo(n);await s.skipTo(r/1e3),this.state!==E.Playing||s.isPlaying||await s.play(),this.setPosition(t)}async start(){if(this.state===E.Playing)return;const e=this.recordings.getCurrent();if(e&&e.getState()!==i.c.Stopped){var t;if(!await De())return;await(null===(t=this.recordings.getCurrent())||void 0===t?void 0:t.stop())}const n=this.chunkEvents.getEvents(),s=this.getInfoState()===i.c.Stopped?n[0]:n[n.length-1];if(s)return this.playEvent(s);this.setState(E.Buffering)}stop(){var e;this.getState()!==E.Error&&(this.setState(E.Stopped),null===(e=this.getCurrentPlayback())||void 0===e||e.stop(),this.currentlyPlaying=null,this.setPosition(0))}pause(){var e;this.getState()!==E.Error&&this.getState()!==E.Stopped&&(this.setState(E.Paused),null===(e=this.getCurrentPlayback())||void 0===e||e.pause())}resume(){var e;this.getState()!==E.Error&&(this.currentlyPlaying?(this.setState(E.Playing),null===(e=this.getCurrentPlayback())||void 0===e||e.play()):this.start())}async toggle(){this.getState()!==E.Error&&(this.state!==E.Stopped?this.state!==E.Paused?this.pause():this.resume():await this.start())}getState(){return this.state}setState(e){this.state!==e&&(this.state=e,this.emit(w.StateChanged,e,this))}setError(){var e;this.setState(E.Error),null===(e=this.getCurrentPlayback())||void 0===e||e.stop(),this.currentlyPlaying=null,this.setPosition(0)}getInfoState(){return this.infoState}setInfoState(e){var t,n;this.infoState!==e&&(this.infoState=e,this.emit(w.InfoStateChanged,e),this.setLiveness((t=this.infoState,null!==(n=y.get(t))&&void 0!==n?n:"not-live")))}get errorMessage(){return this.getState()!==E.Error?"":this.utdChunkEvents.size?Object(S.a)("Unable to decrypt voice broadcast"):Object(S.a)("Unable to play this voice broadcast")}destroy(){for(const[,e]of this.utdChunkEvents)e.off(r.MatrixEventEvent.Decrypted,this.onChunkEventDecrypted);this.utdChunkEvents.clear(),this.chunkRelationHelper.destroy(),this.infoRelationHelper.destroy(),this.removeAllListeners(),this.chunkEvents=new b,this.playbacks.forEach((e=>e.destroy())),this.playbacks=new Map}}var C=n(120),O=n.n(C),I=n(219),R=n(216),k=n(128);const x=()=>{k.b.createDialog(R.a,{title:Object(S.a)("Can't start a new voice broadcast"),description:O.a.createElement("p",null,Object(S.a)("You are already recording a voice broadcast. Please end your current voice broadcast to start a new one.")),hasCloseButton:!0})},T=async(e,t,n)=>{if(n.getCurrent())return x(),!1;const s=t.getUserId();if(!s)return!1;if(!e.currentState.maySendStateEvent(i.b,s))return k.b.createDialog(R.a,{title:Object(S.a)("Can't start a new voice broadcast"),description:O.a.createElement("p",null,Object(S.a)("You don't have the required permissions to start a voice broadcast in this room. Contact a room administrator to upgrade your permissions.")),hasCloseButton:!0}),!1;if(t.getSyncState()===I.b.Error)return k.b.createDialog(R.a,{title:Object(S.a)("Connection error"),description:O.a.createElement("p",null,Object(S.a)("Unfortunately we're unable to start a recording right now. Please try again later.")),hasCloseButton:!0}),!1;const{hasBroadcast:o,startedByUser:r}=await yt(t,e,s);return o&&r?(x(),!1):!o||(k.b.createDialog(R.a,{title:Object(S.a)("Can't start a new voice broadcast"),description:O.a.createElement("p",null,Object(S.a)("Someone else is already recording a voice broadcast. Wait for their voice broadcast to end to start a new one.")),hasCloseButton:!0}),!1)},j=async(e,t,n,s)=>{var o;return await T(e,t,s)?(null===(o=n.getCurrent())||void 0===o||o.pause(),n.clearCurrent(),(async(e,t,n)=>{const{promise:s,resolve:o,reject:a}=Object(d.m)(),c=t.getUserId();if(!c)return a("unable to start voice broadcast if current user is unknown"),s;let l=null;const u=()=>{if(!l)return;const s=e.currentState.getStateEvents(i.b,c);if((null==s?void 0:s.getId())===l.event_id){e.off(r.RoomStateEvent.Events,u);const i=new U(s,t);n.setCurrent(i),i.start(),o(i)}};return e.on(r.RoomStateEvent.Events,u),l=await t.sendStateEvent(e.roomId,i.b,{device_id:t.getDeviceId(),state:i.c.Started,chunk_length:jt()},c),s})(e,t,s)):null};class P extends a.b{constructor(e,t,n,i,s){super(),this.room=e,this.sender=t,this.client=n,this.playbacksStore=i,this.recordingsStore=s,o()(this,"start",(async()=>{await j(this.room,this.client,this.playbacksStore,this.recordingsStore),this.emit("dismiss",this)})),o()(this,"cancel",(()=>{this.emit("dismiss",this)}))}destroy(){this.removeAllListeners()}}var D=n(287),N=n(878),M=n(125),A=n(633);let L;!function(e){e.StateChanged="liveness_changed",e.TimeLeftChanged="time_left_changed"}(L||(L={}));class U extends a.b{constructor(e,t,n){super(),this.infoEvent=e,this.client=t,o()(this,"state",void 0),o()(this,"recorder",null),o()(this,"dispatcherRef",void 0),o()(this,"chunkEvents",new b),o()(this,"chunkRelationHelper",void 0),o()(this,"maxLength",void 0),o()(this,"timeLeft",void 0),o()(this,"toRetry",[]),o()(this,"reconnectedListener",void 0),o()(this,"roomId",void 0),o()(this,"infoEventId",void 0),o()(this,"sequence",0),o()(this,"onChunkEvent",(e=>{var t;(e.getId()||e.getTxnId())&&(null===(t=e.getContent())||void 0===t?void 0:t.msgtype)===r.MsgType.Audio&&this.chunkEvents.addEvent(e)})),o()(this,"onReconnect",(async()=>{if("connection_error"!==this.state)return;const e=[...this.toRetry];for(const t of this.toRetry)try{await t(),e.splice(e.indexOf(t),1)}catch{break}this.toRetry=e,0===this.toRetry.length&&await this.pause()})),o()(this,"toggle",(async()=>this.getState()===i.c.Paused?this.resume():[i.c.Started,i.c.Resumed].includes(this.getState())?this.pause():void 0)),o()(this,"onBeforeRedaction",(()=>{this.getState()!==i.c.Stopped&&(this.setState(i.c.Stopped),this.destroy())})),o()(this,"onAction",(e=>{"call_state"===e.action&&this.pause()})),o()(this,"onCurrentChunkLengthUpdated",(e=>{this.setTimeLeft(this.maxLength-this.chunkEvents.getLengthSeconds()-e)})),o()(this,"onChunkRecorded",(async e=>{await this.callWithRetry((async()=>{const{url:t,file:n}=await this.uploadFile(e);await this.sendVoiceMessage(e,t,n)}))})),this.maxLength=Pt(),this.timeLeft=this.maxLength,this.infoEventId=this.determineEventIdFromInfoEvent(),this.roomId=this.determineRoomIdFromInfoEvent(),this.state=n||this.determineInitialStateFromInfoEvent(),this.infoEvent.on(r.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.dispatcherRef=M.a.register(this.onAction),this.chunkRelationHelper=this.initialiseChunkEventRelation(),this.reconnectedListener=Object(A.a)(this.onReconnect),this.client.on(r.ClientEvent.Sync,this.reconnectedListener)}initialiseChunkEventRelation(){const e=new f(this.infoEvent,r.RelationType.Reference,r.EventType.RoomMessage,this.client);return e.on(v.Add,this.onChunkEvent),e.emitFetchCurrent().catch((t=>{l.a.warn("error fetching server side relation for voice broadcast chunks",t),e.emitCurrent()})),e}determineEventIdFromInfoEvent(){const e=this.infoEvent.getId();if(!e)throw new Error("Cannot create broadcast for info event without Id.");return e}determineRoomIdFromInfoEvent(){const e=this.infoEvent.getRoomId();if(!e)throw new Error(`Cannot create broadcast for unknown room (info event ${this.infoEventId})`);return e}determineInitialStateFromInfoEvent(){var e,t;const n=this.client.getRoom(this.roomId),s=null==n||null===(e=n.getUnfilteredTimelineSet())||void 0===e||null===(t=e.relations)||void 0===t?void 0:t.getChildEventsForEvent(this.infoEventId,r.RelationType.Reference,i.b),o=null==s?void 0:s.getRelations();return null!=o&&o.find((e=>{var t;return(null===(t=e.getContent())||void 0===t?void 0:t.state)===i.c.Stopped}))?i.c.Stopped:i.c.Started}getTimeLeft(){return this.timeLeft}async setTimeLeft(e){if(e<=0)return await this.stop();e>=this.timeLeft||(this.timeLeft=e,this.emit(L.TimeLeftChanged,e))}async start(){return this.getRecorder().start()}async stop(){this.state!==i.c.Stopped&&(this.setState(i.c.Stopped),await this.stopRecorder(),await this.sendInfoStateEvent(i.c.Stopped))}async pause(){[i.c.Stopped,i.c.Paused].includes(this.state)||(this.setState(i.c.Paused),await this.stopRecorder(),await this.sendInfoStateEvent(i.c.Paused))}async resume(){this.state===i.c.Paused&&(this.setState(i.c.Resumed),await this.getRecorder().start(),await this.sendInfoStateEvent(i.c.Resumed))}getState(){return this.state}getRecorder(){return this.recorder||(this.recorder=G(),this.recorder.on($.ChunkRecorded,this.onChunkRecorded),this.recorder.on($.CurrentChunkLengthUpdated,this.onCurrentChunkLengthUpdated)),this.recorder}async destroy(){this.recorder&&(this.recorder.stop(),this.recorder.destroy()),this.infoEvent.off(r.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.removeAllListeners(),M.a.unregister(this.dispatcherRef),this.chunkEvents=new b,this.chunkRelationHelper.destroy(),this.client.off(r.ClientEvent.Sync,this.reconnectedListener)}setState(e){this.state=e,this.emit(L.StateChanged,this.state)}async onConnectionError(){await this.stopRecorder(!1),this.setState("connection_error")}async uploadFile(e){return Object(D.b)(this.client,this.roomId,new Blob([e.buffer],{type:this.getRecorder().contentType}))}async sendVoiceMessage(e,t,n){const i=++this.sequence;await this.callWithRetry((async()=>{const s=Object(N.a)(t,this.getRecorder().contentType,Math.round(1e3*e.length),e.buffer.length,n);s["m.relates_to"]={rel_type:r.RelationType.Reference,event_id:this.infoEventId},s["io.element.voice_broadcast_chunk"]={sequence:i},await this.client.sendMessage(this.roomId,s)}))}async sendInfoStateEvent(e){await this.callWithRetry((async()=>{await this.client.sendStateEvent(this.roomId,i.b,{device_id:this.client.getDeviceId(),state:e,last_chunk_sequence:this.sequence,"m.relates_to":{rel_type:r.RelationType.Reference,event_id:this.infoEventId}},this.client.getSafeUserId())}))}async callWithRetry(e){try{await e()}catch{this.toRetry.push(e),this.onConnectionError()}}async stopRecorder(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.recorder)try{const t=await this.recorder.stop();t&&e&&await this.onChunkRecorded(t)}catch(e){l.a.warn("error stopping voice broadcast recorder",e)}}}var F=n(150),B=n(356),V=n(147),K=n(598);let $;!function(e){e.ChunkRecorded="chunk_recorded",e.CurrentChunkLengthUpdated="current_chunk_length_updated"}($||($={}));const H=[79,112,117,115,72,101,97,100],W=[79,112,117,115,84,97,103,115];class q extends a.b{constructor(e,t){super(),this.voiceRecording=e,this.targetChunkLength=t,o()(this,"opusHead",void 0),o()(this,"opusTags",void 0),o()(this,"chunkBuffer",new Uint8Array(0)),o()(this,"previousChunkEndTimePosition",0),o()(this,"currentChunkLength",0),o()(this,"onDataAvailable",(e=>{const t=new Uint8Array(e),n=Array.from(t.slice(28,36));Object(F.isEqual)(H,n)?this.opusHead=t:Object(F.isEqual)(W,n)?this.opusTags=t:(this.setCurrentChunkLength(this.voiceRecording.recorderSeconds-this.previousChunkEndTimePosition),this.handleData(t))})),this.voiceRecording.onDataAvailable=this.onDataAvailable}async start(){await this.voiceRecording.start(),this.voiceRecording.liveData.onUpdate((e=>{this.setCurrentChunkLength(e.timeSeconds-this.previousChunkEndTimePosition)}))}async stop(){try{await this.voiceRecording.stop()}catch(e){}K.a.forgetAllFor(this.voiceRecording);const e=this.extractChunk();return this.currentChunkLength=0,this.previousChunkEndTimePosition=0,e}get contentType(){return this.voiceRecording.contentType}setCurrentChunkLength(e){this.currentChunkLength!==e&&(this.currentChunkLength=e,this.emit($.CurrentChunkLengthUpdated,e))}getCurrentChunkLength(){return this.currentChunkLength}handleData(e){this.chunkBuffer=Object(V.m)(this.chunkBuffer,e),this.emitChunkIfTargetLengthReached()}emitChunkIfTargetLengthReached(){this.getCurrentChunkLength()>=this.targetChunkLength&&this.emitAndResetChunk()}extractChunk(){if(0===this.chunkBuffer.length)return null;if(!this.opusHead||!this.opusTags)return l.a.warn("Broadcast chunk cannot be extracted. OpusHead or OpusTags is missing."),null;const e=this.voiceRecording.recorderSeconds,t={buffer:Object(V.m)(this.opusHead,this.opusTags,this.chunkBuffer),length:this.getCurrentChunkLength()};return this.chunkBuffer=new Uint8Array(0),this.setCurrentChunkLength(0),this.previousChunkEndTimePosition=e,t}emitAndResetChunk(){0!==this.chunkBuffer.length&&this.emit($.ChunkRecorded,this.extractChunk())}destroy(){this.removeAllListeners(),this.voiceRecording.destroy()}}const G=()=>{const e=new B.d;return e.disableMaxLength(),new q(e,jt())};var z=n(123),J=n(155);const Y=e=>{var t;let{mxEvent:n}=e;const s=Object(C.useContext)(J.a),o=z.a.get(),[a,c]=Object(C.useState)((null===(t=n.getContent())||void 0===t?void 0:t.state)||i.c.Stopped);if(Object(C.useEffect)((()=>{const e=new f(n,r.RelationType.Reference,i.b,o);return e.on(v.Add,(e=>{var t;(null===(t=e.getContent())||void 0===t?void 0:t.state)===i.c.Stopped&&c(i.c.Stopped)})),e.emitCurrent(),()=>{e.destroy()}})),Mt(a,o,n)){const e=s.voiceBroadcastRecordingsStore.getByInfoEvent(n,o);return O.a.createElement(at,{recording:e})}const l=s.voiceBroadcastPlaybacksStore.getByInfoEvent(n,o);return O.a.createElement(qe,{playback:l})};var Q=n(127),X=n.n(Q),Z=n(405);const ee=e=>{let{grey:t=!1}=e;const n=X()("mx_LiveBadge",{"mx_LiveBadge--grey":t});return O.a.createElement("div",{className:n},O.a.createElement(Z.a,{className:"mx_Icon mx_Icon_16"}),Object(S.a)("Live"))};var te=n(124);const ne=e=>{let{className:t="",icon:n,label:i,onClick:s}=e;return O.a.createElement(te.a,{className:X()("mx_VoiceBroadcastControl",t),onClick:s,"aria-label":i},O.a.createElement(n,{className:"mx_Icon mx_Icon_16"}))};var ie;function se(){return se=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},se.apply(this,arguments)}function oe(e){return C.createElement("svg",se({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0},e),ie||(ie=C.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M8 16A8 8 0 108 0a8 8 0 000 16zM6.98 4.51c-.05-.57.37-1.07.94-1.11.56-.04 1.06.38 1.12.95v.16l-.32 4c-.03.37-.34.65-.71.65h-.06a.707.707 0 01-.65-.65l-.32-4zm1.9 6.61a.88.88 0 11-1.76 0 .88.88 0 011.76 0z",fill:"gray"})))}const re=e=>{let{message:t}=e;return O.a.createElement("div",{className:"mx_VoiceBroadcastRecordingConnectionError"},O.a.createElement(oe,{className:"mx_Icon mx_Icon_16"}),t)};var ae;function ce(){return ce=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ce.apply(this,arguments)}function le(e){return C.createElement("svg",ce({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16.15 19.751",role:"presentation","aria-hidden":!0},e),ae||(ae=C.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.175 3.9a3.9 3.9 0 017.8 0v5.832a3.9 3.9 0 11-7.8 0zM1.25 8.488c.69 0 1.25.56 1.25 1.25a5.57 5.57 0 005.567 5.566h.017a5.57 5.57 0 005.566-5.566 1.25 1.25 0 012.5 0c0 4.03-2.96 7.37-6.825 7.97v.793a1.25 1.25 0 01-2.5 0v-.793C2.96 17.108 0 13.769 0 9.738c0-.69.56-1.25 1.25-1.25z",clipRule:"evenodd"})))}var de;function ue(){return ue=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ue.apply(this,arguments)}function he(e){return C.createElement("svg",ue({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 12 14",role:"presentation","aria-hidden":!0},e),de||(de=C.createElement("path",{d:"M8 0H4v1.333h4V0zM5.333 8.667h1.334v-4H5.333v4zm5.354-4.407l.946-.947c-.286-.34-.6-.66-.94-.94l-.946.947A5.974 5.974 0 006 2a6 6 0 106 6 5.975 5.975 0 00-1.313-3.74zM6 12.667A4.663 4.663 0 011.333 8 4.663 4.663 0 016 3.333 4.663 4.663 0 0110.667 8 4.663 4.663 0 016 12.667z",fill:"currentColor"})))}var me=n(165),pe=n(479),ge=n(344),ve=n(166),fe=n(135),be=n(129),ye=n(148);const Se=e=>{let{linkToRoom:t=!1,live:n="not-live",liveBadgePosition:i="right",onCloseClick:s=(()=>{}),onMicrophoneLineClick:o=null,room:r,microphoneLabel:a,showBroadcast:c=!1,showBuffering:l=!1,bufferingPosition:d="line",showClose:u=!1,timeLeft:h}=e;const m=c&&O.a.createElement("div",{className:"mx_VoiceBroadcastHeader_line"},O.a.createElement(Z.a,{className:"mx_Icon mx_Icon_16"}),Object(S.a)("Voice broadcast")),p="not-live"!==n&&O.a.createElement(ee,{grey:"grey"===n}),g=u&&O.a.createElement(te.a,{onClick:s},O.a.createElement(pe.a,{className:"mx_Icon mx_Icon_16"})),v=h&&O.a.createElement("div",{className:"mx_VoiceBroadcastHeader_line"},O.a.createElement(he,{className:"mx_Icon mx_Icon_16"}),O.a.createElement(ge.a,{formatFn:ve.n,seconds:h})),f=l&&"line"===d&&O.a.createElement("div",{className:"mx_VoiceBroadcastHeader_line"},O.a.createElement(fe.a,{w:14,h:14}),Object(S.a)("Buffering…")),b=X()({mx_VoiceBroadcastHeader_line:!0,"mx_VoiceBroadcastHeader_mic--clickable":o}),y=a&&O.a.createElement(ye.a,{className:b,onClick:o,title:Object(S.a)("Change input device")},O.a.createElement(le,{className:"mx_Icon mx_Icon_16"}),O.a.createElement("span",null,a)),E=()=>{M.a.dispatch({action:be.a.ViewRoom,room_id:r.roomId,metricsTrigger:void 0})};let w=O.a.createElement(me.a,{room:r,width:32,height:32}),_=O.a.createElement("div",{className:"mx_VoiceBroadcastHeader_room_wrapper"},O.a.createElement("div",{className:"mx_VoiceBroadcastHeader_room"},r.name),l&&"title"===d&&O.a.createElement(fe.a,{w:12,h:12}));return t&&(w=O.a.createElement(te.a,{onClick:E},w),_=O.a.createElement(te.a,{onClick:E},_)),O.a.createElement("div",{className:"mx_VoiceBroadcastHeader"},w,O.a.createElement("div",{className:"mx_VoiceBroadcastHeader_content"},_,y,v,m,f,"middle"===i&&p),"right"===i&&p,g)};var Ee;function we(){return we=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},we.apply(this,arguments)}function _e(e){return C.createElement("svg",we({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 13 16",role:"presentation","aria-hidden":!0},e),Ee||(Ee=C.createElement("path",{d:"M0 14.21V1.79A1 1 0 011.524.938l10.092 6.21a1 1 0 010 1.704l-10.092 6.21A1 1 0 010 14.21z",fill:"currentColor"})))}var Ce;function Oe(){return Oe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Oe.apply(this,arguments)}function Ie(e){return C.createElement("svg",Oe({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 10 12",role:"presentation","aria-hidden":!0},e),Ce||(Ce=C.createElement("path",{d:"M0 1a1 1 0 011-1h1a1 1 0 011 1v10a1 1 0 01-1 1H1a1 1 0 01-1-1V1zM7 1a1 1 0 011-1h1a1 1 0 011 1v10a1 1 0 01-1 1H8a1 1 0 01-1-1V1z",fill:"currentColor"})))}const Re=e=>{let t,n,{onClick:i,state:s}=e,o="";switch(s){case E.Stopped:t=_e,o="mx_VoiceBroadcastControl-play",n=Object(S.a)("play voice broadcast");break;case E.Paused:t=_e,o="mx_VoiceBroadcastControl-play",n=Object(S.a)("resume voice broadcast");break;case E.Buffering:case E.Playing:t=Ie,n=Object(S.a)("pause voice broadcast")}return O.a.createElement(ne,{className:o,label:n,icon:t,onClick:i})},ke=()=>O.a.createElement("div",{className:"mx_VoiceBroadcastRecordingConnectionError"},O.a.createElement(oe,{className:"mx_Icon mx_Icon_16"}),Object(S.a)("Connection error - Recording paused")),xe=()=>O.a.createElement("div",{className:"mx_RoomTile_subtitle mx_RoomTile_subtitle--voice-broadcast"},O.a.createElement(Z.a,{className:"mx_Icon mx_Icon_16"}),Object(S.a)("Live"));var Te=n(136),je=n(146);const Pe=e=>{let{onFinished:t}=e;return O.a.createElement(Te.a,{title:Object(S.a)("Listen to live broadcast?"),hasCancel:!0,onFinished:t},O.a.createElement("p",null,Object(S.a)("If you start listening to this live broadcast, your current live broadcast recording will be ended.")),O.a.createElement(je.a,{onPrimaryButtonClick:()=>t(!0),primaryButton:Object(S.a)("Yes, end my recording"),cancelButton:Object(S.a)("No"),onCancel:()=>t(!1)}))},De=async()=>{const{promise:e,resolve:t}=Object(d.m)();return k.b.createDialog(Pe,{onFinished:t}),e};var Ne=n(142);const Me=e=>{const t=z.a.get().getRoom(e.infoEvent.getRoomId());if(!t)throw new Error(`Voice Broadcast room not found (event ${e.infoEvent.getId()})`);const n=Object(Ne.d)(e,w.StateChanged,(t=>null!=t?t:e.getState()));return{times:Object(Ne.d)(e,w.TimesChanged,(t=>null!=t?t:{duration:e.durationSeconds,position:e.timeSeconds,timeLeft:e.timeLeftSeconds})),liveness:Object(Ne.d)(e,w.LivenessChanged,(t=>null!=t?t:e.getLiveness())),playbackState:n,room:t,sender:e.infoEvent.sender,toggle:()=>{e.toggle()}}};var Ae,Le;function Ue(){return Ue=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Ue.apply(this,arguments)}function Fe(e){return C.createElement("svg",Ue({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 19.977 22.975",role:"presentation","aria-hidden":!0},e),Ae||(Ae=C.createElement("path",{fill:"currentColor",d:"M9.976 22.975c-2.648 0-4.922-.88-6.82-2.64C1.258 18.577.206 16.4.003 13.808a.728.728 0 01.208-.583.786.786 0 01.598-.25c.222 0 .412.078.57.236.157.157.254.356.29.597.205 2.13 1.093 3.913 2.668 5.348 1.574 1.435 3.454 2.153 5.64 2.153 2.314 0 4.282-.81 5.903-2.43 1.62-1.621 2.43-3.59 2.43-5.904 0-2.315-.786-4.283-2.36-5.904-1.575-1.62-3.52-2.43-5.835-2.43h-.611l1.445 1.444a.8.8 0 01.25.583.8.8 0 01-.25.584.8.8 0 01-.584.25.8.8 0 01-.583-.25L6.865 4.334a.846.846 0 01-.195-.278.816.816 0 01-.055-.306c0-.11.018-.213.055-.305a.846.846 0 01.195-.278L9.81.222A.754.754 0 0110.365 0a.85.85 0 01.584.222.85.85 0 01.222.584.754.754 0 01-.222.555L9.337 2.973h.64c1.388 0 2.69.259 3.903.777a10.021 10.021 0 013.18 2.14 10.02 10.02 0 012.14 3.18 9.824 9.824 0 01.777 3.904c0 1.389-.259 2.69-.777 3.903a10.02 10.02 0 01-2.14 3.18 10.02 10.02 0 01-3.18 2.14 9.824 9.824 0 01-3.904.778z"})),Le||(Le=C.createElement("path",{fill:"currentColor",d:"M7.017 16.914c-.46 0-.87-.078-1.227-.236a2.052 2.052 0 01-.844-.658 1.707 1.707 0 01-.33-.975h1.202a.8.8 0 00.176.463c.107.13.248.231.425.304.177.072.375.108.595.108.234 0 .442-.04.623-.12.181-.084.323-.2.425-.346a.85.85 0 00.15-.508.882.882 0 00-.153-.524 1.026 1.026 0 00-.454-.355 1.775 1.775 0 00-.71-.128h-.578v-.914h.579c.227 0 .427-.04.597-.118a.967.967 0 00.406-.333.856.856 0 00.144-.502.872.872 0 00-.125-.482.841.841 0 00-.354-.323 1.166 1.166 0 00-.534-.115c-.2 0-.386.036-.556.109a1.01 1.01 0 00-.413.31.786.786 0 00-.166.473h-1.14a1.66 1.66 0 01.316-.965 2.04 2.04 0 01.818-.652c.34-.158.723-.237 1.147-.237.437 0 .816.082 1.138.246.324.162.574.38.751.655.177.275.265.579.265.911.002.369-.106.678-.326.927a1.53 1.53 0 01-.856.489v.051c.46.064.813.235 1.058.511.247.275.37.617.367 1.026 0 .367-.104.695-.313.985a2.076 2.076 0 01-.857.677 2.991 2.991 0 01-1.246.246zm5.498.036c-.526 0-.978-.134-1.355-.4-.375-.268-.664-.655-.866-1.16-.2-.507-.3-1.118-.3-1.831.002-.714.103-1.321.303-1.822.202-.503.491-.886.866-1.15.377-.265.828-.397 1.352-.397.524 0 .975.132 1.352.396.377.265.666.648.866 1.15.203.504.304 1.111.304 1.823 0 .716-.101 1.327-.304 1.834-.2.505-.489.89-.866 1.157-.375.266-.826.4-1.352.4zm0-1c.41 0 .732-.202.968-.605.24-.405.358-1 .358-1.786 0-.52-.054-.957-.163-1.31-.108-.354-.262-.62-.46-.8a1.008 1.008 0 00-.703-.271c-.407 0-.729.202-.965.607-.237.403-.356.994-.358 1.774-.002.522.05.96.157 1.316.108.356.262.625.46.806.198.179.433.268.706.268z"})))}var Be,Ve;function Ke(){return Ke=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Ke.apply(this,arguments)}function $e(e){return C.createElement("svg",Ke({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 19.977 22.975",role:"presentation","aria-hidden":!0},e),Be||(Be=C.createElement("path",{fill:"currentColor",d:"M10.001 22.975c2.649 0 4.922-.88 6.82-2.64 1.899-1.759 2.95-3.935 3.153-6.528a.728.728 0 00-.208-.583.786.786 0 00-.597-.25.776.776 0 00-.57.236 1.044 1.044 0 00-.291.597c-.204 2.13-1.093 3.913-2.667 5.348-1.575 1.435-3.454 2.153-5.64 2.153-2.315 0-4.283-.81-5.903-2.43-1.62-1.621-2.431-3.59-2.431-5.904 0-2.315.787-4.283 2.361-5.904 1.574-1.62 3.52-2.43 5.834-2.43h.611L9.03 6.083a.8.8 0 00-.25.583.8.8 0 00.25.584.8.8 0 00.583.25.8.8 0 00.584-.25l2.917-2.917a.846.846 0 00.194-.278.817.817 0 00.056-.306.817.817 0 00-.056-.305.846.846 0 00-.194-.278L10.168.222A.754.754 0 009.612 0a.85.85 0 00-.583.222.85.85 0 00-.222.584c0 .222.074.407.222.555l1.611 1.612h-.639c-1.389 0-2.69.259-3.903.777a10.021 10.021 0 00-3.181 2.14 10.022 10.022 0 00-2.14 3.18A9.824 9.824 0 000 12.974c0 1.389.26 2.69.778 3.903a10.021 10.021 0 002.139 3.18 10.02 10.02 0 003.18 2.14 9.824 9.824 0 003.904.778z"})),Ve||(Ve=C.createElement("path",{fill:"currentColor",d:"M7.017 16.914c-.46 0-.87-.078-1.227-.236a2.052 2.052 0 01-.844-.658 1.707 1.707 0 01-.33-.975h1.202a.8.8 0 00.176.463c.107.13.248.231.425.304.177.072.375.108.595.108.234 0 .442-.04.623-.12.181-.084.323-.2.425-.346a.85.85 0 00.15-.508.882.882 0 00-.153-.524 1.026 1.026 0 00-.454-.355 1.775 1.775 0 00-.71-.128h-.578v-.914h.578c.228 0 .428-.04.598-.118a.967.967 0 00.406-.333.856.856 0 00.144-.502.872.872 0 00-.125-.482.841.841 0 00-.355-.323 1.166 1.166 0 00-.533-.115c-.2 0-.386.036-.556.109a1.01 1.01 0 00-.413.31.786.786 0 00-.166.473h-1.14a1.66 1.66 0 01.315-.965 2.04 2.04 0 01.819-.652c.34-.158.723-.237 1.147-.237.437 0 .816.082 1.138.246.324.162.574.38.75.655.178.275.266.579.266.911.002.369-.106.678-.326.927a1.53 1.53 0 01-.856.489v.051c.46.064.812.235 1.057.511.248.275.37.617.368 1.026 0 .367-.104.695-.313.985a2.076 2.076 0 01-.857.677 2.991 2.991 0 01-1.246.246zm5.498.036c-.526 0-.978-.134-1.355-.4-.375-.268-.664-.655-.866-1.16-.2-.507-.3-1.118-.3-1.831.001-.714.103-1.321.303-1.822.202-.503.491-.886.866-1.15.377-.265.828-.397 1.352-.397.524 0 .975.132 1.352.396.377.265.666.648.866 1.15.202.504.304 1.111.304 1.823 0 .716-.102 1.327-.304 1.834-.2.505-.489.89-.866 1.157-.375.266-.826.4-1.352.4zm0-1c.409 0 .732-.202.968-.605.239-.405.358-1 .358-1.786 0-.52-.054-.957-.163-1.31-.108-.354-.262-.62-.46-.8a1.008 1.008 0 00-.703-.271c-.407 0-.729.202-.965.607-.237.403-.356.994-.358 1.774-.002.522.05.96.156 1.316.109.356.262.625.46.806.199.179.434.268.707.268z"})))}var He=n(634);const We=e=>{let{onClick:t,icon:n,label:i}=e;return O.a.createElement(te.a,{kind:"secondary_content",onClick:t,"aria-label":i},O.a.createElement(n,{className:"mx_Icon mx_Icon_24"}))},qe=e=>{let{pip:t=!1,playback:n}=e;const{times:i,liveness:s,playbackState:o,room:r,sender:a,toggle:c}=Me(n);let l=null,d=null;if(o!==E.Stopped){const e=()=>{n.skipTo(Math.max(0,i.position-30))};l=O.a.createElement(We,{icon:Fe,label:Object(S.a)("30s backward"),onClick:e});const t=()=>{n.skipTo(Math.min(i.duration,i.position+30))};d=O.a.createElement(We,{icon:$e,label:Object(S.a)("30s forward"),onClick:t})}const u=X()({mx_VoiceBroadcastBody:!0,"mx_VoiceBroadcastBody--pip":t}),h=o===E.Error?O.a.createElement(re,{message:n.errorMessage}):O.a.createElement(O.a.Fragment,null,O.a.createElement("div",{className:"mx_VoiceBroadcastBody_controls"},l,O.a.createElement(Re,{state:o,onClick:c}),d),O.a.createElement(He.a,{playback:n}),O.a.createElement("div",{className:"mx_VoiceBroadcastBody_timerow"},O.a.createElement(ge.a,{seconds:i.position}),O.a.createElement(ge.a,{seconds:-i.timeLeft})));return O.a.createElement("div",{className:u},O.a.createElement(Se,{linkToRoom:t,live:s,microphoneLabel:null==a?void 0:a.name,room:r,showBroadcast:o!==E.Buffering,showBuffering:o===E.Buffering}),h)},Ge=e=>{let{playback:t}=e;const{liveness:n,playbackState:i,room:s,sender:o,toggle:r}=Me(t);return O.a.createElement("div",{className:"mx_VoiceBroadcastBody mx_VoiceBroadcastBody--pip mx_VoiceBroadcastBody--small"},O.a.createElement(Se,{linkToRoom:!0,live:n,liveBadgePosition:"middle",microphoneLabel:null==o?void 0:o.name,room:s,showBuffering:i===E.Buffering,bufferingPosition:"title"}),O.a.createElement(Re,{state:i,onClick:r}),O.a.createElement(te.a,{onClick:()=>t.stop()},O.a.createElement(pe.a,{className:"mx_Icon mx_Icon_8 mx_VoiceBroadcastBody__small-close"})))};var ze=n(249),Je=n(879);function Ye(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Qe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ye(Object(n),!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ye(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Xe=e=>{var t;const n=Object(C.useRef)(!0),[i,s]=Object(C.useState)({devices:[],device:null});n.current&&(n.current=!1,Object(Je.a)(!1).then((e=>{ze.c.getDevices().then((t=>{let{audioinput:n}=t;ze.c.getDefaultDevice(n);const o=ze.c.getAudioInput(),r=n.find((e=>e.deviceId===o))||n[0];s(Qe(Qe({},i),{},{devices:n,device:r})),null==e||e.getTracks().forEach((e=>e.stop()))}))})));return{currentDevice:i.device,currentDeviceLabel:(null===(t=i.device)||void 0===t?void 0:t.label)||Object(S.a)("Default Device"),devices:i.devices,setDevice:t=>{var n;const o=t.deviceId!==(null===(n=i.device)||void 0===n?void 0:n.deviceId);ze.c.instance.setDevice(t.deviceId,ze.b.AudioInput),s(Qe(Qe({},i),{},{device:t})),o&&(null==e||e(t))}}};var Ze=n(131),et=n.n(Ze),tt=n(151),nt=n(178);const it=e=>{let{containerRef:t,currentDevice:n,devices:i,onDeviceSelect:s}=e;const o=i.map((e=>O.a.createElement(nt.d,{key:e.deviceId,active:e.deviceId===(null==n?void 0:n.deviceId),onClick:()=>s(e),label:e.label})));return O.a.createElement(nt.e,et()({mountAsChild:!1,onFinished:()=>{}},Object(tt.o)(t.current.getBoundingClientRect(),0)),O.a.createElement(nt.c,null,o))};function st(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function ot(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?st(Object(n),!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):st(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const rt=e=>{let{voiceBroadcastPreRecording:t}=e;const n=Object(C.useRef)(null),{currentDevice:i,currentDeviceLabel:s,devices:o,setDevice:r}=Xe(),[a,c]=Object(C.useState)({showDeviceSelect:!1,disableStartButton:!1});return O.a.createElement("div",{className:"mx_VoiceBroadcastBody mx_VoiceBroadcastBody--pip",ref:n},O.a.createElement(Se,{linkToRoom:!0,onCloseClick:t.cancel,onMicrophoneLineClick:()=>c(ot(ot({},a),{},{showDeviceSelect:!0})),room:t.room,microphoneLabel:s,showClose:!0}),O.a.createElement(te.a,{className:"mx_VoiceBroadcastBody_blockButton",kind:"danger",onClick:()=>{c((e=>ot(ot({},e),{},{disableStartButton:!0}))),t.start()},disabled:a.disableStartButton},O.a.createElement(Z.a,{className:"mx_Icon mx_Icon_16"}),Object(S.a)("Go live")),a.showDeviceSelect&&O.a.createElement(it,{containerRef:n,currentDevice:i,devices:o,onDeviceSelect:e=>{c((e=>ot(ot({},e),{},{showDeviceSelect:!1}))),r(e)}}))},at=e=>{let{recording:t}=e;const{live:n,room:i,sender:s,recordingState:o}=lt(t);return O.a.createElement("div",{className:"mx_VoiceBroadcastBody"},O.a.createElement(Se,{live:n?"live":"grey",microphoneLabel:null==s?void 0:s.name,room:i}),"connection_error"===o&&O.a.createElement(ke,null))};var ct=n(157);const lt=e=>{const t=z.a.get(),n=e.infoEvent.getRoomId(),s=t.getRoom(n);if(!s)throw new Error("Unable to find voice broadcast room with Id: "+n);const o=Object(Ne.d)(e,L.StateChanged,(t=>null!=t?t:e.getState())),r=Object(Ne.d)(e,L.TimeLeftChanged,(t=>null!=t?t:e.getTimeLeft()));return{live:[i.c.Started,i.c.Resumed].includes(o),timeLeft:r,recordingState:o,room:s,sender:e.infoEvent.sender,stopRecording:async()=>{await(async()=>{const{finished:e}=k.b.createDialog(ct.a,{title:Object(S.a)("Stop live broadcasting?"),description:O.a.createElement("p",null,Object(S.a)("Are you sure you want to stop your live broadcast? This will end the broadcast and the full recording will be available in the room.")),button:Object(S.a)("Yes, stop broadcast")}),[t]=await e;return t})()&&await e.stop()},toggleRecording:e.toggle}};var dt;function ut(){return ut=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ut.apply(this,arguments)}function ht(e){return C.createElement("svg",ut({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 13 16",role:"presentation","aria-hidden":!0},e),dt||(dt=C.createElement("rect",{x:.974,y:2,width:12,height:12,rx:1,fill:"currentColor"})))}var mt;function pt(){return pt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},pt.apply(this,arguments)}function gt(e){return C.createElement("svg",pt({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 10 10",role:"presentation","aria-hidden":!0},e),mt||(mt=C.createElement("circle",{cx:5,cy:5,r:5,fill:"#E53935"})))}const vt=e=>{let{recording:t}=e;const n=Object(C.useRef)(null),{live:s,timeLeft:o,recordingState:r,room:a,stopRecording:c,toggleRecording:l}=lt(t),{currentDevice:d,devices:u,setDevice:h}=Xe(),[m,p]=Object(C.useState)(!1),g=r===i.c.Paused?O.a.createElement(ne,{className:"mx_VoiceBroadcastControl-recording",onClick:l,icon:gt,label:Object(S.a)("resume voice broadcast")}):O.a.createElement(ne,{onClick:l,icon:Ie,label:Object(S.a)("pause voice broadcast")}),v="connection_error"===r?O.a.createElement(ke,null):O.a.createElement("div",{className:"mx_VoiceBroadcastBody_controls"},g,O.a.createElement(ye.a,{onClick:()=>p(!0),title:Object(S.a)("Change input device")},O.a.createElement(le,{className:"mx_Icon mx_Icon_16 mx_Icon_alert"})),O.a.createElement(ne,{icon:ht,label:"Stop Recording",onClick:c}));return O.a.createElement("div",{className:"mx_VoiceBroadcastBody mx_VoiceBroadcastBody--pip",ref:n},O.a.createElement(Se,{linkToRoom:!0,live:s?"live":"grey",room:a,timeLeft:o}),O.a.createElement("hr",{className:"mx_VoiceBroadcastBody_divider"}),v,m&&O.a.createElement(it,{containerRef:n,currentDevice:d,devices:u,onDeviceSelect:async e=>{p(!1),(null==d?void 0:d.deviceId)!==e.deviceId&&(h(e),[i.c.Paused,i.c.Stopped].includes(r)||(await t.pause(),await t.resume()))}}))},ft=e=>({currentVoiceBroadcastPreRecording:Object(Ne.d)(e,"changed",(t=>null!=t?t:e.getCurrent()))}),bt=e=>({currentVoiceBroadcastRecording:Object(Ne.d)(e,_t.CurrentChanged,(t=>null!=t?t:e.getCurrent()))}),yt=async(e,t,n)=>{let s=!1,o=!1,r=null;const a=t.currentState.getStateEvents(i.b);return await Object(V.l)(a,(async t=>{var a;const c=null===(a=t.getContent())||void 0===a?void 0:a.state;if(c&&c!==i.c.Stopped){const i=await Nt(t,e);if(null!=i&&i.isRedacted())return!0;if(s=!0,r=i,t.getStateKey()===n)return o=!0,!1}return!0})),{hasBroadcast:s,infoEvent:r,startedByUser:o}},St=e=>{const t=Object(C.useContext)(J.a),[n,i]=Object(C.useState)(!1),s=Object(C.useMemo)((()=>t.client?()=>{yt(t.client,e).then((e=>{let{hasBroadcast:t}=e;i(t)}),(()=>{}))}:()=>{}),[e,t,i]);return Object(C.useEffect)((()=>{s()}),[s]),Object(Ne.c)(e.currentState,r.RoomStateEvent.Update,(()=>s())),n};var Et=n(635);class wt extends a.b{constructor(){super(...arguments),o()(this,"current",null),o()(this,"onCancel",(e=>{this.current===e&&this.clearCurrent()}))}setCurrent(e){this.current!==e&&(this.current&&this.current.off("dismiss",this.onCancel),this.current=e,e.on("dismiss",this.onCancel),this.emit("changed",e))}clearCurrent(){null!==this.current&&(this.current.off("dismiss",this.onCancel),this.current=null,this.emit("changed",null))}getCurrent(){return this.current}destroy(){this.removeAllListeners(),this.current&&this.current.off("dismiss",this.onCancel)}}let _t;!function(e){e.CurrentChanged="current_changed"}(_t||(_t={}));class Ct extends a.b{constructor(){super(),o()(this,"current",null),o()(this,"recordings",new Map),o()(this,"onCurrentStateChanged",(e=>{e===i.c.Stopped&&this.clearCurrent()}))}setCurrent(e){if(this.current===e)return;const t=e.infoEvent.getId();if(!t)throw new Error("Got broadcast info event without Id");this.current&&this.current.off(L.StateChanged,this.onCurrentStateChanged),this.current=e,this.current.on(L.StateChanged,this.onCurrentStateChanged),this.recordings.set(t,e),this.emit(_t.CurrentChanged,e)}getCurrent(){return this.current}hasCurrent(){return null!==this.current}clearCurrent(){this.current&&(this.current.off(L.StateChanged,this.onCurrentStateChanged),this.current=null,this.emit(_t.CurrentChanged,null))}getByInfoEvent(e,t){const n=e.getId();if(!n)throw new Error("Got broadcast info event without Id");const i=this.recordings.get(n)||new U(e,t);return this.recordings.set(n,i),i}}const Ot=async e=>{var t,n,i;null===(t=e.voiceBroadcastPlaybacksStore.getCurrent())||void 0===t||t.stop(),e.voiceBroadcastPlaybacksStore.clearCurrent(),await(null===(n=e.voiceBroadcastRecordingsStore.getCurrent())||void 0===n?void 0:n.stop()),e.voiceBroadcastRecordingsStore.clearCurrent(),null===(i=e.voiceBroadcastPreRecordingStore.getCurrent())||void 0===i||i.cancel(),e.voiceBroadcastPreRecordingStore.clearCurrent()},It=e=>{var t;null===(t=e.getCurrent())||void 0===t||t.getState(),E.Stopped},Rt=async(e,t,n,i)=>{if(i.hasCurrent())return;const s=n.getCurrent();if(s&&s.getState()!==E.Stopped)return;const{infoEvent:o}=await yt(t,e);if(o){const e=n.getByInfoEvent(o,t);n.setCurrent(e)}else n.clearCurrent()};var kt=n(132),xt=n(318),Tt=n(126);const jt=()=>{var e,t;return Tt.b.getValue(xt.a.VoiceBroadcastForceSmallChunks)?15:(null===(e=kt.b.get("voice_broadcast"))||void 0===e?void 0:e.chunk_length)||(null===(t=kt.a.voice_broadcast)||void 0===t?void 0:t.chunk_length)||120},Pt=()=>{var e,t;return(null===(e=kt.b.get("voice_broadcast"))||void 0===e?void 0:e.max_length)||(null===(t=kt.a.voice_broadcast)||void 0===t?void 0:t.max_length)||14400},Dt=(e,t)=>{var n,s;const o=e.getRelation();return(null==o?void 0:o.rel_type)===r.RelationType.Reference&&!!o.event_id&&(null===(n=t.getRoom(e.getRoomId()))||void 0===n||null===(s=n.findEventById(o.event_id))||void 0===s?void 0:s.getType())===i.b};n(582);const Nt=async(e,t)=>{var n,s,o;if((null===(n=e.getContent())||void 0===n?void 0:n.state)===i.c.Started)return e;const a=null===(s=e.getRelation())||void 0===s?void 0:s.event_id;if(!a)return null;const c=e.getRoomId()||"",l=null===(o=t.getRoom(c))||void 0===o?void 0:o.findEventById(a);if(l)return l;try{const e=await t.fetchRoomEvent(c,a);return new r.MatrixEvent(e)}catch(e){}return null},Mt=(e,t,n)=>{var s;const o=t.getUserId();return!!o&&o===n.getSender()&&t.getDeviceId()===(null===(s=n.getContent())||void 0===s?void 0:s.device_id)&&e!==i.c.Stopped};n(636);const At=e=>{var t;return e.getType()===i.b&&(null===(t=e.getContent())||void 0===t?void 0:t.state)===i.c.Stopped&&!e.isRedacted()};var Lt=n(182),Ut=n(480);const Ft=e=>()=>{var t,n;const i=null===(t=z.a.get())||void 0===t?void 0:t.getUserId(),s=null===(n=e.getRelation())||void 0===n?void 0:n.event_id,o=e.getRoomId(),r={a:e=>s&&o?O.a.createElement(te.a,{kind:"link_inline",onClick:()=>Object(Lt.j)(o,s)},e):e};return i&&i===e.getSender()?Object(S.a)("You ended a <a>voice broadcast</a>",{},r):Object(S.a)("%(senderName)s ended a <a>voice broadcast</a>",{senderName:Object(Ut.a)(e)},r)};n(637);class Bt{constructor(e){this.client=e,o()(this,"onClientSync",(()=>{this.client.getSyncState()===I.b.Syncing&&(this.client.off(r.ClientEvent.Sync,this.onClientSync),this.resume())})),e.isInitialSyncComplete()?this.resume():e.on(r.ClientEvent.Sync,this.onClientSync)}resume(){const e=this.client.getUserId(),t=this.client.getDeviceId();e&&t&&this.client.getRooms().forEach((n=>{const s=((e,t,n)=>{const s=e.currentState.getStateEvents(i.b,t);if(!s)return null;const o=s.getContent()||{};return o.state===i.c.Stopped?null:o.device_id===n?s:null})(n,e,t);if(s)return this.sendStopVoiceBroadcastStateEvent(s),!1}))}sendStopVoiceBroadcastStateEvent(e){var t,n,s;const o=this.client.getUserId(),a=this.client.getDeviceId(),c=e.getRoomId();if(!o||!a||!c)return;const l={device_id:a,state:i.c.Stopped},d=(null===(t=e.getContent())||void 0===t?void 0:t.state)===i.c.Started?e.getId():null===(n=e.getContent())||void 0===n||null===(s=n["m.relates_to"])||void 0===s?void 0:s.event_id;d&&(l["m.relates_to"]={rel_type:r.RelationType.Reference,event_id:d}),this.client.sendStateEvent(c,i.b,l,o)}destroy(){this.client.off(r.ClientEvent.Sync,this.onClientSync)}}},function(e,t,n){"use strict";(function(e){n.d(t,"g",(function(){return m}));var i=n(13),s=n.n(i),o=n(1024),r=n(520),a=n(16),c=n(1026),l=n(421),d=n(363),u=n(422),h=n(519);n.d(t,"d",(function(){return h.a})),n.d(t,"a",(function(){return r.a})),n.d(t,"e",(function(){return r.b})),n.d(t,"h",(function(){return r.c})),n.d(t,"b",(function(){return d.a})),n.d(t,"c",(function(){return d.b})),n.d(t,"f",(function(){return d.c})),n.d(t,"i",(function(){return l.a})),n.d(t,"j",(function(){return u.a})),n.d(t,"k",(function(){return u.b})),n.d(t,"l",(function(){return u.c})),n.d(t,"m",(function(){return u.d}));class m extends o.a{constructor(){super(...arguments),s()(this,"uploads",[])}uploadContent(t){var n,i,s,o,h;let m=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const p=null===(n=m.includeFilename)||void 0===n||n,g=null!==(i=m.abortController)&&void 0!==i?i:new AbortController,v=null!==(s=null!==(o=m.type)&&void 0!==o?o:t.type)&&void 0!==s?s:"application/octet-stream",f=null!==(h=m.name)&&void 0!==h?h:t.name,b={loaded:0,total:0,abortController:g},y=a.m();if(e.XMLHttpRequest){const n=new e.XMLHttpRequest,i=function(){n.abort(),y.reject(new Error("Timeout"))};let s=c.b(i,3e4);n.onreadystatechange=function(){if(n.readyState===e.XMLHttpRequest.DONE){c.a(s);try{if(0===n.status)throw new DOMException(n.statusText,"AbortError");if(!n.responseText)throw new Error("No response body.");n.status>=400?y.reject(Object(u.b)(n,n.responseText)):y.resolve(JSON.parse(n.responseText))}catch(e){if("AbortError"===e.name)return void y.reject(e);y.reject(new d.a("request failed",e))}}},n.upload.onprogress=e=>{var t;c.a(s),b.loaded=e.loaded,b.total=e.total,s=c.b(i,3e4),null===(t=m.progressHandler)||void 0===t||t.call(m,{loaded:e.loaded,total:e.total})};const o=this.getUrl("/upload",void 0,r.c.R0);p&&f&&o.searchParams.set("filename",encodeURIComponent(f)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&o.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),n.open(l.a.Post,o.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&n.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),n.setRequestHeader("Content-Type",v),n.send(t),g.signal.addEventListener("abort",(()=>{n.abort()}))}else{const e={};p&&f&&(e.filename=f);const n={"Content-Type":v};this.authedRequest(l.a.Post,"/upload",e,t,{prefix:r.c.R0,headers:n,abortSignal:g.signal}).then((e=>this.opts.onlyData?e:e.json())).then(y.resolve,y.reject)}return b.promise=y.promise.finally((()=>{a.I(this.uploads,(e=>e===b))})),g.signal.addEventListener("abort",(()=>{a.I(this.uploads,(e=>e===b)),y.reject(new DOMException("Aborted","AbortError"))})),this.uploads.push(b),b.promise}cancelUpload(e){const t=this.uploads.find((t=>t.promise===e));return!!t&&(t.abortController.abort(),!0)}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:r.c.R0+"/upload",params:{access_token:this.opts.accessToken}}}}}).call(this,n(14))},,function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c}));var i=n(122),s=n.n(i),o=n(17),r=n.n(o);let a;!function(e){e.Resize="resize"}(a||(a={}));class c extends r.a{constructor(){super(),s()(this,"resizeObserver",void 0),s()(this,"uiElementDimensions",new Map),s()(this,"trackedUiElements",new Map),s()(this,"windowWidth",void 0),s()(this,"windowHeight",void 0),s()(this,"resizeObserverCallback",(e=>{const t=e.find((e=>e.target===document.body));t&&(this.windowWidth=t.contentRect.width,this.windowHeight=t.contentRect.height),e.forEach((e=>{const t=this.trackedUiElements.get(e.target);t&&(this.uiElementDimensions.set(t,e.contentRect),this.emit(t,a.Resize,e))})),this.emit(a.Resize,e)})),this.windowWidth=window.innerWidth,this.windowHeight=window.innerHeight,this.resizeObserver=new ResizeObserver(this.resizeObserverCallback),this.resizeObserver.observe(document.body)}static get instance(){return c._instance||(c._instance=new c),c._instance}static destroy(){c._instance&&(c._instance.resizeObserver.disconnect(),c._instance.removeAllListeners(),c._instance=null)}getElementDimensions(e){return this.uiElementDimensions.get(e)}trackElementDimensions(e,t){this.trackedUiElements.set(t,e),this.resizeObserver.observe(t)}stopTrackingElementDimensions(e){let t;this.trackedUiElements.forEach(((n,i)=>{n===e&&(t=i)})),t&&(this.resizeObserver.unobserve(t),this.uiElementDimensions.delete(e),this.trackedUiElements.delete(t))}isTrackingElementDimensions(e){return this.uiElementDimensions.has(e)}}s()(c,"_instance",null),window.mxUIStore=c.instance},function(e,t,n){"use strict";n.d(t,"b",(function(){return N})),n.d(t,"k",(function(){return L})),n.d(t,"i",(function(){return U})),n.d(t,"e",(function(){return F})),n.d(t,"f",(function(){return B})),n.d(t,"c",(function(){return Y})),n.d(t,"j",(function(){return Q})),n.d(t,"a",(function(){return X})),n.d(t,"h",(function(){return Z})),n.d(t,"g",(function(){return ee})),n.d(t,"d",(function(){return te}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(452),c=n.n(a),l=n(746),d=n.n(l),u=n(127),h=n.n(u),m=n(571),p=n.n(m),g=n(150),v=n(1196),f=n.n(v),b=n(572),y=n(1197),S=n.n(y),E=n(374),w=n(126),_=n(168),C=n(381),O=n(160),I=n(229);function R(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?R(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):R(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const x=/([\ud800-\udbff])([\udc00-\udfff])/,T=/([\u2100-\u2bff])/,j=/[\u200D\u200B\s]/g,P=new RegExp(`^(${p.a.source})+$`,"i"),D=/^#[0-9a-fA-F]{6}$/,N=["bitcoin","ftp","geo","http","https","im","irc","ircs","magnet","mailto","matrix","mms","news","nntp","openpgp4fpr","sip","sftp","sms","smsto","ssh","tel","urn","webcal","wtai","xmpp"],M=/\/_matrix\/media\/r0\/(?:download|thumbnail)\/(.+?)\/(.+?)(?:[?/]|$)/;function A(e){return x.test(e)||T.test(e)}function L(e){var t;const n=null===(t=Object(C.d)(e))||void 0===t?void 0:t.shortcodes;return null!=n&&n.length?`:${n[0]}:`:""}function U(e){const t=c()(e,K);return r.a.createElement("div",{dangerouslySetInnerHTML:{__html:t},dir:"auto"})}function F(e){return c()(e,{allowedTags:[],allowedAttributes:{},selfClosing:[],allowedSchemes:[],disallowedTagsMode:"discard"})}function B(e){try{return N.includes(new URL(e).protocol.slice(0,-1))}catch(e){return!1}}const V={a:function(e,t){if(t.href){t.target="_blank";(Object(_.l)(t.href)!==t.href||t.href.match(E.a))&&delete t.target}else delete t.href;return t.rel="noreferrer noopener",{tagName:e,attribs:t}},img:function(e,t){let n=t.src;if(!n||!w.b.getValue("showImages"))return{tagName:e,attribs:{}};if(!n.startsWith("mxc://")){const e=M.exec(n);e&&(n=`mxc://${e[1]}/${e[2]}`)}if(!n.startsWith("mxc://"))return{tagName:e,attribs:{}};const i=Number(t.width),s=Number(t.height),o=Math.min(i||800,800),r=Math.min(s||600,600);return t.style=`max-width: min(100%, ${o}px); max-height: ${r}px;`,i&&(t.style+="width: 100%;"),s&&(t.style+="height: 100%;"),t.src=Object(O.b)(n).getThumbnailOfSourceHttp(o,r),{tagName:e,attribs:t}},code:function(e,t){if(void 0!==t.class){const e=t.class.split(/\s/).filter((function(e){return e.startsWith("language-")&&!e.startsWith("language-_")}));t.class=e.join(" ")}return{tagName:e,attribs:t}},"*":function(e,t){"img"!==e&&delete t.style;const n={"data-mx-color":"color","data-mx-bg-color":"background-color"};let i="";return Object.keys(n).forEach((e=>{const s=n[e],o=t[e];o&&"string"==typeof o&&D.test(o)&&(i+=s+":"+o+";",delete t[e])})),i&&(t.style=i+(t.style||"")),{tagName:e,attribs:t}}},K={allowedTags:["font","del","h1","h2","h3","h4","h5","h6","blockquote","p","a","ul","ol","sup","sub","nl","li","b","i","u","strong","em","strike","code","hr","br","div","table","thead","caption","tbody","tr","th","td","pre","span","img","details","summary"],allowedAttributes:{font:["color","data-mx-bg-color","data-mx-color","style"],span:["data-mx-maths","data-mx-bg-color","data-mx-color","data-mx-spoiler","style"],div:["data-mx-maths"],a:["href","name","target","rel"],img:["src","alt","title","style","data-mx-emoticon"],ol:["start"],code:["class"]},selfClosing:["img","br","hr","area","base","basefont","input","link","meta"],allowedSchemes:N,allowProtocolRelative:!1,transformTags:V,nestingLimit:50},$=k(k({},K),{},{transformTags:{code:V.code,"*":V["*"]}}),H=k(k({},K),{},{allowedTags:["font","del","a","sup","sub","b","i","u","strong","em","strike","br","div","span"]});class W{constructor(e,t){this.highlightClass=e,this.highlightLink=t}applyHighlights(e,t){let n,i=0,s=[];const o=t[0];for(;(n=e.toLowerCase().indexOf(o.toLowerCase(),i))>=0;){if(n>i){const o=e.substring(i,n);s=s.concat(this.applySubHighlights(o,t))}const r=n+o.length;s.push(this.processSnippet(e.substring(n,r),!0)),i=r}if(i!==e.length){const n=e.substring(i,void 0);s=s.concat(this.applySubHighlights(n,t))}return s}applySubHighlights(e,t){return t[1]?this.applyHighlights(e,t.slice(1)):[this.processSnippet(e,!1)]}}class q extends W{processSnippet(e,t){if(!t)return e;let n=`<span class="${this.highlightClass}">${e}</span>`;return this.highlightLink&&(n=`<a href="${encodeURI(this.highlightLink)}">${n}</a>`),n}}const G=e=>`<span class='mx_Emoji' title='${L(e)}'>${e}</span>`,z=(e,t)=>r.a.createElement("span",{key:t,className:"mx_Emoji",title:L(e)},e);function J(e,t){const n=t?G:z,i=[];let s="",o=0;for(const t of Object(g.split)(e,""))p.a.test(t)?(s&&(i.push(s),s=""),i.push(n(t,o)),o++):s+=t;return s&&i.push(s),i}function Y(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const s="org.matrix.custom.html"===e.format&&"string"==typeof e.formatted_body;let o,a,l=!1,u=!1,m=K;i.forComposerQuote&&(m=$);let p=!1;try{const n=null==t?void 0:t.filter((e=>!e.includes("<"))).map((e=>c()(e,m)));let r="string"==typeof e.formatted_body?e.formatted_body:null;const h="string"==typeof e.body?e.body:"";i.stripReplyFallback&&r&&(r=Object(I.d)(r)),o=i.stripReplyFallback?Object(I.e)(h):h,l=A(s?r:h);const g=null!=n&&n.length?new q("mx_EventTile_searchHighlight",i.highlightLink):null;if(s){g&&(m.textFilter=function(e){return g.applyHighlights(e,n).join("")}),a=c()(r,m);const e=d.a.load(a,{_useHtmlParser2:!0,decodeEntities:!1});u=!(e.html()===e.root().text()),u&&w.b.getValue("feature_latex_maths")&&(e('div, span[data-mx-maths!=""]').replaceWith((function(t,n){return f.a.renderToString(Object(b.decode)(e(n).attr("data-mx-maths")),{throwOnError:!1,displayMode:"div"==n.name,output:"htmlAndMathml"})})),a=e.html()),u&&(p=e.root()[0].children.every((e=>{if("text"===e.type){let t=e.data;t=t.replace(j,"");const n=P.exec(t);return n&&n[0]&&n[0].length===t.length}return"tag"!=e.type||"img"===e.name&&"data-mx-emoticon"in e.attribs}))),l&&(a=J(a,!0).join(""))}else g&&(a=g.applyHighlights(h,n).join(""))}finally{delete m.textFilter}const g=null!==(n=a)&&void 0!==n?n:o;if(i.returnString)return g;let v=!1;if(!i.disableBigEmoji){var y;let t=l&&void 0!==g?g.trim():"";t=t.replace(j,"");const n=P.exec(t);v=((null==n||null===(y=n[0])||void 0===y?void 0:y.length)===t.length||p)&&(o===a||void 0===e.formatted_body||!e.formatted_body.includes("http:")&&!e.formatted_body.includes("https:"))}const S=h()({mx_EventTile_body:!0,mx_EventTile_bigEmoji:v,"markdown-body":u&&!v});let E;return!a&&l&&(E=J(o,!1)),a?r.a.createElement("span",{key:"body",ref:i.ref,className:S,dangerouslySetInnerHTML:{__html:a}}):r.a.createElement("span",{key:"body",ref:i.ref,className:S},E||o)}function Q(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];w.b.getValue("feature_html_topic")||(t=void 0);let s,o=!!t,a=!1,l="";try{a=A(o?t:e),o&&(l=c()(t,i?K:H),a&&(l=J(l,!0).join("")))}catch{o=!1}return!o&&a&&(s=J(e,!1)),o?r.a.createElement("span",{ref:n,dangerouslySetInnerHTML:{__html:l},dir:"auto"}):r.a.createElement("span",{ref:n,dir:"auto"},s||e)}function X(e){let{as:t,options:n,children:i}=e;return r.a.createElement(S.a,{as:t,options:Object(g.merge)({},E.e,n)},i)}function Z(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:E.e;return Object(E.b)(e,t)}function ee(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:E.e;return c()(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:E.e;return Object(E.c)(e,t)}(e,t),K)}function te(e){switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"PRE":case"BLOCKQUOTE":case"P":case"UL":case"OL":case"LI":case"HR":case"TABLE":case"THEAD":case"TBODY":case"TR":case"TH":case"TD":return!0;case"DIV":return!e.hasAttribute("data-mx-maths");default:return!1}}},function(e,t,n){"use strict";n.r(t),function(e,i){n.d(t,"OLM_ALGORITHM",(function(){return m})),n.d(t,"MEGOLM_ALGORITHM",(function(){return p})),n.d(t,"MEGOLM_BACKUP_ALGORITHM",(function(){return g})),n.d(t,"encryptMessageForDevice",(function(){return v})),n.d(t,"getExistingOlmSessions",(function(){return f})),n.d(t,"ensureOlmSessionsForDevices",(function(){return b})),n.d(t,"verifySignature",(function(){return S})),n.d(t,"pkSign",(function(){return E})),n.d(t,"pkVerify",(function(){return w})),n.d(t,"isOlmEncrypted",(function(){return _})),n.d(t,"encodeBase64",(function(){return C})),n.d(t,"encodeUnpaddedBase64",(function(){return O})),n.d(t,"decodeBase64",(function(){return I}));var s,o=n(13),r=n.n(o),a=n(426),c=n.n(a),l=n(1),d=n(130),u=n(16);function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}!function(e){e.Olm="m.olm.v1.curve25519-aes-sha2",e.Megolm="m.megolm.v1.aes-sha2",e.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2"}(s||(s={}));const m=s.Olm,p=s.Megolm,g=s.MegolmBackup;async function v(e,t,n,i,s,o,a){const c=o.getIdentityKey(),d=await i.getSessionIdForDevice(c);if(null===d)return void l.a.log(`[olmlib.encryptMessageForDevice] Unable to find Olm session for device ${s}:${o.deviceId}`);l.a.log(`[olmlib.encryptMessageForDevice] Using Olm session ${d} for device ${s}:${o.deviceId}`);const u=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({sender:t,sender_device:n,keys:{ed25519:i.deviceEd25519Key},recipient:s,recipient_keys:{ed25519:o.getFingerprint()}},a);e[c]=await i.encryptMessage(c,d,JSON.stringify(u))}async function f(e,t,n){const i=new u.b((()=>[])),s=new u.b((()=>new Map)),o=[];for(const[t,r]of Object.entries(n))for(const n of r){const r=n.deviceId,a=n.getIdentityKey();o.push((async()=>{const o=await e.getSessionIdForDevice(a,!0);null===o?i.getOrCreate(t).push(n):s.getOrCreate(t).set(r,{device:n,sessionId:o})})())}return await Promise.all(o),[i,s]}async function b(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:l.a;const a=[],c=new Map,d=new Map;for(const t of n.values())for(const n of t){const t=n.getIdentityKey();t!==e.deviceCurve25519Key&&(e.sessionsInProgress[t]||(e.sessionsInProgress[t]=new Promise((n=>{d.set(t,(i=>{delete e.sessionsInProgress[t],n(i)}))}))))}for(const[t,s]of n){const n=new Map;c.set(t,n);for(const o of s){const s=o.deviceId,c=o.getIdentityKey();if(c===e.deviceCurve25519Key){r.info("Attempted to start session with ourself! Ignoring"),n.set(s,{device:o,sessionId:null});continue}const l=`for ${c} (${t}:${s})`,u=await e.getSessionIdForDevice(c,!!d.get(c),r),h=d.get(c);null!==u&&h&&h(),(null===u||i)&&(i?r.info(`Forcing new Olm session ${l}`):r.info(`Making new Olm session ${l}`),a.push([t,s])),n.set(s,{device:o,sessionId:u})}}if(0===a.length)return c;const u="signed_curve25519";let h,m=`one-time keys for ${a.length} devices`;try{r.debug(`Claiming ${m}`),h=await t.claimOneTimeKeys(a,u,s),r.debug(`Claimed ${m}`)}catch(e){for(const e of d.values())e();throw r.log(`Failed to claim ${m}`,e,a),e}o&&"failures"in h&&o.push(...Object.keys(h.failures));const p=h.one_time_keys||{},g=[];for(const[t,s]of n){const n=p[t]||{};for(const o of s){var v,f;const s=o.deviceId,a=o.getIdentityKey();if(a===e.deviceCurve25519Key)continue;if(null!==(v=c.get(t))&&void 0!==v&&null!==(f=v.get(s))&&void 0!==f&&f.sessionId&&!i)continue;const l=n[s]||{};let h=null;for(const e in l)0===e.indexOf(u+":")&&(h=l[e]);var b;if(h)g.push(y(e,h,t,o).then((e=>{var n,i;null===(n=d.get(a))||void 0===n||n(null!=e?e:void 0);const o=null===(i=c.get(t))||void 0===i?void 0:i.get(s);o&&(o.sessionId=e)}),(e=>{var t;throw null===(t=d.get(a))||void 0===t||t(),e})));else r.warn(`No one-time keys (alg=${u}) for device ${t}:${s}`),null===(b=d.get(a))||void 0===b||b()}}return m=`Olm sessions for ${g.length} devices`,r.debug(`Starting ${m}`),await Promise.all(g),r.debug(`Started ${m}`),c}async function y(e,t,n,i){const s=i.deviceId;try{await S(e,t,n,s,i.getFingerprint())}catch(e){return l.a.error("Unable to verify signature on one-time key for device "+n+":"+s+":",e),null}let o;try{o=await e.createOutboundSession(i.getIdentityKey(),t.key)}catch(e){return l.a.error("Error starting olm session with device "+n+":"+s+": "+e),null}return l.a.log("Started new olm sessionid "+o+" for device "+n+":"+s),o}async function S(e,t,n,i,s){const o="ed25519:"+i,r=((t.signatures||{})[n]||{})[o];if(!r)throw Error("No signature");const a=Object.assign({},t);"unsigned"in a&&delete a.unsigned,delete a.signatures;const l=c.a.stringify(a);e.verifySignature(s,l,r)}function E(t,n,i,s){let o=!1;if(n instanceof Uint8Array){const t=new e.Olm.PkSigning;s=t.init_with_seed(n),n=t,o=!0}const r=t.signatures||{};delete t.signatures;const a=t.unsigned;t.unsigned&&delete t.unsigned;try{const e=r[i]||{};return r[i]=e,e["ed25519:"+s]=n.sign(c.a.stringify(t))}finally{t.signatures=r,a&&(t.unsigned=a),o&&n.free()}}function w(t,n,i){const s="ed25519:"+n;if(!(t.signatures&&t.signatures[i]&&t.signatures[i][s]))throw new Error("No signature");const o=t.signatures[i][s],r=new e.Olm.Utility,a=t.signatures;delete t.signatures;const l=t.unsigned;t.unsigned&&delete t.unsigned;try{r.ed25519_verify(n,c.a.stringify(t),o)}finally{t.signatures=a,l&&(t.unsigned=l),r.free()}}function _(e){return e.getSenderKey()?!(e.getWireType()!==d.b.RoomMessageEncrypted||!["m.olm.v1.curve25519-aes-sha2"].includes(e.getWireContent().algorithm))||(l.a.error("Event was not encrypted using an appropriate algorithm"),!1):(l.a.error("Event has no sender key (not encrypted?)"),!1)}function C(e){return i.from(e).toString("base64")}function O(e){return C(e).replace(/=+$/g,"")}function I(e){return i.from(e,"base64")}}.call(this,n(14),n(53).Buffer)},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(120),s=n.n(i),o=n(127),r=n.n(o);function a(e){let{description:t,hideDescriptionIfValid:n,deriveData:i,rules:o}=e;return async function(e){let{value:a,focused:c,allowEmpty:l=!0}=e;if(!a&&l)return{};const d={value:a,allowEmpty:l},u=await(null==i?void 0:i.call(this,d)),h=[];let m,p,g,v=!0;if(null!=o&&o.length)for(const e of o){var f;if(!e.key||!e.test)continue;if(!v&&e.final)continue;if(null!==(f=e.skip)&&void 0!==f&&f.call(this,d,u))continue;const t=await e.test.call(this,d,u);if(v=v&&t,t&&e.valid){const t=e.valid.call(this,u);if(!t)continue;h.push({key:e.key,valid:!0,text:t})}else if(!t&&e.invalid){const t=e.invalid.call(this,u);if(!t)continue;h.push({key:e.key,valid:!1,text:t})}}if(!c)return{valid:v};if(h&&h.length&&(m=s.a.createElement("ul",{className:"mx_Validation_details"},h.map((e=>{const t=r()({mx_Validation_detail:!0,mx_Validation_valid:e.valid,mx_Validation_invalid:!e.valid});return s.a.createElement("li",{key:e.key,className:t},e.text)})))),t&&(m||!n)){const e=t.call(this,u,h);p=e?s.a.createElement("div",{className:"mx_Validation_description"},e):void 0}return(p||m)&&(g=s.a.createElement("div",{className:"mx_Validation"},p,m)),{valid:v,feedback:g}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(122),s=n.n(i);class o{constructor(e,t){this.preferred=e,this.legacy=t}matches(e){return e===this.preferred||e===this.legacy}static fromString(e){const t=Object.values(o).filter((e=>e instanceof o)).find((t=>t.matches(e)));return t||new o(e,e)}}s()(o,"JITSI",new o("m.jitsi","jitsi")),s()(o,"STICKERPICKER",new o("m.stickerpicker","m.stickerpicker")),s()(o,"INTEGRATION_MANAGER",new o("m.integration_manager","m.integration_manager")),s()(o,"CUSTOM",new o("m.custom","m.custom"))},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(154),r=n(590);class a extends o.a{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}),s()(this,"readyStore",void 0);const t=this;this.readyStore=new class extends r.a{get mxClient(){return this.matrixClient}async onReady(){return t.onReady()}async onNotReady(){return t.onNotReady()}}(e)}async start(){await this.readyStore.start()}get matrixClient(){return this.readyStore.mxClient}async onReady(){}async onNotReady(){}async onDispatch(e){await this.onAction(e)}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var i=n(121);let s;function o(e){switch(e){case s.None:return Object(i.a)("None");case s.Bold:return Object(i.a)("Bold");case s.Grey:return Object(i.a)("Grey");case s.Red:return Object(i.a)("Red");case s.Unsent:return Object(i.a)("Unsent");default:return Object(i.a)("unknown")}}!function(e){e[e.None=0]="None",e[e.Bold=1]="Bold",e[e.Grey=2]="Grey",e[e.Red=3]="Red",e[e.Unsent=4]="Unsent"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"c",(function(){return D})),n.d(t,"g",(function(){return N})),n.d(t,"f",(function(){return M})),n.d(t,"b",(function(){return A})),n.d(t,"a",(function(){return L})),n.d(t,"e",(function(){return U})),n.d(t,"d",(function(){return F}));var i=n(122),s=n.n(i),o=n(159),r=n(1),a=n(225),c=n(141),l=n(152),d=n(190),u=n(15),h=n(204),m=n(226),p=n(130),g=n(132),v=n(126),f=n(249),b=n(400),y=n(183),S=n(202),E=n(2),w=n(239),_=n(270),C=n(339),O=n(156),I=n(121),R=n(861),k=n(128),x=n(474),T=n(191);const j=16e3,P=async function(e,t){let n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>!0;const s=new Promise((s=>{n=function(){i(...arguments)&&s()},e.on(t,n)})),o=!1===await Object(b.b)(s,!1,j);if(e.off(t,n),o)throw new Error("Timed out")};let D;!function(e){e.Disconnected="disconnected",e.Connecting="connecting",e.Connected="connected",e.Disconnecting="disconnecting"}(D||(D={}));const N=e=>e===D.Connected||e===D.Disconnecting;let M,A;!function(e){e.Tile="tile",e.Spotlight="spotlight"}(M||(M={})),function(e){e.ConnectionState="connection_state",e.Participants="participants",e.Layout="layout",e.Destroy="destroy"}(A||(A={}));class L extends o.b{get messaging(){return this._messaging}set messaging(e){this._messaging=e}get roomId(){return this.widget.roomId}get connectionState(){return this._connectionState}set connectionState(e){const t=this._connectionState;this._connectionState=e,this.emit(A.ConnectionState,e,t)}get connected(){return N(this.connectionState)}get participants(){return this._participants}set participants(e){const t=this._participants;this._participants=e,this.emit(A.Participants,e,t)}constructor(e,t){super(),this.widget=e,this.client=t,s()(this,"widgetUid",y.a.getWidgetUid(this.widget)),s()(this,"room",this.client.getRoom(this.roomId)),s()(this,"STUCK_DEVICE_TIMEOUT_MS",void 0),s()(this,"_messaging",null),s()(this,"_connectionState",D.Disconnected),s()(this,"_participants",new Map),s()(this,"onMyMembership",(async(e,t)=>{"join"!==t&&this.setDisconnected()})),s()(this,"onStopMessaging",(e=>{e===this.widgetUid&&(r.a.log("The widget died; treating this as a user hangup"),this.setDisconnected())})),s()(this,"beforeUnload",(()=>this.setDisconnected()))}static get(e){var t;return null!==(t=F.get(e))&&void 0!==t?t:U.get(e)}async connect(){this.connectionState=D.Connecting;const{[f.b.AudioInput]:e,[f.b.VideoInput]:t}=await f.c.getDevices();let n=null;if(!f.c.startWithAudioMuted){var i,s;const t=f.c.getAudioInput();n=null!==(i=null!==(s=e.find((e=>e.deviceId===t)))&&void 0!==s?s:e[0])&&void 0!==i?i:null}let o=null;if(!f.c.startWithVideoMuted){var r,a;const e=f.c.getVideoInput();o=null!==(r=null!==(a=t.find((t=>t.deviceId===e)))&&void 0!==a?a:t[0])&&void 0!==r?r:null}const l=_.a.instance;if(this.messaging=l.getMessagingForUid(this.widgetUid),!this.messaging)try{await P(l,_.b.StoreMessaging,((e,t)=>e===this.widgetUid&&(this.messaging=t,!0)))}catch(e){throw new Error(`Failed to bind call widget in room ${this.roomId}: ${e}`)}try{await this.performConnection(n,o)}catch(e){throw this.connectionState=D.Disconnected,e}this.room.on(c.d.MyMembership,this.onMyMembership),_.a.instance.on(_.b.StopMessaging,this.onStopMessaging),window.addEventListener("beforeunload",this.beforeUnload),this.connectionState=D.Connected}async disconnect(){if(this.connectionState!==D.Connected)throw new Error("Not connected");this.connectionState=D.Disconnecting,await this.performDisconnection(),this.setDisconnected()}setDisconnected(){this.room.off(c.d.MyMembership,this.onMyMembership),_.a.instance.off(_.b.StopMessaging,this.onStopMessaging),window.removeEventListener("beforeunload",this.beforeUnload),this.messaging=null,this.connectionState=D.Disconnected}destroy(){this.connected&&this.setDisconnected(),this.emit(A.Destroy)}}class U extends L{constructor(e,t){super(e,t),s()(this,"STUCK_DEVICE_TIMEOUT_MS",36e5),s()(this,"resendDevicesTimer",null),s()(this,"participantsExpirationTimer",null),s()(this,"onRoomState",(()=>this.updateParticipants())),s()(this,"onConnectionState",(async(e,t)=>{e!==D.Connected||N(t)?e===D.Disconnected&&N(t)&&(this.updateParticipants(),null!==this.resendDevicesTimer&&(clearInterval(this.resendDevicesTimer),this.resendDevicesTimer=null),await this.removeOurDevice()):(this.updateParticipants(),await this.addOurDevice(),this.resendDevicesTimer=window.setInterval((async()=>{r.a.log(`Resending video member event for ${this.roomId}`),await this.addOurDevice()}),3*this.STUCK_DEVICE_TIMEOUT_MS/4))})),s()(this,"onDock",(async()=>{await this.messaging.transport.send(E.a.TileLayout,{})})),s()(this,"onUndock",(async()=>{await this.messaging.transport.send(E.a.SpotlightLayout,{})})),s()(this,"onHangup",(async e=>{this.connectionState!==D.Disconnecting&&(e.preventDefault(),this.connectionState===D.Connecting&&await P(this,A.ConnectionState),await this.messaging.transport.reply(e.detail,{}),this.setDisconnected())})),this.room.on(l.b.Update,this.onRoomState),this.on(A.ConnectionState,this.onConnectionState),this.updateParticipants()}static get(e){if(v.b.getValue("feature_video_rooms")&&e.isElementVideoRoom()){const t=w.a.instance.getApps(e.roomId).find((e=>{var t;return S.a.JITSI.matches(e.type)&&(null===(t=e.data)||void 0===t?void 0:t.isVideoChannel)}));if(t)return new U(t,e.client)}return null}static async create(e){await y.a.addJitsiWidget(e.roomId,d.g.Video,"Group call",!0,e.name)}updateParticipants(){null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null);const e=new Map,t=Date.now();let n=1/0;for(const i of this.room.currentState.getStateEvents(U.MEMBER_EVENT_TYPE)){const s=this.room.getMember(i.getStateKey()),o=i.getContent(),r="number"==typeof o.expires_ts?o.expires_ts:-1/0;let a=r>t&&Array.isArray(o.devices)?o.devices.filter((e=>"string"==typeof e)):[];this.connected||(null==s?void 0:s.userId)!==this.client.getUserId()||(a=a.filter((e=>e!==this.client.getDeviceId()))),a.length>0&&"join"===(null==s?void 0:s.membership)&&(e.set(s,new Set(a)),r<n&&(n=r))}if(this.connected){const t=this.room.getMember(this.client.getUserId());let n=e.get(t);void 0===n&&(n=new Set,e.set(t,n)),n.add(this.client.getDeviceId())}this.participants=e,n<1/0&&(this.participantsExpirationTimer=window.setTimeout((()=>this.updateParticipants()),n-t))}async updateDevices(e){if("join"!==this.room.getMyMembership())return;const t=this.room.currentState.getStateEvents(U.MEMBER_EVENT_TYPE,this.client.getUserId()),n=null==t?void 0:t.getContent(),i=e(("number"==typeof(null==n?void 0:n.expires_ts)?n.expires_ts:-1/0)>Date.now()&&Array.isArray(null==n?void 0:n.devices)?n.devices:[]);if(null!==i){const e={devices:i,expires_ts:Date.now()+this.STUCK_DEVICE_TIMEOUT_MS};await this.client.sendStateEvent(this.roomId,U.MEMBER_EVENT_TYPE,e,this.client.getUserId())}}async clean(){const e=Date.now(),{devices:t}=await this.client.getDevices(),n=new Map(t.map((e=>[e.device_id,e])));await this.updateDevices((t=>{const i=t.filter((t=>{const i=n.get(t);return void 0!==(null==i?void 0:i.last_seen_ts)&&!(t===this.client.getDeviceId()&&!this.connected)&&e-i.last_seen_ts<this.STUCK_DEVICE_TIMEOUT_MS}));return i.length===t.length?null:i}))}async addOurDevice(){await this.updateDevices((e=>Array.from(new Set(e).add(this.client.getDeviceId()))))}async removeOurDevice(){await this.updateDevices((e=>{const t=new Set(e);return t.delete(this.client.getDeviceId()),Array.from(t)}))}async performConnection(e,t){var n,i;const s=new Promise(((e,t)=>{const n=_.a.instance,i=e=>{e===this.widgetUid&&(o(),t(new Error("Messaging stopped")))},s=()=>{o(),e()},o=()=>{n.off(_.b.StopMessaging,i),this.off(A.ConnectionState,s)};n.on(_.b.StopMessaging,i),this.on(A.ConnectionState,s)}));this.messaging.on(`action:${E.a.HangupCall}`,this.onHangup);const o=P(this.messaging,`action:${E.a.JoinCall}`,(e=>(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),!0))),r=this.messaging.transport.send(E.a.JoinCall,{audioInput:null!==(n=null==e?void 0:e.label)&&void 0!==n?n:null,videoInput:null!==(i=null==t?void 0:t.label)&&void 0!==i?i:null});try{await Promise.race([Promise.all([r,o]),s])}catch(e){throw this.messaging.off(`action:${E.a.HangupCall}`,this.onHangup),this.messaging.transport.ready&&this.messaging.transport.send(E.a.HangupCall,{force:!0}),new Error(`Failed to join call in room ${this.roomId}: ${e}`)}C.b.instance.on(C.a.Dock,this.onDock),C.b.instance.on(C.a.Undock,this.onUndock)}async performDisconnection(){const e=P(this.messaging,`action:${E.a.HangupCall}`,(e=>(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),!0))),t=this.messaging.transport.send(E.a.HangupCall,{});try{await Promise.all([t,e])}catch(e){throw new Error(`Failed to hangup call in room ${this.roomId}: ${e}`)}}setDisconnected(){this.messaging.off(`action:${E.a.HangupCall}`,this.onHangup),C.b.instance.off(C.a.Dock,this.onDock),C.b.instance.off(C.a.Undock,this.onUndock),super.setDisconnected()}destroy(){this.room.off(l.b.Update,this.onRoomState),this.on(A.ConnectionState,this.onConnectionState),null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),null!==this.resendDevicesTimer&&(clearInterval(this.resendDevicesTimer),this.resendDevicesTimer=null),super.destroy()}}s()(U,"MEMBER_EVENT_TYPE","io.element.video.member");class F extends L{get layout(){return this._layout}set layout(e){this._layout=e,this.emit(A.Layout,e)}constructor(e,t){var n;const i=t.getAccountData(T.a.ANALYTICS_EVENT_TYPE),o=null!=i&&i.getContent().pseudonymousAnalyticsOptIn?null==i?void 0:i.getContent().id:"",r=new URLSearchParams({embed:"",preload:"",hideHeader:"",userId:t.getUserId(),deviceId:t.getDeviceId(),roomId:e.room.roomId,baseUrl:t.baseUrl,lang:Object(I.e)().replace("_","-"),fontScale:""+v.b.getValue("baseFontSize")/x.a.DEFAULT_SIZE,analyticsID:o});v.b.getValue("useSystemFont")&&v.b.getValue("systemFont").split(",").map((e=>((e=e.trim()).startsWith('"')&&e.endsWith('"')&&(e=e.slice(1,-1)),e))).forEach((e=>r.append("font",e)));const c=new URL(null!==(n=g.b.get("element_call").url)&&void 0!==n?n:g.a.element_call.url);c.pathname="/room",c.hash=`#?${r.toString()}`,super(w.a.instance.addVirtualWidget({id:Object(a.b)(24),creatorUserId:t.getUserId(),name:"Element Call",type:h.MatrixWidgetType.Custom,url:c.toString()},e.room.roomId),t),this.groupCall=e,s()(this,"STUCK_DEVICE_TIMEOUT_MS",36e5),s()(this,"terminationTimer",null),s()(this,"_layout",M.Tile),s()(this,"onParticipants",(async(e,t)=>{let n=0;for(const t of e.values())n+=t.size;let i=0;for(const e of t.values())i+=e.size;var s;0===n&&i>0&&this.mayTerminate&&(null!==(s=t.get(this.room.getMember(this.client.getUserId())))&&void 0!==s&&s.has(this.client.getDeviceId())?await this.groupCall.terminate():this.terminationTimer=window.setTimeout((()=>this.groupCall.terminate()),6e3*Math.random()+2e3))})),s()(this,"onGroupCallParticipants",(()=>this.updateParticipants())),s()(this,"onGroupCallState",(e=>{e===m.e.Ended&&this.destroy()})),s()(this,"onHangup",(async e=>{e.preventDefault(),await this.messaging.transport.reply(e.detail,{}),this.setDisconnected()})),s()(this,"onTileLayout",(async e=>{e.preventDefault(),this.layout=M.Tile,await this.messaging.transport.reply(e.detail,{})})),s()(this,"onSpotlightLayout",(async e=>{e.preventDefault(),this.layout=M.Spotlight,await this.messaging.transport.reply(e.detail,{})})),s()(this,"onScreenshareRequest",(async e=>{var t;if(e.preventDefault(),null!==(t=O.a.get())&&void 0!==t&&t.supportsDesktopCapturer()){await this.messaging.transport.reply(e.detail,{pending:!0});const{finished:t}=k.b.createDialog(R.a),[n]=await t;n?await this.messaging.transport.send(E.a.ScreenshareStart,{desktopCapturerSourceId:n}):await this.messaging.transport.send(E.a.ScreenshareStop,{})}else await this.messaging.transport.reply(e.detail,{pending:!1})})),this.on(A.Participants,this.onParticipants),e.on(m.c.ParticipantsChanged,this.onGroupCallParticipants),e.on(m.c.GroupCallStateChanged,this.onGroupCallState),this.updateParticipants()}static get(e){if(v.b.getValue("feature_group_calls")||v.b.getValue("feature_video_rooms")&&v.b.getValue("feature_element_call_video_rooms")&&e.isCallRoom()){const t=e.client.groupCallEventHandler.groupCalls.get(e.roomId);if(void 0!==t)return new F(t,e.client)}return null}static async create(e){const t=v.b.getValue("feature_video_rooms")&&v.b.getValue("feature_element_call_video_rooms")&&e.isCallRoom(),n=new m.a(e.client,e,m.f.Video,!1,t?m.d.Room:m.d.Prompt);await n.create()}clean(){return this.groupCall.cleanMemberState()}async performConnection(e,t){try{var n,i;await this.messaging.transport.send(E.a.JoinCall,{audioInput:null!==(n=null==e?void 0:e.label)&&void 0!==n?n:null,videoInput:null!==(i=null==t?void 0:t.label)&&void 0!==i?i:null})}catch(e){throw new Error(`Failed to join call in room ${this.roomId}: ${e}`)}this.groupCall.enteredViaAnotherSession=!0,this.messaging.on(`action:${E.a.HangupCall}`,this.onHangup),this.messaging.on(`action:${E.a.TileLayout}`,this.onTileLayout),this.messaging.on(`action:${E.a.SpotlightLayout}`,this.onSpotlightLayout),this.messaging.on(`action:${E.a.ScreenshareRequest}`,this.onScreenshareRequest)}async performDisconnection(){try{await this.messaging.transport.send(E.a.HangupCall,{})}catch(e){throw new Error(`Failed to hangup call in room ${this.roomId}: ${e}`)}}setDisconnected(){this.messaging.off(`action:${E.a.HangupCall}`,this.onHangup),this.messaging.off(`action:${E.a.TileLayout}`,this.onTileLayout),this.messaging.off(`action:${E.a.SpotlightLayout}`,this.onSpotlightLayout),this.messaging.off(`action:${E.a.ScreenshareRequest}`,this.onScreenshareRequest),super.setDisconnected(),this.groupCall.enteredViaAnotherSession=!1}destroy(){w.a.instance.removeVirtualWidget(this.widget.id,this.groupCall.room.roomId),this.off(A.Participants,this.onParticipants),this.groupCall.off(m.c.ParticipantsChanged,this.onGroupCallParticipants),this.groupCall.off(m.c.GroupCallStateChanged,this.onGroupCallState),null!==this.terminationTimer&&(clearTimeout(this.terminationTimer),this.terminationTimer=null),super.destroy()}async setLayout(e){const t=e===M.Tile?E.a.TileLayout:E.a.SpotlightLayout;await this.messaging.transport.send(t,{})}updateParticipants(){const e=new Map;for(const[t,n]of this.groupCall.participants)e.set(t,new Set(n.keys()));this.participants=e}get mayTerminate(){return this.groupCall.intent!==m.d.Room&&this.room.currentState.mayClientSendStateEvent(F.CALL_EVENT_TYPE.name,this.client)}}s()(F,"CALL_EVENT_TYPE",new u.a(null,p.b.GroupCallPrefix)),s()(F,"MEMBER_EVENT_TYPE",new u.a(null,p.b.GroupCallMemberPrefix))},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o}));var i=n(15);const s=new i.c("m.beacon_info","org.matrix.msc3672.beacon_info"),o=new i.c("m.beacon","org.matrix.msc3672.beacon")},function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return o}));const i={HOME:"Home",END:"End",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",BACKSPACE:"Backspace",DELETE:"Delete",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight",TAB:"Tab",ESCAPE:"Escape",ENTER:"Enter",ALT:"Alt",CONTROL:"Control",META:"Meta",SHIFT:"Shift",CONTEXT_MENU:"ContextMenu",COMMA:",",PERIOD:".",LESS_THAN:"<",GREATER_THAN:">",BACKTICK:"`",SPACE:" ",SLASH:"/",SQUARE_BRACKET_LEFT:"[",SQUARE_BRACKET_RIGHT:"]",SEMICOLON:";",A:"a",B:"b",C:"c",D:"d",E:"e",F:"f",G:"g",H:"h",I:"i",J:"j",K:"k",L:"l",M:"m",N:"n",O:"o",P:"p",Q:"q",R:"r",S:"s",T:"t",U:"u",V:"v",W:"w",X:"x",Y:"y",Z:"z"},s=navigator.platform.toUpperCase().includes("MAC");function o(e){return s?e.metaKey&&!e.altKey&&!e.ctrlKey&&!e.shiftKey:e.ctrlKey&&!e.altKey&&!e.metaKey&&!e.shiftKey}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(735);class c extends r.a.PureComponent{render(){return r.a.createElement("div",{className:"mx_InlineSpinner"},r.a.createElement(a.a,{w:this.props.w,h:this.props.h,className:"mx_InlineSpinner_icon mx_Spinner_icon"}))}}s()(c,"defaultProps",{w:32,h:32})},function(e,t,n){"use strict";n.d(t,"c",(function(){return b})),n.d(t,"a",(function(){return y})),n.d(t,"b",(function(){return S})),n.d(t,"d",(function(){return E}));var i=n(122),s=n.n(i),o=n(152),r=n(16),a=n(126),c=n(239),l=n(202),d=n(293),u=n(125),h=n(590),m=n(138),p=n(147),g=n(154);function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const b="io.element.widgets.layout";let y;!function(e){e.Top="top",e.Right="right",e.Center="center"}(y||(y={}));const S=3;class E extends h.a{constructor(){super(u.a),s()(this,"byRoom",new r.b((()=>new Map))),s()(this,"pinnedRef",void 0),s()(this,"layoutRef",void 0),s()(this,"updateAllRooms",(()=>{this.byRoom=new r.b((()=>new Map));for(const e of this.matrixClient.getVisibleRooms())this.recalculateRoom(e)})),s()(this,"updateFromWidgetStore",(e=>{if(e){var t;const n=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e);n&&this.recalculateRoom(n)}else this.updateAllRooms()})),s()(this,"updateRoomFromState",(e=>{var t;if(e.getType()!==b)return;const n=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e.getRoomId());n&&this.recalculateRoom(n)})),s()(this,"updateFromSettings",((e,t)=>{if(t){var n;const e=null===(n=this.matrixClient)||void 0===n?void 0:n.getRoom(t);e&&this.recalculateRoom(e)}else this.updateAllRooms()}))}static get instance(){return this.internalInstance||(this.internalInstance=new E,this.internalInstance.start()),this.internalInstance}static emissionForRoom(e){return`update_${e.roomId}`}emitFor(e){this.emit(E.emissionForRoom(e))}async onReady(){var e;this.updateAllRooms(),null===(e=this.matrixClient)||void 0===e||e.on(o.b.Events,this.updateRoomFromState),this.pinnedRef=a.b.watchSetting("Widgets.pinned",null,this.updateFromSettings),this.layoutRef=a.b.watchSetting("Widgets.layout",null,this.updateFromSettings),c.a.instance.on(g.b,this.updateFromWidgetStore)}async onNotReady(){var e;this.byRoom=new r.b((()=>new Map)),null===(e=this.matrixClient)||void 0===e||e.off(o.b.Events,this.updateRoomFromState),a.b.unwatchSetting(this.pinnedRef),a.b.unwatchSetting(this.layoutRef),c.a.instance.off(g.b,this.updateFromWidgetStore)}recalculateRoom(e){var t;const n=c.a.instance.getApps(e.roomId);if(null==n||!n.length)return this.byRoom.set(e.roomId,new Map),void this.emitFor(e);const i=this.byRoom.getOrCreate(e.roomId),s=JSON.stringify(Object(r.F)(i)),o=e.currentState.getStateEvents(b,""),u=a.b.getValue("Widgets.pinned",e.roomId);let h=a.b.getValue("Widgets.layout",e.roomId);o&&h&&h.overrides!==o.getId()&&(h=null);const m=null!==(t=null==o?void 0:o.getContent())&&void 0!==t?t:null,p=[],g=[],v=[];for(const e of n){var f,E,w,_,C;const t=null==m||null===(f=m.widgets)||void 0===f||null===(E=f[e.id])||void 0===E?void 0:E.container,n=null===(w=h)||void 0===w||null===(_=w.widgets)||void 0===_||null===(C=_[e.id])||void 0===C?void 0:C.container,i=!(null==u||!u[e.id]),s=l.a.JITSI.matches(e.type)?y.Top:y.Right;if(n?n===y.Center:t===y.Center){v.length?console.error("Tried to push a second widget into the center container"):v.push(e);continue}let o=s;n||t?o=null!=n?n:t:i&&!t&&(o=y.Top),(o===y.Top?p:g).push(e)}const O=p.slice(S);g.push(...O),p.sort(((e,t)=>{var n,i,s,o,a,c;const u=null==m||null===(n=m.widgets)||void 0===n?void 0:n[e.id],p=null==m||null===(i=m.widgets)||void 0===i?void 0:i[t.id],g=null===(s=h)||void 0===s||null===(o=s.widgets)||void 0===o?void 0:o[e.id],v=null===(a=h)||void 0===a||null===(c=a.widgets)||void 0===c?void 0:c[t.id],f=l.a.JITSI.matches(e.type)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,b=l.a.JITSI.matches(t.type)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,y=Object(d.b)(null==g?void 0:g.index,Object(d.b)(null==u?void 0:u.index,f)),S=Object(d.b)(null==v?void 0:v.index,Object(d.b)(null==p?void 0:p.index,b));return y===S?Object(r.h)(e.id,t.id):y-S}));const I=[];let R=null,k=!0;for(let e=0;e<p.length;e++){var x,T,j;const t=p[e],n=null==m||null===(x=m.widgets)||void 0===x?void 0:x[t.id],i=null===(T=h)||void 0===T||null===(j=T.widgets)||void 0===j?void 0:j[t.id];if(Number.isFinite(null==i?void 0:i.width)||Number.isFinite(null==n?void 0:n.width)){const e=(null==i?void 0:i.width)||(null==n?void 0:n.width),t=Object(d.a)(e,10,100);I.push(t),k=!1}else I.push(100);if(null!=n&&n.height||null!=i&&i.height){const e=Object(d.b)(null==n?void 0:n.height,2),t=Object(d.b)(null==i?void 0:i.height,e);R=Math.max(R,Object(d.a)(t,2,100))}}if(k)for(let e=0;e<I.length;e++)I[e]=100/I.length;else{const e=Object(d.e)(...I)-100;if(e<0)for(let t=0;t<I.length;t++)I[t]+=Math.abs(e)/I.length;else if(e>0){for(let t=0;t<I.length;t++)I[t]=Object(d.a)(I[t]-e/I.length,10,100);const t=Object(d.e)(...I)-100;if(t>0){const e=I.map(((e,t)=>[t,e])).filter((e=>e[1]>10)).map((e=>e[0]));for(const n of e)I[n]-=t/e.length}}}const P=new Map;this.byRoom.set(e.roomId,P),p.length&&P.set(y.Top,{ordered:p,distributions:I,height:R}),g.length&&P.set(y.Right,{ordered:g}),v.length&&P.set(y.Center,{ordered:v});JSON.stringify(Object(r.F)(P))!==s&&this.emitFor(e)}getContainerWidgets(e,t){var n,i;return(null===(n=this.byRoom.get(null==e?void 0:e.roomId))||void 0===n||null===(i=n.get(t))||void 0===i?void 0:i.ordered)||[]}isInContainer(e,t,n){return this.getContainerWidgets(e,n).some((e=>e.id===t.id))}canAddToContainer(e,t){switch(t){case y.Top:case y.Right:return this.getContainerWidgets(e,t).length<S;case y.Center:return this.getContainerWidgets(e,t).length<1}}getResizerDistributions(e,t){var n,i;let s=null===(n=this.byRoom.get(e.roomId))||void 0===n||null===(i=n.get(t))||void 0===i?void 0:i.distributions;return!s||s.length<2?[]:(2===s.length&&(s=[s[0]]),3===s.length&&(s=[s[0],s[2]]),s.map((e=>`${e.toFixed(1)}%`)))}setResizerDistributions(e,t,n){if(t!==y.Top)return;const i=n.map((e=>Number(Number(e.substring(0,e.length-1)).toFixed(1)))),s=this.getContainerWidgets(e,t),o=100-Object(d.e)(...i);2===i.length&&i.splice(1,0,o),1===i.length&&i.push(o);const r={};s.forEach(((n,s)=>{var o,a;r[n.id]={container:t,width:i[s],index:s,height:(null===(o=this.byRoom.get(e.roomId))||void 0===o||null===(a=o.get(t))||void 0===a?void 0:a.height)||2}})),this.updateUserLayout(e,r)}getContainerHeight(e,t){var n,i,s;return null!==(n=null===(i=this.byRoom.get(e.roomId))||void 0===i||null===(s=i.get(t))||void 0===s?void 0:s.height)&&void 0!==n?n:null}setContainerHeight(e,t,n){var i,s;const o=this.getContainerWidgets(e,t),r=null===(i=this.byRoom.get(e.roomId))||void 0===i||null===(s=i.get(t))||void 0===s?void 0:s.distributions,a={};o.forEach(((e,i)=>{a[e.id]={container:t,width:null==r?void 0:r[i],index:i,height:n}})),this.updateUserLayout(e,a)}moveWithinContainer(e,t,n,i){var s,o,r,a;const c=Object(p.b)(this.getContainerWidgets(e,t)),l=c.findIndex((e=>e.id===n.id));if(l<0)return;c.splice(l,1);const u=Object(d.a)(l+i,0,c.length);c.splice(u,0,n);const h=null===(s=this.byRoom.get(e.roomId))||void 0===s||null===(o=s.get(t))||void 0===o?void 0:o.distributions,m=null===(r=this.byRoom.get(e.roomId))||void 0===r||null===(a=r.get(t))||void 0===a?void 0:a.height,g={};c.forEach(((e,n)=>{g[e.id]={container:t,width:null==h?void 0:h[n],index:n,height:m}})),this.updateUserLayout(e,g)}moveToContainer(e,t,n){if(!this.getAllWidgets(e).some((e=>{let[n]=e;return n.id===t.id})))return;const i={};switch(n){case y.Right:break;case y.Center:for(const t of this.getContainerWidgets(e,y.Top))i[t.id]={container:y.Right};for(const t of this.getContainerWidgets(e,y.Center))i[t.id]={container:y.Right};break;case y.Top:if(this.hasMaximisedWidget(e)){i[this.getContainerWidgets(e,y.Center)[0].id]={container:y.Right}}}i[t.id]={container:n},this.updateUserLayout(e,i)}hasMaximisedWidget(e){return this.getContainerWidgets(e,y.Center).length>0}hasPinnedWidgets(e){return this.getContainerWidgets(e,y.Top).length>0}canCopyLayoutToRoom(e){return!!this.matrixClient&&e.currentState.maySendStateEvent(b,this.matrixClient.getUserId())}copyLayoutToRoom(e){var t;const n=this.getAllWidgets(e),i={widgets:{}};for(const[t,c]of n)if(i.widgets[t.id]={container:c},c===y.Top){var s,o,r,a;const n=this.getContainerWidgets(e,c).findIndex((e=>e.id===t.id)),l=null===(s=this.byRoom.get(e.roomId))||void 0===s||null===(o=s.get(c))||void 0===o?void 0:o.distributions,d=null===(r=this.byRoom.get(e.roomId))||void 0===r||null===(a=r.get(c))||void 0===a?void 0:a.height;i.widgets[t.id]=f(f({},i.widgets[t.id]),{},{height:d?Math.round(d):void 0,width:null!=l&&l[n]?Math.round(l[n]):void 0,index:n})}null===(t=this.matrixClient)||void 0===t||t.sendStateEvent(e.roomId,b,i,"")}getAllWidgets(e){const t=this.byRoom.get(e.roomId);if(!t)return[];const n=[];for(const[e,i]of t){const t=i.ordered;for(const i of t)n.push([i,e])}return n}updateUserLayout(e,t){const n=this.getAllWidgets(e);for(const[a,c]of n){var i,s;const n=this.getContainerWidgets(e,c).findIndex((e=>e.id===a.id)),l=null===(i=this.byRoom.get(e.roomId))||void 0===i||null===(s=i.get(c))||void 0===s?void 0:s.distributions;var o,r;if(!t[a.id])t[a.id]={container:c,index:n,height:null===(o=this.byRoom.get(e.roomId))||void 0===o||null===(r=o.get(c))||void 0===r?void 0:r.height,width:null==l?void 0:l[n]}}const c=e.currentState.getStateEvents(b,"");a.b.setValue("Widgets.layout",e.roomId,m.a.ROOM_ACCOUNT,{overrides:null==c?void 0:c.getId(),widgets:t}).catch((()=>this.recalculateRoom(e))),this.recalculateRoom(e)}}s()(E,"internalInstance",void 0),window.mxWidgetLayoutStore=E.instance},function(e,t,n){"use strict";n.d(t,"f",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"d",(function(){return r})),n.d(t,"b",(function(){return a})),n.d(t,"e",(function(){return c})),n.d(t,"a",(function(){return l})),n.d(t,"g",(function(){return d})),n.d(t,"h",(function(){return u}));var i=n(121);const s=Symbol("top-level-spaces"),o=Symbol("invited-spaces"),r=Symbol("selected-space"),a=Symbol("home-behaviour"),c=Symbol("suggested-rooms");let l;!function(e){e.Home="home-space",e.Favourites="favourites-space",e.People="people-space",e.Orphans="orphans-space"}(l||(l={}));const d=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];switch(e){case l.Home:return t?Object(i.a)("All rooms"):Object(i.a)("Home");case l.Favourites:return Object(i.a)("Favourites");case l.People:return Object(i.a)("People");case l.Orphans:return Object(i.a)("Other rooms")}};function u(e){return e===l.Home||e===l.Favourites||e===l.People||e===l.Orphans}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{getValueOverride(e,t,n,i){return null}async beforeChange(e,t,n){return!0}onChange(e,t,n){}get settingDisabled(){return!1}}},,function(e,t,n){"use strict";n.d(t,"c",(function(){return r})),n.d(t,"d",(function(){return a})),n.d(t,"a",(function(){return c})),n.d(t,"e",(function(){return l})),n.d(t,"f",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(121),s=n(461),o=n(794);function r(e){return e<1e3?e.toString():e<1e4?(e/1e3).toFixed(1)+"K":e<1e5?(e/1e3).toFixed(0)+"K":e<1e7?(e/1e6).toFixed(1)+"M":e<1e8?(e/1e6).toFixed(0)+"M":(e/1e9).toFixed(1)+"B"}function a(e){return(new Intl.NumberFormat).format(e)}function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(0===e)return"0 Bytes";const n=t<0?0:t,i=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,i)).toFixed(n))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][i]}function l(e){return e.match(/.{1,4}/g).join(" ")}function d(e,t,n){if(e===s.a.MXID){return`mx_Username_color${function(e){let t,n,i=0;if(0===e.length)return i;for(t=0;t<e.length;t++)n=e.charCodeAt(t),i=(i<<5)-i+n,i|=0;return Math.abs(i)}(t)%8+1}`}if(e===s.a.PowerLevel){const e=null==n?void 0:n.getMember(t),i=null==e?void 0:e.powerLevel;return i>=100?"mx_Username_color_pl100":i>=95?"mx_Username_color_pl95":i>=51?"mx_Username_color_pl51":i>=50?"mx_Username_color_pl50":i>=1?"mx_Username_color_pl1":"mx_Username_color_pl0"}return"mx_Username_color_accent"}function u(e,t){const n=void 0===t?0:Math.max(e.length-t,0);if(0===e.length)return"";if(1===e.length)return e[0];{let s,r;return n>0?e=e.slice(0,t):s=e.pop(),r=e.every((e=>"string"==typeof e))?e.join(", "):Object(o.a)(e,", "),n>0?Object(i.a)("%(items)s and %(count)s others",{items:r,count:n}):Object(i.a)("%(items)s and %(lastItem)s",{items:r,lastItem:s})}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(134),s=n.n(i),o=n(122),r=n.n(o),a=n(127),c=n.n(a),l=n(120),d=n.n(l);const u=["element","className","onScroll","tabIndex","wrappedRef","children"];function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class p extends d.a.Component{constructor(){super(...arguments),r()(this,"containerRef",d.a.createRef())}componentDidMount(){var e,t;this.containerRef.current&&this.props.onScroll&&this.containerRef.current.addEventListener("scroll",this.props.onScroll,{passive:!0}),null===(e=(t=this.props).wrappedRef)||void 0===e||e.call(t,this.containerRef.current)}componentWillUnmount(){this.containerRef.current&&this.props.onScroll&&this.containerRef.current.removeEventListener("scroll",this.props.onScroll)}render(){const e=this.props,{element:t,className:n,onScroll:i,tabIndex:o,wrappedRef:r,children:a}=e,l=s()(e,u);return d.a.createElement(t,m(m({},l),{},{ref:this.containerRef,className:c()("mx_AutoHideScrollbar",n),tabIndex:null!=o?o:-1}),a)}}r()(p,"defaultProps",{element:"div"})},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a),l=n(121),d=n(136),u=n(146);class h extends r.a.Component{constructor(){super(...arguments),s()(this,"onFinished",(()=>{this.props.onFinished()}))}render(){return r.a.createElement(d.a,{className:"mx_InfoDialog",onFinished:this.props.onFinished,top:this.props.top,title:this.props.title,contentId:"mx_Dialog_content",hasCancel:this.props.hasCloseButton,onKeyDown:this.props.onKeyDown,fixedWidth:this.props.fixedWidth},r.a.createElement("div",{className:c()("mx_Dialog_content",this.props.className),id:"mx_Dialog_content"},this.props.description),!1!==this.props.button&&r.a.createElement(u.a,{primaryButton:this.props.button||Object(l.a)("OK"),onPrimaryButtonClick:this.onFinished,hasCancel:!1}))}}s()(h,"defaultProps",{title:"",description:"",hasCloseButton:!1})},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.General="USER_GENERAL_TAB",e.Appearance="USER_APPEARANCE_TAB",e.Notifications="USER_NOTIFICATIONS_TAB",e.Preferences="USER_PREFERENCES_TAB",e.Keyboard="USER_KEYBOARD_TAB",e.Sidebar="USER_SIDEBAR_TAB",e.Voice="USER_VOICE_TAB",e.Security="USER_SECURITY_TAB",e.Labs="USER_LABS_TAB",e.Mjolnir="USER_MJOLNIR_TAB",e.Help="USER_HELP_TAB",e.SessionManager="USER_SESSION_MANAGER_TAB"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return C})),n.d(t,"a",(function(){return O}));var i=n(122),s=n.n(i),o=n(149),r=n(203),a=n(125),c=n(192),l=n(205),d=n(147),u=n(268);class h extends u.a{constructor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0;super(),this.byTileCount=e,this.getRoomFn=t,s()(this,"rooms",[]),s()(this,"states",{}),s()(this,"onRoomNotificationStateUpdate",(()=>{this.calculateTotalState()}))}get symbol(){return this._color===l.a.Unsent?"!":null}setRooms(e){if(this.byTileCount)return this.rooms=e,void this.calculateTotalState();const t=this.rooms,n=Object(d.a)(t,e);this.rooms=[...e];for(const e of n.removed){const t=this.states[e.roomId];t&&(delete this.states[e.roomId],t.off(u.b.Update,this.onRoomNotificationStateUpdate))}for(const e of n.added){const t=this.getRoomFn(e);t.on(u.b.Update,this.onRoomNotificationStateUpdate),this.states[e.roomId]=t}this.calculateTotalState()}getForRoom(e){const t=this.states[e.roomId];if(!t)throw new Error("Unknown room for notification state");return t}destroy(){super.destroy();for(const e of Object.values(this.states))e.off(u.b.Update,this.onRoomNotificationStateUpdate);this.states={}}calculateTotalState(){const e=this.snapshot();if(this.byTileCount)this._color=l.a.Red,this._count=this.rooms.length;else{this._count=0,this._color=l.a.None;for(const e of Object.values(this.states))this._count+=e.count,this._color=Math.max(this.color,e.color)}this.emitIfUpdated(e)}}var m=n(144),p=n(141),g=n(123),v=n(742),f=n(269),b=n(234),y=n(126);class S extends u.a{constructor(e){super(),this.room=e,s()(this,"featureMarkedUnreadWatcherRef",null),s()(this,"handleLocalEchoUpdated",(()=>{this.updateNotificationState()})),s()(this,"handleReadReceipt",((e,t)=>{Object(v.a)(e,g.a.get())&&t.roomId===this.room.roomId&&this.updateNotificationState()})),s()(this,"handleMembershipUpdate",(()=>{this.updateNotificationState()})),s()(this,"handleNotificationCountUpdate",(()=>{this.updateNotificationState()})),s()(this,"onEventDecrypted",(e=>{e.getRoomId()===this.room.roomId&&this.updateNotificationState()})),s()(this,"handleRoomEventUpdate",(e=>{(null==e?void 0:e.getRoomId())===this.room.roomId&&this.updateNotificationState()})),s()(this,"handleAccountDataUpdate",(e=>{"m.push_rules"===e.getType()&&this.updateNotificationState()})),s()(this,"handleRoomAccountDataUpdate",(e=>{e.getType()===b.a.name&&this.updateNotificationState()}));const t=this.room.client;this.room.on(p.d.Receipt,this.handleReadReceipt),this.room.on(p.d.MyMembership,this.handleMembershipUpdate),this.room.on(p.d.LocalEchoUpdated,this.handleLocalEchoUpdated),this.room.on(p.d.AccountData,this.handleRoomAccountDataUpdate),this.room.on(p.d.Timeline,this.handleRoomEventUpdate),this.room.on(p.d.Redaction,this.handleRoomEventUpdate),this.room.on(p.d.UnreadNotifications,this.handleNotificationCountUpdate),t.on(m.c.Decrypted,this.onEventDecrypted),t.on(o.b.AccountData,this.handleAccountDataUpdate),this.updateNotificationState(),this.featureMarkedUnreadWatcherRef=y.b.watchSetting("feature_mark_unread",null,(()=>{this.updateNotificationState()}))}destroy(){super.destroy();const e=this.room.client;this.room.removeListener(p.d.Receipt,this.handleReadReceipt),this.room.removeListener(p.d.MyMembership,this.handleMembershipUpdate),this.room.removeListener(p.d.LocalEchoUpdated,this.handleLocalEchoUpdated),this.room.removeListener(p.d.AccountData,this.handleRoomAccountDataUpdate),this.room.removeListener(p.d.Timeline,this.handleRoomEventUpdate),this.room.removeListener(p.d.Redaction,this.handleRoomEventUpdate),e.removeListener(m.c.Decrypted,this.onEventDecrypted),e.removeListener(o.b.AccountData,this.handleAccountDataUpdate),y.b.unwatchSetting(this.featureMarkedUnreadWatcherRef)}updateNotificationState(){const e=this.snapshot(),{color:t,symbol:n,count:i}=f.b(this.room);this._color=t,this._symbol=n,this._count=i,this.emitIfUpdated(e)}}class E extends u.a{constructor(){super(),s()(this,"totalStatesWithUnread",0),this._symbol=null,this._count=0,this._color=l.a.None}get numUnreadStates(){return this.totalStatesWithUnread}add(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.symbol&&t&&(this._symbol=e.symbol),e.count&&(this._count+=e.count),e.color>this.color&&(this._color=e.color),e.hasUnreadCount&&this.totalStatesWithUnread++}}var w=n(693),_=n(191);const C=Symbol("update-status-indicator");class O extends r.a{constructor(){super(a.a,{}),s()(this,"roomMap",new Map),s()(this,"listMap",new Map),s()(this,"_globalState",new E),s()(this,"onSync",((e,t,n)=>{const i=new E,s=this.matrixClient.getVisibleRooms();let o=0;for(const e of s)w.a.instance.isRoomVisible(e)&&(i.add(this.getRoomState(e)),e.tags[c.a.Favourite]&&!e.getType()&&o++);_.a.instance.setProperty("numFavouriteRooms",o),this.globalState.symbol===i.symbol&&this.globalState.count===i.count&&this.globalState.color===i.color&&this.globalState.numUnreadStates===i.numUnreadStates&&e===t||(this._globalState=i,this.emit(C,i,e,t,n))}))}get globalState(){return this._globalState}getListState(e){if(this.listMap.has(e))return this.listMap.get(e);const t=e===c.a.Invite,n=new h(t,(e=>this.getRoomState(e)));return this.listMap.set(e,n),n}getRoomState(e){return this.roomMap.has(e)||this.roomMap.set(e,new S(e)),this.roomMap.get(e)}static get instance(){return O.internalInstance}async onReady(){this.matrixClient.on(o.b.Sync,this.onSync)}async onNotReady(){var e;null===(e=this.matrixClient)||void 0===e||e.off(o.b.Sync,this.onSync);for(const e of this.roomMap.values())e.destroy()}async onAction(e){}}s()(O,"internalInstance",(()=>{const e=new O;return e.start(),e})())},function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return _})),n.d(t,"d",(function(){return k})),n.d(t,"e",(function(){return x})),n.d(t,"a",(function(){return T})),n.d(t,"c",(function(){return P}));var i=n(13),s=n.n(i),o=n(224),r=n(141),a=n(16),c=n(320),l=n(180),d=n(1),u=n(291),h=n(149),m=n(196),p=n(130),g=n(152),v=n(186),f=n(362),b=n(518),y=n(423);function S(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?S(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):S(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const w=!0;let _;!function(e){e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING"}(_||(_={}));const C=["org.matrix.msc2716v3"];function O(e,t){return`FILTER_SYNC_${e}`+(t?"_"+t:"")}function I(){w&&d.a.log(...arguments)}var R;function k(e){return E({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:3e4,pendingEventOrdering:h.e.Chronological,threadSupport:!1},e)}function x(e){return E({canResetEntireTimeline:e=>!1},e)}!function(e){e.Offline="offline",e.Online="online",e.Unavailable="unavailable"}(R||(R={}));class T{constructor(e,t,n){this.client=e,s()(this,"opts",void 0),s()(this,"syncOpts",void 0),s()(this,"_peekRoom",null),s()(this,"currentSyncRequest",void 0),s()(this,"abortController",void 0),s()(this,"syncState",null),s()(this,"syncStateData",void 0),s()(this,"catchingUp",!1),s()(this,"running",!1),s()(this,"keepAliveTimer",void 0),s()(this,"connectionReturnedDefer",void 0),s()(this,"notifEvents",[]),s()(this,"failedSyncCount",0),s()(this,"storeIsInvalid",!1),s()(this,"getPushRules",(async()=>{try{I("Getting push rules...");const e=await this.client.getPushRules();I("Got push rules"),this.client.pushRules=e}catch(e){if(d.a.error("Getting push rules failed",e),this.shouldAbortSync(e))return;return I("Waiting for saved sync before retrying push rules..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,e),this.getPushRules()}})),s()(this,"buildDefaultFilter",(()=>{const e=new c.a(this.client.credentials.userId);return this.client.canSupport.get(y.a.ThreadUnreadNotifications)!==y.b.Unsupported&&e.setUnreadThreadNotifications(!0),e})),s()(this,"checkLazyLoadStatus",(async()=>{if(I("Checking lazy load status..."),this.opts.lazyLoadMembers&&this.client.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers){I("Checking server lazy load support...");await this.client.doesServerSupportLazyLoading()?(I("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=this.buildDefaultFilter()),this.opts.filter.setLazyLoadMembers(!0)):(I("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)}I("Checking whether lazy loading has changed in store...");if(await this.wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this.storeIsInvalid=!0;const e=new u.c(u.d.ToggledLazyLoading,!!this.opts.lazyLoadMembers);return this.updateSyncState(_.Error,{error:e}),void d.a.warn("InvalidStoreError: store is not usable: stopping sync.")}var e;this.opts.lazyLoadMembers&&(null===(e=this.syncOpts.crypto)||void 0===e||e.enableLazyLoading());try{I("Storing client options..."),await this.client.storeClientOptions(),I("Stored client options")}catch(e){throw d.a.error("Storing client options failed",e),e}})),s()(this,"getFilter",(async()=>{let e,t;I("Getting filter..."),e=this.opts.filter?this.opts.filter:this.buildDefaultFilter();try{t=await this.client.getOrCreateFilter(O(this.client.credentials.userId),e)}catch(e){return d.a.error("Getting filter failed",e),this.shouldAbortSync(e)?{}:(I("Waiting for saved sync before retrying filter..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,e),this.getFilter())}return{filter:e,filterId:t}})),s()(this,"savedSyncPromise",void 0),s()(this,"onOnline",(()=>{I("Browser thinks we are back online"),this.startKeepAlives(0)})),this.opts=k(t),this.syncOpts=x(n),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[r.d.Timeline,r.d.TimelineReset])}createRoom(e){const t=P(this.client,e,this.opts);return t.on(g.b.Marker,((e,n)=>{this.onMarkerStateEvent(t,e,n)})),t}onMarkerStateEvent(e,t){let{timelineWasEmpty:n}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(n)return void d.a.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because the timeline was empty before the marker arrived which means there is nothing to refresh.`);C.includes(e.getVersion())||t.getSender()===e.getCreator()?(d.a.debug(`MarkerState: Timeline needs to be refreshed because a new markerEventId=${t.getId()} was sent in roomId=${e.roomId}`),e.setTimelineNeedsRefresh(!0),e.emit(r.d.HistoryImportedWithinTimeline,t,e)):d.a.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.`)}async syncLeftRooms(){var e;const t=this.client,n=new c.a(this.client.credentials.userId);n.setTimelineLimit(1),n.setIncludeLeaveRooms(!0);const i=this.opts.pollTimeout+8e4,s={timeout:0,filter:await t.getOrCreateFilter(O(t.credentials.userId,"LEFT_ROOMS"),n)},o=await t.http.authedRequest(m.i.Get,"/sync",s,void 0,{localTimeoutMs:i});let r=[];null!==(e=o.rooms)&&void 0!==e&&e.leave&&(r=this.mapSyncResponseToRoomArray(o.rooms.leave));return(await Promise.all(r.map((async e=>{const n=e.room;if(!e.isBrandNewRoom)return;e.timeline=e.timeline||{prev_batch:null,events:[]};const i=this.mapSyncEventsFormat(e.timeline,n),s=this.mapSyncEventsFormat(e.state,n);return n.getLiveTimeline().setPaginationToken(e.timeline.prev_batch,l.b.BACKWARDS),await this.injectRoomEvents(n,s,i),n.recalculate(),t.store.storeRoom(n),t.emit(h.b.Room,n),this.processEventsForNotifs(n,i),n})))).filter(Boolean)}peek(e){var t;if((null===(t=this._peekRoom)||void 0===t?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);const n=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then((e=>{e.messages=e.messages||{chunk:[]},e.messages.chunk=e.messages.chunk||[],e.state=e.state||[];const t=a.k(e.state).map(n.getEventMapper()),i=e.state.map(n.getEventMapper()),s=e.messages.chunk.map(n.getEventMapper());return Array.isArray(e.presence)&&e.presence.map(n.getEventMapper()).forEach((function(e){let t=n.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=j(n,e.getContent().user_id),t.setPresenceEvent(e),n.store.storeUser(t)),n.emit(h.b.Event,e)})),e.messages.start&&(this._peekRoom.oldState.paginationToken=e.messages.start),this._peekRoom.oldState.setStateEvents(t),this._peekRoom.currentState.setStateEvents(i),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(s.reverse(),!0,this._peekRoom.getLiveTimeline(),e.messages.start),n.store.storeRoom(this._peekRoom),n.emit(h.b.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom}))}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var n;this._peekRoom===e?this.client.http.authedRequest(m.i.Get,"/events",{room_id:e.roomId,timeout:String(3e4),from:t},void 0,{localTimeoutMs:5e4,abortSignal:null===(n=this.abortController)||void 0===n?void 0:n.signal}).then((t=>{if(this._peekRoom!==e)return void I("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(this.client.getEventMapper()).forEach((e=>{let t=this.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=j(this.client,e.getContent().user_id),t.setPresenceEvent(e),this.client.store.storeUser(t)),this.client.emit(h.b.Event,e)}));const n=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(this.client.getEventMapper());e.addLiveEvents(n),this.peekPoll(e,t.end)}),(n=>{d.a.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout((()=>{this.peekPoll(e,t)}),3e4)})):I("Stopped peeking in room %s",e.roomId)}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}async recoverFromSyncStartupError(e,t){await e;const n=this.startKeepAlives();this.updateSyncState(_.Error,{error:t}),await n}async wasLazyLoadingToggled(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=!1;if(!await this.client.store.isNewlyCreated()){const n=await this.client.store.getClientOptions();return n&&(t=!!n.lazyLoadMembers),t!==e}return!1}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(d.a.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(_.Error,{error:e}),!0)}async sync(){var t,n;if(this.running=!0,this.abortController=new AbortController,null===(t=e.window)||void 0===t||null===(n=t.addEventListener)||void 0===n||n.call(t,"online",this.onOnline,!1),this.client.isGuest())return this.doSync({});I("Getting saved sync token...");const i=this.client.store.getSavedSyncToken().then((e=>(I("Got saved sync token"),e)));this.savedSyncPromise=this.client.store.getSavedSync().then((e=>{if(I(`Got reply from saved sync, exists? ${!!e}`),e)return this.syncFromCache(e)})).catch((e=>{d.a.error("Getting saved sync failed",e)})),await this.getPushRules(),await this.checkLazyLoadStatus();const{filterId:s,filter:o}=await this.getFilter();if(o){if(this.client.resetNotifTimelineSet(),!this.currentSyncRequest){let e=s;const t=await i;if(t)I("Sending first sync request...");else{I("Sending initial sync request...");const t=this.buildDefaultFilter();t.setDefinition(o.getDefinition()),t.setTimelineLimit(this.opts.initialSyncLimit),e=JSON.stringify(t.getDefinition())}this.currentSyncRequest=this.doSyncRequest({filter:e},t)}return I("Waiting for saved sync before starting sync processing..."),await this.savedSyncPromise,this.doSync({filter:s})}}stop(){var t,n,i;I("SyncApi.stop"),null===(t=e.window)||void 0===t||null===(n=t.removeEventListener)||void 0===n||n.call(t,"online",this.onOnline,!1),this.running=!1,null===(i=this.abortController)||void 0===i||i.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return!!this.connectionReturnedDefer&&(this.startKeepAlives(0),!0)}async syncFromCache(e){I("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const n={nextSyncToken:t,catchingUp:!1,fromCache:!0},i={next_batch:t,rooms:e.roomsData,account_data:{events:e.accountData}};try{await this.processSyncResponse(n,i)}catch(e){d.a.error("Error processing cached sync",e)}this.storeIsInvalid||this.updateSyncState(_.Prepared,n)}async doSync(e){for(;this.running;){const t=this.client.store.getSyncToken();let n;try{this.currentSyncRequest||(this.currentSyncRequest=this.doSyncRequest(e,t)),n=await this.currentSyncRequest}catch(e){if(await this.onSyncError(e))return;continue}finally{this.currentSyncRequest=void 0}this.client.store.setSyncToken(n.next_batch),this.failedSyncCount=0,await this.client.store.setSyncData(n);const i={oldSyncToken:null!=t?t:void 0,nextSyncToken:n.next_batch,catchingUp:this.catchingUp};this.syncOpts.crypto&&await this.syncOpts.crypto.onSyncWillProcess(i);try{await this.processSyncResponse(i,n)}catch(e){d.a.error("Caught /sync error",e),this.client.emit(h.b.SyncUnexpectedError,e)}i.catchingUp=this.catchingUp,e.hasSyncedBefore||(this.updateSyncState(_.Prepared,i),e.hasSyncedBefore=!0),this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onSyncCompleted(i),this.updateSyncState(_.Syncing,i),this.client.store.wantsSave()&&(this.syncOpts.crypto&&await this.syncOpts.crypto.saveDeviceList(0),this.client.store.save())}this.running||(I("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(_.Stopped))}doSyncRequest(e,t){var n;const i=this.getSyncParams(e,t);return this.client.http.authedRequest(m.i.Get,"/sync",i,void 0,{localTimeoutMs:i.timeout+8e4,abortSignal:null===(n=this.abortController)||void 0===n?void 0:n.signal})}getSyncParams(e,t){let n=this.opts.pollTimeout;(this.getSyncState()!==_.Syncing||this.catchingUp)&&(this.catchingUp=!0,n=0);let i=e.filter;this.client.isGuest()&&!i&&(i=this.getGuestFilter());const s={filter:i,timeout:n};return this.opts.disablePresence&&(s.set_presence=R.Offline),t?s.since=t:s._cacheBuster=Date.now(),[_.Reconnecting,_.Error].includes(this.getSyncState())&&(s.timeout=0),s}async onSyncError(e){if(!this.running)return I("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(_.Stopped),!0;if(d.a.error("/sync error %s",e),this.shouldAbortSync(e))return!0;this.failedSyncCount++,d.a.log("Number of consecutive failed sync requests:",this.failedSyncCount),I("Starting keep-alive");const t=this.startKeepAlives();this.currentSyncRequest=void 0,this.updateSyncState(this.failedSyncCount>=3?_.Error:_.Reconnecting,{error:e});return await t&&this.getSyncState()===_.Error&&this.updateSyncState(_.Catchup,{catchingUp:!0}),!1}async processSyncResponse(e,t){var n,i;const s=this.client;if(Array.isArray(null===(n=t.presence)||void 0===n?void 0:n.events)&&t.presence.events.filter(a.A).map(s.getEventMapper()).forEach((function(e){let t=s.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=j(s,e.getSender()),t.setPresenceEvent(e),s.store.storeUser(t)),s.emit(h.b.Event,e)})),Array.isArray(null===(i=t.account_data)||void 0===i?void 0:i.events)){const e=t.account_data.events.filter(a.A).map(s.getEventMapper()),n=e.reduce(((e,t)=>(e[t.getType()]=s.store.getAccountData(t.getType()),e)),{});s.store.storeAccountDataEvents(e),e.forEach((function(e){if(e.getType()===p.b.PushRules){const t=e.getContent();s.setPushRules(t)}const t=n[e.getType()];return s.emit(h.b.AccountData,e,t),e}))}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){let e=t.to_device.events.filter(a.A);this.syncOpts.cryptoCallbacks&&(e=await this.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(e));const n=[];e.map(s.getEventMapper({toDevice:!0})).map((e=>{if("m.key.verification.cancel"===e.getType()){const t=e.getContent().transaction_id;t&&n.push(t)}return e})).forEach((function(e){const t=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=t.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){const i=t.transaction_id;n.includes(i)&&e.flagCancelled()}s.emit(h.b.ToDeviceEvent,e)}else d.a.log("Ignoring undecryptable to-device event from "+e.getSender())}))}else this.catchingUp=!1;let o=[],c=[],u=[];if(t.rooms&&(t.rooms.invite&&(o=this.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(c=this.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(u=this.mapSyncResponseToRoomArray(t.rooms.leave))),this.notifEvents=[],await a.D(o,(async e=>{var t;const n=e.room,i=this.mapSyncEventsFormat(e.invite_state,n);await this.injectRoomEvents(n,i);const o=null===(t=n.currentState.getStateEvents(p.b.RoomMember,s.getUserId()))||void 0===t?void 0:t.getSender(),r=s.crypto;if(r){const e=await r.cryptoStore.takeParkedSharedHistory(n.roomId);for(const t of e)t.senderId===o&&await r.olmDevice.addInboundGroupSession(n.roomId,t.senderKey,t.forwardingCurve25519KeyChain,t.sessionId,t.sessionKey,t.keysClaimed,!0,{sharedHistory:!0,untrusted:!0})}e.isBrandNewRoom?(n.recalculate(),s.store.storeRoom(n),s.emit(h.b.Room,n)):n.recalculate(),i.forEach((function(e){s.emit(h.b.Event,e)}))})),await a.D(c,(async t=>{var n;const i=t.room,o=this.mapSyncEventsFormat(t.state,i),a=this.mapSyncEventsFormat(t.timeline,i,!1),c=this.mapSyncEventsFormat(t.ephemeral),u=this.mapSyncEventsFormat(t.account_data),m=s.isRoomEncrypted(i.roomId);if(t.unread_notifications){var g,v;if(!m||0===t.unread_notifications.notification_count)i.setUnreadNotificationCount(r.b.Total,null!==(g=t.unread_notifications.notification_count)&&void 0!==g?g:0);if(!m||i.getUnreadNotificationCount(r.b.Highlight)<=0)i.setUnreadNotificationCount(r.b.Highlight,null!==(v=t.unread_notifications.highlight_count)&&void 0!==v?v:0)}const f=null!==(n=t[b.a.name])&&void 0!==n?n:t[b.a.altName];if(f){i.resetThreadUnreadNotificationCount(Object.keys(f));for(const[e,t]of Object.entries(f)){var y;if(!m||0===t.notification_count)i.setThreadUnreadNotificationCount(e,r.b.Total,null!==(y=t.notification_count)&&void 0!==y?y:0);const n=i.getThreadUnreadNotificationCount(e,r.b.Highlight)<=0;var S;if(!m||m&&n)i.setThreadUnreadNotificationCount(e,r.b.Highlight,null!==(S=t.highlight_count)&&void 0!==S?S:0)}}else i.resetThreadUnreadNotificationCount();if(t.timeline=t.timeline||{},t.isBrandNewRoom)null!==t.timeline.prev_batch&&i.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,l.b.BACKWARDS);else if(t.timeline.limited){let n=!0;for(let e=a.length-1;e>=0;e--){const t=a[e].getId();if(i.getTimelineForEvent(t)){I(`Already have event ${t} in limited sync - not resetting`),n=!1,a.splice(0,e);break}}var E;if(n)i.resetLiveTimeline(t.timeline.prev_batch,this.syncOpts.canResetEntireTimeline(i.roomId)?null:null!==(E=e.oldSyncToken)&&void 0!==E?E:null),s.resetNotifTimelineSet()}if(this.syncOpts.cryptoCallbacks)for(const e of o.concat(a))e.isState()&&e.getType()===p.b.RoomEncryption&&""===e.getStateKey()&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(i,e);try{await this.injectRoomEvents(i,o,a,e.fromCache)}catch(e){d.a.error(`Failed to process events on room ${i.roomId}:`,e)}t.summary&&i.setSummary(t.summary),i.addEphemeralEvents(c),i.addAccountData(u),i.recalculate(),t.isBrandNewRoom&&(s.store.storeRoom(i),s.emit(h.b.Room,i)),this.processEventsForNotifs(i,a);const w=e=>s.emit(h.b.Event,e);o.forEach(w),a.forEach(w),c.forEach(w),u.forEach(w),i.decryptCriticalEvents()})),await a.D(u,(async e=>{const t=e.room,n=this.mapSyncEventsFormat(e.state,t),i=this.mapSyncEventsFormat(e.timeline,t),o=this.mapSyncEventsFormat(e.account_data);await this.injectRoomEvents(t,n,i),t.addAccountData(o),t.recalculate(),e.isBrandNewRoom&&(s.store.storeRoom(t),s.emit(h.b.Room,t)),this.processEventsForNotifs(t,i),n.forEach((function(e){s.emit(h.b.Event,e)})),i.forEach((function(e){s.emit(h.b.Event,e)})),o.forEach((function(e){s.emit(h.b.Event,e)}))})),e.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((function(e){var t;null===(t=s.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e)}))),t.device_lists&&this.syncOpts.crypto&&await this.syncOpts.crypto.handleDeviceListChanges(e,t.device_lists),this.syncOpts.crypto&&t.device_one_time_keys_count){const e=t.device_one_time_keys_count.signed_curve25519||0;this.syncOpts.crypto.updateOneTimeKeyCount(e)}if(this.syncOpts.crypto&&(t.device_unused_fallback_key_types||t["org.matrix.msc2732.device_unused_fallback_key_types"])){const e=t.device_unused_fallback_key_types||t["org.matrix.msc2732.device_unused_fallback_key_types"];this.syncOpts.crypto.setNeedsNewFallback(Array.isArray(e)&&!e.includes("signed_curve25519"))}}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=a.m()),this.connectionReturnedDefer.promise}pokeKeepAlive(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const n=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(t),this.connectionReturnedDefer=void 0)};this.client.http.request(m.i.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3,abortSignal:null===(e=this.abortController)||void 0===e?void 0:e.signal}).then((()=>{n()}),(e=>{400==e.httpStatus||404==e.httpStatus?this.keepAliveTimer=setTimeout(n,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(_.Error,{error:e}))}))}mapSyncResponseToRoomArray(e){const t=this.client;return Object.keys(e).filter((e=>!Object(a.Q)(e))).map((n=>{const i=e[n];let s=t.store.getRoom(n),o=!1;return s||(s=this.createRoom(n),o=!0),i.room=s,i.isBrandNewRoom=o,i}))}mapSyncEventsFormat(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!e||!Array.isArray(e.events))return[];const i=this.client.getEventMapper({decrypt:n});return e.events.filter(a.A).map((function(e){return t&&(e.room_id=t.roomId),i(e)}))}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(n){if(n.requestedProfileInfo)return;n.requestedProfileInfo=!0;const i=t.getUser(n.userId);let s;s=i?Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):t.getProfileInfo(n.userId),s.then((function(t){const i=n.events.member;"invite"===(null==i?void 0:i.getContent().membership)&&(i.getContent().avatar_url=t.avatar_url,i.getContent().displayname=t.displayname,n.setMembershipEvent(i,e.currentState))}),(function(e){}))}))}async injectRoomEvents(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const s=e.getLiveTimeline(),o=0==s.getEvents().length;if(o){for(const e of t)this.client.getPushActionsForEvent(e);s.initialiseState(t,{timelineWasEmpty:o})}this.resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(n||[],{fromCache:i,timelineWasEmpty:o}),this.client.processBeaconEvents(e,n)}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(const e of t){var n;const t=this.client.getPushActionsForEvent(e);null!=t&&t.notify&&null!==(n=t.tweaks)&&void 0!==n&&n.highlight&&this.notifEvents.push(e)}}getGuestFilter(){return"{}"}updateSyncState(e,t){const n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(h.b.Sync,this.syncState,n,t)}}function j(e,t){const n=new o.a(t);return e.reEmitter.reEmit(n,[o.b.AvatarUrl,o.b.DisplayName,o.b.Presence,o.b.CurrentlyActive,o.b.LastPresenceTs]),n}function P(e,t,n){const{timelineSupport:i}=e,s=new r.c(t,e,e.getUserId(),{lazyLoadMembers:n.lazyLoadMembers,pendingEventOrdering:n.pendingEventOrdering,timelineSupport:i});return e.reEmitter.reEmit(s,[r.d.Name,r.d.Redaction,r.d.RedactionCancelled,r.d.Receipt,r.d.Tags,r.d.LocalEchoUpdated,r.d.AccountData,r.d.MyMembership,r.d.Timeline,r.d.TimelineReset,g.b.Events,g.b.Members,g.b.NewMember,g.b.Update,f.b.New,f.b.Update,f.b.Destroy,f.b.LivenessChange]),s.on(g.b.NewMember,((t,n,i)=>{var s;i.user=null!==(s=e.getUser(i.userId))&&void 0!==s?s:void 0,e.reEmitter.reEmit(i,[v.b.Name,v.b.Typing,v.b.PowerLevel,v.b.Membership])})),s}}).call(this,n(14))},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(301);function s(e){return"string"==typeof e?e.startsWith(i.a):e instanceof i.b}},function(e,t,n){"use strict";n.d(t,"b",(function(){return T})),n.d(t,"a",(function(){return j})),n.d(t,"d",(function(){return P})),n.d(t,"c",(function(){return D}));var i=n(122),s=n.n(i),o=n(149),r=n(130),a=n(161),c=n(1),l=n(123),d=n(128),u=n(121),h=n(125),m=n(234),p=n(447),g=n(854),v=n(179),f=n(253),b=n(206),y=n(129),S=n(145),E=n(135),w=n(309),_=n(312),C=n(246),O=n(869),I=n(126);function R(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?R(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):R(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const x={[r.b.RoomName]:50,[r.b.RoomAvatar]:50,[r.b.RoomPowerLevels]:100,[r.b.RoomHistoryVisibility]:100,[r.b.RoomCanonicalAlias]:50,[r.b.RoomTombstone]:100,[r.b.RoomServerAcl]:100,[r.b.RoomEncryption]:100};async function T(e){void 0===(e=e||{}).spinner&&(e.spinner=!0),void 0===e.guestAccess&&(e.guestAccess=!0),void 0===e.encryption&&(e.encryption=!1);const t=l.a.get();if(t.isGuest())return h.a.dispatch({action:"require_registration"}),null;const n=e.dmUserId?a.d.TrustedPrivateChat:a.d.PrivateChat,i=e.createOpts||{};if(i.preset=i.preset||n,i.visibility=i.visibility||a.f.Private,e.dmUserId&&void 0===i.invite)switch(Object(p.b)(e.dmUserId)){case"mx-user-id":i.invite=[e.dmUserId];break;case"email":i.invite_3pid=[{id_server:l.a.get().getIdentityServerUrl(!0),medium:"email",address:e.dmUserId}]}if(e.dmUserId&&void 0===i.is_direct&&(i.is_direct=!0),e.roomType?(i.creation_content=k(k({},i.creation_content),{},{[r.i]:e.roomType}),e.roomType===r.j.ElementVideo?i.power_level_content_override={events:k(k({},x),{},{[b.e.MEMBER_EVENT_TYPE]:0,"im.vector.modular.widgets":200}),users:{[t.getUserId()]:200}}:e.roomType===r.j.UnstableCall&&(i.power_level_content_override={events:k(k({},x),{},{[b.d.MEMBER_EVENT_TYPE.name]:0,[b.d.CALL_EVENT_TYPE.name]:200}),users:{[t.getUserId()]:200}})):I.b.getValue("feature_group_calls")&&(i.power_level_content_override={events:k(k({},x),{},{[b.d.MEMBER_EVENT_TYPE.name]:100,[b.d.CALL_EVENT_TYPE.name]:100})}),void 0===e.andView&&(e.andView=!0),i.initial_state=i.initial_state||[],e.guestAccess&&i.initial_state.push({type:"m.room.guest_access",state_key:"",content:{guest_access:"can_join"}}),e.encryption&&i.initial_state.push({type:"m.room.encryption",state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}),e.parentSpace&&(i.initial_state.push(Object(f.b)(e.parentSpace,!0)),e.historyVisibility||(e.historyVisibility=i.preset===a.d.PublicChat?a.b.WorldReadable:a.b.Invited),e.joinRule===a.c.Restricted&&(i.room_version=O.a.RestrictedRooms,i.initial_state.push({type:r.b.RoomJoinRules,content:{join_rule:a.c.Restricted,allow:[{type:a.e.RoomMembership,room_id:e.parentSpace.roomId}]}}))),e.joinRule&&e.joinRule!==a.c.Restricted&&i.initial_state.push({type:r.b.RoomJoinRules,content:{join_rule:e.joinRule}}),e.avatar){let n=e.avatar;e.avatar instanceof File&&({content_uri:n}=await t.uploadContent(e.avatar)),i.initial_state.push({type:r.b.RoomAvatar,content:{url:n}})}let s,g,w;return e.historyVisibility&&i.initial_state.push({type:r.b.RoomHistoryVisibility,content:{history_visibility:e.historyVisibility}}),e.spinner&&(s=d.b.createDialog(E.a,void 0,"mx_Dialog_spinner")),t.createRoom(i).catch((function(e){return 403===e.httpStatus&&"M_UNKNOWN"===e.errcode&&"Not allowed to publish room"===e.data.error?(c.a.warn("Failed to publish room, try again without publishing it"),i.visibility=a.f.Private,t.createRoom(i)):Promise.reject(e)})).finally((function(){s&&s.close()})).then((async n=>{g=n.room_id,w=new Promise((e=>{const n=t.getRoom(g);if(n)e(n);else{const n=i=>{i.roomId===g&&(e(i),t.off(o.b.Room,n))};t.on(o.b.Room,n)}})),e.dmUserId&&await m.f(g,e.dmUserId)})).then((()=>{if(e.parentSpace)return v.a.instance.addRoomToSpace(e.parentSpace,g,[t.getDomain()],e.suggested)})).then((async()=>{if(e.roomType===r.j.ElementVideo){await b.e.create(await w);const e=(await w).currentState.getStateEvents(r.b.RoomPowerLevels,"");await t.setPowerLevel(g,t.getUserId(),100,e)}else if(e.roomType===r.j.UnstableCall){await b.d.create(await w);const e=(await w).currentState.getStateEvents(r.b.RoomPowerLevels,"");await t.setPowerLevel(g,t.getUserId(),100,e)}})).then((function(){return e.andView&&h.a.dispatch({action:y.a.ViewRoom,room_id:g,should_peek:!1,joining:!0,justCreatedOpts:e,metricsTrigger:"Created"}),g}),(function(t){if(e.inlineErrors)throw t;h.a.dispatch({action:y.a.JoinRoomError,roomId:g}),c.a.error("Failed to create room "+g+" "+t);let n=Object(u.a)("Server may be unavailable, overloaded, or you hit a bug.");return"M_UNSUPPORTED_ROOM_VERSION"===t.errcode&&(n=Object(u.a)("The server does not support the room version specified.")),d.b.createDialog(S.a,{title:Object(u.a)("Failure to create room"),description:n}),null}))}async function j(e,t){try{const n=await e.downloadKeys(t);return Object.values(n).every((e=>Object.keys(e).length>0))}catch(e){return c.a.error("Error determining if it's possible to encrypt to all users: ",e),!1}}async function P(e,t,n){const i=Object(w.a)(e,t);let s;return s=i?i.roomId:await T({dmUserId:t,spinner:!1,andView:!1,createOpts:{creation_content:{[g.a]:n}}}),s}async function D(e,t){const n=Object(w.a)(e,t);let i;if(n)i=n.roomId;else{let n;Object(_.a)()&&(n=await j(e,[t])),i=await T({encryption:n,dmUserId:t,spinner:!1,andView:!1}),await Object(C.e)(e,i,t)}return i}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(126),c=n(121),l=n(402),d=n(181);class u extends r.a.Component{constructor(e){super(e),s()(this,"onChange",(async e=>{await this.save(e),this.setState({value:e}),this.props.onChange&&this.props.onChange(e)})),s()(this,"checkBoxOnChange",(e=>{this.onChange(e.target.checked)})),s()(this,"save",(async e=>{await a.b.setValue(this.props.name,this.props.roomId,this.props.level,void 0!==e?e:this.state.value)})),this.state={value:a.b.getValueAt(this.props.level,this.props.name,this.props.roomId,this.props.isExplicit)}}render(){var e;const t=a.b.canSetValue(this.props.name,this.props.roomId,this.props.level);if(!t&&this.props.hideIfCannotSet)return null;const n=null!==(e=this.props.label?Object(c.a)(this.props.label):a.b.getDisplayName(this.props.name,this.props.level))&&void 0!==e?e:void 0,i=a.b.getDescription(this.props.name),s=a.b.shouldHaveWarning(this.props.name);let o=null;return this.props.disabled&&this.props.disabledDescription&&(o=r.a.createElement("div",{className:"mx_SettingsFlag_microcopy"},this.props.disabledDescription)),this.props.useCheckbox?r.a.createElement(d.b,{checked:this.state.value,onChange:this.checkBoxOnChange,disabled:this.props.disabled||!t},n):r.a.createElement("div",{className:"mx_SettingsFlag"},r.a.createElement("label",{className:"mx_SettingsFlag_label"},r.a.createElement("span",{className:"mx_SettingsFlag_labelText"},n),i&&r.a.createElement("div",{className:"mx_SettingsFlag_microcopy"},s?Object(c.a)("<w>WARNING:</w> <description/>",{},{w:e=>r.a.createElement("span",{className:"mx_SettingsTab_microcopy_warning"},e),description:i}):i),o),r.a.createElement(l.a,{checked:this.state.value,onChange:this.onChange,disabled:this.props.disabled||!t,title:n}))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const i={};function s(e){var t,n;return null===(t=null===(n=i.shouldShowComponent)||void 0===n?void 0:n.call(i,e))||void 0===t||t}},function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var i=n(13),s=n.n(i),o=n(159);let r;!function(e){e.DisplayName="User.displayName",e.AvatarUrl="User.avatarUrl",e.Presence="User.presence",e.CurrentlyActive="User.currentlyActive",e.LastPresenceTs="User.lastPresenceTs"}(r||(r={}));class a extends o.b{constructor(e){super(),this.userId=e,s()(this,"modified",-1),s()(this,"displayName",void 0),s()(this,"rawDisplayName",void 0),s()(this,"avatarUrl",void 0),s()(this,"presenceStatusMsg",void 0),s()(this,"presence","offline"),s()(this,"lastActiveAgo",0),s()(this,"lastPresenceTs",0),s()(this,"currentlyActive",!1),s()(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}setPresenceEvent(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const n=[];(e.getContent().presence!==this.presence||t)&&n.push(r.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push(r.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push(r.DisplayName),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&n.push(r.CurrentlyActive),this.presence=e.getContent().presence,n.push(r.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(const t of n)this.emit(t,e,this)}setDisplayName(e){const t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return c}));const i="abcdefghijklmnopqrstuvwxyz",s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",o="0123456789";function r(e){return l(e,s+i+o)}function a(e){return l(e,i)}function c(e){return l(e,s)}function l(e,t){let n="";for(let i=0;i<e;++i)n+=t.charAt(Math.floor(Math.random()*t.length));return n}},function(e,t,n){"use strict";n.d(t,"d",(function(){return b})),n.d(t,"f",(function(){return y})),n.d(t,"c",(function(){return E})),n.d(t,"b",(function(){return w})),n.d(t,"g",(function(){return O})),n.d(t,"e",(function(){return _})),n.d(t,"a",(function(){return x}));var i=n(13),s=n.n(i),o=n(159),r=n(509),a=n(190),c=n(152),l=n(1),d=n(290),u=n(364),h=n(130),m=n(521),p=n(522),g=n(16);function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let b,y,S,E,w,_;!function(e){e.Ring="m.ring",e.Prompt="m.prompt",e.Room="m.room"}(b||(b={})),function(e){e.Video="m.video",e.Voice="m.voice"}(y||(y={})),function(e){e.CallEnded="call_ended"}(S||(S={})),function(e){e.GroupCallStateChanged="group_call_state_changed",e.ActiveSpeakerChanged="active_speaker_changed",e.CallsChanged="calls_changed",e.UserMediaFeedsChanged="user_media_feeds_changed",e.ScreenshareFeedsChanged="screenshare_feeds_changed",e.LocalScreenshareStateChanged="local_screenshare_state_changed",e.LocalMuteStateChanged="local_mute_state_changed",e.ParticipantsChanged="participants_changed",e.Error="error"}(E||(E={})),function(e){e.NoUserMedia="no_user_media",e.UnknownDevice="unknown_device",e.PlaceCallFailed="place_call_failed"}(w||(w={}));class C extends Error{constructor(e,t,n){n?(super(t+": "+n),s()(this,"code",void 0)):(super(t),s()(this,"code",void 0)),this.code=e}}class O extends C{constructor(e){super(w.UnknownDevice,"No device found for "+e),this.userId=e}}class I extends Error{constructor(){super("Cannot unmute: another user is speaking")}}!function(e){e.LocalCallFeedUninitialized="local_call_feed_uninitialized",e.InitializingLocalCallFeed="initializing_local_call_feed",e.LocalCallFeedInitialized="local_call_feed_initialized",e.Entered="entered",e.Ended="ended"}(_||(_={}));const R=36e5;function k(e){var t;return(null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId)||e.invitee||null}class x extends o.b{constructor(e,t,n,i,o,u,m,p,g){var v,f;super(),this.client=e,this.room=t,this.type=n,this.isPtt=i,this.intent=o,this.dataChannelsEnabled=m,this.dataChannelOptions=p,s()(this,"activeSpeakerInterval",1e3),s()(this,"retryCallInterval",5e3),s()(this,"participantTimeout",15e3),s()(this,"pttMaxTransmitTime",2e4),s()(this,"activeSpeaker",void 0),s()(this,"localCallFeed",void 0),s()(this,"localScreenshareFeed",void 0),s()(this,"localDesktopCapturerSourceId",void 0),s()(this,"userMediaFeeds",[]),s()(this,"screenshareFeeds",[]),s()(this,"groupCallId",void 0),s()(this,"allowCallWithoutVideoAndAudio",void 0),s()(this,"calls",new Map),s()(this,"callHandlers",new Map),s()(this,"activeSpeakerLoopInterval",void 0),s()(this,"retryCallLoopInterval",void 0),s()(this,"retryCallCounts",new Map),s()(this,"reEmitter",void 0),s()(this,"transmitTimer",null),s()(this,"participantsExpirationTimer",null),s()(this,"resendMemberStateTimer",null),s()(this,"initWithAudioMuted",!1),s()(this,"initWithVideoMuted",!1),s()(this,"initCallFeedPromise",void 0),s()(this,"_state",_.LocalCallFeedUninitialized),s()(this,"_participants",new Map),s()(this,"_creationTs",null),s()(this,"_enteredViaAnotherSession",!1),s()(this,"onIncomingCall",(e=>{var t,n;if(e.roomId!==this.room.roomId)return;if(e.state!==a.f.Ringing)return void l.a.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call no longer in ringing state - ignoring`);if(!e.groupCallId||e.groupCallId!==this.groupCallId)return l.a.log(`GroupCall ${this.groupCallId} onIncomingCall() ignored because it doesn't match the current group call`),void e.reject();const i=null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId;if(void 0===i)return void l.a.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call with no member - ignoring`);const s=null!==(n=this.calls.get(i))&&void 0!==n?n:new Map,o=s.get(e.getOpponentDeviceId());(null==o?void 0:o.callId)!==e.callId&&(l.a.log(`GroupCall ${this.groupCallId} onIncomingCall() incoming call (userId=${i}, callId=${e.callId})`),o&&this.disposeCall(o,a.c.Replaced),this.initCall(e),e.answerWithCallFeeds(this.getLocalFeeds().map((e=>e.clone()))),s.set(e.getOpponentDeviceId(),e),this.calls.set(i,s),this.emit(E.CallsChanged,this.calls))})),s()(this,"onRetryCallLoop",(()=>{let e=!1;for(const[{userId:i},s]of this.participants){const o=this.calls.get(i);let r=this.retryCallCounts.get(i);for(const[a,c]of s){var t,n;const s=null==o?void 0:o.get(a),l=null!==(t=null===(n=r)||void 0===n?void 0:n.get(a))&&void 0!==t?t:0;(null==s?void 0:s.getOpponentSessionId())!==c.sessionId&&this.wantsOutgoingCall(i,a)&&l<3&&(void 0===r&&(r=new Map,this.retryCallCounts.set(i,r)),r.set(a,l+1),e=!0)}}e&&this.placeOutgoingCalls()})),s()(this,"onCallFeedsChanged",(e=>{const t=k(e),n=e.getOpponentDeviceId();if(!t)throw new Error("Cannot change call feeds without user id");const i=this.getUserMediaFeed(t,n),s=e.remoteUsermediaFeed;s!==i&&(!i&&s?this.addUserMediaFeed(s):i&&s?this.replaceUserMediaFeed(i,s):i&&!s&&this.removeUserMediaFeed(i));const o=this.getScreenshareFeed(t,n),r=e.remoteScreensharingFeed;r!==o&&(!o&&r?this.addScreenshareFeed(r):o&&r?this.replaceScreenshareFeed(o,r):o&&!r&&this.removeScreenshareFeed(o))})),s()(this,"onCallStateChanged",((e,t,n)=>{var i;const s=this.localCallFeed.isAudioMuted();e.localUsermediaStream&&e.isMicrophoneMuted()!==s&&e.setMicrophoneMuted(s);const o=this.localCallFeed.isVideoMuted();e.localUsermediaStream&&e.isLocalVideoMuted()!==o&&e.setLocalVideoMuted(o);const r=null===(i=e.getOpponentMember())||void 0===i?void 0:i.userId;if(t===a.f.Connected&&r){const t=this.retryCallCounts.get(r);null==t||t.delete(e.getOpponentDeviceId()),0===(null==t?void 0:t.size)&&this.retryCallCounts.delete(r)}})),s()(this,"onCallHangup",(e=>{var t,n;if(e.hangupReason===a.c.Replaced)return;const i=null!==(t=null===(n=e.getOpponentMember())||void 0===n?void 0:n.userId)&&void 0!==t?t:this.room.getMember(e.invitee).userId,s=this.calls.get(i);(null==s?void 0:s.get(e.getOpponentDeviceId()))===e&&(this.disposeCall(e,e.hangupReason),s.delete(e.getOpponentDeviceId()),0===s.size&&this.calls.delete(i),this.emit(E.CallsChanged,this.calls))})),s()(this,"onCallReplaced",((e,t)=>{const n=e.getOpponentMember().userId;let i=this.calls.get(n);void 0===i&&(i=new Map,this.calls.set(n,i)),this.disposeCall(e,a.c.Replaced),this.initCall(t),i.set(e.getOpponentDeviceId(),t),this.emit(E.CallsChanged,this.calls)})),s()(this,"onActiveSpeakerLoop",(()=>{let e,t;for(const n of this.userMediaFeeds){if(n.isLocal()&&this.userMediaFeeds.length>1)continue;const i=n.speakingVolumeSamples.reduce(((e,t)=>e+Math.max(t,r.c)))/n.speakingVolumeSamples.length;(!e||i>e)&&(e=i,t=n)}t&&this.activeSpeaker!==t&&e&&e>r.c&&(this.activeSpeaker=t,this.emit(E.ActiveSpeakerChanged,this.activeSpeaker))})),s()(this,"onRoomState",(()=>this.updateParticipants())),s()(this,"onParticipantsChanged",(()=>{this.state===_.Entered&&this.placeOutgoingCalls()})),s()(this,"onStateChanged",((e,t)=>{e!==_.Entered&&t!==_.Entered&&e!==_.Ended||(this.updateParticipants(),this.updateMemberState().catch((e=>l.a.error(`GroupCall ${this.groupCallId} onStateChanged() failed to update member state devices"`,e))))})),s()(this,"onLocalFeedsChanged",(()=>{this.state===_.Entered&&this.updateMemberState().catch((e=>l.a.error(`GroupCall ${this.groupCallId} onLocalFeedsChanged() failed to update member state feeds`,e)))})),this.reEmitter=new d.a(this),this.groupCallId=null!=u?u:Object(a.i)(),this.creationTs=null!==(v=null===(f=t.currentState.getStateEvents(h.b.GroupCallPrefix,this.groupCallId))||void 0===f?void 0:f.getTs())&&void 0!==v?v:null,this.updateParticipants(),t.on(c.b.Update,this.onRoomState),this.on(E.ParticipantsChanged,this.onParticipantsChanged),this.on(E.GroupCallStateChanged,this.onStateChanged),this.on(E.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!g}async create(){this.creationTs=Date.now(),this.client.groupCallEventHandler.groupCalls.set(this.room.roomId,this),this.client.emit(p.b.Outgoing,this);const e={"m.intent":this.intent,"m.type":this.type,"io.element.ptt":this.isPtt,dataChannelsEnabled:this.dataChannelsEnabled,dataChannelOptions:this.dataChannelsEnabled?this.dataChannelOptions:void 0};return await this.client.sendStateEvent(this.room.roomId,h.b.GroupCallPrefix,e,this.groupCallId),this}get state(){return this._state}set state(e){const t=this._state;e!==t&&(this._state=e,this.emit(E.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){const t=this._participants,n=(e,t)=>e.sessionId===t.sessionId&&e.screensharing===t.screensharing;Object(g.y)(e,t,((e,t)=>Object(g.y)(e,t,n)))||(this._participants=e,this.emit(E.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(const t of this.calls.values())for(const n of t.values())e(n)}getLocalFeeds(){const e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return null!==(e=null===(t=this.participants.get(this.room.getMember(this.client.getUserId())))||void 0===t?void 0:t.has(this.client.getDeviceId()))&&void 0!==e&&e}async initLocalCallFeed(){if(this.state!==_.LocalCallFeedUninitialized)throw new Error(`Cannot initialize local call feed in the "${this.state}" state.`);if(this.state=_.InitializingLocalCallFeed,this.initCallFeedPromise)return this.initCallFeedPromise;try{this.initCallFeedPromise=this.initLocalCallFeedInternal(),await this.initCallFeedPromise}finally{this.initCallFeedPromise=void 0}}async initLocalCallFeedInternal(){let e;l.a.log(`GroupCall ${this.groupCallId} initLocalCallFeedInternal() running`);try{e=await this.client.getMediaHandler().getUserMediaStream(!0,this.type===y.Video)}catch(t){if(!this.allowCallWithoutVideoAndAudio)throw this.state=_.LocalCallFeedUninitialized,t;e=new MediaStream}if(this._state!==_.InitializingLocalCallFeed)throw this.client.getMediaHandler().stopUserMediaStream(e),new Error("Group call disposed while gathering media stream");const t=new r.a({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:e,purpose:u.b.Usermedia,audioMuted:this.initWithAudioMuted||0===e.getAudioTracks().length||this.isPtt,videoMuted:this.initWithVideoMuted||0===e.getVideoTracks().length});Object(a.j)(e.getAudioTracks(),!t.isAudioMuted()),Object(a.j)(e.getVideoTracks(),!t.isVideoMuted()),this.localCallFeed=t,this.addUserMediaFeed(t),this.state=_.LocalCallFeedInitialized}async updateLocalUsermediaStream(e){if(this.localCallFeed){const t=this.localCallFeed.stream;this.localCallFeed.setNewStream(e);const n=this.localCallFeed.isAudioMuted(),i=this.localCallFeed.isVideoMuted();l.a.log(`GroupCall ${this.groupCallId} updateLocalUsermediaStream() (oldStreamId=${t.id}, newStreamId=${e.id}, micShouldBeMuted=${n}, vidShouldBeMuted=${i})`),Object(a.j)(e.getAudioTracks(),!n),Object(a.j)(e.getVideoTracks(),!i),this.client.getMediaHandler().stopUserMediaStream(t)}}async enter(){if(this.state===_.LocalCallFeedUninitialized)await this.initLocalCallFeed();else if(this.state!==_.LocalCallFeedInitialized)throw new Error(`Cannot enter call in the "${this.state}" state`);l.a.log(`GroupCall ${this.groupCallId} enter() running`),this.state=_.Entered,this.client.on(m.b.Incoming,this.onIncomingCall);for(const e of this.client.callEventHandler.calls.values())this.onIncomingCall(e);this.retryCallLoopInterval=setInterval(this.onRetryCallLoop,this.retryCallInterval),this.activeSpeaker=void 0,this.onActiveSpeakerLoop(),this.activeSpeakerLoopInterval=setInterval(this.onActiveSpeakerLoop,this.activeSpeakerInterval)}dispose(){this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),null!==this.transmitTimer&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),void 0!==this.retryCallLoopInterval&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.state===_.Entered&&(this.forEachCall((e=>this.disposeCall(e,a.c.UserHangup))),this.calls.clear(),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(m.b.Incoming,this.onIncomingCall))}leave(){this.dispose(),this.state=_.LocalCallFeedUninitialized}async terminate(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.dispose(),this.room.off(c.b.Update,this.onRoomState),this.client.groupCallEventHandler.groupCalls.delete(this.room.roomId),this.client.emit(p.b.Ended,this),this.state=_.Ended,e){const e=this.room.currentState.getStateEvents(h.b.GroupCallPrefix,this.groupCallId);await this.client.sendStateEvent(this.room.roomId,h.b.GroupCallPrefix,f(f({},e.getContent()),{},{"m.terminated":S.CallEnded}),this.groupCallId)}}isLocalVideoMuted(){return!this.localCallFeed||this.localCallFeed.isVideoMuted()}isMicrophoneMuted(){return!this.localCallFeed||this.localCallFeed.isAudioMuted()}async setMicrophoneMuted(e){if(!e&&!await this.client.getMediaHandler().hasAudioDevice())return!1;const t=!e&&this.isPtt;this.isPtt&&(!e&&this.isMicrophoneMuted()?this.transmitTimer=setTimeout((()=>{this.setMicrophoneMuted(!0)}),this.pttMaxTransmitTime):e&&!this.isMicrophoneMuted()&&(null!==this.transmitTimer&&clearTimeout(this.transmitTimer),this.transmitTimer=null)),this.forEachCall((t=>{var n;return null===(n=t.localUsermediaFeed)||void 0===n?void 0:n.setAudioVideoMuted(e,null)}));const n=async()=>{const e=[];this.forEachCall((t=>e.push(t.sendMetadataUpdate()))),await Promise.all(e).catch((e=>l.a.info(`GroupCall ${this.groupCallId} setMicrophoneMuted() failed to send some metadata updates`,e)))};if(t&&await n(),this.localCallFeed){l.a.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() (streamId=${this.localCallFeed.stream.id}, muted=${e})`);try{if(!e){if(null===await this.client.getMediaHandler().getUserMediaStream(!0,!this.localCallFeed.isVideoMuted()))return l.a.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device to receive local stream, muted=${e}`),!1}}catch(t){return l.a.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device or permission to receive local stream, muted=${e}`),!1}this.localCallFeed.setAudioVideoMuted(e,null),Object(a.j)(this.localCallFeed.stream.getAudioTracks(),!e)}else l.a.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no stream muted (muted=${e})`),this.initWithAudioMuted=e;return this.forEachCall((t=>Object(a.j)(t.localUsermediaFeed.stream.getAudioTracks(),!e))),this.emit(E.LocalMuteStateChanged,e,this.isLocalVideoMuted()),t||await n(),!0}async setLocalVideoMuted(e){if(!e&&!await this.client.getMediaHandler().hasVideoDevice())return!1;if(this.localCallFeed){l.a.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() (stream=${this.localCallFeed.stream.id}, muted=${e})`);try{const t=await this.client.getMediaHandler().getUserMediaStream(!0,!e);await this.updateLocalUsermediaStream(t),this.localCallFeed.setAudioVideoMuted(null,e),Object(a.j)(this.localCallFeed.stream.getVideoTracks(),!e)}catch(t){return l.a.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no device or permission to receive local stream, muted=${e}`),!1}}else l.a.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no stream muted (muted=${e})`),this.initWithVideoMuted=e;const t=[];return this.forEachCall((n=>t.push(n.setLocalVideoMuted(e)))),await Promise.all(t),this.emit(E.LocalMuteStateChanged,this.isMicrophoneMuted(),e),!0}async setScreensharingEnabled(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e===this.isScreensharing())return e;if(!e)return this.forEachCall((e=>{e.localScreensharingFeed&&e.removeLocalFeed(e.localScreensharingFeed)})),this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0,this.emit(E.LocalScreenshareStateChanged,!1,void 0,void 0),!1;try{l.a.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() is asking for screensharing permissions`);const e=await this.client.getMediaHandler().getScreensharingStream(t);for(const t of e.getTracks()){const e=()=>{this.setScreensharingEnabled(!1),t.removeEventListener("ended",e)};t.addEventListener("ended",e)}return l.a.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls`),this.localDesktopCapturerSourceId=t.desktopCapturerSourceId,this.localScreenshareFeed=new r.a({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:e,purpose:u.b.Screenshare,audioMuted:!1,videoMuted:!1}),this.addScreenshareFeed(this.localScreenshareFeed),this.emit(E.LocalScreenshareStateChanged,!0,this.localScreenshareFeed,this.localDesktopCapturerSourceId),this.forEachCall((e=>e.pushLocalFeed(this.localScreenshareFeed.clone()))),!0}catch(e){if(t.throwOnFail)throw e;return l.a.error(`GroupCall ${this.groupCallId} setScreensharingEnabled() enabling screensharing error`,e),this.emit(E.Error,new C(w.NoUserMedia,"Failed to get screen-sharing stream: ",e)),!1}}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){const n=this.client.getUserId(),i=this.client.getDeviceId();return e>=n&&(e!==n||t>i)}placeOutgoingCalls(){let e=!1;for(const[{userId:n},i]of this.participants){var t;const s=null!==(t=this.calls.get(n))&&void 0!==t?t:new Map;for(const[t,o]of i){const i=s.get(t);if((null==i?void 0:i.getOpponentSessionId())!==o.sessionId&&this.wantsOutgoingCall(n,t)){e=!0,void 0!==i&&(l.a.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() replacing call (userId=${n}, deviceId=${t}, callId=${i.callId})`),this.disposeCall(i,a.c.NewSession));const r=Object(a.h)(this.client,this.room.roomId,{invitee:n,opponentDeviceId:t,opponentSessionId:o.sessionId,groupCallId:this.groupCallId});null===r?(l.a.error(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to create call (userId=${n}, device=${t})`),s.delete(t)):(this.initCall(r),s.set(t,r),l.a.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() placing call (userId=${n}, deviceId=${t}, sessionId=${o.sessionId})`),r.placeCallWithCallFeeds(this.getLocalFeeds().map((e=>e.clone())),o.screensharing).then((()=>{this.dataChannelsEnabled&&r.createDataChannel("datachannel",this.dataChannelOptions)})).catch((e=>{l.a.warn(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to place call (userId=${n})`,e),e instanceof a.b&&e.code===w.UnknownDevice?this.emit(E.Error,e):this.emit(E.Error,new C(w.PlaceCallFailed,`Failed to place call to ${n}`)),this.disposeCall(r,a.c.SignallingFailed),s.get(t)===r&&s.delete(t)})))}}s.size>0?this.calls.set(n,s):this.calls.delete(n)}e&&this.emit(E.CallsChanged,this.calls)}getMemberStateEvents(e){return void 0===e?this.room.currentState.getStateEvents(h.b.GroupCallMemberPrefix):this.room.currentState.getStateEvents(h.b.GroupCallMemberPrefix,e)}initCall(e){const t=k(e);if(!t)throw new Error("Cannot init call without user id");const n=()=>this.onCallFeedsChanged(e),i=(t,n)=>this.onCallStateChanged(e,t,n),s=this.onCallHangup,o=t=>this.onCallReplaced(e,t);let r=this.callHandlers.get(t);void 0===r&&(r=new Map,this.callHandlers.set(t,r)),r.set(e.getOpponentDeviceId(),{onCallFeedsChanged:n,onCallStateChanged:i,onCallHangup:s,onCallReplaced:o}),e.on(a.d.FeedsChanged,n),e.on(a.d.State,i),e.on(a.d.Hangup,s),e.on(a.d.Replaced,o),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(a.d)),n()}disposeCall(e,t){const n=k(e),i=e.getOpponentDeviceId();if(!n)throw new Error("Cannot dispose call without user id");const s=this.callHandlers.get(n),{onCallFeedsChanged:o,onCallStateChanged:r,onCallHangup:c,onCallReplaced:l}=s.get(i);if(e.removeListener(a.d.FeedsChanged,o),e.removeListener(a.d.State,r),e.removeListener(a.d.Hangup,c),e.removeListener(a.d.Replaced,l),s.delete(n),0===s.size&&this.callHandlers.delete(n),e.hangupReason===a.c.Replaced)return;e.state!==a.f.Ended&&e.hangup(t,!1);const d=this.getUserMediaFeed(n,i);d&&this.removeUserMediaFeed(d);const u=this.getScreenshareFeed(n,i);u&&this.removeScreenshareFeed(u)}getUserMediaFeed(e,t){return this.userMediaFeeds.find((n=>n.userId===e&&n.deviceId===t))}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(E.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){const n=this.userMediaFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===n)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(n,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(E.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){const t=this.userMediaFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===t)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(E.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(E.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find((n=>n.userId===e&&n.deviceId===t))}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(E.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){const n=this.screenshareFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===n)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(n,1,t),e.dispose(),this.emit(E.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){const t=this.screenshareFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===t)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(E.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){const e=this.room.getMember(this.client.getUserId());if(!e)return void l.a.warn(`GroupCall ${this.groupCallId} updateParticipants() tried to update participants before local room member is available`);if(null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===_.Ended)return void(this.participants=new Map);const t=new Map,n=Date.now(),i=this.state===_.Entered||this.enteredViaAnotherSession;let s=1/0;for(const e of this.getMemberStateEvents()){const o=this.room.getMember(e.getStateKey()),r=e.getContent(),a=(Array.isArray(r["m.calls"])?r["m.calls"]:[]).find((e=>e["m.call_id"]===this.groupCallId));let c=(Array.isArray(null==a?void 0:a["m.devices"])?a["m.devices"]:[]).filter((e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>n&&Array.isArray(e.feeds)));if(i||(null==o?void 0:o.userId)!==this.client.getUserId()||(c=c.filter((e=>e.device_id!==this.client.getDeviceId()))),c.length>0&&"join"===(null==o?void 0:o.membership)){const e=new Map;t.set(o,e);for(const t of c)e.set(t.device_id,{sessionId:t.session_id,screensharing:t.feeds.some((e=>e.purpose===u.b.Screenshare))}),t.expires_ts<s&&(s=t.expires_ts)}}if(i){let n=t.get(e);void 0===n&&(n=new Map,t.set(e,n)),n.has(this.client.getDeviceId())||n.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some((e=>e.purpose===u.b.Screenshare))})}this.participants=t,s<1/0&&(this.participantsExpirationTimer=setTimeout((()=>this.updateParticipants()),s-n))}async updateDevices(e){var t;let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=Date.now(),s=this.client.getUserId(),o=this.getMemberStateEvents(s),r=null!==(t=null==o?void 0:o.getContent())&&void 0!==t?t:{},a=Array.isArray(r["m.calls"])?r["m.calls"]:[];let c=null;const l=[];for(const e of a)e["m.call_id"]===this.groupCallId?c=e:l.push(e);null===c&&(c={});const d=e((Array.isArray(c["m.devices"])?c["m.devices"]:[]).filter((e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>i&&Array.isArray(e.feeds))));if(null===d)return;const u=[...l];d.length>0&&u.push(f(f({},c),{},{"m.call_id":this.groupCallId,"m.devices":d}));const m={"m.calls":u};await this.client.sendStateEvent(this.room.roomId,h.b.GroupCallMemberPrefix,m,s,{keepAlive:n})}async addDeviceToMemberState(){await this.updateDevices((e=>[...e.filter((e=>e.device_id!==this.client.getDeviceId())),{device_id:this.client.getDeviceId(),session_id:this.client.getSessionId(),expires_ts:Date.now()+R,feeds:this.getLocalFeeds().map((e=>({purpose:e.purpose})))}]))}async updateMemberState(){null!==this.resendMemberStateTimer&&(clearInterval(this.resendMemberStateTimer),this.resendMemberStateTimer=null),this.state===_.Entered?(await this.addDeviceToMemberState(),this.resendMemberStateTimer=setInterval((async()=>{l.a.log(`GroupCall ${this.groupCallId} updateMemberState() resending call member state"`);try{await this.addDeviceToMemberState()}catch(e){l.a.error(`GroupCall ${this.groupCallId} updateMemberState() failed to resend call member state`,e)}}),27e5)):await this.updateDevices((e=>e.filter((e=>e.device_id!==this.client.getDeviceId()))),!0)}async cleanMemberState(){const{devices:e}=await this.client.getDevices(),t=new Map(e.map((e=>[e.device_id,e])));await this.updateDevices((e=>{const n=e.filter((e=>{const n=t.get(e.device_id);return void 0!==(null==n?void 0:n.last_seen_ts)&&!(e.device_id===this.client.getDeviceId()&&this.state!==_.Entered&&!this.enteredViaAnotherSession)}));return n.length===e.length?null:n}))}}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return u}));var i=n(13),s=n.n(i),o=n(1),r=n(523),a=n(357),c=n(1042),l=n(291),d=n(705);class u{static exists(e,t){return d.a(e,t)}constructor(e,t){this.indexedDB=e,this.dbName=t,s()(this,"backendPromise",void 0),s()(this,"backend",void 0)}startup(){return this.backendPromise||(this.backendPromise=new Promise(((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));o.a.log(`connecting to indexeddb ${this.dbName}`);const n=this.indexedDB.open(this.dbName,c.b);n.onupgradeneeded=e=>{const t=n.result,i=e.oldVersion;c.c(t,i)},n.onblocked=()=>{o.a.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{o.a.log("Error connecting to indexeddb",e),t(n.error)},n.onsuccess=()=>{const t=n.result;o.a.log(`connected to indexeddb ${this.dbName}`),e(new c.a(t))}})).then((e=>e.doTxn("readonly",[u.STORE_INBOUND_GROUP_SESSIONS,u.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(t=>{e.getEndToEndInboundGroupSession("","",t,(()=>{}))})).then((()=>e)))).catch((t=>{if("VersionError"===t.name)throw o.a.warn("Crypto DB is too new for us to use!",t),new l.a(l.b.TooNew);o.a.warn(`unable to connect to indexeddb ${this.dbName}: falling back to localStorage store: ${t}`);try{return new r.a(e.localStorage)}catch(t){return o.a.warn(`unable to open localStorage: falling back to in-memory store: ${t}`),new a.a}})).then((e=>(this.backend=e,e)))),this.backendPromise}deleteAllData(){return new Promise(((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));o.a.log(`Removing indexeddb instance: ${this.dbName}`);const n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{o.a.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{o.a.log("Error deleting data from indexeddb",e),t(n.error)},n.onsuccess=()=>{o.a.log(`Removed indexeddb instance: ${this.dbName}`),e()}})).catch((e=>{o.a.warn(`unable to delete IndexedDBCryptoStore: ${e}`)}))}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,n){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,n)}updateOutgoingRoomKeyRequest(e,t,n){return this.backend.updateOutgoingRoomKeyRequest(e,t,n)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,n){this.backend.getSecretStorePrivateKey(e,t,n)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,n){this.backend.storeSecretStorePrivateKey(e,t,n)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,n,i){this.backend.getEndToEndSession(e,t,n,i)}getEndToEndSessions(e,t,n){this.backend.getEndToEndSessions(e,t,n)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,n,i){this.backend.storeEndToEndSession(e,t,n,i)}storeEndToEndSessionProblem(e,t,n){return this.backend.storeEndToEndSessionProblem(e,t,n)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}getEndToEndInboundGroupSession(e,t,n,i){this.backend.getEndToEndInboundGroupSession(e,t,n,i)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,n,i){this.backend.addEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSession(e,t,n,i){this.backend.storeEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,n,i)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,n){this.backend.storeEndToEndRoom(e,t,n)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,n,i){this.backend.addSharedHistoryInboundGroupSession(e,t,n,i)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}addParkedSharedHistory(e,t,n){this.backend.addParkedSharedHistory(e,t,n)}takeParkedSharedHistory(e,t){return this.backend.takeParkedSharedHistory(e,t)}doTxn(e,t,n,i){return this.backend.doTxn(e,t,n,i)}}s()(u,"STORE_ACCOUNT","account"),s()(u,"STORE_SESSIONS","sessions"),s()(u,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),s()(u,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),s()(u,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),s()(u,"STORE_PARKED_SHARED_HISTORY","parked_shared_history"),s()(u,"STORE_DEVICE_DATA","device_data"),s()(u,"STORE_ROOMS","rooms"),s()(u,"STORE_BACKUP","sessions_needing_backup")}).call(this,n(14))},function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return O})),n.d(t,"a",(function(){return I})),n.d(t,"c",(function(){return k}));var i=n(122),s=n.n(i),o=n(1),r=n(130),a=n(126),c=n(192),l=n(297),d=n(125),u=n(742),h=n(743),m=n(1706),p=n(246),g=n(992),v=n(406),f=n(203),b=n(218),y=n(693),S=n(1570),E=n(904),w=n(1572),_=n(154),C=n(155);const O=E.a.ListsUpdate,I=E.a.ListsLoading;class R extends f.a{constructor(e){super(e),s()(this,"initialListsGenerated",!1),s()(this,"msc3946ProcessDynamicPredecessor",void 0),s()(this,"msc3946SettingWatcherRef",void 0),s()(this,"algorithm",new m.a),s()(this,"prefilterConditions",[]),s()(this,"updateFn",new v.a((()=>{for(const e of Object.keys(this.orderedLists))b.a.instance.getListState(e).setRooms(this.orderedLists[e]);this.emit(O)}))),s()(this,"onAlgorithmListUpdated",(e=>{this.updateFn.mark(),e&&this.updateFn.trigger()})),s()(this,"onAlgorithmFilterUpdated",(()=>{this.updateFn.trigger()})),s()(this,"onPrefilterUpdated",(async()=>{await this.recalculatePrefiltering(),this.updateFn.trigger()})),this.setMaxListeners(20),this.algorithm.start(),this.msc3946ProcessDynamicPredecessor=a.b.getValue("feature_dynamic_room_predecessors"),this.msc3946SettingWatcherRef=a.b.watchSetting("feature_dynamic_room_predecessors",null,((e,t,n,i,s)=>{this.msc3946ProcessDynamicPredecessor=s,this.regenerateAllLists({trigger:!0})}))}componentWillUnmount(){a.b.unwatchSetting(this.msc3946SettingWatcherRef)}setupWatchers(){new S.a(this)}get orderedLists(){return this.algorithm?this.algorithm.getOrderedRooms():{}}async resetStore(){await this.reset(),this.prefilterConditions=[],this.initialListsGenerated=!1,this.algorithm.off(m.b,this.onAlgorithmListUpdated),this.algorithm.off(h.a,this.onAlgorithmListUpdated),this.algorithm.stop(),this.algorithm=new m.a,this.algorithm.on(m.b,this.onAlgorithmListUpdated),this.algorithm.on(h.a,this.onAlgorithmListUpdated),await this.reset(null,!0)}async makeReady(e){e&&this.readyStore.useUnitTestClient(e),C.b.instance.roomViewStore.addListener(_.b,(()=>this.handleRVSUpdate({}))),this.algorithm.on(m.b,this.onAlgorithmListUpdated),this.algorithm.on(h.a,this.onAlgorithmFilterUpdated),this.setupWatchers(),o.a.log("Regenerating room lists: Startup"),this.updateAlgorithmInstances(),this.regenerateAllLists({trigger:!1}),this.handleRVSUpdate({trigger:!1}),this.updateFn.mark(),this.updateFn.trigger()}handleRVSUpdate(e){let{trigger:t=!0}=e;if(!this.matrixClient)return;const n=C.b.instance.roomViewStore.getRoomId();if(!n&&this.algorithm.stickyRoom)this.algorithm.setStickyRoom(null);else if(n){const e=this.matrixClient.getRoom(n);e?e!==this.algorithm.stickyRoom&&this.algorithm.setStickyRoom(e):(o.a.warn(`${n} is current in RVS but missing from client - clearing sticky room`),this.algorithm.setStickyRoom(null))}t&&this.updateFn.trigger()}async onReady(){await this.makeReady()}async onNotReady(){await this.resetStore()}async onAction(t){this.matrixClient&&this.initialListsGenerated&&(R.TEST_MODE?await this.onDispatchAsync(t):e((()=>this.onDispatchAsync(t))))}async onDispatchAsync(e){if(this.matrixClient&&this.initialListsGenerated){if(!this.algorithm)throw new Error("Room list store has no algorithm to process dispatcher update with");if("MatrixActions.Room.receipt"===e.action){if(Object(u.a)(e.event,this.matrixClient)){const t=e.room;return t?(await this.handleRoomUpdate(t,c.c.ReadReceipt),void this.updateFn.trigger()):void o.a.warn(`Own read receipt was in unknown room ${t.roomId}`)}}else if("MatrixActions.Room.tags"===e.action){const t=e;await this.handleRoomUpdate(t.room,c.c.PossibleTagChange),this.updateFn.trigger()}else if("MatrixActions.Room.timeline"===e.action){const t=e;if(!t.isLiveEvent||!t.isLiveUnfilteredRoomTimelineEvent||!t.room)return;const n=t.event.getRoomId(),i=this.matrixClient.getRoom(n),s=async e=>{if(t.event.getType()===r.b.RoomTombstone&&""===t.event.getStateKey()){if(this.matrixClient.getRoom(t.event.getContent().replacement_room))return}await this.handleRoomUpdate(e,c.c.Timeline),this.updateFn.trigger()};if(!i)return o.a.warn(`Live timeline event ${t.event.getId()} received without associated room`),o.a.warn("Queuing failed room update for retry as a result."),void window.setTimeout((async()=>{const e=this.matrixClient.getRoom(n);await s(e)}),100);await s(i)}else if("MatrixActions.Event.decrypted"===e.action){const t=e,n=t.event.getRoomId();if(!n)return;const i=this.matrixClient.getRoom(n);if(!i)return void o.a.warn(`Event ${t.event.getId()} was decrypted in an unknown room ${n}`);await this.handleRoomUpdate(i,c.c.Timeline),this.updateFn.trigger()}else if("MatrixActions.accountData"===e.action&&e.event_type===r.b.Direct){const t=e.event.getContent();for(const e of Object.keys(t)){const n=t[e];for(const e of n){const t=this.matrixClient.getRoom(e);t?await this.handleRoomUpdate(t,c.c.PossibleTagChange):o.a.warn(`${e} was found in DMs but the room is not in the store`)}}this.updateFn.trigger()}else if("MatrixActions.Room.myMembership"===e.action)return void this.onDispatchMyMembership(e)}}async onDispatchMyMembership(e){const t=Object(p.b)(e.oldMembership),n=Object(p.b)(e.membership);if(t!==p.a.Join&&n===p.a.Join){const t=e.room.currentState.findPredecessor(this.msc3946ProcessDynamicPredecessor);if(t){const e=this.matrixClient.getRoom(t.roomId);if(e){this.algorithm.stickyRoom===e&&this.algorithm.setStickyRoom(null),this.algorithm.handleRoomUpdate(e,c.c.RoomRemoved)}else o.a.warn(`Unable to find predecessor room with id ${t.roomId}`)}return await this.handleRoomUpdate(e.room,c.c.NewRoom),void this.updateFn.trigger()}return t!==p.a.Invite&&n===p.a.Invite?(await this.handleRoomUpdate(e.room,c.c.NewRoom),void this.updateFn.trigger()):t!==n?(await this.handleRoomUpdate(e.room,c.c.PossibleTagChange),void this.updateFn.trigger()):void 0}async handleRoomUpdate(e,t){if(t===c.c.NewRoom&&"invite"===e.getMyMembership()&&await y.a.instance.onNewInvitedRoom(e),!y.a.instance.isRoomVisible(e))return;if((t===c.c.NewRoom||t===c.c.PossibleTagChange)&&!this.prefilterConditions.every((t=>t.isVisible(e))))return;this.algorithm.handleRoomUpdate(e,t)&&this.updateFn.mark()}async recalculatePrefiltering(){if(!this.algorithm)return;if(!this.algorithm.hasTagSortingMap)return;this.algorithm.updatesInhibited=!0;const e=this.getPlausibleRooms(),t=this.algorithm.stickyRoom,n=t&&e.includes(t);this.algorithm.setStickyRoom(null),this.algorithm.setKnownRooms(e),n&&this.algorithm.setStickyRoom(t),this.updateFn.mark(),this.algorithm.updatesInhibited=!1}setTagSorting(e,t){this.setAndPersistTagSorting(e,t),this.updateFn.trigger()}setAndPersistTagSorting(e,t){this.algorithm.setTagSorting(e,t),localStorage.setItem(`mx_tagSort_${e}`,t)}getTagSorting(e){return this.algorithm.getTagSorting(e)}getStoredTagSorting(e){return localStorage.getItem(`mx_tagSort_${e}`)}calculateTagSorting(e){const t=this.getTagSorting(e),n=this.getStoredTagSorting(e);let i=l.b.Recent;return n?i=n:t&&(i=t),i}setListOrder(e,t){this.setAndPersistListOrder(e,t),this.updateFn.trigger()}setAndPersistListOrder(e,t){this.algorithm.setListOrdering(e,t),localStorage.setItem(`mx_listOrder_${e}`,t)}getListOrder(e){return this.algorithm.getListOrdering(e)}getStoredListOrder(e){return localStorage.getItem(`mx_listOrder_${e}`)}calculateListOrder(e){const t=l.a.Natural,n=this.getListOrder(e),i=this.getStoredListOrder(e);let s=t;return i?s=i:n&&(s=n),s}updateAlgorithmInstances(){this.updateFn.mark();for(const e of Object.keys(this.orderedLists)){const t=this.getTagSorting(e),n=this.getListOrder(e),i=this.calculateTagSorting(e),s=this.calculateListOrder(e);i!==t&&this.setAndPersistTagSorting(e,i),s!==n&&this.setAndPersistListOrder(e,s)}this.algorithm.setUnifiedRoomList(a.b.getValue("unifiedRoomList"))}getPlausibleRooms(){if(!this.matrixClient)return[];let e=this.matrixClient.getVisibleRooms(this.msc3946ProcessDynamicPredecessor);return e=e.filter((e=>y.a.instance.isRoomVisible(e))),this.prefilterConditions.length>0&&(e=e.filter((e=>{for(const t of this.prefilterConditions)if(!t.isVisible(e))return!1;return!0}))),e}regenerateAllLists(e){let{trigger:t=!0}=e;o.a.warn("Regenerating all room lists");const n=this.getPlausibleRooms(),i={},s={},r=[...c.b];for(const e of r)i[e]=this.calculateTagSorting(e),s[e]=this.calculateListOrder(e),g.a.instance.ensureLayoutExists(e);this.algorithm.populateTags(i,s),this.algorithm.setKnownRooms(n),this.initialListsGenerated=!0,t&&this.updateFn.trigger()}async addFilter(e){let t=Promise.resolve();e.on(h.a,this.onPrefilterUpdated),this.prefilterConditions.push(e),t=this.recalculatePrefiltering(),t.then((()=>this.updateFn.trigger()))}removeFilter(e){let t=Promise.resolve(),n=!1;const i=this.prefilterConditions.indexOf(e);i>=0&&(e.off(h.a,this.onPrefilterUpdated),this.prefilterConditions.splice(i,1),t=this.recalculatePrefiltering(),n=!0),n&&t.then((()=>this.updateFn.trigger()))}getTagsForRoom(e){const t=this.algorithm.getTagsForRoom(e);if(!t)return a.b.getValue("unifiedRoomList")?[c.a.Unified]:[c.a.Untagged];const n=t.indexOf(c.a.DM);-1!==n&&(t[n]=c.a.Unified);const i=t.indexOf(c.a.Untagged);return-1!==i&&(t[i]=c.a.Unified),t}getCount(e){return this.orderedLists[e].length||0}async manualRoomUpdate(e,t){await this.handleRoomUpdate(e,t),this.updateFn.trigger()}}s()(R,"TEST_MODE",!1);class k{static get instance(){if(!k.internalInstance)if(a.b.getValue("feature_sliding_sync")){o.a.info("using SlidingRoomListStoreClass");const e=new w.a(d.a,C.b.instance);e.start(),k.internalInstance=e}else{const e=new R(d.a);e.start(),k.internalInstance=e}return this.internalInstance}}s()(k,"internalInstance",void 0),window.mxRoomListStore=k.instance}).call(this,n(54).setImmediate)},function(e,t,n){"use strict";n.d(t,"b",(function(){return b})),n.d(t,"e",(function(){return y})),n.d(t,"d",(function(){return S})),n.d(t,"c",(function(){return E})),n.d(t,"a",(function(){return w}));var i=n(122),s=n.n(i),o=n(452),r=n.n(o),a=n(767),c=n.n(a),l=n(171),d=n(130),u=n(207),h=n(189),m=n(199),p=n(168),g=n(233);function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function b(e){if(e&&!e.isRedacted())return e.replyEventId?e.replyEventId:void 0}function y(e){const t=e.split("\n");for(;t.length&&t[0].startsWith("> ");)t.shift();return""===t[0]&&t.shift(),t.join("\n")}function S(e){return r()(e,{allowedTags:!1,allowedAttributes:!1,allowedSchemes:[...m.b,"mxc"],exclusiveFilter:e=>"mx-reply"===e.tag})}function E(e){var t,n;if(e.isRedacted())return!1;const i=null===(t=e.getWireContent())||void 0===t||null===(n=t["m.relates_to"])||void 0===n?void 0:n["m.in_reply_to"];if(!i)return!1;const s=e.getRelation();return((null==s?void 0:s.rel_type)!==l.d.name||null==s||!s.is_falling_back)&&!!i.event_id}function w(e,t,n){if(e["m.relates_to"]=f(f({},e["m.relates_to"]||{}),function(e){if(!e)return{};const t={"m.in_reply_to":{event_id:e.getId()}};return e.threadRootId&&(t.is_falling_back=!1),t}(t)),n.includeLegacyFallback){const i=function(e,t){if(!e)return null;let{body:n,formatted_body:i,msgtype:s}=e.getContent();b(e)&&n&&(n=y(n)),n||(n=""),i=i?S(i):c()(n).replace(/\n/g,"<br/>");const o=t.forEvent(e.getId()),r=Object(p.i)(e.getSender()),a=e.getSender();if(u.b.matches(e.getType())){const t=Object(g.f)(e.getContent())?"their":"a";return{html:`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>shared ${t} live location.</blockquote></mx-reply>`,body:`> <${a}> shared ${t} live location.\n\n`}}if(h.a.matches(e.getType()))return{html:`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>Ended poll</blockquote></mx-reply>`,body:`> <${a}>Ended poll\n\n`};switch(s){case d.e.Text:case d.e.Notice:{i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>${i}</blockquote></mx-reply>`;const e=n.trim().split("\n");e.length>0&&(e[0]=`<${a}> ${e[0]}`,n=e.map((e=>`> ${e}`)).join("\n")+"\n\n");break}case d.e.Image:i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>sent an image.</blockquote></mx-reply>`,n=`> <${a}> sent an image.\n\n`;break;case d.e.Video:i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>sent a video.</blockquote></mx-reply>`,n=`> <${a}> sent a video.\n\n`;break;case d.e.Audio:i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>sent an audio file.</blockquote></mx-reply>`,n=`> <${a}> sent an audio file.\n\n`;break;case d.e.File:i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>sent a file.</blockquote></mx-reply>`,n=`> <${a}> sent a file.\n\n`;break;case d.e.Location:{const t=Object(g.f)(e.getContent())?"their":"a";i=`<mx-reply><blockquote><a href="${o}">In reply to</a> <a href="${r}">${a}</a><br>shared ${t} location.</blockquote></mx-reply>`,n=`> <${a}> shared ${t} location.\n\n`;break}case d.e.Emote:{i=`<mx-reply><blockquote><a href="${o}">In reply to</a> * <a href="${r}">${a}</a><br>${i}</blockquote></mx-reply>`;const e=n.trim().split("\n");e.length>0&&(e[0]=`* <${a}> ${e[0]}`,n=e.map((e=>`> ${e}`)).join("\n")+"\n\n");break}default:return null}return{body:n,html:i}}(t,n.permalinkCreator);i&&(e.formatted_body&&(e.formatted_body=i.html+e.formatted_body),e.body=i.body+e.body)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"d",(function(){return o})),n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return a}));var i=n(1);async function s(e){try{var t,n;if(null!==(t=navigator)&&void 0!==t&&null!==(n=t.clipboard)&&void 0!==n&&n.writeText)return await navigator.clipboard.writeText(e),!0;{const t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t);const n=document.getSelection(),i=document.createRange();i.selectNode(t),n.removeAllRanges(),n.addRange(i);const s=document.execCommand("copy");return n.removeAllRanges(),document.body.removeChild(t),s}}catch(e){i.a.error("copyPlaintext failed",e)}return!1}function o(e){const t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t)}function r(e){return!!e&&(o(e),document.execCommand("copy"))}function a(){return window.getSelection().toString()}},,function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(124);t.a=e=>{let{description:t,detail:n,acceptLabel:i,rejectLabel:r,onAccept:a,onReject:c}=e;const l=n?s.a.createElement("div",{className:"mx_Toast_detail"},n):null;return s.a.createElement("div",null,s.a.createElement("div",{className:"mx_Toast_description"},t,l),s.a.createElement("div",{className:"mx_Toast_buttons","aria-live":"off"},c&&r&&s.a.createElement(o.a,{kind:"danger_outline",onClick:c},r),s.a.createElement(o.a,{onClick:a,kind:"primary"},i)))}},function(e,t,n){"use strict";n.d(t,"d",(function(){return i.a})),n.d(t,"f",(function(){return o})),n.d(t,"g",(function(){return r})),n.d(t,"a",(function(){return a.a})),n.d(t,"e",(function(){return a.b})),n.d(t,"c",(function(){return c.c})),n.d(t,"h",(function(){return c.d})),n.d(t,"b",(function(){return c.b})),n.d(t,"i",(function(){return l.a})),n.d(t,"j",(function(){return h}));var i=n(557),s=n(30);const o=e=>{var t;const n=s.b.findIn(e);return(null!==(t=null==n?void 0:n.type)&&void 0!==t?t:s.a.Self)==s.a.Self},r=e=>{const t=e.getContent(),n=s.c.findIn(t);return n?n.uri:t.geo_uri};var a=n(451),c=n(558),l=n(560),d=n(121),u=n(132);const h=e=>{const t=u.b.get().brand;switch(e){case 1:return Object(d.a)("%(brand)s was denied permission to fetch your location. Please allow location access in your browser settings.",{brand:t});case 2:return Object(d.a)("Failed to fetch your location. Please try again later.");case 3:return Object(d.a)("Timed out trying to fetch your location. Please try again later.");case 4:return Object(d.a)("Unknown error fetching location. Please try again later.")}}},function(e,t,n){"use strict";n.d(t,"c",(function(){return a})),n.d(t,"b",(function(){return c})),n.d(t,"d",(function(){return l})),n.d(t,"f",(function(){return d})),n.d(t,"a",(function(){return u})),n.d(t,"e",(function(){return h})),n.d(t,"g",(function(){return m}));var i=n(130),s=n(15),o=n(123);var r={};function a(e){return c(e.getCanonicalAlias(),e.getAltAliases())}function c(e,t){var n;return r.getDisplayAliasForAliasSet?r.getDisplayAliasForAliasSet(e,t):null!==(n=e||(null==t?void 0:t[0]))&&void 0!==n?n:""}function l(e,t){let n;if(t){const t=function(e,t){let n,i;for(const o of e.getJoinedMembers()){var s;if(o.userId!=t)if(void 0===n||o.events.member&&o.events.member.getTs()<n)i=o,n=null===(s=o.events.member)||void 0===s?void 0:s.getTs()}if(i)return i.userId;for(const s of e.currentState.getMembers()){var o;if(s.userId!=t)if(void 0===n||s.events.member&&s.events.member.getTs()<n)i=s,n=null===(o=s.events.member)||void 0===o?void 0:o.getTs()}return void 0===i?t:i.userId}(e,o.a.get().getUserId());n=t}else n=null;return d(e.roomId,n)}async function d(e,t){if(o.a.get().isGuest())return;const n=o.a.get().getAccountData(i.b.Direct),s=(null==n?void 0:n.getContent())||{},r=new Map(Object.entries(s));let a=!1;for(const n of r.keys()){const i=r.get(n)||[];if(n!=t){const t=i.indexOf(e);t>-1&&(i.splice(t,1),a=!0)}}if(t){const n=r.get(t)||[];-1==n.indexOf(e)&&(n.push(e),a=!0),r.set(t,n)}a&&await o.a.get().setAccountData(i.b.Direct,Object.fromEntries(r))}const u=new s.c("m.marked_unread","com.famedly.marked_unread");function h(e){var t,n;return null==e||null===(t=e.getAccountData(u.name))||void 0===t||null===(n=t.getContent())||void 0===n?void 0:n.unread}async function m(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];await o.a.get().setRoomAccountData(e.roomId,u.name,{unread:t})}},function(e,t,n){"use strict";let i,s,o;n.d(t,"d",(function(){return i})),n.d(t,"g",(function(){return s})),n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return r})),n.d(t,"h",(function(){return a})),n.d(t,"a",(function(){return c})),n.d(t,"e",(function(){return l})),n.d(t,"f",(function(){return d})),function(e){e.DontNotify="dont_notify",e.Notify="notify",e.Coalesce="coalesce"}(i||(i={})),function(e){e.Highlight="highlight",e.Sound="sound"}(s||(s={})),function(e){e.ExactEquals="==",e.LessThan="<",e.GreaterThan=">",e.GreaterThanOrEqual=">=",e.LessThanOrEqual="<="}(o||(o={}));const r="2";function a(e){return"==2"===e||"2"===e}let c,l,d;!function(e){e.EventMatch="event_match",e.EventPropertyIs="event_property_is",e.ContainsDisplayName="contains_display_name",e.RoomMemberCount="room_member_count",e.SenderNotificationPermission="sender_notification_permission",e.CallStarted="call_started",e.CallStartedPrefix="org.matrix.msc3914.call_started"}(c||(c={})),function(e){e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride"}(l||(l={})),function(e){e.Master=".m.rule.master",e.ContainsDisplayName=".m.rule.contains_display_name",e.ContainsUserName=".m.rule.contains_user_name",e.AtRoomNotification=".m.rule.roomnotif",e.DM=".m.rule.room_one_to_one",e.EncryptedDM=".m.rule.encrypted_room_one_to_one",e.Message=".m.rule.message",e.EncryptedMessage=".m.rule.encrypted",e.InviteToSelf=".m.rule.invite_for_me",e.MemberEvent=".m.rule.member_event",e.IncomingCall=".m.rule.call",e.SuppressNotices=".m.rule.suppress_notices",e.Tombstone=".m.rule.tombstone",e.PollStart=".m.rule.poll_start",e.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",e.PollEnd=".m.rule.poll_end",e.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",e.PollStartOneToOne=".m.rule.poll_start_one_to_one",e.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",e.PollEndOneToOne=".m.rule.poll_end_one_to_one",e.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one"}(d||(d={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return v})),n.d(t,"f",(function(){return f})),n.d(t,"e",(function(){return b})),n.d(t,"c",(function(){return y})),n.d(t,"b",(function(){return S})),n.d(t,"d",(function(){return E}));var i=n(120),s=n.n(i),o=n(1),r=n(130),a=n(123),c=n(692),l=n(128),d=n(121),u=n(991),h=n(193),m=n(160),p=n(145),g=n(624);function v(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;const s=new c.a(e,i);return s.invite(t,void 0,n).then((e=>Promise.resolve({states:e,inviter:s})))}function f(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";l.b.createDialog(u.a,{kind:g.a.Dm,initialText:e},"mx_InviteDialog_flexWrapper",!1,!0)}function b(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";l.b.createDialog(u.a,{kind:g.a.Invite,initialText:t,roomId:e},"mx_InviteDialog_flexWrapper",!1,!0)}function y(e){if(!e||e.getType()!==r.b.RoomThirdPartyInvite)return!1;return!["key_validity_url","public_key","display_name"].some((t=>!e.getContent()[t]))}function S(e,t){return v(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0).then((t=>{const n=a.a.get().getRoom(e);E(t.states,n,t.inviter)})).catch((e=>{o.a.error(e.stack),l.b.createDialog(p.a,{title:Object(d.a)("Failed to invite"),description:e&&e.message?e.message:Object(d.a)("Operation failed")})}))}function E(e,t,n,i){const o=Object.keys(e).filter((t=>"error"===e[t]));if(1===o.length&&n.fatal)return l.b.createDialog(p.a,{title:Object(d.a)("Failed to invite users to %(roomName)s",{roomName:t.name}),description:n.getErrorText(o[0])}),!1;{const r=[];for(const t of o)if("error"===e[t]){const e=n.getErrorText(t);r.push(t+": "+e)}const c=a.a.get();if(r.length>0){const e=s.a.createElement("div",{className:"mx_InviteDialog_multiInviterError"},s.a.createElement("h4",null,Object(d.a)("We sent the others, but the below people couldn't be invited to <RoomName/>",{},{RoomName:()=>s.a.createElement("b",null,t.name)})),s.a.createElement("div",null,o.map((e=>{var t,o,r;const a=(null==i?void 0:i.get(e))||c.getUser(e),l=a.name||a.rawDisplayName,d=(null===(t=(o=a).getMxcAvatarUrl)||void 0===t?void 0:t.call(o))||a.avatarUrl;return s.a.createElement("div",{key:e,className:"mx_InviteDialog_tile mx_InviteDialog_tile--inviterError"},s.a.createElement("div",{className:"mx_InviteDialog_tile_avatarStack"},s.a.createElement(h.a,{url:null!==(r=d&&Object(m.b)(d).getSquareThumbnailHttp(24))&&void 0!==r?r:void 0,name:l,idName:null==a?void 0:a.userId,width:36,height:36})),s.a.createElement("div",{className:"mx_InviteDialog_tile_nameStack"},s.a.createElement("span",{className:"mx_InviteDialog_tile_nameStack_name"},l),s.a.createElement("span",{className:"mx_InviteDialog_tile_nameStack_userId"},null==a?void 0:a.userId)),s.a.createElement("div",{className:"mx_InviteDialog_tile--inviterError_errorText"},n.getErrorText(e)))}))));return l.b.createDialog(p.a,{title:Object(d.a)("Some invites couldn't be sent"),description:e}),!1}}return!0}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(122),c=n.n(a),l=n(120),d=n.n(l),u=n(127),h=n.n(u);const m=["children","className","disabled","outlined","childrenInLabel","inputRef"];class p extends d.a.PureComponent{render(){const e=this.props,{children:t,className:n,disabled:i,outlined:o,childrenInLabel:a,inputRef:c}=e,l=r()(e,m),u=h()("mx_StyledRadioButton",n,{mx_StyledRadioButton_disabled:i,mx_StyledRadioButton_enabled:!i,mx_StyledRadioButton_checked:this.props.checked,mx_StyledRadioButton_outlined:o}),p=d.a.createElement(d.a.Fragment,null,d.a.createElement("input",s()({ref:c,type:"radio",disabled:i},l)),d.a.createElement("div",null,d.a.createElement("div",null)));return a?d.a.createElement("label",{className:u},p,d.a.createElement("div",{className:"mx_StyledRadioButton_content"},t),d.a.createElement("div",{className:"mx_StyledRadioButton_spacer"})):d.a.createElement("div",{className:u},d.a.createElement("label",{className:"mx_StyledRadioButton_innerLabel"},p),d.a.createElement("div",{className:"mx_StyledRadioButton_content"},t),d.a.createElement("div",{className:"mx_StyledRadioButton_spacer"}))}}c()(p,"defaultProps",{className:"",childrenInLabel:!0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(121);t.b=e=>{let{className:t,actionLabel:n,onBack:o,onAction:c,children:l}=e;const[d,u]=Object(i.useState)(null);let h;if(d)l=d;else if(c){const e=()=>{c().then((e=>{"string"==typeof e&&u(e)}))};h=s.a.createElement("button",{onClick:e},n)}return s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:r()("mx_DevTools_content",t)},l),s.a.createElement("div",{className:"mx_Dialog_buttons"},s.a.createElement("button",{onClick:()=>{d?u(null):o()}},Object(a.a)("Back")),h))};const c=Object(i.createContext)({})},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i=n(122),s=n.n(i),o=n(1),r=n(149),a=n(152),c=n(203),l=n(125),d=n(388),u=n(339),h=n(183),m=n(202),p=n(154);class g extends c.a{constructor(){super(l.a,{}),s()(this,"widgetMap",new Map),s()(this,"roomMap",new Map),s()(this,"onWidgetEchoStoreUpdate",((e,t)=>{this.initRoom(e),this.loadRoomWidgets(this.matrixClient.getRoom(e)),this.emit(p.b,e)})),s()(this,"onRoom",(e=>{this.initRoom(e.roomId),this.loadRoomWidgets(e),this.emit(p.b,e.roomId)})),s()(this,"onRoomStateEvents",(e=>{if("im.vector.modular.widgets"!==e.getType())return;const t=e.getRoomId();this.initRoom(t),this.loadRoomWidgets(this.matrixClient.getRoom(t)),this.emit(p.b,t)})),d.a.on("update",this.onWidgetEchoStoreUpdate)}static get instance(){return g.internalInstance}initRoom(e){this.roomMap.has(e)||this.roomMap.set(e,{widgets:[]})}async onReady(){this.matrixClient.on(r.b.Room,this.onRoom),this.matrixClient.on(a.b.Events,this.onRoomStateEvents),this.matrixClient.getRooms().forEach((e=>{this.loadRoomWidgets(e)})),this.emit(p.b,null)}async onNotReady(){this.matrixClient.off(r.b.Room,this.onRoom),this.matrixClient.off(a.b.Events,this.onRoomStateEvents),this.widgetMap=new Map,this.roomMap=new Map,await this.reset({})}async onAction(e){}generateApps(e){return d.a.getEchoedRoomWidgets(e.roomId,h.a.getRoomWidgets(e)).map((e=>h.a.makeAppConfig(e.getStateKey(),e.getContent(),e.getSender(),e.getRoomId(),e.getId())))}loadRoomWidgets(e){if(!e)return;const t=this.roomMap.get(e.roomId)||{};t.widgets=[],Array.from(this.widgetMap.values()).forEach((n=>{n.roomId===e.roomId&&(void 0===n.eventId?t.widgets.push(n):this.widgetMap.delete(h.a.getWidgetUid(n)))}));let n=!1;this.generateApps(e).forEach((e=>{const i=this.widgetMap.get(h.a.getWidgetUid(e));i&&o.a.warn(`Possible widget ID conflict for ${e.id} - wants to store in room ${e.roomId} but is currently stored as ${i.roomId} - letting the want win`),this.widgetMap.set(h.a.getWidgetUid(e),e),t.widgets.push(e),n=!0})),n&&!this.roomMap.has(e.roomId)&&this.roomMap.set(e.roomId,t);const i=u.b.instance.getPersistentWidgetId();i&&u.b.instance.getPersistentRoomId()===e.roomId&&!t.widgets.some((e=>e.id===i))&&(o.a.log(`Persistent widget ${i} removed from room ${e.roomId}: destroying.`),u.b.instance.destroyPersistentWidget(i,e.roomId)),this.emit(e.roomId)}get(e,t){return this.widgetMap.get(h.a.calcWidgetUid(e,t))}getRoom(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1]&&this.initRoom(e),this.roomMap.get(e)}getApps(e){const t=this.getRoom(e);return(null==t?void 0:t.widgets)||[]}addVirtualWidget(e,t){this.initRoom(t);const n=h.a.makeAppConfig(e.id,e,e.creatorUserId,t,void 0);return this.widgetMap.set(h.a.getWidgetUid(n),n),this.roomMap.get(t).widgets.push(n),n}removeVirtualWidget(e,t){this.widgetMap.delete(h.a.calcWidgetUid(e,t));const n=this.roomMap.get(t);n&&(n.widgets=n.widgets.filter((n=>!(n.id===e&&n.roomId===t))))}doesRoomHaveConference(e){const t=this.getRoom(e.roomId);if(!t)return!1;const n=t.widgets.filter((e=>m.a.JITSI.matches(e.type))),i=d.a.roomHasPendingWidgetsOfType(e.roomId,[],m.a.JITSI);return n.length>0||i}isJoinedToConferenceIn(e){const t=this.getRoom(e.roomId);if(!t)return!1;return t.widgets.filter((e=>m.a.JITSI.matches(e.type))).some((t=>u.b.instance.getWidgetPersistence(t.id,e.roomId)))}}s()(g,"internalInstance",(()=>{const e=new g;return e.start(),e})()),window.mxWidgetStore=g.instance},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(402),c=n(475);class l extends s.a.PureComponent{render(){const{label:e,caption:t}=this.props;let n=s.a.createElement("span",{className:"mx_SettingsFlag_label"},e,t&&s.a.createElement(s.a.Fragment,null,s.a.createElement("br",null),s.a.createElement(c.a,null,t))),i=s.a.createElement(a.a,{checked:this.props.value,disabled:this.props.disabled,onChange:this.props.onChange,title:this.props.label,tooltip:this.props.tooltip});if(this.props.toggleInFront){const e=n;n=i,i=e}const o=r()("mx_SettingsFlag",this.props.className,{mx_SettingsFlag_toggleInFront:this.props.toggleInFront});return s.a.createElement("div",{"data-testid":this.props["data-testid"],className:o},n,i)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(120);const s=(e,t)=>{const n=Object(i.useRef)((e=>{}));Object(i.useEffect)((()=>{n.current=t}),[t]),Object(i.useEffect)((()=>{const t=e.register((e=>n.current(e)));return()=>{e.unregister(t)}}),[e])}},function(e,t,n){"use strict";n.d(t,"b",(function(){return Oe})),n.d(t,"a",(function(){return Ie})),n.d(t,"e",(function(){return Te})),n.d(t,"g",(function(){return je})),n.d(t,"f",(function(){return Pe})),n.d(t,"d",(function(){return Ne})),n.d(t,"c",(function(){return Me}));var i=n(131),s=n.n(i),o=n(120),r=n.n(o),a=n(130),c=n(189),l=n(226),d=n(126),u=n(139),h=n(980),m=n(122),p=n.n(m),g=n(127),v=n.n(g),f=n(243),b=n(175),y=n(123),S=n(121),E=n(649),w=n(284);class _ extends r.a.Component{constructor(e){super(e),p()(this,"onRequestChanged",(()=>{this.forceUpdate()})),p()(this,"onTrustChanged",(e=>{const{mxEvent:t}=this.props,n=t.verificationRequest;n&&n.otherUserId===e&&this.forceUpdate()}))}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on(f.l.Change,this.onRequestChanged),y.a.get().on(b.b.UserTrustStatusChanged,this.onTrustChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off(f.l.Change,this.onRequestChanged);const t=y.a.get();t&&t.removeListener(b.b.UserTrustStatusChanged,this.onTrustChanged)}static shouldRender(e,t){return!!t&&(!(e.getType()===a.b.KeyVerificationCancel&&!t.cancelled)&&(!(e.getType()===a.b.KeyVerificationDone&&!t.done)&&(!t.pending&&!!y.a.get().checkUserTrust(t.otherUserId).isCrossSigningVerified())))}render(){const{mxEvent:e}=this.props,t=e.verificationRequest;if(!_.shouldRender(e,t))return null;const n=y.a.get().getUserId();let i;if(t.done)i=Object(S.a)("You verified %(name)s",{name:Object(E.a)(t.otherUserId,e.getRoomId())});else if(t.cancelled){const s=t.cancellingUserId;i=s===n?Object(S.a)("You cancelled verifying %(name)s",{name:Object(E.a)(t.otherUserId,e.getRoomId())}):Object(S.a)("%(name)s cancelled verifying",{name:Object(E.a)(s,e.getRoomId())})}if(i){const n=v()("mx_cryptoEvent mx_cryptoEvent_icon",{mx_cryptoEvent_icon_verified:t.done});return r.a.createElement(w.a,{className:n,title:i,subtitle:Object(E.b)(t.otherUserId,e.getRoomId()),timestamp:this.props.timestamp})}return null}}var C=n(190),O=n(173),I=n(482),R=n(124),k=n(902),x=n(148),T=n(166),j=n(344),P=n(177);class D extends r.a.PureComponent{constructor(e){super(e),p()(this,"wrapperElement",Object(o.createRef)()),p()(this,"resizeObserver",void 0),p()(this,"onLengthChanged",(e=>{this.setState({length:e})})),p()(this,"resizeObserverCallback",(e=>{const t=e.find((e=>e.target===this.wrapperElement.current));t&&this.setState({narrow:t.contentRect.width<642.8571428571429})})),p()(this,"onSilencedChanged",(e=>{this.setState({silenced:e})})),p()(this,"onStateChanged",(e=>{this.setState({callState:e})})),this.state={callState:this.props.callEventGrouper.state,silenced:!1,narrow:!1,length:0}}componentDidMount(){this.props.callEventGrouper.addListener(I.b.StateChanged,this.onStateChanged),this.props.callEventGrouper.addListener(I.b.SilencedChanged,this.onSilencedChanged),this.props.callEventGrouper.addListener(I.b.LengthChanged,this.onLengthChanged),this.resizeObserver=new ResizeObserver(this.resizeObserverCallback),this.wrapperElement.current&&this.resizeObserver.observe(this.wrapperElement.current)}componentWillUnmount(){this.props.callEventGrouper.removeListener(I.b.StateChanged,this.onStateChanged),this.props.callEventGrouper.removeListener(I.b.SilencedChanged,this.onSilencedChanged),this.props.callEventGrouper.removeListener(I.b.LengthChanged,this.onLengthChanged),this.resizeObserver.disconnect()}renderCallBackButton(e){return r.a.createElement(R.a,{className:"mx_LegacyCallEvent_content_button mx_LegacyCallEvent_content_button_callBack",onClick:this.props.callEventGrouper.callBack,kind:"primary"},r.a.createElement("span",null," ",e," "))}renderSilenceIcon(){const e=v()({mx_LegacyCallEvent_iconButton:!0,mx_LegacyCallEvent_unSilence:this.state.silenced,mx_LegacyCallEvent_silence:!this.state.silenced});return r.a.createElement(x.a,{className:e,onClick:this.props.callEventGrouper.toggleSilenced,title:this.state.silenced?Object(S.a)("Sound on"):Object(S.a)("Silence call")})}renderContent(e){if(e===C.f.Ringing){let e;return this.state.narrow||(e=this.renderSilenceIcon()),r.a.createElement("div",{className:"mx_LegacyCallEvent_content"},e,r.a.createElement(R.a,{className:"mx_LegacyCallEvent_content_button mx_LegacyCallEvent_content_button_reject",onClick:this.props.callEventGrouper.rejectCall,kind:"danger"},r.a.createElement("span",null," ",Object(S.a)("Decline")," ")),r.a.createElement(R.a,{className:"mx_LegacyCallEvent_content_button mx_LegacyCallEvent_content_button_answer",onClick:this.props.callEventGrouper.answerCall,kind:"primary"},r.a.createElement("span",null," ",Object(S.a)("Accept")," ")),this.props.timestamp)}if(e===C.f.Ended){const e=this.props.callEventGrouper.hangupReason;if(this.props.callEventGrouper.gotRejected)return r.a.createElement("div",{className:"mx_LegacyCallEvent_content"},Object(S.a)("Call declined"),this.renderCallBackButton(Object(S.a)("Call back")),this.props.timestamp);if([C.c.UserHangup,"user hangup"].includes(e)||!e){const e=this.props.callEventGrouper.duration;let t=Object(S.a)("Call ended");return e&&(t+=" • "+Object(T.j)(e)),r.a.createElement("div",{className:"mx_LegacyCallEvent_content"},t,this.props.timestamp)}if(e===C.c.InviteTimeout)return r.a.createElement("div",{className:"mx_LegacyCallEvent_content"},Object(S.a)("No answer"),this.renderCallBackButton(Object(S.a)("Call back")),this.props.timestamp);if(e===C.c.AnsweredElsewhere)return r.a.createElement("div",{className:"mx_LegacyCallEvent_content"},Object(S.a)("Answered elsewhere"),this.props.timestamp);let t;return t=e===C.c.IceFailed?Object(S.a)("Could not connect media"):"ice_timeout"===e?Object(S.a)("Connection failed"):e===C.c.NoUserMedia?Object(S.a)("Their device couldn't start the camera or microphone"):"unknown_error"===e?Object(S.a)("An unknown error occurred"):e===C.c.UserBusy?Object(S.a)("The user you called is busy."):Object(S.a)("Unknown failure: %(reason)s",{reason:e}),r.a.createElement("div",{className:"mx_LegacyCallEvent_content"},r.a.createElement(k.b,{tooltip:t,className:"mx_LegacyCallEvent_content_tooltip",kind:k.a.Warning}),Object(S.a)("Connection failed"),this.renderCallBackButton(Object(S.a)("Retry")),this.props.timestamp)}return e===C.f.Connected?r.a.createElement("div",{className:"mx_LegacyCallEvent_content"},r.a.createElement(j.a,{seconds:this.state.length,"aria-live":"off"}),this.props.timestamp):e===C.f.Connecting?r.a.createElement("div",{className:"mx_LegacyCallEvent_content"},Object(S.a)("Connecting"),this.props.timestamp):e===I.a.Missed?r.a.createElement("div",{className:"mx_LegacyCallEvent_content"},Object(S.a)("Missed call"),this.renderCallBackButton(Object(S.a)("Call back")),this.props.timestamp):r.a.createElement("div",{className:"mx_LegacyCallEvent_content"},Object(S.a)("The call is in an unknown state!"),this.props.timestamp)}render(){const e=this.props.mxEvent,t=e.sender?e.sender.name:e.getSender(),n=this.props.callEventGrouper.isVoice,i=n?Object(S.a)("Voice call"):Object(S.a)("Video call"),s=this.state.callState,o=this.props.callEventGrouper.hangupReason,a=this.renderContent(s),c=v()("mx_LegacyCallEvent",{mx_LegacyCallEvent_voice:n,mx_LegacyCallEvent_video:!n,mx_LegacyCallEvent_narrow:this.state.narrow&&this.props.layout!==P.a.Bubble,mx_LegacyCallEvent_missed:s===I.a.Missed,mx_LegacyCallEvent_noAnswer:s===C.f.Ended&&o===C.c.InviteTimeout,mx_LegacyCallEvent_rejected:s===C.f.Ended&&this.props.callEventGrouper.gotRejected});let l;return this.state.narrow&&this.state.callState===C.f.Ringing&&(l=this.renderSilenceIcon()),r.a.createElement("div",{className:"mx_LegacyCallEvent_wrapper",ref:this.wrapperElement},r.a.createElement("div",{className:c},l,r.a.createElement("div",{className:"mx_LegacyCallEvent_info"},r.a.createElement(O.b,{member:e.sender,width:32,height:32}),r.a.createElement("div",{className:"mx_LegacyCallEvent_info_basic"},r.a.createElement("div",{className:"mx_LegacyCallEvent_sender"},t),r.a.createElement("div",{className:"mx_LegacyCallEvent_type"},r.a.createElement("div",{className:"mx_LegacyCallEvent_type_icon"}),i))),a))}}var N=n(206),M=n(283),A=n(125),L=n(129),U=n(638),F=n(650),B=n(133),V=n(651);const K=Object(o.forwardRef)(((e,t)=>{let{mxEvent:n,call:i,participatingMembers:s,buttonText:a,buttonKind:c,buttonDisabledTooltip:l,onButtonClick:d}=e;const u=Object(o.useMemo)((()=>{var e,t;return null!==(e=null===(t=n.sender)||void 0===t?void 0:t.name)&&void 0!==e?e:n.getSender()}),[n]),h=Object(o.useMemo)((()=>s.slice(0,8)),[s]),m=s.length>h.length;return r.a.createElement("div",{className:"mx_CallEvent_wrapper",ref:t},r.a.createElement("div",{className:"mx_CallEvent mx_CallEvent_active"},r.a.createElement(O.b,{member:n.sender,fallbackUserId:n.getSender(),viewUserOnClick:!0,width:24,height:24}),r.a.createElement("div",{className:"mx_CallEvent_columns"},r.a.createElement("div",{className:"mx_CallEvent_details"},r.a.createElement("span",{className:"mx_CallEvent_title"},Object(S.a)("%(name)s started a video call",{name:u})),r.a.createElement(U.a,{type:U.c.Video,text:Object(S.a)("Video call"),active:!1,participantCount:s.length}),r.a.createElement(F.a,{members:h,faceSize:24,overflow:m})),i&&r.a.createElement(V.b,{groupCall:i.groupCall}),r.a.createElement(x.a,{className:"mx_CallEvent_button",kind:c,disabled:null===d||void 0!==l,onClick:d,tooltip:l},a))))})),$=Object(o.forwardRef)(((e,t)=>{let{mxEvent:n,call:i}=e;const s=Object(M.c)(i),a=Object(M.g)(i),c=Object(M.d)(i),l=Object(o.useCallback)((e=>{e.preventDefault(),A.a.dispatch({action:L.a.ViewRoom,room_id:n.getRoomId(),view_call:!0,metricsTrigger:void 0})}),[n]),d=Object(o.useCallback)((e=>{e.preventDefault(),i.disconnect()}),[i]),[u,h,m]=Object(o.useMemo)((()=>{switch(s){case N.c.Disconnected:return[Object(S.a)("Join"),"primary",l];case N.c.Connecting:return[Object(S.a)("Join"),"primary",null];case N.c.Connected:return[Object(S.a)("Leave"),"danger",d];case N.c.Disconnecting:return[Object(S.a)("Leave"),"danger",null]}}),[s,l,d]);return r.a.createElement(K,{ref:t,mxEvent:n,call:i,participatingMembers:a,buttonText:u,buttonKind:h,buttonDisabledTooltip:null!=c?c:void 0,onButtonClick:m})})),H=Object(o.forwardRef)(((e,t)=>{let{mxEvent:n}=e;const i=Object(o.useContext)(B.a),s=Object(M.a)(n.getRoomId()),a=i.getRoom(n.getRoomId()).currentState.getStateEvents(n.getType(),n.getStateKey());return"m.terminated"in a.getContent()?r.a.createElement("div",{className:"mx_CallEvent_wrapper",ref:t},r.a.createElement("div",{className:"mx_CallEvent mx_CallEvent_inactive"},r.a.createElement("div",{className:"mx_CallEvent_columns"},r.a.createElement("span",{className:"mx_CallEvent_title"},Object(S.a)("Video call ended")),r.a.createElement(V.a,{delta:a.getTs()-n.getTs()})))):null===s?r.a.createElement(K,{ref:t,mxEvent:n,call:null,participatingMembers:[],buttonText:Object(S.a)("Join"),buttonKind:"primary",onButtonClick:null}):r.a.createElement($,{mxEvent:n,call:s,ref:t})}));var W=n(296);class q extends r.a.Component{render(){var e;const t=W.b(this.props.mxEvent,!0,null===(e=this.context)||void 0===e?void 0:e.showHiddenEvents);return t?r.a.createElement("div",{className:"mx_TextualEvent"},t):null}}p()(q,"contextType",u.b);var G=n(903),z=n(1),J=n(168),Y=n(314);const Q=e=>{let{mxEvent:t,timestamp:n}=e;const i=d.b.getValue("feature_dynamic_room_predecessors"),s=Object(o.useContext)(u.b),a=Object(Y.a)(s.room,Object(o.useCallback)((e=>e.findPredecessor(i)),[i])),c=Object(o.useCallback)((e=>{e.preventDefault(),A.a.dispatch({action:L.a.ViewRoom,event_id:a.eventId,highlighted:!0,room_id:a.roomId,metricsTrigger:"Predecessor",metricsViaKeyboard:"click"!==e.type})}),[null==a?void 0:a.eventId,null==a?void 0:a.roomId]);if(!s.room||s.room.roomId!==t.getRoomId())return z.a.warn("RoomPredecessorTile unexpectedly used outside of the context of theroom containing this m.room.create event."),r.a.createElement(r.a.Fragment,null);if(!a)return z.a.warn("RoomPredecessorTile unexpectedly used in a room with no predecessor."),r.a.createElement("div",null);const l=y.a.get().getRoom(a.roomId);if(!l)return z.a.warn(`Failed to find predecessor room with id ${a.roomId}`),r.a.createElement(r.a.Fragment,null);const h=new J.a(l,a.roomId);let m;h.load(),m=a.eventId?h.forEvent(a.eventId):h.forRoom();const p=r.a.createElement("a",{href:m,onClick:c},Object(S.a)("Click here to see older messages."));return r.a.createElement(w.a,{className:"mx_CreateEvent",title:Object(S.a)("This room is a continuation of another conversation."),subtitle:p,timestamp:n})};var X=n(128),Z=n(160),ee=n(165),te=n(417);class ne extends r.a.Component{constructor(){super(...arguments),p()(this,"onAvatarClick",(()=>{const e=y.a.get(),t=this.props.mxEvent,n=Object(Z.b)(t.getContent().url).srcHttp,i=e.getRoom(this.props.mxEvent.getRoomId()),s={src:n,name:Object(S.a)("%(senderDisplayName)s changed the avatar for %(roomName)s",{senderDisplayName:t.sender&&t.sender.name?t.sender.name:t.getSender(),roomName:i?i.name:""})};X.b.createDialog(te.a,s,"mx_Dialog_lightbox",null,!0)}))}render(){const e=this.props.mxEvent,t=e.sender&&e.sender.name?e.sender.name:e.getSender();if(!e.getContent().url||0===e.getContent().url.trim().length)return r.a.createElement("div",{className:"mx_TextualEvent"},Object(S.a)("%(senderDisplayName)s removed the room avatar.",{senderDisplayName:t}));const n=y.a.get().getRoom(e.getRoomId()),i={avatarUrl:e.getContent().url,name:n?n.name:""};return r.a.createElement("div",{className:"mx_RoomAvatarEvent"},Object(S.a)("%(senderDisplayName)s changed the room avatar to <img/>",{senderDisplayName:t},{img:()=>r.a.createElement(R.a,{key:"avatar",className:"mx_RoomAvatarEvent_avatar",onClick:this.onAvatarClick},r.a.createElement(ee.a,{width:14,height:14,oobData:i}))}))}}var ie=n(210),se=n(505),oe=n(184),re=n(174);class ae extends r.a.Component{constructor(){super(...arguments),p()(this,"openRequest",(()=>{const{verificationRequest:e}=this.props.mxEvent,t=y.a.get().getUser(e.otherUserId);re.a.instance.setCards([{phase:oe.a.RoomSummary},{phase:oe.a.RoomMemberInfo,state:{member:t}},{phase:oe.a.EncryptionPanel,state:{verificationRequest:e,member:t}}])})),p()(this,"onRequestChanged",(()=>{this.forceUpdate()})),p()(this,"onAcceptClicked",(async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{this.openRequest(),await e.accept()}catch(e){z.a.error(e.message)}})),p()(this,"onRejectClicked",(async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{await e.cancel()}catch(e){z.a.error(e.message)}}))}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on(f.l.Change,this.onRequestChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off(f.l.Change,this.onRequestChanged)}acceptedLabel(e){return e===y.a.get().getUserId()?Object(S.a)("You accepted"):Object(S.a)("%(name)s accepted",{name:Object(E.a)(e,this.props.mxEvent.getRoomId())})}cancelledLabel(e){const t=y.a.get().getUserId(),{cancellationCode:n}=this.props.mxEvent.verificationRequest,i="m.user"===n;return e===t?i?Object(S.a)("You declined"):Object(S.a)("You cancelled"):i?Object(S.a)("%(name)s declined",{name:Object(E.a)(e,this.props.mxEvent.getRoomId())}):Object(S.a)("%(name)s cancelled",{name:Object(E.a)(e,this.props.mxEvent.getRoomId())})}render(){const{mxEvent:e}=this.props,t=e.verificationRequest;if(!t||t.invalid)return null;let n,i,s;if(!t.canAccept){let e;t.ready||t.started||t.done?e=r.a.createElement(R.a,{onClick:this.openRequest},this.acceptedLabel(t.receivingUserId)):t.cancelled?e=this.cancelledLabel(t.cancellingUserId):t.accepting?e=Object(S.a)("Accepting…"):t.declining&&(e=Object(S.a)("Declining…")),s=r.a.createElement("div",{className:"mx_cryptoEvent_state"},e)}if(t.initiatedByMe)n=Object(S.a)("You sent a verification request"),i=Object(E.b)(t.receivingUserId,e.getRoomId());else{const o=Object(E.a)(t.requestingUserId,e.getRoomId());n=Object(S.a)("%(name)s wants to verify",{name:o}),i=Object(E.b)(t.requestingUserId,e.getRoomId()),t.canAccept&&(s=r.a.createElement("div",{className:"mx_cryptoEvent_buttons"},r.a.createElement(R.a,{kind:"danger",onClick:this.onRejectClicked},Object(S.a)("Decline")),r.a.createElement(R.a,{kind:"primary",onClick:this.onAcceptClicked},Object(S.a)("Accept"))))}return n?r.a.createElement(w.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:n,subtitle:i,timestamp:this.props.timestamp},s):null}}var ce=n(202),le=n(239);class de extends r.a.PureComponent{constructor(e){super(e)}render(){var e;const t=this.props.mxEvent.getContent().url,n=this.props.mxEvent.getPrevContent().url,i=(null===(e=this.props.mxEvent.sender)||void 0===e?void 0:e.name)||this.props.mxEvent.getSender(),s=y.a.get().getRoom(this.props.mxEvent.getRoomId()),o=this.props.mxEvent.getStateKey(),a=le.a.instance.getRoom(s.roomId,!0).widgets.find((e=>e.id===o));let c=Object(S.a)("Join the conference at the top of this room");return a&&ie.d.instance.isInContainer(s,a,ie.a.Right)?c=Object(S.a)("Join the conference from the room information card on the right"):a||(c=null),t?n?r.a.createElement(w.a,{className:"mx_MJitsiWidgetEvent",title:Object(S.a)("Video conference updated by %(senderName)s",{senderName:i}),subtitle:c,timestamp:this.props.timestamp}):r.a.createElement(w.a,{className:"mx_MJitsiWidgetEvent",title:Object(S.a)("Video conference started by %(senderName)s",{senderName:i}),subtitle:c,timestamp:this.props.timestamp}):r.a.createElement(w.a,{className:"mx_MJitsiWidgetEvent",title:Object(S.a)("Video conference ended by %(senderName)s",{senderName:i}),timestamp:this.props.timestamp})}}var ue=n(182);var he=r.a.forwardRef(((e,t)=>{let n,{mxEvent:i}=e;const s=i.messageVisibility();switch(s.visible){case!0:throw new Error("HiddenBody should only be applied to hidden messages");case!1:n=s.reason?Object(S.a)("Message pending moderation: %(reason)s",{reason:s.reason}):Object(S.a)("Message pending moderation")}return r.a.createElement("span",{className:"mx_HiddenBody",ref:t},n)})),me=n(137);class pe extends r.a.PureComponent{constructor(e){super(e),p()(this,"onToggle",(e=>{e.preventDefault();const{expanded:t}=this.state;this.setState({expanded:!t})})),this.state={expanded:!1}}componentDidMount(){const{mxEvent:e}=this.props;y.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()&&e.once(me.MatrixEventEvent.Decrypted,(()=>this.forceUpdate()))}render(){const{mxEvent:e}=this.props,{expanded:t}=this.state;let n;n=t?r.a.createElement("pre",null,JSON.stringify(e,null,4)):r.a.createElement("code",null,`{ "type": ${e.getType()} }`);const i=v()("mx_ViewSourceEvent mx_EventTile_content",{mx_ViewSourceEvent_expanded:t});return r.a.createElement("span",{className:i},n,r.a.createElement(R.a,{kind:"link",title:Object(S.a)("toggle event"),className:"mx_ViewSourceEvent_toggle",onClick:this.onToggle}))}}var ge=n(207);const ve=e=>{var t;return ge.b.matches(e.getType())&&((null===(t=e.getContent())||void 0===t?void 0:t.live)||e.isRedacted())};var fe=n(636),be=n(195);const ye=(e,t)=>r.a.createElement(h.a,s()({ref:e},t)),Se=(e,t)=>r.a.createElement(_,s()({ref:e},t)),Ee=(e,t)=>r.a.createElement(H,s()({ref:e},t)),we=(e,t)=>r.a.createElement(q,s()({ref:e},t)),_e=(e,t)=>r.a.createElement(ae,s()({ref:e},t)),Ce=(e,t)=>r.a.createElement(he,s()({ref:e},t)),Oe=(e,t)=>r.a.createElement(de,s()({ref:e},t)),Ie=(e,t)=>r.a.createElement(pe,s()({ref:e},t)),Re=new Map([[a.b.RoomMessage,ye],[a.b.Sticker,ye],[c.e.name,ye],[c.e.altName,ye],[c.a.name,ye],[c.a.altName,ye],[a.b.KeyVerificationCancel,Se],[a.b.KeyVerificationDone,Se],[a.b.CallInvite,(e,t)=>r.a.createElement(D,s()({ref:e},t))]]),ke=new Map([[a.b.RoomEncryption,(e,t)=>r.a.createElement(G.a,s()({ref:e},t))],[a.b.RoomCanonicalAlias,we],[a.b.RoomCreate,(e,t)=>r.a.createElement(Q,t)],[a.b.RoomMember,we],[a.b.RoomName,we],[a.b.RoomAvatar,(e,t)=>r.a.createElement(ne,s()({ref:e},t))],[a.b.RoomThirdPartyInvite,we],[a.b.RoomHistoryVisibility,we],[a.b.RoomTopic,we],[a.b.RoomPowerLevels,we],[a.b.RoomPinnedEvents,we],[a.b.RoomServerAcl,we],["im.vector.modular.widgets",we],[ie.c,we],[a.b.RoomTombstone,we],[a.b.RoomJoinRules,we],[a.b.RoomGuestAccess,we]]);for(const e of N.d.CALL_EVENT_TYPE.names)ke.set(e,Ee);for(const e of se.a)ke.set(e,we);const xe=new Set([a.b.RoomEncryption,a.b.RoomCanonicalAlias,a.b.RoomCreate,a.b.RoomName,a.b.RoomAvatar,a.b.RoomHistoryVisibility,a.b.RoomTopic,a.b.RoomPowerLevels,a.b.RoomPinnedEvents,a.b.RoomServerAcl,ie.c,a.b.RoomTombstone,a.b.RoomJoinRules,a.b.RoomGuestAccess]);function Te(e,t,n,i){var s;const o=e.getType();if(i&&n)return Ie;const r=()=>n?Ie:void 0;if(Object(ue.h)(e,t)===ue.a.HIDDEN_TO_CURRENT_USER)return Ce;if(o===a.b.RoomMessage){const n=e.getContent();if((null==n?void 0:n.msgtype)===a.e.KeyVerificationRequest){const i=t.getUserId();return e.getSender()!==i&&n.to!==i?r():_e}}else if(o===a.b.KeyVerificationDone){const n=t.getUserId();if(e.getSender()!==n)return r()}if((o===a.b.KeyVerificationCancel||o===a.b.KeyVerificationDone)&&!_.shouldRender(e,e.verificationRequest))return r();if(o===a.b.RoomCreate){var c;const n=d.b.getValue("feature_dynamic_room_predecessors");if(!(null===(c=t.getRoom(e.getRoomId()))||void 0===c?void 0:c.findPredecessor(n)))return r()}if("im.vector.modular.widgets"===o){let t=e.getContent().type;if(t||(t=e.getPrevContent().type),ce.a.JITSI.matches(t))return Oe}var l;return e.isState()?ve(e)||Object(fe.a)(e)?ye:Object(be.N)(e)?we:xe.has(o)&&""!==e.getStateKey()?r():(ke.get(o)!==we||Object(W.a)(e,n))&&null!==(l=ke.get(o))&&void 0!==l?l:r():e.isRedacted()?ye:e.isRelation(a.h.Replace)||e.getContent()[be.c]||!n&&e.isDecryptionFailure()&&Object(be.K)(e,t)?r():null!==(s=Re.get(o))&&void 0!==s?s:r()}function je(e,t,n,i){var s;i=null!==(s=i)&&void 0!==s?s:y.a.get();const o=Te(t.mxEvent,i,n);if(!o)return;const{ref:r,mxEvent:a,forExport:c,replacingEventId:l,editState:d,highlights:h,highlightLink:m,showUrlPreview:p,layout:g,userNameColorMode:v,youtubeEmbedPlayer:f,scBubble:b,scBubbleActionBar:S,scBubbleTimestamp:E,permalinkCreator:w,onHeightChanged:_,callEventGrouper:C,getRelationsForEvent:O,isSeeingThroughMessageHiddenForModeration:I,timestamp:R}=t;switch(e){case u.a.File:case u.a.Notification:case u.a.Thread:return o(t.ref,{mxEvent:a,highlights:h,highlightLink:m,showUrlPreview:p,layout:g,userNameColorMode:v,youtubeEmbedPlayer:f,scBubble:b,scBubbleActionBar:S,scBubbleTimestamp:E,onHeightChanged:_,editState:d,replacingEventId:l,getRelationsForEvent:O,isSeeingThroughMessageHiddenForModeration:I,permalinkCreator:w});default:return o(r,{mxEvent:a,forExport:c,replacingEventId:l,editState:d,highlights:h,highlightLink:m,showUrlPreview:p,layout:g,userNameColorMode:v,youtubeEmbedPlayer:f,scBubble:b,scBubbleActionBar:S,scBubbleTimestamp:E,permalinkCreator:w,onHeightChanged:_,callEventGrouper:C,getRelationsForEvent:O,isSeeingThroughMessageHiddenForModeration:I,timestamp:R})}}function Pe(e,t,n){var i;n=null!==(i=n)&&void 0!==i?i:y.a.get();const s=Te(e.mxEvent,n,t);if(!s)return;const{ref:o,mxEvent:r,highlights:a,highlightLink:c,onHeightChanged:l,showUrlPreview:d,layout:u,userNameColorMode:h,youtubeEmbedPlayer:m,scBubble:p,scBubbleActionBar:g,scBubbleTimestamp:v,overrideBodyTypes:f,overrideEventTypes:b,replacingEventId:S,maxImageHeight:E,getRelationsForEvent:w,isSeeingThroughMessageHiddenForModeration:_,permalinkCreator:C}=e;return s(o,{mxEvent:r,highlights:a,highlightLink:c,onHeightChanged:l,showUrlPreview:d,layout:u,userNameColorMode:h,youtubeEmbedPlayer:m,scBubble:p,scBubbleActionBar:g,scBubbleTimestamp:v,overrideBodyTypes:f,overrideEventTypes:b,replacingEventId:S,maxImageHeight:E,getRelationsForEvent:w,isSeeingThroughMessageHiddenForModeration:_,permalinkCreator:C})}const De=[a.b.RoomMessage,a.b.Sticker];function Ne(e){return De.includes(e.getType())||c.e.matches(e.getType())||c.a.matches(e.getType())}function Me(e,t){if(e.isRedacted()&&!e.isEncrypted()&&!Ne(e)&&!e.isState())return!1;if(e.isRelation(a.h.Replace))return!1;const n=y.a.get(),i=Te(e,n,t);if(!i)return!1;if(i===we)return Object(W.a)(e,t);if(i===ke.get(a.b.RoomCreate)){var s;const t=d.b.getValue("feature_dynamic_room_predecessors"),i=null===(s=n.getRoom(e.getRoomId()))||void 0===s?void 0:s.findPredecessor(t);return Boolean(i)}if(N.d.CALL_EVENT_TYPE.names.some((e=>i===ke.get(e)))){const t=e.getContent()["m.intent"];return 0===Object.keys(e.getPrevContent()).length&&"string"==typeof t&&t!==l.d.Room}return i!==Ie}},function(e,t,n){"use strict";n.d(t,"i",(function(){return u})),n.d(t,"j",(function(){return h})),n.d(t,"a",(function(){return m})),n.d(t,"h",(function(){return g})),n.d(t,"g",(function(){return v})),n.d(t,"f",(function(){return f})),n.d(t,"d",(function(){return b})),n.d(t,"c",(function(){return y})),n.d(t,"e",(function(){return S})),n.d(t,"b",(function(){return w})),n.d(t,"l",(function(){return _})),n.d(t,"k",(function(){return C}));var i=n(13),s=n.n(i),o=n(1),r=n(368),a=n(429),c=n(130),l=n(159);const d="m.key.verification.",u=d+"request",h=d+"start",m=d+"cancel",p=d+"done",g=d+"ready";let v;!function(e){e[e.Unsent=1]="Unsent",e[e.Requested=2]="Requested",e[e.Ready=3]="Ready",e[e.Started=4]="Started",e[e.Cancelled=5]="Cancelled",e[e.Done=6]="Done"}(v||(v={}));const f=v.Unsent,b=v.Requested,y=v.Ready,S=v.Started,E=v.Cancelled,w=v.Done;let _;!function(e){e.Change="change"}(_||(_={}));class C extends l.b{constructor(e,t,n){super(),this.channel=e,this.verificationMethods=t,this.client=n,s()(this,"eventsByUs",new Map),s()(this,"eventsByThem",new Map),s()(this,"_observeOnly",!1),s()(this,"timeoutTimer",null),s()(this,"_accepting",!1),s()(this,"_declining",!1),s()(this,"verifierHasFinished",!1),s()(this,"_cancelled",!1),s()(this,"_chosenMethod",null),s()(this,"_qrCodeData",null),s()(this,"requestReceivedAt",null),s()(this,"commonMethods",[]),s()(this,"_phase",void 0),s()(this,"_cancellingUserId",void 0),s()(this,"_verifier",void 0),s()(this,"cancelOnTimeout",(async()=>{try{this.initiatedByMe?await this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):await this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){o.a.error("Error while cancelling verification request",e)}})),this.channel.request=this,this.setPhase(f,!1)}static validateEvent(e,t,n){const i=t.getContent();return!(!e||!e.startsWith(d))&&(i?e!==u&&e!==g||Array.isArray(i.methods)?e!==u&&e!==g&&e!==h||"string"==typeof i.from_device&&0!==i.from_device.length||(o.a.log("VerificationRequest: validateEvent: fail because from_device"),!1):(o.a.log("VerificationRequest: validateEvent: fail because methods"),!1):(o.a.log("VerificationRequest: validateEvent: no content"),!1))}get invalid(){return this.phase===f}get requested(){return this.phase===b}get cancelled(){return this.phase===E}get ready(){return this.phase===y}get started(){return this.phase===S}get done(){return this.phase===w}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+6e5;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=b){const e=this.requestReceivedAt+12e4;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this.getEventByEither(u);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(u)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<y&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==w&&this._phase!==E}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(e){if(!(arguments.length>1&&void 0!==arguments[1]&&arguments[1])&&!this.ready&&!this.started)return!1;const t=this.eventsByThem.get(u)||this.eventsByThem.get(g);if(!t){if(this.started&&this.initiatedByMe){const t=this.eventsByUs.get(h),n=t&&t.getContent();return e==(n&&n.method)}return!1}const n=t.getContent();if(!n)return!1;const{methods:i}=n;return!!Array.isArray(i)&&i.includes(e)}get initiatedByMe(){const e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===f&&e)return!0;const t=this.eventsByUs.has(u),n=this.eventsByThem.has(u);if(t&&!n)return!0;if(!t&&n)return!1;const i=this.eventsByUs.has(h),s=this.eventsByThem.has(h);return!(!i||s)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this.eventsByUs.get(m),t=this.eventsByThem.get(m);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this.getEventByEither(m);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=this.eventsByThem.get(u)||this.eventsByThem.get(g)||this.eventsByThem.get(h),t=null==e?void 0:e.getContent(),n=null==t?void 0:t.from_device;return{userId:this.otherUserId,deviceId:n}}beginKeyVerification(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this.observeOnly&&!this._verifier){if(this.phase===b||this.phase===y||this.phase===f&&this.channel.canCreateRequest(h)){if(this.commonMethods.length&&!this.commonMethods.includes(e))throw Object(r.g)();if(this._verifier=this.createVerifier(e,null,t),!this._verifier)throw Object(r.g)();this._chosenMethod=e}}return this._verifier}async sendRequest(){if(!this.observeOnly&&this._phase===f){const e=[...this.verificationMethods.keys()];await this.channel.send(u,{methods:e})}}async cancel(){let{reason:e="User declined",code:t="m.user"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.observeOnly&&this._phase!==E){if(this._declining=!0,this.emit(_.Change),this._verifier)return this._verifier.cancel(Object(r.a)(t,e)());this._cancellingUserId=this.client.getUserId(),await this.channel.send(m,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===b&&!this.initiatedByMe){const e=[...this.verificationMethods.keys()];this._accepting=!0,this.emit(_.Change),await this.channel.send(g,{methods:e})}}waitFor(e){return new Promise(((t,n)=>{const i=()=>{let s=!1;return e(this)?(t(this),s=!0):this.cancelled&&(n(new Error("cancelled")),s=!0),s&&this.off(_.Change,i),s};i()||this.on(_.Change,i)}))}setPhase(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._phase=e,t&&this.emit(_.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1]?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){const e=[{phase:f}],t=()=>e[e.length-1].phase,n=this.eventsByThem.has(u),i=this.getEventBy(u,n);i&&e.push({phase:b,event:i});const s=i&&this.getEventBy(g,!n);let o;if(s&&t()===b&&e.push({phase:y,event:s}),s||!i){const e=this.eventsByThem.get(h),t=this.eventsByUs.get(h);o=e&&t?e.getSender()<t.getSender()?e:t:e||t}else o=this.getEventBy(h,!n);if(o){const n=t()===b&&(null==i?void 0:i.getSender())!==o.getSender(),s=t()===f&&this.channel.canCreateRequest(h);(n||t()===y||s)&&e.push({phase:S,event:o})}const r=this.eventsByUs.get(p);(this.verifierHasFinished||r&&t()===S)&&e.push({phase:w});const a=this.getEventByEither(m);return(this._cancelled||a)&&t()!==w?(e.push({phase:E,event:a}),e):e}transitionToPhase(e){const{phase:t,event:n}=e;if((t===b||t===y)&&!this.wasSentByOwnDevice(n)){const e=n.getContent();this.commonMethods=e.methods.filter((e=>this.verificationMethods.has(e)))}if(this.observeOnly||t!==b&&t!==S&&t!==y||this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(n)&&!this.wasSentByOwnDevice(n)&&(this._observeOnly=!0),t===S){const{method:e}=n.getContent();this._verifier||this.observeOnly||(this._verifier=this.createVerifier(e,n),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:`Unknown method: ${e}`}))}}applyPhaseTransitions(){const e=this.calculatePhaseTransitions(),t=e.findIndex((e=>e.phase===this.phase)),n=e.slice(t+1);for(const e of n)this.transitionToPhase(e);return n}isWinningStartRace(e){if(e.getType()!==h)return!1;const t=this._verifier.startEvent;let n,i;if(this.isSelfVerification)if(t){const e=t.getContent();n=e&&e.from_device}else n=this.client.getDeviceId();else n=t?t.getSender():this.client.getUserId();if(this.isSelfVerification){const t=e.getContent();i=t&&t.from_device}else i=e.getSender();return i<n}hasEventId(e){for(const t of this.eventsByUs.values())if(t.getId()===e)return!0;for(const t of this.eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,n,i,s){if(this.done||this.cancelled)return;const r=this._observeOnly;if(this.adjustObserveOnly(t,n),!this.observeOnly&&!i&&await this.cancelOnError(e,t))return;if(s?this.eventsByUs.has(e):this.eventsByThem.has(e))return;const c=this.phase;this.addEvent(e,t,s);const l=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const n=this.isWinningStartRace(t);if(this._verifier.canSwitchStartEvent(t)&&n)this._verifier.switchStartEvent(t);else if(!i){var d;(e===m||null!==(d=this._verifier.events)&&void 0!==d&&d.includes(e))&&this._verifier.handleEvent(t)}}if(l.length){if(n&&l.some((e=>e.phase===y))){this.otherPartySupportsMethod(a.d,!0)&&(this._qrCodeData=await a.a.create(this,this.client))}const e=l[l.length-1],{phase:t}=e;this.setupTimeout(t),this.setPhase(t)}else this._observeOnly!==r&&this.emit(_.Change)}finally{o.a.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${s}, isLiveEvent:${n}, isRemoteEcho:${i}, phase:${c}=>${this.phase}, observeOnly:${r}=>${this._observeOnly}`)}}setupTimeout(e){if(!this.timeoutTimer&&!this.observeOnly&&e===b&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer){(e===S||e===y||e===w||e===E)&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}}async cancelOnError(e,t){if(e===h){const e=t.getContent().method;if(!this.verificationMethods.has(e))return await this.cancel(Object(r.b)(Object(r.g)())),!0}const n=e===u&&this.phase!==f,i=e===g&&this.phase!==b&&this.phase!==S;if(this.phase!==f&&(n||i)){o.a.warn(`Cancelling, unexpected ${e} verification event from ${t.getSender()}`);const n=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel(Object(r.b)(Object(r.f)({reason:n}))),!0}return!1}adjustObserveOnly(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}addEvent(e,t){if(arguments.length>2&&void 0!==arguments[2]&&arguments[2]?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===u){for(const[e,t]of this.eventsByThem.entries())t.getSender()!==this.otherUserId&&this.eventsByThem.delete(e);this.requestReceivedAt=Date.now()}}createVerifier(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;n||(n=this.targetDevice);const{userId:i,deviceId:s}=n,r=this.verificationMethods.get(e);if(r)return new r(this.channel,this.client,i,s,t,this);o.a.warn("could not find verifier constructor for method",e)}wasSentByOwnUser(e){return(null==e?void 0:e.getSender())===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send(c.b.KeyVerificationDone,{}),this.verifierHasFinished=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}},,function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"c",(function(){return u})),n.d(t,"f",(function(){return h})),n.d(t,"h",(function(){return m})),n.d(t,"d",(function(){return p})),n.d(t,"g",(function(){return g})),n.d(t,"a",(function(){return v})),n.d(t,"e",(function(){return f}));var i=n(15),s=n(123);const o="io.element.call_behaviour",r="io.element.e2ee",a="im.vector.riot.e2ee",c=new i.c("m.tile_server","org.matrix.msc3488.tile_server"),l="io.element.embedded_pages";function d(){const e=s.a.get().getClientWellKnown();return null==e?void 0:e[o]}function u(){const e=s.a.get().getClientWellKnown();return null!=e&&e[r]?e[r]:null!=e&&e[a]?e[a]:null}function h(){return m(s.a.get().getClientWellKnown())}function m(e){var t;return null!==(t=null==e?void 0:e[c.name])&&void 0!==t?t:null==e?void 0:e[c.altName]}function p(){var e,t;return null==(t=null===(e=s.a.get())||void 0===e?void 0:e.getClientWellKnown())?void 0:t[l]}function g(){var e;return!0===(null===(e=u())||void 0===e?void 0:e.secure_backup_required)}let v;function f(){const e=u();return e&&e.secure_backup_setup_methods&&e.secure_backup_setup_methods.length&&(e.secure_backup_setup_methods.includes(v.Key)||e.secure_backup_setup_methods.includes(v.Passphrase))?e.secure_backup_setup_methods:[v.Key,v.Passphrase]}!function(e){e.Key="key",e.Passphrase="passphrase"}(v||(v={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"d",(function(){return o})),n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"e",(function(){return c}));var i=n(152);let s;function o(e){const t={[s.Invite]:[],[s.Join]:[],[s.Leave]:[]};for(const n of e)t[r(n.getMyMembership())].push(n);return t}function r(e){return"invite"===e?s.Invite:"join"===e?s.Join:s.Leave}function a(e){const t=r(e);return t===s.Join||t===s.Invite}async function c(e,t,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{timeout:1500};const{timeout:o}=s;let r;return new Promise((s=>{r=function(e,i,o){o.userId===n&&o.roomId===t&&s(!0)},e.on(i.b.NewMember,r),window.setTimeout(s,o,!1)})).finally((()=>{e.removeListener(i.b.NewMember,r)}))}!function(e){e.Join="JOIN",e.Invite="INVITE",e.Leave="LEAVE"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l),u=n(248);const h=["class","children","tooltip","tooltipClass","tooltipProps"];class m extends c.a.Component{constructor(e){super(e)}render(){const e=this.props,{class:t,children:n,tooltip:i,tooltipClass:o,tooltipProps:a}=e,l=r()(e,h);return c.a.createElement(u.a,s()({onClick:this.props.onClick,tooltipTargetClassName:d()("mx_TextWithTooltip_target",t)},a,{label:i,tooltipClassName:o,className:"mx_TextWithTooltip_tooltip"},l),n)}}},function(e,t,n){"use strict";var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(587),d=n(811),u=n(163);const h=["children","tooltipTargetClassName","className","id","label","alignment","tooltipClassName","maxParentWidth","ignoreHover"];t.a=e=>{let{children:t,tooltipTargetClassName:n,className:i,id:o,label:a,alignment:m,tooltipClassName:p,maxParentWidth:g,ignoreHover:v}=e,f=r()(e,h);const[b,y]=Object(l.a)(),[S,E]=Object(d.a)(v||(()=>!1)),w=(b||S)&&c.a.createElement(u.b,{id:o,className:i,tooltipClassName:p,label:a,alignment:m,visible:b||S,maxParentWidth:g});return c.a.createElement("div",s()({},E,y,{tabIndex:0,"aria-describedby":o,className:n},f),t,w)}},function(e,t,n){"use strict";n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return m})),n.d(t,"c",(function(){return p}));var i=n(122),s=n.n(i),o=n(17),r=n.n(o),a=n(1),c=n(126),l=n(138),d=n(123),u=n(121);let h,m;!function(e){e.AudioOutput="audiooutput",e.AudioInput="audioinput",e.VideoInput="videoinput"}(h||(h={})),function(e){e.AudioOutputChanged="audio_output_changed"}(m||(m={}));class p extends r.a{static get instance(){return p.internalInstance||(p.internalInstance=new p),p.internalInstance}static async hasAnyLabeledDevices(){return(await navigator.mediaDevices.enumerateDevices()).some((e=>Boolean(e.label)))}static async getDevices(){try{const e=await navigator.mediaDevices.enumerateDevices(),t={[h.AudioOutput]:[],[h.AudioInput]:[],[h.VideoInput]:[]};return e.forEach((e=>t[e.kind].push(e))),t}catch(e){a.a.warn("Unable to refresh WebRTC Devices: ",e)}}static async loadDevices(){const e=c.b.getValue("webrtc_audioinput"),t=c.b.getValue("webrtc_videoinput");await d.a.get().getMediaHandler().setAudioInput(e),await d.a.get().getMediaHandler().setVideoInput(t),await p.updateAudioSettings()}static async updateAudioSettings(){await d.a.get().getMediaHandler().setAudioSettings({autoGainControl:p.getAudioAutoGainControl(),echoCancellation:p.getAudioEchoCancellation(),noiseSuppression:p.getAudioNoiseSuppression()})}setAudioOutput(e){c.b.setValue("webrtc_audiooutput",null,l.a.DEVICE,e),this.emit(m.AudioOutputChanged,e)}async setAudioInput(e){return c.b.setValue("webrtc_audioinput",null,l.a.DEVICE,e),d.a.get().getMediaHandler().setAudioInput(e)}async setVideoInput(e){return c.b.setValue("webrtc_videoinput",null,l.a.DEVICE,e),d.a.get().getMediaHandler().setVideoInput(e)}async setDevice(e,t){switch(t){case h.AudioOutput:this.setAudioOutput(e);break;case h.AudioInput:await this.setAudioInput(e);break;case h.VideoInput:await this.setVideoInput(e)}}static async setAudioAutoGainControl(e){await c.b.setValue("webrtc_audio_autoGainControl",null,l.a.DEVICE,e),await p.updateAudioSettings()}static async setAudioEchoCancellation(e){await c.b.setValue("webrtc_audio_echoCancellation",null,l.a.DEVICE,e),await p.updateAudioSettings()}static async setAudioNoiseSuppression(e){await c.b.setValue("webrtc_audio_noiseSuppression",null,l.a.DEVICE,e),await p.updateAudioSettings()}static getAudioOutput(){return c.b.getValueAt(l.a.DEVICE,"webrtc_audiooutput")}static getAudioInput(){return c.b.getValueAt(l.a.DEVICE,"webrtc_audioinput")}static getVideoInput(){return c.b.getValueAt(l.a.DEVICE,"webrtc_videoinput")}static getAudioAutoGainControl(){return c.b.getValue("webrtc_audio_autoGainControl")}static getAudioEchoCancellation(){return c.b.getValue("webrtc_audio_echoCancellation")}static getAudioNoiseSuppression(){return c.b.getValue("webrtc_audio_noiseSuppression")}static getDevice(e){switch(e){case h.AudioOutput:return this.getAudioOutput();case h.AudioInput:return this.getAudioInput();case h.VideoInput:return this.getVideoInput()}}static get startWithAudioMuted(){return c.b.getValue("audioInputMuted")}static set startWithAudioMuted(e){c.b.setValue("audioInputMuted",null,l.a.DEVICE,e)}static get startWithVideoMuted(){return c.b.getValue("videoInputMuted")}static set startWithVideoMuted(e){c.b.setValue("videoInputMuted",null,l.a.DEVICE,e)}}s()(p,"internalInstance",void 0),s()(p,"getDefaultDevice",(e=>e.some((e=>"default"===e.deviceId))?"default":(e.unshift({deviceId:"",label:Object(u.a)("Default Device")}),"")))},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(126),c=n(268),l=n(163),d=n(121),u=n(205),h=n(857);class m extends r.a.PureComponent{constructor(e){super(e),s()(this,"countWatcherRef",void 0),s()(this,"countPreferenceChanged",(()=>{this.setState({showCounts:a.b.getValue("Notifications.alwaysShowBadgeCounts",this.roomId)})})),s()(this,"onNotificationUpdate",(()=>{this.forceUpdate()})),s()(this,"onMouseOver",(e=>{e.stopPropagation(),this.setState({showTooltip:!0})})),s()(this,"onMouseLeave",(()=>{this.setState({showTooltip:!1})})),this.props.notification.on(c.b.Update,this.onNotificationUpdate),this.state={showCounts:a.b.getValue("Notifications.alwaysShowBadgeCounts",this.roomId),showTooltip:!1},this.countWatcherRef=a.b.watchSetting("Notifications.alwaysShowBadgeCounts",this.roomId,this.countPreferenceChanged)}get roomId(){return this.props.roomId||null}componentWillUnmount(){a.b.unwatchSetting(this.countWatcherRef),this.props.notification.off(c.b.Update,this.onNotificationUpdate)}componentDidUpdate(e){e.notification&&e.notification.off(c.b.Update,this.onNotificationUpdate),this.props.notification.on(c.b.Update,this.onNotificationUpdate)}render(){const{notification:e,showUnsentTooltip:t,forceCount:n,onClick:i}=this.props;if(e.isIdle)return null;if(n&&!e.hasUnreadCount)return null;let s,o;return t&&this.state.showTooltip&&e.color===u.a.Unsent&&(s=Object(d.a)("Message didn't send. Click for info."),o=r.a.createElement(l.b,{className:"mx_RoleButton_tooltip",label:s})),r.a.createElement(h.a,{label:s,symbol:e.symbol,count:e.count,color:e.color,onClick:i,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},o)}}},function(e,t,n){"use strict";n.r(t),n.d(t,"CHAT_EFFECTS",(function(){return s}));var i=n(121);const s=[{emojis:["🎊","🎉"],msgType:"nic.custom.confetti",command:"confetti",description:()=>Object(i.c)("Sends the given message with confetti"),fallbackMessage:()=>Object(i.a)("sends confetti")+" 🎉",options:{maxCount:150,speed:3,frameInterval:15,alpha:1,gradient:!1}},{emojis:["🎆"],msgType:"nic.custom.fireworks",command:"fireworks",description:()=>Object(i.c)("Sends the given message with fireworks"),fallbackMessage:()=>Object(i.a)("sends fireworks")+" 🎆",options:{maxCount:500,gravity:.05}},{emojis:["🌧️","⛈️","🌦️"],msgType:"io.element.effect.rainfall",command:"rainfall",description:()=>Object(i.c)("Sends the given message with rainfall"),fallbackMessage:()=>Object(i.a)("sends rainfall")+" 🌧️",options:{maxCount:600,speed:10}},{emojis:["❄","🌨"],msgType:"io.element.effect.snowfall",command:"snowfall",description:()=>Object(i.c)("Sends the given message with snowfall"),fallbackMessage:()=>Object(i.a)("sends snowfall")+" ❄",options:{maxCount:200,gravity:.05,maxDrift:5}},{emojis:["👾","🌌"],msgType:"io.element.effects.space_invaders",command:"spaceinvaders",description:()=>Object(i.c)("Sends the given message with a space themed effect"),fallbackMessage:()=>Object(i.a)("sends space invaders")+" 👾",options:{maxCount:50,gravity:.01}},{emojis:["💝"],msgType:"io.element.effect.hearts",command:"hearts",description:()=>Object(i.c)("Sends the given message with hearts"),fallbackMessage:()=>Object(i.a)("sends hearts")+" 💝",options:{maxCount:120,gravity:3.2}}]},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(120);function s(e,t,n){const[s,o]=Object(i.useState)(n);return Object(i.useEffect)((()=>{let t=!1;return e().then((e=>{t||o(e)})),()=>{t=!0}}),t),s}},function(e,t,n){"use strict";n.d(t,"d",(function(){return j})),n.d(t,"b",(function(){return P})),n.d(t,"k",(function(){return D})),n.d(t,"e",(function(){return N})),n.d(t,"g",(function(){return M})),n.d(t,"c",(function(){return A})),n.d(t,"i",(function(){return L})),n.d(t,"f",(function(){return U})),n.d(t,"h",(function(){return F})),n.d(t,"a",(function(){return B})),n.d(t,"j",(function(){return V}));var i=n(120),s=n.n(i),o=n(130),r=n(161),a=n(168),c=n(128),l=n(626),d=n(221),u=n(121),h=n(865),m=n(216),p=n(236),g=n(1),v=n(136),f=n(124),b=n(133),y=n(288),S=n(628),E=n(403),w=n(864);var _=e=>{let{space:t,onAddExistingSpaceClick:n,onFinished:o}=e;const[a,c]=Object(i.useState)(t),[l,d]=Object(i.useState)(!1),[h,m]=Object(i.useState)(""),p=Object(i.useRef)(),[_,C]=Object(i.useState)(""),O=Object(i.useRef)(),[I,R]=Object(i.useState)(null),[k,x]=Object(i.useState)(""),T=t.getJoinRule();let j=r.c.Restricted;T===r.c.Public&&(j=r.c.Public);const[P,D]=Object(i.useState)(j),N=async e=>{if(e.preventDefault(),!l){if(d(!0),!await p.current.validate({allowEmpty:!1}))return p.current.focus(),p.current.validate({allowEmpty:!1,focused:!0}),void d(!1);if(P===r.c.Public&&!await O.current.validate({allowEmpty:!0}))return O.current.focus(),O.current.validate({allowEmpty:!0,focused:!0}),void d(!1);try{await Object(S.c)(h,P===r.c.Public,_,k,I,{},{parentSpace:a,joinRule:P}),o(!0)}catch(e){g.a.error(e)}}};let M;return P===r.c.Restricted?M=s.a.createElement("p",null,Object(u.a)("Anyone in <SpaceName/> will be able to find and join.",{},{SpaceName:()=>s.a.createElement("b",null,a.name)})):P===r.c.Public?M=s.a.createElement("p",null,Object(u.a)("Anyone will be able to find and join this space, not just members of <SpaceName/>.",{},{SpaceName:()=>s.a.createElement("b",null,a.name)})):P===r.c.Invite&&(M=s.a.createElement("p",null,Object(u.a)("Only people invited will be able to find and join this space."))),s.a.createElement(v.a,{title:s.a.createElement(E.c,{title:Object(u.a)("Create a space"),space:t,value:a,onChange:c}),className:"mx_CreateSubspaceDialog",contentId:"mx_CreateSubspaceDialog",onFinished:o,fixedWidth:!1},s.a.createElement(b.a.Provider,{value:t.client},s.a.createElement("div",{className:"mx_CreateSubspaceDialog_content"},s.a.createElement("div",{className:"mx_CreateSubspaceDialog_betaNotice"},s.a.createElement(y.a,null),Object(u.a)("Add a space to a space you manage.")),s.a.createElement(S.a,{busy:l,onSubmit:N,setAvatar:R,name:h,setName:m,nameFieldRef:p,topic:k,setTopic:x,alias:_,setAlias:C,showAliasField:P===r.c.Public,aliasFieldRef:O},s.a.createElement(w.a,{label:Object(u.a)("Space visibility"),labelInvite:Object(u.a)("Private space (invite only)"),labelPublic:Object(u.a)("Public space"),labelRestricted:Object(u.a)("Visible to space members"),width:478,value:P,onChange:D}),M)),s.a.createElement("div",{className:"mx_CreateSubspaceDialog_footer"},s.a.createElement("div",{className:"mx_CreateSubspaceDialog_footer_prompt"},s.a.createElement("div",null,Object(u.a)("Want to add an existing space instead?")),s.a.createElement(f.a,{kind:"link",onClick:()=>{n(),o()}},Object(u.a)("Add existing space"))),s.a.createElement(f.a,{kind:"primary_outline",disabled:l,onClick:()=>o(!1)},Object(u.a)("Cancel")),s.a.createElement(f.a,{kind:"primary",disabled:l,onClick:N},l?Object(u.a)("Adding…"):Object(u.a)("Add")))))};var C=e=>{let{space:t,onCreateSubspaceClick:n,onFinished:o}=e;const[r,a]=Object(i.useState)(t);return s.a.createElement(v.a,{title:s.a.createElement(E.c,{title:Object(u.a)("Add existing space"),space:t,value:r,onChange:a}),className:"mx_AddExistingToSpaceDialog",contentId:"mx_AddExistingToSpace",onFinished:o,fixedWidth:!1},s.a.createElement(b.a.Provider,{value:t.client},s.a.createElement(E.a,{space:t,onFinished:o,footerPrompt:s.a.createElement(s.a.Fragment,null,s.a.createElement("div",null,Object(u.a)("Want to add a new space instead?")),s.a.createElement(f.a,{onClick:n,kind:"link"},Object(u.a)("Create a new space"))),filterPlaceholder:Object(u.a)("Search for spaces"),spacesRenderer:E.g})))},O=n(125),I=n(129),R=n(135),k=n(223),x=n(158),T=n(155);const j=e=>{const t=e.client.getUserId();return"join"===e.getMyMembership()&&(e.currentState.maySendStateEvent(o.b.RoomAvatar,t)||e.currentState.maySendStateEvent(o.b.RoomName,t)||e.currentState.maySendStateEvent(o.b.RoomTopic,t)||e.currentState.maySendStateEvent(o.b.RoomJoinRules,t))},P=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return{type:o.b.SpaceParent,content:{via:Object(a.b)(e),canonical:t},state_key:e.roomId}};function D(e){O.a.dispatch({action:I.a.OpenSpaceSettings,space:e})}const N=e=>{O.a.dispatch({action:I.a.OpenAddToExistingSpaceDialog,space:e})},M=async(e,t)=>{const n=c.b.createDialog(l.a,{type:t,defaultPublic:e.getJoinRule()===r.c.Public,parentSpace:e}),[i,s]=await n.finished;return i&&await Object(d.b)(s),i},A=e=>("join"===(null==e?void 0:e.getMyMembership())&&e.canInvite(e.client.getUserId())||e.getJoinRule()===r.c.Public)&&Object(k.a)(x.a.InviteUsers),L=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if("public"===e.getJoinRule()){const t=c.b.createDialog(m.a,{title:Object(u.a)("Invite to %(spaceName)s",{spaceName:e.name}),description:s.a.createElement(s.a.Fragment,null,s.a.createElement("span",null,Object(u.a)("Share your public space")),s.a.createElement(h.a,{space:e,onFinished:()=>t.close()})),fixedWidth:!1,button:!1,className:"mx_SpacePanel_sharePublicSpace",hasCloseButton:!0})}else Object(p.e)(e.roomId,t)},U=e=>{c.b.createDialog(C,{space:e,onCreateSubspaceClick:()=>F(e),onFinished:t=>{t&&T.b.instance.roomViewStore.getRoomId()===e.roomId&&O.a.fire(I.a.UpdateSpaceHierarchy)}},"mx_AddExistingToSpaceDialog_wrapper")},F=e=>{c.b.createDialog(_,{space:e,onAddExistingSpaceClick:()=>U(e),onFinished:t=>{t&&T.b.instance.roomViewStore.getRoomId()===e.roomId&&O.a.fire(I.a.UpdateSpaceHierarchy)}},"mx_CreateSubspaceDialog_wrapper")},B=async(e,t,n)=>{const i=c.b.createDialog(R.a,void 0,"mx_Dialog_spinner");try{for(const e of t)await n(e);await n(e)}finally{i.close()}},V=(e,t)=>{O.a.dispatch({action:I.a.OpenSpacePreferences,space:e,initialTabId:t})}},function(e,t,n){"use strict";n.d(t,"d",(function(){return M})),n.d(t,"a",(function(){return A})),n.d(t,"c",(function(){return B})),n.d(t,"e",(function(){return V})),n.d(t,"b",(function(){return K})),n.d(t,"f",(function(){return $}));var i=n(431),s=n(432),o=n(200),r=n(1),a=n(128),c=n(123),l=n(121),d=n(245),u=n(122),h=n.n(u),m=n(150),p=n(127),g=n.n(p),v=n(120),f=n.n(v),b=n(140),y=n(124),S=n(260),E=n(146),w=n(136),_=n(294);class C extends f.a.PureComponent{constructor(e){super(e),h()(this,"fileUpload",f.a.createRef()),h()(this,"onCancel",(()=>{this.state.resetting&&this.setState({resetting:!1}),this.props.onFinished(!1)})),h()(this,"onUseRecoveryKeyClick",(()=>{this.setState({forceRecoveryKey:!0})})),h()(this,"validateRecoveryKeyOnChange",Object(m.debounce)((async()=>{await this.validateRecoveryKey()}),200)),h()(this,"onRecoveryKeyChange",(e=>{this.setState({recoveryKey:e.target.value,recoveryKeyFileError:null}),this.fileUpload.current&&(this.fileUpload.current.value=null),this.validateRecoveryKeyOnChange()})),h()(this,"onRecoveryKeyFileChange",(async e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;const n=e.target.files[0];if(n.size>128)this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1});else{const e=await n.text();/^[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\s]+$/.test(e)?(this.setState({recoveryKeyFileError:null,recoveryKey:e.trim()}),await this.validateRecoveryKey()):this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1,recoveryKey:""})}})),h()(this,"onRecoveryKeyFileUploadClick",(()=>{var e;null===(e=this.fileUpload.current)||void 0===e||e.click()})),h()(this,"onPassPhraseNext",(async e=>{if(e.preventDefault(),this.state.passPhrase.length<=0)return;this.setState({keyMatches:null});const t={passphrase:this.state.passPhrase},n=await this.props.checkPrivateKey(t);n?this.props.onFinished(t):this.setState({keyMatches:n})})),h()(this,"onRecoveryKeyNext",(async e=>{if(e.preventDefault(),!this.state.recoveryKeyValid)return;this.setState({keyMatches:null});const t={recoveryKey:this.state.recoveryKey},n=await this.props.checkPrivateKey(t);n?this.props.onFinished(t):this.setState({keyMatches:n})})),h()(this,"onPassPhraseChange",(e=>{this.setState({passPhrase:e.target.value,keyMatches:null})})),h()(this,"onResetAllClick",(e=>{e.preventDefault(),this.setState({resetting:!0})})),h()(this,"onConfirmResetAllClick",(async()=>{a.b.toggleCurrentDialogVisibility();try{await K((async()=>{const e=c.a.get();await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:n}=a.b.createDialog(S.a,{title:Object(l.a)("Setting up keys"),matrixClient:e,makeRequest:t}),[i]=await n;if(!i)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:!0}),this.props.onFinished({})}),!0)}catch(e){r.a.error(e),this.props.onFinished(!1)}})),this.state={recoveryKey:"",recoveryKeyValid:null,recoveryKeyCorrect:null,recoveryKeyFileError:null,forceRecoveryKey:!1,passPhrase:"",keyMatches:null,resetting:!1}}async validateRecoveryKey(){if(""!==this.state.recoveryKey)try{const e=c.a.get(),t=e.keyBackupKeyFromRecoveryKey(this.state.recoveryKey),n=await e.checkSecretStorageKey(t,this.props.keyInfo);this.setState({recoveryKeyValid:!0,recoveryKeyCorrect:n})}catch(e){this.setState({recoveryKeyValid:!1,recoveryKeyCorrect:!1})}else this.setState({recoveryKeyValid:null,recoveryKeyCorrect:null})}getKeyValidationText(){return this.state.recoveryKeyFileError?Object(l.a)("Wrong file type"):this.state.recoveryKeyCorrect?Object(l.a)("Looks good!"):this.state.recoveryKeyValid?Object(l.a)("Wrong Security Key"):null===this.state.recoveryKeyValid?"":Object(l.a)("Invalid Security Key")}render(){var e,t,n,i;const s=(null===(e=this.props.keyInfo)||void 0===e||null===(t=e.passphrase)||void 0===t?void 0:t.salt)&&(null===(n=this.props.keyInfo)||void 0===n||null===(i=n.passphrase)||void 0===i?void 0:i.iterations),o=f.a.createElement("div",{className:"mx_AccessSecretStorageDialog_reset"},Object(l.a)("Forgotten or lost all recovery methods? <a>Reset all</a>",void 0,{a:e=>f.a.createElement(y.a,{kind:"link_inline",onClick:this.onResetAllClick,className:"mx_AccessSecretStorageDialog_reset_link"},e)}));let r,a,c;if(this.state.resetting)a=Object(l.a)("Reset everything"),c=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_resetBadge"],r=f.a.createElement("div",null,f.a.createElement("p",null,Object(l.a)("Only do this if you have no other device to complete verification with.")),f.a.createElement("p",null,Object(l.a)("If you reset everything, you will restart with no trusted sessions, no trusted users, and might not be able to see past messages.")),f.a.createElement(E.a,{primaryButton:Object(l.a)("Reset"),onPrimaryButtonClick:this.onConfirmResetAllClick,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryButtonClass:"danger"}));else if(s&&!this.state.forceRecoveryKey){let e;a=Object(l.a)("Security Phrase"),c=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_securePhraseTitle"],e=!1===this.state.keyMatches?f.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"},"👎 ",Object(l.a)("Unable to access secret storage. Please verify that you entered the correct Security Phrase.")):f.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"}),r=f.a.createElement("div",null,f.a.createElement("p",null,Object(l.a)("Enter your Security Phrase or <button>use your Security Key</button> to continue.",{},{button:e=>f.a.createElement(y.a,{kind:"link_inline",onClick:this.onUseRecoveryKeyClick},e)})),f.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this.onPassPhraseNext},f.a.createElement(b.a,{id:"mx_passPhraseInput",className:"mx_AccessSecretStorageDialog_passPhraseInput",type:"password",label:Object(l.a)("Security Phrase"),value:this.state.passPhrase,onChange:this.onPassPhraseChange,autoFocus:!0,autoComplete:"new-password"}),e,f.a.createElement(E.a,{primaryButton:Object(l.a)("Continue"),onPrimaryButtonClick:this.onPassPhraseNext,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryDisabled:0===this.state.passPhrase.length,additive:o})))}else{var d;a=Object(l.a)("Security Key"),c=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_secureBackupTitle"];const e=g()({mx_AccessSecretStorageDialog_recoveryKeyFeedback:!0,"mx_AccessSecretStorageDialog_recoveryKeyFeedback--valid":!0===this.state.recoveryKeyCorrect,"mx_AccessSecretStorageDialog_recoveryKeyFeedback--invalid":!1===this.state.recoveryKeyCorrect}),t=f.a.createElement("div",{className:e},this.getKeyValidationText());r=f.a.createElement("div",null,f.a.createElement("p",null,Object(l.a)("Use your Security Key to continue.")),f.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this.onRecoveryKeyNext,spellCheck:!1,autoComplete:"off"},f.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry"},f.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_textInput"},f.a.createElement(b.a,{type:"password",id:"mx_securityKey",label:Object(l.a)("Security Key"),value:this.state.recoveryKey,onChange:this.onRecoveryKeyChange,autoFocus:!0,forceValidity:null!==(d=this.state.recoveryKeyCorrect)&&void 0!==d?d:void 0,autoComplete:"off"})),f.a.createElement("span",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_entryControlSeparatorText"},Object(l.a)("%(securityKey)s or %(recoveryFile)s",{recoveryFile:"",securityKey:""})),f.a.createElement("div",null,f.a.createElement("input",{type:"file",className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_fileInput",ref:this.fileUpload,onClick:_.a,onChange:this.onRecoveryKeyFileChange}),f.a.createElement(y.a,{kind:"primary",onClick:this.onRecoveryKeyFileUploadClick},Object(l.a)("Upload")))),t,f.a.createElement(E.a,{primaryButton:Object(l.a)("Continue"),onPrimaryButtonClick:this.onRecoveryKeyNext,hasCancel:!0,cancelButton:Object(l.a)("Go Back"),cancelButtonClass:"danger",onCancel:this.onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid,additive:o})))}return f.a.createElement(w.a,{className:"mx_AccessSecretStorageDialog",onFinished:this.props.onFinished,title:a,titleClass:c},f.a.createElement("div",null,r))}}var O=n(373),I=n(126),R=n(295),k=n(157);let x={},T={},j=!1,P=!1,D={};function N(){return j}function M(){return j}class A extends Error{constructor(){super("Secret storage access canceled")}}async function L(){const[e]=await a.b.createDialog(k.a,{title:Object(l.a)("Cancel entering passphrase?"),description:Object(l.a)("Are you sure you want to cancel entering passphrase?"),danger:!1,button:Object(l.a)("Go Back"),cancelButton:Object(l.a)("Cancel")}).finished;return!e}function U(e){return async t=>{let{passphrase:n,recoveryKey:o}=t;return n?Object(i.a)(n,e.passphrase.salt,e.passphrase.iterations):Object(s.a)(o)}}function F(e,t,n){N()&&(x[e]=n,T[e]=t)}const B={getSecretStorageKey:async function(e){var t;let{keys:n}=e;const i=c.a.get();let s,o=await i.getDefaultSecretStorageKeyId();if(o&&(s=n[o],s||(o=null)),!o){const e=Object.entries(n);if(e.length>1)throw new Error("Multiple storage key requests not implemented");[o,s]=e[0]}if(N()&&x[o])return[o,x[o]];if(D.key&&await c.a.get().checkSecretStorageKey(D.key,s))return F(o,s,D.key),[o,D.key];const l=null===(t=R.a.getSecretStorageKey)||void 0===t?void 0:t.call(R.a);if(l)return r.a.log("Using key from security customisations (secret storage)"),F(o,s,l),[o,l];if(P)throw new Error("Could not unlock non-interactively");const d=U(s),{finished:u}=a.b.createDialog(C,{keyInfo:s,checkPrivateKey:async e=>{const t=await d(e);return c.a.get().checkSecretStorageKey(t,s)}},void 0,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||L()}),[h]=await u;if(!h)throw new A;const m=await d(h);return F(o,s,m),[o,m]},cacheSecretStorageKey:F,onSecretRequested:async function(e,t,n,i,s){r.a.log("onSecretRequested",e,t,n,i,s);const a=c.a.get();if(e===a.getUserId())if(null!=s&&s.isVerified()){if("m.cross_signing.master"===i||"m.cross_signing.self_signing"===i||"m.cross_signing.user_signing"===i){const e=a.getCrossSigningCacheCallbacks();if(null==e||!e.getCrossSigningKeyCache)return;const n=i.replace("m.cross_signing.",""),s=await e.getCrossSigningKeyCache(n);return s||r.a.log(`${n} requested by ${t}, but not found in cache`),s?Object(o.encodeBase64)(s):void 0}if("m.megolm_backup.v1"===i){var l;const e=await(null===(l=a.crypto)||void 0===l?void 0:l.getSessionBackupPrivateKey());return e||r.a.log(`session backup key requested by ${t}, but not found in cache`),e?Object(o.encodeBase64)(e):void 0}r.a.warn("onSecretRequested didn't recognise the secret named ",i)}else r.a.log(`Ignoring secret request from untrusted device ${t}`)},getDehydrationKey:async function(e,t){var n;const i=null===(n=R.a.getSecretStorageKey)||void 0===n?void 0:n.call(R.a);if(i)return r.a.log("Using key from security customisations (dehydration)"),i;const s=U(e),{finished:o}=a.b.createDialog(C,{keyInfo:e,checkPrivateKey:async e=>{const n=await s(e);try{return t(n),!0}catch(e){return!1}}},void 0,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||L()}),[c]=await o;if(!c)throw new A;const l=await s(c);return D={key:new Uint8Array(l),keyInfo:e},l}};async function V(){let e;const{finished:t}=a.b.createDialog(O.a,{showSummary:!1,keyCallback:t=>e=t},void 0,!1,!0);if(!await t)throw new Error("Key backup prompt cancelled");return e}async function K(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:async()=>{},t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=c.a.get();j=!0;try{if(!await i.hasSecretStorageKey()||t){const{finished:e}=a.b.createDialogAsync(n.e(32).then(n.bind(null,1729)),{forceReset:t},void 0,!1,!0,{onBeforeClose:async e=>"backgroundClick"!==e||!Object(d.g)()}),[i]=await e;if(!i)throw new Error("Secret storage creation canceled")}else{await i.bootstrapCrossSigning({authUploadDeviceSigningKeys:async e=>{const{finished:t}=a.b.createDialog(S.a,{title:Object(l.a)("Setting up keys"),matrixClient:i,makeRequest:e}),[n]=await t;if(!n)throw new Error("Cross-signing key upload auth canceled")}}),await i.bootstrapSecretStorage({getKeyBackupPassphrase:V});const e=Object.keys(x)[0];if(e&&I.b.getValue("feature_dehydration")){let t={};T[e]&&T[e].passphrase&&(t={passphrase:T[e].passphrase}),r.a.log("Setting dehydration key"),await i.setDehydrationKey(x[e],t,"Backup device")}else e?r.a.log("Not setting dehydration key: feature disabled"):r.a.warn("Not setting dehydration key: no SSSS key found")}return await e()}catch(e){var s;throw null===(s=R.a.catchAccessSecretStorageError)||void 0===s||s.call(R.a,e),r.a.error(e),e}finally{j=!1,N()||(x={},T={})}}async function $(e){const t=D.key;let n=!1;if(t&&await e.isSecretStorageReady()){r.a.log("Trying to set up cross-signing using dehydration key"),j=!0,P=!0;try{await e.checkOwnCrossSigningTrust();let i={};D.keyInfo&&D.keyInfo.passphrase&&(i={passphrase:D.keyInfo.passphrase}),await e.setDehydrationKey(t,i,"Backup device");const s=await e.getKeyBackupVersion();s&&(n=!0,e.restoreKeyBackupWithSecretStorage(s).finally((()=>{j=!1,P=!1,N()||(x={},T={})})))}finally{D={},n||(j=!1,P=!1,N()||(x={},T={}))}}}},function(e,t,n){"use strict";n.d(t,"d",(function(){return p})),n.d(t,"b",(function(){return g})),n.d(t,"a",(function(){return v})),n.d(t,"c",(function(){return f}));var i=n(122),s=n.n(i),o=n(17),r=n.n(o),a=n(204),c=n(1),l=n(154),d=n(147);class u{constructor(e){var t=this;this.context=e,s()(this,"clipStart",0),s()(this,"stopped",!0),s()(this,"lastCheck",0),s()(this,"observable",new a.SimpleObservable),s()(this,"timerId",void 0),s()(this,"clipDuration",0),s()(this,"placeholderDuration",0),s()(this,"checkTime",(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const n=t.timeSeconds;(t.lastCheck!==n||e)&&(t.observable.update([n,t.durationSeconds]),t.lastCheck=n)}))}get durationSeconds(){return this.clipDuration||this.placeholderDuration}set durationSeconds(e){this.clipDuration=e,this.observable.update([this.timeSeconds,this.clipDuration])}get timeSeconds(){return(this.context.currentTime-this.clipStart)%this.clipDuration}get liveData(){return this.observable}populatePlaceholdersFrom(e){var t;const n=Number(null===(t=e.getContent().info)||void 0===t?void 0:t.duration);Number.isFinite(n)&&(this.placeholderDuration=n/1e3)}flagLoadTime(){this.clipStart=this.context.currentTime}flagStart(){this.stopped&&(this.clipStart=this.context.currentTime,this.stopped=!1),this.timerId||(this.timerId=window.setInterval(this.checkTime,100))}flagStop(){this.stopped=!0,this.clipStart=this.context.currentTime}syncTo(e,t){this.clipStart=e-t,this.stopped=!1,this.checkTime(!0)}destroy(){this.observable.close(),this.timerId&&clearInterval(this.timerId)}}var h=n(820),m=n(293);let p;!function(e){e.Decoding="decoding",e.Stopped="stopped",e.Paused="paused",e.Playing="playing"}(p||(p={}));const g=39,v=Object(d.h)(0,g);class f extends r.a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:v;super(),this.buf=e,s()(this,"thumbnailWaveform",void 0),s()(this,"context",void 0),s()(this,"source",void 0),s()(this,"state",p.Decoding),s()(this,"audioBuf",void 0),s()(this,"element",void 0),s()(this,"resampledWaveform",void 0),s()(this,"waveformObservable",new a.SimpleObservable),s()(this,"clock",void 0),s()(this,"fileSize",void 0),s()(this,"onPlaybackEnd",(async()=>{await this.context.suspend(),this.emit(p.Stopped)})),this.fileSize=this.buf.byteLength,this.context=Object(h.a)(),this.resampledWaveform=Object(d.c)(null!=t?t:v,g),this.thumbnailWaveform=Object(d.c)(null!=t?t:v,100),this.waveformObservable.update(this.resampledWaveform),this.clock=new u(this.context)}get sizeBytes(){return this.fileSize}get waveform(){return this.resampledWaveform}get waveformData(){return this.waveformObservable}get clockInfo(){return this.clock}get liveData(){return this.clock.liveData}get timeSeconds(){return this.clock.timeSeconds}get durationSeconds(){return this.clock.durationSeconds}get currentState(){return this.state}get isPlaying(){return this.currentState===p.Playing}emit(e){this.state=e;for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n),super.emit(l.b,e,...n),!0}destroy(){this.stop(),this.removeAllListeners(),this.clock.destroy(),this.waveformObservable.close(),this.element&&(URL.revokeObjectURL(this.element.src),this.element.remove())}async prepare(){if(this.state===p.Decoding){if(this.buf.byteLength>5242880){c.a.log("Audio file too large: processing through <audio /> element"),this.element=document.createElement("AUDIO");const e=new Promise(((e,t)=>{this.element.onloadeddata=()=>e(null),this.element.onerror=e=>t(e)}));this.element.src=URL.createObjectURL(new Blob([this.buf])),await e}else{this.audioBuf=await new Promise(((e,t)=>{this.context.decodeAudioData(this.buf,(t=>e(t)),(async n=>{try{c.a.error("Error decoding recording: ",n),c.a.warn("Trying to re-encode to WAV instead...");const i=await Object(h.b)(this.buf);this.context.decodeAudioData(i,(t=>e(t)),(e=>{c.a.error("Still failed to decode recording: ",e),t(e)}))}catch(n){c.a.error("Caught decoding error:",n),t(n)}}))}));const e=Array.from(this.audioBuf.getChannelData(0));this.resampledWaveform=function(e){const t=e.map((e=>Math.abs(e)));return Object(d.g)(Object(d.i)(t,g),0,1)}(e)}this.waveformObservable.update(this.resampledWaveform),this.clock.flagLoadTime(),this.clock.durationSeconds=this.element?this.element.duration:this.audioBuf.duration,this.emit(p.Stopped)}}async play(){this.state===p.Stopped&&(this.disconnectSource(),this.makeNewSourceBuffer(),this.element?await this.element.play():this.source.start()),await this.context.resume(),this.clock.flagStart(),this.emit(p.Playing)}disconnectSource(){var e,t;this.element||(null===(e=this.source)||void 0===e||e.disconnect(),null===(t=this.source)||void 0===t||t.removeEventListener("ended",this.onPlaybackEnd))}makeNewSourceBuffer(){this.element&&this.source||(this.element?this.source=this.context.createMediaElementSource(this.element):(this.source=this.context.createBufferSource(),this.source.buffer=this.audioBuf),this.source.addEventListener("ended",this.onPlaybackEnd),this.source.connect(this.context.destination))}async pause(){await this.context.suspend(),this.emit(p.Paused)}async stop(){await this.onPlaybackEnd(),this.clock.flagStop()}async toggle(){this.isPlaying?await this.pause():await this.play()}async skipTo(e){e=Object(m.a)(e,0,this.clock.durationSeconds);const t=this.isPlaying;t&&await this.context.suspend();const n=this.context.currentTime;this.disconnectSource(),this.makeNewSourceBuffer(),this.clock.syncTo(n,e),this.element?this.element.currentTime=e:this.source.start(n,e),t?await this.context.resume():await this.pause()}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return f})),n.d(t,"c",(function(){return x})),n.d(t,"a",(function(){return j}));var i=n(122),s=n.n(i),o=n(150),r=n(571),a=n.n(r),c=n(1);class l{constructor(e,t,n,i){this.updateCallback=e,this.getAutocompleterComponent=t,this.updateQuery=n,this.partCreator=i,s()(this,"partIndex",void 0)}onEscape(e){this.getAutocompleterComponent().onEscape(e)}close(){this.updateCallback({close:!0})}hasSelection(){return this.getAutocompleterComponent().hasSelection()}hasCompletions(){const e=this.getAutocompleterComponent();return e&&e.countCompletions()>0}confirmCompletion(){this.getAutocompleterComponent().onConfirmCompletion(),this.updateCallback({close:!0})}async startSelection(){const e=this.getAutocompleterComponent();0===e.countCompletions()&&await e.forceComplete()}selectPreviousSelection(){this.getAutocompleterComponent().moveSelection(-1)}selectNextSelection(){this.getAutocompleterComponent().moveSelection(1)}onPartUpdate(e,t){return this.partIndex=t.index,this.updateQuery(e.text)}onComponentConfirm(e){this.updateCallback({replaceParts:this.partForCompletion(e),close:!0})}partForCompletion(e){const{completionId:t}=e,n=e.completion;switch(e.type){case"room":return[this.partCreator.roomPill(n,t),this.partCreator.plain(e.suffix)];case"at-room":return[this.partCreator.atRoomPill(t),this.partCreator.plain(e.suffix)];case"user":return this.partCreator.createMentionParts(0===this.partIndex,n,t);case"command":return[this.partCreator.command(n)];case"customEmoji":return[this.partCreator.customEmoji(n,t)];default:return this.partCreator.plainWithEmoji(n)}}}var d=n(199),u=n(262),h=n(125),m=n(129),p=n(126),g=n(160);const v=String.fromCodePoint(8203);let f;!function(e){e.Plain="plain",e.Newline="newline",e.Emoji="emoji",e.CustomEmoji="custom-emoji",e.Command="command",e.UserPill="user-pill",e.RoomPill="room-pill",e.AtRoomPill="at-room-pill",e.PillCandidate="pill-candidate"}(f||(f={}));class b{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";s()(this,"_text",void 0),this._text=e}acceptsInsertion(e,t,n){return!0}acceptsRemoval(e,t){return!0}merge(e){return!1}split(e){const t=this.text.slice(e);return this._text=this.text.slice(0,e),new S(t)}remove(e,t){const n=this.text.slice(0,e)+this.text.slice(e+t);for(let i=e;i<t+e;++i){const e=this.text.charAt(i);if(!this.acceptsRemoval(i,e))return n}this._text=n}appendUntilRejected(e,t){const n=this.text.length;let i=e;for(;i;){const[s]=Object(o.split)(i,"",2);if(!this.acceptsInsertion(s,n+e.length-i.length,t))break;i=i.slice(s.length)}return this._text+=e.slice(0,e.length-i.length),i||void 0}validateAndInsert(e,t,n){for(let i=0;i<t.length;++i){const s=t.charAt(i);if(!this.acceptsInsertion(s,e+i,n))return!1}const i=this._text.slice(0,e),s=this._text.slice(e);return this._text=i+t+s,!0}createAutoComplete(e){}trim(e){const t=this._text.slice(e);return this._text=this._text.slice(0,e),t}get text(){return this._text}get canEdit(){return!0}get acceptsCaret(){return this.canEdit}toString(){return`${this.type}(${this.text})`}serialize(){return{type:this.type,text:this.text}}}class y extends b{acceptsInsertion(e,t,n){return"\n"!==e&&!a.a.test(e)&&("insertFromPaste"===n||"insertFromDrop"===n||("@"!==e&&"#"!==e&&":"!==e&&"+"!==e||0!==t&&(" "!==this._text[t-1]&&this._text[t-1]!==v&&("+"!==this._text[t-1]||":"!==e))))}toDOMNode(){return document.createTextNode(this.text)}merge(e){return e.type===this.type&&(this._text=this.text+e.text,!0)}updateDOMNode(e){e.textContent!==this.text&&(e.textContent=this.text)}canUpdateDOMNode(e){return e.nodeType===Node.TEXT_NODE}}class S extends y{get type(){return f.Plain}}class E extends b{constructor(e,t){super(t),this.resourceId=e,s()(this,"onClick",void 0)}acceptsInsertion(e){return" "!==e}acceptsRemoval(e,t){return 0!==e}toDOMNode(){const e=document.createElement("span");return e.setAttribute("spellcheck","false"),e.setAttribute("contentEditable","false"),e.onclick=this.onClick,e.className=this.className,e.appendChild(document.createTextNode(this.text)),this.setAvatar(e),e}updateDOMNode(e){const t=e.childNodes[0];t.textContent!==this.text&&(t.textContent=this.text),e.className!==this.className&&(e.className=this.className),e.onclick!==this.onClick&&(e.onclick=this.onClick),this.setAvatar(e)}canUpdateDOMNode(e){return e.nodeType===Node.ELEMENT_NODE&&"SPAN"===e.nodeName&&1===e.childNodes.length&&e.childNodes[0].nodeType===Node.TEXT_NODE}setAvatarVars(e,t,n){const i=`url('${t}')`,s=`'${n}'`;e.style.getPropertyValue("--avatar-background")!==i&&e.style.setProperty("--avatar-background",i),e.style.getPropertyValue("--avatar-letter")!==s&&e.style.setProperty("--avatar-letter",s)}serialize(){return{type:this.type,text:this.text,resourceId:this.resourceId}}get canEdit(){return!1}}class w extends b{acceptsInsertion(e,t){return 0===t&&"\n"===e}acceptsRemoval(e,t){return!0}toDOMNode(){return document.createElement("br")}merge(){return!1}updateDOMNode(){}canUpdateDOMNode(e){return"BR"===e.tagName}get type(){return f.Newline}get canEdit(){return!1}}class _ extends b{acceptsInsertion(e,t){return a.a.test(e)}acceptsRemoval(e,t){return!1}toDOMNode(){const e=document.createElement("span");return e.className="mx_Emoji",e.setAttribute("title",Object(d.k)(this.text)),e.appendChild(document.createTextNode(this.text)),e}updateDOMNode(e){const t=e.childNodes[0];t.textContent!==this.text&&(e.setAttribute("title",Object(d.k)(this.text)),t.textContent=this.text)}canUpdateDOMNode(e){return"mx_Emoji"===e.className}get type(){return f.Emoji}get canEdit(){return!1}get acceptsCaret(){return!0}}class C extends E{get className(){return"mx_CustomEmojiPill mx_Pill"}setAvatar(e){let t;try{t=Object(g.b)(this.resourceId).getThumbnailOfSourceHttp(24,24,"crop")}catch(e){c.a.error(e)}this.setAvatarVars(e,t,this.text[0])}constructor(e,t){super(t,e)}acceptsInsertion(e){return!1}acceptsRemoval(e,t){return!1}get type(){return f.CustomEmoji}get canEdit(){return!1}}class O extends E{constructor(e,t,n){super(e,t),this.room=n}setAvatar(e){var t;let n="",i=u.b(null!==(t=this.room)&&void 0!==t?t:null,16,16,"crop");var s,o,r,a;i||(n=null!==(s=u.e((null===(o=this.room)||void 0===o?void 0:o.name)||this.resourceId))&&void 0!==s?s:"",i=u.d(null!==(r=null===(a=this.room)||void 0===a?void 0:a.roomId)&&void 0!==r?r:this.resourceId));this.setAvatarVars(e,i,n)}get type(){return f.RoomPill}get className(){var e;return"mx_Pill "+(null!==(e=this.room)&&void 0!==e&&e.isSpaceRoom()?"mx_SpacePill":"mx_RoomPill")}}class I extends O{constructor(e,t){super(e,e,t)}get type(){return f.AtRoomPill}serialize(){return{type:this.type,text:this.text}}}class R extends E{constructor(e,t,n){super(e,t),this.member=n,s()(this,"onClick",(()=>{h.a.dispatch({action:m.a.ViewUser,member:this.member})}))}get type(){return f.UserPill}get className(){return"mx_UserPill mx_Pill"}setAvatar(e){if(!this.member)return;const t=this.member.name||this.member.userId,n=u.d(this.member.userId),i=u.a(this.member,16,16,"crop");let s="";var o;i===n&&(s=null!==(o=u.e(t))&&void 0!==o?o:"");this.setAvatarVars(e,i,s)}}class k extends y{constructor(e,t){super(e),this.autoCompleteCreator=t}createAutoComplete(e){return this.autoCompleteCreator.create(e)}acceptsInsertion(e,t,n){return 0===t||super.acceptsInsertion(e,t,n)}merge(){return!1}acceptsRemoval(e,t){return!0}get type(){return f.PillCandidate}}function x(e,t){return n=>i=>new l(i,e,t,n)}class T{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.room=e,this.client=t,s()(this,"autoCompleteCreator",void 0),this.autoCompleteCreator={create:null==n?void 0:n(this)}}setAutoCompleteCreator(e){this.autoCompleteCreator.create=e(this)}createPartForInput(e,t,n){switch(e[0]){case"#":case"@":case":":case"+":return this.pillCandidate("");case"\n":return new w;default:return a.a.test(Object(o.split)(e,"",2)[0])?new _:new S}}createDefaultPart(e){return this.plain(e)}deserializePart(e){switch(e.type){case f.Plain:return this.plain(e.text);case f.Newline:return this.newline();case f.Emoji:return this.emoji(e.text);case f.CustomEmoji:return this.customEmoji(e.text,e.resourceId);case f.AtRoomPill:return this.atRoomPill(e.text);case f.PillCandidate:return this.pillCandidate(e.text);case f.RoomPill:return this.roomPill(e.resourceId);case f.UserPill:return this.userPill(e.text,e.resourceId)}}plain(e){return new S(e)}newline(){return new w("\n")}emoji(e){return new _(e)}pillCandidate(e){return new k(e,this.autoCompleteCreator)}roomPill(e,t){let n;var i;t||"#"!==e[0]?n=null!==(i=this.client.getRoom(t||e))&&void 0!==i?i:void 0:n=this.client.getRooms().find((t=>t.getCanonicalAlias()===e||t.getAltAliases().includes(e)));return new O(e,n?n.name:e,n)}atRoomPill(e){return new I(e,this.room)}userPill(e,t){const n=this.room.getMember(t);return new R(t,e,n||void 0)}static isRegionalIndicator(e){var t;const n=null!==(t=e.codePointAt(0))&&void 0!==t?t:0;return 0!=n&&2==e.length&&127462<=n&&n<=127487}plainWithEmoji(e){const t=[];let n="";for(const i of Object(o.split)(e,""))a.a.test(i)?(n&&(t.push(this.plain(n)),n=""),t.push(this.emoji(i)),T.isRegionalIndicator(e)&&t.push(this.plain(v))):n+=i;return n&&t.push(this.plain(n)),t}customEmoji(e,t){return new C(e,t)}createMentionParts(e,t,n){const i=this.userPill(t,n);p.b.getValue("MessageComposerInput.insertTrailingColon")||(e=!1);return[i,this.plain(e?": ":" ")]}}class j extends T{createPartForInput(e,t){return 0===t&&"/"===e[0]?this.command(""):super.createPartForInput(e,t)}command(e){return new P(e,this.autoCompleteCreator)}deserializePart(e){return e.type===f.Command?this.command(e.text):super.deserializePart(e)}}class P extends k{get type(){return f.Command}}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(121),c=n(124),l=n(540),d=n(324),u=n(136);class h extends r.a.Component{constructor(e){super(e),s()(this,"onAuthFinished",((e,t)=>{e?this.props.onFinished(!0,t):t===l.a?this.props.onFinished(!1,null):this.setState({authError:t})})),s()(this,"onUpdateStagePhase",((e,t)=>{this.setState({uiaStage:e,uiaStagePhase:t})})),s()(this,"onDismissClick",(()=>{this.props.onFinished(!1)})),this.state={authError:null,uiaStage:null,uiaStagePhase:null}}getDefaultDialogAesthetics(){const e={[d.c.PHASE_PREAUTH]:{title:Object(a.a)("Use Single Sign On to continue"),body:Object(a.a)("To continue, use Single Sign On to prove your identity."),continueText:Object(a.a)("Single Sign On"),continueKind:"primary"},[d.c.PHASE_POSTAUTH]:{title:Object(a.a)("Confirm to continue"),body:Object(a.a)("Click the button below to confirm your identity."),continueText:Object(a.a)("Confirm"),continueKind:"primary"}};return{[d.c.LOGIN_TYPE]:e,[d.c.UNSTABLE_LOGIN_TYPE]:e}}render(){let e,t,n=this.state.authError?"Error":this.props.title||Object(a.a)("Authentication"),i=this.state.authError?null:this.props.body;const s=this.props.aestheticsForStagePhases||this.getDefaultDialogAesthetics();if(!this.state.authError&&s&&null!==this.state.uiaStage&&null!==this.state.uiaStagePhase&&s[this.state.uiaStage]){const o=s[this.state.uiaStage][this.state.uiaStagePhase];o&&(o.title&&(n=o.title),o.body&&(i=o.body),o.continueText&&(e=o.continueText),o.continueKind&&(t=o.continueKind))}let o;return o=this.state.authError?r.a.createElement("div",{id:"mx_Dialog_content"},r.a.createElement("div",{role:"alert"},this.state.authError.message||this.state.authError.toString()),r.a.createElement("br",null),r.a.createElement(c.a,{onClick:this.onDismissClick,className:"mx_GeneralButton",autoFocus:!0},Object(a.a)("Dismiss"))):r.a.createElement("div",{id:"mx_Dialog_content"},i,r.a.createElement(l.b,{matrixClient:this.props.matrixClient,authData:this.props.authData,makeRequest:this.props.makeRequest,onAuthFinished:this.onAuthFinished,onStagePhaseChange:this.onUpdateStagePhase,continueText:e,continueKind:t})),r.a.createElement(u.a,{className:"mx_InteractiveAuthDialog",onFinished:this.props.onFinished,title:n,contentId:"mx_Dialog_content"},o)}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return c})),n.d(t,"d",(function(){return d})),n.d(t,"e",(function(){return u})),n.d(t,"b",(function(){return h}));var i=n(150),s=n(164),o=n(160),r=n(220);function a(e,t,n,i){let s;return null!=e&&e.getMxcAvatarUrl()&&(s=Object(o.b)(e.getMxcAvatarUrl()).getThumbnailOfSourceHttp(t,n,i)),s||(s=d(e?e.userId:"")),s}function c(e,t,n,i){return e.avatarUrl?Object(o.b)(e.avatarUrl).getThumbnailOfSourceHttp(t,n,i):null}const l=new Map;function d(e){if(!e)return"";const t=["#8BC34A","#368bd6","#ac3ba8"];let n=0;for(let t=0;t<e.length;++t)n+=e.charCodeAt(t);const i=n%t.length,s=`--avatar-background-colors_${i}`,o=document.body.style.getPropertyValue(s)||t[i];let r=l.get(o);return r||(!function(e){return"string"==typeof e&&(7===e.length||9===e.length)&&"#"===e.charAt(0)&&!e.slice(1).split("").some((e=>isNaN(parseInt(e,16))))}(o)?r="":(r=function(e){const t=document.createElement("canvas");t.width=40,t.height=40;const n=t.getContext("2d");return n?(n.fillStyle=e,n.fillRect(0,0,40,40),t.toDataURL()):""}(o),l.set(o,r))),r}function u(e){if(!e)return void console.trace("`name` argument to `getInitialLetter` not supplied");if(e.length<1)return;const t=e[0];return"@"!==t&&"#"!==t&&"+"!==t||!e[1]||(e=e.substring(1)),Object(i.split)(e,"",1)[0].toUpperCase()}function h(e,t,n,i){if(!e)return null;if(e.getMxcAvatarUrl()){var a;const s=Object(o.b)(null!==(a=e.getMxcAvatarUrl())&&void 0!==a?a:void 0);return void 0!==t&&void 0!==n?s.getThumbnailOfSourceHttp(t,n,i):s.srcHttp}if(e.isSpaceRoom())return null;if(!s.a.shared().getUserIdForRoomId(e.roomId)&&!Object(r.a)(e))return null;const c=e.getAvatarFallbackMember();if(null!=c&&c.getMxcAvatarUrl()){const e=Object(o.b)(c.getMxcAvatarUrl());return void 0!==t&&void 0!==n?e.getThumbnailOfSourceHttp(t,n,i):e.srcHttp}return null}},function(e,t,n){"use strict";t.a={getDisplayUserIdentifier:function(e,t){let{roomId:n,withDisplayName:i}=t;return e}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return o}));const i="io.element.voice_broadcast_info",s="io.element.voice_broadcast_chunk";let o;!function(e){e.Started="started",e.Paused="paused",e.Resumed="resumed",e.Stopped="stopped"}(o||(o={}))},,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i),o=n(159),r=n(205),a=n(126);let c;!function(e){e.Update="update"}(c||(c={}));class l extends o.b{constructor(){super(),s()(this,"_symbol",null),s()(this,"_count",0),s()(this,"_color",r.a.None),s()(this,"watcherReferences",[]),this.watcherReferences.push(a.b.watchSetting("feature_hidebold",null,(()=>{this.emit(c.Update)})))}get symbol(){return this._symbol}get count(){return this._count}get color(){return this._color}get isIdle(){return this.color<=r.a.None}get isUnread(){if(this.color>r.a.Bold)return!0;{const e=a.b.getValue("feature_hidebold");return this.color===r.a.Bold&&!e}}get hasUnreadCount(){return this.color>=r.a.Grey&&(!!this.count||!!this.symbol)}get hasMentions(){return this.color>=r.a.Red}emitIfUpdated(e){e.isDifferentFrom(this)&&this.emit(c.Update)}snapshot(){return new d(this)}destroy(){this.removeAllListeners(c.Update);for(const e of this.watcherReferences)a.b.unwatchSetting(e);this.watcherReferences=[]}}class d{constructor(e){s()(this,"symbol",void 0),s()(this,"count",void 0),s()(this,"color",void 0),this.symbol=e.symbol,this.count=e.count,this.color=e.color}isDifferentFrom(e){const t={count:this.count,symbol:this.symbol,color:this.color},n={count:e.count,symbol:e.symbol,color:e.color};return JSON.stringify(t)!==JSON.stringify(n)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m})),n.d(t,"c",(function(){return p})),n.d(t,"d",(function(){return g})),n.d(t,"b",(function(){return S}));var i=n(325),s=n(141),o=n(235),r=n(123),a=n(205),c=n(855),l=n(376),d=n(246),u=n(126),h=n(234);let m;function p(e,t){var n;if(e.isGuest())return m.AllMessages;if(f(t))return m.Mute;let s;try{s=e.getRoomPushRule("global",t)}catch(e){return null}if(null===(n=s)||void 0===n||!n.enabled)return m.AllMessages;if(y(s))return m.MentionsOnly;return i.a.actionListToActionsObject(s.actions).tweaks.sound?m.AllMessagesLoud:null}function g(e,t){return t===m.Mute?function(e){const t=r.a.get(),n=[],i=t.getRoomPushRule("global",e);i&&n.push(t.deletePushRule("global",o.e.RoomSpecific,i.rule_id));return n.push(t.addPushRule("global",o.e.Override,e,{conditions:[{kind:o.a.EventMatch,key:"room_id",pattern:e}],actions:[o.d.DontNotify]})),Promise.all(n)}(e):function(e,t){const n=r.a.get(),i=[],s=f(e);s&&i.push(n.deletePushRule("global",o.e.Override,s.rule_id));if(t===m.AllMessages){const t=n.getRoomPushRule("global",e);t&&i.push(n.deletePushRule("global",o.e.RoomSpecific,t.rule_id))}else t===m.MentionsOnly?(i.push(n.addPushRule("global",o.e.RoomSpecific,e,{actions:[o.d.DontNotify]})),i.push(n.setPushRuleEnabled("global",o.e.RoomSpecific,e,!0))):t===m.AllMessagesLoud&&(i.push(n.addPushRule("global",o.e.RoomSpecific,e,{actions:[o.d.Notify,{set_tweak:o.g.Sound,value:"default"}]})),i.push(n.setPushRuleEnabled("global",o.e.RoomSpecific,e,!0)));return Promise.all(i)}(e,t)}function v(e,t,n){let i=n?e.getThreadUnreadNotificationCount(n,t):e.getUnreadNotificationCount(t);const o=u.b.getValue("feature_dynamic_room_predecessors"),a=e.findPredecessor(o);if(!n&&null!=a&&a.roomId){const e=a.roomId,t=r.a.get().getRoom(e);t&&(i+=t.getUnreadNotificationCount(s.b.Highlight))}return i}function f(e){var t,n;const i=r.a.get();if(null==i||null===(t=i.pushRules)||void 0===t||null===(n=t.global)||void 0===n||!n.override)return null;for(const t of i.pushRules.global.override)if(t.enabled&&b(e,t)&&y(t))return t;return null}function b(e,t){var n;if(1!==(null===(n=t.conditions)||void 0===n?void 0:n.length))return!1;const i=t.conditions[0];return i.kind===o.a.EventMatch&&"room_id"===i.key&&i.pattern===e}function y(e){return 1===e.actions.length&&e.actions[0]===o.d.DontNotify}function S(e,t){if(!e)return{symbol:null,count:0,color:a.a.None};const n=u.b.getValue("feature_mark_unread")&&Object(h.e)(e);if(Object(c.b)(e,t).length>0)return{symbol:"!",count:1,color:a.a.Unsent};if(Object(d.b)(e.getMyMembership())===d.a.Invite)return{symbol:"!",count:1,color:a.a.Red};if(p(e.client,e.roomId)===m.Mute&&!n)return l.a(e)?{symbol:null,count:0,color:a.a.Bold}:{symbol:null,count:0,color:a.a.None};const i=v(e,s.b.Highlight,t),o=v(e,s.b.Total,t),r=o||i;if(i>0)return{symbol:null,count:r,color:a.a.Red};if(o>0)return{symbol:null,count:r,color:a.a.Grey};if(n)return{symbol:"!",count:1,color:a.a.Grey};let g=!1;return g=t?Object(l.b)(e.getThread(t)):Object(l.a)(e),{symbol:null,count:r,color:g?a.a.Bold:a.a.None}}!function(e){e.AllMessagesLoud="all_messages_loud",e.AllMessages="all_messages",e.MentionsOnly="mentions_only",e.Mute="mute"}(m||(m={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return d}));var i=n(122),s=n.n(i),o=n(203),r=n(125),a=n(466),c=n(183);let l;!function(e){e.StoreMessaging="store_messaging",e.StopMessaging="stop_messaging"}(l||(l={}));class d extends o.a{constructor(){super(r.a),s()(this,"widgetMap",new a.a)}static get instance(){return d.internalInstance}async onAction(e){}async onReady(){this.widgetMap.clear()}storeMessaging(e,t,n){this.stopMessaging(e,t);const i=c.a.calcWidgetUid(e.id,t);this.widgetMap.set(i,n),this.emit(l.StoreMessaging,i,n)}stopMessaging(e,t){this.stopMessagingByUid(c.a.calcWidgetUid(e.id,t))}getMessaging(e,t){return this.widgetMap.get(c.a.calcWidgetUid(e.id,t))}stopMessagingByUid(e){var t;null===(t=this.widgetMap.remove(e))||void 0===t||t.stop(),this.emit(l.StopMessaging,e)}getMessagingForUid(e){return this.widgetMap.get(e)}}s()(d,"internalInstance",(()=>{const e=new d;return e.start(),e})())},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(121),c=n(124),l=n(163);let d;!function(e){e.Verified="verified",e.Warning="warning",e.Unknown="unknown",e.Normal="normal",e.Unauthenticated="unauthenticated"}(d||(d={}));const u={[d.Warning]:Object(a.c)("This user has not verified all of their sessions."),[d.Normal]:Object(a.c)("You have not verified this user."),[d.Verified]:Object(a.c)("You have verified this user. This user has verified all of their sessions.")},h={[d.Warning]:Object(a.c)("Someone is using an unknown session"),[d.Normal]:Object(a.c)("This room is end-to-end encrypted"),[d.Verified]:Object(a.c)("Everyone in this room is verified")};t.b=e=>{let{isUser:t,status:n,className:o,size:m,onClick:p,hideTooltip:g,tooltipAlignment:v,bordered:f}=e;const[b,y]=Object(i.useState)(!1),S=r()({mx_E2EIcon:!0,mx_E2EIcon_bordered:f,mx_E2EIcon_warning:n===d.Warning,mx_E2EIcon_normal:n===d.Normal,mx_E2EIcon_verified:n===d.Verified},o);let E,w;E=t?u[n]:h[n],m&&(w={width:`${m}px`,height:`${m}px`});const _=()=>y(!0),C=()=>y(!1);let O;return b&&!g&&(O=s.a.createElement(l.b,{label:E?Object(a.a)(E):"",alignment:v})),p?s.a.createElement(c.a,{onClick:p,onMouseOver:_,onMouseLeave:C,className:S,style:w},O):s.a.createElement("div",{onMouseOver:_,onMouseLeave:C,className:S,style:w},O)}},,function(e,t,n){"use strict";n.d(t,"d",(function(){return i})),n.d(t,"c",(function(){return s})),n.d(t,"i",(function(){return r})),n.d(t,"g",(function(){return a})),n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return m})),n.d(t,"f",(function(){return p})),n.d(t,"h",(function(){return g})),n.d(t,"e",(function(){return v})),n.d(t,"l",(function(){return f})),n.d(t,"j",(function(){return w})),n.d(t,"k",(function(){return C}));const i=e=>{return t=e.timestamp,n=e.timeout,Math.max(0,t+n-Date.now());var t,n},s=e=>e.beaconInfo.timestamp+e.beaconInfo.timeout,o=(e,t)=>s(t)-s(e),r=(e,t)=>t.beaconInfo.timestamp-e.beaconInfo.timestamp,a=e=>!e.isLive&&e.beaconInfo.timestamp>Date.now()&&s(e)>Date.now();var c=n(1);let l;!function(e){e.Unavailable="Unavailable",e.PermissionDenied="PermissionDenied",e.PositionUnavailable="PositionUnavailable",e.Timeout="Timeout",e.Default="Default"}(l||(l={}));const d={timeout:1e4,maximumAge:6e4},u=e=>{var t;if(c.a.error("Geolocation failed",null!==(t=null==e?void 0:e.message)&&void 0!==t?t:e),!(e=>"object"==typeof e&&!!e.PERMISSION_DENIED)(e))return e.message===l.Unavailable?l.Unavailable:l.Default;switch(null==e?void 0:e.code){case e.PERMISSION_DENIED:return l.PermissionDenied;case e.POSITION_UNAVAILABLE:return l.PositionUnavailable;case e.TIMEOUT:return l.Timeout;default:return l.Default}},h=()=>{if(!navigator.geolocation)throw new Error(l.Unavailable);return navigator.geolocation},m=e=>{const{latitude:t,longitude:n,altitude:i,accuracy:s}=e.coords;return{timestamp:Date.now(),latitude:t,longitude:n,altitude:i,accuracy:s}},p=e=>`geo:${e.latitude},${e.longitude}${Number.isFinite(e.altitude)?`,${e.altitude}`:""}${Number.isFinite(e.accuracy)?`;u=${e.accuracy}`:""}`,g=e=>{const t=m(e);return{timestamp:t.timestamp,geoUri:p(t)}},v=async()=>{try{return await new Promise(((e,t)=>{h().getCurrentPosition(e,t,d)}))}catch(e){throw new Error(u(e))}},f=(e,t)=>{try{const n=e=>t(u(e)),i=h().watchPosition(e,n,d);return()=>{h().clearWatch(i)}}catch(e){throw new Error(u(e))}};var b=n(120),y=n(137),S=n(133),E=n(142);const w=e=>{const t=Object(b.useContext)(S.a),[n,i]=Object(b.useState)();Object(b.useEffect)((()=>{const n=e.getRoomId(),s=Object(y.getBeaconInfoIdentifier)(e),o=t.getRoom(n),r=null==o?void 0:o.currentState.beacons.get(s);(null==r?void 0:r.beaconInfoId)===e.getId()?i(r):i(void 0)}),[e,t]);const s=Object(E.b)(n,y.BeaconEvent.Update,(()=>null==n?void 0:n.beaconInfoId));return Object(b.useEffect)((()=>{s&&s!==e.getId()&&i(void 0)}),[s,e]),Object(b.useEffect)((()=>{n&&n.monitorLiveness()}),[n]),n};var _=n(346);const C=e=>{const[t,n]=Object(b.useState)(!1),i=Object(E.b)(_.a.instance,_.b.LocationPublishError,(()=>e.some(_.a.instance.beaconHasLocationPublishError))),s=Object(E.b)(_.a.instance,_.b.BeaconUpdateError,(()=>e.some((e=>_.a.instance.beaconUpdateErrors.has(e)))));Object(b.useEffect)((()=>{s&&n(!1)}),[s]),Object(b.useEffect)((()=>{n(!1)}),[e]);return{onStopSharing:async()=>{n(!0);try{await Promise.all(e.map((e=>_.a.instance.stopBeacon(e))))}catch(e){n(!1)}},onResetLocationPublishError:()=>{e.forEach((e=>{_.a.instance.resetLocationPublishError(e)}))},beacon:e.map((e=>_.a.instance.getBeaconById(e))).sort(o).shift(),stoppingInProgress:t,hasLocationPublishError:i,hasStopSharingError:s}}},function(e,t,n){"use strict";n.r(t),n.d(t,"makeHtmlMessage",(function(){return u})),n.d(t,"makeHtmlNotice",(function(){return h})),n.d(t,"makeHtmlEmote",(function(){return m})),n.d(t,"makeTextMessage",(function(){return p})),n.d(t,"makeNotice",(function(){return g})),n.d(t,"makeEmoteMessage",(function(){return v})),n.d(t,"getTextForLocationEvent",(function(){return f})),n.d(t,"makeLocationContent",(function(){return b})),n.d(t,"parseLocationEvent",(function(){return y})),n.d(t,"makeTopicContent",(function(){return S})),n.d(t,"parseTopicContent",(function(){return E})),n.d(t,"makeBeaconInfoContent",(function(){return w})),n.d(t,"parseBeaconInfoContent",(function(){return _})),n.d(t,"makeBeaconContent",(function(){return C})),n.d(t,"parseBeaconContent",(function(){return O}));var i=n(13),s=n.n(i),o=n(130),r=n(55),a=n(33),c=n(30);const l=new(n(15).c)("m.topic","org.matrix.msc3765.topic");function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e,t){return{msgtype:o.e.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}}function h(e,t){return{msgtype:o.e.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}}function m(e,t){return{msgtype:o.e.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}}function p(e){return{msgtype:o.e.Text,body:e}}function g(e){return{msgtype:o.e.Notice,body:e}}function v(e){return{msgtype:o.e.Emote,body:e}}const f=(e,t,n,i)=>{const s=`at ${new Date(n).toISOString()}`;return[t===c.a.Self?"User":void 0,"Location",i?`"${i}"`:void 0,e,s].filter(Boolean).join(" ")},b=(e,t,n,i,a)=>{const l=null!=e?e:f(t,a||c.a.Self,n,i),u=n?{[c.d.name]:n}:{};return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({msgtype:o.e.Location,body:l,geo_uri:t,[c.c.name]:{description:i,uri:t},[c.b.name]:{type:a||c.a.Self},[r.c.name]:l},u)},y=e=>{var t,n;const i=c.c.findIn(e),s=c.b.findIn(e),o=c.d.findIn(e),a=r.c.findIn(e),l=null!==(t=null==i?void 0:i.uri)&&void 0!==t?t:null==e?void 0:e.geo_uri,d=null==i?void 0:i.description,u=null!==(n=null==s?void 0:s.type)&&void 0!==n?n:c.a.Self,h=null!=a?a:e.body;return b(h,l,null!=o?o:void 0,d,u)},S=(e,t)=>{const n=[{body:e,mimetype:"text/plain"}];return Object(a.b)(t)&&n.push({body:t,mimetype:"text/html"}),{topic:e,[l.name]:n}},E=e=>{var t,n,i;const s=l.findIn(e);if(!Array.isArray(s))return{text:e.topic};return{text:null!==(t=null==s||null===(n=s.find((e=>!Object(a.b)(e.mimetype)||"text/plain"===e.mimetype)))||void 0===n?void 0:n.body)&&void 0!==t?t:e.topic,html:null==s||null===(i=s.find((e=>"text/html"===e.mimetype)))||void 0===i?void 0:i.body}},w=(e,t,n,i,s)=>({description:n,timeout:e,live:t,[c.d.name]:s||Date.now(),[c.b.name]:{type:null!=i?i:c.a.Self}}),_=e=>{var t;const{description:n,timeout:i,live:s}=e,o=null!==(t=c.d.findIn(e))&&void 0!==t?t:void 0,r=c.b.findIn(e);return{description:n,timeout:i,live:s,assetType:null==r?void 0:r.type,timestamp:o}},C=(e,t,n,i)=>({[c.c.name]:{description:i,uri:e},[c.d.name]:t,"m.relates_to":{rel_type:r.d.name,event_id:n}}),O=e=>{var t;const n=c.c.findIn(e),i=null!==(t=c.d.findIn(e))&&void 0!==t?t:void 0;return{description:null==n?void 0:n.description,uri:null==n?void 0:n.uri,timestamp:i}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(1),s=n(137),o=n(125),r=n(123),a=n(301),c=n(220);function l(e,t){var n;if(!t.actualRoomId)return!1;const i=e.getRoom(t.actualRoomId);if(!i)return!1;if(i.getInvitedAndJoinedMemberCount()!==1+(null===(n=t.targets)||void 0===n?void 0:n.length))return!1;if(0===i.currentState.getStateEvents(s.EventType.RoomHistoryVisibility).length)return!1;const o=i.currentState.getStateEvents(s.EventType.RoomEncryption);return!0!==t.encrypted||0!==o.length}async function d(e,t,n){if(Object(c.a)(e)){var i;const s=(n=null!==(i=n)&&void 0!==i?i:r.a.get()).getRoom(e);return s.isCreated?t(s.actualRoomId):new Promise(((e,n)=>{s.afterCreateCallbacks.push((i=>{t(i).then(e).catch(n)})),o.a.dispatch({action:"local_room_event",roomId:s.roomId})}))}return t(e)}async function u(e,t){return l(e,t)?h(t,t.actualRoomId).then((()=>(t.state=a.c.CREATED,e.emit(s.ClientEvent.Room,t),Promise.resolve(t.actualRoomId)))):new Promise((n=>{const o=()=>{r&&clearInterval(r),c&&clearTimeout(c),h(t,t.actualRoomId).then((()=>{t.state=a.c.CREATED,e.emit(s.ClientEvent.Room,t),n(t.actualRoomId)}))},r=window.setInterval((()=>{l(e,t)&&o()}),500),c=window.setTimeout((()=>{i.a.warn(`Assuming local room ${t.roomId} is ready after hitting timeout`),o()}),5e3)}))}async function h(e,t){for(const n of e.afterCreateCallbacks)await n(t);e.afterCreateCallbacks=[]}},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.IS="SERVICE_TYPE_IS",e.IM="SERVICE_TYPE_IM"}(i||(i={}))},,,function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"Notifier",(function(){return F}));var i=n(122),s=n.n(i),o=n(144),r=n(141),a=n(149),c=n(1),l=n(130),d=n(30),u=n(219),h=n(123),m=n(191),p=n(132),g=n(156),v=n(296),f=n(262),b=n(125),y=n(121),S=n(128),E=n(126),w=n(655),_=n(138),C=n(738),O=n(656),I=n(160),R=n(145),k=n(185),x=n(397),T=n(155),j=n(398),P=n(1573),D=n(194),N=n(206),M=n(195),A=n(480);const L={[l.e.KeyVerificationRequest]:e=>{const t=(e.sender||{}).name;return Object(y.a)("%(name)s is requesting verification",{name:t})},[d.c.name]:e=>v.c(e)(),[d.c.altName]:e=>v.c(e)(),[l.e.Audio]:e=>{var t,n,i;return null!==(t=e.getContent())&&void 0!==t&&t[M.c]?1===(null===(n=e.getContent())||void 0===n||null===(i=n[M.c])||void 0===i?void 0:i.sequence)?Object(y.a)("%(senderName)s started a voice broadcast",{senderName:Object(A.a)(e)}):null:v.b(e)}};class U{constructor(){s()(this,"notifsByRoom",{}),s()(this,"pendingEncryptedEventIds",[]),s()(this,"toolbarHidden",void 0),s()(this,"isSyncing",void 0),s()(this,"onSyncStateChange",((e,t,n)=>{e===u.b.Syncing?this.isSyncing=!0:e!==u.b.Stopped&&e!==u.b.Error||(this.isSyncing=!1),[u.b.Stopped,u.b.Error].includes(e)||null!=n&&n.fromCache||Object(j.c)(h.a.get())})),s()(this,"onEvent",((e,t,n,i,s)=>{if(s.liveEvent&&this.isSyncing&&e.getSender()!==h.a.get().getUserId())if(h.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure())for(this.pendingEncryptedEventIds.push(e.getId());this.pendingEncryptedEventIds.length>20;)this.pendingEncryptedEventIds.shift();else this.evaluateEvent(e)})),s()(this,"onEventDecrypted",(e=>{if(e.isDecryptionFailure())return;const t=this.pendingEncryptedEventIds.indexOf(e.getId());-1!==t&&(this.pendingEncryptedEventIds.splice(t,1),this.evaluateEvent(e))})),s()(this,"onRoomReceipt",((e,t)=>{if(0===t.getUnreadNotificationCount()){const e=g.a.get();if(!e)return;if(void 0===this.notifsByRoom[t.roomId])return;for(const n of this.notifsByRoom[t.roomId])e.clearNotification(n);delete this.notifsByRoom[t.roomId]}}))}notificationMessageForEvent(e){return L.hasOwnProperty(e.getContent().msgtype)?L[e.getContent().msgtype](e):v.b(e)}displayPopupNotification(e,t){const n=g.a.get(),i=h.a.get();if(!n)return;if(!n.supportsNotifications()||!n.maySendNotifications())return;if(Object(j.e)(i))return;let s,o=this.notificationMessageForEvent(e);if(!o)return;e.sender&&t.name!==e.sender.name?"m.room.member"===e.getType()?s=t.name:e.sender&&(s=e.sender.name+" ("+t.name+")",e.getContent().body&&!L.hasOwnProperty(e.getContent().msgtype)&&(o=e.getContent().body)):(s=t.name,e.getContent().body&&!L.hasOwnProperty(e.getContent().msgtype)&&(o=e.getContent().body)),this.isBodyEnabled()||(o="");let r=null;e.sender&&!E.b.getValue("lowBandwidth")&&(r=f.a(e.sender,40,40,"crop"));const a=n.displayNotification(s,o,r,t,e);a&&(void 0===this.notifsByRoom[e.getRoomId()]&&(this.notifsByRoom[e.getRoomId()]=[]),this.notifsByRoom[e.getRoomId()].push(a))}getSoundForRoom(e){const t=E.b.getValue("notificationSound",e);return t?"string"!=typeof t.url?(c.a.warn(`${e} has custom notification sound event, but no url string`),null):t.url.startsWith("mxc://")?{url:Object(I.b)(t.url).srcHttp,name:t.name,type:t.type,size:t.size}:(c.a.warn(`${e} has custom notification sound event, but url is not a mxc url`),null):null}async playAudioNotification(e,t){const n=h.a.get();if(Object(j.e)(n))return;const i=this.getSoundForRoom(t.roomId);c.a.log(`Got sound ${i&&i.name||"default"} for ${t.roomId}`);try{let e=document.querySelector(i?`audio[src='${i.url}']`:"#messageAudio");if(!e){if(!i)return void c.a.error("No audio element or sound to play for notification");e=new Audio(i.url),i.type&&(e.type=i.type),document.body.appendChild(e)}await e.play()}catch(e){c.a.warn("Caught error when trying to fetch room notification sound:",e)}}start(){h.a.get().on(r.d.Timeline,this.onEvent),h.a.get().on(r.d.Receipt,this.onRoomReceipt),h.a.get().on(o.c.Decrypted,this.onEventDecrypted),h.a.get().on(a.b.Sync,this.onSyncStateChange),this.toolbarHidden=!1,this.isSyncing=!1}stop(){h.a.get()&&(h.a.get().removeListener(r.d.Timeline,this.onEvent),h.a.get().removeListener(r.d.Receipt,this.onRoomReceipt),h.a.get().removeListener(o.c.Decrypted,this.onEventDecrypted),h.a.get().removeListener(a.b.Sync,this.onSyncStateChange)),this.isSyncing=!1}supportsDesktopNotifications(){var e,t;return null!==(e=null===(t=g.a.get())||void 0===t?void 0:t.supportsNotifications())&&void 0!==e&&e}setEnabled(e,t){const n=g.a.get();n&&(E.b.isLevelSupported(_.a.DEVICE)&&E.b.setValue("audioNotificationsEnabled",null,_.a.DEVICE,this.isEnabled()),e?n.requestNotificationPermission().then((e=>{if("granted"===e)t&&t(),m.a.instance.trackEvent({eventName:"PermissionChanged",permission:"Notification",granted:!0}),b.a.dispatch({action:"notifier_enabled",value:!0});else{const t=p.b.get().brand,n="denied"===e?Object(y.a)("%(brand)s does not have permission to send you notifications - please check your browser settings",{brand:t}):Object(y.a)("%(brand)s was not given permission to send notifications - please try again",{brand:t});S.b.createDialog(R.a,{title:Object(y.a)("Unable to enable Notifications"),description:n})}})):(m.a.instance.trackEvent({eventName:"PermissionChanged",permission:"Notification",granted:!1}),b.a.dispatch({action:"notifier_enabled",value:!1})),this.setPromptHidden(!0))}isEnabled(){return this.isPossible()&&E.b.getValue("notificationsEnabled")}isPossible(){const e=g.a.get();return!(null==e||!e.supportsNotifications())&&!!e.maySendNotifications()}isBodyEnabled(){return this.isEnabled()&&E.b.getValue("notificationBodyEnabled")}isAudioEnabled(){return E.b.getValue("audioNotificationsEnabled")}setPromptHidden(t){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.toolbarHidden=t,Object(w.a)(),n&&e.localStorage&&e.localStorage.setItem("notifications_hidden",String(t))}shouldShowPrompt(){const e=h.a.get();if(!e)return!1;return!e.isGuest()&&this.supportsDesktopNotifications()&&!Object(C.c)()&&!this.isEnabled()&&!this.isPromptHidden()}isPromptHidden(){return e.localStorage?"true"===e.localStorage.getItem("notifications_hidden"):!!this.toolbarHidden}evaluateEvent(e){if(e.getType()===M.g)return;let t=e.getRoomId();if(k.b.instance.getSupportsVirtualRooms()){const e=x.a.sharedInstance().nativeRoomForVirtualRoom(t);e&&(t=e)}const n=h.a.get().getRoom(t);if(!n)return;const i=h.a.get().getPushActionsForEvent(e);if(null!=i&&i.notify){this.performCustomEventHandling(e);const t=T.b.instance.roomViewStore,o=t.getRoomId()===n.roomId,r=e.getId()!==e.threadRootId?e.threadRootId:void 0,a=t.getThreadId()===r;if(o&&(!r||a)&&O.a.sharedInstance().userActiveRecently()&&!S.b.hasDialogs())return;var s;if(this.isEnabled()&&this.displayPopupNotification(e,n),i.tweaks.sound&&this.isAudioEnabled())null===(s=g.a.get())||void 0===s||s.loudNotification(e,n),this.playAudioNotification(e,n)}}performCustomEventHandling(e){N.d.CALL_EVENT_TYPE.names.includes(e.getType())&&E.b.getValue("feature_group_calls")&&D.a.sharedInstance().addOrReplaceToast({key:Object(P.b)(e.getStateKey()),priority:100,component:P.a,bodyClassName:"mx_IncomingCallToast",props:{callEvent:e}})}}window.mxNotifier||(window.mxNotifier=new U),t.default=window.mxNotifier;const F=window.mxNotifier}.call(this,n(14))},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return S}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(132),c=n(128),l=n(121),d=n(393),u=n(124),h=n(157),m=n(136),p=n(140),g=n(135),v=n(146),f=n(607),b=n(125),y=n(129);class S extends r.a.Component{constructor(e){super(e),s()(this,"unmounted",void 0),s()(this,"onCancel",(()=>{this.props.onFinished(!1)})),s()(this,"onSubmit",(()=>{if(!(this.state.text&&this.state.text.trim()||this.state.issueUrl&&this.state.issueUrl.trim()))return void this.setState({err:Object(l.a)("Please tell us what went wrong or, better, create a GitHub issue that describes the problem.")});const e=(this.state.text.length>0?this.state.text+"\n\n":"")+"Issue: "+(this.state.issueUrl.length>0?this.state.issueUrl:"No issue link given");this.setState({busy:!0,progress:null,err:null}),this.sendProgressCallback(Object(l.a)("Preparing to send logs")),Object(d.a)(a.b.get().bug_report_endpoint_url,{userText:e,sendLogs:!0,progressCallback:this.sendProgressCallback,labels:this.props.label?[this.props.label]:[]}).then((()=>{this.unmounted||(this.props.onFinished(!1),c.b.createDialog(h.a,{title:Object(l.a)("Logs sent"),description:Object(l.a)("Thank you!"),hasCancelButton:!1}))}),(e=>{this.unmounted||this.setState({busy:!1,progress:null,err:Object(l.a)("Failed to send logs: ")+`${e.message}`})})),Object(f.b)(this.state.text,this.state.issueUrl,this.props.error)})),s()(this,"onDownload",(async()=>{this.setState({downloadBusy:!0}),this.downloadProgressCallback(Object(l.a)("Preparing to download logs"));try{await Object(d.b)({sendLogs:!0,progressCallback:this.downloadProgressCallback,labels:this.props.label?[this.props.label]:[]}),this.setState({downloadBusy:!1,downloadProgress:null})}catch(e){this.unmounted||this.setState({downloadBusy:!1,downloadProgress:Object(l.a)("Failed to send logs: ")+`${e.message}`})}})),s()(this,"onTextChange",(e=>{this.setState({text:e.currentTarget.value})})),s()(this,"onIssueUrlChange",(e=>{this.setState({issueUrl:e.currentTarget.value})})),s()(this,"sendProgressCallback",(e=>{this.unmounted||this.setState({progress:e})})),s()(this,"downloadProgressCallback",(e=>{this.unmounted||this.setState({downloadProgress:e})})),this.state={sendLogs:!0,busy:!1,err:null,issueUrl:"",text:e.initialText||"",progress:null,downloadBusy:!1,downloadProgress:null},this.unmounted=!1,b.a.dispatch({action:y.a.DumpDebugLogs})}componentWillUnmount(){this.unmounted=!0}render(){let e=null;this.state.err&&(e=r.a.createElement("div",{className:"error"},this.state.err));let t,n=null;return this.state.busy&&(n=r.a.createElement("div",{className:"progress"},r.a.createElement(g.a,null),this.state.progress," ...")),window.Modernizr&&Object.values(window.Modernizr).some((e=>!1===e))&&(t=r.a.createElement("p",null,r.a.createElement("b",null,Object(l.a)("Reminder: Your browser is unsupported, so your experience may be unpredictable.")))),r.a.createElement(m.a,{className:"mx_BugReportDialog",onFinished:this.onCancel,title:Object(l.a)("Submit debug logs"),contentId:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},t,r.a.createElement("p",null,Object(l.a)("Debug logs contain application usage data including your username, the IDs or aliases of the rooms you have visited, which UI elements you last interacted with, and the usernames of other users. They do not contain messages.")),r.a.createElement("p",null,r.a.createElement("b",null,Object(l.a)("Before submitting logs, you must <a>create a GitHub issue</a> to describe your problem.",{},{a:e=>r.a.createElement("a",{target:"_blank",href:"https://github.com/SchildiChat/schildichat-desktop/issues/new/choose"},e)}))),r.a.createElement("div",{className:"mx_BugReportDialog_download"},r.a.createElement(u.a,{onClick:this.onDownload,kind:"link",disabled:this.state.downloadBusy},Object(l.a)("Download logs")),this.state.downloadProgress&&r.a.createElement("span",null,this.state.downloadProgress," ...")),r.a.createElement(p.a,{type:"text",className:"mx_BugReportDialog_field_input",label:Object(l.a)("GitHub issue"),onChange:this.onIssueUrlChange,value:this.state.issueUrl,placeholder:"https://github.com/vector-im/element-web/issues/..."}),r.a.createElement(p.a,{className:"mx_BugReportDialog_field_input",element:"textarea",label:Object(l.a)("Notes"),rows:5,onChange:this.onTextChange,value:this.state.text,placeholder:Object(l.a)("If there is additional context that would help in analysing the issue, such as what you were doing at the time, room IDs, user IDs, etc., please include those things here.")}),n,e),r.a.createElement(v.a,{primaryButton:Object(l.a)("Send logs"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return d})),n.d(t,"c",(function(){return u})),n.d(t,"f",(function(){return m})),n.d(t,"g",(function(){return p})),n.d(t,"d",(function(){return g})),n.d(t,"e",(function(){return v}));var i=n(120),s=n(206),o=n(142),r=n(310),a=n(132),c=n(121);const l=e=>{const[t,n]=Object(i.useState)((()=>r.a.instance.getCall(e)));return Object(o.a)(r.a.instance,r.b.Call,((t,i)=>{i===e&&n(t)})),t},d=(e,t)=>{const n=l(t);return(null==n?void 0:n.widget.id)===e?n:null},u=e=>Object(o.d)(e,s.b.ConnectionState,Object(i.useCallback)((t=>null!=t?t:e.connectionState),[e])),h=e=>Object(o.d)(e,s.b.Participants,Object(i.useCallback)((t=>null!=t?t:e.participants),[e])),m=e=>{const t=h(e);return Object(i.useMemo)((()=>{let e=0;for(const n of t.values())e+=n.size;return e}),[t])},p=e=>{const t=h(e);return Object(i.useMemo)((()=>{const e=[];for(const[n,i]of t)for(let t=0;t<i.size;t++)e.push(n);return e}),[t])},g=e=>{const t=(e=>{var t;return m(e)>=(null!==(t=a.b.get("element_call").participant_limit)&&void 0!==t?t:a.a.element_call.participant_limit)})(e);return u(e)===s.c.Connecting?Object(c.a)("Connecting"):t?Object(c.a)("Sorry — this call is currently full"):null},v=e=>Object(o.d)(e,s.b.Layout,Object(i.useCallback)((t=>null!=t?t:e.layout),[e]))},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(127),r=n.n(o);const a=Object(i.forwardRef)(((e,t)=>{let{className:n,title:i,timestamp:o,subtitle:a,children:c}=e;return s.a.createElement("div",{className:r()("mx_EventTileBubble",n),ref:t},s.a.createElement("div",{className:"mx_EventTileBubble_title"},i),a&&s.a.createElement("div",{className:"mx_EventTileBubble_subtitle"},a),c,o)}));t.a=a},,function(e,t,n){"use strict";n.d(t,"a",(function(){return A}));var i=n(122),s=n.n(i),o=n(259),r=n.n(o),a=n(1),c=n(149),l=n(16),d=n(132),u=n(128),h=n(276),m=n(510),p=n(123),g=n(336);class v{constructor(e,t){this.apiUrl=e,this.uiUrl=t,s()(this,"scalarToken",void 0),s()(this,"termsInteractionCallback",void 0),s()(this,"isDefaultManager",void 0),this.scalarToken=null,this.termsInteractionCallback=void 0;const n=d.b.get("integrations_rest_url"),i=d.b.get("integrations_ui_url");this.isDefaultManager=e===n&&i===t}writeTokenToStore(){window.localStorage.setItem("mx_scalar_token_at_"+this.apiUrl,this.scalarToken),this.isDefaultManager&&window.localStorage.removeItem("mx_scalar_token")}readTokenFromStore(){let e=window.localStorage.getItem("mx_scalar_token_at_"+this.apiUrl);return!e&&this.isDefaultManager&&(e=window.localStorage.getItem("mx_scalar_token")),e}readToken(){return this.scalarToken?this.scalarToken:this.readTokenFromStore()}setTermsInteractionCallback(e){this.termsInteractionCallback=e}connect(){return this.getScalarToken().then((e=>{this.scalarToken=e}))}hasCredentials(){return null!=this.scalarToken}getScalarToken(){const e=this.readToken();return e?this.checkToken(e).catch((e=>{if(e instanceof m.b)throw e;return this.registerForToken()})):this.registerForToken()}async getAccountName(e){const t=new URL(this.apiUrl+"/account");t.searchParams.set("scalar_token",e),t.searchParams.set("v","1.1");const n=await fetch(t,{method:"GET"}),i=await n.json();if("M_TERMS_NOT_SIGNED"===(null==i?void 0:i.errcode))throw new m.b;if(!n.ok)throw i;if(null==i||!i.user_id)throw new Error("Missing user_id in response");return i.user_id}checkToken(e){return this.getAccountName(e).then((t=>{const n=p.a.get().getUserId();if(t!==n)throw new Error("Scalar token is owned by someone else: "+n);return e})).catch((t=>{if(t instanceof m.b){a.a.log("Integration manager requires new terms to be agreed to");const t=r.a.parse(this.apiUrl);return t.path="",t.pathname="",Object(m.d)([new m.a(h.a.IM,r.a.format(t),e)],this.termsInteractionCallback).then((()=>e))}throw t}))}registerForToken(){return p.a.get().getOpenIdToken().then((e=>this.exchangeForScalarToken(e))).then((e=>this.checkToken(e))).then((e=>(this.scalarToken=e,this.writeTokenToStore(),e)))}async exchangeForScalarToken(e){const t=new URL(this.apiUrl+"/register");t.searchParams.set("v","1.1");const n=await fetch(t,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Scalar request failed: ${n.status}`);const i=await n.json();if(null==i||!i.scalar_token)throw new Error("Missing scalar_token in response");return i.scalar_token}async getScalarPageTitle(e){var t;const n=new URL(this.getStarterLink(this.apiUrl+"/widgets/title_lookup"));n.searchParams.set("curl",encodeURIComponent(e));const i=await fetch(n,{method:"GET"});if(!i.ok)throw new Error(`Scalar request failed: ${i.status}`);const s=await i.json();return null==s||null===(t=s.page_title_cache_item)||void 0===t?void 0:t.cached_title}async disableWidgetAssets(e,t){const n=new URL(this.getStarterLink(this.apiUrl+"/widgets/set_assets_state"));n.searchParams.set("widget_type",e.preferred),n.searchParams.set("widget_id",t),n.searchParams.set("state","disable");const i=await fetch(n,{method:"GET"});if(!i.ok)throw new Error(`Scalar request failed: ${i.status}`);if(!await i.text())throw new Error("Failed to set widget assets state")}getScalarInterfaceUrlForRoom(e,t,n){const i=e.roomId,s=e.name;let o=this.uiUrl;return o+="?scalar_token="+encodeURIComponent(this.scalarToken),o+="&room_id="+encodeURIComponent(i),o+="&room_name="+encodeURIComponent(s),o+="&theme="+encodeURIComponent(g.a.getCurrentTheme()),n&&(o+="&integ_id="+encodeURIComponent(n)),t&&(o+="&screen="+encodeURIComponent(t)),o}getStarterLink(e){return e+"?scalar_token="+encodeURIComponent(this.scalarToken)}}var f=n(126),b=n(120),y=n.n(b),S=n(121),E=n(125),w=n(135),_=n(153),C=n(143),O=n(176);class I extends y.a.Component{constructor(){super(...arguments),s()(this,"dispatcherRef",void 0),s()(this,"state",{errored:!1}),s()(this,"onKeyDown",(e=>{if(Object(_.a)().getAccessibilityAction(e)===C.h.Escape)e.stopPropagation(),e.preventDefault(),this.props.onFinished()})),s()(this,"onAction",(e=>{"close_scalar"===e.action&&this.props.onFinished()})),s()(this,"onError",(()=>{this.setState({errored:!0})}))}componentDidMount(){this.dispatcherRef=E.a.register(this.onAction),document.addEventListener("keydown",this.onKeyDown)}componentWillUnmount(){E.a.unregister(this.dispatcherRef),document.removeEventListener("keydown",this.onKeyDown)}render(){return this.props.loading?y.a.createElement("div",{className:"mx_IntegrationManager_loading"},y.a.createElement(O.a,{size:"h3"},Object(S.a)("Connecting to integration manager…")),y.a.createElement(w.a,null)):!this.props.connected||this.state.errored?y.a.createElement("div",{className:"mx_IntegrationManager_error"},y.a.createElement(O.a,{size:"h3"},Object(S.a)("Cannot connect to integration manager")),y.a.createElement("p",null,Object(S.a)("The integration manager is offline or it cannot reach your homeserver."))):y.a.createElement("iframe",{title:Object(S.a)("Integration manager"),src:this.props.url,onError:this.onError})}}let R;s()(I,"defaultProps",{connected:!0,loading:!1}),function(e){e.Account="account",e.Config="config",e.Homeserver="homeserver"}(R||(R={}));class k{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,i=arguments.length>3?arguments[3]:void 0;this.kind=e,this.apiUrl=t,this.uiUrl=n,this.id=i}get name(){return r.a.parse(this.uiUrl).host}get trimmedApiUrl(){const e=r.a.parse(this.apiUrl);return e.pathname="",e.path="",r.a.format(e)}getScalarClient(){return new v(this.apiUrl,this.uiUrl)}async open(e,t,n){if(!f.b.getValue("integrationProvisioning"))return A.sharedInstance().showDisabledDialog();const i=u.b.createDialog(I,{loading:!0},"mx_IntegrationManager"),s=this.getScalarClient();s.setTermsInteractionCallback(((e,t)=>Object(m.c)(e,t,"mx_TermsDialog_forIntegrationManager")));const o={};try{await s.connect(),s.hasCredentials()?o.url=s.getScalarInterfaceUrlForRoom(e,t,n):o.connected=!1}catch(e){if(e instanceof m.b)return void i.close();a.a.error(e),o.connected=!1}i.close(),u.b.createDialog(I,o,"mx_IntegrationManager")}}var x=n(136),T=n(146);class j extends y.a.Component{constructor(){super(...arguments),s()(this,"onAcknowledgeClick",(()=>{this.props.onFinished()}))}render(){const e=d.b.get().brand;return y.a.createElement(x.a,{className:"mx_IntegrationsImpossibleDialog",hasCancel:!1,onFinished:this.props.onFinished,title:Object(S.a)("Integrations not allowed")},y.a.createElement("div",{className:"mx_IntegrationsImpossibleDialog_content"},y.a.createElement("p",null,Object(S.a)("Your %(brand)s doesn't allow you to use an integration manager to do this. Please contact an admin.",{brand:e}))),y.a.createElement(T.a,{primaryButton:Object(S.a)("OK"),onPrimaryButtonClick:this.onAcknowledgeClick,hasCancel:!1}))}}var P=n(129);class D extends y.a.Component{constructor(){super(...arguments),s()(this,"onAcknowledgeClick",(()=>{this.props.onFinished()})),s()(this,"onOpenSettingsClick",(()=>{this.props.onFinished(),E.a.fire(P.a.ViewUserSettings)}))}render(){return y.a.createElement(x.a,{className:"mx_IntegrationsDisabledDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(S.a)("Integrations are disabled")},y.a.createElement("div",{className:"mx_IntegrationsDisabledDialog_content"},y.a.createElement("p",null,Object(S.a)("Enable '%(manageIntegrations)s' in Settings to do this.",{manageIntegrations:Object(S.a)("Manage integrations")}))),y.a.createElement(T.a,{primaryButton:Object(S.a)("Settings"),onPrimaryButtonClick:this.onOpenSettingsClick,cancelButton:Object(S.a)("OK"),onCancel:this.onAcknowledgeClick}))}}var N=n(183);const M=[R.Account,R.Homeserver,R.Config];class A{static sharedInstance(){return A.instance||(A.instance=new A),A.instance}constructor(){s()(this,"managers",[]),s()(this,"client",void 0),s()(this,"primaryManager",void 0),s()(this,"setupHomeserverManagers",(async e=>{if(a.a.log("Updating homeserver-configured integration managers..."),e&&e["m.integrations"]){let t=e["m.integrations"].managers;Array.isArray(t)||(t=[]),a.a.log(`Homeserver has ${t.length} integration managers`),this.managers=this.managers.filter((e=>e.kind!==R.Homeserver));for(const e of t)e.api_url&&this.managers.push(new k(R.Homeserver,e.api_url,e.ui_url));this.primaryManager=null}else a.a.log("Homeserver has no integration managers")})),s()(this,"onAccountData",(e=>{"m.widgets"===e.getType()&&this.compileManagers()})),this.compileManagers()}startWatching(){this.stopWatching(),this.client=p.a.get(),this.client.on(c.b.AccountData,this.onAccountData),this.client.on(c.b.ClientWellKnown,this.setupHomeserverManagers),this.compileManagers()}stopWatching(){this.client&&(this.client.removeListener(c.b.AccountData,this.onAccountData),this.client.removeListener(c.b.ClientWellKnown,this.setupHomeserverManagers))}compileManagers(){this.managers=[],this.setupConfiguredManager(),this.setupAccountManagers()}setupConfiguredManager(){const e=d.b.get("integrations_rest_url"),t=d.b.get("integrations_ui_url");e&&t&&(this.managers.push(new k(R.Config,e,t)),this.primaryManager=null)}setupAccountManagers(){if(!this.client||!this.client.getUserId())return;N.a.getIntegrationManagerWidgets().forEach((e=>{const t=e.content.data;if(!t)return;const n=e.content.url,i=t.api_url;if(!i||!n)return;const s=new k(R.Account,i,n,e.id||e.state_key||"");this.managers.push(s)})),this.primaryManager=null}hasManager(){return this.managers.length>0}getOrderedManagers(){const e=[];for(const t of M){const n=this.managers.filter((e=>e.kind===t));n&&n.length&&(t===R.Account&&n.sort(((e,t)=>Object(l.h)(e.id,t.id))),e.push(...n))}return e}getPrimaryManager(){return this.hasManager()?(this.primaryManager||(this.primaryManager=this.getOrderedManagers()[0]),this.primaryManager):null}openNoManagerDialog(){u.b.createDialog(j)}showDisabledDialog(){u.b.createDialog(D)}async overwriteManagerOnAccount(e){await N.a.removeIntegrationManagerWidgets(),await N.a.addIntegrationManagerWidget(e.name,e.uiUrl,e.apiUrl)}async tryDiscoverManager(e){let t;a.a.log("Looking up integration manager via .well-known"),(e.startsWith("http:")||e.startsWith("https:"))&&(e=r.a.parse(e).host);try{const n=await fetch(`https://${e}/.well-known/matrix/integrations`);t=await n.json()}catch(e){return a.a.error(e),a.a.warn("Failed to locate integration manager"),null}if(!t||!t["m.integrations_widget"])return a.a.warn("Missing integrations widget on .well-known response"),null;const n=t["m.integrations_widget"];if(!n.url||!n.data||!n.data.api_url)return a.a.warn("Malformed .well-known response for integrations widget"),null;const i=new k(R.Account,n.data.api_url,n.url);return a.a.log("Got an integration manager (untested)"),i}}s()(A,"instance",void 0),window.mxIntegrationManagers=A},function(e,t,n){"use strict";n.d(t,"b",(function(){return q})),n.d(t,"a",(function(){return G}));var i=n(122),s=n.n(i),o=n(130),r=n(744),a=n.n(r),c=n(1493),l=n.n(c),d=n(1),u=n(171),h=n(16),m=n(125),p=n(121),g=n(128),v=n(135),f=n(129);class b{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this.roomId=e,this.fileName=t,this.relation=n,this.fileSize=i,s()(this,"abortController",new AbortController),s()(this,"promise",void 0),s()(this,"uploaded",0)}onProgress(e){this.uploaded=e.loaded,this.fileSize=e.total}abort(){this.abortController.abort()}get cancelled(){return this.abortController.signal.aborted}get total(){return this.fileSize}get loaded(){return this.uploaded}}var y=n(126),S=n(467),E=n(139),w=n(229),_=n(145),C=n(387),O=n(120),I=n.n(O),R=n(136),k=n(146);class x extends I.a.Component{constructor(){super(...arguments),s()(this,"onCancelClick",(()=>{this.props.onFinished(!1)})),s()(this,"onUploadClick",(()=>{this.props.onFinished(!0)}))}render(){let e,t;if(1===this.props.totalFiles&&1===this.props.badFiles.length)e=Object(p.a)("This file is <b>too large</b> to upload. The file size limit is %(limit)s but this file is %(sizeOfThisFile)s.",{limit:Object(C.filesize)(this.props.contentMessages.getUploadLimit()),sizeOfThisFile:Object(C.filesize)(this.props.badFiles[0].size)},{b:e=>I.a.createElement("b",null,e)}),t=I.a.createElement(k.a,{primaryButton:Object(p.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.onCancelClick,focus:!0});else if(this.props.totalFiles===this.props.badFiles.length)e=Object(p.a)("These files are <b>too large</b> to upload. The file size limit is %(limit)s.",{limit:Object(C.filesize)(this.props.contentMessages.getUploadLimit())},{b:e=>I.a.createElement("b",null,e)}),t=I.a.createElement(k.a,{primaryButton:Object(p.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.onCancelClick,focus:!0});else{e=Object(p.a)("Some files are <b>too large</b> to be uploaded. The file size limit is %(limit)s.",{limit:Object(C.filesize)(this.props.contentMessages.getUploadLimit())},{b:e=>I.a.createElement("b",null,e)});const n=this.props.totalFiles-this.props.badFiles.length;t=I.a.createElement(k.a,{primaryButton:Object(p.a)("Upload %(count)s other files",{count:n}),onPrimaryButtonClick:this.onUploadClick,hasCancel:!0,cancelButton:Object(p.a)("Cancel All"),onCancel:this.onCancelClick,focus:!0})}return I.a.createElement(R.a,{className:"mx_UploadFailureDialog",onFinished:this.onCancelClick,title:Object(p.a)("Upload Error"),contentId:"mx_Dialog_content"},I.a.createElement("div",{id:"mx_Dialog_content"},e,undefined),t)}}var T=n(996),j=n(507),P=n(599),D=n(275),N=n(155);function M(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function A(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?M(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):M(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const L=[0,0,22,37,0,0,22,37,1];class U extends Error{}const F=32768,B=65536,V=.1,K=["image/avif","image/webp"];async function $(e,t,n){let i="image/png";"image/jpeg"===n.type&&(i="image/jpeg");const s=await async function(e){const t=new Image,n=URL.createObjectURL(e),i=new Promise(((e,i)=>{t.onload=function(){URL.revokeObjectURL(n),e(t)},t.onerror=function(e){i(e)}}));t.src=n;let s=Promise.resolve(!1);"image/png"===e.type&&(s=W(e).then((e=>{const t=new Uint8Array(e),n=l()(t);for(const e of n)if("pHYs"===e.name)return e.data.byteLength===L.length&&e.data.every(((e,t)=>e===L[t]));return!1})));const[o]=await Promise.all([s,i]);return{width:o?t.width>>1:t.width,height:o?t.height>>1:t.height,img:t}}(n),o=await Object(j.b)(s.img,s.width,s.height,i),r=o.info;if(!K.includes(n.type)){const e=n.size-r.thumbnail_info.size;if(n.size<=F||e<=B&&e<=n.size*V)return delete r.thumbnail_info,r}const a=await q(e,t,o.thumbnail);return r.thumbnail_url=a.url,r.thumbnail_file=a.file,r}function H(e,t,n){let i;return function(e){return new Promise(((t,n)=>{const i=document.createElement("video");i.preload="metadata",i.playsInline=!0,i.muted=!0;const s=new FileReader;s.onload=function(e){var s,o;i.onloadeddata=async function(){t(i),i.pause()},i.onerror=function(e){n(e)};let r=null===(s=e.target)||void 0===s?void 0:s.result;null!==(o=r)&&void 0!==o&&o.startsWith("data:video/quicktime;")&&(r=r.replace("data:video/quicktime;","data:video/mp4;")),i.src=r,i.load(),i.play()},s.onerror=function(e){n(e)},s.readAsDataURL(e)}))}(n).then((e=>Object(j.b)(e,e.videoWidth,e.videoHeight,"image/jpeg"))).then((n=>(i=n.info,q(e,t,n.thumbnail)))).then((e=>(i.thumbnail_url=e.url,i.thumbnail_file=e.file,i)))}function W(e){return new Promise(((t,n)=>{const i=new FileReader;i.onload=function(e){var n;t(null===(n=e.target)||void 0===n?void 0:n.result)},i.onerror=function(e){n(e)},i.readAsArrayBuffer(e)}))}async function q(e,t,n,i,s){const o=null!=s?s:new AbortController;if(e.isRoomEncrypted(t)){const t=await W(n);if(o.signal.aborted)throw new U;const s=await a.a.encryptAttachment(t);if(o.signal.aborted)throw new U;const r=new Blob([s.data]),{content_uri:c}=await e.uploadContent(r,{progressHandler:i,abortController:o,includeFilename:!1,type:"application/octet-stream"});if(o.signal.aborted)throw new U;return{file:A(A({},s.info),{},{url:c})}}{const{content_uri:t}=await e.uploadContent(n,{progressHandler:i,abortController:o});if(o.signal.aborted)throw new U;return{url:t}}}class G{constructor(){s()(this,"inprogress",[]),s()(this,"mediaConfig",null)}sendStickerContentToRoom(e,t,n,i,s,o){return Object(D.a)(t,(t=>o.sendStickerMessage(t,n,e,i,s)),o).catch((n=>{throw d.a.warn(`Failed to send content with URL ${e} to room ${t}`,n),n}))}getUploadLimit(){return null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]?this.mediaConfig["m.upload.size"]:null}async sendContentListToRoom(e,t,n,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:E.a.Room;if(i.isGuest())return void m.a.dispatch({action:"require_registration"});const o=N.b.instance.roomViewStore.getQuotingEvent();if(!this.mediaConfig){const e=g.b.createDialog(v.a,void 0,"mx_Dialog_spinner");await this.ensureMediaConfigFetched(i),e.close()}const r=[],a=[];for(const t of e)this.isFileSizeAcceptable(t)?a.push(t):r.push(t);if(r.length>0){const{finished:t}=g.b.createDialog(x,{badFiles:r,totalFiles:e.length,contentMessages:this}),[n]=await t;if(!n)return}let c=!1,l=Promise.resolve();for(let e=0;e<a.length;++e){const s=a[e],r=l;if(!c){const{finished:t}=g.b.createDialog(T.a,{file:s,currentIndex:e,totalFiles:a.length}),[n,i]=await t;if(!n)break;i&&(c=!0)}l=Object(D.a)(t,(e=>this.sendContentToRoom(s,e,n,i,null!=o?o:void 0,r)))}o&&m.a.dispatch({action:"reply_to_event",event:null,context:s}),m.a.dispatch({action:f.a.FocusSendMessageComposer,context:s})}getCurrentUploads(e){return this.inprogress.filter((t=>{const n=!e&&!t.relation,i=e&&t.relation&&e.rel_type===t.relation.rel_type&&e.event_id===t.relation.event_id;return(n||i)&&!t.cancelled}))}cancelUpload(e){e.abort(),m.a.dispatch({action:f.a.UploadCanceled,upload:e})}async sendContentToRoom(e,t,n,i,s,r){const a=e.name||Object(p.a)("Attachment"),c={body:a,info:{size:e.size},msgtype:o.e.File};Object(P.a)(c,n),s&&Object(w.a)(c,s,{includeLegacyFallback:!1}),y.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(S.a)(c),e.type&&(c.info.mimetype=e.type);const l=new b(t,a,n,e.size);this.inprogress.push(l),m.a.dispatch({action:f.a.UploadStarted,upload:l});try{if(e.type.startsWith("image/")){c.msgtype=o.e.Image;try{const n=await $(i,t,e);Object.assign(c.info,n)}catch(e){d.a.error(e),c.msgtype=o.e.File}}else if(0===e.type.indexOf("audio/"))c.msgtype=o.e.Audio;else if(0===e.type.indexOf("video/")){c.msgtype=o.e.Video;try{const n=await H(i,t,e);Object.assign(c.info,n)}catch(e){d.a.error(e),c.msgtype=o.e.File}}else c.msgtype=o.e.File;if(l.cancelled)throw new U;const s=await q(i,t,e,(function(e){l.onProgress(e),m.a.dispatch({action:f.a.UploadProgress,upload:l})}),l.abortController);if(c.file=s.file,c.url=s.url,l.cancelled)throw new U;if(r&&await r,l.cancelled)throw new U;const a=(null==n?void 0:n.rel_type)===u.d.name?n.event_id:null,h=await i.sendMessage(t,null!=a?a:null,c);y.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(S.b)(i,t,h.event_id),m.a.dispatch({action:f.a.UploadFinished,upload:l}),m.a.dispatch({action:"message_sent"})}catch(e){if(413===(null==e?void 0:e.httpStatus)&&(this.mediaConfig=null),!l.cancelled){let t=Object(p.a)("The file '%(fileName)s' failed to upload.",{fileName:l.fileName});413===e.httpStatus&&(t=Object(p.a)("The file '%(fileName)s' exceeds this homeserver's size limit for uploads",{fileName:l.fileName})),g.b.createDialog(_.a,{title:Object(p.a)("Upload Failed"),description:t}),m.a.dispatch({action:f.a.UploadFailed,upload:l,error:e})}}finally{Object(h.I)(this.inprogress,(e=>e.promise===l.promise))}}isFileSizeAcceptable(e){return!(null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]&&e.size>this.mediaConfig["m.upload.size"])}ensureMediaConfigFetched(e){return null!==this.mediaConfig?Promise.resolve():(d.a.log("[Media Config] Fetching"),e.getMediaConfig().then((e=>(d.a.log("[Media Config] Fetched config:",e),e))).catch((()=>(d.a.log("[Media Config] Could not fetch config, so not limiting uploads."),{}))).then((e=>{this.mediaConfig=e})))}static sharedInstance(){return void 0===window.mxContentMessages&&(window.mxContentMessages=new G),window.mxContentMessages}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return w}));var i=n(120),s=n.n(i),o=n(16),r=n(121),a=n(124),c=n(126),l=n(138),d=n(128),u=n(125),h=n(129),m=n(217),p=n(866);var g=e=>{var t;let{featureId:n,onFinished:i}=e;const o=c.b.getBetaInfo(n);return s.a.createElement(p.a,{title:Object(r.a)("%(featureName)s Beta feedback",{featureName:o.title}),subheading:Object(r.a)(o.feedbackSubheading),onFinished:i,rageshakeLabel:o.feedbackLabel,rageshakeData:Object.fromEntries(((null===(t=c.b.getBetaInfo(n))||void 0===t?void 0:t.extraSettings)||[]).map((e=>c.b.getValue(e))))},s.a.createElement(a.a,{kind:"link_inline",onClick:()=>{i(),u.a.dispatch({action:h.a.ViewUserSettings,initialTabId:m.a.Labs})}},Object(r.a)("To leave the beta, visit your settings.")))},v=n(132),f=n(222),b=n(167),y=n(209),S=n(148),E=n(476);const w=e=>{let{onClick:t,tooltipTitle:n=Object(r.a)("This is a beta feature"),tooltipCaption:i=Object(r.a)("Click for more info")}=e;return t?s.a.createElement(S.a,{className:"mx_BetaCard_betaPill",title:`${n} ${i}`,tooltip:s.a.createElement("div",null,s.a.createElement("div",{className:"mx_Tooltip_title"},n),s.a.createElement("div",{className:"mx_Tooltip_sub"},i)),onClick:t},Object(r.a)("Beta")):s.a.createElement("span",{className:"mx_BetaCard_betaPill"},Object(r.a)("Beta"))};t.b=e=>{let{title:t,featureId:n}=e;const u=c.b.getBetaInfo(n),h=Object(b.a)(n),[m,p]=Object(i.useState)(!1);if(!u)return null;const{title:S,caption:_,faq:C,image:O,feedbackLabel:I,feedbackSubheading:R,extraSettings:k,requiresRefresh:x}=u;let T,j,P;if(h&&I&&R&&Object(E.a)()&&(T=s.a.createElement(a.a,{onClick:()=>{d.b.createDialog(g,{featureId:n})},kind:"primary"},Object(r.a)("Feedback"))),x){const e=v.b.get().brand;j=h?Object(r.a)("Leaving the beta will reload %(brand)s.",{brand:e}):Object(r.a)("Joining the beta will reload %(brand)s.",{brand:e})}return P=m?s.a.createElement(y.a,null):h?Object(r.a)("Leave the beta"):Object(r.a)("Join the beta"),s.a.createElement("div",{className:"mx_BetaCard"},s.a.createElement("div",{className:"mx_BetaCard_columns"},s.a.createElement("div",{className:"mx_BetaCard_columns_description"},s.a.createElement("h3",{className:"mx_BetaCard_title"},s.a.createElement("span",null,t||Object(r.a)(S)),s.a.createElement(w,null)),s.a.createElement("div",{className:"mx_BetaCard_caption"},_()),s.a.createElement("div",{className:"mx_BetaCard_buttons"},T,s.a.createElement(a.a,{onClick:async()=>{p(!0),x||await Object(o.N)(2e3),await c.b.setValue(n,null,l.a.DEVICE,!h),x||p(!1)},kind:T?"primary_outline":"primary",disabled:m},P)),j&&s.a.createElement("div",{className:"mx_BetaCard_refreshWarning"},j),C&&s.a.createElement("div",{className:"mx_BetaCard_faq"},C(h))),s.a.createElement("div",{className:"mx_BetaCard_columns_image_wrapper"},s.a.createElement("img",{className:"mx_BetaCard_columns_image",src:O,alt:""}))),k&&h&&s.a.createElement("div",{className:"mx_BetaCard_relatedSettings"},k.map((e=>s.a.createElement(f.a,{key:e,name:e,level:l.a.DEVICE})))))}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return r}));var i=n(13),s=n.n(i);class o{constructor(e){this.target=e,s()(this,"reEmitters",new Map)}reEmit(e,t){var n=this;let i=this.reEmitters.get(e);i||(i=new Map,this.reEmitters.set(e,i));for(const s of t){const t=function(){if("error"!==s||0!==n.target.listenerCount("error")){for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];n.target.emit(s,...i,e)}};e.on(s,t),i.set(s,t)}}stopReEmitting(e,t){const n=this.reEmitters.get(e);if(n){for(const i of t)e.off(i,n.get(i)),n.delete(i);0===n.size&&this.reEmitters.delete(e)}}}class r extends o{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}},function(e,t,n){"use strict";n.d(t,"d",(function(){return o})),n.d(t,"c",(function(){return a})),n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return c})),n.d(t,"e",(function(){return l}));var i=n(13),s=n.n(i);let o,r;!function(e){e[e.ToggledLazyLoading=0]="ToggledLazyLoading"}(o||(o={}));class a extends Error{constructor(e,t){super(`Store is invalid because ${e}, please stop the client, delete all data and start the client again`),this.reason=e,this.value=t,this.name="InvalidStoreError"}}s()(a,"TOGGLED_LAZY_LOADING",o.ToggledLazyLoading),function(e){e.TooNew="TOO_NEW"}(r||(r={}));class c extends Error{constructor(e){super(`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`),this.reason=e,this.name="InvalidCryptoStoreError"}}s()(c,"TOO_NEW",r.TooNew);class l extends Error{constructor(e,t){super(e),this.value=t}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(276),c=n(137),l=n(1),d=n(123),u=n(128),h=n(121),m=n(510),p=n(446),g=n(157),v=n(372);class f extends Error{}class b{constructor(e){s()(this,"accessToken",void 0),s()(this,"tempClient",void 0),s()(this,"authEnabled",!0),e&&(this.tempClient=Object(c.createClient)({baseUrl:"",idBaseUrl:e}))}get matrixClient(){return this.tempClient?this.tempClient:d.a.get()}writeToken(){this.tempClient||window.localStorage.setItem("mx_is_access_token",this.accessToken)}readToken(){return this.tempClient?null:window.localStorage.getItem("mx_is_access_token")}hasCredentials(){return Boolean(this.accessToken)}async getAccessToken(){let{check:e=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.authEnabled)return null;let t=this.accessToken;if(t||(t=this.readToken()),!t)return t=await this.registerForToken(e),t&&(this.accessToken=t,this.writeToken()),t;if(e)try{await this.checkToken(t)}catch(e){if(e instanceof m.b||e instanceof f)throw e;t=await this.registerForToken(),t&&(this.accessToken=t,this.writeToken())}return t}async checkToken(e){const t=this.matrixClient.getIdentityServerUrl();try{await this.matrixClient.getIdentityAccount(e)}catch(n){if("M_TERMS_NOT_SIGNED"===n.errcode)return l.a.log("Identity server requires new terms to be agreed to"),void await Object(m.d)([new m.a(a.a.IS,t,e)]);throw n}if(!this.tempClient&&!Object(p.a)()&&!await Object(p.b)(t)){const{finished:e}=u.b.createDialog(g.a,{title:Object(h.a)("Identity server has no terms of service"),description:r.a.createElement("div",null,r.a.createElement("p",null,Object(h.a)("This action requires accessing the default identity server <server /> to validate an email address or phone number, but the server does not have any terms of service.",{},{server:()=>r.a.createElement("b",null,Object(v.a)(t))})),r.a.createElement("p",null,Object(h.a)("Only continue if you trust the owner of the server."))),button:Object(h.a)("Trust")}),[n]=await e;if(!n)throw new f("User aborted identity server action without terms");Object(p.d)()}}async registerForToken(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=await d.a.get().getOpenIdToken(),{access_token:n,token:i}=await this.matrixClient.registerWithIdentityServer(t),s=i||n;return e&&await this.checkToken(s),s}}},function(e,t,n){"use strict";function i(e,t){return Number.isFinite(e)?Number(e):t}function s(e,t,n){return Math.min(Math.max(e,t),n)}function o(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return[...t].reduce(((e,t)=>t+e),0)}function r(e,t,n){return e*(n-t)+t}function a(e,t,n){const i=(e-t)/(n-t);return Number.isNaN(i)?0:i}n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"e",(function(){return o})),n.d(t,"d",(function(){return r})),n.d(t,"c",(function(){return a}))},function(e,t,n){"use strict";function i(e){e.currentTarget.value=""}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";t.a={SHOW_ENCRYPTION_SETUP_UI:!0}},function(e,t,n){"use strict";n.d(t,"c",(function(){return P})),n.d(t,"a",(function(){return U})),n.d(t,"b",(function(){return F}));var i=n(120),s=n.n(i),o=n(1),r=n(16),a=n(161),c=n(130),l=n(189),d=n(121),u=n(545),h=n(236),m=n(126),p=n(505),g=n(210),v=n(184),f=n(125),b=n(123),y=n(415),S=n(124),E=n(174),w=n(182),_=n(206),C=n(195),O=n(480);function I(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.getSender();const i=b.a.get(),s=e.getRoomId(),o=null===(t=i.getRoom(s))||void 0===t?void 0:t.getMember(n);return(null==o?void 0:o.name)||(null==o?void 0:o.rawDisplayName)||n||Object(d.a)("Someone")}function R(e){var t;const n=null===(t=b.a.get().getRoom(e.getRoomId()))||void 0===t?void 0:t.name;return b.a.get().supportsVoip()?()=>Object(d.a)("Video call started in %(roomName)s.",{roomName:n}):()=>Object(d.a)("Video call started in %(roomName)s. (not supported by this browser)",{roomName:n})}const k=()=>{f.a.dispatch({action:"open_room_settings",initial_tab_id:y.b})};function x(e){return Object(w.l)(e)?P(e):()=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let n=e.getContent().body;return e.isRedacted()&&(n=D(e)),n=e.getContent().msgtype===c.e.Emote?"* "+t+" "+n:e.getContent().msgtype===c.e.Image?Object(d.a)("%(senderDisplayName)s sent an image.",{senderDisplayName:t}):e.getType()==c.b.Sticker?Object(d.a)("%(senderDisplayName)s sent a sticker.",{senderDisplayName:t}):t+": "+n,n}}const T=()=>{E.a.instance.setCard({phase:v.a.PinnedMessages},!1)};function j(e){const t=Object(O.a)(e),{entity:n}=e.getPrevContent(),{entity:i,recommendation:s,reason:o}=e.getContent();return i?s&&o?i===n?p.g.includes(e.getType())?()=>Object(d.a)("%(senderName)s updated the rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):p.c.includes(e.getType())?()=>Object(d.a)("%(senderName)s updated the rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):p.f.includes(e.getType())?()=>Object(d.a)("%(senderName)s updated the rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):()=>Object(d.a)("%(senderName)s updated a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):n?p.g.includes(e.getType())?()=>Object(d.a)("%(senderName)s changed a rule that was banning users matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:n,newGlob:i,reason:o}):p.c.includes(e.getType())?()=>Object(d.a)("%(senderName)s changed a rule that was banning rooms matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:n,newGlob:i,reason:o}):p.f.includes(e.getType())?()=>Object(d.a)("%(senderName)s changed a rule that was banning servers matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:n,newGlob:i,reason:o}):()=>Object(d.a)("%(senderName)s updated a ban rule that was matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:n,newGlob:i,reason:o}):p.g.includes(e.getType())?()=>Object(d.a)("%(senderName)s created a rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):p.c.includes(e.getType())?()=>Object(d.a)("%(senderName)s created a rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):p.f.includes(e.getType())?()=>Object(d.a)("%(senderName)s created a rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):()=>Object(d.a)("%(senderName)s created a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:i,reason:o}):()=>Object(d.a)("%(senderName)s updated an invalid ban rule",{senderName:t}):p.g.includes(e.getType())?()=>Object(d.a)("%(senderName)s removed the rule banning users matching %(glob)s",{senderName:t,glob:n}):p.c.includes(e.getType())?()=>Object(d.a)("%(senderName)s removed the rule banning rooms matching %(glob)s",{senderName:t,glob:n}):p.f.includes(e.getType())?()=>Object(d.a)("%(senderName)s removed the rule banning servers matching %(glob)s",{senderName:t,glob:n}):()=>Object(d.a)("%(senderName)s removed a ban rule matching %(glob)s",{senderName:t,glob:n})}function P(e){return()=>Object(d.a)("%(senderName)s has shared their location",{senderName:Object(O.a)(e)})}function D(e){var t;let n=Object(d.a)("Message deleted");const i=e.getUnsigned(),s=null==i||null===(t=i.redacted_because)||void 0===t?void 0:t.sender;if(s&&s!==e.getSender()){const t=b.a.get().getRoom(e.getRoomId()),i=null==t?void 0:t.getMember(s);n=Object(d.a)("Message deleted by %(name)s",{name:(null==i?void 0:i.name)||s})}return n}function N(e){return()=>{let t="";if(e.isRedacted()){var n,i;t=D(e);t=(null!==(n=null===(i=e.sender)||void 0===i?void 0:i.name)&&void 0!==n?n:e.getSender())+": "+t}else{var s,o;t=Object(d.a)("%(senderName)s has started a poll - %(pollQuestion)s",{senderName:Object(O.a)(e),pollQuestion:null===(s=e.unstableExtensibleEvent)||void 0===s||null===(o=s.question)||void 0===o?void 0:o.text})}return t}}function M(e){return()=>Object(d.a)("%(senderName)s has ended a poll",{senderName:Object(O.a)(e)})}const A={[c.b.RoomMessage]:x,[c.b.Sticker]:x,[c.b.CallInvite]:function(e){var t,n;const i=Object(O.a)(e),s=!(null!==(t=e.getContent().offer)&&void 0!==t&&null!==(n=t.sdp)&&void 0!==n&&n.includes("m=video")),o=b.a.get().supportsVoip();return s&&o?()=>Object(d.a)("%(senderName)s placed a voice call.",{senderName:i}):s&&!o?()=>Object(d.a)("%(senderName)s placed a voice call. (not supported by this browser)",{senderName:i}):!s&&o?()=>Object(d.a)("%(senderName)s placed a video call.",{senderName:i}):s||o?null:()=>Object(d.a)("%(senderName)s placed a video call. (not supported by this browser)",{senderName:i})},[l.e.name]:N,[l.a.name]:M,[l.e.altName]:N,[l.a.altName]:M},L={[c.b.RoomCanonicalAlias]:function(e){const t=Object(O.a)(e),n=e.getPrevContent().alias,i=e.getPrevContent().alt_aliases||[],s=e.getContent().alias,o=e.getContent().alt_aliases||[],r=i.filter((e=>!o.includes(e))),a=o.filter((e=>!i.includes(e)));if(r.length||a.length){if(s!==n)return()=>Object(d.a)("%(senderName)s changed the main and alternative addresses for this room.",{senderName:t});if(a.length&&!r.length)return()=>Object(d.a)("%(senderName)s added the alternative addresses %(addresses)s for this room.",{senderName:t,addresses:a.join(", "),count:a.length});if(r.length&&!a.length)return()=>Object(d.a)("%(senderName)s removed the alternative addresses %(addresses)s for this room.",{senderName:t,addresses:r.join(", "),count:r.length});if(r.length&&a.length)return()=>Object(d.a)("%(senderName)s changed the alternative addresses for this room.",{senderName:t})}else{if(s)return()=>Object(d.a)("%(senderName)s set the main address for this room to %(address)s.",{senderName:t,address:e.getContent().alias});if(n)return()=>Object(d.a)("%(senderName)s removed the main address for this room.",{senderName:t})}return()=>Object(d.a)("%(senderName)s changed the addresses for this room.",{senderName:t})},[c.b.RoomName]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return e.getContent().name&&0!==e.getContent().name.trim().length?e.getPrevContent().name?()=>Object(d.a)("%(senderDisplayName)s changed the room name from %(oldRoomName)s to %(newRoomName)s.",{senderDisplayName:t,oldRoomName:e.getPrevContent().name,newRoomName:e.getContent().name}):()=>Object(d.a)("%(senderDisplayName)s changed the room name to %(roomName)s.",{senderDisplayName:t,roomName:e.getContent().name}):()=>Object(d.a)("%(senderDisplayName)s removed the room name.",{senderDisplayName:t})},[c.b.RoomTopic]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return()=>Object(d.a)('%(senderDisplayName)s changed the topic to "%(topic)s".',{senderDisplayName:t,topic:e.getContent().topic})},[c.b.RoomMember]:function(e,t,n){var i,s;const a=(null===(i=e.sender)||void 0===i?void 0:i.name)||I(e),c=(null===(s=e.target)||void 0===s?void 0:s.name)||I(e,e.getStateKey()),l=e.getPrevContent(),u=e.getContent(),h=u.reason;switch(u.membership){case"invite":{const e=u.third_party_invite;return e?e.display_name?()=>Object(d.a)("%(targetName)s accepted the invitation for %(displayName)s",{targetName:c,displayName:e.display_name}):()=>Object(d.a)("%(targetName)s accepted an invitation",{targetName:c}):()=>Object(d.a)("%(senderName)s invited %(targetName)s",{senderName:a,targetName:c})}case"ban":return()=>h?Object(d.a)("%(senderName)s banned %(targetName)s: %(reason)s",{senderName:a,targetName:c,reason:h}):Object(d.a)("%(senderName)s banned %(targetName)s",{senderName:a,targetName:c});case"join":return l&&"join"===l.membership?l.displayname&&u.displayname&&l.displayname!==u.displayname?()=>Object(d.a)("%(oldDisplayName)s changed their display name to %(displayName)s",{oldDisplayName:Object(r.H)(l.displayname),displayName:Object(r.H)(u.displayname)}):!l.displayname&&u.displayname?()=>Object(d.a)("%(senderName)s set their display name to %(displayName)s",{senderName:e.getSender(),displayName:Object(r.H)(u.displayname)}):l.displayname&&!u.displayname?()=>Object(d.a)("%(senderName)s removed their display name (%(oldDisplayName)s)",{senderName:a,oldDisplayName:Object(r.H)(l.displayname)}):l.avatar_url&&!u.avatar_url?()=>Object(d.a)("%(senderName)s removed their profile picture",{senderName:a}):l.avatar_url&&u.avatar_url&&l.avatar_url!==u.avatar_url?()=>Object(d.a)("%(senderName)s changed their profile picture",{senderName:a}):!l.avatar_url&&u.avatar_url?()=>Object(d.a)("%(senderName)s set a profile picture",{senderName:a}):(null!=n?n:m.b.getValue("showHiddenEventsInTimeline"))?()=>Object(d.a)("%(senderName)s made no change",{senderName:a}):null:(e.target||o.a.warn("Join message has no target! -- "+e.getContent().state_key),()=>Object(d.a)("%(targetName)s joined the room",{targetName:c}));case"leave":return e.getSender()===e.getStateKey()?"invite"===l.membership?()=>Object(d.a)("%(targetName)s rejected the invitation",{targetName:c}):()=>h?Object(d.a)("%(targetName)s left the room: %(reason)s",{targetName:c,reason:h}):Object(d.a)("%(targetName)s left the room",{targetName:c}):"ban"===l.membership?()=>Object(d.a)("%(senderName)s unbanned %(targetName)s",{senderName:a,targetName:c}):"invite"===l.membership?()=>h?Object(d.a)("%(senderName)s withdrew %(targetName)s's invitation: %(reason)s",{senderName:a,targetName:c,reason:h}):Object(d.a)("%(senderName)s withdrew %(targetName)s's invitation",{senderName:a,targetName:c}):"join"===l.membership?()=>h?Object(d.a)("%(senderName)s removed %(targetName)s: %(reason)s",{senderName:a,targetName:c,reason:h}):Object(d.a)("%(senderName)s removed %(targetName)s",{senderName:a,targetName:c}):null}return null},[c.b.RoomAvatar]:function(e){var t;const n=(null==e||null===(t=e.sender)||void 0===t?void 0:t.name)||e.getSender();return()=>Object(d.a)("%(senderDisplayName)s changed the room avatar.",{senderDisplayName:n})},[c.b.RoomThirdPartyInvite]:function(e){const t=Object(O.a)(e);return Object(h.c)(e)?()=>Object(d.a)("%(senderName)s sent an invitation to %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:e.getContent().display_name}):()=>Object(d.a)("%(senderName)s revoked the invitation for %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:e.getPrevContent().display_name||Object(d.a)("Someone")})},[c.b.RoomHistoryVisibility]:function(e){const t=Object(O.a)(e);switch(e.getContent().history_visibility){case a.b.Invited:return()=>Object(d.a)("%(senderName)s made future room history visible to all room members, from the point they are invited.",{senderName:t});case a.b.Joined:return()=>Object(d.a)("%(senderName)s made future room history visible to all room members, from the point they joined.",{senderName:t});case a.b.Shared:return()=>Object(d.a)("%(senderName)s made future room history visible to all room members.",{senderName:t});case a.b.WorldReadable:return()=>Object(d.a)("%(senderName)s made future room history visible to anyone.",{senderName:t});default:return()=>Object(d.a)("%(senderName)s made future room history visible to unknown (%(visibility)s).",{senderName:t,visibility:e.getContent().history_visibility})}},[c.b.RoomPowerLevels]:function(e){var t,n;const i=Object(O.a)(e);if(null===(t=e.getPrevContent())||void 0===t||!t.users||null===(n=e.getContent())||void 0===n||!n.users)return null;const s=e.getPrevContent().users_default||0,o=e.getContent().users_default||0,r=[];Object.keys(e.getContent().users).forEach((e=>{-1===r.indexOf(e)&&r.push(e)})),Object.keys(e.getPrevContent().users).forEach((e=>{-1===r.indexOf(e)&&r.push(e)}));const a=[];return r.forEach((t=>{let n=e.getPrevContent().users[t];Number.isInteger(n)||(n=s);let i=e.getContent().users[t];if(Number.isInteger(i)||(i=o),(n!==s||i!==o)&&i!==n){const s=I(e,t);a.push({userId:t,name:s,from:n,to:i})}})),a.length?()=>Object(d.a)("%(senderName)s changed the power level of %(powerLevelDiffText)s.",{senderName:i,powerLevelDiffText:a.map((e=>Object(d.a)("%(userId)s from %(fromPowerLevel)s to %(toPowerLevel)s",{userId:e.name,fromPowerLevel:u.b(e.from,s),toPowerLevel:u.b(e.to,o)}))).join(", ")}):null},[c.b.RoomPinnedEvents]:function(e,t){var n,i;if(!m.b.getValue("feature_pinning"))return null;const o=Object(O.a)(e),r=e.getRoomId(),a=null!==(n=e.getContent().pinned)&&void 0!==n?n:[],c=null!==(i=e.getPrevContent().pinned)&&void 0!==i?i:[],l=a.filter((e=>c.indexOf(e)<0)),u=c.filter((e=>a.indexOf(e)<0));if(1===l.length&&0===u.length){if(t){const e=l.pop();return()=>s.a.createElement("span",null,Object(d.a)("%(senderName)s pinned <a>a message</a> to this room. See all <b>pinned messages</b>.",{senderName:o},{a:t=>s.a.createElement(S.a,{kind:"link_inline",onClick:t=>Object(w.j)(r,e)},t),b:e=>s.a.createElement(S.a,{kind:"link_inline",onClick:T},e)}))}return()=>Object(d.a)("%(senderName)s pinned a message to this room. See all pinned messages.",{senderName:o})}if(1===u.length&&0===l.length){if(t){const e=u.pop();return()=>s.a.createElement("span",null,Object(d.a)("%(senderName)s unpinned <a>a message</a> from this room. See all <b>pinned messages</b>.",{senderName:o},{a:t=>s.a.createElement(S.a,{kind:"link_inline",onClick:t=>Object(w.j)(r,e)},t),b:e=>s.a.createElement(S.a,{kind:"link_inline",onClick:T},e)}))}return()=>Object(d.a)("%(senderName)s unpinned a message from this room. See all pinned messages.",{senderName:o})}return t?()=>s.a.createElement("span",null,Object(d.a)("%(senderName)s changed the <a>pinned messages</a> for the room.",{senderName:o},{a:e=>s.a.createElement(S.a,{kind:"link_inline",onClick:T},e)})):()=>Object(d.a)("%(senderName)s changed the pinned messages for the room.",{senderName:o})},[c.b.RoomServerAcl]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),n=e.getPrevContent(),i=e.getContent(),s=Array.isArray(n.deny)?n.deny:[],o=Array.isArray(n.allow)?n.allow:[];let r;return n.allow_ip_literals,r=0===s.length&&0===o.length?()=>Object(d.a)("%(senderDisplayName)s set the server ACLs for this room.",{senderDisplayName:t}):()=>Object(d.a)("%(senderDisplayName)s changed the server ACLs for this room.",{senderDisplayName:t}),Array.isArray(i.allow)||(i.allow=[]),0===i.allow.length?()=>r()+" "+Object(d.a)("🎉 All servers are banned from participating! This room can no longer be used."):r},[c.b.RoomTombstone]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return()=>Object(d.a)("%(senderDisplayName)s upgraded this room.",{senderDisplayName:t})},[c.b.RoomJoinRules]:function(e,t){const n=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().join_rule){case a.c.Public:return()=>Object(d.a)("%(senderDisplayName)s made the room public to whoever knows the link.",{senderDisplayName:n});case a.c.Invite:return()=>Object(d.a)("%(senderDisplayName)s made the room invite only.",{senderDisplayName:n});case a.c.Restricted:return t?()=>s.a.createElement("span",null,Object(d.a)("%(senderDisplayName)s changed who can join this room. <a>View settings</a>.",{senderDisplayName:n},{a:e=>s.a.createElement(S.a,{kind:"link_inline",onClick:k},e)})):()=>Object(d.a)("%(senderDisplayName)s changed who can join this room.",{senderDisplayName:n});default:return()=>Object(d.a)("%(senderDisplayName)s changed the join rule to %(rule)s",{senderDisplayName:n,rule:e.getContent().join_rule})}},[c.b.RoomGuestAccess]:function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().guest_access){case a.a.CanJoin:return()=>Object(d.a)("%(senderDisplayName)s has allowed guests to join the room.",{senderDisplayName:t});case a.a.Forbidden:return()=>Object(d.a)("%(senderDisplayName)s has prevented guests from joining the room.",{senderDisplayName:t});default:return()=>Object(d.a)("%(senderDisplayName)s changed guest access to %(rule)s",{senderDisplayName:t,rule:e.getContent().guest_access})}},"im.vector.modular.widgets":function(e){const t=Object(O.a)(e),{name:n,type:i,url:s}=e.getPrevContent(),{name:o,type:r,url:a}=e.getContent()||{};let c=o||n||r||i||"";return c&&c.length>0&&(c=c[0].toUpperCase()+c.slice(1)),a?s?()=>Object(d.a)("%(widgetName)s widget modified by %(senderName)s",{widgetName:c,senderName:t}):()=>Object(d.a)("%(widgetName)s widget added by %(senderName)s",{widgetName:c,senderName:t}):()=>Object(d.a)("%(widgetName)s widget removed by %(senderName)s",{widgetName:c,senderName:t})},[g.c]:function(e){const t=Object(O.a)(e);return()=>Object(d.a)("%(senderName)s has updated the room layout",{senderName:t})},[C.g]:C.P};for(const e of p.a)L[e]=j;for(const e of _.d.CALL_EVENT_TYPE.names)L[e]=R;function U(e,t){const n=(e.isState()?L:A)[e.getType()];return Boolean(null==n?void 0:n(e,!1,t))}function F(e){var t;let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2?arguments[2]:void 0;const s=(e.isState()?L:A)[e.getType()];return(null==s||null===(t=s(e,n,i))||void 0===t?void 0:t())||""}},function(e,t,n){"use strict";let i,s;n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),function(e){e.Manual="MANUAL",e.Alphabetic="ALPHABETIC",e.Recent="RECENT"}(i||(i={})),function(e){e.Importance="IMPORTANCE",e.Natural="NATURAL"}(s||(s={}))},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"b",(function(){return c}));var i=n(122),s=n.n(i),o=n(137);const r="local+";let a;!function(e){e[e.NEW=0]="NEW",e[e.CREATING=1]="CREATING",e[e.CREATED=2]="CREATED",e[e.ERROR=3]="ERROR"}(a||(a={}));class c extends o.Room{constructor(e,t,n){super(e,t,n,{pendingEventOrdering:o.PendingEventOrdering.Detached}),s()(this,"encrypted",!1),s()(this,"actualRoomId",void 0),s()(this,"targets",[]),s()(this,"afterCreateCallbacks",[]),s()(this,"state",a.NEW),this.name=this.getDefaultRoomName(n)}get isNew(){return this.state===a.NEW}get isCreated(){return this.state===a.CREATED}get isError(){return this.state===a.ERROR}}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(121),c=n(230),l=n(148);t.a=e=>{let{children:t,getTextToCopy:n,border:o=!0,className:d}=e;const[u,h]=Object(i.useState)(void 0),m=r()("mx_CopyableText",d,{mx_CopyableText_border:o});return s.a.createElement("div",{className:m},t,s.a.createElement(l.a,{title:null!=u?u:Object(a.a)("Copy"),onClick:async e=>{e.preventDefault();const t=await Object(c.b)(n());h(t?Object(a.a)("Copied!"):Object(a.a)("Failed to copy"))},className:"mx_CopyableText_copyButton",onHideTooltip:()=>{u&&h(void 0)}}))}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i),o=n(150),r=n(16);function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class l{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{keys:[]};s()(this,"_options",void 0),s()(this,"_items",void 0),this._options=t,this.setObjects(e),void 0===this._options.shouldMatchWordsOnly&&(this._options.shouldMatchWordsOnly=!0)}setObjects(e){this._items=new Map;for(const t of e){const e=Object(o.at)(t,this._options.keys);if(this._options.funcs)for(const n of this._options.funcs){const i=n(t);Array.isArray(i)?e.push(...i):e.push(i)}for(const[n,i]of Object.entries(e)){if(!i)continue;const e=this.processQuery(i);this._items.has(e)||this._items.set(e,[]),this._items.get(e).push({keyWeight:Number(n),object:t})}}}match(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;if(e=this.processQuery(e),this._options.shouldMatchWordsOnly&&(e=e.replace(/[^\w]/g,"")),0===e.length)return[];const n=[];for(const[t,i]of this._items.entries()){let s=t;this._options.shouldMatchWordsOnly&&(s=s.replace(/[^\w]/g,""));const o=s.indexOf(e);-1!==o&&n.push(...i.map((e=>c({index:o},e))))}n.sort(((e,t)=>{if(e.index<t.index)return-1;if(e.index===t.index){if(e.keyWeight<t.keyWeight)return-1;if(e.keyWeight===t.keyWeight)return 0}return 1}));const i=Object(o.uniq)(n.map((e=>e.object))),s=-1===t?i.length:t;return i.slice(0,s)}processQuery(e){return!1!==this._options.fuzzy?Object(r.J)(e.toLowerCase()).toLowerCase():e.toLowerCase()}}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(164),s=n(220),o=n(246),r=n(859);function a(e,t,n){const i=e.filter((e=>{if(e&&"join"===e.getMyMembership()){if(Object(s.a)(e))return!1;const i=Object(r.a)(e),a=e.currentState.getMembers().filter((e=>!i.includes(e.userId)&&e.membership&&Object(o.c)(e.membership)));if(a.find((e=>e.userId===t))&&2===a.length)return!0;const c=e.currentState.getStateEvents("m.room.third_party_invite")||[];return n&&1===a.length&&1===c.length}return!1})).sort(((e,t)=>t.getLastActiveTimestamp()-e.getLastActiveTimestamp()));if(i.length)return i[0]}function c(e,t){const n=a(i.a.shared().getDMRoomsForUserId(t).map((t=>e.getRoom(t))).filter((e=>null!==e)),t,!0);if(n)return n;const s=i.a.shared().getRoomIds();return a(Array.from(s).map((t=>e.getRoom(t))).filter((e=>null!==e)),t,!1)}},function(e,t,n){"use strict";n.d(t,"b",(function(){return p})),n.d(t,"a",(function(){return g}));var i=n(122),s=n.n(i),o=n(1),r=n(522),a=n(125),c=n(154),l=n(203),d=n(239),u=n(126),h=n(138),m=n(206);let p;!function(e){e.Call="call",e.ActiveCalls="active_calls"}(p||(p={}));class g extends l.a{static get instance(){return this._instance||(this._instance=new g,this._instance.start()),this._instance}constructor(){super(a.a),s()(this,"_activeCalls",new Set),s()(this,"calls",new Map),s()(this,"callListeners",new Map),s()(this,"onWidgets",(e=>{if(null===e)for(const e of this.matrixClient.getRooms())this.updateRoom(e);else{const t=this.matrixClient.getRoom(e);null!==t&&this.updateRoom(t)}})),s()(this,"onGroupCall",(e=>this.updateRoom(e.room)))}async onAction(){}async onReady(){for(const e of this.matrixClient.getRooms())this.updateRoom(e);this.matrixClient.on(r.b.Incoming,this.onGroupCall),this.matrixClient.on(r.b.Outgoing,this.onGroupCall),d.a.instance.on(c.b,this.onWidgets);const e=u.b.getValue("activeCallRoomIds");e.length&&await Promise.all([...e.map((async e=>{var t;o.a.log(`Cleaning up call state for room ${e}`),await(null===(t=this.getCall(e))||void 0===t?void 0:t.clean())})),u.b.setValue("activeCallRoomIds",null,h.a.DEVICE,[])])}async onNotReady(){for(const[e,t]of this.callListeners){for(const[n,i]of t)e.off(n,i);e.destroy()}this.callListeners.clear(),this.calls.clear(),this._activeCalls.clear(),this.matrixClient.off(r.b.Incoming,this.onGroupCall),this.matrixClient.off(r.b.Outgoing,this.onGroupCall),this.matrixClient.off(r.b.Ended,this.onGroupCall),d.a.instance.off(c.b,this.onWidgets)}get activeCalls(){return this._activeCalls}set activeCalls(e){this._activeCalls=e,this.emit(p.ActiveCalls,e),u.b.setValue("activeCallRoomIds",null,h.a.DEVICE,[...e].map((e=>e.roomId)))}updateRoom(e){if(!this.calls.has(e.roomId)){const t=m.a.get(e);if(t){const n=e=>{e===m.c.Connected?this.activeCalls=new Set([...this.activeCalls,t]):e===m.c.Disconnected&&(this.activeCalls=new Set([...this.activeCalls].filter((e=>e!==t))))},i=()=>{this.calls.delete(e.roomId);for(const[e,n]of this.callListeners.get(t))t.off(e,n);this.updateRoom(e)};t.on(m.b.ConnectionState,n),t.on(m.b.Destroy,i),this.calls.set(e.roomId,t),this.callListeners.set(t,new Map([[m.b.ConnectionState,n],[m.b.Destroy,i]]))}this.emit(p.Call,t,e.roomId)}}getCall(e){var t;return null!==(t=this.calls.get(e))&&void 0!==t?t:null}getActiveCall(e){const t=this.getCall(e);return null!==t&&this.activeCalls.has(t)?t:null}}s()(g,"_instance",void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a),l=n(124),d=n(121),u=n(153),h=n(143),m=n(187);class p extends r.a.Component{constructor(){super(...arguments),s()(this,"onMouseEnter",(()=>{this.props.onMouseEnter(this.props.dropdownKey)})),s()(this,"onClick",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onClick(this.props.dropdownKey)}))}render(){const e=c()({mx_Dropdown_option:!0,mx_Dropdown_option_highlight:this.props.highlighted});return r.a.createElement("div",{id:this.props.id,className:e,onClick:this.onClick,onMouseEnter:this.onMouseEnter,role:"option","aria-selected":this.props.highlighted,ref:this.props.inputRef},this.props.children)}}s()(p,"defaultProps",{disabled:!1});class g extends r.a.Component{constructor(e){super(e),s()(this,"buttonRef",Object(o.createRef)()),s()(this,"dropdownRootElement",null),s()(this,"ignoreEvent",null),s()(this,"childrenByKey",{}),s()(this,"onDocumentClick",(e=>{e!==this.ignoreEvent&&this.setState({expanded:!1})})),s()(this,"onRootClick",(e=>{this.ignoreEvent=e})),s()(this,"onAccessibleButtonClick",(e=>{if(this.props.disabled)return;const t=Object(u.a)().getAccessibilityAction(e);this.state.expanded?t===h.h.Enter?(this.props.onOptionChange(this.state.highlightedOption),this.close()):e.key||(this.setState({expanded:!1}),e.preventDefault()):(this.setState({expanded:!0}),e.preventDefault())})),s()(this,"onMenuOptionClick",(e=>{this.close(),this.props.onOptionChange(e)})),s()(this,"onKeyDown",(e=>{let t=!0;switch(Object(u.a)().getAccessibilityAction(e)){case h.h.Enter:this.props.onOptionChange(this.state.highlightedOption);case h.h.Escape:this.close();break;case h.h.ArrowDown:this.state.expanded?this.setState({highlightedOption:this.nextOption(this.state.highlightedOption)}):this.setState({expanded:!0});break;case h.h.ArrowUp:this.state.expanded?this.setState({highlightedOption:this.prevOption(this.state.highlightedOption)}):this.setState({expanded:!0});break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())})),s()(this,"onInputChange",(e=>{this.setState({searchQuery:e.currentTarget.value}),this.props.onSearchChange&&this.props.onSearchChange(e.currentTarget.value)})),s()(this,"collectRoot",(e=>{this.dropdownRootElement&&this.dropdownRootElement.removeEventListener("click",this.onRootClick,!1),e&&e.addEventListener("click",this.onRootClick,!1),this.dropdownRootElement=e})),s()(this,"setHighlightedOption",(e=>{this.setState({highlightedOption:e})})),this.reindexChildren(this.props.children);const t=r.a.Children.toArray(e.children)[0];this.state={expanded:!1,highlightedOption:t?t.key:null,searchQuery:""},document.addEventListener("click",this.onDocumentClick,!1)}componentDidUpdate(e){var t;if(Object(m.c)(this.props,e)&&null!==(t=this.props.children)&&void 0!==t&&t.length){var n;this.reindexChildren(this.props.children);const e=this.props.children[0];this.setState({highlightedOption:null!==(n=String(null==e?void 0:e.key))&&void 0!==n?n:null})}}componentWillUnmount(){document.removeEventListener("click",this.onDocumentClick,!1)}reindexChildren(e){this.childrenByKey={},r.a.Children.forEach(e,(e=>{this.childrenByKey[e.key]=e}))}close(){this.setState({expanded:!1}),this.buttonRef.current&&this.buttonRef.current.focus()}nextOption(e){const t=Object.keys(this.childrenByKey),n=t.indexOf(e);return t[(n+1)%t.length]}prevOption(e){const t=Object.keys(this.childrenByKey),n=t.indexOf(e);return t[n<=0?t.length-1:(n-1)%t.length]}scrollIntoView(e){e&&e.scrollIntoView({block:"nearest",behavior:"auto"})}getMenuOptions(){const e=r.a.Children.map(this.props.children,(e=>{const t=this.state.highlightedOption===e.key;return r.a.createElement(p,{id:`${this.props.id}__${e.key}`,key:e.key,dropdownKey:e.key,highlighted:t,onMouseEnter:this.setHighlightedOption,onClick:this.onMenuOptionClick,inputRef:t?this.scrollIntoView:void 0},e)}));return 0===e.length?[r.a.createElement("div",{key:"0",className:"mx_Dropdown_option",role:"option","aria-selected":!1},Object(d.a)("No results"))]:e}render(){let e;const t={};let n;if(this.props.menuWidth&&(t.width=this.props.menuWidth),this.state.expanded&&(this.props.searchEnabled&&(e=r.a.createElement("input",{id:`${this.props.id}_input`,type:"text",autoFocus:!0,className:"mx_Dropdown_option",onChange:this.onInputChange,value:this.state.searchQuery,role:"combobox","aria-autocomplete":"list","aria-activedescendant":`${this.props.id}__${this.state.highlightedOption}`,"aria-expanded":this.state.expanded,"aria-controls":`${this.props.id}_listbox`,"aria-disabled":this.props.disabled,"aria-label":this.props.label,onKeyDown:this.onKeyDown})),n=r.a.createElement("div",{className:"mx_Dropdown_menu",style:t,role:"listbox",id:`${this.props.id}_listbox`},this.getMenuOptions())),!e){const t=this.props.getShortOption?this.props.getShortOption(this.props.value):this.childrenByKey[this.props.value];e=r.a.createElement("div",{className:"mx_Dropdown_option",id:`${this.props.id}_value`},t||this.props.placeholder)}const i={mx_Dropdown:!0,mx_Dropdown_disabled:this.props.disabled};return this.props.className&&(i[this.props.className]=!0),r.a.createElement("div",{className:c()(i),ref:this.collectRoot},r.a.createElement(l.a,{className:"mx_Dropdown_input mx_no_textinput",onClick:this.onAccessibleButtonClick,"aria-haspopup":"listbox","aria-expanded":this.state.expanded,disabled:this.props.disabled,inputRef:this.buttonRef,"aria-label":this.props.label,"aria-describedby":`${this.props.id}_value`,"aria-owns":`${this.props.id}_input`,onKeyDown:this.onKeyDown},e,r.a.createElement("span",{className:"mx_Dropdown_arrow"}),n))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(245);function s(){const e=Object(i.c)();if(e){return!(!1===e.default)}return!0}},function(e,t,n){"use strict";n.r(t),n.d(t,"containsEmoji",(function(){return i}));const i=(e,t)=>t.some((t=>e.body&&e.body.includes(t)))},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(120),s=n(152),o=n(142);const r=e=>e,a=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r;const[n,a]=Object(i.useState)(e?t(e.currentState):void 0),c=Object(i.useCallback)((()=>{e&&a(t(e.currentState))}),[e,t]);return Object(o.c)(null==e?void 0:e.currentState,s.b.Update,c),Object(i.useEffect)((()=>(c(),()=>{a(void 0)})),[c]),n}},,,,function(e,t,n){"use strict";n.d(t,"d",(function(){return Y})),n.d(t,"b",(function(){return oe})),n.d(t,"a",(function(){return re})),n.d(t,"e",(function(){return ae})),n.d(t,"c",(function(){return ce}));var i=n(149),s=n(120),o=n.n(s),r=n(121),a=n(738),c=n(588),l=n(123),d=n(212);class u extends d.a{constructor(e,t){super(),this.setter=e,this.inverse=t}onChange(e,t,n){this.setter.call(l.a.get(),this.inverse?!n:n)}}var h=n(156);class m extends d.a{onChange(e,t,n){var i;null===(i=h.a.get())||void 0===i||i.reload()}}var p=n(125),g=n(129);class v extends d.a{constructor(){super()}onChange(e,t,n){p.a.dispatch({action:g.a.UpdateFontSize,size:n})}}var f=n(126);class b extends d.a{constructor(){super()}onChange(e,t,n){p.a.dispatch({action:g.a.UpdateSystemFont,useSystemFont:f.b.getValue("useSystemFont"),font:n})}}class y extends d.a{constructor(){super()}onChange(e,t,n){p.a.dispatch({action:g.a.UpdateSystemFont,useSystemFont:n,font:f.b.getValue("systemFont")})}}var S=n(138),E=n(208);class w extends d.a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];super(),this.uiFeatureName=e,this.forcedValue=t}getValueOverride(e,t,n,i){return this.settingDisabled?this.forcedValue:null}get settingDisabled(){return!f.b.getValue(this.uiFeatureName)}}var _=n(158);class C extends d.a{constructor(e){super(),this.controllers=e}getValueOverride(e,t,n,i){for(const s of this.controllers){const o=s.getValueOverride(e,t,n,i);if(null!=o)return o}return null}onChange(e,t,n){for(const i of this.controllers)i.onChange(e,t,n)}get settingDisabled(){for(const e of this.controllers)if(e.settingDisabled)return!0;return!1}}var O=n(177);class I extends d.a{getValueOverride(e,t,n,i){return!this.prefersReducedMotion()&&null}get settingDisabled(){return this.prefersReducedMotion()}prefersReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}}class R extends d.a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super(),this.settingName=e,this.forcedValue=t,this.incompatibleValue=n}getValueOverride(e,t,n,i){return this.incompatibleSetting?this.forcedValue:null}get settingDisabled(){return this.incompatibleSetting}get incompatibleSetting(){return"function"==typeof this.incompatibleValue?this.incompatibleValue(f.b.getValue(this.settingName)):f.b.getValue(this.settingName)===this.incompatibleValue}}var k=n(330),x=n(461),T=n(477),j=n(408),P=n(211),D=n(132),N=n(137),M=n(1),A=n(583),L=n(201),U=n(252);const F=e=>{let{onFinished:t}=e;const n=l.a.get(),i=f.b.getValue("feature_sliding_sync_proxy_url"),s=Object(U.a)((()=>async function(e){await e.http.authedRequest(N.Method.Post,"/sync",void 0,void 0,{localTimeoutMs:1e4,prefix:"/_matrix/client/unstable/org.matrix.msc3575"}),M.a.info("server natively support sliding sync OK")}(n).then((()=>!0),(()=>!1))),[],null);let a;a=null===s?Object(r.a)("Checking…"):s?Object(r.a)("Your server has native support"):Object(r.a)("Your server lacks native support");const c=Object(L.a)({async deriveData(e){let{value:t}=e;try{return await async function(e,t){const n=new AbortController,i=window.setTimeout((()=>n.abort()),1e4),s=await fetch(e+"/client/server.json",{signal:n.signal});if(clearTimeout(i),200!=s.status)throw new Error(`proxyHealthCheck: proxy server returned HTTP ${s.status}`);const o=await s.json();if(o.server!==t)throw new Error(`proxyHealthCheck: client using ${t} but server is as ${o.server}`);M.a.info("sliding sync proxy is OK")}(t,l.a.get().baseUrl),{}}catch(e){return{error:e}}},rules:[{key:"required",test:async e=>{let{value:t}=e;return!!t||s},invalid:()=>Object(r.a)("Your server lacks native support, you must specify a proxy")},{key:"working",final:!0,test:async(e,t)=>{let{error:n}=t;return!n},valid:()=>Object(r.a)("Looks good"),invalid:e=>{let{error:t}=e;return null==t?void 0:t.message}}]});return o.a.createElement(A.a,{title:Object(r.a)("Sliding Sync configuration"),description:o.a.createElement("div",null,o.a.createElement("div",null,o.a.createElement("b",null,Object(r.a)("To disable you will need to log out and back in, use with caution!"))),a),placeholder:s?Object(r.a)("Proxy URL (optional)"):Object(r.a)("Proxy URL"),value:i,button:Object(r.a)("Enable"),validator:c,onFinished:(e,n)=>{e?(f.b.setValue("feature_sliding_sync_proxy_url",null,S.a.DEVICE,n),t(!0)):t(!1)}})};var B=n(128);class V extends d.a{async beforeChange(e,t,n){const{finished:i}=B.b.createDialog(F),[s]=await i;return n===s}async onChange(){var e;null===(e=h.a.get())||void 0===e||e.reload()}get settingDisabled(){return f.b.getValue("feature_sliding_sync")}}var K=n(474),$=n(913),H=n(914);class W extends d.a{get settingDisabled(){return!0}}var q=n(122),G=n.n(q),z=n(737);class J extends z.a{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];super(),this.settingName=e,this.watchers=t,this.unstableFeatures=n,this.forcedValue=i,G()(this,"enabled",void 0)}get disabled(){return!this.enabled}set disabled(e){if(!e===this.enabled)return;this.enabled=!e;const t=f.b.firstSupportedLevel(this.settingName),n=f.b.getValue(this.settingName,null);this.watchers.notifyUpdate(this.settingName,null,t,n)}async initMatrixClient(e,t){this.disabled=!0;let n=!0;for(const e of this.unstableFeatures)if(n=await this.client.doesServerSupportUnstableFeature(e),!n)break;this.disabled=!n}getValueOverride(e,t,n,i){return this.settingDisabled?this.forcedValue:null}get settingDisabled(){return this.disabled}}const Y=new class{constructor(){G()(this,"watchers",new Map)}watchSetting(e,t,n){this.watchers.has(e)||this.watchers.set(e,new Map),this.watchers.get(e).has(t)||this.watchers.get(e).set(t,[]),this.watchers.get(e).get(t).push(n)}unwatchSetting(e){this.watchers.forEach((t=>{t.forEach((t=>{let n;for(;-1!==(n=t.indexOf(e));)t.splice(n,1)}))}))}notifyUpdate(e,t,n,i){if(!this.watchers.has(e))return;const s=this.watchers.get(e),o=[];null!==t&&s.has(t)&&o.push(...s.get(t)),t?s.has(null)&&o.push(...s.get(null)):o.push(...Array.from(s.values()).flat(1));for(const e of o)e(t,n,i)}},Q=[S.a.DEVICE,S.a.ROOM_DEVICE,S.a.ROOM_ACCOUNT,S.a.ACCOUNT,S.a.CONFIG],X=[S.a.ROOM_ACCOUNT,S.a.ACCOUNT],Z=[S.a.DEVICE,S.a.ROOM_DEVICE,S.a.ROOM_ACCOUNT,S.a.ACCOUNT,S.a.CONFIG,S.a.ROOM],ee=[S.a.DEVICE,S.a.ACCOUNT,S.a.CONFIG],te=[S.a.DEVICE,S.a.CONFIG],ne=[S.a.DEVICE],ie=[S.a.DEVICE,S.a.CONFIG],se=[S.a.CONFIG];let oe,re;!function(e){e[e.Messaging=0]="Messaging",e[e.Profile=1]="Profile",e[e.Spaces=2]="Spaces",e[e.Widgets=3]="Widgets",e[e.Rooms=4]="Rooms",e[e.VoiceAndVideo=5]="VoiceAndVideo",e[e.Moderation=6]="Moderation",e[e.Analytics=7]="Analytics",e[e.MessagePreviews=8]="MessagePreviews",e[e.Themes=9]="Themes",e[e.Encryption=10]="Encryption",e[e.Experimental=11]="Experimental",e[e.Developer=12]="Developer"}(oe||(oe={})),function(e){e.VoiceBroadcast="feature_voice_broadcast",e.VoiceBroadcastForceSmallChunks="feature_voice_broadcast_force_small_chunks"}(re||(re={}));const ae={[oe.Messaging]:Object(r.c)("Messaging"),[oe.Profile]:Object(r.c)("Profile"),[oe.Spaces]:Object(r.c)("Spaces"),[oe.Widgets]:Object(r.c)("Widgets"),[oe.Rooms]:Object(r.c)("Rooms"),[oe.VoiceAndVideo]:Object(r.c)("Voice & Video"),[oe.Moderation]:Object(r.c)("Moderation"),[oe.Analytics]:Object(r.c)("Analytics"),[oe.MessagePreviews]:Object(r.c)("Message Previews"),[oe.Themes]:Object(r.c)("Themes"),[oe.Encryption]:Object(r.c)("Encryption"),[oe.Experimental]:Object(r.c)("Experimental"),[oe.Developer]:Object(r.c)("Developer")},ce={feature_video_rooms:{isFeature:!0,labsGroup:oe.VoiceAndVideo,displayName:Object(r.c)("Video rooms"),supportedLevels:te,default:!1,controller:new m,betaInfo:{title:Object(r.c)("Video rooms"),caption:()=>o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(r.a)("A new way to chat over voice and video in %(brand)s.",{brand:D.b.get().brand})),o.a.createElement("p",null,Object(r.a)("Video rooms are always-on VoIP channels embedded within a room in %(brand)s.",{brand:D.b.get().brand}))),faq:()=>D.b.get().bug_report_endpoint_url&&o.a.createElement(o.a.Fragment,null,o.a.createElement("h4",null,Object(r.a)("How can I create a video room?")),o.a.createElement("p",null,Object(r.a)("Use the “+” button in the room section of the left panel.")),o.a.createElement("h4",null,Object(r.a)("Can I use text chat alongside the video call?")),o.a.createElement("p",null,Object(r.a)("Yes, the chat timeline is displayed alongside the video."))),feedbackLabel:"video-room-feedback",feedbackSubheading:Object(r.c)("Thank you for trying the beta, please go into as much detail as you can so we can improve it."),image:n(1574),requiresRefresh:!0}},feature_exploring_public_spaces:{isFeature:!0,labsGroup:oe.Spaces,displayName:Object(r.c)("Explore public spaces in the new search dialog"),supportedLevels:te,default:!1,controller:new J("feature_exploring_public_spaces",Y,["org.matrix.msc3827.stable"])},feature_msc3531_hide_messages_pending_moderation:{isFeature:!0,labsGroup:oe.Moderation,controller:new m,displayName:Object(r.c)("Let moderators hide messages pending moderation."),supportedLevels:te,default:!1},feature_report_to_moderators:{isFeature:!0,labsGroup:oe.Moderation,displayName:Object(r.c)("Report to moderators"),description:Object(r.c)("In rooms that support moderation, the “Report” button will let you report abuse to room moderators."),supportedLevels:te,default:!1},feature_latex_maths:{isFeature:!0,labsGroup:oe.Messaging,displayName:Object(r.c)("Render LaTeX maths in messages"),supportedLevels:te,default:!1},feature_mark_unread:{isFeature:!0,labsGroup:oe.Rooms,displayName:Object(r.c)("Mark rooms as unread"),supportedLevels:te,default:!0},feature_pinning:{isFeature:!0,labsGroup:oe.Messaging,displayName:Object(r.c)("Message Pinning"),supportedLevels:te,default:!0},feature_wysiwyg_composer:{isFeature:!0,labsGroup:oe.Messaging,displayName:Object(r.c)("Rich text editor"),description:Object(r.c)("Use rich text instead of Markdown in the message composer."),supportedLevels:te,default:!1},feature_state_counters:{isFeature:!0,labsGroup:oe.Rooms,displayName:Object(r.c)("Render simple counters in room header"),supportedLevels:te,default:!1},feature_mjolnir:{isFeature:!0,labsGroup:oe.Moderation,displayName:Object(r.c)("New ways to ignore people"),description:Object(r.c)("Currently experimental."),supportedLevels:te,default:!1},feature_custom_themes:{isFeature:!0,labsGroup:oe.Themes,displayName:Object(r.c)("Support adding custom themes"),supportedLevels:te,default:!1},feature_roomlist_preview_reactions_dms:{isFeature:!0,labsGroup:oe.MessagePreviews,displayName:Object(r.c)("Show message previews for reactions in DMs"),supportedLevels:te,default:!0,controller:new R("feature_roomlist_preview_reactions_all")},feature_roomlist_preview_reactions_all:{isFeature:!0,labsGroup:oe.MessagePreviews,displayName:Object(r.c)("Show message previews for reactions in all rooms"),supportedLevels:te,default:!0},feature_dehydration:{isFeature:!0,labsGroup:oe.Encryption,displayName:Object(r.c)("Offline encrypted messaging using dehydrated devices"),supportedLevels:te,default:!1},scShowUpdateAnnouncementRoomToast:{supportedLevels:ie,default:!0},useOnlyCurrentProfiles:{supportedLevels:ee,displayName:Object(r.c)("Show current avatar and name for users in message history"),default:!1},mjolnirRooms:{supportedLevels:[S.a.ACCOUNT],default:[]},mjolnirPersonalRoom:{supportedLevels:[S.a.ACCOUNT],default:null},feature_html_topic:{isFeature:!0,labsGroup:oe.Rooms,supportedLevels:te,displayName:Object(r.c)("Show HTML representation of room topics"),default:!1},feature_bridge_state:{isFeature:!0,labsGroup:oe.Rooms,supportedLevels:te,displayName:Object(r.c)("Show info about bridges in room settings"),default:!1},feature_breadcrumbs_v2:{isFeature:!0,labsGroup:oe.Rooms,supportedLevels:te,displayName:Object(r.c)("Use new room breadcrumbs"),default:!1},feature_right_panel_default_open:{isFeature:!0,labsGroup:oe.Rooms,supportedLevels:te,displayName:Object(r.c)("Right panel stays open"),description:Object(r.c)("Defaults to room member list."),default:!1},feature_poll_history:{isFeature:!0,labsGroup:oe.Rooms,supportedLevels:te,displayName:Object(r.c)("Polls history"),description:Object(r.c)("View a list of polls in a room. (Under active development)"),default:!1},feature_jump_to_date:{isFeature:!0,labsGroup:oe.Messaging,displayName:Object(r.c)("Jump to date (adds /jumptodate and jump to date headers)"),supportedLevels:te,default:!1,controller:new J("feature_jump_to_date",Y,["org.matrix.msc3030"])},"RoomList.backgroundImage":{supportedLevels:ee,default:null},sendReadReceipts:{supportedLevels:ee,displayName:Object(r.c)("Send read receipts"),default:!0},feature_sliding_sync:{isFeature:!0,labsGroup:oe.Developer,supportedLevels:ie,displayName:Object(r.c)("Sliding Sync mode"),description:Object(r.c)("Under active development, cannot be disabled."),shouldWarn:!0,default:!1,controller:new V},feature_sliding_sync_proxy_url:{supportedLevels:ie,default:""},feature_element_call_video_rooms:{isFeature:!0,supportedLevels:te,labsGroup:oe.VoiceAndVideo,displayName:Object(r.c)("Element Call video rooms"),controller:new m,default:!1},feature_group_calls:{isFeature:!0,supportedLevels:te,labsGroup:oe.VoiceAndVideo,displayName:Object(r.c)("New group call experience"),controller:new m,default:!1},feature_location_share_live:{isFeature:!0,labsGroup:oe.Messaging,supportedLevels:te,displayName:Object(r.c)("Live Location Sharing"),description:Object(r.c)("Temporary implementation. Locations persist in room history."),shouldWarn:!0,default:!1},feature_dynamic_room_predecessors:{isFeature:!0,labsGroup:oe.Rooms,supportedLevels:te,displayName:Object(r.c)("Dynamic room predecessors"),description:Object(r.c)("Enable MSC3946 (to support late-arriving room archives)"),shouldWarn:!0,default:!1},feature_favourite_messages:{isFeature:!0,labsGroup:oe.Messaging,supportedLevels:te,displayName:Object(r.c)("Favourite Messages"),description:Object(r.c)("Under active development."),default:!1},[re.VoiceBroadcast]:{isFeature:!0,labsGroup:oe.Messaging,supportedLevels:te,displayName:Object(r.c)("Voice broadcast"),default:!1},[re.VoiceBroadcastForceSmallChunks]:{supportedLevels:ne,displayName:Object(r.c)("Force 15s voice broadcast chunk length"),default:!1},feature_new_device_manager:{isFeature:!0,labsGroup:oe.Experimental,supportedLevels:te,displayName:Object(r.c)("Use new session manager"),default:!1,betaInfo:{title:Object(r.c)("New session manager"),caption:()=>o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(r.a)("Have greater visibility and control over all your sessions.")),o.a.createElement("p",null,Object(r.a)("Our new sessions manager provides better visibility of all your sessions, and greater control over them including the ability to remotely toggle push notifications.")))}},feature_rust_crypto:{isFeature:!0,labsGroup:oe.Developer,supportedLevels:ie,displayName:Object(r.c)("Rust cryptography implementation"),description:Object(r.c)("Under active development. Can currently only be enabled via config.json"),default:!1,controller:new W},baseFontSize:{displayName:Object(r.c)("Font size"),supportedLevels:ee,default:K.a.DEFAULT_SIZE,controller:new v},useCustomFontSize:{displayName:Object(r.c)("Use custom size"),supportedLevels:ee,default:!1},"MessageComposerInput.suggestEmoji":{supportedLevels:ee,displayName:Object(r.c)("Enable Emoji suggestions while typing"),default:!0,invertedSettingName:"MessageComposerInput.dontSuggestEmoji"},"MessageComposerInput.showStickersButton":{supportedLevels:ee,displayName:Object(r.c)("Show stickers button"),default:!0,controller:new w(_.b.Widgets,!1)},"MessageComposerInput.collapseButtons":{supportedLevels:ee,displayName:Object(r.c)("Collapse additional buttons"),default:!1,controller:new w(_.b.Widgets,!1)},"MessageComposerInput.showPollsButton":{supportedLevels:ee,displayName:Object(r.c)("Show polls button"),default:!0},"MessageComposerInput.insertTrailingColon":{supportedLevels:ee,displayName:Object(r.c)("Insert a trailing colon after user mentions at the start of a message"),default:!0},"Notifications.alwaysShowBadgeCounts":{supportedLevels:X,default:!1},feature_hidebold:{isFeature:!0,supportedLevels:ie,displayName:Object(r.c)("Hide notification dot (only display counters badges)"),labsGroup:oe.Rooms,default:!1},useCompactLayout:{supportedLevels:ne,displayName:Object(r.c)("Use a more compact 'Modern' layout"),default:!1,controller:new R("layout",!1,(e=>e!==O.a.Group))},borderRadius:{supportedLevels:ie,default:$.a.Default},showRedactions:{supportedLevels:Z,displayName:Object(r.c)("Show a placeholder for removed messages"),default:!1,invertedSettingName:"hideRedactions"},showJoinLeaves:{supportedLevels:Z,displayName:Object(r.c)("Show join/leave messages (invites/removes/bans unaffected)"),default:!0,invertedSettingName:"hideJoinLeaves"},showAvatarChanges:{supportedLevels:Z,displayName:Object(r.c)("Show avatar changes"),default:!0,invertedSettingName:"hideAvatarChanges"},showDisplaynameChanges:{supportedLevels:Z,displayName:Object(r.c)("Show display name changes"),default:!0,invertedSettingName:"hideDisplaynameChanges"},showReadReceipts:{supportedLevels:Q,displayName:Object(r.c)("Show read receipts sent by other users"),default:!0,invertedSettingName:"hideReadReceipts"},showTwelveHourTimestamps:{supportedLevels:ee,displayName:Object(r.c)("Show timestamps in 12 hour format (e.g. 2:30pm)"),default:!1},alwaysShowTimestamps:{supportedLevels:ee,displayName:Object(r.c)("Always show message timestamps"),default:!0},autoplayGifs:{supportedLevels:ee,displayName:Object(r.c)("Autoplay GIFs"),default:!0},autoplayVideo:{supportedLevels:ee,displayName:Object(r.c)("Autoplay videos"),default:!1},enableSyntaxHighlightLanguageDetection:{supportedLevels:ee,displayName:Object(r.c)("Enable automatic language detection for syntax highlighting"),default:!1},expandCodeByDefault:{supportedLevels:ee,displayName:Object(r.c)("Expand code blocks by default"),default:!1},showCodeLineNumbers:{supportedLevels:ee,displayName:Object(r.c)("Show line numbers in code blocks"),default:!0},scrollToBottomOnMessageSent:{supportedLevels:ee,displayName:Object(r.c)("Jump to the bottom of the timeline when you send a message"),default:!0},"Pill.shouldShowPillAvatar":{supportedLevels:ee,displayName:Object(r.c)("Show avatars in user and room mentions"),default:!0,invertedSettingName:"Pill.shouldHidePillAvatar"},"TextualBody.enableBigEmoji":{supportedLevels:ee,displayName:Object(r.c)("Enable big emoji in chat"),default:!0,invertedSettingName:"TextualBody.disableBigEmoji"},"MessageComposerInput.isRichTextEnabled":{supportedLevels:ee,default:!1},"MessageComposer.showFormatting":{supportedLevels:ee,default:!1},sendTypingNotifications:{supportedLevels:ee,displayName:Object(r.c)("Send typing notifications"),default:!0,invertedSettingName:"dontSendTypingNotifications"},showTypingNotifications:{supportedLevels:ee,displayName:Object(r.c)("Show typing notifications"),default:!0},ctrlFForSearch:{supportedLevels:ee,displayName:E.a?Object(r.c)("Use Command + F to search timeline"):Object(r.c)("Use Ctrl + F to search timeline"),default:!0},"MessageComposerInput.ctrlEnterToSend":{supportedLevels:ee,displayName:E.a?Object(r.c)("Use Command + Enter to send a message"):Object(r.c)("Use Ctrl + Enter to send a message"),default:!1},"MessageComposerInput.surroundWith":{supportedLevels:ee,displayName:Object(r.c)("Surround selected text when typing special characters"),default:!1},"MessageComposerInput.autoReplaceEmoji":{supportedLevels:ee,displayName:Object(r.c)("Automatically replace plain text Emoji"),default:!1},"MessageComposerInput.useMarkdown":{supportedLevels:ee,displayName:Object(r.c)("Enable Markdown"),description:()=>Object(r.a)("Start messages with <code>/plain</code> to send without markdown and <code>/md</code> to send with.",{},{code:e=>o.a.createElement("code",null,e)}),default:!0},"VideoView.flipVideoHorizontally":{supportedLevels:ee,displayName:Object(r.c)("Mirror local video feed"),default:!1},light_theme:{supportedLevels:ee,default:"light",controller:new c.a("light")},dark_theme:{supportedLevels:ee,default:"dark",controller:new c.a("dark")},theme_in_use:{supportedLevels:ie,default:k.a.System},custom_themes:{supportedLevels:ee,default:[]},userNameColorModeDM:{supportedLevels:ie,default:x.a.Uniform},userNameColorModeGroup:{supportedLevels:ie,default:x.a.Uniform},userNameColorModePublic:{supportedLevels:ie,default:x.a.Uniform},useSystemFont:{supportedLevels:ne,default:!1,displayName:Object(r.c)("Use a system font"),controller:new y},systemFont:{supportedLevels:ne,default:"",displayName:Object(r.c)("System font name"),controller:new b},webRtcAllowPeerToPeer:{supportedLevels:ie,displayName:Object(r.c)("Allow Peer-to-Peer for 1:1 calls"),description:Object(r.c)("When enabled, the other party might be able to see your IP address"),default:!0,invertedSettingName:"webRtcForceTURN"},webrtc_audiooutput:{supportedLevels:ne,default:"default"},webrtc_audioinput:{supportedLevels:ne,default:"default"},webrtc_videoinput:{supportedLevels:ne,default:"default"},webrtc_audio_autoGainControl:{supportedLevels:ne,displayName:Object(r.c)("Automatic gain control"),default:!0},webrtc_audio_echoCancellation:{supportedLevels:ne,displayName:Object(r.c)("Echo cancellation"),default:!0},webrtc_audio_noiseSuppression:{supportedLevels:ne,displayName:Object(r.c)("Noise suppression"),default:!0},language:{supportedLevels:ie,default:"en"},breadcrumb_rooms:{supportedLevels:[S.a.ACCOUNT],default:[]},recent_emoji:{supportedLevels:[S.a.ACCOUNT],default:[]},"SpotlightSearch.recentSearches":{supportedLevels:[S.a.ACCOUNT],default:[]},"SpotlightSearch.showNsfwPublicRooms":{supportedLevels:ee,displayName:Object(r.c)("Show NSFW content"),default:!1},room_directory_servers:{supportedLevels:[S.a.ACCOUNT],default:[]},integrationProvisioning:{supportedLevels:[S.a.ACCOUNT],default:!0},allowedWidgets:{supportedLevels:[S.a.ROOM_ACCOUNT,S.a.ROOM_DEVICE],supportedLevelsAreOrdered:!0,default:{}},analyticsOptIn:{supportedLevels:ie,default:!1},pseudonymousAnalyticsOptIn:{supportedLevels:[S.a.ACCOUNT],displayName:Object(r.c)("Send analytics data"),default:null},deviceClientInformationOptIn:{supportedLevels:[S.a.ACCOUNT],displayName:Object(r.c)("Record the client name, version, and url to recognise sessions more easily in session manager"),default:!1},"FTUE.useCaseSelection":{supportedLevels:ee,default:null},autocompleteDelay:{supportedLevels:ie,default:200},readMarkerInViewThresholdMs:{supportedLevels:ie,default:3e3},readMarkerOutOfViewThresholdMs:{supportedLevels:ie,default:3e4},blacklistUnverifiedDevices:{supportedLevels:[S.a.ROOM_DEVICE,S.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:{default:Object(r.c)("Never send encrypted messages to unverified sessions from this session"),"room-device":Object(r.c)("Never send encrypted messages to unverified sessions in this room from this session")},default:!1,controller:new w(_.b.AdvancedEncryption)},urlPreviewsEnabled:{supportedLevels:Z,displayName:{default:Object(r.c)("Enable inline URL previews by default"),"room-account":Object(r.c)("Enable URL previews for this room (only affects you)"),room:Object(r.c)("Enable URL previews by default for participants in this room")},default:!0,controller:new w(_.b.URLPreviews)},urlPreviewsEnabled_e2ee:{supportedLevels:[S.a.ROOM_DEVICE,S.a.ROOM_ACCOUNT],displayName:{"room-account":Object(r.c)("Enable URL previews for this room (only affects you)")},default:!1,controller:new w(_.b.URLPreviews)},youtubeEmbedPlayer:{supportedLevels:ee,displayName:Object(r.c)("Enable YouTube embed player"),default:!0,controller:new w(_.b.YoutubeEmbedPlayer)},notificationsEnabled:{supportedLevels:ne,default:!1,controller:new a.b},soundPack:{displayName:Object(r.c)("Sound pack"),supportedLevels:ie,default:H.a.Schildi},deviceNotificationsEnabled:{supportedLevels:[S.a.DEVICE],default:!0},notificationSound:{supportedLevels:X,default:!1},notificationBodyEnabled:{supportedLevels:ne,default:!0,controller:new a.a},audioNotificationsEnabled:{supportedLevels:ne,default:!0},enableWidgetScreenshots:{supportedLevels:ee,displayName:Object(r.c)("Enable widget screenshots on supported widgets"),default:!1},promptBeforeInviteUnknownUsers:{supportedLevels:ee,displayName:Object(r.c)("Prompt before sending invites to potentially invalid matrix IDs"),default:!0},widgetOpenIDPermissions:{supportedLevels:ne,default:{allow:[],deny:[]}},unifiedRoomList:{supportedLevels:ee,displayName:Object(r.c)("Show people and rooms in a combined list"),default:!0,controller:new m},roomListStyle:{supportedLevels:ee,default:T.a.Roomy,controller:new m},breadcrumbs:{supportedLevels:ee,displayName:Object(r.c)("Show shortcuts to recently viewed rooms above the room list"),default:!0,controller:new R("feature_breadcrumbs_v2",!0)},"FTUE.userOnboardingButton":{supportedLevels:ee,displayName:Object(r.c)("Show shortcut to welcome checklist above the room list"),default:!0},showHiddenEventsInTimeline:{displayName:Object(r.c)("Show hidden events in timeline"),supportedLevels:ne,default:!1},lowBandwidth:{supportedLevels:ie,displayName:Object(r.c)("Low bandwidth mode"),description:Object(r.c)("Requires compatible homeserver."),default:!1,controller:new m,shouldWarn:!0},fallbackICEServerAllowed:{supportedLevels:ne,displayName:Object(r.c)("Allow fallback call assist server (turn.matrix.org)"),description:Object(r.c)("Only applies if your homeserver does not offer one. Your IP address would be shared during a call."),default:null},showImages:{supportedLevels:ee,displayName:Object(r.c)("Show previews/thumbnails for images"),default:!0},"RightPanel.phasesGlobal":{supportedLevels:[S.a.DEVICE],default:null},"RightPanel.phases":{supportedLevels:[S.a.ROOM_DEVICE],default:null},enableEventIndexing:{supportedLevels:ne,displayName:Object(r.c)("Enable message search in encrypted rooms"),default:!0},crawlerSleepTime:{supportedLevels:ne,displayName:Object(r.c)("How fast should messages be downloaded."),default:3e3},showCallButtonsInComposer:{supportedLevels:ie,default:!0,controller:new w(_.b.Voip)},"e2ee.manuallyVerifyAllSessions":{supportedLevels:ne,displayName:Object(r.c)("Manually verify all remote sessions"),default:!1,controller:new C([new w(_.b.AdvancedEncryption),new u(i.d.prototype.setCryptoTrustCrossSignedDevices,!0)])},ircDisplayNameWidth:{supportedLevels:[S.a.ROOM_DEVICE,S.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:Object(r.c)("IRC display name width"),default:80},layout:{supportedLevels:ee,default:O.a.Bubble},singleSideBubbles:{supportedLevels:Z,displayName:Object(r.c)("Show message bubbles on one side only"),default:!1},adaptiveSideBubbles:{supportedLevels:Z,displayName:Object(r.c)("Show message bubbles depending on the width either on both sides or only on one side"),default:!0},"Images.size":{supportedLevels:ee,default:j.a.Normal},showChatEffects:{supportedLevels:Z,displayName:Object(r.c)("Show chat effects (animations when receiving e.g. confetti)"),default:!0,controller:new I},"Performance.addSendMessageTimingMetadata":{supportedLevels:[S.a.CONFIG],default:!1},"Widgets.pinned":{supportedLevels:X,default:{}},"Widgets.layout":{supportedLevels:X,default:{}},"Spaces.allRoomsInHome":{displayName:Object(r.c)("Show all rooms in Home"),description:Object(r.c)("All rooms you're in will appear in Home."),supportedLevels:ee,default:!0},"Spaces.showSpaceDMBadges":{displayName:Object(r.c)("Show notification badges for People in Spaces"),supportedLevels:ee,default:!0},"Spaces.returnToPreviouslyOpenedRoom":{displayName:Object(r.c)("Return to the room previously opened in a space"),description:Object(r.c)("If disabled, the space overview will be shown when switching to another space."),supportedLevels:ee,default:!1},"Spaces.enabledMetaSpaces":{supportedLevels:ee,default:{[P.a.Home]:!0}},"Spaces.showPeopleInSpace":{supportedLevels:[S.a.ROOM_ACCOUNT],default:!1},developerMode:{displayName:Object(r.c)("Developer mode"),supportedLevels:ee,default:!1},automaticErrorReporting:{displayName:Object(r.c)("Automatically send debug logs on any error"),supportedLevels:ee,default:!1,controller:new m},automaticDecryptionErrorReporting:{displayName:Object(r.c)("Automatically send debug logs on decryption errors"),supportedLevels:ne,default:!1,controller:new m},automaticKeyBackNotEnabledReporting:{displayName:Object(r.c)("Automatically send debug logs when key backup is not functioning"),supportedLevels:ie,default:!1},debug_scroll_panel:{supportedLevels:ne,default:!1},debug_timeline_panel:{supportedLevels:ne,default:!1},debug_registration:{supportedLevels:ne,default:!1},debug_animation:{supportedLevels:ne,default:!1},debug_legacy_call_handler:{supportedLevels:ne,default:!1},audioInputMuted:{supportedLevels:ne,default:!1},videoInputMuted:{supportedLevels:ne,default:!1},activeCallRoomIds:{supportedLevels:ne,default:[]},[_.b.RoomHistorySettings]:{supportedLevels:se,default:!0},[_.b.AdvancedEncryption]:{supportedLevels:se,default:!0},[_.b.URLPreviews]:{supportedLevels:se,default:!0},[_.b.Widgets]:{supportedLevels:se,default:!0},[_.b.Voip]:{supportedLevels:se,default:!0},[_.b.Feedback]:{supportedLevels:se,default:!0},[_.b.Registration]:{supportedLevels:se,default:!0},[_.b.PasswordReset]:{supportedLevels:se,default:!0},[_.b.Deactivate]:{supportedLevels:se,default:!0},[_.b.ShareQRCode]:{supportedLevels:se,default:!0},[_.b.ShareSocial]:{supportedLevels:se,default:!0},[_.b.IdentityServer]:{supportedLevels:se,default:!0,controller:new w(_.b.ThirdPartyID)},[_.b.ThirdPartyID]:{supportedLevels:se,default:!0},[_.b.AdvancedSettings]:{supportedLevels:se,default:!0},[_.b.TimelineEnableRelativeDates]:{supportedLevels:se,default:!0},[_.b.YoutubeEmbedPlayer]:{supportedLevels:se,default:!0},[_.b.BulkUnverifiedSessionsReminder]:{supportedLevels:se,default:!0},"Electron.autoLaunch":{supportedLevels:[S.a.PLATFORM],displayName:Object(r.c)("Start automatically after system login"),default:!1},"Electron.warnBeforeExit":{supportedLevels:[S.a.PLATFORM],displayName:Object(r.c)("Warn before quitting"),default:!0},"Electron.alwaysShowMenuBar":{supportedLevels:[S.a.PLATFORM],displayName:Object(r.c)("Always show the window menu bar"),default:!1},"Electron.showTrayIcon":{supportedLevels:[S.a.PLATFORM],displayName:Object(r.c)("Show tray icon and minimise window to it on close"),default:!0},"Electron.enableHardwareAcceleration":{supportedLevels:[S.a.PLATFORM],displayName:Object(r.c)("Enable hardware acceleration"),default:!0}}},function(e,t,n){"use strict";n.d(t,"e",(function(){return I})),n.d(t,"f",(function(){return R})),n.d(t,"g",(function(){return x})),n.d(t,"d",(function(){return T})),n.d(t,"a",(function(){return D})),n.d(t,"b",(function(){return N})),n.d(t,"c",(function(){return M}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(1),c=n(189),l=n(13),d=n.n(l);class u{constructor(e){d()(this,"relations",void 0),this.relations=e.filter((e=>!!e))}getRelations(){return this.relations.reduce(((e,t)=>[...e,...t.getRelations()]),[])}on(e,t){this.relations.forEach((n=>n.on(e,t)))}off(e,t){this.relations.forEach((n=>n.off(e,t)))}}var h=n(460),m=n(55),p=n(385);class g extends h.a{get answerIds(){return this.internalAnswerIds}get spoiled(){return this.internalSpoiled}constructor(e){super(e),d()(this,"internalAnswerIds",[]),d()(this,"internalSpoiled",!1),d()(this,"pollEventId",void 0);const t=this.wireContent["m.relates_to"];if(!m.d.matches(null==t?void 0:t.rel_type)||"string"!=typeof(null==t?void 0:t.event_id))throw new p.a("Relationship must be a reference to an event");this.pollEventId=t.event_id,this.validateAgainst(null)}validateAgainst(e){var t;const n=c.d.findIn(this.wireContent);if(!Array.isArray(null==n?void 0:n.answers))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);let i=null!==(t=null==n?void 0:n.answers)&&void 0!==t?t:[];if(i.some((e=>"string"!=typeof e))||0===i.length)return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);if(e){if(i.some((t=>!e.answers.some((e=>e.id===t)))))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);i=i.slice(0,e.maxSelections)}this.internalAnswerIds=i,this.internalSpoiled=!1}isEquivalentTo(e){return Object(m.e)(e,c.d)}serialize(){return{type:c.d.name,content:{"m.relates_to":{rel_type:m.d.name,event_id:this.pollEventId},[c.d.name]:{answers:this.spoiled?void 0:this.answerIds}}}}static from(e,t){return new g({type:c.d.name,content:{"m.relates_to":{rel_type:m.d.name,event_id:t},[c.d.name]:{answers:e}}})}}var v=n(420),f=n(121),b=n(128),y=n(214),S=n(133),E=n(145),w=n(795),_=n(123),C=n(135),O=n(1e3);function I(e,t){if(!e.getId())return a.a.warn("findTopAnswer: Poll event needs an event ID to fetch relations in order to determine the top answer - assuming no best answer"),"";const n=e.unstableExtensibleEvent;if(null==n||!n.isEquivalentTo(c.e))return a.a.warn("Failed to parse poll to determine top answer - assuming no best answer"),"";const i=M(N(D(t)),n),s=Math.max(...i.values()),o=[];for(const[e,t]of i)t==s&&o.push(e);const r=o.map((e=>{var t,i;return null!==(t=null===(i=n.answers.find((t=>t.id===e)))||void 0===i?void 0:i.text)&&void 0!==t?t:""}));return Object(y.b)(r,3)}function R(e,t){const n=t.getRoom(e.getRoomId()),i=null==n?void 0:n.polls.get(e.getId());return!(!i||i.isFetchingResponses)&&i.isEnded}function k(e,t){if(!t)return!1;const n=e.getId();if(!n)return!1;const i=function(e,t){const n=[],i=e(t,"m.reference",c.d.name);i&&n.push(i);const s=e(t,"m.reference",c.d.altName);return s&&n.push(s),new u(n)}(t,n);return i.getRelations().length>0}function x(e,t){var n,i;k(e,t)?b.b.createDialog(E.a,{title:Object(f.a)("Can't edit poll"),description:Object(f.a)("Sorry, you can't edit a poll after votes have been cast.")}):b.b.createDialog(w.a,{room:_.a.get().getRoom(e.getRoomId()),threadId:null!==(n=null===(i=e.getThread())||void 0===i?void 0:i.id)&&void 0!==n?n:null,editingMxEvent:e},"mx_CompoundDialog",!1,!0)}class T extends r.a.Component{constructor(e){super(e),s()(this,"context",void 0),s()(this,"seenEventIds",[]),s()(this,"onResponsesChange",(e=>{this.setState({voteRelations:e}),this.onRelationsChange()})),s()(this,"onRelationsChange",(()=>{this.unselectIfNewEventFromMe()})),this.state={selected:null,pollInitialised:!1}}componentDidMount(){const e=this.context.getRoom(this.props.mxEvent.getRoomId()),t=null==e?void 0:e.polls.get(this.props.mxEvent.getId());t?this.setPollInstance(t):null==e||e.on(v.b.New,this.setPollInstance.bind(this))}componentWillUnmount(){this.removeListeners()}async setPollInstance(e){if(e.pollId!==this.props.mxEvent.getId())return;this.setState({poll:e},(()=>{this.addListeners()}));const t=await e.getResponses();this.setState({pollInitialised:!0,voteRelations:t})}addListeners(){var e,t,n;null===(e=this.state.poll)||void 0===e||e.on(v.b.Responses,this.onResponsesChange),null===(t=this.state.poll)||void 0===t||t.on(v.b.End,this.onRelationsChange),null===(n=this.state.poll)||void 0===n||n.on(v.b.UndecryptableRelations,this.render.bind(this))}removeListeners(){this.state.poll&&(this.state.poll.off(v.b.Responses,this.onResponsesChange),this.state.poll.off(v.b.End,this.onRelationsChange),this.state.poll.off(v.b.UndecryptableRelations,this.render.bind(this)))}selectOption(e){var t,n;if(null!==(t=this.state.poll)&&void 0!==t&&t.isEnded)return;const i=this.collectUserVotes(),s=this.context.getSafeUserId();if(e===(null===(n=i.get(s))||void 0===n?void 0:n.answers[0]))return;const o=g.from([e],this.props.mxEvent.getId()).serialize();this.context.sendEvent(this.props.mxEvent.getRoomId(),o.type,o.content).catch((e=>{console.error("Failed to submit poll response event:",e),b.b.createDialog(E.a,{title:Object(f.a)("Vote not registered"),description:Object(f.a)("Sorry, your vote was not registered. Please try again.")})})),this.setState({selected:e})}collectUserVotes(){return this.state.voteRelations?N(D(this.state.voteRelations),this.context.getUserId(),this.state.selected):new Map}unselectIfNewEventFromMe(){var e;const t=((null===(e=this.state.voteRelations)||void 0===e?void 0:e.getRelations())||[]).filter((e=>!this.seenEventIds.includes(e.getId())));let n=this.state.selected;if(t.length>0)for(const e of t)e.getSender()===this.context.getUserId()&&(n=null);const i=t.map((e=>e.getId()));this.seenEventIds=this.seenEventIds.concat(i),this.setState({selected:n})}totalVotes(e){let t=0;for(const n of e.values())t+=n;return t}render(){var e;const{poll:t,pollInitialised:n}=this.state;if(null==t||!t.pollEvent)return null;const i=t.pollEvent,s=this.props.mxEvent.getId(),o=!n||t.isFetchingResponses,a=this.collectUserVotes(),l=M(a,i),d=this.totalVotes(l),u=Math.max(...l.values()),h=this.context.getUserId(),m=null==a||null===(e=a.get(h))||void 0===e?void 0:e.answers[0],p=c.b.matches(i.kind.name),g=t.isEnded||p&&void 0!==m;let v;v=g&&t.undecryptableRelationsCount?Object(f.a)("Due to decryption errors, some votes may not be counted"):t.isEnded?Object(f.a)("Final result based on %(count)s votes",{count:d}):p?void 0===m?0===d?Object(f.a)("No votes cast"):Object(f.a)("%(count)s votes cast. Vote to see the results",{count:d}):Object(f.a)("Based on %(count)s votes",{count:d}):Object(f.a)("Results will be visible when the poll is ended");const b=this.props.mxEvent.replacingEvent()?r.a.createElement("span",{className:"mx_MPollBody_edited"}," (",Object(f.a)("edited"),")"):null;return r.a.createElement("div",{className:"mx_MPollBody"},r.a.createElement("h2",{"data-testid":"pollQuestion"},i.question.text,b),r.a.createElement("div",{className:"mx_MPollBody_allOptions"},i.answers.map((e=>{let n=0;var i;g&&(n=null!==(i=l.get(e.id))&&void 0!==i?i:0);const o=!t.isEnded&&m===e.id||t.isEnded&&n===u;return r.a.createElement(O.a,{key:e.id,pollId:s,answer:e,isChecked:o,isEnded:t.isEnded,voteCount:n,totalVoteCount:d,displayVoteCount:g,onOptionSelected:this.selectOption.bind(this)})}))),r.a.createElement("div",{"data-testid":"totalVotes",className:"mx_MPollBody_totalVotes"},v,o&&r.a.createElement(C.a,{w:16,h:16}),this.props.scBubbleTimestamp))}}s()(T,"contextType",S.a);class j{constructor(e,t,n){this.ts=e,this.sender=t,this.answers=n}}function P(e){const t=e.unstableExtensibleEvent;if(null==t||!t.isEquivalentTo(c.d))throw new Error("Failed to parse Poll Response Event to determine user response");return new j(e.getTs(),e.getSender(),t.answerIds)}function D(e){return e?e.getRelations().map(P):[]}function N(e,t,n){const i=new Map;for(const t of e){const e=i.get(t.sender);(!e||e.ts<t.ts)&&i.set(t.sender,t)}return n&&t&&i.set(t,new j(0,t,[n])),i}function M(e,t){const n=new Map;for(const i of e.values()){const e=g.from(i.answers,"$irrelevant");if(e.validateAgainst(t),!e.spoiled)for(const t of e.answerIds)n.has(t)?n.set(t,n.get(t)+1):n.set(t,1)}return n}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(13),s=n.n(i),o=n(518),r=n(171);class a{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,n;const i=(null===(t=e.getUnsigned())||void 0===t?void 0:t["m.relations"])||{},s=Object.keys(i),o=[];return this.userId&&null!=i&&null!==(n=i[r.d.name])&&void 0!==n&&n.current_user_participated&&o.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url,s,o)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[r.b.name]:this.filterJson[r.b.name]||[],[r.a.name]:this.filterJson[r.a.name]||[]}}checkFields(e,t,n,i,s,o){const a={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const n=t.slice(0,-1);return e.slice(0,n.length)===n}return e===t}(n,e)}};for(const e in a){const t=a[e],n="not_"+e,i=this.filterJson[n];if(null!=i&&i.some(t))return!1;const s=this.filterJson[e];if(s&&!s.some(t))return!1}const c=this.filterJson.contains_url;if(void 0!==c&&c!==i)return!1;const l=this.filterJson[r.a.name];if(void 0!==l&&!this.arrayMatchesFilter(l,s))return!1;const d=this.filterJson[r.b.name];return!(void 0!==d&&!this.arrayMatchesFilter(d,o))}arrayMatchesFilter(e,t){return t.length>0&&e.every((e=>t.includes(e)))}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function d(e,t,n){const i=t.split(".");let s=e;for(let e=0;e<i.length-1;e++)s[i[e]]||(s[i[e]]={}),s=s[i[e]];s[i[i.length-1]]=n}class u{static fromJson(e,t,n){const i=new u(e,t);return i.setDefinition(n),i}constructor(e,t){this.userId=e,this.filterId=t,s()(this,"definition",{}),s()(this,"roomFilter",void 0),s()(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;const t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms)),this.roomFilter=new a(n,this.userId),this.roomTimelineFilter=new a((null==t?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){d(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,n,i;this.definition=l(l({},this.definition),{},{room:l(l({},null===(t=this.definition)||void 0===t?void 0:t.room),{},{timeline:l(l({},null===(n=this.definition)||void 0===n||null===(i=n.room)||void 0===i?void 0:i.timeline),{},{[o.a.name]:e})})})}setLazyLoadMembers(e){d(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){d(this.definition,"room.include_leave",e)}}s()(u,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},,function(e,t,n){"use strict";n.d(t,"a",(function(){return O}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a),l=n(141),d=n(224),u=n(130),h=n(161),m=n(15),p=n(165),g=n(250),v=n(218),f=n(123),b=n(132);var y=n(121),S=n(247),E=n(164);const w=new m.c("busy","org.matrix.msc3026.busy");var _;function C(e){switch(e){case _.Globe:return Object(y.a)("This room is public");case _.PresenceOnline:return Object(y.a)("Online");case _.PresenceAway:return Object(y.a)("Away");case _.PresenceOffline:return Object(y.a)("Offline");case _.PresenceBusy:return Object(y.a)("Busy")}}!function(e){e.None="NONE",e.Globe="GLOBE",e.PresenceOnline="ONLINE",e.PresenceAway="AWAY",e.PresenceOffline="OFFLINE",e.PresenceBusy="BUSY"}(_||(_={}));class O extends r.a.PureComponent{constructor(e){super(e),s()(this,"_dmUser",void 0),s()(this,"isUnmounted",!1),s()(this,"isWatchingTimeline",!1),s()(this,"onRoomTimeline",((e,t)=>{if(!this.isUnmounted&&this.props.room.roomId===(null==t?void 0:t.roomId)&&(e.getType()===u.b.RoomJoinRules||e.getType()===u.b.RoomMember)){const e=this.calculateIcon();e!==this.state.icon&&this.setState({icon:e})}})),s()(this,"onPresenceUpdate",(()=>{if(this.isUnmounted)return;const e=this.getPresenceIcon();e!==this.state.icon&&this.setState({icon:e})})),this.state={notificationState:v.a.instance.getRoomState(this.props.room),icon:this.calculateIcon()}}componentWillUnmount(){this.isUnmounted=!0,this.isWatchingTimeline&&this.props.room.off(l.d.Timeline,this.onRoomTimeline),this.dmUser=null}get isPublicRoom(){const e=this.props.room.currentState.getStateEvents(u.b.RoomJoinRules,"");return(e&&e.getContent().join_rule)===h.c.Public}get dmUser(){return this._dmUser}set dmUser(e){const t=this._dmUser;this._dmUser=e,t&&t!==this._dmUser&&(t.off(d.b.CurrentlyActive,this.onPresenceUpdate),t.off(d.b.Presence,this.onPresenceUpdate)),this._dmUser&&t!==this._dmUser&&(this._dmUser.on(d.b.CurrentlyActive,this.onPresenceUpdate),this._dmUser.on(d.b.Presence,this.onPresenceUpdate))}getPresenceIcon(){if(!this.dmUser)return _.None;let e=_.None;const t=this.dmUser.currentlyActive||"online"===this.dmUser.presence;return w.matches(this.dmUser.presence)?e=_.PresenceBusy:t?e=_.PresenceOnline:"offline"===this.dmUser.presence?e=_.PresenceOffline:"unavailable"===this.dmUser.presence&&(e=_.PresenceAway),e}calculateIcon(){let e=_.None;const t=E.a.shared().getUserIdForRoomId(this.props.room.roomId);return t&&2===this.props.room.getJoinedMemberCount()?function(){const e=f.a.get().baseUrl,t=b.b.get("enable_presence_by_hs_url");return!t||!(!t[e]&&void 0!==t[e])}()&&(this.dmUser=f.a.get().getUser(t),e=this.getPresenceIcon()):(e=this.isPublicRoom?_.Globe:_.None,this.isWatchingTimeline||(this.props.room.on(l.d.Timeline,this.onRoomTimeline),this.isWatchingTimeline=!0)),e}render(){let e,t;this.props.displayBadge&&this.state.notificationState&&(e=r.a.createElement(g.a,{notification:this.state.notificationState,forceCount:this.props.forceCount,roomId:this.props.room.roomId})),this.state.icon!==_.None&&(t=r.a.createElement(S.a,{tooltip:C(this.state.icon),tooltipProps:this.props.tooltipProps,class:`mx_DecoratedRoomAvatar_icon mx_DecoratedRoomAvatar_icon_${this.state.icon.toLowerCase()}`}));const n=c()("mx_DecoratedRoomAvatar",{mx_DecoratedRoomAvatar_cutout:t});return r.a.createElement("div",{className:n},r.a.createElement(p.a,{room:this.props.room,width:this.props.avatarSize,height:this.props.avatarSize,oobData:this.props.oobData,viewAvatarOnClick:this.props.viewAvatarOnClick}),t,e)}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return _})),n.d(t,"b",(function(){return C})),n.d(t,"c",(function(){return T})),n.d(t,"d",(function(){return P}));var i=n(122),s=n.n(i),o=n(127),r=n.n(o),a=n(436),c=n(1),l=n(120),d=n.n(l),u=n(541),h=n(121),m=n(126),p=n(542),g=n(736);function v(e){const t=Object(l.useContext)(p.a),n=t?t.dispatch:null;return Object(l.useEffect)((()=>{if(n)return n({type:g.a.Add,value:e}),()=>n({type:g.a.Remove,value:e})}),[e,n]),null}var f=n(124),b=n(148),y=n(140),S=n(135),E=n(163),w=n(1143);const _=0;class C extends d.a.Component{constructor(e){super(e),s()(this,"onSubmit",(e=>{var t;e.preventDefault(),this.props.busy||this.props.submitAuthDict({type:a.a.Password,user:null!==(t=this.props.matrixClient.credentials.userId)&&void 0!==t?t:void 0,identifier:{type:"m.id.user",user:this.props.matrixClient.credentials.userId},password:this.state.password})})),s()(this,"onPasswordFieldChange",(e=>{this.setState({password:e.target.value})})),this.state={password:""}}componentDidMount(){this.props.onPhaseChange(_)}render(){const e=r()({error:this.props.errorText});let t,n;return t=this.props.busy?d.a.createElement(S.a,null):d.a.createElement("input",{type:"submit",className:"mx_Dialog_primary",disabled:!this.state.password,value:Object(h.a)("Continue")}),this.props.errorText&&(n=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),d.a.createElement("div",null,d.a.createElement("p",null,Object(h.a)("Confirm your identity by entering your account password below.")),d.a.createElement("form",{onSubmit:this.onSubmit,className:"mx_InteractiveAuthEntryComponents_passwordSection"},d.a.createElement(y.a,{className:e,type:"password",name:"passwordField",label:Object(h.a)("Password"),autoFocus:!0,value:this.state.password,onChange:this.onPasswordFieldChange}),n,d.a.createElement("div",{className:"mx_button_row"},t)))}}s()(C,"LOGIN_TYPE",a.a.Password);class O extends d.a.Component{constructor(){super(...arguments),s()(this,"onCaptchaResponse",(e=>{this.props.submitAuthDict({type:a.a.Recaptcha,response:e})}))}componentDidMount(){this.props.onPhaseChange(_)}render(){if(this.props.busy)return d.a.createElement(S.a,null);let e,t,n=this.props.errorText;return this.props.stageParams&&this.props.stageParams.public_key?e=this.props.stageParams.public_key:n=Object(h.a)("Missing captcha public key in homeserver configuration. Please report this to your homeserver administrator."),n&&(t=d.a.createElement("div",{className:"error",role:"alert"},n)),d.a.createElement("div",null,d.a.createElement(w.a,{sitePublicKey:e,onCaptchaResponse:this.onCaptchaResponse}),t)}}s()(O,"LOGIN_TYPE",a.a.Recaptcha);class I extends d.a.Component{constructor(e){var t;super(e),s()(this,"trySubmit",(()=>{let e=!0;for(const t of this.state.policies){const n=this.state.toggledPolicies[t.id];e=e&&n}e?this.props.submitAuthDict({type:a.a.Terms}):this.setState({errorText:Object(h.a)("Please review and accept all of the homeserver's policies")})}));const n=(null===(t=this.props.stageParams)||void 0===t?void 0:t.policies)||{},i=m.b.getValue("language"),o={},r=[];for(const e of Object.keys(n)){const t=n[e];let s=t[i];if(s||(s=t.en),!s){const e=Object.keys(t).find((e=>"version"!==e));s=e?t[e]:void 0}if(!s)throw new Error("Failed to find a policy to show the user");o[e]=!1,r.push({id:e,name:s.name,url:s.url})}this.state={toggledPolicies:o,policies:r}}componentDidMount(){this.props.onPhaseChange(_)}togglePolicy(e){const t={};for(const n of this.state.policies){let i=this.state.toggledPolicies[n.id];n.id===e&&(i=!i),t[n.id]=i}this.setState({toggledPolicies:t})}render(){if(this.props.busy)return d.a.createElement(S.a,null);const e=[];let t,n,i=!0;for(const t of this.state.policies){const n=this.state.toggledPolicies[t.id];i=i&&n,e.push(d.a.createElement("label",{key:"policy_checkbox_"+t.id,className:"mx_InteractiveAuthEntryComponents_termsPolicy"},d.a.createElement("input",{type:"checkbox",onChange:()=>this.togglePolicy(t.id),checked:n}),d.a.createElement("a",{href:t.url,target:"_blank",rel:"noreferrer noopener"},t.name)))}return(this.props.errorText||this.state.errorText)&&(t=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText||this.state.errorText)),!1!==this.props.showContinue&&(n=d.a.createElement("button",{className:"mx_InteractiveAuthEntryComponents_termsSubmit mx_GeneralButton",onClick:this.trySubmit,disabled:!i},Object(h.a)("Accept"))),d.a.createElement("div",null,d.a.createElement("p",null,Object(h.a)("Please review and accept the policies of this homeserver:")),e,t,n)}}s()(I,"LOGIN_TYPE",a.a.Terms);class R extends d.a.Component{constructor(e){super(e),this.state={requested:!1,requesting:!1}}componentDidMount(){this.props.onPhaseChange(_)}render(){var e,t;let n;return this.props.errorText&&"M_UNAUTHORIZED"!==this.props.errorCode&&(n=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),void 0===(null===(e=this.props.inputs)||void 0===e?void 0:e.emailAddress)||null!==(t=this.props.stageState)&&void 0!==t&&t.emailSid?n||d.a.createElement(S.a,null):d.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_emailWrapper"},d.a.createElement(v,{title:Object(h.a)("Check your email to continue"),icon:d.a.createElement("img",{src:u.b,alt:Object(h.a)("Unread email icon"),width:16}),hideServerPicker:!0}),d.a.createElement("p",null,Object(h.a)("To create your account, open the link in the email we just sent to %(emailAddress)s.",{emailAddress:d.a.createElement("b",null,this.props.inputs.emailAddress)})),this.state.requesting?d.a.createElement("p",{className:"secondary"},Object(h.a)("Did not receive it? <a>Resend it</a>",{},{a:e=>d.a.createElement(l.Fragment,null,d.a.createElement(f.a,{kind:"link_inline",onClick:null,disabled:!0},e," ",d.a.createElement(S.a,{w:14,h:14})))})):d.a.createElement("p",{className:"secondary"},Object(h.a)("Did not receive it? <a>Resend it</a>",{},{a:e=>d.a.createElement(b.a,{kind:"link_inline",title:this.state.requested?Object(h.a)("Resent!"):Object(h.a)("Resend"),alignment:E.a.Right,onHideTooltip:this.state.requested?()=>this.setState({requested:!1}):void 0,onClick:async()=>{this.setState({requesting:!0});try{var e,t;await(null===(e=(t=this.props).requestEmailToken)||void 0===e?void 0:e.call(t))}catch(e){c.a.warn("Email token request failed: ",e)}finally{this.setState({requested:!0,requesting:!1})}}},e)})),n)}}s()(R,"LOGIN_TYPE",a.a.Email);class k extends d.a.Component{constructor(e){super(e),s()(this,"submitUrl",void 0),s()(this,"sid",void 0),s()(this,"msisdn",void 0),s()(this,"onTokenChange",(e=>{this.setState({token:e.target.value})})),s()(this,"onFormSubmit",(async e=>{if(e.preventDefault(),""!=this.state.token){this.setState({errorText:null});try{let e;if(!this.submitUrl)throw new Error("The registration with MSISDN flow is misconfigured");if(e=await this.props.matrixClient.submitMsisdnTokenOtherUrl(this.submitUrl,this.sid,this.props.clientSecret,this.state.token),e.success){const e={sid:this.sid,client_secret:this.props.clientSecret};this.props.submitAuthDict({type:a.a.Msisdn,threepid_creds:e,threepidCreds:e})}else this.setState({errorText:Object(h.a)("Token incorrect")})}catch(e){this.props.fail(e),c.a.log("Failed to submit msisdn token")}}})),this.state={token:"",requestingToken:!1,errorText:""}}componentDidMount(){this.props.onPhaseChange(_),this.setState({requestingToken:!0}),this.requestMsisdnToken().catch((e=>{this.props.fail(e)})).finally((()=>{this.setState({requestingToken:!1})}))}requestMsisdnToken(){return this.props.matrixClient.requestRegisterMsisdnToken(this.props.inputs.phoneCountry,this.props.inputs.phoneNumber,this.props.clientSecret,1).then((e=>{this.submitUrl=e.submit_url,this.sid=e.sid,this.msisdn=e.msisdn}))}render(){if(this.state.requestingToken)return d.a.createElement(S.a,null);{const e=Boolean(this.state.token),t=r()({mx_InteractiveAuthEntryComponents_msisdnSubmit:!0,mx_GeneralButton:!0});let n;return this.state.errorText&&(n=d.a.createElement("div",{className:"error",role:"alert"},this.state.errorText)),d.a.createElement("div",null,d.a.createElement("p",null,Object(h.a)("A text message has been sent to %(msisdn)s",{msisdn:d.a.createElement("i",null,this.msisdn)})),d.a.createElement("p",null,Object(h.a)("Please enter the code it contains:")),d.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_msisdnWrapper"},d.a.createElement("form",{onSubmit:this.onFormSubmit},d.a.createElement("input",{type:"text",className:"mx_InteractiveAuthEntryComponents_msisdnEntry",value:this.state.token,onChange:this.onTokenChange,"aria-label":Object(h.a)("Code")}),d.a.createElement("br",null),d.a.createElement("input",{type:"submit",value:Object(h.a)("Submit"),className:t,disabled:!e})),n))}}}s()(k,"LOGIN_TYPE",a.a.Msisdn);class x extends d.a.Component{constructor(e){super(e),s()(this,"onSubmit",(e=>{e.preventDefault(),this.props.busy||this.props.submitAuthDict({type:this.props.loginType,token:this.state.registrationToken})})),s()(this,"onRegistrationTokenFieldChange",(e=>{this.setState({registrationToken:e.target.value})})),this.state={registrationToken:""}}componentDidMount(){this.props.onPhaseChange(_)}render(){const e=r()({error:this.props.errorText});let t,n;return t=this.props.busy?d.a.createElement(S.a,null):d.a.createElement(f.a,{onClick:this.onSubmit,kind:"primary",disabled:!this.state.registrationToken},Object(h.a)("Continue")),this.props.errorText&&(n=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),d.a.createElement("div",null,d.a.createElement("p",null,Object(h.a)("Enter a registration token provided by the homeserver administrator.")),d.a.createElement("form",{onSubmit:this.onSubmit,className:"mx_InteractiveAuthEntryComponents_registrationTokenSection"},d.a.createElement(y.a,{className:e,type:"text",name:"registrationTokenField",label:Object(h.a)("Registration token"),autoFocus:!0,value:this.state.registrationToken,onChange:this.onRegistrationTokenFieldChange}),n,d.a.createElement("div",{className:"mx_button_row"},t)))}}s()(x,"LOGIN_TYPE",a.a.RegistrationToken);class T extends d.a.Component{constructor(e){if(super(e),s()(this,"ssoUrl",void 0),s()(this,"popupWindow",void 0),s()(this,"attemptFailed",(()=>{this.setState({attemptFailed:!0})})),s()(this,"onReceiveMessage",(e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this.popupWindow&&(this.popupWindow.close(),this.popupWindow=null)})),s()(this,"onStartAuthClick",(()=>{this.popupWindow=window.open(this.ssoUrl,"_blank"),this.setState({phase:T.PHASE_POSTAUTH}),this.props.onPhaseChange(T.PHASE_POSTAUTH)})),s()(this,"onConfirmClick",(()=>{this.props.submitAuthDict({})})),!this.props.authSessionId)throw new Error("This UIA flow requires an authSessionId");this.ssoUrl=e.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId),this.popupWindow=null,window.addEventListener("message",this.onReceiveMessage),this.state={phase:T.PHASE_PREAUTH,attemptFailed:!1}}componentDidMount(){this.props.onPhaseChange(T.PHASE_PREAUTH)}componentWillUnmount(){window.removeEventListener("message",this.onReceiveMessage),this.popupWindow&&(this.popupWindow.close(),this.popupWindow=null)}render(){var e;let t;const n=d.a.createElement(f.a,{onClick:null!==(e=this.props.onCancel)&&void 0!==e?e:null,kind:this.props.continueKind?this.props.continueKind+"_outline":"primary_outline"},Object(h.a)("Cancel"));let i;return t=this.state.phase===T.PHASE_PREAUTH?d.a.createElement(f.a,{onClick:this.onStartAuthClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(h.a)("Single Sign On")):d.a.createElement(f.a,{onClick:this.onConfirmClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(h.a)("Confirm")),this.props.errorText?i=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText):this.state.attemptFailed&&(i=d.a.createElement("div",{className:"error",role:"alert"},Object(h.a)("Something went wrong in confirming your identity. Cancel and try again."))),d.a.createElement(l.Fragment,null,i,d.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_sso_buttons"},n,t))}}s()(T,"LOGIN_TYPE",a.a.Sso),s()(T,"UNSTABLE_LOGIN_TYPE",a.a.SsoUnstable),s()(T,"PHASE_PREAUTH",1),s()(T,"PHASE_POSTAUTH",2);class j extends d.a.Component{constructor(e){super(e),s()(this,"popupWindow",void 0),s()(this,"fallbackButton",Object(l.createRef)()),s()(this,"focus",(()=>{var e;null===(e=this.fallbackButton.current)||void 0===e||e.focus()})),s()(this,"onShowFallbackClick",(e=>{if(!this.props.authSessionId)return;e.preventDefault(),e.stopPropagation();const t=this.props.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId);this.popupWindow=window.open(t,"_blank")})),s()(this,"onReceiveMessage",(e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this.props.submitAuthDict({})})),this.popupWindow=null,window.addEventListener("message",this.onReceiveMessage)}componentDidMount(){this.props.onPhaseChange(_)}componentWillUnmount(){var e;window.removeEventListener("message",this.onReceiveMessage),null===(e=this.popupWindow)||void 0===e||e.close()}render(){let e;return this.props.errorText&&(e=d.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),d.a.createElement("div",null,d.a.createElement(f.a,{kind:"link",inputRef:this.fallbackButton,onClick:this.onShowFallbackClick},Object(h.a)("Start authentication")),e)}}function P(e){switch(e){case a.a.Password:return C;case a.a.Recaptcha:return O;case a.a.Email:return R;case a.a.Msisdn:return k;case a.a.Terms:return I;case a.a.RegistrationToken:case a.a.UnstableRegistrationToken:return x;case a.a.Sso:case a.a.SsoUnstable:return T;default:return j}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(13),s=n.n(i),o=n(16),r=n(1),a=n(235),c=n(130);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const u=[a.e.Override,a.e.ContentSpecific,a.e.RoomSpecific,a.e.SenderSpecific,a.e.Underride],h=[{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:a.a.EventMatch,key:"type",pattern:"m.reaction"}],actions:[a.d.DontNotify]},{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:a.a.EventMatch,key:"type",pattern:c.b.RoomServerAcl},{kind:a.a.EventMatch,key:"state_key",pattern:""}],actions:[]}],m=[{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:a.a.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:a.a.CallStarted}],actions:[a.d.Notify,{set_tweak:a.g.Sound,value:"default"}]}];class p{constructor(e){this.client=e,s()(this,"parsedKeys",new Map)}static actionListToActionsObject(e){const t={notify:!1,tweaks:{}};for(const n of e)n===a.d.Notify?t.notify=!0:"object"==typeof n&&(void 0===n.value&&(n.value=!0),t.tweaks[n.set_tweak]=n.value);return t}static rewriteDefaultRules(e){var t;let n=JSON.parse(JSON.stringify(e));n||(n={}),n.global||(n.global={}),n.global.override||(n.global.override=[]),n.global.underride||(n.global.underride=[]);const i=n.global.override;for(const e of h){const t=i.find((t=>t.rule_id===e.rule_id));if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{const t=e.rule_id;r.a.warn(`Adding default global override for ${t}`),i.push(e)}}const s=null!==(t=n.global.underride)&&void 0!==t?t:[];for(const e of m){const t=s.find((t=>t.rule_id===e.rule_id));if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{const t=e.rule_id;r.a.warn(`Adding default global underride for ${t}`),s.push(e)}}return n}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);const t=new Set(this.parsedKeys.keys());for(const n of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(const e of n)if(e.conditions)for(const n of e.conditions)n.kind===a.a.EventMatch&&(t.delete(n.key),this.parsedKeys.set(n.key,p.partsForDottedKey(n.key)));t.forEach((e=>this.parsedKeys.delete(e)))}matchingRuleFromKindSet(e,t){for(const n of u){const i=t[n];if(i)for(const t of i){if(!t.enabled)continue;const i=this.templateRuleToRaw(n,t);if(i&&this.ruleMatchesEvent(i,e))return d(d({},t),{},{kind:n})}}return null}templateRuleToRaw(e,t){const n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case a.e.Underride:case a.e.Override:n.conditions=t.conditions;break;case a.e.RoomSpecific:if(!t.rule_id)return null;n.conditions.push({kind:a.a.EventMatch,key:"room_id",value:t.rule_id});break;case a.e.SenderSpecific:if(!t.rule_id)return null;n.conditions.push({kind:a.a.EventMatch,key:"user_id",value:t.rule_id});break;case a.e.ContentSpecific:if(!t.pattern)return null;n.conditions.push({kind:a.a.EventMatch,key:"content.body",pattern:t.pattern})}return n}eventFulfillsCondition(e,t){switch(e.kind){case a.a.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case a.a.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case a.a.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case a.a.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case a.a.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case a.a.CallStarted:case a.a.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){const n=e.key;if(!n)return!1;const i=this.client.getRoom(t.getRoomId());return!(null==i||!i.currentState)&&i.currentState.mayTriggerNotifOfType(n,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;const n=this.client.getRoom(t.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;const i=n.currentState.getJoinedMemberCount(),s=e.is.match(/^([=<>]*)(\d*)$/);if(!s)return!1;const o=s[1],r=parseInt(s[2]);if(isNaN(r))return!1;switch(o){case"":case"==":return i==r;case"<":return i<r;case">":return i>r;case"<=":return i<=r;case">=":return i>=r;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var n;let i=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(i=t.getClearContent()),!i||!i.body||"string"!=typeof i.body)return!1;const s=this.client.getRoom(t.getRoomId()),r=null==s||null===(n=s.currentState)||void 0===n?void 0:n.getMember(this.client.credentials.userId);if(!r)return!1;const a=r.name,c=new RegExp("(^|\\W)"+Object(o.q)(a)+"(\\W|$)","i");return i.body.search(c)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;const n=this.valueForDottedKey(e.key,t);if("string"!=typeof n)return!1;if(e.value)return e.value===n;if("string"!=typeof e.pattern)return!1;const i="content.body"===e.key?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$");return!!n.match(i)}eventFulfillsEventPropertyIsCondition(e,t){return!(!e.key||void 0===e.value)&&e.value===this.valueForDottedKey(e.key,t)}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||Object(o.j)(t.getPrevContent(),{}))}createCachedRegex(e,t,n){return p.cachedGlobToRegex[t]||(p.cachedGlobToRegex[t]=new RegExp(e+Object(o.r)(t)+n,"i")),p.cachedGlobToRegex[t]}static partsForDottedKey(e){const t=[];let n="",i=!1;for(const s of e)i?(n+="\\"===s||"."===s?s:"\\"+s,i=!1):"."==s?(t.push(n),n=""):"\\"==s?i=!0:n+=s;return i&&(n+="\\"),t.push(n),t}valueForDottedKey(e,t){let n,i=this.parsedKeys.get(e);void 0===i&&(i=p.partsForDottedKey(e),this.parsedKeys.set(e,i));const s=i[0];let r=0;for("content"===s?(n=t.getContent(),++r):"type"===s?(n=t.getType(),++r):n=t.event;r<i.length;++r){if(Object(o.u)(n))return;n=n[i[r]]}return n}matchingRuleForEventWithRulesets(e,t){return t?e.getSender()===this.client.credentials.userId?null:this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){const n=this.matchingRuleForEventWithRulesets(e,t);if(!n)return{};const i=p.actionListToActionsObject(n.actions);return void 0===i.tweaks.highlight&&(i.tweaks.highlight=n.kind==a.e.ContentSpecific),i}ruleMatchesEvent(e,t){var n;return!(null!==(n=e.conditions)&&void 0!==n&&n.some((e=>!this.eventFulfillsCondition(e,t))))}actionsForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t;const n=this.getPushRuleAndKindById(e);return null!==(t=null==n?void 0:n.rule)&&void 0!==t?t:null}getPushRuleAndKindById(e){for(const n of["global"]){var t;if(void 0!==(null===(t=this.client.pushRules)||void 0===t?void 0:t[n]))for(const t of u)if(void 0!==this.client.pushRules[n][t])for(const i of this.client.pushRules[n][t])if(i.rule_id===e)return{rule:i,kind:t}}return null}}s()(p,"cachedGlobToRegex",{})},function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return l}));var i=n(13),s=n.n(i),o=n(1),r=n(196);let a;var c;!function(e){e.SUCCESS="SUCCESS",e.IGNORE="IGNORE",e.PROMPT="PROMPT",e.FAIL_PROMPT="FAIL_PROMPT",e.FAIL_ERROR="FAIL_ERROR"}(a||(a={})),function(e){e.Invalid="Invalid homeserver discovery response",e.GenericFailure="Failed to get autodiscovery configuration from server",e.InvalidHsBaseUrl="Invalid base_url for m.homeserver",e.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",e.InvalidIsBaseUrl="Invalid base_url for m.identity_server",e.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",e.InvalidIs="Invalid identity server discovery response",e.MissingWellknown="No .well-known JSON file found",e.InvalidJson="Invalid JSON"}(c||(c={}));class l{static async fromDiscoveryConfig(e){var t;const n={"m.homeserver":{state:l.FAIL_ERROR,error:l.ERROR_INVALID,base_url:null},"m.identity_server":{state:l.PROMPT,error:null,base_url:null}};if(!e||!e["m.homeserver"])return o.a.error("No m.homeserver key in config"),n["m.homeserver"].state=l.FAIL_PROMPT,n["m.homeserver"].error=l.ERROR_INVALID,Promise.resolve(n);if(!e["m.homeserver"].base_url)return o.a.error("No m.homeserver base_url in config"),n["m.homeserver"].state=l.FAIL_PROMPT,n["m.homeserver"].error=l.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);const i=this.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!i)return o.a.error("Invalid base_url for m.homeserver"),n["m.homeserver"].error=l.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);const s=await this.fetchWellKnownObject(`${i}/_matrix/client/versions`);if(!s||null===(t=s.raw)||void 0===t||!t.versions)return o.a.error("Invalid /versions response"),n["m.homeserver"].error=l.ERROR_INVALID_HOMESERVER,n["m.homeserver"].base_url=i,Promise.resolve(n);n["m.homeserver"]={state:l.SUCCESS,error:null,base_url:i};let r="";if(e["m.identity_server"]){const t={"m.homeserver":n["m.homeserver"],"m.identity_server":{state:l.FAIL_PROMPT,error:l.ERROR_INVALID_IS,base_url:null}};if(r=this.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!r)return o.a.error("Invalid base_url for m.identity_server"),t["m.identity_server"].error=l.ERROR_INVALID_IS_BASE_URL,Promise.resolve(t);const i=await this.fetchWellKnownObject(`${r}/_matrix/identity/v2`);if(null==i||!i.raw||i.action!==a.SUCCESS)return o.a.error("Invalid /v2 response"),t["m.identity_server"].error=l.ERROR_INVALID_IDENTITY_SERVER,t["m.identity_server"].base_url=r,Promise.resolve(t)}return r&&r.toString().length>0&&(n["m.identity_server"]={state:l.SUCCESS,error:null,base_url:r}),Object.keys(e).forEach((t=>{if("m.homeserver"===t||"m.identity_server"===t){const i=["error","state","base_url"];for(const s of Object.keys(e[t]))i.includes(s)||(n[t][s]=e[t][s])}else n[t]=e[t]})),Promise.resolve(n)}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:l.FAIL_ERROR,error:l.ERROR_INVALID,base_url:null},"m.identity_server":{state:l.PROMPT,error:null,base_url:null}},n=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return n&&n.action===a.SUCCESS?l.fromDiscoveryConfig(n.raw):(o.a.error("No response or error when parsing .well-known"),n.reason&&o.a.error(n.reason),n.action===a.IGNORE?t["m.homeserver"]={state:l.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=l.FAIL_PROMPT,t["m.homeserver"].error=l.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t&&t.raw||{}}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t;let n;try{n=new URL(e)}catch(e){o.a.error("Could not parse url",e)}if(null===(t=n)||void 0===t||!t.hostname)return!1;if("http:"!==n.protocol&&"https:"!==n.protocol)return!1;const i=n.port?`:${n.port}`:"",s=n.pathname?n.pathname:"";let r=`${n.protocol}//${n.hostname}${i}${s}`;return r.endsWith("/")&&(r=r.substring(0,r.length-1)),r}catch(e){return o.a.error(e),!1}}static fetch(t,n){return this.fetchFn?this.fetchFn(t,n):e.fetch(t,n)}static setFetchFn(e){l.fetchFn=e}static async fetchWellKnownObject(e){let t;try{if(t=await l.fetch(e,{method:r.i.Get,signal:Object(r.m)(5e3)}),404===t.status)return{raw:{},action:a.IGNORE,reason:l.ERROR_MISSING_WELLKNOWN};if(!t.ok)return{raw:{},action:a.FAIL_PROMPT,reason:"General failure"}}catch(e){const t=e;let n="";return"object"==typeof t&&(n=null==t?void 0:t.message),{error:t,raw:{},action:a.FAIL_PROMPT,reason:n||"General failure"}}try{return{raw:await t.json(),action:a.SUCCESS}}catch(e){const t=e;return{error:t,raw:{},action:a.FAIL_PROMPT,reason:"SyntaxError"===(null==t?void 0:t.name)?l.ERROR_INVALID_JSON:l.ERROR_INVALID}}}}s()(l,"ERROR_INVALID",c.Invalid),s()(l,"ERROR_GENERIC_FAILURE",c.GenericFailure),s()(l,"ERROR_INVALID_HS_BASE_URL",c.InvalidHsBaseUrl),s()(l,"ERROR_INVALID_HOMESERVER",c.InvalidHomeserver),s()(l,"ERROR_INVALID_IS_BASE_URL",c.InvalidIsBaseUrl),s()(l,"ERROR_INVALID_IDENTITY_SERVER",c.InvalidIdentityServer),s()(l,"ERROR_INVALID_IS",c.InvalidIs),s()(l,"ERROR_MISSING_WELLKNOWN",c.MissingWellknown),s()(l,"ERROR_INVALID_JSON",c.InvalidJson),s()(l,"ALL_ERRORS",Object.keys(c)),s()(l,"FAIL_ERROR",a.FAIL_ERROR),s()(l,"FAIL_PROMPT",a.FAIL_PROMPT),s()(l,"PROMPT",a.PROMPT),s()(l,"SUCCESS",a.SUCCESS),s()(l,"fetchFn",void 0)}).call(this,n(14))},function(e,t,n){"use strict";n.d(t,"c",(function(){return r})),n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return d}));var i=n(200),s=n(428);const o=new Uint8Array(8);async function r(e,t,n,o){let r;o?r=Object(i.decodeBase64)(o):(r=new Uint8Array(16),s.b.getRandomValues(r),r[8]&=127);const[a,l]=await c(t,n),d=(new s.a).encode(e),u=await s.c.encrypt({name:"AES-CTR",counter:r,length:64},a,d),h=await s.c.sign({name:"HMAC"},l,u);return{iv:Object(i.encodeBase64)(r),ciphertext:Object(i.encodeBase64)(u),mac:Object(i.encodeBase64)(h)}}async function a(e,t,n){const[o,r]=await c(t,n),a=Object(i.decodeBase64)(e.ciphertext);if(!await s.c.verify({name:"HMAC"},r,Object(i.decodeBase64)(e.mac),a))throw new Error(`Error decrypting secret ${n}: bad MAC`);const l=await s.c.decrypt({name:"AES-CTR",counter:Object(i.decodeBase64)(e.iv),length:64},o,a);return(new TextDecoder).decode(new Uint8Array(l))}async function c(e,t){const n=await s.c.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),i=await s.c.deriveBits({name:"HKDF",salt:o,info:(new s.a).encode(t),hash:"SHA-256"},n,512),r=i.slice(0,32),a=i.slice(32),c=s.c.importKey("raw",r,{name:"AES-CTR"},!1,["encrypt","decrypt"]),l=s.c.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([c,l])}const l="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function d(e,t){return r(l,e,"",t)}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(122),s=n.n(i);class o{constructor(){s()(this,"watchers",void 0)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(197),s=n.n(i);let o;!function(e){e.Light="light",e.Dark="dark",e.System="system"}(o||(o={}));s.a.oneOf(Object.values(o))},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const i=new RegExp("^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$","i");function s(e){return!(e.indexOf("@")<1)&&i.test(e)}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(148);const d=["isExpanded","children","onClick","onContextMenu"],u=e=>{let{isExpanded:t,children:n,onClick:i,onContextMenu:o}=e,a=r()(e,d);return c.a.createElement(l.a,s()({},a,{onClick:i,onContextMenu:o||i,"aria-haspopup":!0,"aria-expanded":t,forceHide:t}),n)}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return u}));var i=n(122),s=n.n(i),o=n(126),r=n(125),a=n(129),c=n(588),l=n(464),d=n(330);class u{constructor(){s()(this,"lightThemeWatchRef",void 0),s()(this,"darkThemeWatchRef",void 0),s()(this,"themeInUseWatchRef",void 0),s()(this,"dispatcherRef",void 0),s()(this,"preferDark",void 0),s()(this,"preferLight",void 0),s()(this,"preferHighContrast",void 0),s()(this,"onChange",(()=>{this.recheck()})),s()(this,"onAction",(e=>{e.action===a.a.RecheckTheme&&this.recheck(e.forceTheme)})),this.lightThemeWatchRef=null,this.darkThemeWatchRef=null,this.themeInUseWatchRef=null,this.dispatcherRef=null,this.preferDark=e.matchMedia("(prefers-color-scheme: dark)"),this.preferLight=e.matchMedia("(prefers-color-scheme: light)"),this.preferHighContrast=e.matchMedia("(prefers-contrast: more)"),u.currentTheme=this.getEffectiveTheme()}start(){this.lightThemeWatchRef=o.b.watchSetting("light_theme",null,this.onChange),this.darkThemeWatchRef=o.b.watchSetting("dark_theme",null,this.onChange),this.themeInUseWatchRef=o.b.watchSetting("theme_in_use",null,this.onChange),this.preferDark.addEventListener("change",this.onChange),this.preferLight.addEventListener("change",this.onChange),this.preferHighContrast.addEventListener("change",this.onChange),this.dispatcherRef=r.a.register(this.onAction)}stop(){this.preferDark.removeEventListener("change",this.onChange),this.preferLight.removeEventListener("change",this.onChange),this.preferHighContrast.removeEventListener("change",this.onChange),this.themeInUseWatchRef&&o.b.unwatchSetting(this.themeInUseWatchRef),this.darkThemeWatchRef&&o.b.unwatchSetting(this.darkThemeWatchRef),this.lightThemeWatchRef&&o.b.unwatchSetting(this.lightThemeWatchRef),this.dispatcherRef&&r.a.unregister(this.dispatcherRef)}recheck(e){const t=u.currentTheme;u.currentTheme=void 0===e?this.getEffectiveTheme():e,t!==u.currentTheme&&Object(l.d)(u.currentTheme)}getEffectiveTheme(){let e=d.a.Light;return c.a.isLogin||(e=o.b.getValue("theme_in_use"),e===d.a.System&&(this.preferDark.matches&&(e=d.a.Dark),this.preferLight.matches&&(e=d.a.Light))),e===d.a.Dark?o.b.getValue("dark_theme"):o.b.getValue("light_theme")}isSystemThemeSupported(){return this.preferDark.matches||this.preferLight.matches}static getCurrentTheme(){return u.currentTheme}static getCurrentThemeSimplified(){let e=u.currentTheme;if(e.startsWith("custom-")){const t=Object(l.b)(e.substr(7));e=t.is_dark?"dark":"light"}return e=e.includes("light")?"light":"dark",e}}s()(u,"currentTheme",void 0)}).call(this,n(14))},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(122),s=n.n(i);class o{constructor(e){this.timeout=e,s()(this,"timerHandle",void 0),s()(this,"startTs",void 0),s()(this,"promise",void 0),s()(this,"resolve",void 0),s()(this,"reject",void 0),s()(this,"onTimeout",(()=>{const e=Date.now()-this.startTs;if(e>=this.timeout)this.resolve(),this.setNotStarted();else{const t=this.timeout-e;this.timerHandle=window.setTimeout(this.onTimeout,t)}})),this.setNotStarted()}setNotStarted(){this.timerHandle=void 0,this.startTs=void 0,this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t})).finally((()=>{this.timerHandle=void 0}))}changeTimeout(e){if(e===this.timeout)return;const t=e<this.timeout;this.timeout=e,this.isRunning()&&t&&(clearTimeout(this.timerHandle),this.onTimeout())}start(){return this.isRunning()||(this.startTs=Date.now(),this.timerHandle=window.setTimeout(this.onTimeout,this.timeout)),this}restart(){return this.isRunning()?(this.startTs=Date.now(),this):this.start()}abort(){return this.isRunning()&&(clearTimeout(this.timerHandle),this.reject(new Error("Timer was aborted.")),this.setNotStarted()),this}finished(){return this.promise}isRunning(){return void 0!==this.timerHandle}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(205),r=n(268);class a extends r.a{constructor(e,t,n){super(),this._symbol=e,this._count=t,this._color=n}static forCount(e,t){return new a(null,e,t)}static forSymbol(e,t){return new a(e,0,t)}}s()(a,"RED_EXCLAMATION",a.forSymbol("!",o.a.Red))},function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var i=n(122),s=n.n(i),o=n(17),r=n.n(o),a=n(137),c=n(123),l=n(183),d=n(270);let u;!function(e){e.Persistence="persistence",e.Dock="dock",e.Undock="undock"}(u||(u={}));class h extends r.a{constructor(){super(...arguments),s()(this,"persistentWidgetId",void 0),s()(this,"persistentRoomId",void 0),s()(this,"dockedWidgetsByUid",new Map),s()(this,"onRoomStateEvents",((e,t)=>{let{roomId:n}=t;"im.vector.modular.widgets"===e.getType()&&this.destroyPersistentWidget(e.getStateKey(),n)}))}static get instance(){return h.internalInstance||(h.internalInstance=new h),h.internalInstance}start(){c.a.get().on(a.RoomStateEvent.Events,this.onRoomStateEvents)}stop(){var e;null===(e=c.a.get())||void 0===e||e.removeListener(a.RoomStateEvent.Events,this.onRoomStateEvents)}destroyPersistentWidget(e,t){this.getWidgetPersistence(e,t)&&(d.a.instance.stopMessagingByUid(l.a.calcWidgetUid(e,t)),this.setWidgetPersistence(e,t,!1))}setWidgetPersistence(e,t,n){const i=this.getWidgetPersistence(e,t);i&&!n?(this.persistentWidgetId=null,this.persistentRoomId=null):!i&&n&&(this.persistentWidgetId=e,this.persistentRoomId=t),this.emit(u.Persistence)}getWidgetPersistence(e,t){return this.persistentWidgetId===e&&this.persistentRoomId===t}getPersistentWidgetId(){return this.persistentWidgetId}getPersistentRoomId(){return this.persistentRoomId}dockWidget(e,t){var n;const i=l.a.calcWidgetUid(e,t),s=null!==(n=this.dockedWidgetsByUid.get(i))&&void 0!==n?n:0;this.dockedWidgetsByUid.set(i,s+1),0===s&&this.emit(u.Dock)}undockWidget(e,t){const n=l.a.calcWidgetUid(e,t),i=this.dockedWidgetsByUid.get(n);i&&this.dockedWidgetsByUid.set(n,i-1),1===i&&this.emit(u.Undock)}isDocked(e,t){var n;const i=l.a.calcWidgetUid(e,t);return(null!==(n=this.dockedWidgetsByUid.get(i))&&void 0!==n?n:0)>0}isLive(e,t){return this.isDocked(e,t)||this.getWidgetPersistence(e,t)}}s()(h,"internalInstance",void 0),window.mxActiveWidgetStore=h.instance},function(e,t,n){"use strict";n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return p})),n.d(t,"c",(function(){return g}));var i=n(122),s=n.n(i),o=n(120),r=n(127),a=n.n(r),c=n(1),l=n(121),d=n(215),u=n(124),h=n(162);class m{constructor(e,t,n,i,s){this.id=e,this.label=t,this.icon=n,this.body=i,this.screenName=s}}let p;!function(e){e.LEFT="left",e.TOP="top"}(p||(p={}));class g extends o.Component{constructor(e){var t;super(e);const n=e.tabs.find((t=>t.id===e.initialTabId));this.state={activeTabId:n?e.initialTabId:null===(t=e.tabs[0])||void 0===t?void 0:t.id}}getTabById(e){return this.props.tabs.find((t=>t.id===e))}setActiveTab(e){this.getTabById(e.id)?(this.props.onChange&&this.props.onChange(e.id),this.setState({activeTabId:e.id})):c.a.error("Could not find tab "+e.label+" in tabs")}renderTabLabel(e){let t="mx_TabbedView_tabLabel ";this.state.activeTabId===e.id&&(t+="mx_TabbedView_tabLabel_active");let n=null;e.icon&&(n=o.createElement("span",{className:`mx_TabbedView_maskedIcon ${e.icon}`}));const i=Object(l.a)(e.label);return o.createElement(u.a,{className:t,key:"tab_label_"+e.label,onClick:()=>this.setActiveTab(e),"data-testid":`settings-tab-${e.id}`},n,o.createElement("span",{className:"mx_TabbedView_tabLabel_text"},i))}renderTabPanel(e){return o.createElement("div",{className:"mx_TabbedView_tabPanel",key:"mx_tabpanel_"+e.label},o.createElement(d.a,{className:"mx_TabbedView_tabPanelContent"},e.body))}render(){var e;const t=this.props.tabs.map((e=>this.renderTabLabel(e))),n=this.getTabById(this.state.activeTabId),i=n?this.renderTabPanel(n):null,s=a()({mx_TabbedView:!0,mx_TabbedView_tabsOnLeft:this.props.tabLocation==p.LEFT,mx_TabbedView_tabsOnTop:this.props.tabLocation==p.TOP});return o.createElement("div",{className:s},o.createElement(h.a,{screenName:null!==(e=null==n?void 0:n.screenName)&&void 0!==e?e:this.props.screenName}),o.createElement("div",{className:"mx_TabbedView_tabLabels"},t),i)}}s()(g,"defaultProps",{tabLocation:p.LEFT})},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(122),c=n.n(a),l=n(120),d=n.n(l),u=n(150),h=n(127),m=n.n(h),p=n(124),g=n(153),v=n(143);const f=["onSearch","onCleared","onKeyDown","onFocus","onBlur","className","placeholder","blurredPlaceholder","autoFocus","initialValue","collapsed"];class b extends d.a.Component{constructor(e){super(e),c()(this,"search",Object(l.createRef)()),c()(this,"onChange",(()=>{this.search.current&&(this.setState({searchTerm:this.search.current.value}),this.onSearch())})),c()(this,"onSearch",Object(u.throttle)((()=>{var e;this.props.onSearch(null===(e=this.search.current)||void 0===e?void 0:e.value)}),200,{trailing:!0,leading:!0})),c()(this,"onKeyDown",(e=>{if(Object(g.a)().getAccessibilityAction(e)===v.h.Escape)this.clearSearch("keyboard");this.props.onKeyDown&&this.props.onKeyDown(e)})),c()(this,"onFocus",(e=>{this.setState({blurred:!1}),e.target.select(),this.props.onFocus&&this.props.onFocus(e)})),c()(this,"onBlur",(e=>{this.setState({blurred:!0}),this.props.onBlur&&this.props.onBlur(e)})),this.state={searchTerm:e.initialValue||"",blurred:!0}}clearSearch(e){this.search.current.value="",this.onChange(),this.props.onCleared&&this.props.onCleared(e)}render(){const e=this.props,{onSearch:t,onCleared:n,onKeyDown:i,onFocus:o,onBlur:a,className:c="",placeholder:l,blurredPlaceholder:u,autoFocus:h,initialValue:g,collapsed:v}=e,b=r()(e,f);if(v)return null;const y=!this.state.blurred||this.state.searchTerm?d.a.createElement(p.a,{key:"button",tabIndex:-1,className:"mx_SearchBox_closeButton",onClick:()=>{this.clearSearch("button")}}):void 0;return d.a.createElement("div",{className:m()("mx_SearchBox","mx_textinput",{mx_SearchBox_blurred:this.state.blurred})},d.a.createElement("input",s()({},b,{key:"searchfield",type:"text",ref:this.search,className:"mx_textinput_icon mx_textinput_search "+c,value:this.state.searchTerm,onFocus:this.onFocus,onChange:this.onChange,onKeyDown:this.onKeyDown,onBlur:this.onBlur,placeholder:this.state.blurred&&u||l,autoComplete:"off",autoFocus:this.props.autoFocus,"data-testid":"searchbox-input"})),y)}}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(237);t.a=function(e){let{name:t,definitions:n,value:i,className:o,outlined:c,disabled:l,onChange:d}=e;const u=e=>{d(e.target.value)};return s.a.createElement(s.a.Fragment,null,n.map((e=>{var n;const d=`${t}-${e.value}`;return s.a.createElement(s.a.Fragment,{key:e.value},s.a.createElement(a.a,{id:d,className:r()(o,e.className),onChange:u,checked:void 0!==e.checked?e.checked:e.value===i,name:t,value:e.value,disabled:null!==(n=e.disabled)&&void 0!==n?n:l,outlined:c,"aria-describedby":e.description?`${d}-description`:void 0},e.label),e.description?s.a.createElement("span",{id:`${d}-description`},e.description):null)})))}},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.Send="send",e.Edit="edit"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(166);class c extends r.a.Component{constructor(e){super(e)}shouldComponentUpdate(e){return Math.floor(this.props.seconds)!==Math.floor(e.seconds)}render(){return r.a.createElement("span",{"aria-live":this.props["aria-live"],role:this.props.role,className:"mx_Clock"},this.props.formatFn(this.props.seconds))}}s()(c,"defaultProps",{formatFn:a.l})},function(e,t,n){"use strict";n.d(t,"a",(function(){return S}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(387),c=n(1),l=n(121),d=n(128),u=n(124),h=n(160),m=n(145),p=n(586),g=n(886),v=n(247),f=n(139);let b;function y(e){if(!e)return"";const t=window.getComputedStyle(e,null);let n=t.cssText;if(""==n)for(const e of t)n+=e+":",n+=t.getPropertyValue(e)+";";return n}!async function(){if(b)return;const e=await fetch(n(887).default).then((e=>e.text()));b="data:image/svg+xml;base64,"+window.btoa(e)}();class S extends r.a.Component{constructor(e){super(e),s()(this,"context",void 0),s()(this,"iframe",Object(o.createRef)()),s()(this,"dummyLink",Object(o.createRef)()),s()(this,"userDidClick",!1),s()(this,"fileDownloader",new g.a((()=>this.iframe.current))),s()(this,"decryptFile",(async()=>{if(!this.state.decryptedBlob)try{this.userDidClick=!0,this.setState({decryptedBlob:await this.props.mediaEventHelper.sourceBlob.value})}catch(e){c.a.warn("Unable to decrypt attachment: ",e),d.b.createDialog(m.a,{title:Object(l.a)("Error"),description:Object(l.a)("Error decrypting attachment")})}})),s()(this,"onPlaceholderClick",(async()=>{const e=this.props.mediaEventHelper;null!=e&&e.media.isEncrypted?(await this.decryptFile(),this.downloadFile(this.fileName,this.linkText)):this.fileDownloader.download({blob:await e.sourceBlob.value,name:this.fileName})})),this.state={}}getContentUrl(){if(this.props.forExport)return null;return Object(h.a)(this.props.mxEvent.getContent()).srcHttp}get content(){return this.props.mxEvent.getContent()}get fileName(){return this.content.body&&this.content.body.length>0?this.content.body:Object(l.a)("Attachment")}get linkText(){return Object(p.a)(this.content)}downloadFile(e,t){this.fileDownloader.download({blob:this.state.decryptedBlob,name:e,autoDownload:this.userDidClick,opts:{imgSrc:b,imgStyle:null,style:y(this.dummyLink.current),textContent:Object(l.a)("Download %(text)s",{text:t})}})}componentDidUpdate(e,t){this.props.onHeightChanged&&!t.decryptedBlob&&this.state.decryptedBlob&&this.props.onHeightChanged()}render(){var e;const t=null===(e=this.props.mediaEventHelper)||void 0===e?void 0:e.media.isEncrypted,n=this.getContentUrl(),i=this.content.info?this.content.info.size:null,s=this.content.info?this.content.info.mimetype:"application/octet-stream";let o=null;if(this.props.showGenericPlaceholder&&(o=r.a.createElement(u.a,{className:"mx_MediaBody mx_MFileBody_info",onClick:this.onPlaceholderClick},r.a.createElement("span",{className:"mx_MFileBody_info_icon"}),r.a.createElement(v.a,{tooltip:Object(p.a)(this.content,Object(l.a)("Attachment"),!0)},r.a.createElement("span",{className:"mx_MFileBody_info_filename"},Object(p.a)(this.content,Object(l.a)("Attachment"),!0,!0))))),this.props.forExport){var d;const e=this.props.mxEvent.getContent();return r.a.createElement("span",{className:"mx_MFileBody"},r.a.createElement("a",{href:(null===(d=e.file)||void 0===d?void 0:d.url)||e.url},o))}let h=!this.props.showGenericPlaceholder||this.context.timelineRenderingType!==f.a.Room&&this.context.timelineRenderingType!==f.a.Search&&this.context.timelineRenderingType!==f.a.Pinned;if(this.context.timelineRenderingType===f.a.Thread&&(h=!1),t){if(!this.state.decryptedBlob)return r.a.createElement("span",{className:"mx_MFileBody"},o,h&&r.a.createElement("div",{className:"mx_MFileBody_download"},r.a.createElement(u.a,{onClick:this.decryptFile},Object(l.a)("Decrypt %(text)s",{text:this.linkText}))),this.props.scBubbleTimestamp);const e="usercontent/";return r.a.createElement("span",{className:"mx_MFileBody"},o,h&&r.a.createElement("div",{className:"mx_MFileBody_download"},r.a.createElement("div",{"aria-hidden":!0,style:{display:"none"}},r.a.createElement("a",{ref:this.dummyLink})),r.a.createElement("iframe",{"aria-hidden":!0,title:Object(p.a)(this.content,Object(l.a)("Attachment"),!0,!0),src:e,onLoad:()=>this.downloadFile(this.fileName,this.linkText),ref:this.iframe,sandbox:"allow-scripts allow-downloads allow-downloads-without-user-activation"})),this.props.scBubbleTimestamp)}if(n){var m;const e={target:"_blank",rel:"noreferrer noopener",href:n},t="number"!=typeof i||i>524288e3;return["application/pdf"].includes(s)&&!t?e.onClick=e=>{c.a.log(`Downloading ${s} as blob (unencrypted)`),e.preventDefault(),e.stopPropagation(),this.props.mediaEventHelper.sourceBlob.value.then((e=>{const t=URL.createObjectURL(e),n=document.createElement("a");n.download=this.fileName,n.href=t,document.body.appendChild(n),n.click(),n.remove()}))}:e.download=this.fileName,r.a.createElement("span",{className:"mx_MFileBody"},o,h&&r.a.createElement("div",{className:"mx_MFileBody_download"},r.a.createElement("a",e,r.a.createElement("span",{className:"mx_MFileBody_download_icon"}),Object(l.a)("Download %(text)s",{text:this.linkText})),this.context.timelineRenderingType===f.a.File&&r.a.createElement("div",{className:"mx_MImageBody_size"},null!==(m=this.content.info)&&void 0!==m&&m.size?Object(a.filesize)(this.content.info.size):"")),this.props.scBubbleTimestamp)}{const e=this.linkText?": "+this.linkText:"";return r.a.createElement("span",{className:"mx_MFileBody"},o,Object(l.a)("Invalid file%(extra)s",{extra:e}),this.props.scBubbleTimestamp)}}}s()(S,"contextType",f.b),s()(S,"defaultProps",{showGenericPlaceholder:!0})},function(e,t,n){"use strict";n.d(t,"b",(function(){return b})),n.d(t,"a",(function(){return E}));var i=n(122),s=n.n(i),o=n(150),r=n(137),a=n(274),c=n(207),l=n(1),d=n(125),u=n(203),h=n(147),m=n(273),p=n(275);function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const f=(e,t)=>e.beaconInfoOwner===t;let b;!function(e){e.LivenessChange="OwnBeaconStore.LivenessChange",e.MonitoringLivePosition="OwnBeaconStore.MonitoringLivePosition",e.LocationPublishError="LocationPublishError",e.BeaconUpdateError="BeaconUpdateError"}(b||(b={}));const y="mx_live_beacon_created_id",S=()=>{let e;try{var t;if(e=JSON.parse(null!==(t=window.localStorage.getItem(y))&&void 0!==t?t:"[]"),!Array.isArray(e))throw new Error("Invalid stored value")}catch(t){l.a.error("Failed to retrieve locally created beacon event ids",t),e=[]}return e};class E extends u.a{constructor(){super(d.a),s()(this,"beacons",new Map),s()(this,"beaconsByRoomId",new Map),s()(this,"beaconLocationPublishErrorCounts",new Map),s()(this,"beaconUpdateErrors",new Map),s()(this,"liveBeaconIds",[]),s()(this,"locationInterval",void 0),s()(this,"geolocationError",void 0),s()(this,"clearPositionWatch",void 0),s()(this,"lastPublishedPositionTimestamp",void 0),s()(this,"hasLiveBeacons",(e=>!!this.getLiveBeaconIds(e).length)),s()(this,"hasLocationPublishErrors",(e=>this.getLiveBeaconIds(e).some(this.beaconHasLocationPublishError))),s()(this,"beaconHasLocationPublishError",(e=>this.beaconLocationPublishErrorCounts.get(e)>=2)),s()(this,"resetLocationPublishError",(e=>{this.incrementBeaconLocationPublishErrorCount(e,!1),this.publishCurrentLocationToBeacons()})),s()(this,"getLiveBeaconIds",(e=>e?this.liveBeaconIds.filter((t=>{var n;return null===(n=this.beaconsByRoomId.get(e))||void 0===n?void 0:n.has(t)})):this.liveBeaconIds)),s()(this,"getLiveBeaconIdsWithLocationPublishError",(e=>this.getLiveBeaconIds(e).filter(this.beaconHasLocationPublishError))),s()(this,"getBeaconById",(e=>this.beacons.get(e))),s()(this,"stopBeacon",(async e=>{var t;const n=this.beacons.get(e);null!=n&&null!==(t=n.beaconInfo)&&void 0!==t&&t.live&&(await this.updateBeaconEvent(n,{live:!1}),(e=>{const t=S();window.localStorage.setItem(y,JSON.stringify(t.filter((t=>t!==e))))})(n.beaconInfoId))})),s()(this,"onNewBeacon",((e,t)=>{f(t,this.matrixClient.getUserId())&&(this.addBeacon(t),this.checkLiveness())})),s()(this,"onUpdateBeacon",((e,t)=>{f(t,this.matrixClient.getUserId())&&(this.checkLiveness(),t.monitorLiveness())})),s()(this,"onDestroyBeacon",(e=>{this.beacons.has(e)&&this.checkLiveness()})),s()(this,"onBeaconLiveness",((e,t)=>{this.beacons.has(t.identifier)&&(e||this.stopBeacon(t.identifier),this.checkLiveness(),this.emit(b.LivenessChange,this.getLiveBeaconIds()))})),s()(this,"onRoomStateMembers",((e,t,n)=>{var i;this.beaconsByRoomId.has(t.roomId)&&n.userId===this.matrixClient.getUserId()&&("leave"!==n.membership&&"ban"!==n.membership||(null===(i=this.beaconsByRoomId.get(t.roomId))||void 0===i||i.forEach(this.removeBeacon),this.beaconsByRoomId.delete(t.roomId)))})),s()(this,"initialiseBeaconState",(()=>{const e=this.matrixClient.getUserId();this.matrixClient.getVisibleRooms().forEach((t=>{[...t.currentState.beacons.values()].filter((t=>f(t,e))).forEach((e=>this.addBeacon(e)))})),this.checkLiveness()})),s()(this,"addBeacon",(e=>{this.beacons.set(e.identifier,e),this.beaconsByRoomId.has(e.roomId)||this.beaconsByRoomId.set(e.roomId,new Set),this.beaconsByRoomId.get(e.roomId).add(e.identifier),e.monitorLiveness()})),s()(this,"removeBeacon",(e=>{this.beacons.has(e)&&(this.beacons.get(e).destroy(),this.beacons.delete(e),this.checkLiveness())})),s()(this,"checkLiveness",(()=>{const e=S(),t=this.getLiveBeaconIds();this.liveBeaconIds=[...this.beacons.values()].filter((t=>t.isLive&&e.includes(t.beaconInfoId))).sort(m.i).map((e=>e.identifier));const n=Object(h.a)(t,this.liveBeaconIds);(n.added.length||n.removed.length)&&this.emit(b.LivenessChange,this.liveBeaconIds),n.added.length&&this.isMonitoringLiveLocation&&this.publishCurrentLocationToBeacons(),!(null==t||!t.length)!=!!this.liveBeaconIds.length&&this.togglePollingLocation()})),s()(this,"createLiveBeacon",(async(e,t)=>{const n=this.getLiveBeaconIds(e);await Promise.all(n.map((e=>this.stopBeacon(e))));const{event_id:i}=await Object(p.a)(e,(e=>this.matrixClient.unstable_createLiveBeacon(e,t)),this.matrixClient);(e=>{const t=S();window.localStorage.setItem(y,JSON.stringify([...t,e]))})(i)})),s()(this,"togglePollingLocation",(()=>{this.liveBeaconIds.length?this.startPollingLocation():this.stopPollingLocation()})),s()(this,"startPollingLocation",(async()=>{this.stopPollingLocation();try{this.clearPositionWatch=Object(m.l)(this.onWatchedPosition,this.onGeolocationError)}catch(e){return void this.onGeolocationError(null==e?void 0:e.message)}this.locationInterval=window.setInterval((()=>{this.lastPublishedPositionTimestamp&&this.lastPublishedPositionTimestamp<=Date.now()-3e4&&this.publishCurrentLocationToBeacons()}),3e4),this.emit(b.MonitoringLivePosition)})),s()(this,"stopPollingLocation",(()=>{clearInterval(this.locationInterval),this.locationInterval=void 0,this.lastPublishedPositionTimestamp=void 0,this.geolocationError=void 0,this.clearPositionWatch&&(this.clearPositionWatch(),this.clearPositionWatch=void 0),this.emit(b.MonitoringLivePosition)})),s()(this,"onWatchedPosition",(e=>{const t=Object(m.h)(e);this.lastPublishedPositionTimestamp?this.debouncedPublishLocationToBeacons(t):this.publishLocationToBeacons(t)})),s()(this,"onGeolocationError",(async e=>{this.geolocationError=e,l.a.error("Geolocation failed",this.geolocationError),[m.a.Unavailable,m.a.PermissionDenied].includes(e)&&(this.stopPollingLocation(),await Promise.all(this.liveBeaconIds.map(this.stopBeacon)))})),s()(this,"publishCurrentLocationToBeacons",(async()=>{try{const e=await Object(m.e)();this.publishLocationToBeacons(Object(m.h)(e))}catch(e){this.onGeolocationError(null==e?void 0:e.message)}})),s()(this,"updateBeaconEvent",(async(e,t)=>{const{description:n,timeout:i,timestamp:s,live:o,assetType:r}=v(v({},e.beaconInfo),t),c=Object(a.makeBeaconInfoContent)(i,o,n,r,s);try{await this.matrixClient.unstable_setLiveBeacon(e.roomId,c);this.beaconUpdateErrors.has(e.identifier)&&(this.beaconUpdateErrors.delete(e.identifier),this.emit(b.BeaconUpdateError,e.identifier,!1))}catch(t){throw l.a.error("Failed to update beacon",t),this.beaconUpdateErrors.set(e.identifier,t),this.emit(b.BeaconUpdateError,e.identifier,!0),t}})),s()(this,"publishLocationToBeacons",(async e=>{this.lastPublishedPositionTimestamp=Date.now(),await Promise.all(this.healthyLiveBeaconIds.map((t=>this.sendLocationToBeacon(this.beacons.get(t),e))))})),s()(this,"debouncedPublishLocationToBeacons",Object(o.debounce)(this.publishLocationToBeacons,5e3)),s()(this,"sendLocationToBeacon",(async(e,t)=>{let{geoUri:n,timestamp:i}=t;const s=Object(a.makeBeaconContent)(n,i,e.beaconInfoId);try{await this.matrixClient.sendEvent(e.roomId,c.a.name,s),this.incrementBeaconLocationPublishErrorCount(e.identifier,!1)}catch(t){l.a.error(t),this.incrementBeaconLocationPublishErrorCount(e.identifier,!0)}})),s()(this,"incrementBeaconLocationPublishErrorCount",((e,t)=>{const n=this.beaconHasLocationPublishError(e);var i;t?this.beaconLocationPublishErrorCounts.set(e,(null!==(i=this.beaconLocationPublishErrorCounts.get(e))&&void 0!==i?i:0)+1):this.beaconLocationPublishErrorCounts.delete(e);this.beaconHasLocationPublishError(e)!==n&&this.emit(b.LocationPublishError,e)}))}static get instance(){return E.internalInstance}get isMonitoringLiveLocation(){return!!this.clearPositionWatch}async onNotReady(){this.matrixClient.removeListener(r.BeaconEvent.LivenessChange,this.onBeaconLiveness),this.matrixClient.removeListener(r.BeaconEvent.New,this.onNewBeacon),this.matrixClient.removeListener(r.BeaconEvent.Update,this.onUpdateBeacon),this.matrixClient.removeListener(r.BeaconEvent.Destroy,this.onDestroyBeacon),this.matrixClient.removeListener(r.RoomStateEvent.Members,this.onRoomStateMembers),this.beacons.forEach((e=>e.destroy())),this.stopPollingLocation(),this.beacons.clear(),this.beaconsByRoomId.clear(),this.liveBeaconIds=[],this.beaconLocationPublishErrorCounts.clear(),this.beaconUpdateErrors.clear()}async onReady(){this.matrixClient.on(r.BeaconEvent.LivenessChange,this.onBeaconLiveness),this.matrixClient.on(r.BeaconEvent.New,this.onNewBeacon),this.matrixClient.on(r.BeaconEvent.Update,this.onUpdateBeacon),this.matrixClient.on(r.BeaconEvent.Destroy,this.onDestroyBeacon),this.matrixClient.on(r.RoomStateEvent.Members,this.onRoomStateMembers),this.initialiseBeaconState()}async onAction(e){}get healthyLiveBeaconIds(){return this.liveBeaconIds.filter((e=>!this.beaconHasLocationPublishError(e)&&!this.beaconUpdateErrors.has(e)))}}s()(E,"internalInstance",(()=>{const e=new E;return e.start(),e})())},function(e,t,n){"use strict";var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l),u=n(645);const h=["className","withError","isIdle"];t.a=e=>{let{className:t,withError:n,isIdle:i}=e,o=r()(e,h);return c.a.createElement(u.a,s()({},o,{className:d()("mx_StyledLiveBeaconIcon",t,{mx_StyledLiveBeaconIcon_error:n,mx_StyledLiveBeaconIcon_idle:i})}))}},function(e,t,n){"use strict";var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l);const u=["legend","className","children","description"];t.a=e=>{let{legend:t,className:n,children:i,description:o}=e,a=r()(e,u);return c.a.createElement("fieldset",s()({},a,{className:d()("mx_SettingsFieldset",n)}),c.a.createElement("legend",{className:"mx_SettingsFieldset_legend"},t),o&&c.a.createElement("div",{className:"mx_SettingsFieldset_description"},o),i)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"c",(function(){return m})),n.d(t,"b",(function(){return p})),n.d(t,"d",(function(){return g})),n.d(t,"e",(function(){return f}));var i=n(122),s=n.n(i),o=n(200),r=n(1),a=n(125),c=n(129),l=n(690),d=n(123),u=n(445);const h="mx_sso_hs_url",m="mx_sso_is_url",p="mx_sso_idp_id";let g;!function(e){e.Checking="CHECKING",e.Error="ERROR",e.NotAvailable="NOTAVAILABLE",e.Downloading="DOWNLOADING",e.Ready="READY"}(g||(g={}));const v="mx_defer_update";class f{constructor(){s()(this,"notificationCount",0),s()(this,"errorDidOccur",!1),s()(this,"onAction",(e=>{switch(e.action){case"on_client_not_viable":case c.a.OnLoggedOut:this.setNotificationCount(0)}})),a.a.register(this.onAction),this.startUpdateCheck=this.startUpdateCheck.bind(this)}setNotificationCount(e){this.notificationCount=e}setErrorStatus(e){this.errorDidOccur=e}async canSelfUpdate(){return!1}startUpdateCheck(){Object(l.a)(),localStorage.removeItem(v),a.a.dispatch({action:c.a.CheckUpdates,status:g.Checking})}installUpdate(){}shouldShowUpdate(e){if(d.a.userRegisteredWithinLastHours(24))return!1;try{const[t,n]=JSON.parse(localStorage.getItem(v));return e!==t||Date.now()>n}catch(e){return!0}}deferUpdate(e){const t=new Date(Date.now()+864e5);t.setHours(8,0,0,0),localStorage.setItem(v,JSON.stringify([e,t.getTime()])),Object(l.a)()}supportsSpellCheckSettings(){return!1}allowOverridingNativeContextMenus(){return!1}supportsNotifications(){return!1}maySendNotifications(){return!1}displayNotification(e,t,n,i,s){const o={body:t,silent:!0};n&&(o.icon=n);const r=new window.Notification(e,o);return r.onclick=()=>{const e={action:c.a.ViewRoom,room_id:i.roomId,metricsTrigger:"Notification"};null!=s&&s.getThread()&&(e.event_id=s.getId()),a.a.dispatch(e),window.focus()},r}loudNotification(e,t){}clearNotification(e){e.close&&e.close()}needsUrlTooltips(){return!1}supportsSetting(e){return!1}async getSettingValue(e){}setSettingValue(e,t){throw new Error("Unimplemented")}getEventIndexingManager(){return null}setLanguage(e){}setSpellCheckEnabled(e){}async getSpellCheckEnabled(){return!1}setSpellCheckLanguages(e){}getSpellCheckLanguages(){return null}async getDesktopCapturerSources(e){return[]}supportsDesktopCapturer(){return!1}supportsJitsiScreensharing(){return!0}overrideBrowserShortcuts(){return!1}navigateForwardBack(e){}getAvailableSpellCheckLanguages(){return null}getSSOCallbackUrl(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const t=new URL(window.location.href);return t.hash=e,t}startSingleSignOn(e,t,n,i,s){localStorage.setItem(h,e.getHomeserverUrl()),e.getIdentityServerUrl()&&localStorage.setItem(m,e.getIdentityServerUrl()),i&&localStorage.setItem(p,i);const o=this.getSSOCallbackUrl(n);window.location.href=e.getSsoLoginUrl(o.toString(),t,i,s)}async getPickleKey(e,t){if(!window.crypto||!window.crypto.subtle)return null;let n;try{n=await Object(u.c)("pickleKey",[e,t])}catch(e){r.a.error("idbLoad for pickleKey failed",e)}if(!n)return null;if(!n.encrypted||!n.iv||!n.cryptoKey)return r.a.error("Badly formatted pickle key"),null;const i=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);i[e.length]=124;for(let n=0;n<t.length;n++)i[e.length+1+n]=t.charCodeAt(n);try{const e=await crypto.subtle.decrypt({name:"AES-GCM",iv:n.iv,additionalData:i},n.cryptoKey,n.encrypted);return Object(o.encodeUnpaddedBase64)(e)}catch(e){return r.a.error("Error decrypting pickle key"),null}}async createPickleKey(e,t){if(!window.crypto||!window.crypto.subtle)return null;const n=window.crypto,i=new Uint8Array(32);n.getRandomValues(i);const s=await n.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),r=new Uint8Array(32);n.getRandomValues(r);const a=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)a[t]=e.charCodeAt(t);a[e.length]=124;for(let n=0;n<t.length;n++)a[e.length+1+n]=t.charCodeAt(n);const c=await n.subtle.encrypt({name:"AES-GCM",iv:r,additionalData:a},s,i);try{await Object(u.d)("pickleKey",[e,t],{encrypted:c,iv:r,cryptoKey:s})}catch(e){return null}return Object(o.encodeUnpaddedBase64)(i)}async destroyPickleKey(e,t){try{await Object(u.b)("pickleKey",[e,t])}catch(e){r.a.error("idbDelete failed in destroyPickleKey",e)}}}},,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return T}));var i=n(122),s=n.n(i),o=n(16),r=n(137),a=n(128),c=n(121),l=n(120),d=n.n(l),u=n(1),h=n(798);class m extends h.a{constructor(e){super(e),s()(this,"contentRef",Object(l.createRef)()),this.state={title:this.props.title,canSubmit:!0,actionLabel:Object(c.a)("OK")}}async submit(){try{const e=await this.contentRef.current.trySubmit();this.props.onFinished(!0,e)}catch(e){u.a.error("Error during submission of module dialog:",e)}}cancel(){this.props.onFinished(!1)}renderContent(){return d.a.createElement("div",{className:"mx_ModuleUiDialog"},this.props.contentFactory(this.props.contentProps,this.contentRef))}}var p=n(132),g=n(156),v=n(125),f=n(915),b=n(168),y=n(123),S=n(399),E=n(129);function w(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function _(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?w(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class C{constructor(){s()(this,"cachedTranslations",void 0)}get translations(){return this.cachedTranslations}registerTranslations(e){this.cachedTranslations=e}translateString(e,t){return Object(c.a)(e,t)}openDialog(e,t){return new Promise((n=>{a.b.createDialog(m,{title:e,contentFactory:t,contentProps:{moduleApi:this}},"mx_CompoundDialog").finished.then((e=>{let[t,i]=e;n({didOkOrSubmit:t,model:i})}))}))}async registerSimpleAccount(e,t,n){var i,s;const o=null===(i=p.b.get("validated_server_config"))||void 0===i?void 0:i.hsUrl,a=r.createClient({baseUrl:o}),c={username:e,password:t,initial_device_display_name:p.b.get("default_device_display_name")||(null===(s=g.a.get())||void 0===s?void 0:s.getDefaultDeviceDisplayName()),auth:void 0,inhibit_login:!1},l=await a.registerRequest(c).catch((e=>a.registerRequest(_(_({},c),{},{auth:{session:e.data.session,type:"m.login.dummy"}}))));if(n){const e=r.createClient({baseUrl:o,userId:l.user_id,deviceId:l.device_id,accessToken:l.access_token});await e.setDisplayName(n)}return{homeserverUrl:o,userId:l.user_id,deviceId:l.device_id,accessToken:l.access_token}}async overwriteAccountAuth(e){v.a.dispatch({action:E.a.OverwriteLogin,credentials:_(_({},e),{},{guest:!1})},!0)}async navigatePermalink(e,t){Object(f.a)(e);const n=Object(b.j)(e);if(null!=n&&n.roomIdOrAlias&&t){let e=n.roomIdOrAlias,i=n.viaServers;if(e.startsWith("#")&&(e=Object(S.a)(n.roomIdOrAlias),!e)){const t=await y.a.get().getRoomIdForAlias(n.roomIdOrAlias);e=t.room_id,i||(i=t.servers)}v.a.dispatch({action:E.a.ViewRoom,room_id:e,via_servers:i}),t&&v.a.dispatch({action:E.a.JoinRoom})}}getConfigValue(e,t){const n=p.b.get(e);if(n&&"object"==typeof n)return n[t]}}class O{constructor(e){s()(this,"module",void 0),s()(this,"api",new C),this.module=e(this.api)}}var I=n(1575),R=n(1577),k=n(140),x=n(135);I.TextInputField.renderFactory=e=>d.a.createElement(k.a,{type:"text",value:e.value,onChange:t=>e.onChange(t.target.value),label:e.label,autoComplete:"off"}),R.Spinner.renderFactory=()=>d.a.createElement(x.a,null);class T{constructor(){s()(this,"modules",[])}reset(){this.modules=[]}get allTranslations(){const e={};for(const t of this.modules){const n=t.api.translations;if(n)for(const[t,i]of Object.entries(n)){Object(o.L)(e,t,e[t]||{});for(const[n,s]of Object.entries(i))Object(o.L)(e[t],n,s)}}return e}registerModule(e){this.modules.push(new O(e))}invoke(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(const t of this.modules)t.module.emit(e,...n)}}s()(T,"instance",new T)},,function(e,t,n){"use strict";n.d(t,"c",(function(){return w})),n.d(t,"a",(function(){return _})),n.d(t,"b",(function(){return I})),n.d(t,"d",(function(){return R}));var i=n(122),s=n.n(i),o=n(1490),r=n.n(o),a=n(1491),c=n(204),l=n(17),d=n.n(l),u=n(1),h=n(249),m=n(598);let p;!function(e){e.Timekeep="timekeep",e.AmplitudeMark="amplitude_mark"}(p||(p={}));var g=n(154),v=n(820),f=n(147);class b{constructor(e,t){this.width=e,s()(this,"samples",[]),this.samples=Object(f.h)(t,this.width)}get value(){return this.samples}pushValue(e){let t=Object(f.b)(this.samples);t.splice(0,0,e),t.length>this.width&&(t=t.slice(0,this.width)),this.samples=t}}var y=n(293),S=n(1492),E=n.n(S);const w=48e3,_=44,C={bitrate:24e3,encoderApplication:2048},O={bitrate:96e3,encoderApplication:2049};let I;!function(e){e.Started="started",e.EndingSoon="ending_soon",e.Ended="ended",e.Uploading="uploading",e.Uploaded="uploaded"}(I||(I={}));class R extends d.a{constructor(){super(...arguments),s()(this,"recorder",void 0),s()(this,"recorderContext",void 0),s()(this,"recorderSource",void 0),s()(this,"recorderStream",void 0),s()(this,"recorderWorklet",void 0),s()(this,"recorderProcessor",void 0),s()(this,"recording",!1),s()(this,"observable",void 0),s()(this,"targetMaxLength",900),s()(this,"amplitudes",[]),s()(this,"liveWaveform",new b(_,0)),s()(this,"onDataAvailable",void 0),s()(this,"onAudioProcess",(e=>{this.processAudioUpdate(e.playbackTime)})),s()(this,"processAudioUpdate",(e=>{if(!this.recording)return;if(this.observable.update({waveform:this.liveWaveform.value.map((e=>Object(y.a)(e,0,1))),timeSeconds:e}),!this.targetMaxLength)return;const t=900-this.recorderSeconds;t<0?this.stop():t<=10&&m.a.for(this,"ending_soon").do((()=>(this.emit(I.EndingSoon,{secondsLeft:t}),m.a.Void)))}))}get contentType(){return"audio/ogg"}get durationSeconds(){if(!this.recorder)throw new Error("Duration not available without a recording");return this.recorderContext.currentTime}get isRecording(){return this.recording}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n),super.emit(g.b,e,...n),!0}disableMaxLength(){this.targetMaxLength=null}shouldRecordInHighQuality(){return!h.c.getAudioNoiseSuppression()}async makeRecorder(){try{this.recorderStream=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,deviceId:h.c.getAudioInput(),autoGainControl:{ideal:h.c.getAudioAutoGainControl()},echoCancellation:{ideal:h.c.getAudioEchoCancellation()},noiseSuppression:{ideal:h.c.getAudioNoiseSuppression()}}}),this.recorderContext=Object(v.a)({}),this.recorderSource=this.recorderContext.createMediaStreamSource(this.recorderStream),this.recorderContext.audioWorklet?(await this.recorderContext.audioWorklet.addModule(E.a),this.recorderWorklet=new AudioWorkletNode(this.recorderContext,"mx-voice-worklet"),this.recorderSource.connect(this.recorderWorklet),this.recorderWorklet.connect(this.recorderContext.destination),this.recorderWorklet.port.onmessage=e=>{switch(e.data.ev){case p.Timekeep:this.processAudioUpdate(e.data.timeSeconds);break;case p.AmplitudeMark:e.data.forIndex===this.amplitudes.length&&(this.amplitudes.push(e.data.amplitude),this.liveWaveform.pushValue(e.data.amplitude))}}):(this.recorderProcessor=this.recorderContext.createScriptProcessor(1024,1,1),this.recorderSource.connect(this.recorderProcessor),this.recorderProcessor.connect(this.recorderContext.destination),this.recorderProcessor.addEventListener("audioprocess",this.onAudioProcess));const e=this.shouldRecordInHighQuality()?O:C,{encoderApplication:t,bitrate:n}=e;this.recorder=new r.a({encoderPath:a.a,encoderSampleRate:w,encoderApplication:t,streamPages:!0,encoderFrameSize:20,numberOfChannels:1,sourceNode:this.recorderSource,encoderBitRate:n,encoderComplexity:3,resampleQuality:3}),this.recorder.ondataavailable=e=>{var t;return null===(t=this.onDataAvailable)||void 0===t?void 0:t.call(this,e)}}catch(e){throw u.a.error("Error starting recording: ",e),e instanceof DOMException&&u.a.error(`${e.name} (${e.code}): ${e.message}`),this.recorderStream&&this.recorderStream.getTracks().forEach((e=>e.stop())),this.recorderSource&&this.recorderSource.disconnect(),this.recorder&&this.recorder.close(),this.recorderContext&&this.recorderContext.close(),e}}get liveData(){if(!this.recording)throw new Error("No observable when not recording");return this.observable}get isSupported(){return!!r.a.isRecordingSupported()}get recorderSeconds(){return this.recorder.encodedSamplePosition/48e3}async start(){if(this.recording)throw new Error("Recording already in progress");this.observable&&this.observable.close(),this.observable=new c.SimpleObservable,await this.makeRecorder(),await this.recorder.start(),this.recording=!0,this.emit(I.Started)}async stop(){return m.a.for(this,"stop").do((async()=>{if(!this.recording)throw new Error("No recording to stop");await this.recorder.stop(),this.recorderSource.disconnect(),this.recorderWorklet&&this.recorderWorklet.disconnect(),this.recorderProcessor&&(this.recorderProcessor.disconnect(),this.recorderProcessor.removeEventListener("audioprocess",this.onAudioProcess)),await this.recorderContext.close(),this.recorderStream.getTracks().forEach((e=>e.stop())),this.recording=!1,await this.recorder.close(),this.emit(I.Ended)}))}destroy(){this.stop(),this.removeAllListeners(),this.onDataAvailable=void 0,m.a.forgetAllFor(this),this.observable.close()}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(13),s=n.n(i),o=n(1),r=n(16);function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class l{constructor(){s()(this,"outgoingRoomKeyRequests",[]),s()(this,"account",null),s()(this,"crossSigningKeys",null),s()(this,"privateKeys",{}),s()(this,"sessions",{}),s()(this,"sessionProblems",{}),s()(this,"notifiedErrorDevices",{}),s()(this,"inboundGroupSessions",{}),s()(this,"inboundGroupSessionsWithheld",{}),s()(this,"deviceData",null),s()(this,"rooms",{}),s()(this,"sessionsNeedingBackup",{}),s()(this,"sharedHistoryInboundGroupSessions",{}),s()(this,"parkedSharedHistory",new Map)}async startup(){return this}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return r.E((()=>{const n=this._getOutgoingRoomKeyRequest(t);return n?(o.a.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),n):(o.a.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this.outgoingRoomKeyRequests.push(e),e)}))}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this.outgoingRoomKeyRequests)if(r.j(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this.outgoingRoomKeyRequests)for(const n of e)if(t.state===n)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter((t=>t.state==e)))}getOutgoingRoomKeyRequestsByTarget(e,t,n){const i=[];for(const s of this.outgoingRoomKeyRequests)for(const o of n)s.state===o&&s.recipients.some((n=>n.userId===e&&n.deviceId===t))&&i.push(s);return Promise.resolve(i)}updateOutgoingRoomKeyRequest(e,t,n){for(const i of this.outgoingRoomKeyRequests)if(i.requestId===e)return i.state!==t?(o.a.warn(`Cannot update room key request from ${t} as it was already updated to ${i.state}`),Promise.resolve(null)):(Object.assign(i,n),Promise.resolve(i));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let n=0;n<this.outgoingRoomKeyRequests.length;n++){const i=this.outgoingRoomKeyRequests[n];if(i.requestId===e)return i.state!=t?(o.a.warn(`Cannot delete room key request in state ${i.state} (expected ${t})`),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(n,1),Promise.resolve(i))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,n){t(this.privateKeys[n]||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,n){this.privateKeys[t]=n}countEndToEndSessions(e,t){t(Object.keys(this.sessions).length)}getEndToEndSession(e,t,n,i){i((this.sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,n){n(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach((e=>{let[n,i]=e;Object.entries(i).forEach((e=>{let[i,s]=e;t(c(c({},s),{},{deviceKey:n,sessionId:i}))}))}))}storeEndToEndSession(e,t,n,i){let s=this.sessions[e];void 0===s&&(s={},this.sessions[e]=s),s[t]=n}async storeEndToEndSessionProblem(e,t,n){const i=this.sessionProblems[e]=this.sessionProblems[e]||[];i.push({type:t,fixed:n,time:Date.now()}),i.sort(((e,t)=>e.time-t.time))}async getEndToEndSessionProblem(e,t){const n=this.sessionProblems[e]||[];if(!n.length)return null;const i=n[n.length-1];for(const e of n)if(e.time>t)return Object.assign({},e,{fixed:i.fixed});return i.fixed?null:i}async filterOutNotifiedErrorDevices(e){const t=this.notifiedErrorDevices,n=[];for(const i of e){const{userId:e,deviceInfo:s}=i;e in t?s.deviceId in t[e]||(n.push(i),Object(r.L)(t[e],s.deviceId,!0)):(n.push(i),Object(r.L)(t,e,{[s.deviceId]:!0}))}return n}getEndToEndInboundGroupSession(e,t,n,i){const s=e+"/"+t;i(this.inboundGroupSessions[s]||null,this.inboundGroupSessionsWithheld[s]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const e of Object.keys(this.inboundGroupSessions))t({senderKey:e.slice(0,43),sessionId:e.slice(44),sessionData:this.inboundGroupSessions[e]});t(null)}addEndToEndInboundGroupSession(e,t,n,i){const s=e+"/"+t;void 0===this.inboundGroupSessions[s]&&(this.inboundGroupSessions[s]=n)}storeEndToEndInboundGroupSession(e,t,n,i){this.inboundGroupSessions[e+"/"+t]=n}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){const s=e+"/"+t;this.inboundGroupSessionsWithheld[s]=n}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,n){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){const t=[];for(const n in this.sessionsNeedingBackup)if(this.inboundGroupSessions[n]&&(t.push({senderKey:n.slice(0,43),sessionId:n.slice(44),sessionData:this.inboundGroupSessions[n]}),e&&n.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;delete this.sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;this.sessionsNeedingBackup[e]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,n){const i=this.sharedHistoryInboundGroupSessions[e]||[];i.push([t,n]),this.sharedHistoryInboundGroupSessions[e]=i}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}addParkedSharedHistory(e,t){var n;const i=null!==(n=this.parkedSharedHistory.get(e))&&void 0!==n?n:[];i.push(t),this.parkedSharedHistory.set(e,i)}takeParkedSharedHistory(e){var t;const n=null!==(t=this.parkedSharedHistory.get(e))&&void 0!==t?t:[];return this.parkedSharedHistory.delete(e),Promise.resolve(n)}doTxn(e,t,n){return Promise.resolve(n(null))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(13),s=n.n(i),o=n(224),r=n(152),a=n(16);function c(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}class l{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s()(this,"rooms",{}),s()(this,"users",{}),s()(this,"syncToken",null),s()(this,"filters",new a.b((()=>new Map))),s()(this,"accountData",new Map),s()(this,"localStorage",void 0),s()(this,"oobMembers",new Map),s()(this,"pendingEvents",{}),s()(this,"clientOptions",void 0),s()(this,"pendingToDeviceBatches",[]),s()(this,"nextToDeviceBatchId",0),s()(this,"onRoomMember",((e,t,n)=>{if("invite"===n.membership)return;const i=this.users[n.userId]||new o.a(n.userId);n.name&&(i.setDisplayName(n.name),n.events.member&&i.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&i.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[i.userId]=i})),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(r.b.Members,this.onRoomMember),e.currentState.getMembers().forEach((t=>{this.onRoomMember(null,e.currentState,t)}))}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(r.b.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map((function(e){return e.summary}))}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,n,i){}storeFilter(e){null!=e&&e.userId&&null!=e&&e.filterId&&this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var n;return(null===(n=this.filters.get(e))||void 0===n?void 0:n.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;const t="mxjssdk_memory_filter_"+e;try{const e=this.localStorage.getItem(t);if(c(e))return e}catch(e){}return null}setFilterIdByName(e,t){if(!this.localStorage)return;const n="mxjssdk_memory_filter_"+e;try{c(t)?this.localStorage.setItem(n,t):this.localStorage.removeItem(n)}catch(e){}}storeAccountDataEvents(e){e.forEach((e=>{!Object.keys(e.getContent()).length?this.accountData.delete(e.getType()):this.accountData.set(e.getType(),e)}))}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new a.b((()=>new Map)),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}async getPendingEvents(e){var t;return null!==(t=this.pendingEvents[e])&&void 0!==t?t:[]}async setPendingEvents(e,t){this.pendingEvents[e]=t}saveToDeviceBatches(e){for(const t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}async getOldestToDeviceBatch(){return 0===this.pendingToDeviceBatches.length?null:this.pendingToDeviceBatches[0]}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter((t=>t.id!==e)),Promise.resolve()}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(16);function s(e,t,n,s,o){let r=arguments.length>5&&void 0!==arguments[5]&&arguments[5];if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return r?t:"";let a=t.slice(6),c="/_matrix/media/r0/download/";const l={};n&&(l.width=Math.round(n).toString()),s&&(l.height=Math.round(s).toString()),o&&(l.method=o),Object.keys(l).length>0&&(c="/_matrix/media/r0/thumbnail/");const d=a.indexOf("#");let u="";d>=0&&(u=a.slice(d),a=a.slice(0,d));return e+c+a+(0===Object.keys(l).length?"":"?"+i.n(l))+u}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var i=n(13),s=n.n(i),o=n(180),r=n(1),a=n(141),c=n(159),l=n(699);let d,u;d=r.a.log.bind(r.a),function(e){e.Ignore="ignore",e.Replace="replace"}(u||(u={}));class h extends c.b{constructor(e){var t,n,i;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0,c=arguments.length>3?arguments[3]:void 0,d=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;super(),this.room=e,this.thread=c,this.threadListType=d,s()(this,"relations",void 0),s()(this,"timelineSupport",void 0),s()(this,"displayPendingEvents",void 0),s()(this,"liveTimeline",void 0),s()(this,"timelines",void 0),s()(this,"_eventIdToTimeline",new Map),s()(this,"filter",void 0),this.timelineSupport=Boolean(r.timelineSupport),this.liveTimeline=new o.b(this),this.displayPendingEvents=!1!==r.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=r.filter,this.relations=null!==(t=null===(n=this.room)||void 0===n?void 0:n.relations)&&void 0!==t?t:new l.a(null!==(i=null==e?void 0:e.client)&&void 0!==i?i:a)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){const n=this._eventIdToTimeline.get(e);n&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,n))}resetLiveTimeline(e,t){const n=!this.timelineSupport||!t,i=this.liveTimeline,s=n?i.forkLive(o.b.FORWARDS):i.fork(o.b.FORWARDS);n?(this.timelines=[s],this._eventIdToTimeline=new Map):this.timelines.push(s),t&&i.setPaginationToken(t,o.b.FORWARDS),s.setPaginationToken(null!=e?e:null,o.b.BACKWARDS),this.liveTimeline=s,this.emit(a.d.TimelineReset,this.room,this,n)}getTimelineForEvent(e){if(null==e)return null;const t=this._eventIdToTimeline.get(e);return void 0===t?null:t}findEventById(e){const t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new o.b(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,n,i){if(!n)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&n==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&!(e=this.filter.filterRoomTimeline(e)).length)return;const s=t?o.b.BACKWARDS:o.b.FORWARDS,a=t?o.b.FORWARDS:o.b.BACKWARDS;let c=!1,l=!1;for(const i of e){const e=i.getId(),u=this._eventIdToTimeline.get(e);if(!u){this.addEventToTimeline(i,n,{toStartOfTimeline:t}),l=!0,c=!0;continue}if(l=!1,u==n){d("Event "+e+" already in timeline "+n);continue}const h=n.getNeighbouringTimeline(s);if(h){d(u==h?"Event "+e+" in neighbouring timeline - switching to "+u:"Event "+e+" already in a different timeline "+u),n=u;continue}r.a.info("Already have timeline for "+e+" - joining timeline "+n+" to "+u);const m=u===this.liveTimeline,p=n===this.liveTimeline,g=s===o.b.BACKWARDS&&m,v=s===o.b.FORWARDS&&p;g||v?(g&&r.a.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+u+")"),v&&r.a.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+n+")")):(n.setNeighbouringTimeline(u,s),u.setNeighbouringTimeline(n,a),n=u,c=!0)}if(l||!c){if(s===o.b.FORWARDS&&n===this.liveTimeline)return r.a.warn({lastEventWasNew:l,didUpdate:c}),void r.a.warn(`Refusing to set forwards pagination token of live timeline ${n} to ${i}`);n.setPaginationToken(null!=i?i:null,s)}}addLiveEvent(e,t){let n,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3?arguments[3]:void 0,a=t||u.Ignore;if("object"==typeof t?({duplicateStrategy:a=u.Ignore,fromCache:i=!1,roomState:s,timelineWasEmpty:n}=t):void 0!==t&&r.a.warn("Overload deprecated: `EventTimelineSet.addLiveEvent(event, duplicateStrategy?, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addLiveEvent(event, IAddLiveEventOptions)`"),this.filter){if(!this.filter.filterRoomTimeline([e]).length)return}const c=this._eventIdToTimeline.get(e.getId());if(c)if(a===u.Replace){d("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=c.getEvents();for(let n=0;n<t.length;n++)if(t[n].getId()===e.getId()){s||(s=c.getState(o.b.FORWARDS)),o.b.setEventMetadata(e,s,!1),t[n]=e;break}}else d("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:s,timelineWasEmpty:n})}addEventToTimeline(e,t,n){let i,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4?arguments[4]:void 0,c=!!n;var l;if("object"==typeof n?({toStartOfTimeline:c,fromCache:s=!1,roomState:o,timelineWasEmpty:i}=n):void 0!==n&&r.a.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`"),t.getTimelineSet()!==this)throw new Error(`EventTimelineSet.addEventToTimeline: Timeline=${t.toString()} does not belong " +\n                "in timelineSet(threadId=${null===(l=this.thread)||void 0===l?void 0:l.id})`);if(this.room&&!this.canContain(e)){var d;let n=`event=${e.getId()}`;return e.threadRootId&&(n+=`(belongs to thread=${e.threadRootId})`),void r.a.warn(`EventTimelineSet.addEventToTimeline: Ignoring ${n} that does not belong in timeline=${t.toString()} timelineSet(threadId=${null===(d=this.thread)||void 0===d?void 0:d.id})`)}const u=e.getId();t.addEvent(e,{toStartOfTimeline:c,roomState:o,timelineWasEmpty:i}),this._eventIdToTimeline.set(u,t),this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this);const h={timeline:t,liveEvent:!c&&t==this.liveTimeline&&!s};this.emit(a.d.Timeline,e,this.room,Boolean(c),!1,h)}handleRemoteEcho(e,t,n){const i=this._eventIdToTimeline.get(t);i?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(n,i)):this.filter&&!this.filter.filterRoomTimeline([e]).length||this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(e){const t=this._eventIdToTimeline.get(e);if(!t)return null;const n=t.removeEvent(e);if(n){this._eventIdToTimeline.delete(e);const i={timeline:t};this.emit(a.d.Timeline,n,this.room,void 0,!0,i)}return n}compareEventOrdering(e,t){if(e==t)return 0;const n=this._eventIdToTimeline.get(e),i=this._eventIdToTimeline.get(t);if(void 0===n)return null;if(void 0===i)return null;if(n===i){let i,s;const o=n.getEvents();for(let n=0;n<o.length&&(void 0===i||void 0===s);n++){const r=o[n].getId();r==e&&(i=n),r==t&&(s=n)}return i-s}let s=n;for(;s;){if(s===i)return-1;s=s.getNeighbouringTimeline(o.b.FORWARDS)}for(s=n;s;){if(s===i)return 1;s=s.getNeighbouringTimeline(o.b.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");const{threadId:t,shouldLiveInRoom:n}=this.room.eventShouldLiveIn(e);return this.thread?this.thread.id===t:n}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return u}));var i=n(13),s=n.n(i),o=n(144),r=n(1),a=n(130),c=n(159),l=n(141);let d;!function(e){e.Add="Relations.add",e.Remove="Relations.remove",e.Redaction="Relations.redaction"}(d||(d={}));class u extends c.b{constructor(e,t,n,i){super(),this.relationType=e,this.eventType=t,this.altEventTypes=i,s()(this,"relationEventIds",new Set),s()(this,"relations",new Set),s()(this,"annotationsByKey",{}),s()(this,"annotationsBySender",{}),s()(this,"sortedAnnotationsByKey",[]),s()(this,"targetEvent",null),s()(this,"creationEmitted",!1),s()(this,"client",void 0),s()(this,"onEventStatus",((e,t)=>{e.isSending()?t===o.a.CANCELLED&&(e.removeListener(o.c.Status,this.onEventStatus),this.removeEvent(e)):e.removeListener(o.c.Status,this.onEventStatus)})),s()(this,"onBeforeRedaction",(async e=>{if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===a.h.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===a.h.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.removeListener(o.c.BeforeRedaction,this.onBeforeRedaction),this.emit(d.Redaction,e)}})),this.client=n instanceof l.c?n.client:n}async addEvent(e){if(this.relationEventIds.has(e.getId()))return;const t=e.getRelation();if(!t)return void r.a.error("Event must have relation info");const n=t.rel_type,i=e.getType();if(this.relationType===n&&function(e,t){return[t,...arguments.length>2&&void 0!==arguments[2]?arguments[2]:[]].includes(e)}(i,this.eventType,this.altEventTypes)){if(e.isSending()&&e.on(o.c.Status,this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),this.relationType===a.h.Annotation)this.addAnnotationToAggregation(e);else if(this.relationType===a.h.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.on(o.c.BeforeRedaction,this.onBeforeRedaction),this.emit(d.Add,e),this.maybeEmitCreated()}else r.a.error("Event relation info doesn't match this container")}async removeEvent(e){if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===a.h.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===a.h.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}this.emit(d.Remove,e)}}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t;const{key:n}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(!n)return;let i=this.annotationsByKey[n];i||(i=this.annotationsByKey[n]=new Set,this.sortedAnnotationsByKey.push([n,i])),i.add(e),this.sortedAnnotationsByKey.sort(((e,t)=>{const n=e[1];return t[1].size-n.size}));const s=e.getSender();let o=this.annotationsBySender[s];o||(o=this.annotationsBySender[s]=new Set),o.add(e)}removeAnnotationFromAggregation(e){var t;const{key:n}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(!n)return;const i=this.annotationsByKey[n];i&&(i.delete(e),this.sortedAnnotationsByKey.sort(((e,t)=>{const n=e[1];return t[1].size-n.size})));const s=e.getSender(),o=this.annotationsBySender[s];o&&o.delete(e)}getSortedAnnotationsByKey(){return this.relationType!==a.h.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==a.h.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==a.h.Replace)return null;if(!this.targetEvent)return null;const e=this.targetEvent.getServerAggregatedRelation(a.h.Replace),t=null==e?void 0:e.origin_server_ts,n=this.getRelations().reduce(((e,n)=>n.getSender()!==this.targetEvent.getSender()||t&&t>n.getTs()||e&&e.getTs()>n.getTs()?e:n),null);return null!=n&&n.shouldAttemptDecryption()&&this.client.isCryptoEnabled()?await n.attemptDecryption(this.client.crypto):null!=n&&n.isBeingDecrypted()&&await n.getDecryptionPromise(),n}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,this.relationType===a.h.Replace&&!this.targetEvent.isState()){const e=await this.getLastReplacement();e&&this.targetEvent.makeReplaced(e)}this.maybeEmitCreated()}}maybeEmitCreated(){this.creationEmitted||this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(o.c.RelationsCreated,this.relationType,this.eventType))}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"d",(function(){return l})),n.d(t,"c",(function(){return d})),n.d(t,"a",(function(){return u}));var i=n(13),s=n.n(i),o=n(274),r=n(16),a=n(159);let c;!function(e){e.New="Beacon.new",e.Update="Beacon.update",e.LivenessChange="Beacon.LivenessChange",e.Destroy="Beacon.Destroy",e.LocationUpdate="Beacon.LocationUpdate"}(c||(c={}));const l=(e,t,n)=>n>=e&&e+t>=n,d=e=>`${e.getRoomId()}_${e.getStateKey()}`;class u extends a.b{constructor(e){super(),this.rootEvent=e,s()(this,"roomId",void 0),s()(this,"_beaconInfo",void 0),s()(this,"_isLive",void 0),s()(this,"livenessWatchTimeout",void 0),s()(this,"_latestLocationEvent",void 0),s()(this,"clearLatestLocation",(()=>{this._latestLocationEvent=void 0,this.emit(c.LocationUpdate,this.latestLocationState)})),this.setBeaconInfo(this.rootEvent),this.roomId=this.rootEvent.getRoomId()}get isLive(){return!!this._isLive}get identifier(){return d(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&Object(o.parseBeaconContent)(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(d(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(c.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(c.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),this.beaconInfo)if(this.isLive){const e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(!this.isLive)return;const n=null===(t=e.filter((e=>{const t=e.getContent(),n=Object(o.parseBeaconContent)(t);if(!n.uri||!n.timestamp)return!1;const{timestamp:i}=n;return this._beaconInfo.timestamp&&l(this._beaconInfo.timestamp,this._beaconInfo.timeout,i)&&(!this.latestLocationState||i>this.latestLocationState.timestamp)})).sort(r.O))||void 0===t?void 0:t[0];n&&(this._latestLocationEvent=n,this.emit(c.LocationUpdate,this.latestLocationState))}setBeaconInfo(e){this._beaconInfo=Object(o.parseBeaconInfoContent)(e.getContent()),this.checkLiveness()}checkLiveness(){var e,t;const n=this.isLive;if(!this.beaconInfo)return;const i=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!(null===(e=this._beaconInfo)||void 0===e||!e.live)&&!!i&&l(i,null===(t=this._beaconInfo)||void 0===t?void 0:t.timeout,Date.now()),n!==this.isLive&&this.emit(c.LivenessChange,this.isLive,this)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return a}));var i=n(13),s=n.n(i);class o extends Error{constructor(e,t){super(e),this.httpStatus=t}}class r extends o{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,o=e.error||"Unknown message";t&&(o=`[${t}] ${o}`),n&&(o=`${o} (${n})`),super(`MatrixError: ${o}`,t),this.httpStatus=t,this.url=n,this.event=i,s()(this,"errcode",void 0),s()(this,"data",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}}class a extends Error{constructor(e,t){super(e+(t?`: ${t.message}`:""))}get name(){return"ConnectionError"}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s}));const i="org.matrix.msc3077.sdp_stream_metadata";let s;!function(e){e.Usermedia="m.usermedia",e.Screenshare="m.screenshare"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i,s=n(13),o=n.n(s);!function(e){e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified"}(i||(i={}));class r{static fromStorage(e,t){const n=new r(t);for(const t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}constructor(e){this.deviceId=e,o()(this,"algorithms",[]),o()(this,"keys",{}),o()(this,"verified",i.Unverified),o()(this,"known",!1),o()(this,"unsigned",{}),o()(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==i.Blocked}isVerified(){return this.verified==i.Verified}isUnverified(){return this.verified==i.Unverified}isKnown(){return!0===this.known}}o()(r,"DeviceVerification",{VERIFIED:i.Verified,UNVERIFIED:i.Unverified,BLOCKED:i.Blocked})},,function(e,t,n){"use strict";(function(e,i){n.d(t,"a",(function(){return h})),n.d(t,"c",(function(){return p})),n.d(t,"b",(function(){return g})),n.d(t,"d",(function(){return v})),n.d(t,"e",(function(){return f}));var s=n(13),o=n.n(s),r=n(200),a=n(1),c=n(227),l=n(327);const d=6e4;function u(e){return Object.values(e.keys)[0]}class h{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.userId=e,this.callbacks=t,this.cacheCallbacks=n,o()(this,"keys",{}),o()(this,"firstUse",!0),o()(this,"crossSigningVerifiedBefore",!1)}static fromStorage(e,t){const n=new h(t);for(const t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(t,n){const i=["master","self_signing","user_signing"].indexOf(t)>=0;if(!this.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function s(t){if(!t)return;const i=new e.Olm.PkSigning,s=i.init_with_seed(t);if(s===n)return[s,i];i.free()}void 0===n&&(n=this.getId(t));let o=null;this.cacheCallbacks.getCrossSigningKeyCache&&i&&(o=await this.cacheCallbacks.getCrossSigningKeyCache(t,n));const r=s(o);if(r)return r;o=await this.callbacks.getCrossSigningKey(t,n);const a=s(o);if(a)return this.cacheCallbacks.storeCrossSigningKeyCache&&i&&await this.cacheCallbacks.storeCrossSigningKeyCache(t,o),a;if(!o)throw new Error("getCrossSigningKey callback for "+t+" returned falsey");throw new Error("Key type "+t+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master")||{};function n(e){for(const n of Object.keys(t))e[n]||delete t[n]}for(const t of["self_signing","user_signing"])n(await e.isStored(`m.cross_signing.${t}`)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[n,i]of e){const e=Object(r.encodeBase64)(i);await t.store(`m.cross_signing.${n}`,e)}}static async getFromSecretStorage(e,t){const n=await t.get(`m.cross_signing.${e}`);return n?Object(r.decodeBase64)(n):null}async isStoredInKeyCache(e){const t=this.cacheCallbacks;if(!t)return!1;const n=e?[e]:["master","self_signing","user_signing"];for(const e of n){var i;if(!await(null===(i=t.getCrossSigningKeyCache)||void 0===i?void 0:i.call(t,e)))return!1}return!0}async getCrossSigningKeysFromCache(){const e=new Map,t=this.cacheCallbacks;if(!t)return e;for(const i of["master","self_signing","user_signing"]){var n;const s=await(null===(n=t.getCrossSigningKeyCache)||void 0===n?void 0:n.call(t,i));s&&e.set(i,s)}return e}getId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"master";if(!this.keys[e])return null;return u(this.keys[e])}async resetKeys(t){if(!this.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===t||t&m.MASTER||!this.keys.master)t=m.MASTER|m.USER_SIGNING|m.SELF_SIGNING;else if(0===t)return;const n={},i={};let s,o;try{if(t&m.MASTER?(s=new e.Olm.PkSigning,n.master=s.generate_seed(),o=s.init_with_seed(n.master),i.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+o]:o}}):[o,s]=await this.getCrossSigningKey("master"),t&m.SELF_SIGNING){const t=new e.Olm.PkSigning;try{n.self_signing=t.generate_seed();const e=t.init_with_seed(n.self_signing);i.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+e]:e}},Object(r.pkSign)(i.self_signing,s,this.userId,o)}finally{t.free()}}if(t&m.USER_SIGNING){const t=new e.Olm.PkSigning;try{n.user_signing=t.generate_seed();const e=t.init_with_seed(n.user_signing);i.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+e]:e}},Object(r.pkSign)(i.user_signing,s,this.userId,o)}finally{t.free()}}Object.assign(this.keys,i),this.callbacks.saveCrossSigningKeys(n)}finally{s&&s.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw a.a.error(t),new Error(t)}this.keys.master?u(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const n=u(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw a.a.error(t),new Error(t)}try{Object(r.pkVerify)(e.user_signing,n,this.userId)}catch(e){throw a.a.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw a.a.error(t),new Error(t)}try{Object(r.pkVerify)(e.self_signing,n,this.userId)}catch(e){throw a.a.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,delete this.keys.self_signing,delete this.keys.user_signing),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[n,i]=await this.getCrossSigningKey(t);try{return Object(r.pkSign)(e,i,this.userId,n),e}finally{i.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");a.a.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");a.a.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new p(!0,!0,this.firstUse);if(!this.keys.user_signing)return new p(!1,!1,e.firstUse);let t;const n=e.keys.master,i=this.getId("user_signing");try{Object(r.pkVerify)(n,i,this.userId),t=!0}catch(e){t=!1}return new p(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,n,i){const s=this.checkUserTrust(e),o=e.keys.self_signing;if(!o)return new g(!1,!1,n,i);const a=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return Object(r.pkVerify)(o,e.getId(),e.userId),Object(r.pkVerify)(a,u(o),e.userId),g.fromUserTrustLevel(s,n,i)}catch(e){return new g(!1,!1,n,i)}}getCacheCallbacks(){return this.cacheCallbacks}}let m;!function(e){e[e.MASTER=4]="MASTER",e[e.USER_SIGNING=2]="USER_SIGNING",e[e.SELF_SIGNING=1]="SELF_SIGNING"}(m||(m={}));class p{constructor(e,t,n){this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=n}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class g{constructor(e,t,n,i){this.crossSigningVerified=e,this.tofu=t,this.localVerified=n,this.trustCrossSignedDevices=i}static fromUserTrustLevel(e,t,n){return new g(e.isCrossSigningVerified(),e.isTofu(),t,n)}isVerified(){return Boolean(this.isLocallyVerified()||this.trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function v(e,t){return{getCrossSigningKeyCache:async function(n,s){const o=await new Promise((t=>e.doTxn("readonly",[c.a.STORE_ACCOUNT],(i=>{e.getSecretStorePrivateKey(i,t,n)}))));if(o&&o.ciphertext){const e=i.from(t.pickleKey),s=await Object(l.b)(o,e,n);return Object(r.decodeBase64)(s)}return o},storeCrossSigningKeyCache:async function(n,s){if(!(s instanceof Uint8Array))throw new Error(`storeCrossSigningKeyCache expects Uint8Array, got ${s}`);const o=i.from(t.pickleKey),a=await Object(l.c)(Object(r.encodeBase64)(s),o,n);return e.doTxn("readwrite",[c.a.STORE_ACCOUNT],(t=>{e.storeSecretStorePrivateKey(t,n,a)}))}}}async function f(e,t,n){if(e.getUserId()===t)return a.a.log("Cross-signing: Self-verification done; requesting keys"),new Promise(((t,i)=>{const s=e,o=s.crypto.crossSigningInfo,c=new h(o.userId,{getCrossSigningKey:async e=>{a.a.debug("Cross-signing: requesting secret",e,n);const{promise:t}=s.requestSecret(`m.cross_signing.${e}`,[n]),i=await t,o=Object(r.decodeBase64)(i);return Uint8Array.from(o)}},o.getCacheCallbacks());c.keys=o.keys;const l=new Promise((e=>{setTimeout(e,d,new Error("Timeout"))})),u=(async()=>{if(!await s.crypto.getSessionBackupPrivateKey()){a.a.info("No cached backup key found. Requesting...");const e=s.requestSecret("m.megolm_backup.v1",[n]),t=await e.promise;a.a.info("Got key backup key, decoding...");const i=Object(r.decodeBase64)(t);a.a.info("Decoded backup key, storing..."),await s.crypto.storeSessionBackupPrivateKey(Uint8Array.from(i)),a.a.info("Backup key stored. Starting backup restore...");const o=await s.getKeyBackupVersion();s.restoreKeyBackupWithCache(void 0,void 0,o).then((()=>{a.a.info("Backup restored.")}))}})();return Promise.race([Promise.all([c.getCrossSigningKey("master"),c.getCrossSigningKey("self_signing"),c.getCrossSigningKey("user_signing"),u]),l]).then(t,i)})).catch((e=>{a.a.warn("Cross-signing: failure while requesting keys:",e)}))}}).call(this,n(14),n(53).Buffer)},function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"h",(function(){return r})),n.d(t,"e",(function(){return a})),n.d(t,"g",(function(){return c})),n.d(t,"f",(function(){return l})),n.d(t,"d",(function(){return d})),n.d(t,"c",(function(){return u})),n.d(t,"b",(function(){return h}));var i=n(144),s=n(130);function o(e,t){return function(n){return function(e,t,n){const o=Object.assign({},{code:e,reason:t},n);return new i.b({type:s.b.KeyVerificationCancel,content:o})}(e,t,n)}}const r=o("m.user","Cancelled by user"),a=o("m.timeout","Timed out"),c=o("m.unknown_method","Unknown method"),l=o("m.unexpected_message","Unexpected message"),d=o("m.key_mismatch","Key mismatch"),u=o("m.invalid_message","Invalid message");function h(e){const t=e.getContent();if(t){const{code:e,reason:n}=t;return{code:e,reason:n}}return{code:"Unknown error",reason:"m.unknown"}}},function(e,t,n){"use strict";var i;!function(e){e[e.LOADING=0]="LOADING",e[e.WELCOME=1]="WELCOME",e[e.LOGIN=2]="LOGIN",e[e.REGISTER=3]="REGISTER",e[e.FORGOT_PASSWORD=4]="FORGOT_PASSWORD",e[e.COMPLETE_SECURITY=5]="COMPLETE_SECURITY",e[e.E2E_SETUP=6]="E2E_SETUP",e[e.USE_CASE_SELECTION=7]="USE_CASE_SELECTION",e[e.LOGGED_IN=8]="LOGGED_IN",e[e.SOFT_LOGOUT=9]="SOFT_LOGOUT"}(i||(i={})),t.a=i},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return r}));var i=n(259),s=n.n(i);function o(e){if(!e)return"";const t=s.a.parse(e);return t&&"/"===t.path?t.host||"":e}function r(e){if(!e)return"";let t=e;e.startsWith("https://")||(t="https://"+e);return null===s.a.parse(t).hostname?e:t}},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i,s,o=n(122),r=n.n(o),a=n(120),c=n.n(a),l=n(149),d=n(1),u=n(123),h=n(121),m=n(254),p=n(135),g=n(146),v=n(124),f=n(136);!function(e){e.Passphrase="passphrase",e.RecoveryKey="recovery_key",e.SecretStorage="secret_storage"}(i||(i={})),function(e){e.PreFetch="prefetch",e.Fetch="fetch",e.LoadKeys="load_keys"}(s||(s={}));class b extends c.a.PureComponent{constructor(e){super(e),r()(this,"onCancel",(()=>{this.props.onFinished(!1)})),r()(this,"onDone",(()=>{this.props.onFinished(!0)})),r()(this,"onUseRecoveryKeyClick",(()=>{this.setState({forceRecoveryKey:!0})})),r()(this,"progressCallback",(e=>{this.setState({progress:e})})),r()(this,"onResetRecoveryClick",(()=>{this.props.onFinished(!1),Object(m.b)((async()=>{}),!0)})),r()(this,"onRecoveryKeyChange",(e=>{this.setState({recoveryKey:e.target.value,recoveryKeyValid:u.a.get().isValidRecoveryKey(e.target.value)})})),r()(this,"onPassPhraseNext",(async()=>{this.setState({loading:!0,restoreError:null,restoreType:i.Passphrase});try{const e=await u.a.get().restoreKeyBackupWithPassword(this.state.passPhrase,void 0,void 0,this.state.backupInfo,{progressCallback:this.progressCallback});if(this.props.keyCallback){const e=await u.a.get().keyBackupKeyFromPassword(this.state.passPhrase,this.state.backupInfo);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){d.a.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}})),r()(this,"onRecoveryKeyNext",(async()=>{if(this.state.recoveryKeyValid){this.setState({loading:!0,restoreError:null,restoreType:i.RecoveryKey});try{const e=await u.a.get().restoreKeyBackupWithRecoveryKey(this.state.recoveryKey,void 0,void 0,this.state.backupInfo,{progressCallback:this.progressCallback});if(this.props.keyCallback){const e=u.a.get().keyBackupKeyFromRecoveryKey(this.state.recoveryKey);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){d.a.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}})),r()(this,"onPassPhraseChange",(e=>{this.setState({passPhrase:e.target.value})})),this.state={backupInfo:null,backupKeyStored:null,loading:!1,loadError:null,restoreError:null,recoveryKey:"",recoverInfo:null,recoveryKeyValid:!1,forceRecoveryKey:!1,passPhrase:"",restoreType:null,progress:{stage:s.PreFetch}}}componentDidMount(){this.loadBackupStatus()}async restoreWithSecretStorage(){this.setState({loading:!0,restoreError:null,restoreType:i.SecretStorage});try{await Object(m.b)((async()=>{await u.a.get().restoreKeyBackupWithSecretStorage(this.state.backupInfo,void 0,void 0,{progressCallback:this.progressCallback})})),this.setState({loading:!1})}catch(e){d.a.log("Error restoring backup",e),this.setState({restoreError:e,loading:!1})}}async restoreWithCachedKey(e){if(!e)return!1;try{const t=await u.a.get().restoreKeyBackupWithCache(void 0,void 0,e,{progressCallback:this.progressCallback});return this.setState({recoverInfo:t}),!0}catch(e){return d.a.log("restoreWithCachedKey failed:",e),!1}}async loadBackupStatus(){this.setState({loading:!0,loadError:null});try{const e=u.a.get(),t=await e.getKeyBackupVersion(),n=await e.hasSecretStorageKey()&&await e.isKeyBackupKeyStored();this.setState({backupInfo:t,backupKeyStored:n});if(await this.restoreWithCachedKey(t))return d.a.log("RestoreKeyBackupDialog: found cached backup key"),void this.setState({loading:!1});if(n)return this.restoreWithSecretStorage();this.setState({loadError:null,loading:!1})}catch(e){d.a.log("Error loading backup status",e),this.setState({loadError:e,loading:!1})}}render(){const e=this.state.backupInfo&&this.state.backupInfo.auth_data&&this.state.backupInfo.auth_data.private_key_salt&&this.state.backupInfo.auth_data.private_key_iterations;let t,n;if(this.state.loading){let e;if(n=Object(h.a)("Restoring keys from backup"),this.state.progress.stage===s.Fetch)e=Object(h.a)("Fetching keys from server…");else if(this.state.progress.stage===s.LoadKeys){const{total:t,successes:n,failures:i}=this.state.progress;e=Object(h.a)("%(completed)s of %(total)s keys restored",{total:t,completed:n+i})}else this.state.progress.stage===s.PreFetch&&(e=Object(h.a)("Fetching keys from server…"));t=c.a.createElement("div",null,c.a.createElement("div",null,e),c.a.createElement(p.a,null))}else if(this.state.loadError)n=Object(h.a)("Error"),t=Object(h.a)("Unable to load backup status");else if(this.state.restoreError)this.state.restoreError.errcode===l.d.RESTORE_BACKUP_ERROR_BAD_KEY?this.state.restoreType===i.RecoveryKey?(n=Object(h.a)("Security Key mismatch"),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("Backup could not be decrypted with this Security Key: please verify that you entered the correct Security Key.")))):(n=Object(h.a)("Incorrect Security Phrase"),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("Backup could not be decrypted with this Security Phrase: please verify that you entered the correct Security Phrase.")))):(n=Object(h.a)("Error"),t=Object(h.a)("Unable to restore backup"));else if(null===this.state.backupInfo)n=Object(h.a)("Error"),t=Object(h.a)("No backup found!");else if(this.state.recoverInfo){let e;n=Object(h.a)("Keys restored"),this.state.recoverInfo.total>this.state.recoverInfo.imported&&(e=c.a.createElement("p",null,Object(h.a)("Failed to decrypt %(failedCount)s sessions!",{failedCount:this.state.recoverInfo.total-this.state.recoverInfo.imported}))),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("Successfully restored %(sessionCount)s keys",{sessionCount:this.state.recoverInfo.imported})),e,c.a.createElement(g.a,{primaryButton:Object(h.a)("OK"),onPrimaryButtonClick:this.onDone,hasCancel:!1,focus:!0}))}else if(e&&!this.state.forceRecoveryKey)n=Object(h.a)("Enter Security Phrase"),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("<b>Warning</b>: you should only set up key backup from a trusted computer.",{},{b:e=>c.a.createElement("b",null,e)})),c.a.createElement("p",null,Object(h.a)("Access your secure message history and set up secure messaging by entering your Security Phrase.")),c.a.createElement("form",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},c.a.createElement("input",{type:"password",className:"mx_RestoreKeyBackupDialog_passPhraseInput",onChange:this.onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0}),c.a.createElement(g.a,{primaryButton:Object(h.a)("Next"),onPrimaryButtonClick:this.onPassPhraseNext,primaryIsSubmit:!0,hasCancel:!0,onCancel:this.onCancel,focus:!1})),Object(h.a)("If you've forgotten your Security Phrase you can <button1>use your Security Key</button1> or <button2>set up new recovery options</button2>",{},{button1:e=>c.a.createElement(v.a,{kind:"link_inline",onClick:this.onUseRecoveryKeyClick},e),button2:e=>c.a.createElement(v.a,{kind:"link_inline",onClick:this.onResetRecoveryClick},e)}));else{let e;n=Object(h.a)("Enter Security Key"),e=0===this.state.recoveryKey.length?c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"}):this.state.recoveryKeyValid?c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👍 ",Object(h.a)("This looks like a valid Security Key!")):c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👎 ",Object(h.a)("Not a valid Security Key")),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(h.a)("<b>Warning</b>: you should only set up key backup from a trusted computer.",{},{b:e=>c.a.createElement("b",null,e)})),c.a.createElement("p",null,Object(h.a)("Access your secure message history and set up secure messaging by entering your Security Key.")),c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},c.a.createElement("input",{className:"mx_RestoreKeyBackupDialog_recoveryKeyInput",onChange:this.onRecoveryKeyChange,value:this.state.recoveryKey,autoFocus:!0}),e,c.a.createElement(g.a,{primaryButton:Object(h.a)("Next"),onPrimaryButtonClick:this.onRecoveryKeyNext,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid})),Object(h.a)("If you've forgotten your Security Key you can <button>set up new recovery options</button>",{},{button:e=>c.a.createElement(v.a,{kind:"link_inline",onClick:this.onResetRecoveryClick},e)}))}return c.a.createElement(f.a,{className:"mx_RestoreKeyBackupDialog",onFinished:this.props.onFinished,title:n},c.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_content"},t))}}r()(b,"defaultProps",{showSummary:!0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return g})),n.d(t,"e",(function(){return v})),n.d(t,"d",(function(){return f})),n.d(t,"b",(function(){return b})),n.d(t,"c",(function(){return y}));var i=n(375),s=n(1146),o=n.n(s),r=n(1147),a=n.n(r),c=n(137),l=n(168),d=n(125),u=n(129);let h;function m(e){let{scanner:t,parser:n,utils:i,token:s,name:o}=e;const{DOT:r,NUM:a,TLD:c,COLON:l,SYM:d,HYPHEN:u,UNDERSCORE:h,LOCALHOST:m,domain:p}=t.tokens,g=n.start,v=i.createTokenClass(o,{isLink:!0}),f=[p,c,m,d,h,u],b=[p,c,m,u],y=g.tt(s),S=y.tt(p);for(const e of f)y.tt(e,S),S.tt(e,S);const E=S.tt(r);for(const e of f)E.tt(e,S);const w=S.tt(l),_=w.tt(p);_.tt(r,w);for(const e of b)_.tt(e,_),_.tt(e,v);for(const e of b)w.tt(e,_);_.tt(l).tt(a,v)}function p(e,t){e.preventDefault(),d.a.dispatch({action:u.a.ViewUser,member:new c.User(t)})}!function(e){e.URL="url",e.UserId="userid",e.RoomAlias="roomalias"}(h||(h={}));const g="^(?:vector://|https?://)?(?:"+((window.location.host+window.location.pathname).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"|(?:www\\.)?(?:riot|vector)\\.im/(?:app|beta|staging|develop)/|(?:app|beta|staging|develop)\\.element\\.io/)(#.*)");const v={events:function(e,t){switch(t){case h.URL:try{const t=Object(l.j)(e);if(null!=t&&t.userId)return{click:function(e){p(e,t.userId)}};{const t=Object(l.l)(e);if(t!==e)return{click:function(e){e.preventDefault(),window.location.hash=t}}}}catch(e){}break;case h.UserId:return{click:function(t){var n;const i=null===(n=Object(l.j)(e))||void 0===n?void 0:n.userId;i&&p(t,i)}};case h.RoomAlias:return{click:function(t){var n;const i=null===(n=Object(l.j)(e))||void 0===n?void 0:n.roomIdOrAlias;var s;i&&(s=i,t.preventDefault(),d.a.dispatch({action:u.a.ViewRoom,room_alias:s,metricsTrigger:"Timeline",metricsViaKeyboard:!1}))}}}},formatHref:function(e,t){switch(t){case h.RoomAlias:case h.UserId:}return Object(l.k)(e)},attributes:{rel:"noreferrer noopener"},ignoreTags:["pre","code"],className:"linkified",target:function(e,t){if(t===h.URL)try{return Object(l.l)(e)!==e||decodeURIComponent(e).match(g)?null:"_blank"}catch(e){}return null}};Object(i.registerPlugin)(h.RoomAlias,(e=>{let{scanner:t,parser:n,utils:i}=e;m({scanner:t,parser:n,utils:i,token:t.tokens.POUND,name:h.RoomAlias})})),Object(i.registerPlugin)(h.UserId,(e=>{let{scanner:t,parser:n,utils:i}=e;m({scanner:t,parser:n,utils:i,token:t.tokens.AT,name:h.UserId})})),Object(i.registerCustomProtocol)("matrix",!0);const f=i,b=o.a,y=a.a},,function(e,t,n){"use strict";n.d(t,"c",(function(){return l})),n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(130),s=n(207),o=n(123),r=n(377),a=n(242),c=n(126);function l(e){if(e.getSender()===o.a.get().credentials.userId)return!1;switch(e.getType()){case i.b.RoomMember:case i.b.RoomThirdPartyInvite:case i.b.CallAnswer:case i.b.CallHangup:case i.b.RoomCanonicalAlias:case i.b.RoomServerAcl:case s.a.name:case s.a.altName:return!1}return!e.isRedacted()&&Object(a.c)(e,!1)}function d(e){if(c.b.getValue("feature_sliding_sync"))return!1;for(const t of[e,...e.getThreads()])if(u(t))return!0;return!1}function u(e){var t;if(!e||0===e.timeline.length)return!1;const n=o.a.get().getUserId();if((null===(t=e.timeline[e.timeline.length-1])||void 0===t?void 0:t.getSender())===n)return!1;const i=e.getEventReadUpTo(n);for(let t=e.timeline.length-1;t>=0;--t){const n=e.timeline[t];if(n.getId()==i)return!1;if(!Object(r.a)(n)&&l(n))return!0}return!0}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(130),s=n(126);function o(e,t){const n=t?e=>t[e]:t=>s.b.getValue(t,e.getRoomId());if(e.isRedacted()&&!n("showRedactions")&&!e.getThread())return!0;if(e.isRelation(i.h.Replace))return!0;const o=function(e){const t={isMemberEvent:e.getType()===i.b.RoomMember};if(!t.isMemberEvent)return t;const n=e.getContent(),s=e.getPrevContent(),o=n.membership!==s.membership;t.isJoin=o&&"join"===n.membership,t.isPart=o&&"leave"===n.membership&&e.getStateKey()===e.getSender();const r=!o&&"join"===n.membership;return t.isDisplaynameChange=r&&n.displayname!==s.displayname,t.isAvatarChange=r&&n.avatar_url!==s.avatar_url,t}(e);if(o.isMemberEvent){if((o.isJoin||o.isPart)&&!n("showJoinLeaves"))return!0;if(o.isAvatarChange&&!n("showAvatarChanges"))return!0;if(o.isDisplaynameChange&&!n("showDisplaynameChanges"))return!0}return!1}},,,,function(e,t,n){"use strict";n.d(t,"c",(function(){return d})),n.d(t,"d",(function(){return u})),n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return p}));var i=n(122),s=n.n(i),o=n(1198),r=n(1199);function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const l=new Map,d=new Map,u=e=>l.get(g(e)),h=["people","people","control","nature","foods","places","activity","objects","symbols","flags"],m={people:[],nature:[],foods:[],places:[],activity:[],objects:[],symbols:[],flags:[]},p=o.map((e=>{var t,n;const i=null!==(t=r[e.hexcode])&&void 0!==t?t:[e.label.toLowerCase().replace(/\W+/g,"_")],s=c(c({},e),{},{shortcodes:"string"==typeof i?[i]:i}),o=null!==(n=h[s.group])&&void 0!==n?n:(a=s.unicode,1===Array.from(a).length&&a>="🇦"&&a<="🇿"?"symbols":null);var a;return m.hasOwnProperty(o)&&m[o].push(s),l.set(g(s.unicode),s),s.emoticon&&(Array.isArray(s.emoticon)?s.emoticon.forEach((e=>d.set(e,s))):d.set(s.emoticon,s)),s}));function g(e){return e.replace(/[\uFE00-\uFE0F]$/,"")}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(120);const s=n.n(i).a.createContext({isCard:!1})},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i extends Error{constructor(e){super(e)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return b}));var i=n(122),s=n.n(i),o=n(423),r=n(137),a=n(120),c=n.n(a),l=n(121),d=n(123),u=n(128),h=n(582),m=n(145),p=n(583);function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class f extends c.a.Component{render(){return c.a.createElement(p.a,{onFinished:this.props.onFinished,title:Object(l.a)("Confirm Removal"),description:Object(l.a)("Are you sure you wish to remove (delete) this event? Note that if you delete a room name or topic change, it could undo the change."),placeholder:Object(l.a)("Reason (optional)"),focus:!0,button:Object(l.a)("Remove")})}}function b(e){let{mxEvent:t,onCloseDialog:n=(()=>{})}=e;const i=t.getId();if(!i)throw new Error("cannot redact event without ID");const s=t.getRoomId();if(!s)throw new Error(`cannot redact event ${t.getId()} without room ID`);u.b.createDialog(f,{onFinished:async(e,a)=>{if(!e)return;const c=d.a.get(),p={};if(Object(h.a)(t)){const e=c.canSupport.get(o.a.RelationBasedRedactions);e&&e!==o.b.Unsupported&&(p.with_relations=[r.RelationType.Reference])}try{null==n||n(),await c.redactEvent(s,i,void 0,v(v({},a?{reason:a}:{}),p))}catch(e){const t=e.errcode||e.statusCode;void 0!==t&&u.b.createDialog(m.a,{title:Object(l.a)("Error"),description:Object(l.a)("You cannot delete this message. (%(code)s)",{code:t})})}}},"mx_Dialog_confirmredact")}},,function(e,t,n){"use strict";var i=n(122),s=n.n(i),o=n(17),r=n.n(o);class a extends r.a{constructor(){super(),s()(this,"roomWidgetEcho",void 0),this.roomWidgetEcho={}}getEchoedRoomWidgets(e,t){const n=[],i=Object.assign({},this.roomWidgetEcho[e]);for(const e of t){const t=e.getStateKey();i[t]&&0===Object.keys(i[t]).length||n.push(e),delete i[t]}return n}roomHasPendingWidgetsOfType(e,t,n){const i=Object.assign({},this.roomWidgetEcho[e]);for(const e of t){delete i[e.getStateKey()]}return void 0===n?Object.keys(i).length>0:Object.values(i).some((e=>n.matches(e.type)))}roomHasPendingWidgets(e,t){return this.roomHasPendingWidgetsOfType(e,t)}setRoomWidgetEcho(e,t,n){void 0===this.roomWidgetEcho[e]&&(this.roomWidgetEcho[e]={}),this.roomWidgetEcho[e][t]=n,this.emit("update",e,t)}removeRoomWidgetEcho(e,t){delete this.roomWidgetEcho[e][t],0===Object.keys(this.roomWidgetEcho[e]).length&&delete this.roomWidgetEcho[e],this.emit("update",e,t)}}let c=null;c||(c=new a),t.a=c},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(1),c=n(126),l=n(337),d=n(215),u=n(153),h=n(143);const m=function(){if(c.b.getValue("debug_scroll_panel")){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];a.a.log.call(console,"ScrollPanel debuglog:",...t)}};class p extends r.a.Component{constructor(e){var t,n;super(e),t=this,s()(this,"pendingFillRequests",{b:null,f:null}),s()(this,"itemlist",Object(o.createRef)()),s()(this,"unmounted",!1),s()(this,"scrollTimeout",void 0),s()(this,"isFilling",void 0),s()(this,"isFillingDueToPropsUpdate",!1),s()(this,"fillRequestWhileRunning",void 0),s()(this,"pendingFillDueToPropsUpdate",void 0),s()(this,"scrollState",void 0),s()(this,"preventShrinkingState",void 0),s()(this,"unfillDebouncer",void 0),s()(this,"bottomGrowth",void 0),s()(this,"minListHeight",void 0),s()(this,"heightUpdateInProgress",void 0),s()(this,"divScroll",void 0),s()(this,"onScroll",(e=>{var t,n;this.props.resizeNotifier&&this.props.resizeNotifier.isResizing||(m("onScroll called past resize gate; scroll node top:",this.getScrollNode().scrollTop),this.scrollTimeout.restart(),this.saveScrollState(),this.updatePreventShrinking(),null===(t=(n=this.props).onScroll)||void 0===t||t.call(n,e),this.checkFillState())})),s()(this,"onResize",(()=>{m("onResize called"),this.checkScroll(),this.preventShrinkingState&&this.preventShrinking()})),s()(this,"checkScroll",(function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];t.unmounted||(t.restoreSavedScrollState(),t.checkFillState(0,e))})),s()(this,"isAtBottom",(()=>{const e=this.getScrollNode();return e.scrollHeight-(e.scrollTop+e.clientHeight)<=1})),s()(this,"checkFillState",(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t.unmounted)return;const i=0===e,s=t.getScrollNode();if(i){if(t.isFilling&&!t.isFillingDueToPropsUpdate)return m("isFilling: not entering while request is ongoing, marking for a subsequent request"),t.fillRequestWhileRunning=!0,void(t.pendingFillDueToPropsUpdate=n);m("isFilling: setting"),t.isFilling=!0,t.isFillingDueToPropsUpdate=n}const o=t.itemlist.current,r=o&&o.firstElementChild,c=r&&r.offsetTop,l=[];if((!r||s.scrollTop-c<s.clientHeight)&&l.push(t.maybeFill(e,!0)),s.scrollHeight-s.scrollTop<2*s.clientHeight&&l.push(t.maybeFill(e,!1)),l.length)try{await Promise.all(l)}catch(e){a.a.error(e)}if(i&&(m("isFilling: clearing"),t.isFilling=!1,t.isFillingDueToPropsUpdate=!1),t.fillRequestWhileRunning){const e=t.pendingFillDueToPropsUpdate;t.fillRequestWhileRunning=!1,t.pendingFillDueToPropsUpdate=!1,t.checkFillState(0,e)}})),s()(this,"getScrollState",(()=>this.scrollState)),s()(this,"resetScrollState",(()=>{this.scrollState={stuckAtBottom:this.props.startAtBottom},this.bottomGrowth=0,this.minListHeight=0,this.scrollTimeout=new l.a(100),this.heightUpdateInProgress=!1})),s()(this,"scrollToTop",(()=>{this.getScrollNode().scrollTop=0,this.saveScrollState()})),s()(this,"scrollToBottom",(()=>{const e=this.getScrollNode();e.scrollTop=e.scrollHeight,this.saveScrollState()})),s()(this,"scrollRelative",(e=>{const t=this.getScrollNode(),n=e*t.clientHeight*.9;t.scrollBy(0,n),this.saveScrollState()})),s()(this,"handleScrollKey",(e=>{switch(Object(u.a)().getRoomAction(e)){case h.h.ScrollUp:this.scrollRelative(-1);break;case h.h.ScrollDown:this.scrollRelative(1);break;case h.h.JumpToFirstMessage:this.scrollToTop();break;case h.h.JumpToLatestMessage:this.scrollToBottom()}})),s()(this,"scrollToToken",((e,t,n)=>{t=t||0,n=n||0,this.scrollState={stuckAtBottom:!1,trackedScrollToken:e};const i=this.getTrackedNode(),s=this.getScrollNode();i&&(m("scrollToken: setting scrollTop",{offsetBase:n,pixelOffset:t,offsetTop:i.offsetTop}),s.scrollTop=i.offsetTop-s.clientHeight*n+t,this.saveScrollState())})),s()(this,"collectScroll",(e=>{this.divScroll=e})),s()(this,"preventShrinking",(()=>{const e=this.itemlist.current,t=e&&e.children;if(!e)return;let n;for(let e=t.length-1;e>=0;e--){const i=t[e];if(i.dataset.scrollTokens){n=i;break}}if(!n)return;this.clearPreventShrinking();const i=e.clientHeight-(n.offsetTop+n.clientHeight);this.preventShrinkingState={offsetFromBottom:i,offsetNode:n},m("prevent shrinking, last tile ",i,"px from bottom")})),s()(this,"clearPreventShrinking",(()=>{const e=this.itemlist.current,t=e&&e.parentElement;t&&(t.style.paddingBottom=null),this.preventShrinkingState=null,m("prevent shrinking cleared")})),s()(this,"updatePreventShrinking",(()=>{if(this.preventShrinkingState){const e=this.getScrollNode(),t=this.scrollState,n=this.itemlist.current,{offsetNode:i,offsetFromBottom:s}=this.preventShrinkingState,o=n.parentElement;let r=!i.parentElement;if(!r&&!t.stuckAtBottom){r=e.scrollHeight-(e.scrollTop+e.clientHeight)>=200}if(!r){const e=s-(n.clientHeight-(i.offsetTop+i.clientHeight));e>0?(o.style.paddingBottom=`${e}px`,m("update prevent shrinking ",e,"px from bottom")):e<0&&(r=!0)}r&&this.clearPreventShrinking()}})),null===(n=this.props.resizeNotifier)||void 0===n||n.on("middlePanelResizedNoisy",this.onResize),this.resetScrollState()}componentDidMount(){this.checkScroll()}componentDidUpdate(){this.checkScroll(!0),this.updatePreventShrinking()}componentWillUnmount(){var e;this.unmounted=!0,null===(e=this.props.resizeNotifier)||void 0===e||e.removeListener("middlePanelResizedNoisy",this.onResize)}getExcessHeight(e){const t=this.getScrollNode(),n=this.getMessagesHeight(),i=n-this.getListHeight(),s=t.scrollTop+i;return e?s-t.clientHeight-6e3:n-(s+2*t.clientHeight)-6e3}checkUnfillState(e){let t=this.getExcessHeight(e);if(t<=0)return;const n=t,i=this.itemlist.current.children;let s,o=null;for(let n=0;n<i.length&&(s=i[e?n:i.length-1-n],t-=s.clientHeight,!(s.clientHeight>t));n++)s.dataset.scrollTokens&&(o=s.dataset.scrollTokens.split(",")[0]);o&&(this.unfillDebouncer&&clearTimeout(this.unfillDebouncer),this.unfillDebouncer=window.setTimeout((()=>{var t,i;this.unfillDebouncer=null,m("unfilling now",{backwards:e,origExcessHeight:n}),null===(t=(i=this.props).onUnfillRequest)||void 0===t||t.call(i,e,o)}),200))}maybeFill(e,t){const n=t?"b":"f";return this.pendingFillRequests[n]?(m("Already a fill in progress - not starting another; direction=",n),Promise.resolve()):(m("starting fill; direction=",n),this.pendingFillRequests[n]=!0,new Promise((e=>window.setTimeout(e,1))).then((()=>this.props.onFillRequest(t))).finally((()=>{this.pendingFillRequests[n]=!1})).then((i=>{if(!this.unmounted)return this.checkUnfillState(!t),m("fill complete; hasMoreResults=",i,"direction=",n),i?this.checkFillState(e+1):void 0})))}saveScrollState(){if(this.props.stickyBottom&&this.isAtBottom())return this.scrollState={stuckAtBottom:!0},void m("saved stuckAtBottom state");const e=this.getScrollNode(),t=e.scrollHeight-(e.scrollTop+e.clientHeight),n=this.itemlist.current.children;let i=null;for(let e=n.length-1;e>=0;--e){var s;const o=n[e];if(null!==(s=o.dataset)&&void 0!==s&&s.scrollTokens&&(i=o,this.topFromBottom(i)>t))break}if(!i)return void m("unable to save scroll state: found no children in the viewport");const o=i.dataset.scrollTokens.split(",")[0];m("saving anchored scroll state to message",o);const r=this.topFromBottom(i);this.scrollState={stuckAtBottom:!1,trackedNode:i,trackedScrollToken:o,bottomOffset:r,pixelOffset:r-t}}async restoreSavedScrollState(){const e=this.scrollState;if(e.stuckAtBottom){const e=this.getScrollNode();e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight)}else if(e.trackedScrollToken){const t=this.itemlist.current,n=this.getTrackedNode();if(n){const i=this.topFromBottom(n),s=i-e.bottomOffset;this.bottomGrowth+=s,e.bottomOffset=i;const o=`${this.getListHeight()}px`;t.style.height!==o&&(t.style.height=o),m("balancing height because messages below viewport grew by",s)}}if(this.heightUpdateInProgress)m("not updating height because request already in progress");else{this.heightUpdateInProgress=!0;try{await this.updateHeight()}finally{this.heightUpdateInProgress=!1}}}async updateHeight(){if(this.scrollTimeout.isRunning()?(m("updateHeight waiting for scrolling to end ... "),await this.scrollTimeout.finished(),m("updateHeight actually running now")):m("updateHeight running without delay"),this.unmounted)return void m("updateHeight: abort due to unmount");const e=this.getScrollNode(),t=this.itemlist.current,n=this.getMessagesHeight();n<e.clientHeight?this.minListHeight=e.clientHeight:this.minListHeight=400*Math.ceil(n/400),this.bottomGrowth=0;const i=`${this.getListHeight()}px`,s=this.scrollState;if(s.stuckAtBottom)t.style.height!==i&&(t.style.height=i),e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight),m("updateHeight to",i);else if(s.trackedScrollToken){const n=this.getTrackedNode();if(n){const s=n.offsetTop;t.style.height!==i&&(t.style.height=i);const o=n.offsetTop-s;e.scrollBy(0,o),m("updateHeight to",{newHeight:i,topDiff:o})}}}getTrackedNode(){const e=this.scrollState,t=e.trackedNode;if(null==t||!t.parentElement){let t;const i=this.itemlist.current.children,s=e.trackedScrollToken;for(let e=i.length-1;e>=0;--e){var n;const o=i[e];if(s&&null!==(n=o.dataset.scrollTokens)&&void 0!==n&&n.split(",").includes(s)){t=o;break}}t&&m("had to find tracked node again for token:",e.trackedScrollToken),e.trackedNode=t}if(e.trackedNode)return e.trackedNode;m("No node with token:",e.trackedScrollToken)}getListHeight(){return this.bottomGrowth+this.minListHeight}getMessagesHeight(){const e=this.itemlist.current,t=e.lastElementChild;return(t?t.offsetTop+t.clientHeight:0)-(e.firstElementChild?e.firstElementChild.offsetTop:0)+36}topFromBottom(e){return this.itemlist.current.clientHeight-e.offsetTop}getScrollNode(){if(this.unmounted)throw new Error("ScrollPanel.getScrollNode called when unmounted");if(!this.divScroll)throw new Error("ScrollPanel.getScrollNode called before AutoHideScrollbar ref collected");return this.divScroll}render(){return r.a.createElement(d.a,{wrappedRef:this.collectScroll,onScroll:this.onScroll,className:`mx_ScrollPanel ${this.props.className}`,style:this.props.style},this.props.fixedChildren,r.a.createElement("div",{className:"mx_RoomView_messageListWrapper"},r.a.createElement("ol",{ref:this.itemlist,className:"mx_RoomView_MessageList","aria-live":"polite"},this.props.children)))}}s()(p,"defaultProps",{stickyBottom:!0,startAtBottom:!0,onFillRequest:function(e){return Promise.resolve(!1)},onUnfillRequest:function(e,t){},onScroll:function(){}})},function(e,t,n){"use strict";n.d(t,"c",(function(){return g})),n.d(t,"b",(function(){return v})),n.d(t,"g",(function(){return f})),n.d(t,"a",(function(){return b})),n.d(t,"d",(function(){return y})),n.d(t,"e",(function(){return S})),n.d(t,"f",(function(){return E})),n.d(t,"h",(function(){return w}));var i=n(572),s=n(746),o=n.n(s),r=n(767),a=n.n(r),c=n(150),l=n.n(c),d=n(994),u=n(168),h=n(126),m=n(132),p=n(256);function g(e){let{forceHTML:t=!1,useMarkdown:n=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!n)return a()(f(e)).replace(/\n/g,"<br/>");const i=function(e){return e.parts.reduce(((e,t)=>{switch(t.type){case p.b.Newline:return e+"\n";case p.b.Plain:case p.b.Emoji:case p.b.Command:case p.b.PillCandidate:case p.b.AtRoomPill:return e+t.text;case p.b.RoomPill:return e+`[${t.resourceId.replace(/[[\\\]]/g,(e=>"\\"+e))}](${Object(u.g)(t.resourceId)})`;case p.b.UserPill:return e+`[${t.text.replace(/[[\\\]]/g,(e=>"\\"+e))}](${Object(u.g)(t.resourceId)})`;case p.b.CustomEmoji:return e+`<img data-mx-emoticon height="18" src="${encodeURI(t.resourceId)}"`+` title=":${l.a.escape(t.text)}:" alt=":${l.a.escape(t.text)}:">`}}),"")}(e);return v(i,{forceHTML:t})}function v(e){let{forceHTML:t=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=e;if(h.b.getValue("feature_latex_maths")){const t=["display","inline"],n={tex:{display:"(^)\\$\\$(([^$]|\\\\\\$)+?)\\$\\$$",inline:"(^|\\s|[.,!?:;])(?!\\\\)\\$(?!\\s)(([^$\\n]|\\\\\\$)*([^\\\\\\s\\$]|\\\\\\$)(?:\\\\\\$)?)\\$"},latex:{display:"(^)\\\\\\[(?!\\\\\\])(.*?)\\\\\\]$",inline:"(^|[^\\\\])\\\\\\((?!\\\\\\))(.*?)\\\\\\)"}};["tex","latex"].forEach((function(s){t.forEach((function(t){var o,r,a;const c=(null===(o=m.b.get("latex_maths_delims"))||void 0===o||null===(r=o[t])||void 0===r||null===(a=r.pattern)||void 0===a?void 0:a[s])||n[s][t];e=e.replace(RegExp(c,"gms"),(function(e,n,s){const o=Object(i.encode)(s);switch(t){case"display":return`${n}<div data-mx-maths="${o}">\n\n</div>\n\n`;case"inline":return`${n}<span data-mx-maths="${o}"></span>`}}))}))})),e=e.replace(/(.)<div/g,(function(e,t){return`${t}\n<div`}))}const s=new d.a(e);if(!s.isPlainText()||t){const e=o.a.load(s.toHTML(),{_useHtmlParser2:!0,decodeEntities:!1});if(h.b.getValue("feature_latex_maths")){const t=new d.a(n),i=o.a.load(t.toHTML(),{_useHtmlParser2:!0,decodeEntities:!1});i("code").each((function(t){e("code").eq(t).text(i("code").eq(t).text())})),e("div, span").each((function(t,n){const i=e(n).attr("data-mx-maths");i&&e(n).html(`<code>${i}</code>`)}))}return e.html()}if(e.indexOf("\\")>-1)return s.toPlaintext()}function f(e){return e.parts.reduce(((e,t)=>{switch(t.type){case p.b.Newline:return e+"\n";case p.b.Plain:case p.b.Emoji:case p.b.Command:case p.b.PillCandidate:case p.b.AtRoomPill:return e+t.text;case p.b.RoomPill:return e+`${t.resourceId}`;case p.b.UserPill:return e+`${t.text}`;case p.b.CustomEmoji:return e+`:${t.text}:`}}),"")}function b(e){var t,n;const i=y(e,"/me ",!1),s=(null===(t=e.parts[0])||void 0===t||null===(n=t.text)||void 0===n?void 0:n.length)>4||e.parts.length>1;return i&&s}function y(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=e.parts[0];let s=(null==i?void 0:i.text)||"";return n||(t=t.toLowerCase(),s=s.toLowerCase()),i&&(i.type===p.b.Plain||i.type===p.b.Command)&&s.startsWith(t)}function S(e){return E(e,"/me ")}function E(e,t){return(e=e.clone()).removeText({index:0,offset:0},t.length),e}function w(e){const{parts:t}=e;if(t.length){const n=t[0];n.type===p.b.Plain&&n.text.startsWith("\\/")&&(e=e.clone()).removeText({index:0,offset:0},1)}return e}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(122),s=n.n(i),o=n(139);class r{constructor(e){let{commandRegex:t,forcedCommandRegex:n,renderingType:i}=e;if(s()(this,"commandRegex",void 0),s()(this,"forcedCommandRegex",void 0),s()(this,"renderingType",o.a.Room),t){if(!t.global)throw new Error("commandRegex must have global flag set");this.commandRegex=t}if(n){if(!n.global)throw new Error("forcedCommandRegex must have global flag set");this.forcedCommandRegex=n}i&&(this.renderingType=i)}destroy(){}getCurrentCommand(e,t){let n,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=this.commandRegex;if(i&&this.shouldForceComplete()&&(s=this.forcedCommandRegex||/\S+/g),!s)return{};for(s.lastIndex=0;null!==(n=s.exec(e));){const e=n.index,i=e+n[0].length;if(t.start<=i&&t.end>=e)return{command:n,range:{start:e,end:i}}}return{command:null,range:{start:-1,end:-1}}}shouldForceComplete(){return!1}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return m})),n.d(t,"a",(function(){return p}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l);const u=["title","subtitle","description","className","aria-selected"],h=["title","subtitle","description","className","children","aria-selected"],m=Object(a.forwardRef)(((e,t)=>{const{title:n,subtitle:i,description:o,className:a,"aria-selected":l}=e,h=r()(e,u);return c.a.createElement("div",s()({},h,{className:d()("mx_Autocomplete_Completion_block",a),role:"option","aria-selected":l,ref:t}),c.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},n),c.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},i),c.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},o))})),p=Object(a.forwardRef)(((e,t)=>{const{title:n,subtitle:i,description:o,className:a,children:l,"aria-selected":u}=e,m=r()(e,h);return c.a.createElement("div",s()({},m,{className:d()("mx_Autocomplete_Completion_pill",a),role:"option","aria-selected":u,ref:t}),l,c.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},n),c.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},i),c.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},o))}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return g})),n.d(t,"b",(function(){return v})),n.d(t,"c",(function(){return f}));var i=n(1509),s=n.n(i),o=n(1518),r=n.n(o),a=n(1),c=n(123),l=n(156),d=n(121),u=n(606),h=n(126),m=n(132);async function p(){var e,t,n;let i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const r=i.progressCallback||(()=>{});let m;r(Object(d.a)("Collecting app version information"));try{var p;m=await(null===(p=l.a.get())||void 0===p?void 0:p.getAppVersion())}catch(e){}const g=null!==(e=null===(t=window.navigator)||void 0===t?void 0:t.userAgent)&&void 0!==e?e:"UNKNOWN";let v="UNKNOWN";try{v=String(window.matchMedia("(display-mode: standalone)").matches)}catch(e){}let f="UNKNOWN";try{f=String(window.matchMedia("(pointer: coarse)").matches)}catch(e){}const b=c.a.get();a.a.log("Sending bug report.");const y=new FormData;if(y.append("text",i.userText||"User did not supply any additional text."),y.append("app",i.customApp||"element-web"),y.append("version",null!==(n=m)&&void 0!==n?n:"UNKNOWN"),y.append("user_agent",g),y.append("installed_pwa",v),y.append("touch_input",f),i.customFields)for(const e in i.customFields)y.append(e,i.customFields[e]);if(b&&(y.append("user_id",b.credentials.userId),y.append("device_id",b.deviceId),b.isCryptoEnabled()&&b.crypto)){const e=[`ed25519:${b.getDeviceEd25519Key()}`];b.getDeviceCurve25519Key&&e.push(`curve25519:${b.getDeviceCurve25519Key()}`),y.append("device_keys",e.join(", ")),y.append("cross_signing_key",b.getCrossSigningId());const t=b.crypto.crossSigningInfo,n=b.crypto.secretStorage;y.append("cross_signing_ready",String(await b.isCrossSigningReady())),y.append("cross_signing_supported_by_hs",String(await b.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"))),y.append("cross_signing_key",t.getId()),y.append("cross_signing_privkey_in_secret_storage",String(!!await t.isStoredInSecretStorage(n)));const i=b.getCrossSigningCacheCallbacks();y.append("cross_signing_master_privkey_cached",String(!(!i||!await i.getCrossSigningKeyCache("master")))),y.append("cross_signing_self_signing_privkey_cached",String(!(!i||!await i.getCrossSigningKeyCache("self_signing")))),y.append("cross_signing_user_signing_privkey_cached",String(!(!i||!await i.getCrossSigningKeyCache("user_signing")))),y.append("secret_storage_ready",String(await b.isSecretStorageReady())),y.append("secret_storage_key_in_account",String(!!await n.hasKey())),y.append("session_backup_key_in_secret_storage",String(!!await b.isKeyBackupKeyStored()));const s=await b.crypto.getSessionBackupPrivateKey();y.append("session_backup_key_cached",String(!!s)),y.append("session_backup_key_well_formed",String(s instanceof Uint8Array))}if(i.labels)for(const e of i.labels)y.append("label",e);const S=h.b.getFeatureSettingNames().filter((e=>h.b.getValue(e)));if(S.length&&y.append("enabled_labs",S.join(", ")),h.b.getValue("lowBandwidth")&&y.append("lowBandwidth","enabled"),navigator.storage&&navigator.storage.persisted)try{y.append("storageManager_persisted",String(await navigator.storage.persisted()))}catch(e){}else if(document.hasStorageAccess)try{y.append("storageManager_persisted",String(await document.hasStorageAccess()))}catch(e){}if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate();y.append("storageManager_quota",String(e.quota)),y.append("storageManager_usage",String(e.usage)),e.usageDetails&&Object.keys(e.usageDetails).forEach((t=>{y.append(`storageManager_usage_${t}`,String(e.usageDetails[t]))}))}catch(e){}if(window.Modernizr){const e=Object.keys(window.Modernizr).filter((e=>!1===window.Modernizr[e]));e.length>0&&y.append("modernizr_missing_features",e.join(", "))}if(y.append("mx_local_settings",localStorage.getItem("mx_local_settings")),i.sendLogs){r(Object(d.a)("Collecting logs"));const e=await u.c();for(const t of e){let e=(new TextEncoder).encode(t.lines);o&&(e=s.a.gzip(e)),y.append("compressed-log",new Blob([e]),t.id)}}return y}async function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)throw new Error("No bug report endpoint has been set.");const n=t.progressCallback||(()=>{}),i=await p(t);return n(Object(d.a)("Uploading logs")),b(e,i,n)}async function v(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=e.progressCallback||(()=>{}),n=await p(e,!1);t(Object(d.a)("Downloading logs"));let i="";const s=new r.a;let o=0;for(const[e,t]of n.entries())"compressed-log"===e?await new Promise((e=>{const n=new FileReader;n.addEventListener("loadend",(t=>{s.append(`log-${o++}.log`,(new TextDecoder).decode(t.target.result)),e()})),n.readAsArrayBuffer(t)})):i+=`${e} = ${t}\n`;s.append("issue.txt",i);const a=document.createElement("a");a.href=`data:application/octet-stream;base64,${btoa(function(e){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return t}(s.out))}`,a.download="rageshake.tar",document.body.appendChild(a),a.click(),document.body.removeChild(a)}async function f(e,t,n){var i;let s,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};try{var a;s=await(null===(a=l.a.get())||void 0===a?void 0:a.getAppVersion())}catch(e){}const d=new FormData;d.append("label",t),d.append("text",n),d.append("can_contact",o?"yes":"no"),d.append("app","element-web"),d.append("version",s||"UNKNOWN"),d.append("platform",l.a.get().getHumanReadableName()),d.append("user_id",null===(i=c.a.get())||void 0===i?void 0:i.getUserId());for(const e in r)d.append(e,JSON.stringify(r[e]));await b(m.b.get().bug_report_endpoint_url,d,(()=>{}))}function b(e,t,n){return new Promise(((i,s)=>{const o=new XMLHttpRequest;o.open("POST",e),o.responseType="json",o.timeout=3e5,o.onreadystatechange=function(){if(o.readyState===XMLHttpRequest.LOADING)n(Object(d.a)("Waiting for response from server"));else if(o.readyState===XMLHttpRequest.DONE){if(o.status<200||o.status>=400)return void s(new Error(`HTTP ${o.status}`));i(o.response.report_url||"")}},o.send(t)}))}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c}));var i=n(120),s=n.n(i),o=n(196),r=n(121);function a(e,t,n,i){let o=e?n[e]:void 0;void 0===o&&(o=n[""]);const a=e=>t?s.a.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},e):e;return o.includes("<a>")?Object(r.a)(o,{},Object.assign({a:a},i)):Object(r.a)(o,{},i)}function c(e){if(e instanceof o.f&&"M_RESOURCE_LIMIT_EXCEEDED"===e.errcode){const t=a(e.data.limit_type,e.data.admin_contact,{monthly_active_user:Object(r.c)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(r.c)("This homeserver has been blocked by its administrator."),"":Object(r.c)("This homeserver has exceeded one of its resource limits.")}),n=a(e.data.limit_type,e.data.admin_contact,{"":Object(r.c)("Please <a>contact your service administrator</a> to continue using the service.")});return s.a.createElement("div",null,s.a.createElement("div",null,t),s.a.createElement("div",null,n))}return s.a.createElement("div",null,Object(r.a)("Unable to connect to Homeserver. Retrying…"))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var i=n(122),s=n.n(i),o=n(1),r=n(130),a=n(221),c=n(123),l=n(164),d=n(185),u=n(854),h=n(309);class m{constructor(){s()(this,"virtualToNativeRoomIdCache",new Map)}static sharedInstance(){return void 0===window.mxVoipUserMapper&&(window.mxVoipUserMapper=new m),window.mxVoipUserMapper}async userToVirtualUser(e){const t=await d.b.instance.sipVirtualLookup(e);return 0!==t.length&&t[0].fields.lookup_success?t[0].userid:null}async getVirtualUserForRoom(e){const t=l.a.shared().getUserIdForRoomId(e);if(!t)return null;const n=await this.userToVirtualUser(t);return n||null}async getOrCreateVirtualRoomForRoom(e){const t=await this.getVirtualUserForRoom(e);if(!t)return null;const n=await Object(a.d)(c.a.get(),t,e);return c.a.get().setRoomAccountData(n,u.a,{native_room:e}),this.virtualToNativeRoomIdCache.set(n,e),n}async getVirtualRoomForRoom(e){const t=await this.getVirtualUserForRoom(e);if(t)return Object(h.a)(c.a.get(),t)}nativeRoomForVirtualRoom(e){const t=this.virtualToNativeRoomIdCache.get(e);if(t)return o.a.log("Returning native room ID "+t+" for virtual room ID "+e+" from cache"),t;const n=c.a.get().getRoom(e);if(!n)return null;const i=n.getAccountData(u.a);if(!i||!i.getContent())return null;const s=i.getContent().native_room,r=c.a.get().getRoom(s);return r&&"join"===r.getMyMembership()?s:null}isVirtualRoom(e){if(this.nativeRoomForVirtualRoom(e.roomId))return!0;if(this.virtualToNativeRoomIdCache.has(e.roomId))return!0;const t=e.currentState.getStateEvents(r.b.RoomCreate,"");if(!t||!t.getContent())return!1;if(t.getSender()!==c.a.get().getUserId())return!1;const n=t.getContent()[u.a];return Boolean(n)}async onNewInvitedRoom(e){if(!d.b.instance.getSupportsVirtualRooms())return;const t=e.getDMInviter();t||o.a.error("Could not find DM inviter for room id: "+e.roomId),o.a.log(`Checking virtual-ness of room ID ${e.roomId}, invited by ${t}`);const n=await d.b.instance.sipNativeLookup(t);if(0!==n.length&&n[0].fields.is_virtual){const t=n[0].userid,i=Object(h.a)(c.a.get(),t);i&&(c.a.get().setRoomAccountData(e.roomId,u.a,{native_room:i.roomId}),c.a.get().joinRoom(e.roomId),this.virtualToNativeRoomIdCache.set(e.roomId,i.roomId))}}}},function(e,t,n){"use strict";n.d(t,"d",(function(){return c})),n.d(t,"c",(function(){return l})),n.d(t,"e",(function(){return d})),n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return h}));var i=n(130),s=n(18),o=n(141),r=n(126);const a=["notificationsEnabled","notificationBodyEnabled","audioNotificationsEnabled"];function c(e){return`${i.c.name}.${e}`}async function l(e){if(e.isGuest())return;const t=c(e.deviceId);if(!e.getAccountData(t)){const n=!a.some((e=>r.b.getValue(e)));await e.setAccountData(t,{is_silenced:n})}}function d(e){var t,n;const i=c(e.deviceId),s=e.getAccountData(i);return null!==(t=null==s||null===(n=s.getContent())||void 0===n?void 0:n.is_silenced)&&void 0!==t&&t}async function u(e,t){var n,i,a;const c=e.getLiveTimeline().getEvents(),l=null===(n=e.lastThread)||void 0===n?void 0:n.events,d=null==c?void 0:c[(null==c?void 0:c.length)-1],u=null==l?void 0:l[(null==l?void 0:l.length)-1],h=(null!==(i=null==d?void 0:d.getTs())&&void 0!==i?i:0)>(null!==(a=null==u?void 0:u.getTs())&&void 0!==a?a:0)?d:u;try{if(h){const n=r.b.getValue("sendReadReceipts",e.roomId)?s.b.Read:s.b.ReadPrivate;return await t.sendReadReceipt(h,n,!0)}return{}}finally{e.setUnreadNotificationCount(o.b.Highlight,0),e.setUnreadNotificationCount(o.b.Total,0);for(const t of e.getThreads())e.setThreadUnreadNotificationCount(t.id,o.b.Highlight,0),e.setThreadUnreadNotificationCount(t.id,o.b.Total,0)}}function h(e){const t=e.getRooms().reduce(((t,n)=>{if(n.getUnreadNotificationCount()>0){const i=u(n,e);t.push(i)}return t}),[]);return Promise.all(t)}},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o}));const i=new Map;function s(e,t){i.set(e,t)}function o(e){return i.get(e)}},function(e,t,n){"use strict";async function i(e,t,n){const i=new Promise((i=>{const s=window.setTimeout(i,n,t);e.then((()=>{clearTimeout(s)}))}));return Promise.race([e,i])}async function s(e,t,n){let i;for(let s=0;s<t;s++)try{return await e()}catch(e){if(n&&!n(e))throw e;i=e}throw i}n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return v})),n.d(t,"b",(function(){return f}));var i=n(122),s=n.n(i),o=n(130),r=n(1),a=n(149),c=n(236),l=n(128),d=n(121),u=n(145),h=n(179),m=n(135);function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}async function v(e,t){const n=e.getRoom(t);return n||new Promise((n=>{const i=s=>{s.roomId===t&&(n(s),e.off(a.b.Room,i))};e.on(a.b.Room,i)}))}async function f(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],p=arguments.length>5&&void 0!==arguments[5]&&arguments[5],f=arguments.length>6?arguments[6]:void 0;const b=e.client;let y;f||(y=l.b.createDialog(m.a,void 0,"mx_Dialog_spinner"));let S=[];i&&(S=[...e.getMembersWithMembership("join"),...e.getMembersWithMembership("invite")].map((e=>e.userId)).filter((e=>e!==b.getUserId())));let E=[];a&&(E=Array.from(h.a.instance.getKnownParents(e.roomId)).map((e=>b.getRoom(e))).filter((e=>null==e?void 0:e.currentState.maySendStateEvent(o.b.SpaceChild,b.getUserId()))));const w={roomUpgraded:!1,roomSynced:!p&&!i&&void 0,inviteUsersProgress:i?0:void 0,inviteUsersTotal:S.length,updateSpacesProgress:a?0:void 0,updateSpacesTotal:E.length};let _;null==f||f(w);try{({replacement_room:_}=await b.upgradeRoom(e.roomId,t))}catch(e){if(!s)throw e;throw r.a.error(e),l.b.createDialog(u.a,{title:Object(d.a)("Error upgrading room"),description:Object(d.a)("Double check that your server supports the room version chosen and try again.")}),e}if(w.roomUpgraded=!0,null==f||f(w),(p||i)&&(await v(e.client,_),w.roomSynced=!0,null==f||f(w)),S.length>0&&await Object(c.b)(_,S,!1,(()=>{w.inviteUsersProgress++,null==f||f(w)})),E.length>0)try{for(const t of E){const n=t.currentState.getStateEvents(o.b.SpaceChild,e.roomId);await b.sendStateEvent(t.roomId,o.b.SpaceChild,g(g({},(null==n?void 0:n.getContent())||{}),{},{via:[b.getDomain()]}),_),await b.sendStateEvent(t.roomId,o.b.SpaceChild,{},e.roomId),w.updateSpacesProgress++,null==f||f(w)}}catch(e){r.a.warn("Failed to update parent spaces during room upgrade",e)}return null===(n=y)||void 0===n||n.close(),_}},function(e,t,n){"use strict";var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l),u=n(148);const h=["checked","disabled","title","tooltip","onChange"];t.a=e=>{let{checked:t,disabled:n=!1,title:i,tooltip:o,onChange:a}=e,l=r()(e,h);const m=d()({mx_ToggleSwitch:!0,mx_ToggleSwitch_on:t,mx_ToggleSwitch_enabled:!n});return c.a.createElement(u.a,s()({},l,{className:m,onClick:()=>{n||a(!t)},role:"switch","aria-checked":t,"aria-disabled":n,title:i,tooltip:o}),c.a.createElement("div",{className:"mx_ToggleSwitch_ball"}))}},function(e,t,n){"use strict";n.d(t,"b",(function(){return j})),n.d(t,"a",(function(){return D})),n.d(t,"f",(function(){return M})),n.d(t,"g",(function(){return A})),n.d(t,"e",(function(){return L})),n.d(t,"c",(function(){return U}));var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(16),c=n(130),l=n(1),d=n(121),u=n(136),h=n(311),m=n(341),p=n(179),g=n(165),v=n(234),f=n(124),b=n(215),y=n(164),S=n(168),E=n(181),w=n(133),_=n(448),C=n(506),O=n(322),I=n(305),R=n(801);const k=44,x=15,T=24,j=e=>{let{room:t,checked:n,onChange:i}=e;return s.a.createElement("label",{className:"mx_AddExistingToSpace_entry"},null!=t&&t.isSpaceRoom()?s.a.createElement(g.a,{room:t,height:32,width:32}):s.a.createElement(O.a,{room:t,avatarSize:32}),s.a.createElement("span",{className:"mx_AddExistingToSpace_entry_name"},t.name),s.a.createElement(E.b,{onChange:i?e=>i(e.currentTarget.checked):null,checked:n,disabled:!i}))},P=function(e,t){let{scrollTop:n,height:i}=e,s=0;for(var o=arguments.length,r=new Array(o>2?o-2:0),a=2;a<o;a++)r[a-2]=arguments[a];r.forEach((e=>{s+=T+x+e*k}));const c=n,l=c+i,d=s+x,u=d+t*k,h=Math.max(c,d),m=Math.min(l,u);return{scrollTop:Math.max(0,n-d),height:Math.max(0,m-h)}},D=e=>{let{space:t,footerPrompt:o,emptySelectionButton:r,filterPlaceholder:c,roomsRenderer:u,dmsRenderer:h,spacesRenderer:g,onFinished:v}=e;const E=Object(i.useContext)(w.a),O=Object(i.useMemo)((()=>E.getVisibleRooms().filter((e=>"join"===e.getMyMembership()))),[E]),R=Object(i.useRef)(),[k,x]=Object(i.useState)({scrollTop:0,height:600}),[T,j]=Object(i.useState)(new Set),[D,N]=Object(i.useState)(null),[M,A]=Object(i.useState)(null),[L,U]=Object(i.useState)(""),F=L.toLowerCase().trim(),B=Object(i.useMemo)((()=>new Set(p.a.instance.getChildSpaces(t.roomId))),[t]),V=Object(i.useMemo)((()=>new Set(p.a.instance.getChildRooms(t.roomId))),[t]),[K,$,H]=Object(i.useMemo)((()=>{let e=O;if(F){e=new I.a(O,{keys:["name"],funcs:[e=>[e.getCanonicalAlias(),...e.getAltAliases()].filter(Boolean)],shouldMatchWordsOnly:!1}).match(F)}const n=t.getJoinRule();return Object(_.b)(e).reduce(((e,i)=>(i.isSpaceRoom()?i===t||B.has(i)||e[0].push(i):V.has(i)||(y.a.shared().getUserIdForRoomId(i.roomId)?"public"!==n&&e[2].push(i):e[1].push(i)),e)),[[],[],[]])}),[O,t,F,V,B]),W=async()=>{let e;A(null),N(0);for(const n of T){const i=Object(S.b)(n);try{await p.a.instance.addRoomToSpace(t,n.roomId,i).catch((async e=>{if("M_LIMIT_EXCEEDED"===e.errcode)return await Object(a.N)(e.data.retry_after_ms),void await p.a.instance.addRoomToSpace(t,n.roomId,i);throw e})),N((e=>e+1))}catch(t){l.a.error("Failed to add rooms to space",t),e=t;break}}e?A(e):v(!0)},q=null!==D;let G;if(M)G=s.a.createElement(s.a.Fragment,null,s.a.createElement("img",{src:n(404).default,height:"24",width:"24",alt:""}),s.a.createElement("span",{className:"mx_AddExistingToSpaceDialog_error"},s.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_errorHeading"},Object(d.a)("Not all selected were added")),s.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_errorCaption"},Object(d.a)("Try again"))),s.a.createElement(f.a,{className:"mx_AddExistingToSpaceDialog_retryButton",onClick:W},Object(d.a)("Retry")));else if(q)G=s.a.createElement("span",null,s.a.createElement(C.a,{value:D,max:T.size}),s.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_progressText"},Object(d.a)("Adding rooms... (%(progress)s out of %(count)s)",{count:T.size,progress:D})));else{let e=r;(!e||T.size>0)&&(e=s.a.createElement(f.a,{kind:"primary",disabled:T.size<1,onClick:W},Object(d.a)("Add"))),G=s.a.createElement(s.a.Fragment,null,s.a.createElement("span",null,o),e)}const z=q||M?null:(e,t)=>{e?T.add(t):T.delete(t),j(new Set(T))},J=!g||h||u?0:K.length,Y=u?$.length:0,Q=h?H.length:0;let X=!0;(J>0||Y>0||Q>0)&&(X=!1);const Z=P(k,Y),ee=P(k,J,Y),te=P(k,Q,J,Y);return s.a.createElement("div",{className:"mx_AddExistingToSpace"},s.a.createElement(m.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:c,onSearch:U,autoFocus:!0}),s.a.createElement(b.a,{className:"mx_AddExistingToSpace_content",onScroll:()=>{var e;const t=null===(e=R.current)||void 0===e?void 0:e.containerRef.current;x({scrollTop:t.scrollTop,height:t.clientHeight})},wrappedRef:e=>{x({scrollTop:e.scrollTop,height:e.clientHeight})},ref:R},$.length>0&&u?u($,T,Z,z):void 0,K.length>0&&g?g(K,T,ee,z):null,H.length>0&&h?h(H,T,te,z):null,X?s.a.createElement("span",{className:"mx_AddExistingToSpace_noResults"},Object(d.a)("No results")):void 0),s.a.createElement("div",{className:"mx_AddExistingToSpace_footer"},G))},N=e=>(t,n,i,o)=>{let{scrollTop:r,height:a}=i;return s.a.createElement("div",{className:"mx_AddExistingToSpace_section"},s.a.createElement("h3",null,Object(d.a)(e)),s.a.createElement(R.a,{itemHeight:k,items:t,scrollTop:r,height:a,renderItem:e=>s.a.createElement(j,{key:e.roomId,room:e,checked:n.has(e),onChange:o?t=>{o(t,e)}:null})}))},M=N(Object(d.c)("Rooms")),A=N(Object(d.c)("Spaces")),L=N(Object(d.c)("Direct Messages")),U=e=>{let{title:t,space:n,value:o,onChange:a}=e;const l=Object(i.useMemo)((()=>[n,...p.a.instance.getChildSpaces(n.roomId).filter((e=>e.currentState.maySendStateEvent(c.b.SpaceChild,e.client.credentials.userId)))]),[n]);let u;return u=l.length>1?s.a.createElement(h.a,{id:"mx_SpaceSelectDropdown",className:"mx_SpaceSelectDropdown",onOptionChange:e=>{a(l.find((t=>t.roomId===e))||n)},value:o.roomId,label:Object(d.a)("Space selection")},l.map((e=>{const t=r()({mx_SubspaceSelector_dropdownOptionActive:e===o});return s.a.createElement("div",{key:e.roomId,className:t},s.a.createElement(g.a,{room:e,width:24,height:24}),e.name||Object(v.c)(e)||e.roomId)}))):s.a.createElement("div",{className:"mx_SubspaceSelector_onlySpace"},n.name||Object(v.c)(n)||n.roomId),s.a.createElement("div",{className:"mx_SubspaceSelector"},s.a.createElement(g.a,{room:o,height:40,width:40}),s.a.createElement("div",null,s.a.createElement("h1",null,t),u))};t.d=e=>{let{space:t,onCreateRoomClick:n,onAddSubspaceClick:o,onFinished:r}=e;const[a,c]=Object(i.useState)(t);return s.a.createElement(u.a,{title:s.a.createElement(U,{title:Object(d.a)("Add existing rooms"),space:t,value:a,onChange:c}),className:"mx_AddExistingToSpaceDialog",contentId:"mx_AddExistingToSpace",onFinished:r,fixedWidth:!1},s.a.createElement(w.a.Provider,{value:t.client},s.a.createElement(D,{space:t,onFinished:r,footerPrompt:s.a.createElement(s.a.Fragment,null,s.a.createElement("div",null,Object(d.a)("Want to add a new room instead?")),s.a.createElement(f.a,{kind:"link",onClick:e=>{n(e),r()}},Object(d.a)("Create a new room"))),filterPlaceholder:Object(d.a)("Search for rooms"),roomsRenderer:M,spacesRenderer:()=>s.a.createElement("div",{className:"mx_AddExistingToSpace_section"},s.a.createElement("h3",null,Object(d.a)("Spaces")),s.a.createElement(f.a,{kind:"link",onClick:()=>{o(),r()}},Object(d.a)("Adding spaces has moved."))),dmsRenderer:L})))}},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return r}));var i,s=n(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm-.12 3.504c.84-.06 1.59.57 1.68 1.426v.24l-.48 6c-.045.555-.51.975-1.064.975h-.09a1.06 1.06 0 01-.975-.975l-.48-6a1.527 1.527 0 011.41-1.666zm.12 10.26a1.32 1.32 0 110 2.64 1.32 1.32 0 010-2.64z",fill:"#e53935"})))}t.default="img/element-icons/warning-badge.18dd59f.svg"},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i,s,o,r,a=n(120);function c(){return c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},c.apply(this,arguments)}function l(e){return a.createElement("svg",c({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 21.799 21.799",role:"presentation","aria-hidden":!0},e),i||(i=a.createElement("path",{d:"M19.189 3.086a1 1 0 00-1.58 1.226v.001l.001.001.014.018.063.087c.057.08.14.202.243.364.206.323.484.8.763 1.397.56 1.2 1.106 2.853 1.106 4.72 0 1.866-.546 3.519-1.106 4.72a12.36 12.36 0 01-.763 1.396 8.777 8.777 0 01-.306.45l-.014.019v.001l-.001.001a1 1 0 001.58 1.226l-.746-.58.746.58.002-.002.002-.004.009-.01.026-.036.09-.123c.074-.105.178-.256.3-.448.244-.384.566-.936.887-1.625.64-1.37 1.294-3.318 1.294-5.565 0-2.248-.654-4.195-1.294-5.566a14.368 14.368 0 00-.887-1.625 10.746 10.746 0 00-.39-.571l-.026-.035-.009-.011-.002-.004-.002-.001-.79.613z",fill:"currentColor"})),s||(s=a.createElement("path",{d:"M16.59 6.686a1 1 0 00-1.582 1.224l.003.005.025.034a5.67 5.67 0 01.458.802c.26.558.506 1.31.506 2.149 0 .838-.246 1.59-.506 2.148a5.66 5.66 0 01-.458.802l-.025.035-.003.004a1 1 0 001.581 1.225L15.8 14.5l.79.614.001-.003.002-.002.006-.008.017-.022.051-.07a7.7 7.7 0 00.64-1.114c.339-.729.693-1.776.693-2.995 0-1.22-.354-2.267-.694-2.995a7.689 7.689 0 00-.639-1.114 3.763 3.763 0 00-.051-.07l-.017-.023-.006-.007-.002-.003v-.001s-.002-.001-.79.613zM2.61 18.713a1 1 0 001.58-1.226v-.001l-.001-.001-.014-.018a8.711 8.711 0 01-.306-.45c-.206-.324-.484-.8-.763-1.398C2.546 14.42 2 12.766 2 10.9c0-1.866.546-3.519 1.106-4.72a12.36 12.36 0 01.762-1.396 8.721 8.721 0 01.307-.45l.014-.019v-.001l.001-.001a1 1 0 00-1.58-1.226l.746.58-.746-.58-.002.002-.002.004-.009.01-.026.036-.09.123c-.074.105-.178.256-.3.448-.244.384-.566.936-.887 1.625C.654 6.704 0 8.652 0 10.899c0 2.248.654 4.195 1.294 5.566.32.689.643 1.241.887 1.625a10.737 10.737 0 00.39.571l.026.035.009.011.002.004.002.001.79-.613z",fill:"currentColor"})),o||(o=a.createElement("path",{d:"M5.21 15.113a1 1 0 001.58-1.224l-.002-.005a3.866 3.866 0 01-.132-.195 5.669 5.669 0 01-.35-.641c-.261-.558-.507-1.31-.507-2.149 0-.838.246-1.59.506-2.148a5.68 5.68 0 01.458-.802 1.9 1.9 0 01.025-.035l.003-.004A1 1 0 005.21 6.685l.789.614-.79-.614-.001.003-.002.002-.006.008-.017.022a5.853 5.853 0 00-.216.316 7.679 7.679 0 00-.474.869c-.34.728-.694 1.775-.694 2.994 0 1.22.354 2.267.694 2.995a7.69 7.69 0 00.64 1.114c.02.03.037.053.05.07l.017.023.006.007.002.003v.001s.002.001.79-.613z",fill:"currentColor"})),r||(r=a.createElement("circle",{cx:11,cy:10.899,r:2,fill:"currentColor"})))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(122),s=n.n(i);class o{constructor(e,t){this.fn=e,this.onMarkCallback=t,s()(this,"marked",!1)}reset(){this.marked=!1}mark(){var e;this.marked||null===(e=this.onMarkCallback)||void 0===e||e.call(this),this.marked=!0}trigger(){this.marked&&(this.reset(),this.fn())}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(120);const s=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const[t,n]=Object(i.useState)(e);return[t,()=>{n(!t)},n]}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a}));const i={w:800,h:600},s={w:324,h:324},o={w:Math.ceil(182.25),h:324};let r;function a(e,t,n){const a=t.w/t.h,c=a<1,l=e===r.Large?i:c?o:s;if(!t.w||!t.h)return l;const d={w:Math.min(l.w,t.w),h:n?Math.min(l.h,t.h,n):Math.min(l.h,t.h)};return d.h*a<d.w?{w:Math.floor(d.h*a),h:d.h}:{w:d.w,h:Math.floor(d.w/a)}}!function(e){e.Normal="normal",e.Large="large"}(r||(r={}))},function(e,t,n){"use strict";var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(654);const d=["heading","description","children"];t.a=e=>{let{heading:t,description:n,children:i}=e,o=r()(e,d);return c.a.createElement("div",s()({},o,{className:"mx_SettingsSubsection"}),"string"==typeof t?c.a.createElement(l.a,{heading:t}):c.a.createElement(c.a.Fragment,null,t),!!n&&c.a.createElement("div",{className:"mx_SettingsSubsection_description"},n),c.a.createElement("div",{className:"mx_SettingsSubsection_content"},i))}},,,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return Ce})),n.d(t,"a",(function(){return Oe})),n.d(t,"c",(function(){return Ie}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(141),c=n(340),l=n(121),d=n(908),u=n(984),h=n(127),m=n.n(h),p=n(123),g=n(140),v=n(160),f=n(124),b=n(910),y=n(390),S=n(294);function E(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function w(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?E(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):E(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class _ extends r.a.Component{constructor(e){super(e),s()(this,"avatarUpload",Object(o.createRef)()),s()(this,"uploadAvatar",(()=>{this.avatarUpload.current.click()})),s()(this,"removeAvatar",(()=>{this.avatarUpload.current.value="",this.setState({avatarUrl:null,avatarFile:null,profileFieldsTouched:w(w({},this.state.profileFieldsTouched),{},{avatar:!0})})})),s()(this,"isSaveEnabled",(()=>Boolean(Object.values(this.state.profileFieldsTouched).length))),s()(this,"cancelProfileChanges",(async e=>{e.stopPropagation(),e.preventDefault(),this.isSaveEnabled()&&this.setState({profileFieldsTouched:{},displayName:this.state.originalDisplayName,topic:this.state.originalTopic,avatarUrl:this.state.originalAvatarUrl,avatarFile:null})})),s()(this,"saveProfile",(async e=>{if(e.stopPropagation(),e.preventDefault(),!this.isSaveEnabled())return;this.setState({profileFieldsTouched:{}});const t=p.a.get(),n={},i=this.state.displayName.trim();if(this.state.originalDisplayName!==this.state.displayName&&(await t.setRoomName(this.props.roomId,i),n.originalDisplayName=i,n.displayName=i),this.state.avatarFile){const{content_uri:e}=await t.uploadContent(this.state.avatarFile);await t.sendStateEvent(this.props.roomId,"m.room.avatar",{url:e},""),n.avatarUrl=Object(v.b)(e).getSquareThumbnailHttp(96),n.originalAvatarUrl=n.avatarUrl,n.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.sendStateEvent(this.props.roomId,"m.room.avatar",{},"");if(this.state.originalTopic!==this.state.topic){const e=Object(y.b)(this.state.topic,{forceHTML:!1});await t.setRoomTopic(this.props.roomId,this.state.topic,e),n.originalTopic=this.state.topic}this.setState(n)})),s()(this,"onDisplayNameChanged",(e=>{this.setState({displayName:e.target.value}),this.state.originalDisplayName===e.target.value?this.setState({profileFieldsTouched:w(w({},this.state.profileFieldsTouched),{},{name:!1})}):this.setState({profileFieldsTouched:w(w({},this.state.profileFieldsTouched),{},{name:!0})})})),s()(this,"onTopicChanged",(e=>{this.setState({topic:e.target.value}),this.state.originalTopic===e.target.value?this.setState({profileFieldsTouched:w(w({},this.state.profileFieldsTouched),{},{topic:!1})}):this.setState({profileFieldsTouched:w(w({},this.state.profileFieldsTouched),{},{topic:!0})})})),s()(this,"onAvatarChanged",(e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,profileFieldsTouched:w(w({},this.state.profileFieldsTouched),{},{avatar:!1})});const t=e.target.files[0],n=new FileReader;n.onload=e=>{this.setState({avatarUrl:String(e.target.result),avatarFile:t,profileFieldsTouched:w(w({},this.state.profileFieldsTouched),{},{avatar:!0})})},n.readAsDataURL(t)}));const t=p.a.get(),n=t.getRoom(e.roomId);if(!n)throw new Error(`Expected a room for ID: ${e.roomId}`);const i=n.currentState.getStateEvents("m.room.avatar","");let r=i&&i.getContent()?i.getContent().url:null;r&&(r=Object(v.b)(r).getSquareThumbnailHttp(96));const a=n.currentState.getStateEvents("m.room.topic",""),c=a&&a.getContent()?a.getContent().topic:"",l=n.currentState.getStateEvents("m.room.name",""),d=l&&l.getContent()?l.getContent().name:"";this.state={originalDisplayName:d,displayName:d,originalAvatarUrl:r,avatarUrl:r,avatarFile:null,originalTopic:c,topic:c,profileFieldsTouched:{},canSetName:n.currentState.maySendStateEvent("m.room.name",t.getUserId()),canSetTopic:n.currentState.maySendStateEvent("m.room.topic",t.getUserId()),canSetAvatar:n.currentState.maySendStateEvent("m.room.avatar",t.getUserId())}}render(){let e;return(this.state.canSetName||this.state.canSetTopic||this.state.canSetAvatar)&&(e=r.a.createElement("div",{className:"mx_ProfileSettings_buttons"},r.a.createElement(f.a,{onClick:this.cancelProfileChanges,kind:"link",disabled:!this.isSaveEnabled()},Object(l.a)("Cancel")),r.a.createElement(f.a,{onClick:this.saveProfile,kind:"primary",disabled:!this.isSaveEnabled()},Object(l.a)("Save")))),r.a.createElement("form",{onSubmit:this.saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings"},r.a.createElement("input",{type:"file",ref:this.avatarUpload,className:"mx_ProfileSettings_avatarUpload",onClick:S.a,onChange:this.onAvatarChanged,accept:"image/*"}),r.a.createElement("div",{className:"mx_ProfileSettings_profile"},r.a.createElement("div",{className:"mx_ProfileSettings_profile_controls"},r.a.createElement(g.a,{label:Object(l.a)("Room Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this.onDisplayNameChanged,disabled:!this.state.canSetName}),r.a.createElement(g.a,{className:m()("mx_ProfileSettings_profile_controls_topic","mx_ProfileSettings_profile_controls_topic--room"),id:"profileTopic",label:Object(l.a)("Room Topic"),disabled:!this.state.canSetTopic,type:"text",value:this.state.topic,autoComplete:"off",onChange:this.onTopicChanged,element:"textarea"})),r.a.createElement(b.a,{avatarUrl:this.state.avatarUrl,avatarName:this.state.displayName||this.props.roomId,avatarAltText:Object(l.a)("Room avatar"),uploadAvatar:this.state.canSetAvatar?this.uploadAvatar:void 0,removeAvatar:this.state.canSetAvatar?this.removeAvatar:void 0})),e)}}var C=n(125),O=n(133),I=n(126),R=n(158),k=n(129),x=n(138),T=n(222),j=n(348);class P extends r.a.Component{constructor(){super(...arguments),s()(this,"onClickUserSettings",(e=>{e.preventDefault(),e.stopPropagation(),C.a.fire(k.a.ViewUserSettings)}))}render(){const e=this.props.room.roomId,t=p.a.get().isRoomEncrypted(e);let n,i;if(t)n=Object(l.a)("In encrypted rooms, like this one, URL previews are disabled by default to ensure that your homeserver (where the previews are generated) cannot gather information about links you see in this room.");else{if(n=I.b.getValueAt(x.a.ACCOUNT,"urlPreviewsEnabled")?Object(l.a)("You have <a>enabled</a> URL previews by default.",{},{a:e=>r.a.createElement(f.a,{kind:"link_inline",onClick:this.onClickUserSettings},e)}):Object(l.a)("You have <a>disabled</a> URL previews by default.",{},{a:e=>r.a.createElement(f.a,{kind:"link_inline",onClick:this.onClickUserSettings},e)}),I.b.canSetValue("urlPreviewsEnabled",e,x.a.ROOM))i=r.a.createElement("label",null,r.a.createElement(T.a,{name:"urlPreviewsEnabled",level:x.a.ROOM,roomId:e,isExplicit:!0}));else{let t=Object(l.c)("URL previews are enabled by default for participants in this room.");I.b.getValueAt(x.a.ROOM,"urlPreviewsEnabled",e,!0)||(t=Object(l.c)("URL previews are disabled by default for participants in this room.")),i=r.a.createElement("label",null,Object(l.a)(t))}}const s=r.a.createElement(T.a,{name:t?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled",level:x.a.ROOM_ACCOUNT,roomId:e}),o=r.a.createElement(r.a.Fragment,null,r.a.createElement("p",null,Object(l.a)("When someone puts a URL in their message, a URL preview can be shown to give more information about that link such as the title, description, and an image from the website.")),r.a.createElement("p",null,n));return r.a.createElement(j.a,{legend:Object(l.a)("URL Previews"),description:o},i,r.a.createElement("label",null,s))}}var D=n(985),N=n(162);class M extends r.a.Component{constructor(e,t){super(e,t),s()(this,"context",void 0),s()(this,"onLeaveClick",(e=>{C.a.dispatch({action:"leave_room",room_id:this.props.roomId}),N.b.trackInteraction("WebRoomSettingsLeaveButton",e)})),this.state={isRoomPublished:!1}}render(){var e;const t=this.context,n=t.getRoom(this.props.roomId),i=null==n?void 0:n.currentState.mayClientSendStateEvent("m.room.canonical_alias",t),s=null!==(e=null==n?void 0:n.currentState.getStateEvents("m.room.canonical_alias",""))&&void 0!==e?e:void 0,o=n&&I.b.getValue(R.b.URLPreviews)?r.a.createElement(P,{room:n}):null;let a;return"join"===(null==n?void 0:n.getMyMembership())&&(a=r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Leave room")),r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement(f.a,{kind:"danger",onClick:this.onLeaveClick},Object(l.a)("Leave room"))))),r.a.createElement("div",{className:"mx_SettingsTab mx_GeneralRoomSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("General")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralRoomSettingsTab_profileSection"},r.a.createElement(_,{roomId:this.props.roomId})),r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Room Addresses")),r.a.createElement(D.a,{roomId:this.props.roomId,canSetCanonicalAlias:i,canSetAliases:!0,canonicalAliasEvent:s}),r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Other")),o,a)}}s()(M,"contextType",O.a);var A=n(161),L=n(152),U=n(130),F=n(1),B=n(640),V=n(240),K=n(128),$=n(157),H=n(342),W=n(221),q=n(626),G=n(999),z=n(145),J=n(131),Y=n.n(J),Q=n(134),X=n.n(Q);const Z=["children","className"];var ee=e=>{let{children:t,className:n}=e,i=X()(e,Z);return r.a.createElement("a",Y()({target:"_blank",rel:"noreferrer noopener"},i,{className:m()("mx_ExternalLink",n)}),t,r.a.createElement("i",{className:"mx_ExternalLink_icon"}))};class te extends r.a.Component{constructor(e,t){var n;super(e,t),s()(this,"context",void 0),s()(this,"onStateEvent",(e=>{[U.b.RoomJoinRules,U.b.RoomGuestAccess,U.b.RoomHistoryVisibility,U.b.RoomEncryption].includes(e.getType())&&this.forceUpdate()})),s()(this,"onEncryptionChange",(async()=>{var e;if((null===(e=this.context.getRoom(this.props.roomId))||void 0===e?void 0:e.getJoinRule())===A.c.Public){const e=K.b.createDialog($.a,{title:Object(l.a)("Are you sure you want to add encryption to this public room?"),description:r.a.createElement("div",null,r.a.createElement("p",null," ",Object(l.a)("<b>It's not recommended to add encryption to public rooms.</b> Anyone can find and join public rooms, so anyone can read messages in them. You'll get none of the benefits of encryption, and you won't be able to turn it off later. Encrypting messages in a public room will make receiving and sending messages slower.",void 0,{b:e=>r.a.createElement("b",null,e)})," "),r.a.createElement("p",null," ",Object(l.a)("To avoid these issues, create a <a>new encrypted room</a> for the conversation you plan to have.",void 0,{a:t=>r.a.createElement(f.a,{kind:"link_inline",onClick:()=>{e.close(),this.createNewRoom(!1,!0)}}," ",t," ")})," "))}),{finished:t}=e,[n]=await t;if(!n)return}K.b.createDialog($.a,{title:Object(l.a)("Enable encryption?"),description:Object(l.a)("Once enabled, encryption for a room cannot be disabled. Messages sent in an encrypted room cannot be seen by the server, only by the participants of the room. Enabling encryption may prevent many bots and bridges from working correctly. <a>Learn more about encryption.</a>",{},{a:e=>r.a.createElement(ee,{href:"https://element.io/help#encryption"},e)}),onFinished:e=>{if(!e)return void this.setState({encrypted:!1});const t=this.state.encrypted;this.setState({encrypted:!0}),this.context.sendStateEvent(this.props.roomId,U.b.RoomEncryption,{algorithm:"m.megolm.v1.aes-sha2"}).catch((e=>{F.a.error(e),this.setState({encrypted:t})}))}})})),s()(this,"onGuestAccessChange",(e=>{const t=e?A.a.CanJoin:A.a.Forbidden,n=this.state.guestAccess;n!==t&&(this.setState({guestAccess:t}),this.context.sendStateEvent(this.props.roomId,U.b.RoomGuestAccess,{guest_access:t},"").catch((e=>{F.a.error(e),this.setState({guestAccess:n})})))})),s()(this,"createNewRoom",(async(e,t)=>{const n=K.b.createDialog(q.a,{defaultPublic:e,defaultEncrypted:t});N.b.trackInteraction("WebRoomSettingsSecurityTabCreateNewRoomButton");const[i,s]=await n.finished;return i&&await Object(W.b)(s),i})),s()(this,"onHistoryRadioToggle",(e=>{const t=this.state.history;t!==e&&(this.setState({history:e}),this.context.sendStateEvent(this.props.roomId,U.b.RoomHistoryVisibility,{history_visibility:e},"").catch((e=>{F.a.error(e),this.setState({history:t})})))})),s()(this,"updateBlacklistDevicesFlag",(e=>{var t;null===(t=this.context.getRoom(this.props.roomId))||void 0===t||t.setBlacklistUnverifiedDevices(e)})),s()(this,"onJoinRuleChangeError",(e=>{var t;K.b.createDialog(z.a,{title:Object(l.a)("Failed to update the join rules"),description:null!==(t=e.message)&&void 0!==t?t:Object(l.a)("Unknown failure")})})),s()(this,"onBeforeJoinRuleChange",(async e=>{if(this.state.encrypted&&e===A.c.Public){const e=K.b.createDialog($.a,{title:Object(l.a)("Are you sure you want to make this encrypted room public?"),description:r.a.createElement("div",null,r.a.createElement("p",null," ",Object(l.a)("<b>It's not recommended to make encrypted rooms public.</b> It will mean anyone can find and join the room, so anyone can read messages. You'll get none of the benefits of encryption. Encrypting messages in a public room will make receiving and sending messages slower.",void 0,{b:e=>r.a.createElement("b",null,e)})," "),r.a.createElement("p",null," ",Object(l.a)("To avoid these issues, create a <a>new public room</a> for the conversation you plan to have.",void 0,{a:t=>r.a.createElement(f.a,{kind:"link_inline",onClick:()=>{e.close(),this.createNewRoom(!0,!1)}}," ",t," ")})," "))}),{finished:t}=e,[n]=await t;if(!n)return!1}return!0})),s()(this,"toggleAdvancedSection",(()=>{this.setState({showAdvancedSection:!this.state.showAdvancedSection})}));const i=null===(n=t.getRoom(this.props.roomId))||void 0===n?void 0:n.currentState;this.state={guestAccess:this.pullContentPropertyFromEvent(null==i?void 0:i.getStateEvents(U.b.RoomGuestAccess,""),"guest_access",A.a.Forbidden),history:this.pullContentPropertyFromEvent(null==i?void 0:i.getStateEvents(U.b.RoomHistoryVisibility,""),"history_visibility",A.b.Shared),hasAliases:!1,encrypted:t.isRoomEncrypted(this.props.roomId),showAdvancedSection:!1}}componentDidMount(){this.context.on(L.b.Events,this.onStateEvent),this.hasAliases().then((e=>this.setState({hasAliases:e})))}pullContentPropertyFromEvent(e,t,n){return(null==e?void 0:e.getContent()[t])||n}componentWillUnmount(){this.context.removeListener(L.b.Events,this.onStateEvent)}async hasAliases(){const e=this.context,t=(await e.getLocalAliases(this.props.roomId)).aliases;return Array.isArray(t)&&0!==t.length}renderJoinRule(){const e=this.context.getRoom(this.props.roomId);let t;(null==e?void 0:e.getJoinRule())!==A.c.Public||this.state.hasAliases||(t=r.a.createElement("div",{className:"mx_SecurityRoomSettingsTab_warning"},r.a.createElement(B.Icon,{width:15,height:15}),r.a.createElement("span",null,Object(l.a)("To link to this room, please add an address."))));const n=Object(l.a)("Decide who can join %(roomName)s.",{roomName:null==e?void 0:e.name});return r.a.createElement(j.a,{legend:Object(l.a)("Access"),description:n},r.a.createElement(G.a,{room:e,beforeChange:this.onBeforeJoinRuleChange,onError:this.onJoinRuleChangeError,closeSettingsFn:this.props.closeSettingsFn,promptUpgrade:!0,aliasWarning:t}))}renderHistory(){var e;if(!I.b.getValue(R.b.RoomHistorySettings))return null;const t=this.context,n=this.state.history,i=null===(e=t.getRoom(this.props.roomId))||void 0===e?void 0:e.currentState,s=null==i?void 0:i.mayClientSendStateEvent(U.b.RoomHistoryVisibility,t),o=[{value:A.b.Shared,label:Object(l.a)("Members only (since the point in time of selecting this option)")},{value:A.b.Invited,label:Object(l.a)("Members only (since they were invited)")},{value:A.b.Joined,label:Object(l.a)("Members only (since they joined)")}];this.state.encrypted&&n!==A.b.WorldReadable||o.unshift({value:A.b.WorldReadable,label:Object(l.a)("Anyone")});const a=Object(l.a)("Changes to who can read history will only apply to future messages in this room. The visibility of existing history will be unchanged.");return r.a.createElement(j.a,{legend:Object(l.a)("Who can read history?"),description:a},r.a.createElement(H.a,{name:"historyVis",value:n,onChange:this.onHistoryRadioToggle,disabled:!s,definitions:o}))}renderAdvanced(){var e;const t=this.context,n=this.state.guestAccess,i=null===(e=t.getRoom(this.props.roomId))||void 0===e?void 0:e.currentState,s=null==i?void 0:i.mayClientSendStateEvent(U.b.RoomGuestAccess,t);return r.a.createElement(r.a.Fragment,null,r.a.createElement(V.a,{value:n===A.a.CanJoin,onChange:this.onGuestAccessChange,disabled:!s,label:Object(l.a)("Enable guest access")}),r.a.createElement("p",null,Object(l.a)("People with supported clients will be able to join the room without having a registered account.")))}render(){const e=this.context,t=e.getRoom(this.props.roomId),n=this.state.encrypted,i=null==t?void 0:t.currentState.mayClientSendStateEvent(U.b.RoomEncryption,e),s=!n&&i;let o;n&&I.b.isEnabled("blacklistUnverifiedDevices")&&(o=r.a.createElement(T.a,{name:"blacklistUnverifiedDevices",level:x.a.ROOM_DEVICE,onChange:this.updateBlacklistDevicesFlag,roomId:this.props.roomId}));const a=this.renderHistory();let c;return(null==t?void 0:t.getJoinRule())===A.c.Public&&(c=r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement(f.a,{onClick:this.toggleAdvancedSection,kind:"link",className:"mx_SettingsTab_showAdvanced"},this.state.showAdvancedSection?Object(l.a)("Hide advanced"):Object(l.a)("Show advanced")),this.state.showAdvancedSection&&this.renderAdvanced())),r.a.createElement("div",{className:"mx_SettingsTab mx_SecurityRoomSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Security & Privacy")),r.a.createElement(j.a,{legend:Object(l.a)("Encryption"),description:Object(l.a)("Once enabled, encryption cannot be disabled.")},r.a.createElement(V.a,{value:n,onChange:this.onEncryptionChange,label:Object(l.a)("Encrypted"),disabled:!s}),o),this.renderJoinRule(),c,a)}}s()(te,"contextType",O.a);var ne=n(279),ie=n(503),se=n(269),oe=n(217);class re extends r.a.Component{constructor(e,t){super(e,t),s()(this,"roomProps",void 0),s()(this,"soundUpload",Object(o.createRef)()),s()(this,"context",void 0),s()(this,"triggerUploader",(async e=>{var t;e.stopPropagation(),e.preventDefault(),null===(t=this.soundUpload.current)||void 0===t||t.click()})),s()(this,"onSoundUploadChanged",(e=>{if(!e.target.files||!e.target.files.length)return void this.setState({uploadedFile:null});const t=e.target.files[0];this.setState({uploadedFile:t})})),s()(this,"onClickSaveSound",(async e=>{e.stopPropagation(),e.preventDefault();try{await this.saveSound()}catch(e){F.a.error(`Unable to save notification sound for ${this.props.roomId}`),F.a.error(e)}})),s()(this,"clearSound",(e=>{e.stopPropagation(),e.preventDefault(),I.b.setValue("notificationSound",this.props.roomId,x.a.ROOM_ACCOUNT,null),this.setState({currentSound:"default"})})),s()(this,"onRoomNotificationChange",(e=>{this.roomProps.notificationVolume=e,this.forceUpdate()})),s()(this,"onOpenSettingsClick",(e=>{e.preventDefault(),this.props.closeSettingsFn(),C.a.dispatch({action:k.a.ViewUserSettings,initialTabId:oe.a.Notifications})})),this.roomProps=ie.a.forRoom(t.getRoom(this.props.roomId));let n="default";const i=ne.default.getSoundForRoom(this.props.roomId);i&&(n=i.name||i.url),this.state={currentSound:n,uploadedFile:null}}async saveSound(){if(!this.state.uploadedFile)return;let e=this.state.uploadedFile.type;"video/ogg"===e&&(e="audio/ogg");const{content_uri:t}=await p.a.get().uploadContent(this.state.uploadedFile,{type:e});await I.b.setValue("notificationSound",this.props.roomId,x.a.ROOM_ACCOUNT,{name:this.state.uploadedFile.name,type:e,size:this.state.uploadedFile.size,url:t}),this.setState({uploadedFile:null,currentSound:this.state.uploadedFile.name})}render(){let e;return this.state.uploadedFile&&(e=r.a.createElement("div",null,r.a.createElement("span",null,Object(l.a)("Uploaded sound"),": ",r.a.createElement("code",null,this.state.uploadedFile.name)))),r.a.createElement("div",{className:"mx_SettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Notifications")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_NotificationSettingsTab_notificationsSection"},r.a.createElement(H.a,{name:"roomNotificationSetting",definitions:[{value:se.a.AllMessages,className:"mx_NotificationSettingsTab_defaultEntry",label:r.a.createElement(r.a.Fragment,null,Object(l.a)("Default"),r.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(l.a)("Get notifications as set up in your <a>settings</a>",{},{a:e=>r.a.createElement(f.a,{kind:"link_inline",onClick:this.onOpenSettingsClick},e)})))},{value:se.a.AllMessagesLoud,className:"mx_NotificationSettingsTab_allMessagesEntry",label:r.a.createElement(r.a.Fragment,null,Object(l.a)("All messages"),r.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(l.a)("Get notified for every message")))},{value:se.a.MentionsOnly,className:"mx_NotificationSettingsTab_mentionsKeywordsEntry",label:r.a.createElement(r.a.Fragment,null,Object(l.a)("@mentions & keywords"),r.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(l.a)("Get notified only with mentions and keywords as set up in your <a>settings</a>",{},{a:e=>r.a.createElement(f.a,{kind:"link_inline",onClick:this.onOpenSettingsClick},e)})))},{value:se.a.Mute,className:"mx_NotificationSettingsTab_noneEntry",label:r.a.createElement(r.a.Fragment,null,Object(l.a)("Off"),r.a.createElement("div",{className:"mx_NotificationSettingsTab_microCopy"},Object(l.a)("You won't get any notifications")))}],onChange:this.onRoomNotificationChange,value:this.roomProps.notificationVolume})),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Sounds")),r.a.createElement("div",null,r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("span",null,Object(l.a)("Notification sound"),": ",r.a.createElement("code",null,this.state.currentSound))),r.a.createElement(f.a,{className:"mx_NotificationSound_resetSound",disabled:"default"==this.state.currentSound,onClick:this.clearSound,kind:"primary"},Object(l.a)("Reset"))),r.a.createElement("div",null,r.a.createElement("h3",null,Object(l.a)("Set a new custom sound")),r.a.createElement("div",{className:"mx_SettingsFlag"},r.a.createElement("form",{autoComplete:"off",noValidate:!0},r.a.createElement("input",{ref:this.soundUpload,className:"mx_NotificationSound_soundUpload",type:"file",onClick:S.a,onChange:this.onSoundUploadChanged,accept:"audio/*"})),e),r.a.createElement(f.a,{className:"mx_NotificationSound_browse",onClick:this.triggerUploader,kind:"primary"},Object(l.a)("Browse")),r.a.createElement(f.a,{className:"mx_NotificationSound_save",disabled:null==this.state.uploadedFile,onClick:this.onClickSaveSound,kind:"primary"},Object(l.a)("Save")),r.a.createElement("br",null))))}}s()(re,"contextType",O.a);var ae=n(574),ce=n(168),le=n(193),de=n(199);class ue extends r.a.PureComponent{render(){var e,t;const n=this.props.ev.getContent();if(null===(e=n.channel)||void 0===e||!e.id||null===(t=n.protocol)||void 0===t||!t.id)return F.a.warn(`Bridge info event ${this.props.ev.getId()} has missing content. Tile will not render`),null;n.bridgebot||(F.a.warn(`Bridge info event ${this.props.ev.getId()} does not provide a 'bridgebot' key whichis deprecated behaviour. Using sender for now.`),n.bridgebot=this.props.ev.getSender());const{channel:i,network:s,protocol:o}=n,a=o.displayname||o.id,c=i.displayname||i.id;let d;n.creator&&(d=r.a.createElement("li",null,Object(l.a)("This bridge was provisioned by <user />.",{},{user:()=>r.a.createElement(ae.b,{type:ae.a.UserMention,room:this.props.room,url:Object(ce.i)(n.creator),shouldShowPillAvatar:I.b.getValue("Pill.shouldShowPillAvatar")})})));const u=r.a.createElement("li",null,Object(l.a)("This bridge is managed by <user />.",{},{user:()=>r.a.createElement(ae.b,{type:ae.a.UserMention,room:this.props.room,url:Object(ce.i)(n.bridgebot),shouldShowPillAvatar:I.b.getValue("Pill.shouldShowPillAvatar")})}));let h,m;if(o.avatar_url){var p;const e=null!==(p=Object(v.b)(o.avatar_url).getSquareThumbnailHttp(64))&&void 0!==p?p:void 0;h=r.a.createElement(le.a,{className:"mx_RoomSettingsDialog_protocolIcon",width:48,height:48,resizeMethod:"crop",name:a,idName:a,url:e})}else h=r.a.createElement("div",{className:"mx_RoomSettingsDialog_noProtocolIcon"});if(s){const e=s.displayname||s.id;let t=r.a.createElement("span",null,e);"string"==typeof s.external_url&&Object(de.f)(s.external_url)&&(t=r.a.createElement("a",{href:s.external_url,target:"_blank",rel:"noreferrer noopener"},e)),m=Object(l.a)("Workspace: <networkLink/>",{},{networkLink:()=>t})}let g=r.a.createElement("span",null,c);"string"==typeof i.external_url&&Object(de.f)(i.external_url)&&(g=r.a.createElement("a",{href:i.external_url,target:"_blank",rel:"noreferrer noopener"},c));const f=this.props.ev.getId();return r.a.createElement("li",{key:f,className:"mx_RoomSettingsDialog_BridgeList_listItem"},r.a.createElement("div",{className:"mx_RoomSettingsDialog_column_icon"},h),r.a.createElement("div",{className:"mx_RoomSettingsDialog_column_data"},r.a.createElement("h3",{className:"mx_RoomSettingsDialog_column_data_protocolName"},a),r.a.createElement("p",{className:"mx_RoomSettingsDialog_column_data_details mx_RoomSettingsDialog_workspace_channel_details"},m,r.a.createElement("span",{className:"mx_RoomSettingsDialog_channel"},Object(l.a)("Channel: <channelLink/>",{},{channelLink:()=>g}))),r.a.createElement("ul",{className:"mx_RoomSettingsDialog_column_data_metadata mx_RoomSettingsDialog_metadata"},d," ",u)))}}const he=["uk.half-shot.bridge"],me="https://matrix.org/bridges/";class pe extends r.a.Component{renderBridgeCard(e,t){const n=e.getContent();return t&&null!=n&&n.channel&&n.protocol?r.a.createElement(ue,{key:e.getId(),room:t,ev:e}):null}static getBridgeStateEvents(e){var t;const n=null===(t=p.a.get().getRoom(e))||void 0===t?void 0:t.currentState;return n?he.map((e=>n.getStateEvents(e))).flat(1):[]}render(){const e=pe.getBridgeStateEvents(this.props.roomId),t=p.a.get().getRoom(this.props.roomId);let n;return n=e.length>0?r.a.createElement("div",null,r.a.createElement("p",null,Object(l.a)("This room is bridging messages to the following platforms. <a>Learn more.</a>",{},{a:e=>r.a.createElement("a",{href:me,target:"_blank",rel:"noreferrer noopener"},e)})),r.a.createElement("ul",{className:"mx_RoomSettingsDialog_BridgeList"},e.map((e=>this.renderBridgeCard(e,t))))):r.a.createElement("p",null,Object(l.a)("This room isn't bridging messages to any platforms. <a>Learn more.</a>",{},{a:e=>r.a.createElement("a",{href:me,target:"_blank",rel:"noreferrer noopener"},e)})),r.a.createElement("div",{className:"mx_SettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Bridges")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},n))}}var ge=n(136),ve=n(409),fe=n(912),be=n(206),ye=n(314),Se=n(132);function Ee(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const we=e=>{var t;let{roomId:n}=e;const i=Object(o.useMemo)((()=>p.a.get().getRoom(n)),[n]),a=Object(o.useMemo)((()=>i.getJoinRule()===A.c.Public),[i]),[c,d,u]=Object(ye.a)(i,Object(o.useCallback)((e=>{var t,n;const i=null==e||null===(t=e.getStateEvents(U.b.RoomPowerLevels,""))||void 0===t?void 0:t.getContent();return[null!=i?i:{},null!==(n=null==i?void 0:i.events)&&void 0!==n?n:{},null==e?void 0:e.maySendStateEvent(U.b.RoomPowerLevels,p.a.get().getUserId())]}),[])),[h,m]=Object(o.useState)((()=>0===d[be.d.MEMBER_EVENT_TYPE.name])),g=Object(o.useCallback)((e=>{if(m(e),e){var t,i,o;const e=null!==(t=null!==(i=d[U.b.RoomMessage])&&void 0!==i?i:c.users_default)&&void 0!==t?t:0,n=null!==(o=c.kick)&&void 0!==o?o:50;d[be.d.CALL_EVENT_TYPE.name]=a?n:e,d[be.d.MEMBER_EVENT_TYPE.name]=e}else{var r,l;const e=null!==(r=null!==(l=d[U.b.RoomPowerLevels])&&void 0!==l?l:c.state_default)&&void 0!==r?r:100;d[be.d.CALL_EVENT_TYPE.name]=e,d[be.d.MEMBER_EVENT_TYPE.name]=e}p.a.get().sendStateEvent(n,U.b.RoomPowerLevels,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ee(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ee(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({events:d},c))}),[n,c,d,a]),v=null!==(t=Se.b.get("element_call").brand)&&void 0!==t?t:Se.a.element_call.brand;return r.a.createElement(V.a,{"data-testid":"element-call-switch",label:Object(l.a)("Enable %(brand)s as an additional calling option in this room",{brand:v}),caption:Object(l.a)("%(brand)s is end-to-end encrypted, but is currently limited to smaller numbers of users.",{brand:v}),value:h,onChange:g,disabled:!u,tooltip:Object(l.a)("You do not have sufficient permissions to change this.")})},_e=e=>{let{roomId:t}=e;return r.a.createElement(fe.a,{heading:Object(l.a)("Voice & Video")},r.a.createElement(ve.a,{heading:Object(l.a)("Call type")},r.a.createElement(we,{roomId:t})))},Ce="ROOM_SECURITY_TAB",Oe="ROOM_NOTIFICATIONS_TAB";class Ie extends r.a.Component{constructor(e){super(e),s()(this,"dispatcherRef",void 0),s()(this,"onAction",(e=>{e.action===k.a.ViewHomePage&&this.props.onFinished(!0)})),s()(this,"onRoomName",(()=>{this.setState({roomName:p.a.get().getRoom(this.props.roomId).name})})),this.state={roomName:""}}componentDidMount(){this.dispatcherRef=C.a.register(this.onAction),p.a.get().on(a.d.Name,this.onRoomName),this.onRoomName()}componentWillUnmount(){this.dispatcherRef&&C.a.unregister(this.dispatcherRef),p.a.get().removeListener(a.d.Name,this.onRoomName)}getTabs(){const e=[];return e.push(new c.a("ROOM_GENERAL_TAB",Object(l.c)("General"),"mx_RoomSettingsDialog_settingsIcon",r.a.createElement(M,{roomId:this.props.roomId}),"RoomSettingsGeneral")),I.b.getValue("feature_group_calls")&&e.push(new c.a("ROOM_VOIP_TAB",Object(l.c)("Voice & Video"),"mx_RoomSettingsDialog_voiceIcon",r.a.createElement(_e,{roomId:this.props.roomId}))),e.push(new c.a(Ce,Object(l.c)("Security & Privacy"),"mx_RoomSettingsDialog_securityIcon",r.a.createElement(te,{roomId:this.props.roomId,closeSettingsFn:()=>this.props.onFinished(!0)}),"RoomSettingsSecurityPrivacy")),e.push(new c.a("ROOM_ROLES_TAB",Object(l.c)("Roles & Permissions"),"mx_RoomSettingsDialog_rolesIcon",r.a.createElement(u.a,{roomId:this.props.roomId}),"RoomSettingsRolesPermissions")),e.push(new c.a(Oe,Object(l.c)("Notifications"),"mx_RoomSettingsDialog_notificationsIcon",r.a.createElement(re,{roomId:this.props.roomId,closeSettingsFn:()=>this.props.onFinished(!0)}),"RoomSettingsNotifications")),I.b.getValue("feature_bridge_state")&&e.push(new c.a("ROOM_BRIDGES_TAB",Object(l.c)("Bridges"),"mx_RoomSettingsDialog_bridgesIcon",r.a.createElement(pe,{roomId:this.props.roomId}),"RoomSettingsBridges")),I.b.getValue(R.b.AdvancedSettings)&&e.push(new c.a("ROOM_ADVANCED_TAB",Object(l.c)("Advanced"),"mx_RoomSettingsDialog_warningIcon",r.a.createElement(d.a,{roomId:this.props.roomId,closeSettingsFn:()=>this.props.onFinished(!0)}),"RoomSettingsAdvanced")),e}render(){const e=this.state.roomName;return r.a.createElement(ge.a,{className:"mx_RoomSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Room Settings - %(roomName)s",{roomName:e})},r.a.createElement("div",{className:"mx_SettingsDialog_content"},r.a.createElement(c.c,{tabs:this.getTabs(),initialTabId:this.props.initialTabId,screenName:"RoomSettings"})))}}},function(e,t,n){"use strict";n.d(t,"e",(function(){return w})),n.d(t,"c",(function(){return _})),n.d(t,"a",(function(){return O})),n.d(t,"b",(function(){return I})),n.d(t,"d",(function(){return R}));var i=n(122),s=n.n(i),o=n(149),r=n(1),a=n(221),c=n(129),l=n(125),d=n(301),u=n(275),h=n(164),m=n(309);var p=n(312),g=n(200),v=n(137);var f=n(220),b=n(447);async function y(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=t.map((e=>e.userId));let s;var o;1===i.length?s=Object(m.a)(e,i[0]):s=null!==(o=h.a.shared().getDMRoomForIdentifiers(i))&&void 0!==o?o:void 0;if(s&&!Object(f.a)(s))return l.a.dispatch({action:c.a.ViewRoom,room_id:s.roomId,should_peek:!1,joining:!1,metricsTrigger:"MessageUser"}),Promise.resolve(s.roomId);const r={inlineErrors:!0};await R(e,t)&&(r.encryption=!0);const d=1===i.length&&i[0]===e.getUserId();return 1!==i.length||d||(r.dmUserId=i[0]),i.length>1&&(r.createOpts=i.reduce(((t,n)=>{const i=Object(b.b)(n);if("email"===i){const i={id_server:e.getIdentityServerUrl(!0),medium:"email",address:n};t.invite_3pid.push(i)}else"mx-user-id"===i&&t.invite.push(n);return t}),{invite:[],invite_3pid:[]})),r.spinner=n,Object(a.b)(r)}const S=async(e,t)=>{const n=e.filter((e=>e instanceof I));if(0===n.length)return e;const i=await E(n,t);return e.map((e=>{var t,n;if(!(e instanceof I))return e;const s=i.find((t=>t.threePidId===e.userId));return s?new O({user_id:s.mxid,avatar_url:null==s||null===(t=s.profile)||void 0===t?void 0:t.avatar_url,display_name:null==s||null===(n=s.profile)||void 0===n?void 0:n.displayname}):e}))},E=async(e,t)=>{const n=await(async(e,t)=>{if(!t.identityServer)return[];if(0===e.length)return[];const n=await t.identityServer.getAccessToken();return(await t.bulkLookupThreePids(e.map((e=>[e.isEmail?"email":"msisdn",e.userId])),n)).threepids.map((e=>{let[t,n,i]=e;return{threePidId:n,mxid:i}}))})(e,t),i=n.map((async e=>{let n=null;try{n=await t.getProfileInfo(e.mxid)}catch{}return{threePidId:e.threePidId,mxid:e.mxid,profile:n}}));return Promise.all(i)};async function w(e,t){let n=t;try{n=await S(t,e)}catch(e){r.a.warn("Error resolving 3rd-party members",e)}const i=function(e,t){const n=t.map((e=>e.userId));let i;return i=1===n.length?Object(m.a)(e,n[0]):h.a.shared().getDMRoomForIdentifiers(n),i||null}(e,n);if(i)return l.a.dispatch({action:c.a.ViewRoom,room_id:i.roomId,should_peek:!1,joining:!1,metricsTrigger:"MessageUser"}),i.roomId;if(1===t.length&&t[0]instanceof I&&Object(p.a)())return await y(e,t);const s=await async function(e,t){const n=e.getUserId(),i=new d.b(d.a+e.makeTxnId(),e,n),s=[];return s.push(new v.MatrixEvent({event_id:`~${i.roomId}:${e.makeTxnId()}`,type:v.EventType.RoomCreate,content:{creator:n,room_version:v.KNOWN_SAFE_ROOM_VERSION},state_key:"",user_id:n,sender:n,room_id:i.roomId,origin_server_ts:Date.now()})),await R(e,t)&&(i.encrypted=!0,s.push(new v.MatrixEvent({event_id:`~${i.roomId}:${e.makeTxnId()}`,type:v.EventType.RoomEncryption,content:{algorithm:g.MEGOLM_ALGORITHM},user_id:n,sender:n,state_key:"",room_id:i.roomId,origin_server_ts:Date.now()}))),s.push(new v.MatrixEvent({event_id:`~${i.roomId}:${e.makeTxnId()}`,type:v.EventType.RoomMember,content:{displayname:n,membership:"join"},state_key:n,user_id:n,sender:n,room_id:i.roomId})),t.forEach((t=>{var o,r;s.push(new v.MatrixEvent({event_id:`~${i.roomId}:${e.makeTxnId()}`,type:v.EventType.RoomMember,content:{displayname:t.name,avatar_url:null!==(o=t.getMxcAvatarUrl())&&void 0!==o?o:void 0,membership:"invite",isDirect:!0},state_key:t.userId,sender:n,room_id:i.roomId})),s.push(new v.MatrixEvent({event_id:`~${i.roomId}:${e.makeTxnId()}`,type:v.EventType.RoomMember,content:{displayname:t.name,avatar_url:null!==(r=t.getMxcAvatarUrl())&&void 0!==r?r:void 0,membership:"join"},state_key:t.userId,sender:t.userId,room_id:i.roomId}))})),i.targets=t,i.updateMyMembership("join"),i.addLiveEvents(s),i.currentState.setStateEvents(s),i.name=i.getDefaultRoomName(e.getUserId()),e.store.storeRoom(i),i}(e,n);return l.a.dispatch({action:c.a.ViewRoom,room_id:s.roomId,joining:!1,targets:n}),s.roomId}async function _(e,t){if(t.isNew)return t.state=d.c.CREATING,e.emit(o.b.Room,t),y(e,t.targets,!1).then((n=>{if(!n)throw new Error(`startDm for local room ${t.roomId} didn't return a room Id`);return t.actualRoomId=n,Object(u.b)(e,t)}),(()=>{r.a.warn(`Error creating DM for local room ${t.roomId}`),t.state=d.c.ERROR,e.emit(o.b.Room,t)}))}class C{}class O extends C{constructor(e){super(),s()(this,"_userId",void 0),s()(this,"displayName",void 0),s()(this,"avatarUrl",void 0),this._userId=e.user_id,this.displayName=e.display_name,this.avatarUrl=e.avatar_url}get name(){return this.displayName||this._userId}get userId(){return this._userId}getMxcAvatarUrl(){var e;return null!==(e=this.avatarUrl)&&void 0!==e?e:null}}class I extends C{constructor(e){super(),s()(this,"id",void 0),this.id=e}get isEmail(){return this.id.includes("@")}get name(){return this.id}get userId(){return this.id}getMxcAvatarUrl(){return null}}async function R(e,t){if(Object(p.a)()){if(1===t.length&&t[0]instanceof I)return!0;if(!t.some((e=>e instanceof I))){const n=t.map((e=>e.userId));if(await Object(a.a)(e,n))return!0}}return!1}},function(e,t,n){"use strict";n.d(t,"a",(function(){return D}));var i=n(131),s=n.n(i),o=n(122),r=n.n(o),a=n(120),c=n.n(a),l=n(439),d=n.n(l),u=n(121),h=n(148),m=n(173),p=n(335),g=n(687),v=n(151),f=n(808),b=n(126),y=n(166),S=n(125),E=n(129),w=n(134),_=n.n(w);const C=["deltaMode","deltaX","deltaY","deltaZ"];function O(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function I(e){let{deltaMode:t,deltaX:n,deltaY:i,deltaZ:s}=e,o=_()(e,C);return 1===t&&(n*=18,i*=18,s*=18),new WheelEvent("syntheticWheel",function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?O(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):O(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({deltaMode:0,deltaY:i,deltaX:n,deltaZ:s},o))}var R=n(198),k=n(143),x=n(153),T=n(586);const j=.95,P=()=>{const e=getComputedStyle(document.documentElement).getPropertyValue("--image-view-panel-height");return parseInt(e.slice(0,e.length-2))};class D extends c.a.Component{constructor(e){var t,n;super(e),r()(this,"contextMenuButton",Object(a.createRef)()),r()(this,"focusLock",Object(a.createRef)()),r()(this,"imageWrapper",Object(a.createRef)()),r()(this,"image",Object(a.createRef)()),r()(this,"initX",0),r()(this,"initY",0),r()(this,"previousX",0),r()(this,"previousY",0),r()(this,"animatingLoading",!1),r()(this,"imageIsLoaded",!1),r()(this,"imageLoaded",(()=>{const{thumbnailInfo:e}=this.props;null!=e&&e.width&&this.setState({zoom:e.width/this.image.current.naturalWidth}),this.imageIsLoaded=!0,this.animatingLoading=!0,this.setZoomAndRotation(),this.setState({translationX:0,translationY:0}),this.animatingLoading=!1})),r()(this,"recalculateZoom",(()=>{this.setZoomAndRotation()})),r()(this,"setZoomAndRotation",(e=>{const t=this.image.current,n=this.imageWrapper.current,i=null!=e?e:this.state.rotation,s=i%180==0,o=s?t.naturalWidth:t.naturalHeight,r=s?t.naturalHeight:t.naturalWidth,a=n.clientWidth/o,c=n.clientHeight/r;if(a>=1&&c>=1)return void this.setState({zoom:1,minZoom:1,maxZoom:1,rotation:i});const l=Math.min(a,c)*j,d=this.state.zoom<=this.state.minZoom?l:this.state.zoom;this.setState({minZoom:l,maxZoom:1,rotation:i,zoom:d})})),r()(this,"onWheel",(e=>{if(e.target===this.image.current){e.stopPropagation(),e.preventDefault();const{deltaY:t}=I(e);this.zoomDelta(.0025*-t,e.offsetX,e.offsetY)}})),r()(this,"onZoomInClick",(()=>{this.zoomDelta(.1)})),r()(this,"onZoomOutClick",(()=>{this.zoomDelta(-.1)})),r()(this,"onKeyDown",(e=>{if(Object(x.a)().getAccessibilityAction(e)===k.h.Escape)e.stopPropagation(),e.preventDefault(),this.props.onFinished()})),r()(this,"onRotateCounterClockwiseClick",(()=>{const e=this.state.rotation;this.setZoomAndRotation(e-90)})),r()(this,"onRotateClockwiseClick",(()=>{const e=this.state.rotation;this.setZoomAndRotation(e+90)})),r()(this,"onDownloadClick",(()=>{const e=document.createElement("a");e.href=this.props.src,e.download=this.props.name,e.target="_blank",e.rel="noreferrer noopener",e.click()})),r()(this,"onOpenContextMenu",(()=>{this.setState({contextMenuDisplayed:!0})})),r()(this,"onCloseContextMenu",(()=>{this.setState({contextMenuDisplayed:!1})})),r()(this,"onPermalinkClicked",(e=>{e.preventDefault(),S.a.dispatch({action:E.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0}),this.props.onFinished()})),r()(this,"onStartMoving",(e=>{e.stopPropagation(),e.preventDefault(),0===e.button&&(this.state.zoom!==this.state.minZoom?(this.setState({moving:!0}),this.previousX=this.state.translationX,this.previousY=this.state.translationY,this.initX=e.pageX-this.state.translationX,this.initY=e.pageY-this.state.translationY):this.zoom(this.state.maxZoom===this.state.minZoom?2*this.state.maxZoom:this.state.maxZoom,e.nativeEvent.offsetX,e.nativeEvent.offsetY))})),r()(this,"onMoving",(e=>{e.stopPropagation(),e.preventDefault(),this.state.moving&&this.setState({translationX:e.pageX-this.initX,translationY:e.pageY-this.initY})})),r()(this,"onEndMoving",(()=>{!0===this.state.moving&&Math.abs(this.state.translationX-this.previousX)<10&&Math.abs(this.state.translationY-this.previousY)<10&&(this.zoom(this.state.minZoom),this.initX=0,this.initY=0),this.setState({moving:!1})}));const{thumbnailInfo:i}=this.props;this.state={zoom:0,minZoom:j,maxZoom:j,rotation:0,translationX:null!==(t=(null==i?void 0:i.positionX)+(null==i?void 0:i.width)/2-R.b.instance.windowWidth/2)&&void 0!==t?t:0,translationY:null!==(n=(null==i?void 0:i.positionY)+(null==i?void 0:i.height)/2-R.b.instance.windowHeight/2-P()/2)&&void 0!==n?n:0,moving:!1,contextMenuDisplayed:!1}}componentDidMount(){this.focusLock.current.addEventListener("wheel",this.onWheel,{passive:!1}),window.addEventListener("resize",this.recalculateZoom),this.image.current.addEventListener("load",this.imageLoaded)}componentWillUnmount(){this.focusLock.current.removeEventListener("wheel",this.onWheel),window.removeEventListener("resize",this.recalculateZoom),this.image.current.removeEventListener("load",this.imageLoaded)}zoomDelta(e,t,n){this.zoom(this.state.zoom+e,t,n)}zoom(e,t,n){const i=this.state.zoom,s=this.state.maxZoom===this.state.minZoom?2*this.state.maxZoom:this.state.maxZoom,o=Math.min(e,s);if(o<=this.state.minZoom)this.setState({zoom:this.state.minZoom,translationX:0,translationY:0});else if("number"!=typeof t&&"number"!=typeof n)this.setState({zoom:o,translationX:this.state.translationX*o/i,translationY:this.state.translationY*o/i});else{let e,s;switch((this.state.rotation%360+360)%360){case 0:e=this.image.current.clientWidth/2-t,s=this.image.current.clientHeight/2-n;break;case 90:e=n-this.image.current.clientHeight/2,s=this.image.current.clientWidth/2-t;break;case 180:e=t-this.image.current.clientWidth/2,s=n-this.image.current.clientHeight/2;break;case 270:e=this.image.current.clientHeight/2-n,s=t-this.image.current.clientWidth/2}this.setState({zoom:o,translationX:this.state.translationX+(o-i)*e,translationY:this.state.translationY+(o-i)*s})}}renderContextMenu(){let e=null;return this.state.contextMenuDisplayed&&(e=c.a.createElement(g.a,s()({},Object(v.i)(this.contextMenuButton.current.getBoundingClientRect()),{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,onFinished:this.onCloseContextMenu,onCloseDialog:this.props.onFinished}))),c.a.createElement(c.a.Fragment,null,e)}render(){var e;const t=!!this.props.mxEvent;let n,i;n=this.animatingLoading?"mx_ImageView_image_animatingLoading":this.state.moving||!this.imageIsLoaded?"":"mx_ImageView_image_animating",i=this.state.moving?"grabbing":this.state.zoom===this.state.minZoom?"zoom-in":"zoom-out";const s=this.state.rotation+"deg",o=this.state.zoom,r={cursor:i,transform:`translateX(${this.state.translationX+"px"})\n                        translateY(${this.state.translationY+"px"})\n                        scale(${o})\n                        rotate(${s})`};let a,l;if(t){const e=this.props.mxEvent,t=b.b.getValue("showTwelveHourTimestamps");let n="#";this.props.permalinkCreator&&(n=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const i=e.sender?e.sender.name:e.getSender(),s=c.a.createElement("div",{className:"mx_ImageView_info_sender"},i),o=c.a.createElement("a",{href:n,onClick:this.onPermalinkClicked,"aria-label":Object(y.c)(new Date(this.props.mxEvent.getTs()),t,!1)},c.a.createElement(f.a,{showFullDate:!0,showTwelveHour:t,ts:e.getTs(),showSeconds:!1})),r=c.a.createElement(m.b,{member:e.sender,fallbackUserId:e.getSender(),width:32,height:32,viewUserOnClick:!0});a=c.a.createElement("div",{className:"mx_ImageView_info_wrapper"},r,c.a.createElement("div",{className:"mx_ImageView_info"},s,o))}else a=c.a.createElement("div",null);this.props.mxEvent&&(l=c.a.createElement(p.a,{className:"mx_ImageView_button mx_ImageView_button_more",title:Object(u.a)("Options"),onClick:this.onOpenContextMenu,inputRef:this.contextMenuButton,isExpanded:this.state.contextMenuDisplayed}));const g=c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_zoomOut",title:Object(u.a)("Zoom out"),onClick:this.onZoomOutClick}),v=c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_zoomIn",title:Object(u.a)("Zoom in"),onClick:this.onZoomInClick});let S;var E;null!==(e=this.props.mxEvent)&&void 0!==e&&e.getContent()&&(S=c.a.createElement("div",{className:"mx_ImageView_title"},Object(T.a)(null===(E=this.props.mxEvent)||void 0===E?void 0:E.getContent(),Object(u.a)("Image"),!0)));return c.a.createElement(d.a,{returnFocus:!0,lockProps:{onKeyDown:this.onKeyDown,role:"dialog"},className:"mx_ImageView",ref:this.focusLock},c.a.createElement("div",{className:"mx_ImageView_panel"},a,S,c.a.createElement("div",{className:"mx_ImageView_toolbar"},g,v,c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_rotateCCW",title:Object(u.a)("Rotate Left"),onClick:this.onRotateCounterClockwiseClick}),c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_rotateCW",title:Object(u.a)("Rotate Right"),onClick:this.onRotateClockwiseClick}),c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_download",title:Object(u.a)("Download"),onClick:this.onDownloadClick}),l,c.a.createElement(h.a,{className:"mx_ImageView_button mx_ImageView_button_close",title:Object(u.a)("Close"),onClick:this.props.onFinished}),this.renderContextMenu())),c.a.createElement("div",{className:"mx_ImageView_image_wrapper",ref:this.imageWrapper,onMouseDown:this.props.onFinished,onMouseMove:this.onMoving,onMouseUp:this.onEndMoving,onMouseLeave:this.onEndMoving},c.a.createElement("img",{src:this.props.src,style:r,alt:this.props.name,ref:this.image,className:`mx_ImageView_image ${n}`,draggable:!0,onMouseDown:this.onStartMoving})))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return ee})),n.d(t,"c",(function(){return re})),n.d(t,"b",(function(){return ae})),n.d(t,"e",(function(){return ce})),n.d(t,"d",(function(){return le}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(180),c=n(130),l=n(274),d=n(1496),u=n(1),h=n(123),m=n(125),p=n(121),g=n(128),v=n(692),f=n(199),b=n(157),y=n(183),S=n(823),E=n(447),w=n(372),_=n(446),C=n(168),O=n(202),I=n(589),R=n(282),k=n(221),x=n(129),T=n(246),j=n(132),P=n(126),D=n(158),N=n(251),M=n(185),A=n(234),L=n(401),U=n(996),F=n(685),B=n(872),V=n(216);var K=e=>{let{onFinished:t}=e;const n={};re.forEach((e=>{e.isEnabled()&&(n[e.category]||(n[e.category]=[]),n[e.category].push(e))}));const i=Object.values(ee).filter((e=>n[e])).map((e=>{const t=[r.a.createElement("tr",{key:"_category_"+e,className:"mx_SlashCommandHelpDialog_headerRow"},r.a.createElement("td",{colSpan:3},r.a.createElement("h2",null,Object(p.a)(e))))];return n[e].forEach((e=>{t.push(r.a.createElement("tr",{key:e.command},r.a.createElement("td",null,r.a.createElement("strong",null,e.getCommand())),r.a.createElement("td",null,e.args),r.a.createElement("td",null,e.description)))})),t}));return r.a.createElement(V.a,{className:"mx_SlashCommandHelpDialog",title:Object(p.a)("Command Help"),description:r.a.createElement("table",null,r.a.createElement("tbody",null,i)),hasCloseButton:!0,onFinished:t})},$=n(223),H=n(139),W=n(191),q=n(397),G=n(390),z=n(508),J=n(220),Y=n(155);function Q(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function X(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Q(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Q(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const Z=async()=>new Promise((e=>{const t=document.createElement("input");t.setAttribute("type","file"),t.onchange=t=>{var n;const i=null===(n=t.target.files)||void 0===n?void 0:n[0];i&&g.b.createDialog(U.a,{file:i,onFinished:async t=>{if(t){const{content_uri:t}=await h.a.get().uploadContent(i);e(t)}else e(null)}})},t.click()})),ee={messages:Object(p.c)("Messages"),actions:Object(p.c)("Actions"),admin:Object(p.c)("Admin"),advanced:Object(p.c)("Advanced"),effects:Object(p.c)("Effects"),other:Object(p.c)("Other")};class te{constructor(e){var t;s()(this,"command",void 0),s()(this,"aliases",void 0),s()(this,"args",void 0),s()(this,"description",void 0),s()(this,"runFn",void 0),s()(this,"category",void 0),s()(this,"hideCompletionAfterSpace",void 0),s()(this,"renderingTypes",void 0),s()(this,"analyticsName",void 0),s()(this,"_isEnabled",void 0),this.command=e.command,this.aliases=e.aliases||[],this.args=e.args||"",this.description=e.description,this.runFn=null===(t=e.runFn)||void 0===t?void 0:t.bind(this),this.category=e.category||ee.other,this.hideCompletionAfterSpace=e.hideCompletionAfterSpace||!1,this._isEnabled=e.isEnabled,this.renderingTypes=e.renderingTypes,this.analyticsName=e.analyticsName}getCommand(){return`/${this.command}`}getCommandWithArgs(){return this.getCommand()+" "+this.args}run(e,t,n){var i;if(!this.runFn)return ne(Object(p.i)("Command error: Unable to handle slash command."));const s=t?H.a.Thread:H.a.Room;return!this.renderingTypes||null!==(i=this.renderingTypes)&&void 0!==i&&i.includes(s)?(this.analyticsName&&W.a.instance.trackEvent({eventName:"SlashCommand",command:this.analyticsName}),this.runFn(e,n)):ne(Object(p.i)("Command error: Unable to find rendering type (%(renderingType)s)",{renderingType:s}))}getUsage(){return Object(p.a)("Usage")+": "+this.getCommandWithArgs()}isEnabled(){return!this._isEnabled||this._isEnabled()}}function ne(e){return{error:e}}function ie(){return{promise:arguments.length>0&&void 0!==arguments[0]?arguments[0]:Promise.resolve()}}function se(e){return ie(Promise.resolve(e))}const oe=()=>{const e=h.a.get().getRoom(Y.b.instance.roomViewStore.getRoomId());return Object(J.a)(e)},re=[new te({command:"spoiler",args:"<message>",description:Object(p.c)("Sends the given message as a spoiler"),runFn:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return se(l.makeHtmlMessage(t,`<span data-mx-spoiler>${t}</span>`))},category:ee.messages}),new te({command:"shrug",args:"<message>",description:Object(p.c)("Prepends ¯\\_(ツ)_/¯ to a plain-text message"),runFn:function(e,t){let n="¯\\_(ツ)_/¯";return t&&(n=n+" "+t),se(l.makeTextMessage(n))},category:ee.messages}),new te({command:"tableflip",args:"<message>",description:Object(p.c)("Prepends (╯°□°）╯︵ ┻━┻ to a plain-text message"),runFn:function(e,t){let n="(╯°□°）╯︵ ┻━┻";return t&&(n=n+" "+t),se(l.makeTextMessage(n))},category:ee.messages}),new te({command:"unflip",args:"<message>",description:Object(p.c)("Prepends ┬──┬ ノ( ゜-゜ノ) to a plain-text message"),runFn:function(e,t){let n="┬──┬ ノ( ゜-゜ノ)";return t&&(n=n+" "+t),se(l.makeTextMessage(n))},category:ee.messages}),new te({command:"lenny",args:"<message>",description:Object(p.c)("Prepends ( ͡° ͜ʖ ͡°) to a plain-text message"),runFn:function(e,t){let n="( ͡° ͜ʖ ͡°)";return t&&(n=n+" "+t),se(l.makeTextMessage(n))},category:ee.messages}),new te({command:"plain",args:"<message>",description:Object(p.c)("Sends a message as plain text, without interpreting it as markdown"),runFn:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return se(l.makeTextMessage(t))},category:ee.messages}),new te({command:"html",args:"<message>",description:Object(p.c)("Sends a message as html, without interpreting it as markdown"),runFn:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return se(l.makeHtmlMessage(t,t))},category:ee.messages}),new te({command:"upgraderoom",args:"<new_version>",description:Object(p.c)("Upgrades a room to a new version"),isEnabled:()=>!oe(),runFn:function(e,t){if(t){const n=h.a.get(),i=n.getRoom(e);if(null==i||!i.currentState.mayClientSendStateEvent("m.room.tombstone",n))return ne(Object(p.i)("You do not have the required permissions to use this command."));const{finished:s}=g.b.createDialog(B.a,{roomId:e,targetVersion:t},void 0,!1,!0);return ie(s.then((async e=>{let[n]=e;null!=n&&n.continue&&await Object(L.b)(i,t,n.invite)})))}return ne(this.getUsage())},category:ee.admin,renderingTypes:[H.a.Room]}),new te({command:"jumptodate",args:"<YYYY-MM-DD>",description:Object(p.c)("Jump to the given date in the timeline"),isEnabled:()=>P.b.getValue("feature_jump_to_date"),runFn:function(e,t){return t?ie((async()=>{const n=Date.parse(t);if(!n)throw Object(p.i)("We were unable to understand the given date (%(inputDate)s). Try using the format YYYY-MM-DD.",{inputDate:t});const i=h.a.get(),{event_id:s,origin_server_ts:o}=await i.timestampToEvent(e,n,a.a.Forward);u.a.log(`/timestamp_to_event: found ${s} (${o}) for timestamp=${n}`),m.a.dispatch({action:x.a.ViewRoom,event_id:s,highlighted:!0,room_id:e,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0})})()):ne(this.getUsage())},category:ee.actions}),new te({command:"nick",args:"<display_name>",description:Object(p.c)("Changes your display nickname"),runFn:function(e,t){return t?ie(h.a.get().setDisplayName(t)):ne(this.getUsage())},category:ee.actions,renderingTypes:[H.a.Room]}),new te({command:"myroomnick",aliases:["roomnick"],args:"<display_name>",description:Object(p.c)("Changes your display nickname in the current room only"),isEnabled:()=>!oe(),runFn:function(e,t){if(t){var n;const i=h.a.get(),s=null===(n=i.getRoom(e))||void 0===n?void 0:n.currentState.getStateEvents("m.room.member",i.getUserId()),o=X(X({},s?s.getContent():{membership:"join"}),{},{displayname:t});return ie(i.sendStateEvent(e,"m.room.member",o,i.getUserId()))}return ne(this.getUsage())},category:ee.actions,renderingTypes:[H.a.Room]}),new te({command:"roomavatar",args:"[<mxc_url>]",description:Object(p.c)("Changes the avatar of the current room"),isEnabled:()=>!oe(),runFn:function(e,t){let n=Promise.resolve(null!=t?t:null);return t||(n=Z()),ie(n.then((t=>{if(t)return h.a.get().sendStateEvent(e,"m.room.avatar",{url:t},"")})))},category:ee.actions,renderingTypes:[H.a.Room]}),new te({command:"myroomavatar",args:"[<mxc_url>]",description:Object(p.c)("Changes your avatar in this current room only"),isEnabled:()=>!oe(),runFn:function(e,t){const n=h.a.get(),i=n.getRoom(e),s=n.getUserId();let o=Promise.resolve(null!=t?t:null);return t||(o=Z()),ie(o.then((t=>{if(!t)return;const o=null==i?void 0:i.currentState.getStateEvents("m.room.member",s),r=X(X({},o?o.getContent():{membership:"join"}),{},{avatar_url:t});return n.sendStateEvent(e,"m.room.member",r,s)})))},category:ee.actions,renderingTypes:[H.a.Room]}),new te({command:"myavatar",args:"[<mxc_url>]",description:Object(p.c)("Changes your avatar in all rooms"),runFn:function(e,t){let n=Promise.resolve(null!=t?t:null);return t||(n=Z()),ie(n.then((e=>{if(e)return h.a.get().setAvatarUrl(e)})))},category:ee.actions,renderingTypes:[H.a.Room]}),new te({command:"topic",args:"[<topic>]",description:Object(p.c)("Gets or sets the room topic"),isEnabled:()=>!oe(),runFn:function(e,t){var n;const i=h.a.get();if(t){const n=Object(G.b)(t,{forceHTML:!1});return ie(i.setRoomTopic(e,t,n))}const s=i.getRoom(e);if(!s)return ne(Object(p.i)("Failed to get room topic: Unable to find room (%(roomId)s",{roomId:e}));const r=null===(n=s.currentState.getStateEvents("m.room.topic",""))||void 0===n?void 0:n.getContent(),a=r?l.parseTopicContent(r):{text:Object(p.a)("This room has no topic.")},c=Object(f.j)(a.text,a.html,void 0,!0);return g.b.createDialog(V.a,{title:s.name,description:o.createElement(f.a,null,c),hasCloseButton:!0,className:"markdown-body"}),ie()},category:ee.admin,renderingTypes:[H.a.Room]}),new te({command:"roomname",args:"<name>",description:Object(p.c)("Sets the room name"),isEnabled:()=>!oe(),runFn:function(e,t){return t?ie(h.a.get().setRoomName(e,t)):ne(this.getUsage())},category:ee.admin,renderingTypes:[H.a.Room]}),new te({command:"invite",args:"<user-id> [<reason>]",description:Object(p.c)("Invites user with given id to current room"),analyticsName:"Invite",isEnabled:()=>!oe()&&Object($.a)(D.a.InviteUsers),runFn:function(e,t){if(t){const[n,i]=t.split(/\s+(.+)/);if(n){let t=Promise.resolve();if(Object(E.b)(n)===E.a.Email&&!h.a.get().getIdentityServerUrl()){const e=Object(_.c)();if(!e)return ne(Object(p.i)("Use an identity server to invite by email. Manage in Settings."));{const{finished:n}=g.b.createDialog(b.a,{title:Object(p.a)("Use an identity server"),description:o.createElement("p",null,Object(p.a)("Use an identity server to invite by email. Click continue to use the default identity server (%(defaultIdentityServerName)s) or manage in Settings.",{defaultIdentityServerName:Object(w.a)(e)})),button:Object(p.a)("Continue")});t=n.then((e=>{let[t]=e;if(!t)throw Object(p.i)("Use an identity server to invite by email. Manage in Settings.");Object(_.d)()}))}}const s=new v.a(e);return ie(t.then((()=>s.invite([n],i,!0))).then((()=>{if("invited"!==s.getCompletionState(n))throw new Error(s.getErrorText(n))})))}}return ne(this.getUsage())},category:ee.actions,renderingTypes:[H.a.Room]}),new te({command:"join",aliases:["j","goto"],args:"<room-address>",description:Object(p.c)("Joins room with given address"),runFn:function(e,t){if(t){const e=t.split(" ");if(e.length<1)return ne(this.getUsage());let n=!1;if(e[0].startsWith("http:")||e[0].startsWith("https:")){const t=new URL(e[0]),i=t.host||t.hostname;Object(C.f)(i)&&(n=!0)}if("#"===e[0][0]){let t=e[0];return t.includes(":")||(t+=":"+h.a.get().getDomain()),m.a.dispatch({action:x.a.ViewRoom,room_alias:t,auto_join:!0,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0}),ie()}if("!"===e[0][0]){const[t,...n]=e;return m.a.dispatch({action:x.a.ViewRoom,room_id:t,via_servers:n,auto_join:!0,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0}),ie()}if(n){const t=Object(C.j)(e[0]);if(!t)return ne(this.getUsage());if(!t.roomIdOrAlias)return ne(this.getUsage());const n=t.roomIdOrAlias,i=t.viaServers,s=t.eventId,o={action:x.a.ViewRoom,auto_join:!0,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0};return"!"===n[0]?o.room_id=n:o.room_alias=n,s&&(o.event_id=s,o.highlighted=!0),i&&(o.opts={viaServers:i},o.via_servers=i),m.a.dispatch(o),ie()}}return ne(this.getUsage())},category:ee.actions,renderingTypes:[H.a.Room]}),new te({command:"part",args:"[<room-address>]",description:Object(p.c)("Leave room"),analyticsName:"Part",isEnabled:()=>!oe(),runFn:function(e,t){const n=h.a.get();let i;if(t){const e=t.match(/^(\S+)$/);if(e){var s;let t=e[1];if("#"!==t[0])return ne(this.getUsage());t.includes(":")||(t+=":"+n.getDomain());if(i=null===(s=n.getRooms().find((e=>e.getCanonicalAlias()===t||e.getAltAliases().includes(t))))||void 0===s?void 0:s.roomId,!i)return ne(Object(p.i)("Unrecognised room address: %(roomAlias)s",{roomAlias:t}))}}return i||(i=e),ie(Object(z.a)(i))},category:ee.actions,renderingTypes:[H.a.Room]}),new te({command:"remove",aliases:["kick"],args:"<user-id> [reason]",description:Object(p.c)("Removes user with given id from this room"),isEnabled:()=>!oe(),runFn:function(e,t){if(t){const n=t.match(/^(\S+?)( +(.*))?$/);if(n)return ie(h.a.get().kick(e,n[1],n[3]))}return ne(this.getUsage())},category:ee.admin,renderingTypes:[H.a.Room]}),new te({command:"ban",args:"<user-id> [reason]",description:Object(p.c)("Bans user with given id"),isEnabled:()=>!oe(),runFn:function(e,t){if(t){const n=t.match(/^(\S+?)( +(.*))?$/);if(n)return ie(h.a.get().ban(e,n[1],n[3]))}return ne(this.getUsage())},category:ee.admin,renderingTypes:[H.a.Room]}),new te({command:"unban",args:"<user-id>",description:Object(p.c)("Unbans user with given ID"),isEnabled:()=>!oe(),runFn:function(e,t){if(t){const n=t.match(/^(\S+)$/);if(n)return ie(h.a.get().unban(e,n[1]))}return ne(this.getUsage())},category:ee.admin,renderingTypes:[H.a.Room]}),new te({command:"ignore",args:"<user-id>",description:Object(p.c)("Ignores a user, hiding their messages from you"),runFn:function(e,t){if(t){const e=h.a.get(),n=t.match(/^(@[^:]+:\S+)$/);if(n){const t=n[1],i=e.getIgnoredUsers();return i.push(t),ie(e.setIgnoredUsers(i).then((()=>{g.b.createDialog(V.a,{title:Object(p.a)("Ignored user"),description:o.createElement("div",null,o.createElement("p",null,Object(p.a)("You are now ignoring %(userId)s",{userId:t})))})})))}}return ne(this.getUsage())},category:ee.actions}),new te({command:"unignore",args:"<user-id>",description:Object(p.c)("Stops ignoring a user, showing their messages going forward"),runFn:function(e,t){if(t){const e=h.a.get(),n=t.match(/(^@[^:]+:\S+$)/);if(n){const t=n[1],i=e.getIgnoredUsers(),s=i.indexOf(t);return-1!==s&&i.splice(s,1),ie(e.setIgnoredUsers(i).then((()=>{g.b.createDialog(V.a,{title:Object(p.a)("Unignored user"),description:o.createElement("div",null,o.createElement("p",null,Object(p.a)("You are no longer ignoring %(userId)s",{userId:t})))})})))}}return ne(this.getUsage())},category:ee.actions}),new te({command:"op",args:"<user-id> [<power-level>]",description:Object(p.c)("Define the power level of a user"),isEnabled(){const e=h.a.get(),t=e.getRoom(Y.b.instance.roomViewStore.getRoomId());return!(null==t||!t.currentState.maySendStateEvent(c.b.RoomPowerLevels,e.getUserId())||Object(J.a)(t))},runFn:function(e,t){if(t){const n=t.match(/^(\S+?)( +(-?\d+))?$/);let i=50;if(n){const t=n[1];if(4===n.length&&void 0!==n[3]&&(i=parseInt(n[3],10)),!isNaN(i)){const n=h.a.get(),s=n.getRoom(e);if(!s)return ne(Object(p.i)("Command failed: Unable to find room (%(roomId)s",{roomId:e}));const o=s.getMember(t);if(!o||Object(T.b)(o.membership)===T.a.Leave)return ne(Object(p.i)("Could not find user in room"));const r=s.currentState.getStateEvents("m.room.power_levels","");return ie(n.setPowerLevel(e,t,i,r))}}}return ne(this.getUsage())},category:ee.admin,renderingTypes:[H.a.Room]}),new te({command:"deop",args:"<user-id>",description:Object(p.c)("Deops user with given id"),isEnabled(){const e=h.a.get(),t=e.getRoom(Y.b.instance.roomViewStore.getRoomId());return!(null==t||!t.currentState.maySendStateEvent(c.b.RoomPowerLevels,e.getUserId())||Object(J.a)(t))},runFn:function(e,t){if(t){if(t.match(/^(\S+)$/)){const n=h.a.get(),i=n.getRoom(e);if(!i)return ne(Object(p.i)("Command failed: Unable to find room (%(roomId)s",{roomId:e}));const s=i.currentState.getStateEvents("m.room.power_levels","");return null!=s&&s.getContent().users[t]?ie(n.setPowerLevel(e,t,void 0,s)):ne(Object(p.i)("Could not find user in room"))}}return ne(this.getUsage())},category:ee.admin,renderingTypes:[H.a.Room]}),new te({command:"devtools",description:Object(p.c)("Opens the Developer Tools dialog"),runFn:function(e){return g.b.createDialog(F.a,{roomId:e},"mx_DevtoolsDialog_wrapper"),ie()},category:ee.advanced}),new te({command:"addwidget",args:"<url | embed code | Jitsi url>",description:Object(p.c)("Adds a custom widget by URL to the room"),isEnabled:()=>P.b.getValue(D.b.Widgets)&&Object($.a)(D.a.AddIntegrations)&&!oe(),runFn:function(e,t){if(!t)return ne(Object(p.i)("Please supply a widget URL or embed code"));if(t.toLowerCase().startsWith("<iframe ")){const e=Object(d.parseFragment)(t);if(e&&e.childNodes&&1===e.childNodes.length){const n=e.childNodes[0];if("iframe"===n.tagName.toLowerCase()&&n.attrs){const e=n.attrs.find((e=>"src"===e.name));u.a.log("Pulling URL out of iframe (embed code)"),t=e.value}}}if(!t.startsWith("https://")&&!t.startsWith("http://"))return ne(Object(p.i)("Please supply a https:// or http:// widget URL"));if(y.a.canUserModifyWidgets(e)){const n=h.a.get().getUserId(),i=(new Date).getTime(),s=encodeURIComponent(`${e}_${n}_${i}`);let o=O.a.CUSTOM,r="Custom",a={};const c=I.a.getInstance().parsePreferredConferenceUrl(t);return c&&(u.a.log("Making /addwidget widget a Jitsi conference"),o=O.a.JITSI,r="Jitsi",a=c,t=y.a.getLocalJitsiWrapperUrl()),ie(y.a.setRoomWidget(e,s,o,t,r,a))}return ne(Object(p.i)("You cannot modify widgets in this room."))},category:ee.admin,renderingTypes:[H.a.Room]}),new te({command:"verify",args:"<user-id> <device-id> <device-signing-key>",description:Object(p.c)("Verifies a user, session, and pubkey tuple"),runFn:function(e,t){if(t){const e=t.match(/^(\S+) +(\S+) +(\S+)$/);if(e){const t=h.a.get(),n=e[1],i=e[2],s=e[3];return ie((async()=>{const e=t.getStoredDevice(n,i);if(!e)throw Object(p.i)("Unknown (user, session) pair: (%(userId)s, %(deviceId)s)",{userId:n,deviceId:i});if((await t.checkDeviceTrust(n,i)).isVerified())throw e.getFingerprint()===s?Object(p.i)("Session already verified!"):Object(p.i)("WARNING: session already verified, but keys do NOT MATCH!");if(e.getFingerprint()!==s){const t=e.getFingerprint();throw Object(p.i)('WARNING: KEY VERIFICATION FAILED! The signing key for %(userId)s and session %(deviceId)s is "%(fprint)s" which does not match the provided key "%(fingerprint)s". This could mean your communications are being intercepted!',{fprint:t,userId:n,deviceId:i,fingerprint:s})}await t.setDeviceVerified(n,i,!0),g.b.createDialog(V.a,{title:Object(p.a)("Verified key"),description:o.createElement("div",null,o.createElement("p",null,Object(p.a)("The signing key you provided matches the signing key you received from %(userId)s's session %(deviceId)s. Session marked as verified.",{userId:n,deviceId:i})))})})())}}return ne(this.getUsage())},category:ee.advanced,renderingTypes:[H.a.Room]}),new te({command:"discardsession",description:Object(p.c)("Forces the current outbound group session in an encrypted room to be discarded"),isEnabled:()=>!oe(),runFn:function(e){try{h.a.get().forceDiscardSession(e)}catch(e){return ne(e.message)}return ie()},category:ee.advanced,renderingTypes:[H.a.Room]}),new te({command:"remakeolm",description:Object(p.c)("Developer command: Discards the current outbound group session and sets up new Olm sessions"),isEnabled:()=>P.b.getValue("developerMode")&&!oe(),runFn:e=>{try{const t=h.a.get().getRoom(e);return h.a.get().forceDiscardSession(e),ie(null==t?void 0:t.getEncryptionTargetMembers().then((e=>{var t;null===(t=h.a.get().crypto)||void 0===t||t.ensureOlmSessionsForUsers(e.map((e=>e.userId)),!0)})))}catch(e){return ne(e.message)}},category:ee.advanced,renderingTypes:[H.a.Room]}),new te({command:"rainbow",description:Object(p.c)("Sends the given message coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?se(l.makeHtmlMessage(t,Object(S.a)(t))):ne(this.getUsage())},category:ee.messages}),new te({command:"rainbowme",description:Object(p.c)("Sends the given emote coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?se(l.makeHtmlEmote(t,Object(S.a)(t))):ne(this.getUsage())},category:ee.messages}),new te({command:"help",description:Object(p.c)("Displays list of commands with usages and descriptions"),runFn:function(){return g.b.createDialog(K),ie()},category:ee.advanced}),new te({command:"whois",description:Object(p.c)("Displays information about a user"),args:"<user-id>",isEnabled:()=>!oe(),runFn:function(e,t){var n;if(!t||!t.startsWith("@")||!t.includes(":"))return ne(this.getUsage());const i=null===(n=h.a.get().getRoom(e))||void 0===n?void 0:n.getMember(t);return m.a.dispatch({action:x.a.ViewUser,member:i||{userId:t}}),ie()},category:ee.advanced}),new te({command:"rageshake",aliases:["bugreport"],description:Object(p.c)("Send a bug report with logs"),isEnabled:()=>!!j.b.get().bug_report_endpoint_url,args:"<description>",runFn:function(e,t){return ie(g.b.createDialog(R.a,{initialText:t}).finished)},category:ee.advanced}),new te({command:"tovirtual",description:Object(p.c)("Switches to this room's virtual room, if it has one"),category:ee.advanced,isEnabled:()=>!!M.b.instance.getSupportsVirtualRooms()&&!oe(),runFn:e=>ie((async()=>{const t=await q.a.sharedInstance().getVirtualRoomForRoom(e);if(!t)throw Object(p.i)("No virtual room for this room");m.a.dispatch({action:x.a.ViewRoom,room_id:t.roomId,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0})})())}),new te({command:"query",description:Object(p.c)("Opens chat with the given user"),args:"<user-id>",runFn:function(e,t){const n=t&&/^\+?[0123456789]+$/.test(t);return t&&(t.startsWith("@")&&t.includes(":")||n)?ie((async()=>{if(n){const e=await M.b.instance.pstnLookup(t);if(!e||0===e.length||!e[0].userid)throw Object(p.i)("Unable to find Matrix ID for phone number");t=e[0].userid}const e=await Object(k.c)(h.a.get(),t);m.a.dispatch({action:x.a.ViewRoom,room_id:e,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0})})()):ne(this.getUsage())},category:ee.actions}),new te({command:"msg",description:Object(p.c)("Sends a message to the given user"),args:"<user-id> [<message>]",runFn:function(e,t){if(t){const e=t.match(/^(\S+?)(?: +(.*))?$/s);if(e){const[t,n]=e.slice(1);if(t&&t.startsWith("@")&&t.includes(":"))return ie((async()=>{const e=h.a.get(),i=await Object(k.c)(e,t);m.a.dispatch({action:x.a.ViewRoom,room_id:i,metricsTrigger:"SlashCommand",metricsViaKeyboard:!0}),n&&e.sendTextMessage(i,n)})())}}return ne(this.getUsage())},category:ee.actions}),new te({command:"holdcall",description:Object(p.c)("Places the call in the current room on hold"),category:ee.other,isEnabled:()=>!oe(),runFn:function(e,t){const n=M.b.instance.getCallForRoom(e);return n?(n.setRemoteOnHold(!0),ie()):ne(Object(p.i)("No active call in this room"))},renderingTypes:[H.a.Room]}),new te({command:"unholdcall",description:Object(p.c)("Takes the call in the current room off hold"),category:ee.other,isEnabled:()=>!oe(),runFn:function(e,t){const n=M.b.instance.getCallForRoom(e);return n?(n.setRemoteOnHold(!1),ie()):ne(Object(p.i)("No active call in this room"))},renderingTypes:[H.a.Room]}),new te({command:"converttodm",description:Object(p.c)("Converts the room to a DM"),category:ee.other,isEnabled:()=>!oe(),runFn:function(e,t){const n=h.a.get().getRoom(e);return ie(Object(A.d)(n,!0))},renderingTypes:[H.a.Room]}),new te({command:"converttoroom",description:Object(p.c)("Converts the DM to a room"),category:ee.other,isEnabled:()=>!oe(),runFn:function(e,t){const n=h.a.get().getRoom(e);return ie(Object(A.d)(n,!1))},renderingTypes:[H.a.Room]}),new te({command:"me",args:"<message>",description:Object(p.c)("Displays action"),category:ee.messages,hideCompletionAfterSpace:!0}),...N.CHAT_EFFECTS.map((e=>new te({command:e.command,description:e.description(),args:"<message>",runFn:function(t,n){let i;return i=n?{msgtype:e.msgType,body:n}:l.makeEmoteMessage(e.fallbackMessage()),m.a.dispatch({action:`effects.${e.command}`}),se(i)},category:ee.effects,renderingTypes:[H.a.Room]})))],ae=new Map;function ce(e){if("/"!==(e=e.replace(/\s+$/,""))[0])return{};const t=e.match(/^(\S+?)(?:[ \n]+((.|\n)*))?$/);let n,i;return t?(n=t[1].substring(1).toLowerCase(),i=t[2]):n=e,{cmd:n,args:i}}function le(e){const{cmd:t,args:n}=ce(e);return t&&ae.has(t)&&ae.get(t).isEnabled()?{cmd:ae.get(t),args:n}:{}}re.forEach((e=>{ae.set(e.command,e),e.aliases.forEach((t=>{ae.set(t,e)}))}))},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.NOT_SENT="not_sent",e.ENCRYPTING="encrypting",e.SENDING="sending",e.QUEUED="queued",e.SENT="sent",e.CANCELLED="cancelled"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return d}));var i=n(13),s=n.n(i),o=n(189),r=n(361),a=n(159);let c;!function(e){e.New="Poll.new",e.End="Poll.end",e.Update="Poll.update",e.Responses="Poll.Responses",e.Destroy="Poll.Destroy",e.UndecryptableRelations="Poll.UndecryptableRelations"}(c||(c={}));const l=(e,t)=>({responseEvents:e.filter((e=>{if(!e.isDecryptionFailure())return o.d.matches(e.getType())&&e.getTs()<=t}))});class d extends a.b{constructor(e,t,n){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=n,s()(this,"roomId",void 0),s()(this,"pollEvent",void 0),s()(this,"_isFetchingResponses",!1),s()(this,"relationsNextBatch",void 0),s()(this,"responses",null),s()(this,"endEvent",void 0),s()(this,"undecryptableRelationEventIds",new Set),s()(this,"countUndecryptableEvents",(e=>{const t=e.filter((e=>e.isDecryptionFailure())).map((e=>e.getId())),n=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...t]),this.undecryptableRelationsCount!==n&&this.emit(c.UndecryptableRelations,this.undecryptableRelationsCount)})),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return null===(e=this.endEvent)||void 0===e?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}async getResponses(){return this.responses||this.isFetchingResponses||await this.fetchResponses(),this.responses}onNewRelation(e){var t;if(o.a.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(c.End)),!this.responses)return;const n=(null===(t=this.endEvent)||void 0===t?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:i}=l([e],n);this.countUndecryptableEvents([e]),i.length&&(i.forEach((e=>{this.responses.addEvent(e)})),this.emit(c.Responses,this.responses))}async fetchResponses(){var e,t;this._isFetchingResponses=!0;const n=await this.matrixClient.relations(this.roomId,this.rootEvent.getId(),"m.reference",void 0,{from:this.relationsNextBatch||void 0});await Promise.all(n.events.map((e=>this.matrixClient.decryptEventIfNeeded(e))));const i=this.responses||new r.a("m.reference",o.d.name,this.matrixClient,[o.d.altName]),s=n.events.find((e=>o.a.matches(e.getType())));this.validateEndEvent(s)&&(this.endEvent=s,this.refilterResponsesOnEnd(),this.emit(c.End));const a=(null===(e=this.endEvent)||void 0===e?void 0:e.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:d}=l(n.events,a);d.forEach((e=>{i.addEvent(e)})),this.relationsNextBatch=null!==(t=n.nextBatch)&&void 0!==t?t:void 0,this.responses=i,this.countUndecryptableEvents(n.events),this.relationsNextBatch?this.fetchResponses():this._isFetchingResponses=!1,this.emit(c.Responses,this.responses)}refilterResponsesOnEnd(){var e;if(!this.responses)return;const t=(null===(e=this.endEvent)||void 0===e?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach((e=>{var n;e.getTs()>t&&(null===(n=this.responses)||void 0===n||n.removeEvent(e))})),this.emit(c.Responses,this.responses)}validateEndEvent(e){if(!e)return!1;if(this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;const t=this.room.currentState,n=e.getSender();return!!n&&(n===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,n))}}},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.Get="GET",e.Put="PUT",e.Post="POST",e.Delete="DELETE"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"d",(function(){return a})),n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"c",(function(){return u}));var i=n(1025),s=n(1),o=n(16),r=n(363);function a(e){const t=new AbortController;return setTimeout((()=>{t.abort()}),e),t.signal}function c(e){const t=new AbortController;function n(){for(const t of e)t.removeEventListener("abort",i)}function i(){t.abort(),n()}for(const t of e){if(t.aborted){i();break}t.addEventListener("abort",i)}return{signal:t.signal,cleanup:n}}function l(e,t){var n,s;let o;try{o=function(e){let t;t=d(e)?e.getResponseHeader("Content-Type"):e.headers.get("Content-Type");if(!t)return null;try{return Object(i.parse)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e)}catch(e){return e}return"application/json"===(null===(n=o)||void 0===n?void 0:n.type)&&t?new r.c(JSON.parse(t),e.status,d(e)?e.responseURL:e.url):"text/plain"===(null===(s=o)||void 0===s?void 0:s.type)?new r.b(`Server returned ${e.status} error: ${t}`,e.status):new r.b(`Server returned ${e.status} error`,e.status)}function d(e){return"getResponseHeader"in e}async function u(e,t){let n=0,i=null;for(;n<e;)try{if(n>0){const e=1e3*Math.pow(2,n);s.a.log(`network operation failed ${n} times, retrying in ${e}ms...`),await Object(o.N)(e)}return await t()}catch(e){if(!(e instanceof r.a))throw e;n+=1,i=e}throw i}},function(e,t,n){"use strict";let i,s;n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return r})),function(e){e[e.Stable=0]="Stable",e[e.Unstable=1]="Unstable",e[e.Unsupported=2]="Unsupported"}(i||(i={})),function(e){e.Thread="Thread",e.ThreadUnreadNotifications="ThreadUnreadNotifications",e.LoginTokenRequest="LoginTokenRequest",e.RelationBasedRedactions="RelationBasedRedactions",e.AccountDataDeletion="AccountDataDeletion"}(s||(s={}));const o={[s.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[s.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[s.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[s.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[s.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]}};async function r(e){const t=new Map;for(const[c,l]of Object.entries(o)){var n,s,r,a;const o=null!==(n=null===(s=e.versions)||void 0===s?void 0:s.includes(l.matrixVersion||""))&&void 0!==n&&n,d=null!==(r=null===(a=l.unstablePrefixes)||void 0===a?void 0:a.every((t=>{var n;return!0===(null===(n=e.unstable_features)||void 0===n?void 0:n[t])})))&&void 0!==r&&r;o?t.set(c,i.Stable):d?t.set(c,i.Unstable):t.set(c,i.Unsupported)}return t}},,,,function(e,t,n){"use strict";n.d(t,"d",(function(){return o})),n.d(t,"a",(function(){return r})),n.d(t,"e",(function(){return a})),n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return l})),n.d(t,"f",(function(){return d})),n.d(t,"g",(function(){return u}));var i=n(13),s=n.n(i);const o=new Map,r=new Map;class a{constructor(e){s()(this,"userId",void 0),s()(this,"deviceId",void 0),s()(this,"crypto",void 0),s()(this,"olmDevice",void 0),s()(this,"baseApis",void 0),s()(this,"roomId",void 0),this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,n){}}class c{constructor(e){s()(this,"userId",void 0),s()(this,"crypto",void 0),s()(this,"olmDevice",void 0),s()(this,"baseApis",void 0),s()(this,"roomId",void 0),this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}async onRoomKeyEvent(e){}async importRoomKey(e,t){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){return!1}}class l extends Error{constructor(e,t,n){super(t),this.code=e,s()(this,"detailedString",void 0),this.code=e,this.name="DecryptionError",this.detailedString=function(e,t){let n=e.name+"[msg: "+e.message;t&&(n+=", "+Object.keys(t).map((e=>e+": "+t[e])).join(", "));return n+="]",n}(this,n)}}class d extends Error{constructor(e,t,n){super(e),this.devices=t,this.event=n,this.name="UnknownDeviceError",this.devices=t}}function u(e,t,n){o.set(e,t),r.set(e,n)}},function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return u})),n.d(t,"c",(function(){return h})),n.d(t,"a",(function(){return m}));var i,s,o,r,a,c,l,d=n(1);let u=null===(i=e.window)||void 0===i?void 0:i.crypto,h=null!==(s=null===(o=e.window)||void 0===o||null===(r=o.crypto)||void 0===r?void 0:r.subtle)&&void 0!==s?s:null===(a=e.window)||void 0===a||null===(c=a.crypto)||void 0===c?void 0:c.webkitSubtle,m=null===(l=e.window)||void 0===l?void 0:l.TextEncoder;if(!u)try{u=n(1044).webcrypto}catch(e){d.a.error("Failed to load webcrypto",e)}var p;h||(h=null===(p=u)||void 0===p?void 0:p.subtle);if(!m)try{m=n(516).TextEncoder}catch(e){d.a.error("Failed to load TextEncoder util",e)}}).call(this,n(14))},function(e,t,n){"use strict";(function(e,i){n.d(t,"e",(function(){return d})),n.d(t,"d",(function(){return u})),n.d(t,"b",(function(){return h})),n.d(t,"c",(function(){return m})),n.d(t,"a",(function(){return g}));var s=n(13),o=n.n(s),r=n(430),a=n(368),c=n(200),l=n(1);const d="m.qr_code.show.v1",u="m.qr_code.scan.v1";let h;!function(e){e.ShowReciprocateQr="show_reciprocate_qr"}(h||(h={}));class m extends r.b{constructor(){super(...arguments),o()(this,"reciprocateQREvent",void 0),o()(this,"doVerification",(async()=>{if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==(null==e?void 0:e.encodedSharedSecret))throw Object(a.d)();await new Promise(((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t(Object(a.h)())},this.emit(h.ShowReciprocateQr,this.reciprocateQREvent)}));const t={};switch(null==e?void 0:e.mode){case p.VerifyOtherUser:{const n=e.otherUserMasterKey;t[`ed25519:${n}`]=n;break}case p.VerifySelfTrusted:{const n=this.request.targetDevice.deviceId;t[`ed25519:${n}`]=e.otherDeviceKey;break}case p.VerifySelfUntrusted:{const n=e.myMasterKey;t[`ed25519:${n}`]=n;break}}await this.verifyKeys(this.userId,t,((e,n,i)=>{const s=t[e];if(!s)throw Object(a.d)();if(i!==s)throw l.a.error("key ID from key info does not match"),Object(a.d)();for(const e in n.keys){if(!e.startsWith("ed25519"))continue;const i=t[e];if(!i)throw Object(a.d)();if(n.keys[e]!==i)throw l.a.error("master key does not match"),Object(a.d)()}}))}))}static factory(e,t,n,i,s,o){return new m(e,t,n,i,s,o)}static get NAME(){return"m.reciprocate.v1"}}var p;!function(e){e[e.VerifyOtherUser=0]="VerifyOtherUser",e[e.VerifySelfTrusted=1]="VerifySelfTrusted",e[e.VerifySelfUntrusted=2]="VerifySelfUntrusted"}(p||(p={}));class g{constructor(e,t,n,i,s,o){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=n,this.otherDeviceKey=i,this.myMasterKey=s,this.buffer=o}static async create(e,t){const n=g.generateSharedSecret(),i=g.determineMode(e,t);let s=null,o=null,r=null;if(i===p.VerifyOtherUser){s=t.getStoredCrossSigningForUser(e.otherUserId).getId("master")}else if(i===p.VerifySelfTrusted)o=await g.getOtherDeviceKey(e,t);else if(i===p.VerifySelfUntrusted){const e=t.getUserId();r=t.getStoredCrossSigningForUser(e).getId("master")}const a=g.generateQrData(e,t,i,n,s,o,r),c=g.generateBuffer(a);return new g(i,n,s,o,r,c)}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){const t=new Uint8Array(11);return e.crypto.getRandomValues(t),Object(c.encodeUnpaddedBase64)(t)}static async getOtherDeviceKey(e,t){const n=t.getUserId(),i=e.targetDevice,s=i.deviceId?t.getStoredDevice(n,i.deviceId):void 0;if(!s)throw new Error("could not find device "+(null==i?void 0:i.deviceId));return s.getFingerprint()}static determineMode(e,t){const n=t.getUserId(),i=e.otherUserId;let s=p.VerifyOtherUser;if(n===i){s=t.checkUserTrust(n).isCrossSigningVerified()?p.VerifySelfTrusted:p.VerifySelfUntrusted}return s}static generateQrData(e,t,n,i,s,o,r){const a=t.getUserId(),c={prefix:"MATRIX",version:2,mode:n,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:i},l=t.getStoredCrossSigningForUser(a);return n===p.VerifyOtherUser?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=s):n===p.VerifySelfTrusted?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=o):n===p.VerifySelfUntrusted&&(c.firstKeyB64=t.getDeviceEd25519Key(),c.secondKeyB64=r),c}static generateBuffer(e){let t=i.alloc(0);const n=e=>{const n=i.from([e]);t=i.concat([t,n])},s=e=>{const n=i.alloc(2);n.writeInt16BE(e,0),t=i.concat([t,n])},o=function(e,n){let o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const r=i.from(e,n);o&&s(r.byteLength),t=i.concat([t,r])},r=e=>{const n=Object(c.decodeBase64)(e),s=i.from(n);t=i.concat([t,s])};return o(e.prefix,"ascii",!1),n(e.version),n(e.mode),o(e.transactionId,"utf-8"),r(e.firstKeyB64),r(e.secondKeyB64),r(e.secretB64),t}}}).call(this,n(14),n(53).Buffer)},function(e,t,n){"use strict";n.d(t,"a",(function(){return m})),n.d(t,"c",(function(){return p})),n.d(t,"b",(function(){return g}));var i=n(13),s=n.n(i),o=n(144),r=n(130),a=n(1),c=n(365),l=n(368),d=n(367),u=n(159);const h=new Error("Verification timed out");class m extends Error{constructor(e){super(),this.startEvent=e}}let p;!function(e){e.Cancel="cancel"}(p||(p={}));class g extends u.b{constructor(e,t,n,i,o,r){super(),this.channel=e,this.baseApis=t,this.userId=n,this.deviceId=i,this.startEvent=o,this.request=r,s()(this,"cancelled",!1),s()(this,"_done",!1),s()(this,"promise",null),s()(this,"transactionTimeoutTimer",null),s()(this,"expectedEvent",void 0),s()(this,"resolve",void 0),s()(this,"reject",void 0),s()(this,"resolveEvent",void 0),s()(this,"rejectEvent",void 0),s()(this,"started",void 0),s()(this,"doVerification",void 0)}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){a.a.info("Refreshing/starting the verification transaction timeout timer"),null!==this.transactionTimeoutTimer&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout((()=>{this._done||this.cancelled||(a.a.info("Triggering verification timeout"),this.cancel(h))}),6e5)}endTimer(){null!==this.transactionTimeoutTimer&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise(((e,t)=>{this.resolveEvent=e,this.rejectEvent=t})))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(a.a.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){const t=this.rejectEvent;this.rejectEvent=void 0,t(new m(e))}else this.startEvent=e}handleEvent(e){var t;if(!this._done)if(e.getType()===this.expectedEvent)this.expectedEvent!==r.b.KeyVerificationDone&&(this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),null===(t=this.resolveEvent)||void 0===t||t.call(this,e));else if(e.getType()===r.b.KeyVerificationCancel){const t=this.reject;if(this.reject=void 0,t){const n=e.getContent(),{reason:i,code:s}=n;t(new Error(`Other side cancelled verification because ${i} (${s})`))}}else if(this.expectedEvent){const t=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){const e=this.rejectEvent;this.rejectEvent=void 0,e(t)}this.cancel(t)}}async done(){var e;if(this.endTimer(),!this._done)return this.request.onVerifierFinished(),null===(e=this.resolve)||void 0===e||e.call(this),Object(d.e)(this.baseApis,this.userId,this.deviceId)}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===h){const e=Object(l.e)();this.send(e.getType(),e.getContent())}else if(e instanceof o.b){if(e.getSender()!==this.userId){const t=e.getContent();e.getType()===r.b.KeyVerificationCancel?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this.send(r.b.KeyVerificationCancel,t)):this.send(r.b.KeyVerificationCancel,{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this.send(r.b.KeyVerificationCancel,{code:"m.unknown",reason:e.toString()});null!==this.promise?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(p.Cancel,e)}}verify(){var e=this;return this.promise||(this.promise=new Promise(((t,n)=>{this.resolve=function(){e._done=!0,e.endTimer(),t(...arguments)},this.reject=e=>{this._done=!0,this.endTimer(),n(e)}})),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise(((e,t)=>{var n;(null===(n=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))||void 0===n?void 0:n.getId())===this.deviceId&&t(new Error("Device ID is the same as the cross-signing ID")),e()})).then((()=>this.doVerification())).then(this.done.bind(this),this.cancel.bind(this)))),this.promise}async verifyKeys(e,t,n){const i=[];for(const[s,o]of Object.entries(t)){const t=s.split(":",2)[1],r=this.baseApis.getStoredDevice(e,t);if(r)n(s,r,o),i.push([t,s,r.keys[s]]);else{const r=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);r&&r.getId()===t?(n(s,c.a.fromStorage({keys:{[s]:t}},t),o),i.push([t,s,t])):a.a.warn(`verification: Could not find device ${t} to verify`)}}if(!i.length)throw new Error("No devices could be verified");a.a.info("Verification completed! Marking devices verified: ",i);for(const[t,n,s]of i)await this.baseApis.crypto.setDeviceVerification(e,t,!0,null,null,{[n]:s});e==this.baseApis.credentials.userId&&await this.baseApis.checkKeyBackup()}get events(){}}},function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return c})),n.d(t,"a",(function(){return l}));var i=n(225),s=n(428);const o=5e5,r=256;function a(t,n){if(!e.Olm)throw new Error("Olm is not available");if(!t.private_key_salt||!t.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return l(n,t.private_key_salt,t.private_key_iterations,t.private_key_bits||r)}async function c(t){if(!e.Olm)throw new Error("Olm is not available");const n=Object(i.b)(32);return{key:await l(t,n,o,r),salt:n,iterations:o}}async function l(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r;if(!s.c||!s.a)throw new Error("Password-based backup is not available on this platform");const o=await s.c.importKey("raw",(new s.a).encode(e),{name:"PBKDF2"},!1,["deriveBits"]),a=await s.c.deriveBits({name:"PBKDF2",salt:(new s.a).encode(t),iterations:n,hash:"SHA-512"},o,i);return new Uint8Array(a)}}).call(this,n(14))},function(e,t,n){"use strict";(function(e,i){n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var s=n(1047);const o=[139,1];function r(t){var n;const i=e.alloc(o.length+t.length+1);i.set(o,0),i.set(t,o.length);let r=0;for(let e=0;e<i.length-1;++e)r^=i[e];i[i.length-1]=r;return null===(n=s.encode(i).match(/.{1,4}/g))||void 0===n?void 0:n.join(" ")}function a(e){const t=s.decode(e.replace(/ /g,""));let n=0;for(const e of t)n^=e;if(0!==n)throw new Error("Incorrect parity");for(let e=0;e<o.length;++e)if(t[e]!==o[e])throw new Error("Incorrect prefix");if(t.length!==o.length+i.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(o.length,o.length+i.Olm.PRIVATE_KEY_LENGTH))}}).call(this,n(53).Buffer,n(14))},function(e,t,n){"use strict";var i;let s;n.d(t,"a",(function(){return s})),function(e){e.RoomId="room_id",e.Sender="sender"}(i||(i={})),function(e){e.Recent="recent",e.Rank="rank"}(s||(s={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(13),s=n.n(i),o=n(16),r=n(1),a=n(130),c=n(196);const l=!1;class d{static RETRY_BACKOFF_RATELIMIT(e,t,n){if(400===n.httpStatus||403===n.httpStatus||401===n.httpStatus)return-1;if(n instanceof c.b)return-1;if("M_TOO_LARGE"===n.name)return-1;if("M_LIMIT_EXCEEDED"===n.name){const e=n.data.retry_after_ms;if(e>0)return e}return t>4?-1:1e3*Math.pow(2,t)}static QUEUE_MESSAGES(e){return e.getType()===a.b.RoomMessage||e.hasAssociation()?"message":null}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:d.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:d.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,s()(this,"queues",{}),s()(this,"activeQueues",[]),s()(this,"procFn",null),s()(this,"processQueue",(e=>{const t=this.peekNextEvent(e);t?(u("Queue '%s' has %s pending events",e,this.queues[e].length),Promise.resolve().then((()=>this.procFn(t.event))).then((n=>{this.removeNextEvent(e),u("Queue '%s' sent event %s",e,t.event.getId()),t.defer.resolve(n),this.processQueue(e)}),(n=>{t.attempts+=1;const i=this.retryAlgorithm(t.event,t.attempts,n);u("retry(%s) err=%s event_id=%s waitTime=%s",t.attempts,n,t.event.getId(),i),-1===i?(u("Queue '%s' giving up on event %s",e,t.event.getId()),this.clearQueue(e,n)):setTimeout(this.processQueue,i,e)}))):this.disableQueue(e)}))}getQueueForEvent(e){const t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map((function(e){return e.event})):null}removeEventFromQueue(e){const t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;let n=!1;return o.I(this.queues[t],(t=>t.event.getId()===e.getId()&&(n=!0,!0))),n}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){const t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);const n=o.m();return this.queues[t].push({event:e,defer:n,attempts:0}),u("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),this.startProcessingQueues(),n.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter((e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0)).forEach((e=>{this.activeQueues.push(e),u("Spinning up queue: '%s'",e),this.processQueue(e)}))}disableQueue(e){const t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),u("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){let n;for(u("clearing queue '%s'",e);n=this.removeNextEvent(e);)n.defer.reject(t);this.disableQueue(e)}peekNextEvent(e){const t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){const t=this.queues[e];if(Array.isArray(t))return t.shift()}}function u(){l&&r.a.log(...arguments)}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return u}));var i=n(13),s=n.n(i),o=n(1),r=n(16);const a="m.login.email.identity",c="m.login.msisdn";let l;!function(e){e.Password="m.login.password",e.Recaptcha="m.login.recaptcha",e.Terms="m.login.terms",e.Email="m.login.email.identity",e.Msisdn="m.login.msisdn",e.Sso="m.login.sso",e.SsoUnstable="org.matrix.login.sso",e.Dummy="m.login.dummy",e.RegistrationToken="m.login.registration_token",e.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token"}(l||(l={}));class d extends Error{constructor(e,t,n){super(e),this.required_stages=t,this.flows=n,s()(this,"name","NoAuthFlowFoundError")}}class u{constructor(e){s()(this,"matrixClient",void 0),s()(this,"inputs",void 0),s()(this,"clientSecret",void 0),s()(this,"requestCallback",void 0),s()(this,"busyChangedCallback",void 0),s()(this,"stateUpdatedCallback",void 0),s()(this,"requestEmailTokenCallback",void 0),s()(this,"data",void 0),s()(this,"emailSid",void 0),s()(this,"requestingEmailToken",!1),s()(this,"attemptAuthDeferred",null),s()(this,"chosenFlow",null),s()(this,"currentStage",null),s()(this,"emailAttempt",1),s()(this,"submitPromise",null),s()(this,"requestEmailToken",(async()=>{if(this.requestingEmailToken)o.a.warn("Could not request email token: Already requesting");else{o.a.trace("Requesting email token. Attempt: "+this.emailAttempt),this.requestingEmailToken=!0;try{const e=await this.requestEmailTokenCallback(this.inputs.emailAddress,this.clientSecret,this.emailAttempt++,this.data.session);this.emailSid=e.sid,o.a.trace("Email token request succeeded")}finally{this.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid}attemptAuth(){var e;this.attemptAuthDeferred=Object(r.m)();const t=this.attemptAuthDeferred.promise;if(null!==(e=this.data)&&void 0!==e&&e.flows)this.startNextAuthStage();else{var n;null===(n=this.busyChangedCallback)||void 0===n||n.call(this,!0);const e=this.data.session?{session:this.data.session}:null;this.doRequest(e).finally((()=>{var e;null===(e=this.busyChangedCallback)||void 0===e||e.call(this,!1)}))}return t}async poll(){if(!this.data.session)return;if(!this.attemptAuthDeferred)return;if(this.submitPromise)return;let e={};if(this.currentStage==a&&this.emailSid){const t={sid:this.emailSid,client_secret:this.clientSecret};if(await this.matrixClient.doesServerRequireIdServerParam()){const e=new URL(this.matrixClient.getIdentityServerUrl());t.id_server=e.host}e={type:a,threepid_creds:t,threepidCreds:t}}this.submitAuthDict(e,!0)}getSessionId(){var e;return null===(e=this.data)||void 0===e?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return null===(t=this.data.params)||void 0===t?void 0:t[e]}getChosenFlow(){return this.chosenFlow}async submitAuthDict(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");var n;t||(null===(n=this.busyChangedCallback)||void 0===n||n.call(this,!0));for(;this.submitPromise;)try{await this.submitPromise}catch(e){}let i;this.data.session?(i={session:this.data.session},Object.assign(i,e)):i=e;try{this.submitPromise=this.doRequest(i,t),await this.submitPromise}finally{var s;if(this.submitPromise=null,!t)null===(s=this.busyChangedCallback)||void 0===s||s.call(this,!1)}}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}async doRequest(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{const n=await this.requestCallback(e,t);this.attemptAuthDeferred.resolve(n),this.attemptAuthDeferred=null}catch(e){var n,i,s;const a=null!==(n=null===(i=e.data)||void 0===i?void 0:i.flows)&&void 0!==n?n:null,c=this.data.flows||Boolean(a);var r;if(401!==e.httpStatus||!e.data||!c)if(t)o.a.log("Background poll request failed doing UI auth: ignoring",e);else null===(r=this.attemptAuthDeferred)||void 0===r||r.reject(e);e.data||(e.data={}),e.data.flows||e.data.completed||e.data.session||(e.data.flows=this.data.flows,e.data.completed=this.data.completed,e.data.session=this.data.session),this.data=e.data;try{this.startNextAuthStage()}catch(e){return this.attemptAuthDeferred.reject(e),void(this.attemptAuthDeferred=null)}if(!this.emailSid&&null!==(s=this.chosenFlow)&&void 0!==s&&s.stages.includes(l.Email))try{await this.requestEmailToken()}catch(e){this.attemptAuthDeferred.reject(e),this.attemptAuthDeferred=null}}}startNextAuthStage(){var e,t;const n=this.chooseStage();if(!n)throw new Error("No incomplete flows from the server");var i,s;(this.currentStage=n,n!==l.Dummy)?null!==(e=this.data)&&void 0!==e&&e.errcode||null!==(t=this.data)&&void 0!==t&&t.error?this.stateUpdatedCallback(n,{errcode:(null===(i=this.data)||void 0===i?void 0:i.errcode)||"",error:(null===(s=this.data)||void 0===s?void 0:s.error)||""}):this.stateUpdatedCallback(n,n===a?{emailSid:this.emailSid}:{}):this.submitAuthDict({type:"m.login.dummy"})}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),o.a.log("Active flow => %s",JSON.stringify(this.chosenFlow));const e=this.firstUncompletedStage(this.chosenFlow);return o.a.log("Next stage: %s",e),e}chooseFlow(){const e=this.data.flows||[],t=Boolean(this.inputs.emailAddress)||Boolean(this.emailSid),n=Boolean(this.inputs.phoneCountry)&&Boolean(this.inputs.phoneNumber);for(const i of e){let e=!1,s=!1;for(const t of i.stages)t===a?e=!0:t==c&&(s=!0);if(e==t&&s==n)return i}const i=[];throw t&&i.push(a),n&&i.push(c),new d("No appropriate authentication flow found",i,e)}firstUncompletedStage(e){const t=this.data.completed||[];return e.stages.find((e=>!t.includes(e)))}}},,function(e,t,n){"use strict";var i;!function(e){e.HomePage="home_page",e.RoomView="room_view",e.UserView="user_view"}(i||(i={})),t.a=i},,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(122),s=n.n(i),o=n(329);class r extends o.a{static set matrixClient(e){const t=r._matrixClient;r._matrixClient=e;for(const n of r.instances)n.initMatrixClient(t,e)}constructor(){super(),r.instances.push(this)}get client(){return r._matrixClient}}s()(r,"_matrixClient",void 0),s()(r,"instances",[])},function(e,t,n){"use strict";n.d(t,"f",(function(){return m})),n.d(t,"a",(function(){return p})),n.d(t,"e",(function(){return g})),n.d(t,"c",(function(){return b})),n.d(t,"d",(function(){return y})),n.d(t,"b",(function(){return S}));var i=n(523),s=n(504),o=n(227),r=n(1);const a=window.localStorage;let c;try{c=window.indexedDB}catch(e){}const l="riot-web-sync",d="matrix-js-sdk:crypto";function u(e){r.a.log(`StorageManager: ${e}`)}function h(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];r.a.error(`StorageManager: ${e}`,...n)}function m(){navigator.storage&&navigator.storage.persist?navigator.storage.persist().then((e=>{r.a.log("StorageManager: Persistent?",e)})):document.requestStorageAccess?document.requestStorageAccess().then((()=>r.a.log("StorageManager: Persistent?",!0)),(()=>r.a.log("StorageManager: Persistent?",!1))):r.a.log("StorageManager: Persistence unsupported")}async function p(){u("Checking storage consistency"),u(`Local storage supported? ${!!a}`),u(`IndexedDB supported? ${!!c}`);let e=!1,t=!1,n=!1,r=!0;if(a?(e=a.length>0,u(`Local storage contains data? ${e}`),n=!!a.getItem("mx_crypto_initialised"),u(`Crypto initialised? ${n}`)):(r=!1,h("Local storage cannot be used on this browser")),c&&a){(await async function(){let e=!1;try{return e=await s.a.exists(c,l),u(`Sync store using IndexedDB contains data? ${e}`),{exists:e,healthy:!0}}catch(e){h("Sync store using IndexedDB inaccessible",e)}return u("Sync store using memory only"),{exists:e,healthy:!1}}()).healthy||(r=!1)}else r=!1,h("Sync store cannot be used on this browser");if(c){const e=await async function(){let e=!1;try{return e=await o.a.exists(c,d),u(`Crypto store using IndexedDB contains data? ${e}`),{exists:e,healthy:!0}}catch(e){h("Crypto store using IndexedDB inaccessible",e)}try{return e=i.a.exists(a),u(`Crypto store using local storage contains data? ${e}`),{exists:e,healthy:!0}}catch(e){h("Crypto store using local storage inaccessible",e)}return u("Crypto store using memory only"),{exists:e,healthy:!1}}();t=e.exists,e.healthy||(r=!1)}else r=!1,h("Crypto store cannot be used on this browser");return e&&n&&!t&&(r=!1,h("Data exists in local storage and crypto is marked as initialised  but no data found in crypto store. IndexedDB storage has likely been evicted by the browser!")),r?u("Storage consistency checks passed"):h("Storage consistency checks failed"),{dataInLocalStorage:e,dataInCryptoStore:t,cryptoInited:n,healthy:r}}function g(e){a.setItem("mx_crypto_initialised",String(e))}let v=null;async function f(){if(!c)throw new Error("IndexedDB not available");v=await new Promise(((e,t)=>{const n=c.open("matrix-react-sdk",1);n.onerror=t,n.onsuccess=()=>{e(n.result)},n.onupgradeneeded=()=>{const e=n.result;e.createObjectStore("pickleKey"),e.createObjectStore("account")}}))}async function b(e,t){return v||await f(),new Promise(((n,i)=>{const s=v.transaction([e],"readonly");s.onerror=i;const o=s.objectStore(e).get(t);o.onerror=i,o.onsuccess=e=>{n(o.result)}}))}async function y(e,t,n){return v||await f(),new Promise(((i,s)=>{const o=v.transaction([e],"readwrite");o.onerror=s;const r=o.objectStore(e).put(n,t);r.onerror=s,r.onsuccess=e=>{i()}}))}async function S(e,t){return v||await f(),new Promise(((n,i)=>{const s=v.transaction([e],"readwrite");s.onerror=i;const o=s.objectStore(e).delete(t);o.onerror=i,o.onsuccess=()=>{n()}}))}},function(e,t,n){"use strict";n.d(t,"c",(function(){return a})),n.d(t,"d",(function(){return c})),n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return d}));var i=n(276),s=n(1),o=n(132),r=n(123);function a(){return o.b.get("validated_server_config").isUrl}function c(){const e=a();r.a.get().setAccountData("m.identity_server",{base_url:e})}async function l(e){var t;let n;try{n=await r.a.get().getTerms(i.a.IS,e)}catch(e){if(s.a.error(e),"rejected"!==e.cors&&404!==e.httpStatus)throw e;n=null}return!(null===(t=n)||void 0===t||!t.policies)&&Object.keys(n.policies).length>0}function d(){const e=r.a.get().getAccountData("m.identity_server");return e&&e.getContent()&&e.getContent().base_url}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a}));const i=/^\S+@\S+\.\S+$/,s=/^@\S+:\S+$/,o=/^!\S+:\S+$/;let r;function a(e){return i.test(e)?r.Email:s.test(e)?r.MatrixUserId:o.test(e)?r.MatrixRoomId:null}!function(e){e.Email="email",e.MatrixUserId="mx-user-id",e.MatrixRoomId="mx-room-id"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return d}));var i=n(130),s=n(123),o=n(376),r=n(246);function a(e){const t=e.getType(),n=e.getContent(),s=e.getPrevContent();return t===i.b.RoomMember&&s.membership!==n.membership||(t!==i.b.RoomMember||s.displayname===n.displayname)&&(t!==i.b.RoomMember||s.avatar_url===n.avatar_url)}const c=e=>{let t="";s.a.get()&&(t=s.a.get().getUserId());const n={};return e.sort(((e,i)=>{var s,o;const r=null!==(s=n[e.roomId])&&void 0!==s?s:l(e,t),a=null!==(o=n[i.roomId])&&void 0!==o?o:l(i,t);return n[e.roomId]=r,n[i.roomId]=a,a-r}))},l=(e,t)=>{const n=(()=>{var n,s;if(null==e||!e.timeline)return Number.MAX_SAFE_INTEGER;if(Object(r.b)(e.getMyMembership())!==r.a.Join){const n=e.currentState.getStateEvents(i.b.RoomMember,t);if(n&&!Array.isArray(n))return n.getTs()}for(let n=e.timeline.length-1;n>=0;--n){const i=e.timeline[n];if(i.getTs()&&(i.getSender()===t&&a(i)||o.c(i)))return i.getTs()}return null!==(n=null===(s=e.timeline[0])||void 0===s?void 0:s.getTs())&&void 0!==n?n:Number.MAX_SAFE_INTEGER})(),s=e.getThreads().map((e=>{var t,n;const i=null!==(t=e.replyToEvent)&&void 0!==t?t:e.rootEvent;return null!==(n=null==i?void 0:i.getTs())&&void 0!==n?n:0}));return Math.max(n,...s)};class d{sortRooms(e,t){return c(e)}getLastTs(e,t){return l(e,t)}}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var i=n(121);let s;!function(e){e.MapStyleUrlNotConfigured="MapStyleUrlNotConfigured",e.MapStyleUrlNotReachable="MapStyleUrlNotReachable",e.Default="Default"}(s||(s={}));const o=e=>{switch(e){case s.MapStyleUrlNotConfigured:return Object(i.a)("This homeserver is not configured to display maps.");case s.MapStyleUrlNotReachable:default:return Object(i.a)("This homeserver is not configured correctly to display maps, or the configured map server may be unreachable.")}}},,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(170);const d=["children","label","active","disabled"],u=e=>{let{children:t,label:n,active:i,disabled:o}=e,a=r()(e,d);return c.a.createElement(l.a,s()({},a,{role:"menuitemradio","aria-checked":i,"aria-disabled":o,disabled:o,"aria-label":n}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(144),s=n(1),o=n(123),r=n(125);class a{static resendUnsentEvents(e){return Promise.all(e.getPendingEvents().filter((function(e){return e.status===i.a.NOT_SENT})).map((function(e){return a.resend(e)})))}static cancelUnsentEvents(e){e.getPendingEvents().filter((function(e){return e.status===i.a.NOT_SENT})).forEach((function(e){a.removeFromQueue(e)}))}static resend(e){const t=o.a.get().getRoom(e.getRoomId());return o.a.get().resendEvent(e,t).then((function(t){r.a.dispatch({action:"message_sent",event:e})}),(function(e){s.a.log("Resend got send failure: "+e.name+"("+e+")")}))}static removeFromQueue(e){o.a.get().cancelPendingEvent(e)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{constructor(e){this.wireFormat=e}get wireContent(){return this.wireFormat.content}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(197),s=n.n(i);let o;!function(e){e.Uniform="uniform",e.PowerLevel="powerlevel",e.MXID="mxid"}(o||(o={}));s.a.oneOf(Object.values(o))},function(e,t,n){"use strict";n.d(t,"f",(function(){return u})),n.d(t,"d",(function(){return h})),n.d(t,"e",(function(){return m})),n.d(t,"a",(function(){return g})),n.d(t,"b",(function(){return v})),n.d(t,"c",(function(){return f}));var i=n(120),s=n.n(i),o=n(121),r=n(140),a=n(238),c=n(133),l=n(201),d=n(578);const u=e=>JSON.stringify(e,null,2),h=e=>({id:"eventType",label:Object(o.c)("Event Type"),default:e}),m=e=>({id:"stateKey",label:Object(o.c)("State Key"),default:e}),p=Object(l.a)({deriveData(e){let{value:t}=e;try{JSON.parse(t)}catch(e){return e}},rules:[{key:"validJson",test:(e,t)=>{let{value:n}=e;return!n||!t},invalid:e=>Object(o.a)("Doesn't look like valid JSON.")+" "+e}]}),g=e=>{let{fieldDefs:t,defaultContent:n="{\n\n}",onSend:c,onBack:l}=e;const[d,u]=Object(i.useState)(t.map((e=>{var t;return null!==(t=e.default)&&void 0!==t?t:""}))),[h,m]=Object(i.useState)(n),g=Object(i.useRef)(),v=t.map(((e,t)=>s.a.createElement(r.a,{key:e.id,id:e.id,label:Object(o.a)(e.label),size:42,autoFocus:void 0===n&&0===t,type:"text",autoComplete:"on",value:d[t],onChange:e=>u((n=>(n[t]=e.target.value,[...n])))})));return s.a.createElement(a.b,{actionLabel:Object(o.a)("Send"),onAction:async()=>{if(!await g.current.validate({}))return g.current.focus(),void g.current.validate({focused:!0});try{const e=JSON.parse(h);await c(d,e)}catch(e){return Object(o.a)("Failed to send event!")+` (${e.toString()})`}return Object(o.a)("Event sent!")},onBack:l},s.a.createElement("div",{className:"mx_DevTools_eventTypeStateKeyGroup"},v),s.a.createElement(r.a,{id:"evContent",label:Object(o.a)("Event Content"),type:"text",className:"mx_DevTools_textarea",autoComplete:"off",value:h,onChange:e=>m(e.target.value),element:"textarea",onValidate:p,ref:g,autoFocus:!!n}))},v=e=>{let{mxEvent:t,onBack:n,Editor:r}=e;const[c,l]=Object(i.useState)(!1);if(c){const e=()=>{l(!1)};return s.a.createElement(r,{mxEvent:t,onBack:e})}return s.a.createElement(a.b,{onBack:n,actionLabel:Object(o.a)("Edit"),onAction:async()=>{l(!0)}},s.a.createElement(d.a,{language:"json"},u(t.event)))},f=e=>{let{mxEvent:t,onBack:n}=e;const o=Object(i.useContext)(a.a),r=Object(i.useContext)(c.a),l=Object(i.useMemo)((()=>[h(null==t?void 0:t.getType())]),[t]);let d;if(t){var m,p;const e=t.getContent(),n=null!==(m=null===(p=e["m.new_content"])||void 0===p?void 0:p.body)&&void 0!==m?m:e.body,i={body:` * ${n}`,msgtype:e.msgtype,"m.new_content":{body:n,msgtype:e.msgtype},"m.relates_to":{rel_type:"m.replace",event_id:(v=t,null!==(b=null===(y=(null!==(f=v.replacingEvent())&&void 0!==f?f:v).getWireContent()["m.relates_to"])||void 0===y?void 0:y.event_id)&&void 0!==b?b:v.getId())}};d=u(i)}var v,f,b,y;return s.a.createElement(g,{fieldDefs:l,defaultContent:d,onSend:(e,t)=>{let[n]=e;return r.sendEvent(o.room.roomId,n,t)},onBack:n})}},function(e,t,n){"use strict";var i=n(122),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n(1423),l=n(127),d=n.n(l),u=n(121),h=n(135);const m=["data","className"];function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const v={errorCorrectionLevel:"L"};t.a=e=>{let{data:t,className:n}=e,i=r()(e,m);const[s,o]=a.useState(null);return a.useEffect((()=>{let e=!1;return Object(c.toDataURL)(t,g(g({},v),i)).then((t=>{e||o(t)})),()=>{e=!0}}),[JSON.stringify(t),i]),a.createElement("div",{className:d()("mx_QRCode",n)},s?a.createElement("img",{src:s,className:"mx_VerificationQRCode",alt:Object(u.a)("QR Code")}):a.createElement(h.a,null))}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return c})),n.d(t,"c",(function(){return l})),n.d(t,"b",(function(){return h})),n.d(t,"d",(function(){return m}));var i=n(16),s=n(121),o=n(126),r=n(336);const a={light:"light-high-contrast"};function c(){const e={light:"SC "+Object(s.a)("Light"),"light-high-contrast":Object(s.a)("Light high contrast"),dark:"SC "+Object(s.a)("Dark")},t=o.b.getValue("custom_themes"),n={};for(const{name:e}of t)n[`custom-${e}`]=e;return Object.assign({},n,e)}function l(){const e=Object.entries(c()).map((e=>({id:e[0],name:e[1]}))).filter((e=>{return t=e.id,!Object.values(a).includes(t);var t})),t=e.filter((e=>!e.id.startsWith("custom-"))),n=e.filter((e=>!t.includes(e))).sort(((e,t)=>Object(i.h)(e.name,t.name)));return[...t,...n]}const d=["font-display","font-family","font-stretch","font-style","font-weight","font-variant","font-feature-settings","font-variation-settings","src","unicode-range"];function u(e){const{style:t}=document.body;function n(e,n){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];t.setProperty(`--${e}`,n),i&&(t.setProperty(`--${e}-0pct`,n+"00"),t.setProperty(`--${e}-15pct`,n+"26"),t.setProperty(`--${e}-50pct`,n+"7F"))}if(e.colors)for(const[t,i]of Object.entries(e.colors))if(Array.isArray(i))for(let e=0;e<i.length;e+=1)n(`${t}_${e}`,i[e],!1);else n(t,i);if(e.fonts){const{fonts:n}=e;if(n.faces){const e=n.faces.map((e=>{var t;const n=null===(t=e.src)||void 0===t?void 0:t.map((e=>{let t="";return e.format&&(t=`format("${e.format}")`),e.url?`url("${e.url}") ${t}`:e.local?`local("${e.local}") ${t}`:""})).join(", ");return`@font-face {${Object.keys(e).filter((e=>d.includes(e))).map((t=>{let i;return i="src"===t?n:"font-family"===t?`"${e[t]}"`:e[t],`${t}: ${i}`})).join(";")}}`})).join("\n"),t=document.createElement("style");t.setAttribute("title","custom-theme-font-faces"),t.setAttribute("type","text/css"),t.appendChild(document.createTextNode(e)),document.head.appendChild(t)}n.general&&t.setProperty("--font-family",n.general),n.monospace&&t.setProperty("--font-family-monospace",n.monospace)}}function h(e){const t=o.b.getValue("custom_themes");if(!t)throw new Error(`No custom themes set, can't set custom theme "${e}"`);const n=t.find((t=>t.name===e));if(!n){const n=t.map((e=>e.name)).join(", ");throw new Error(`Can't find custom theme "${e}", only know ${n}`)}return n}async function m(t){if(!t){t=(new r.a).getEffectiveTheme()}!function(){const e=Object.values(document.body.style);for(const t of e)t.startsWith("--")&&document.body.style.removeProperty(t);const t=document.querySelector("head > style[title='custom-theme-font-faces']");t&&t.remove()}();let n=t;if(t.startsWith("custom-")){const e=h(t.slice(7));n=e.is_dark?"dark-custom":"light-custom",u(e)}const i=new Map;if(Array.from(document.querySelectorAll("[data-mx-theme]")).forEach((e=>{i.set(e.dataset.mxTheme.toLowerCase(),e)})),!i.has(n))throw new Error("Unknown theme "+n);const s=i.get(n);return s.disabled=!1,new Promise(((t,n)=>{const o=function(){s.disabled=!1,i.forEach((e=>{e!=s&&(e.disabled=!0)}));const n=e.getComputedStyle(document.body);if(n.backgroundColor){document.querySelector('meta[name="theme-color"]').content=n.backgroundColor}t()},r=()=>Boolean([...document.styleSheets].find((e=>(null==e?void 0:e.href)===s.href)));!function(){if(r())return void o();let e=0;const t=window.setInterval((()=>{r()&&(clearInterval(t),s.onload=null,s.onerror=null,o()),e++,10===e&&(clearInterval(t),n())}),200);s.onload=()=>{clearInterval(t),o()},s.onerror=e=>{clearInterval(t),n(e)}}()}))}}).call(this,n(14))},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return B}));var i=n(131),s=n.n(i),o=n(122),r=n.n(o),a=n(120),c=n.n(a),l=n(141),d=n(127),u=n.n(d),h=n(170),m=n(124),p=n(125),g=n(129),v=n(121),f=n(151),b=n(192),y=n(683),S=n(322),E=n(269),w=n(123),_=n(880),C=n(250),O=n(218),I=n(268),R=n(148),k=n(503),x=n(630),T=n(631),j=n(162),P=n(143),D=n(153),N=n(1554),M=n(881),A=n(310),L=n(155),U=n(195);const F=e=>`mx_RoomTile_messagePreview_${e}`,B=e=>({left:e.left+window.scrollX-9,top:e.bottom+window.scrollY+17,chevronFace:f.a.None});class V extends c.a.PureComponent{constructor(t){super(t),r()(this,"dispatcherRef",void 0),r()(this,"roomTileRef",Object(a.createRef)()),r()(this,"notificationState",void 0),r()(this,"roomProps",void 0),r()(this,"onRoomNameUpdate",(e=>{this.forceUpdate()})),r()(this,"onNotificationUpdate",(()=>{this.forceUpdate()})),r()(this,"onRoomPropertyUpdate",(e=>{e===x.a.NotificationVolume&&this.onNotificationUpdate()})),r()(this,"onAction",(t=>{t.action===g.a.ViewRoom&&t.room_id===this.props.room.roomId&&t.show_room_tile&&e((()=>{this.scrollIntoView()}))})),r()(this,"onRoomPreviewChanged",(e=>{this.props.room&&e.roomId===this.props.room.roomId&&this.generatePreview()})),r()(this,"onCallChanged",((e,t)=>{var n;t===(null===(n=this.props.room)||void 0===n?void 0:n.roomId)&&this.setState({call:e})})),r()(this,"scrollIntoView",(()=>{this.roomTileRef.current&&this.roomTileRef.current.scrollIntoView({block:"nearest",behavior:"auto"})})),r()(this,"onTileClick",(async e=>{e.preventDefault(),e.stopPropagation();const t=Object(D.a)().getAccessibilityAction(e),n=[P.h.Enter,P.h.Space].includes(t);p.a.dispatch({action:g.a.ViewRoom,show_room_tile:!0,room_id:this.props.room.roomId,clear_search:n,metricsTrigger:"RoomList",metricsViaKeyboard:"click"!==e.type})})),r()(this,"onActiveRoomUpdate",(e=>{this.setState({selected:e})})),r()(this,"onNotificationsMenuOpenClick",(e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({notificationsMenuPosition:t.getBoundingClientRect()}),j.b.trackInteraction("WebRoomListRoomTileNotificationsMenu",e)})),r()(this,"onCloseNotificationsMenu",(()=>{this.setState({notificationsMenuPosition:null})})),r()(this,"onGeneralMenuOpenClick",(e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({generalMenuPosition:t.getBoundingClientRect()})})),r()(this,"onContextMenu",(e=>{this.showContextMenu&&(e.preventDefault(),e.stopPropagation(),this.setState({generalMenuPosition:{left:e.clientX,bottom:e.clientY}}))})),r()(this,"onCloseGeneralMenu",(()=>{this.setState({generalMenuPosition:null})})),this.state={selected:L.b.instance.roomViewStore.getRoomId()===this.props.room.roomId,notificationsMenuPosition:null,generalMenuPosition:null,call:A.a.instance.getCall(this.props.room.roomId),messagePreview:""},this.generatePreview(),this.notificationState=O.a.instance.getRoomState(this.props.room),this.roomProps=k.a.forRoom(this.props.room)}get showContextMenu(){return this.props.tag!==b.a.Invite}get showMessagePreview(){return!this.props.isMinimized&&this.props.showMessagePreview}componentDidUpdate(e,t){var n,i;const s=e.showMessagePreview!==this.props.showMessagePreview,o=e.isMinimized!==this.props.isMinimized;var r,a,c,d,u,h;((s||o)&&this.generatePreview(),(null===(n=e.room)||void 0===n?void 0:n.roomId)!==(null===(i=this.props.room)||void 0===i?void 0:i.roomId))&&(y.a.instance.off(y.a.getPreviewChangedEventName(e.room),this.onRoomPreviewChanged),y.a.instance.on(y.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),null===(r=e.room)||void 0===r||r.off(l.d.Name,this.onRoomNameUpdate),null===(a=this.props.room)||void 0===a||a.on(l.d.Name,this.onRoomNameUpdate));(t.generalMenuPosition&&!this.state.generalMenuPosition||t.notificationsMenuPosition&&this.state.notificationsMenuPosition)&&(null===(c=this.roomTileRef)||void 0===c||null===(d=c.current)||void 0===d||d.focus(),null===(u=this.roomTileRef)||void 0===u||null===(h=u.current)||void 0===h||h.blur())}componentDidMount(){this.state.selected&&this.scrollIntoView(),L.b.instance.roomViewStore.addRoomListener(this.props.room.roomId,this.onActiveRoomUpdate),this.dispatcherRef=p.a.register(this.onAction),y.a.instance.on(y.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),this.notificationState.on(I.b.Update,this.onNotificationUpdate),this.roomProps.on(T.b,this.onRoomPropertyUpdate),this.props.room.on(l.d.Name,this.onRoomNameUpdate),A.a.instance.on(A.b.Call,this.onCallChanged),this.setState({call:A.a.instance.getCall(this.props.room.roomId)})}componentWillUnmount(){L.b.instance.roomViewStore.removeRoomListener(this.props.room.roomId,this.onActiveRoomUpdate),y.a.instance.off(y.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),this.props.room.off(l.d.Name,this.onRoomNameUpdate),this.dispatcherRef&&p.a.unregister(this.dispatcherRef),this.notificationState.off(I.b.Update,this.onNotificationUpdate),this.roomProps.off(T.b,this.onRoomPropertyUpdate),A.a.instance.off(A.b.Call,this.onCallChanged)}async generatePreview(){if(!this.showMessagePreview)return null;const e=await y.a.instance.getPreviewForRoom(this.props.room,this.props.tag);this.setState({messagePreview:e})}renderNotificationsMenu(e){if(w.a.get().isGuest()||this.props.tag===b.a.Archived||!this.showContextMenu||this.props.isMinimized)return null;const t=this.roomProps.notificationVolume,n=u()("mx_RoomTile_notificationsButton",{mx_RoomNotificationContextMenu_iconBell:t===E.a.AllMessages,mx_RoomNotificationContextMenu_iconBellDot:t===E.a.AllMessagesLoud,mx_RoomNotificationContextMenu_iconBellMentions:t===E.a.MentionsOnly,mx_RoomNotificationContextMenu_iconBellCrossed:t===E.a.Mute,mx_RoomTile_notificationsButton_show:!1});return c.a.createElement(c.a.Fragment,null,c.a.createElement(f.c,{className:n,onClick:this.onNotificationsMenuOpenClick,title:Object(v.a)("Notification options"),isExpanded:!!this.state.notificationsMenuPosition,tabIndex:e?0:-1}),this.state.notificationsMenuPosition&&c.a.createElement(_.a,s()({},B(this.state.notificationsMenuPosition),{onFinished:this.onCloseNotificationsMenu,room:this.props.room})))}renderGeneralMenu(){return this.showContextMenu?c.a.createElement(c.a.Fragment,null,c.a.createElement(f.c,{className:"mx_RoomTile_menuButton",onClick:this.onGeneralMenuOpenClick,title:Object(v.a)("Room options"),isExpanded:!!this.state.generalMenuPosition}),this.state.generalMenuPosition&&c.a.createElement(M.a,s()({},B(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,room:this.props.room,onPostFavoriteClick:e=>j.b.trackInteraction("WebRoomListRoomTileContextMenuFavouriteToggle",e),onPostInviteClick:e=>j.b.trackInteraction("WebRoomListRoomTileContextMenuInviteItem",e),onPostSettingsClick:e=>j.b.trackInteraction("WebRoomListRoomTileContextMenuSettingsItem",e),onPostLeaveClick:e=>j.b.trackInteraction("WebRoomListRoomTileContextMenuLeaveItem",e)}))):null}render(){const e=u()({mx_RoomTile:!0,mx_RoomTile_selected:this.state.selected,mx_RoomTile_hasMenuOpen:!(!this.state.generalMenuPosition&&!this.state.notificationsMenuPosition),mx_RoomTile_minimized:this.props.isMinimized});let t,n,i=this.props.room.name;"string"!=typeof i&&(i=""),i=i.replace(":",":​"),!this.props.isMinimized&&this.notificationState&&(t=c.a.createElement("div",{className:"mx_RoomTile_badgeContainer","aria-hidden":"true"},c.a.createElement(C.a,{notification:this.notificationState,forceCount:!1,roomId:this.props.room.roomId}))),this.state.call?n=c.a.createElement("div",{className:"mx_RoomTile_subtitle"},c.a.createElement(N.a,{call:this.state.call})):this.props.hasLiveVoiceBroadcast?n=c.a.createElement(U.A,null):this.showMessagePreview&&this.state.messagePreview&&(n=c.a.createElement("div",{className:"mx_RoomTile_subtitle",id:F(this.props.room.roomId),title:this.state.messagePreview,dir:"auto"},this.state.messagePreview));const o=u()({mx_RoomTile_title:!0,mx_RoomTile_titleWithSubtitle:!!n,mx_RoomTile_titleHasUnreadEvents:this.notificationState.isUnread}),r=this.props.isMinimized?null:c.a.createElement("div",{className:"mx_RoomTile_titleContainer"},c.a.createElement("div",{title:i,className:o,tabIndex:-1},c.a.createElement("span",{dir:"auto"},i)),n);let a,l=i;this.props.tag===b.a.Invite||(this.notificationState.hasMentions?l+=" "+Object(v.a)("%(count)s unread messages including mentions.",{count:this.notificationState.count}):this.notificationState.hasUnreadCount?l+=" "+Object(v.a)("%(count)s unread messages.",{count:this.notificationState.count}):this.notificationState.isUnread&&(l+=" "+Object(v.a)("Unread messages."))),this.showMessagePreview&&(a=F(this.props.room.roomId));const d={};let p=m.a;return this.props.isMinimized&&(p=R.a,d.title=i,d.forceHide=!!this.state.generalMenuPosition),c.a.createElement(c.a.Fragment,null,c.a.createElement(h.e,{inputRef:this.roomTileRef},(n=>{let{onFocus:i,isActive:o,ref:u}=n;return c.a.createElement(p,s()({},d,{onFocus:i,tabIndex:o?0:-1,inputRef:u,className:e,onClick:this.onTileClick,onContextMenu:this.onContextMenu,role:"treeitem","aria-label":l,"aria-selected":this.state.selected,"aria-describedby":a}),c.a.createElement(S.a,{room:this.props.room,avatarSize:48,displayBadge:this.props.isMinimized,tooltipProps:{tabIndex:o?0:-1}}),r,t,this.renderGeneralMenu(),this.renderNotificationsMenu(o))})))}}t.b=e=>{const t=Object(U.S)(e.room);return c.a.createElement(V,s()({},e,{hasLiveVoiceBroadcast:t}))}}).call(this,n(54).setImmediate)},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o}));var i=n(147);function s(e,t){const n=[...e.keys()],s=[...t.keys()],o=Object(i.a)(n,s);return{changed:Object(i.f)(n,s).filter((n=>e.get(n)!==t.get(n))),added:o.added,removed:o.removed}}class o extends Map{constructor(e){super(e)}getOrCreate(e,t){return this.has(e)?this.get(e):(this.set(e,t),t)}remove(e){const t=this.get(e);return this.delete(e),t}}},function(e,t,n){"use strict";function i(e){e["io.element.performance_metrics"]={sendStartTs:Date.now()}}function s(e,t,n){e.sendEvent(t,"io.element.performance_metric",{"io.element.performance_metrics":{forEventId:n,responseTs:Date.now(),kind:"send_time"}})}n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"c",(function(){return b})),n.d(t,"b",(function(){return y}));var i=n(130),s=n(199),o=n(168),r=n(256),a=n(132),c=n(823),l=n(229);const d=["UL","OL","LI"];function u(e){return e.replace(/[\\*_[\]`<]|^>/g,(e=>`\\${e}`))}function h(e){let t=0,n=0;for(const i of e)"`"===i?n++:(t=Math.max(t,n),n=0);return Math.max(t,n)}function m(e){var t;return d.includes((null===(t=e.parentNode)||void 0===t?void 0:t.nodeName)||"")}function p(e,t,n){const i="@room",s=[];return e.split(i).forEach(((e,o,r)=>{e.length&&s.push(...t.plainWithEmoji(n.shouldEscape?u(e):e));o===r.length-1||s.push(t.atRoomPill(i))})),s}function g(e,t,n){e.unshift(n.plain(t));for(let i=0;i<e.length;i++)e[i].type===r.b.Newline&&(e.splice(i+1,0,n.plain(t)),i+=1)}function v(e,t,n,i){let o;return Array.from(e.childNodes).flatMap((e=>{const r=f(e,t,n,i);return r.length&&o&&(Object(s.d)(o)||Object(s.d)(e))&&(m(e)?r.unshift(t.newline()):r.unshift(t.newline(),t.newline())),r.length&&(o=e),r}))}function f(e,t,n,i){var s;if(function(e){return e.nodeType===Node.TEXT_NODE?"\n"===e.nodeValue:e.nodeType!==Node.ELEMENT_NODE||"MX-REPLY"===e.nodeName}(e))return[];switch(e.nodeType){case Node.TEXT_NODE:return p(e.nodeValue,t,n);case Node.ELEMENT_NODE:switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return function(e,t,n){const i=parseInt(e.nodeName.slice(1),10);return[t.plain("#".repeat(i)+" "),...v(e,t,n)]}(e,t,n);case"A":return function(e,t,n){const{href:i}=e,s=Object(o.d)(i);switch(null==s?void 0:s[0]){case"@":return[t.userPill(e.textContent,s)];case"#":return[t.roomPill(s)]}const r=Array.from(e.childNodes);return i===e.textContent&&r.every((e=>e.nodeType===Node.TEXT_NODE))?p(e.textContent,t,n):[t.plain("["),...v(e,t,n),t.plain(`](${i})`)]}(e,t,n);case"IMG":return function(e,t,n){const i=e,{alt:s,src:o}=i;if(i.hasAttribute("data-mx-emoticon")){const e=i.title||i.alt||":SHORTCODE_MISSING:";return[t.customEmoji(e,o)]}return t.plainWithEmoji(`![${u(s)}](${o})`)}(e,t);case"BR":return[t.newline()];case"HR":return[t.plain("---")];case"EM":return[t.plain("_"),...v(e,t,n),t.plain("_")];case"STRONG":return[t.plain("**"),...v(e,t,n),t.plain("**")];case"DEL":return[t.plain("<del>"),...v(e,t,n),t.plain("</del>")];case"SUB":return[t.plain("<sub>"),...v(e,t,n),t.plain("</sub>")];case"SUP":return[t.plain("<sup>"),...v(e,t,n),t.plain("</sup>")];case"U":return[t.plain("<u>"),...v(e,t,n),t.plain("</u>")];case"PRE":return function(e,t,n){var i;let s="";if("CODE"===(null===(i=e.firstChild)||void 0===i?void 0:i.nodeName))for(const t of e.firstChild.classList)if(t.startsWith("language-")&&!t.startsWith("language-_")){s=t.slice("language-".length);break}const o=e.textContent.replace(/\n$/,""),r="`".repeat(Math.max(3,h(o)+1)),a=[...t.plainWithEmoji(r+s),t.newline()];return o.split("\n").forEach((e=>{a.push(...t.plainWithEmoji(e)),a.push(t.newline())})),a.push(t.plain(r)),a}(e,t);case"CODE":{const n="`".repeat(h(e.textContent)+1);return t.plainWithEmoji(`${n}${e.textContent}${n}`)}case"BLOCKQUOTE":{const i=v(e,t,n);return g(i,"> ",t),i}case"LI":return null!==(s=null==i?void 0:i(e))&&void 0!==s?s:v(e,t,n);case"UL":{const i=v(e,t,n,(e=>[t.plain("- "),...v(e,t,n)]));return m(e)&&g(i,"    ",t),i}case"OL":{var r;let i=null!==(r=e.start)&&void 0!==r?r:1;const s=v(e,t,n,(e=>{const s=[t.plain(`${i}. `),...v(e,t,n)];return i++,s}));return m(e)&&g(s,"    ",t),s}case"DIV":case"SPAN":if(e.hasAttribute("data-mx-maths")){var c,l,d,f,b,y,S,E;const n=a.b.get().latex_maths_delims,i="SPAN"===e.nodeName?null!==(c=null==n||null===(l=n.inline)||void 0===l?void 0:l.left)&&void 0!==c?c:"\\(":null!==(d=null==n||null===(f=n.display)||void 0===f?void 0:f.left)&&void 0!==d?d:"\\[",s="SPAN"===e.nodeName?null!==(b=null==n||null===(y=n.inline)||void 0===y?void 0:y.right)&&void 0!==b?b:"\\)":null!==(S=null==n||null===(E=n.display)||void 0===E?void 0:E.right)&&void 0!==S?S:"\\]",o=e.getAttribute("data-mx-maths");return t.plainWithEmoji(`${i}${o}${s}`)}}}return v(e,t,n)}function b(e,t,n){const i=e.split(/\r\n|\r|\n/g);return i.reduce(((e,s,o)=>{n.isQuotedMessage&&e.push(t.plain("> ")),e.push(...p(s,t,n));return o===i.length-1||e.push(t.newline()),e}),[])}function y(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{shouldEscape:!0};const s=e.getContent();let o;const r=s.msgtype===i.e.Emote;let a=!1;if("org.matrix.custom.html"===s.format)o=function(e,t,n){const i=f((new DOMParser).parseFromString(e,"text/html").body,t,n);return n.isQuotedMessage&&g(i,"> ",t),i}(s.formatted_body||"",t,n),s.body&&s.formatted_body&&Object(c.a)(s.body)===s.formatted_body&&(a=!0);else{let i=s.body||"";e.replyEventId&&(i=Object(l.e)(i)),o=b(i,t,n)}return r&&a?o.unshift(t.plain("/rainbowme ")):a?o.unshift(t.plain("/rainbow ")):r&&o.unshift(t.plain("/me ")),o}},,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(122),s=n.n(i),o=n(125),r=n(126),a=n(575),c=n(129),l=n(138);class d{constructor(){s()(this,"dispatcherRef",void 0),s()(this,"onAction",(e=>{e.action===c.a.UpdateFontSize?this.setRootFontSize(e.size):e.action===c.a.UpdateSystemFont?this.setSystemFont(e):e.action===c.a.OnLoggedOut?(this.setRootFontSize(d.DEFAULT_SIZE),this.setSystemFont({useSystemFont:!1,font:""})):e.action===c.a.OnLoggedIn&&this.updateFont()})),s()(this,"setRootFontSize",(e=>{const t=Math.max(Math.min(d.MAX_SIZE,e),d.MIN_SIZE);t!==e&&r.b.setValue("baseFontSize",null,l.a.DEVICE,t),document.querySelector(":root").style.fontSize=Object(a.a)(t)})),s()(this,"setSystemFont",(e=>{let{useSystemFont:t,font:n}=e;document.body.style.fontFamily=t?n.split(",").map((e=>((e=e.trim()).startsWith('"')||e.endsWith('"')||(e=`"${e}"`),e))).join(","):""})),this.dispatcherRef=null}start(){this.updateFont(),this.dispatcherRef=o.a.register(this.onAction)}stop(){this.dispatcherRef&&o.a.unregister(this.dispatcherRef)}updateFont(){this.setRootFontSize(r.b.getValue("baseFontSize")),this.setSystemFont({useSystemFont:r.b.getValue("useSystemFont"),font:r.b.getValue("systemFont")})}}s()(d,"MIN_SIZE",8),s()(d,"DEFAULT_SIZE",10),s()(d,"MAX_SIZE",15),s()(d,"SIZE_DIFF",5)},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a);const l=["children"],d=e=>{let{children:t}=e,n=r()(e,l);return c.a.createElement("span",s()({className:"mx_Caption"},n),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(132),s=n(126),o=n(158);function r(){return!!i.b.get().bug_report_endpoint_url&&s.b.getValue(o.b.Feedback)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(197),s=n.n(i);let o;!function(e){e.Compact="compact",e.Intermediate="intermediate",e.Roomy="roomy"}(o||(o={}));s.a.oneOf(Object.values(o))},,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i,s=n(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 10 10",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M1 1l8 8M9.001 1l-8 8",stroke:"currentColor",strokeWidth:1.6,strokeLinecap:"round"})))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(121);function s(e){var t,n,s;return null!==(t=null!==(n=null===(s=e.sender)||void 0===s?void 0:s.name)&&void 0!==n?n:e.getSender())&&void 0!==t?t:Object(i.a)("Someone")}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(640);t.a=e=>{let{className:t,children:n}=e;return s.a.createElement("span",{className:t},s.a.createElement(o.Icon,{className:"mx_MediaProcessingError_Icon",width:"16",height:"16"}),n)}},function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return m})),n.d(t,"d",(function(){return p})),n.d(t,"c",(function(){return g}));var i=n(122),s=n.n(i),o=n(130),r=n(190),a=n(17),c=n(185),l=n(123);let d;!function(e){e.StateChanged="state_changed",e.SilencedChanged="silenced_changed",e.LengthChanged="length_changed"}(d||(d={}));const u=[r.f.Connecting,r.f.WaitLocalMedia,r.f.CreateOffer,r.f.CreateAnswer],h=[r.f.Connected,r.f.Ringing,r.f.Ended];let m;!function(e){e.Missed="missed"}(m||(m={}));const p=e=>{return(t=e.getType()).startsWith("m.call.")||t.startsWith("org.matrix.call.");var t};function g(e,t){const n=new Map;return null==t||t.forEach((t=>{if(!p(t))return;const i=t.getContent().call_id;n.has(i)||(e.has(i)?n.set(i,e.get(i)):n.set(i,new v)),n.get(i).add(t)})),n}class v extends a.EventEmitter{constructor(){super(),s()(this,"events",new Set),s()(this,"call",null),s()(this,"state",void 0),s()(this,"onSilencedCallsChanged",(()=>{const e=c.b.instance.isCallSilenced(this.callId);this.emit(d.SilencedChanged,e)})),s()(this,"onLengthChanged",(e=>{this.emit(d.LengthChanged,e)})),s()(this,"answerCall",(()=>{c.b.instance.answerCall(this.roomId)})),s()(this,"rejectCall",(()=>{c.b.instance.hangupOrReject(this.roomId,!0)})),s()(this,"callBack",(()=>{c.b.instance.placeCall(this.roomId,this.isVoice?r.g.Voice:r.g.Video)})),s()(this,"toggleSilenced",(()=>{c.b.instance.isCallSilenced(this.callId)?c.b.instance.unSilenceCall(this.callId):c.b.instance.silenceCall(this.callId)})),s()(this,"setState",(()=>{var e,t;u.includes(null===(e=this.call)||void 0===e?void 0:e.state)?this.state=r.f.Connecting:h.includes(null===(t=this.call)||void 0===t?void 0:t.state)?this.state=this.call.state:this.callWasMissed?this.state=m.Missed:this.reject||this.hangup?this.state=r.f.Ended:this.invite&&this.call&&(this.state=r.f.Connecting),this.emit(d.StateChanged,this.state)})),s()(this,"setCall",(()=>{this.call||(this.call=c.b.instance.getCallById(this.callId),this.setCallListeners(),this.setState())})),c.b.instance.addListener(c.a.CallsChanged,this.setCall),c.b.instance.addListener(c.a.SilencedCallsChanged,this.onSilencedCallsChanged)}get invite(){return[...this.events].find((e=>e.getType()===o.b.CallInvite))}get hangup(){return[...this.events].find((e=>e.getType()===o.b.CallHangup))}get reject(){return[...this.events].find((e=>e.getType()===o.b.CallReject))}get selectAnswer(){return[...this.events].find((e=>e.getType()===o.b.CallSelectAnswer))}get isVoice(){var e,t,n;const i=this.invite;if(i)return-1===(null===(e=i.getContent())||void 0===e||null===(t=e.offer)||void 0===t||null===(n=t.sdp)||void 0===n?void 0:n.indexOf("m=video"))}get hangupReason(){var e,t,n,i,s;return null!==(e=null!==(t=null===(n=this.call)||void 0===n?void 0:n.hangupReason)&&void 0!==t?t:null===(i=this.hangup)||void 0===i||null===(s=i.getContent())||void 0===s?void 0:s.reason)&&void 0!==e?e:null}get rejectParty(){var e;return null===(e=this.reject)||void 0===e?void 0:e.getSender()}get gotRejected(){return Boolean(this.reject)}get duration(){return this.hangup&&this.selectAnswer?this.hangup.getDate().getTime()-this.selectAnswer.getDate().getTime():null}get callWasMissed(){return![...this.events].some((e=>{var t;return(null===(t=e.sender)||void 0===t?void 0:t.userId)===l.a.get().getUserId()}))}get callId(){var e,t;return null===(e=[...this.events][0])||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.call_id}get roomId(){var e;return null===(e=[...this.events][0])||void 0===e?void 0:e.getRoomId()}setCallListeners(){this.call&&(this.call.addListener(r.d.State,this.setState),this.call.addListener(r.d.LengthChanged,this.onLengthChanged))}add(e){this.events.has(e)||(this.events.add(e),this.setCall())}}},,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return j}));var i=n(122),s=n.n(i),o=n(630),r=n(632),a=n(147),c=n(870);let l;!function(e){e[e.NotStarted=0]="NotStarted",e[e.PendingErrors=1]="PendingErrors",e[e.AllSuccessful=2]="AllSuccessful"}(l||(l={}));class d extends c.a{constructor(){super(...arguments),s()(this,"_transactions",[]),s()(this,"_state",l.NotStarted),s()(this,"checkTransactions",(()=>{let e=l.AllSuccessful;for(const t of this.transactions){if(t.status===r.b.Error||t.didPreviouslyFail){e=l.PendingErrors;break}t.status===r.b.Pending&&(e=l.NotStarted)}this._state=e,this.notifyCondition(e)}))}get transactions(){return Object(a.b)(this._transactions)}get state(){return this._state}get firstFailedTime(){const e=this.transactions.find((e=>e.didPreviouslyFail||e.status===r.b.Error));return e?e.startTime:null}disownTransaction(e){const t=this._transactions.indexOf(e);t>=0&&this._transactions.splice(t,1),e.destroy(),this.checkTransactions()}beginTransaction(e,t){const n=new r.a(e,t);return this._transactions.push(n),n.whenAnything(this.checkTransactions),n.when(r.b.Success,(()=>n.destroy())),n}destroy(){for(const e of this.transactions)e.destroy();this._transactions=[],super.destroy()}}class u extends d{constructor(e){super(),this.room=e}}var h=n(203),m=n(125),p=n(871),g=n(120),v=n.n(g),f=n(121),b=n(124),y=n(128),S=n(136),E=n(166),w=n(126),_=n(165),C=n(135),O=n(154),I=n(123);class R extends g.PureComponent{constructor(){super(...arguments),s()(this,"onEchosUpdated",(()=>{this.forceUpdate()}))}componentDidMount(){T.instance.on(O.b,this.onEchosUpdated)}componentWillUnmount(){T.instance.off(O.b,this.onEchosUpdated)}renderTimeline(){return T.instance.contexts.map(((e,t)=>{if(!e.firstFailedTime)return null;if(!(e instanceof u))throw new Error("Cannot render unknown context: "+e.constructor.name);const n=g.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline_header"},g.createElement(_.a,{width:24,height:24,room:e.room}),g.createElement("span",null,e.room.name)),i=e.transactions.filter((e=>e.status===r.b.Error||e.didPreviouslyFail)).map(((e,t)=>{let n=g.createElement(C.a,{w:19,h:19});return e.status===r.b.Error&&(n=g.createElement(b.a,{kind:"link",onClick:()=>e.run()},Object(f.a)("Resend"))),g.createElement("div",{className:"mx_ServerOfflineDialog_content_context_txn",key:`txn-${t}`},g.createElement("span",{className:"mx_ServerOfflineDialog_content_context_txn_desc"},e.auditName),n)}));return g.createElement("div",{className:"mx_ServerOfflineDialog_content_context",key:`context-${t}`},g.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timestamp"},Object(E.m)(e.firstFailedTime,w.b.getValue("showTwelveHourTimestamps"))),g.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline"},n,i))}))}render(){let e=this.renderTimeline().filter((e=>!!e));0===e.length&&(e=[g.createElement("div",{key:1},Object(f.a)("You're all caught up."))]);const t=I.a.getHomeserverName();return g.createElement(S.a,{title:Object(f.a)("Server isn't responding"),className:"mx_ServerOfflineDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished,hasCancel:!0},g.createElement("div",{className:"mx_ServerOfflineDialog_content"},g.createElement("p",null,Object(f.a)("Your server isn't responding to some of your requests. Below are some of the most likely reasons.")),g.createElement("ul",null,g.createElement("li",null,Object(f.a)("The server (%(serverName)s) took too long to respond.",{serverName:t})),g.createElement("li",null,Object(f.a)("Your firewall or anti-virus is blocking the request.")),g.createElement("li",null,Object(f.a)("A browser extension is preventing the request.")),g.createElement("li",null,Object(f.a)("The server is offline.")),g.createElement("li",null,Object(f.a)("The server has denied your request.")),g.createElement("li",null,Object(f.a)("Your area is experiencing difficulties connecting to the internet.")),g.createElement("li",null,Object(f.a)("A connection error occurred while trying to contact the server.")),g.createElement("li",null,Object(f.a)("The server is not configured to indicate what the problem is (CORS)."))),g.createElement("hr",null),g.createElement("h2",null,Object(f.a)("Recent changes that have not yet been received")),e))}}class k extends v.a.PureComponent{constructor(){super(...arguments),s()(this,"openDialog",(()=>{y.b.createDialog(R,{})}))}render(){return v.a.createElement("div",{className:"mx_NonUrgentEchoFailureToast"},v.a.createElement("span",{className:"mx_NonUrgentEchoFailureToast_icon"}),Object(f.a)("Your server isn't responding to some <a>requests</a>.",{},{a:e=>v.a.createElement(b.a,{kind:"link_inline",onClick:this.openDialog},e)}))}}const x=e=>`room-${e.roomId}`;class T extends h.a{constructor(){super(m.a),s()(this,"caches",new Map)}static get instance(){return this._instance||(this._instance=new T,this._instance.start()),this._instance}get contexts(){return Array.from(this.caches.values()).map((e=>e.context))}getOrCreateChamberForRoom(e){if(this.caches.has(x(e)))return this.caches.get(x(e));const t=new u(e);t.whenAnything((()=>this.checkContexts()));const n=new o.b(t);return n.setClient(this.matrixClient),this.caches.set(x(e),n),n}async checkContexts(){let e=!1;for(const t of this.caches.values())if(e=t.context.state===l.PendingErrors,e)break;if(e&&!this.state.toastRef){const e=p.a.instance.addToast(k);await this.updateState({toastRef:e})}else!e&&this.state.toastRef&&(p.a.instance.removeToast(this.state.toastRef),await this.updateState({toastRef:null}))}async onReady(){if(this.caches)for(const e of this.caches.values())e.setClient(this.matrixClient)}async onNotReady(){for(const e of this.caches.values())e.setClient(null)}async onAction(e){}}s()(T,"_instance",void 0);class j{constructor(){}static forRoom(e){return T.instance.getOrCreateChamberForRoom(e)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return E}));var i=n(13),s=n.n(i),o=n(358),r=n(535),a=n(16),c=n(705),l=n(1);const d=[e=>{e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})},e=>{e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")},e=>{e.createObjectStore("client_options",{keyPath:["clobber"]})},e=>{e.createObjectStore("to_device_queue",{autoIncrement:!0})}],u=d.length;function h(e,t,n){const i=e.openCursor(t);return new Promise(((e,t)=>{const s=[];i.onerror=()=>{t(new Error("Query failed: "+i.error))},i.onsuccess=()=>{const t=i.result;t?(s.push(n(t)),t.continue()):e(s)}}))}function m(e){return new Promise(((t,n)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){n(e.error)}}))}function p(e){return new Promise(((t,n)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){n(e.error)}}))}function g(e){return p(e).then((t=>e.result))}class v{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),c.a(e,t)}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";this.indexedDB=e,s()(this,"dbName",void 0),s()(this,"syncAccumulator",void 0),s()(this,"db",void 0),s()(this,"disconnected",!0),s()(this,"_isNewlyCreated",!1),s()(this,"isPersisting",!1),s()(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new r.b}connect(){if(!this.disconnected)return l.a.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,l.a.log("LocalIndexedDBStoreBackend.connect: connecting...");const e=this.indexedDB.open(this.dbName,u);return e.onupgradeneeded=t=>{const n=e.result,i=t.oldVersion;l.a.log(`LocalIndexedDBStoreBackend.connect: upgrading from ${i}`),i<1&&(this._isNewlyCreated=!0),d.forEach(((e,t)=>{i<=t&&e(n)}))},e.onblocked=()=>{l.a.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},l.a.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),p(e).then((async()=>{l.a.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=e.result,this.db.onversionchange=()=>{var e;null===(e=this.db)||void 0===e||e.close()},await this.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then((e=>{let[t,n]=e;l.a.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:n.nextBatch,rooms:n.roomsData,account_data:{events:t}},!0)}))}getOutOfBandMembers(e){return new Promise(((t,n)=>{const i=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),s=IDBKeyRange.only(e),o=i.openCursor(s),r=[];let a=!1;o.onsuccess=()=>{const e=o.result;if(!e)return r.length||a?t(r):t(null);const n=e.value;n.oob_written?a=!0:r.push(n),e.continue()},o.onerror=e=>{n(e)}})).then((t=>(l.a.log(`LL: got ${null==t?void 0:t.length} membershipEvents from storage for room ${e} ...`),t)))}async setOutOfBandMembers(e,t){l.a.log(`LL: backend about to store ${t.length} members for ${e}`);const n=this.db.transaction(["oob_membership_events"],"readwrite"),i=n.objectStore("oob_membership_events");t.forEach((e=>{i.put(e)}));const s={room_id:e,oob_written:!0,state_key:0};i.put(s),await m(n),l.a.log(`LL: backend done storing for ${e}!`)}async clearOutOfBandMembers(e){const t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),n=IDBKeyRange.only(e),i=g(t.openKeyCursor(n,"next")).then((e=>(null==e?void 0:e.primaryKey)[1])),s=g(t.openKeyCursor(n,"prev")).then((e=>(null==e?void 0:e.primaryKey)[1])),[o,r]=await Promise.all([i,s]),a=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),c=IDBKeyRange.bound([e,o],[e,r]);var d;l.a.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,o],[e,r]),await(d=a.delete(c),new Promise(((e,t)=>{d.onsuccess=()=>e(d),d.onerror=e=>t(e)})))}clearDatabase(){return new Promise((e=>{l.a.log(`Removing indexeddb instance: ${this.dbName}`);const t=this.indexedDB.deleteDatabase(this.dbName);t.onblocked=()=>{l.a.log(`can't yet delete indexeddb ${this.dbName} because it is open elsewhere`)},t.onerror=()=>{l.a.warn(`unable to delete js-sdk store indexeddb: ${t.error}`),e()},t.onsuccess=()=>{l.a.log(`Removed indexeddb instance: ${this.dbName}`),e()}}))}getSavedSync(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(a.k(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then((()=>{this.syncAccumulator.accumulate(e)}))}async syncToDatabase(e){if(this.isPersisting)return l.a.warn("Skipping syncToDatabase() as persist already in flight"),void this.pendingUserPresenceData.push(...e);e.unshift(...this.pendingUserPresenceData),this.isPersisting=!0;try{const t=this.syncAccumulator.getJSON(!0);await Promise.all([this.persistUserPresenceEvents(e),this.persistAccountData(t.accountData),this.persistSyncData(t.nextBatch,t.roomsData)])}finally{this.isPersisting=!1}}persistSyncData(e,t){return l.a.log("Persisting sync data up to",e),a.E((()=>{const n=this.db.transaction(["sync"],"readwrite");return n.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t}),m(n).then((()=>{l.a.log("Persisted sync data up to",e)}))}))}persistAccountData(e){return a.E((()=>{const t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(const t of e)n.put(t);return m(t).then()}))}persistUserPresenceEvents(e){return a.E((()=>{const t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(const t of e)n.put({userId:t[0],event:t[1]});return m(t).then()}))}getUserPresenceEvents(){return a.E((()=>h(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,(e=>[e.value.userId,e.value.event]))))}loadAccountData(){return l.a.log("LocalIndexedDBStoreBackend: loading account data..."),a.E((()=>h(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,(e=>e.value)).then((e=>(l.a.log("LocalIndexedDBStoreBackend: loaded account data"),e)))))}loadSyncData(){return l.a.log("LocalIndexedDBStoreBackend: loading sync data..."),a.E((()=>h(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,(e=>e.value)).then((e=>(l.a.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&l.a.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))))}getClientOptions(){return Promise.resolve().then((()=>h(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,(e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.options})).then((e=>e[0]))))}async storeClientOptions(e){const t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await m(t)}async saveToDeviceBatches(e){const t=this.db.transaction(["to_device_queue"],"readwrite"),n=t.objectStore("to_device_queue");for(const t of e)n.add(t);await m(t)}async getOldestToDeviceBatch(){const e=this.db.transaction(["to_device_queue"],"readonly").objectStore("to_device_queue"),t=await g(e.openCursor());if(!t)return null;const n=t.value;return{id:t.key,txnId:n.txnId,eventType:n.eventType,batch:n.batch}}async removeToDeviceBatch(e){const t=this.db.transaction(["to_device_queue"],"readwrite");t.objectStore("to_device_queue").delete(e),await m(t)}}class f{constructor(e,t){this.workerFactory=e,this.dbName=t,s()(this,"worker",void 0),s()(this,"nextSeq",0),s()(this,"inFlight",{}),s()(this,"startPromise",void 0),s()(this,"onWorkerMessage",(e=>{const t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void l.a.error("Got reply from worker with no seq");const e=this.inFlight[t.seq];if(void 0===e)return void l.a.error("Got reply for unknown seq "+t.seq);if(delete this.inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const n=new Error(t.error.message);n.name=t.error.name,e.reject(n)}}else l.a.warn("Unrecognised message from worker: ",t)}))}connect(){return this.ensureStarted().then((()=>this.doCmd("connect")))}clearDatabase(){return this.ensureStarted().then((()=>this.doCmd("clearDatabase")))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}async saveToDeviceBatches(e){return this.doCmd("saveToDeviceBatches",[e])}async getOldestToDeviceBatch(){return this.doCmd("getOldestToDeviceBatch")}async removeToDeviceBatch(e){return this.doCmd("removeToDeviceBatch",[e])}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then((()=>{l.a.log("IndexedDB worker is ready")}))),this.startPromise}doCmd(e,t){return Promise.resolve().then((()=>{var n;const i=this.nextSeq++,s=Object(a.m)();return this.inFlight[i]=s,null===(n=this.worker)||void 0===n||n.postMessage({command:e,seq:i,args:t}),s.promise}))}}var b=n(224),y=n(144),S=n(159);class E extends o.a{static exists(e,t){return v.exists(e,t)}constructor(e){if(super(e),s()(this,"backend",void 0),s()(this,"startedUp",!1),s()(this,"syncTs",0),s()(this,"userModifiedMap",{}),s()(this,"emitter",new S.b),s()(this,"on",this.emitter.on.bind(this.emitter)),s()(this,"getSavedSync",this.degradable((()=>this.backend.getSavedSync()),"getSavedSync")),s()(this,"isNewlyCreated",this.degradable((()=>this.backend.isNewlyCreated()),"isNewlyCreated")),s()(this,"getSavedSyncToken",this.degradable((()=>this.backend.getNextBatchToken()),"getSavedSyncToken")),s()(this,"deleteAllData",this.degradable((()=>(super.deleteAllData(),this.backend.clearDatabase().then((()=>{l.a.log("Deleted indexeddb data.")}),(e=>{throw l.a.error(`Failed to delete indexeddb data: ${e}`),e})))))),s()(this,"reallySave",this.degradable((()=>{this.syncTs=Date.now();const e=[];for(const t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)}))),s()(this,"setSyncData",this.degradable((e=>this.backend.setSyncData(e)),"setSyncData")),s()(this,"getOutOfBandMembers",this.degradable((e=>this.backend.getOutOfBandMembers(e)),"getOutOfBandMembers")),s()(this,"setOutOfBandMembers",this.degradable(((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t))),"setOutOfBandMembers")),s()(this,"clearOutOfBandMembers",this.degradable((e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e))),"clearOutOfBandMembers")),s()(this,"getClientOptions",this.degradable((()=>this.backend.getClientOptions()),"getClientOptions")),s()(this,"storeClientOptions",this.degradable((e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e))),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new f(e.workerFactory,e.dbName):this.backend=new v(e.indexedDB,e.dbName)}startup(){return this.startedUp?(l.a.log("IndexedDBStore.startup: already started"),Promise.resolve()):(l.a.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then((()=>(l.a.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents()))).then((e=>{l.a.log("IndexedDBStore.startup: processing presence events"),e.forEach((e=>{let[t,n]=e;const i=new b.a(t);n&&i.setPresenceEvent(new y.b(n)),this.userModifiedMap[i.userId]=i.getLastModifiedTime(),this.storeUser(i)}))})))}wantsSave(){return Date.now()-this.syncTs>3e5}save(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var n=this;const i=t?super[t]:null;return async function(){for(var t=arguments.length,s=new Array(t),o=0;o<t;o++)s[o]=arguments[o];try{return await e.call(n,...s)}catch(e){l.a.error("IndexedDBStore failure, degrading to MemoryStore",e),n.emitter.emit("degraded",e);try{l.a.log("IndexedDBStore trying to delete degraded data"),await n.backend.clearDatabase(),l.a.log("IndexedDBStore delete after degrading succeeded")}catch(e){l.a.warn("IndexedDBStore delete after degrading failed",e)}if(i)return i.call(n,...s)}}}async getPendingEvents(e){if(!this.localStorage)return super.getPendingEvents(e);const t=this.localStorage.getItem(w(e));if(t)try{return JSON.parse(t)}catch(e){l.a.error("Could not parse persisted pending events",e)}return[]}async setPendingEvents(e,t){if(!this.localStorage)return super.setPendingEvents(e,t);t.length>0?this.localStorage.setItem(w(e),JSON.stringify(t)):this.localStorage.removeItem(w(e))}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function w(e){return`mx_pending_events_${e}`}},function(e,t,n){"use strict";n.d(t,"e",(function(){return m})),n.d(t,"d",(function(){return g})),n.d(t,"g",(function(){return v})),n.d(t,"c",(function(){return f})),n.d(t,"f",(function(){return b})),n.d(t,"a",(function(){return y})),n.d(t,"b",(function(){return E}));var i=n(122),s=n.n(i),o=n(1148),r=n.n(o);class a{constructor(e){s()(this,"regex",void 0);const t=r()(e,{extended:!1,globstar:!1}).toString().replace(/\\\?/g,".");this.regex=new RegExp(t.substring(1,t.length-1))}test(e){return this.regex.test(e)}}const c="m.ban",l=[c,"org.matrix.mjolnir.ban"];function d(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return l.includes(e)?t?l[l.length-1]:c:null}class u{constructor(e,t,n,i){s()(this,"_glob",void 0),s()(this,"_entity",void 0),s()(this,"_action",void 0),s()(this,"_reason",void 0),s()(this,"_kind",void 0),this._glob=new a(e),this._entity=e,this._action=d(t,!1),this._reason=n,this._kind=i}get entity(){return this._entity}get reason(){return this._reason}get kind(){return this._kind}get recommendation(){return this._action}isMatch(e){return this._glob.test(e)}}var h=n(123);const m="m.policy.rule.user",p="m.policy.rule.room",g="m.policy.rule.server",v=[m,"m.room.rule.user","org.matrix.mjolnir.rule.user"],f=[p,"m.room.rule.room","org.matrix.mjolnir.rule.room"],b=[g,"m.room.rule.server","org.matrix.mjolnir.rule.server"],y=[...v,...f,...b];function S(e){return v.includes(e)?m:f.includes(e)?p:b.includes(e)?g:null}class E{constructor(e){s()(this,"_rules",[]),s()(this,"_roomId",void 0),this._roomId=e,this.updateList()}get roomId(){return this._roomId}get serverRules(){return this._rules.filter((e=>e.kind===g))}get userRules(){return this._rules.filter((e=>e.kind===m))}get roomRules(){return this._rules.filter((e=>e.kind===p))}async banEntity(e,t,n){const i=S(e);i&&(await h.a.get().sendStateEvent(this._roomId,i,{entity:t,reason:n,recommendation:d(c,!0)},"rule:"+t),this._rules.push(new u(t,c,n,i)))}async unbanEntity(e,t){const n=S(e);n&&(await h.a.get().sendStateEvent(this._roomId,n,{},"rule:"+t),this._rules=this._rules.filter((n=>n.kind!==S(e)||n.entity!==t)))}updateList(){this._rules=[];const e=h.a.get().getRoom(this._roomId);if(e)for(const t of y){const n=e.currentState.getStateEvents(t);for(const e of n){if(!e.getStateKey())continue;const n=S(t);if(!n)continue;const i=e.getContent().entity,s=e.getContent().recommendation,o=e.getContent().reason;i&&s&&o&&this._rules.push(new u(i,s,o,n))}}}}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(122),r=n.n(o),a=n(1),c=n(126);const l=function(){if(c.b.getValue("debug_animation")){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];a.a.log.call(console,"Animation debuglog:",...t)}};function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const h=function(){if(c.b.getValue("debug_animation")){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];a.a.log.call(console,"Animation debuglog:",...t)}};function m(e,t,n){const s=Object(i.useRef)({timestamp:null,value:e}),[o,r]=Object(i.useState)(e),[a,c]=Object(i.useState)(0);Object(i.useEffect)((()=>{const e=t-s.current.value;c(e/n),s.current=u(u({},s.current),{},{timestamp:null})}),[n,t]);const d=Object(i.useCallback)((e=>{if(!s.current.timestamp)return s.current=u(u({},s.current),{},{timestamp:e}),!0;if(Math.abs(a)<Number.EPSILON)return!1;const n=e-s.current.timestamp,i=a*n,o=t-s.current.value,c=Math.sign(i)*Math.min(Math.abs(o),Math.abs(i)),l=s.current.value+c;return h(`Animating to ${t} at ${l} timeDelta=${n}, valueDelta=${i}`),r(l),s.current={value:l,timestamp:e},Math.abs(o)>Number.EPSILON}),[a,t]);return function(e,t){const n=Object(i.useRef)(null),s=Object(i.useCallback)((e=>{t(e)?n.current=requestAnimationFrame(s):l("Finished animation!")}),[t]);Object(i.useEffect)((()=>(l("Started animation!"),e&&(n.current=requestAnimationFrame(s)),()=>{n.current&&(l("Aborted animation!"),cancelAnimationFrame(n.current),n.current=null)})),[e,s])}(n>0,d),n>0?o:t}t.a=e=>{let{value:t,max:n,animated:i=!0}=e;const o=m(0,t,i?300:0);return s.a.createElement("progress",{className:"mx_ProgressBar",max:n,value:o})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return u}));var i=n(122),s=n.n(i),o=n(16);function r(){return new Worker(n.p+"eb87b8d11927ec4f0ff7.worker.js")}class a{static get instance(){return a.internalInstance}constructor(){s()(this,"worker",void 0),s()(this,"seq",0),s()(this,"pendingDeferredMap",new Map),s()(this,"onMessage",(e=>{const{seq:t,blurhash:n}=e.data,i=this.pendingDeferredMap.get(t);i&&(this.pendingDeferredMap.delete(t),i.resolve(n))})),this.worker=new r,this.worker.onmessage=this.onMessage}getBlurhash(e){const t=this.seq++,n=Object(o.m)();return this.pendingDeferredMap.set(t,n),this.worker.postMessage({seq:t,imageData:e}),n.promise}}s()(a,"internalInstance",new a);const c="xyz.amorgan.blurhash",l=800,d=600;async function u(e,t,n,i){let s,o,r,u=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],h=t,m=n;m>d&&(h=Math.floor(h*(d/m)),m=d),h>l&&(m=Math.floor(m*(l/h)),h=l);try{s=new window.OffscreenCanvas(h,m),o=s.getContext("2d")}catch(e){s=document.createElement("canvas"),s.width=h,s.height=m,o=s.getContext("2d")}o.drawImage(e,0,0,h,m),r=window.OffscreenCanvas&&s instanceof OffscreenCanvas?s.convertToBlob({type:i}):new Promise((e=>s.toBlob(e,i)));const p=o.getImageData(0,0,h,m),g=u?await a.instance.getBlurhash(p):void 0,v=await r;return{info:{thumbnail_info:{w:h,h:m,mimetype:v.type,size:v.size},w:t,h:n,[c]:g},thumbnail:v}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return O})),n.d(t,"b",(function(){return I}));var i=n(16),s=n(120),o=n.n(s),r=n(419),a=n(144),c=n(128),l=n(135),d=n(123),u=n(121),h=n(145),m=n(211),p=n(179),g=n(125),v=n(129),f=n(161),b=n(146),y=n(136),S=n(873);const E=e=>{const t=e.client.getUserId();return 100===e.getMember(t).powerLevelNorm&&e.getJoinedMembers().every((e=>e.userId===t||e.powerLevelNorm<100))};var w=e=>{let{space:t,onFinished:n}=e;const i=Object(s.useMemo)((()=>{const e=new Set(p.a.instance.getSpaceFilteredRoomIds(t.roomId));return p.a.instance.traverseSpace(t.roomId,(n=>{t.roomId!==n&&e.add(n)}),!1),Array.from(e).map((e=>t.client.getRoom(e))).filter(Boolean)}),[t]),[r,a]=Object(s.useState)([]),c=Object(s.useMemo)((()=>new Set(r)),[r]);let l,d;if(t.getJoinRule()!==f.c.Public&&(l=Object(u.a)("You won't be able to rejoin unless you are re-invited.")),E(t))d=Object(u.a)("You're the only admin of this space. Leaving it will mean no one has control over it.");else{r.filter(E).length>0&&(d=Object(u.a)("You're the only admin of some of the rooms or spaces you wish to leave. Leaving them will leave them without any admins."))}return o.a.createElement(y.a,{title:Object(u.a)("Leave %(spaceName)s",{spaceName:t.name}),className:"mx_LeaveSpaceDialog",contentId:"mx_LeaveSpaceDialog",onFinished:()=>n(!1),fixedWidth:!1},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_LeaveSpaceDialog"},o.a.createElement("p",null,Object(u.a)("You are about to leave <spaceName/>.",{},{spaceName:()=>o.a.createElement("b",null,t.name)})," ",l,l&&o.a.createElement(o.a.Fragment,null," "),i.length>0&&Object(u.a)("Would you like to leave the rooms in this space?")),i.length>0&&o.a.createElement(S.a,{space:t,spaceChildren:i,selected:c,onChange:a,noneLabel:Object(u.a)("Don't leave any rooms"),allLabel:Object(u.a)("Leave all rooms"),specificLabel:Object(u.a)("Leave some rooms")}),d&&o.a.createElement("div",{className:"mx_LeaveSpaceDialog_section_warning"},d)),o.a.createElement(b.a,{primaryButton:Object(u.a)("Leave space"),primaryButtonClass:"danger",onPrimaryButtonClick:()=>n(!0,r),hasCancel:!0,onCancel:()=>n(!1)}))},_=n(253),C=n(155);async function O(e){var t;let n,s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];(!(arguments.length>2&&void 0!==arguments[2])||arguments[2])&&(n=c.b.createDialog(l.a,void 0,"mx_Dialog_spinner"));const f=d.a.get();let b=!0;const y=f.getRoomUpgradeHistory(e);if(y&&y.length>0){y[y.length-1].roomId!==e&&(b=!1)}const S=f.getRoom(e);await Promise.all(S.getPendingEvents().filter((e=>[r.a.QUEUED,r.a.ENCRYPTING,r.a.SENDING].includes(e.status))).map((e=>new Promise(((t,i)=>{const s=()=>{var o;e.status===r.a.NOT_SENT&&(null===(o=n)||void 0===o||o.close(),i(e.error));e.status&&e.status!==r.a.SENT||(e.off(a.c.Status,s),t())};e.on(a.c.Status,s)})))));let E={};if(b)E=await f.leaveRoomChain(e,s);else try{await f.leave(e)}catch(t){var w;if(null!=t&&null!==(w=t.data)&&void 0!==w&&w.errcode){const n=t.data.error||Object(u.a)("Unexpected server error trying to leave the room");E[e]=Object.assign(new Error(n),{errcode:t.data.errcode,data:t.data})}else E[e]=t||new Error("Failed to leave room for unknown causes")}if(s){const t=Object.values(E).find((e=>"M_LIMIT_EXCEEDED"===(null==e?void 0:e.errcode)));var _;if(t)return await Object(i.N)(null!==(_=t.data.retry_after_ms)&&void 0!==_?_:100),O(e,!1,!1)}null===(t=n)||void 0===t||t.close();const I=Object.entries(E).filter((e=>!!e[1]));if(I.length>0){const t=[];for(const n of I){const i=n[1];let s=Object(u.a)("Unexpected server error trying to leave the room");if(i.errcode&&i.message){if("M_CANNOT_LEAVE_SERVER_NOTICE_ROOM"===i.errcode)return void c.b.createDialog(h.a,{title:Object(u.a)("Can't leave Server Notices room"),description:Object(u.a)("This room is used for important messages from the Homeserver, so you cannot leave it.")});s=E[e].message}t.push(s,o.a.createElement("BR"))}c.b.createDialog(h.a,{title:Object(u.a)("Error leaving room"),description:t})}else if(C.b.instance.roomViewStore.getRoomId()===e)if(Object(m.h)(p.a.instance.activeSpace))g.a.dispatch({action:v.a.ViewHomePage});else if(p.a.instance.activeSpace===e){const t=p.a.instance.getCanonicalParent(e);null!==t?g.a.dispatch({action:v.a.ViewRoom,room_id:t.roomId,metricsTrigger:void 0}):g.a.dispatch({action:v.a.ViewHomePage})}else g.a.dispatch({action:v.a.ViewRoom,room_id:p.a.instance.activeSpace,metricsTrigger:void 0})}const I=e=>{c.b.createDialog(w,{space:e,onFinished:async(t,n)=>{t&&(await Object(_.a)(e,n,(e=>O(e.roomId))),g.a.dispatch({action:v.a.AfterLeaveRoom,room_id:e.roomId}))}},"mx_LeaveSpaceDialog_wrapper")}},function(e,t,n){"use strict";n.d(t,"c",(function(){return u})),n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return m}));var i=n(13),s=n.n(i),o=n(364);let r=null,a=0;var c=n(1),l=n(159),d=n(190);const u=-60;let h;!function(e){e.NewStream="new_stream",e.MuteStateChanged="mute_state_changed",e.LocalVolumeChanged="local_volume_changed",e.VolumeChanged="volume_changed",e.ConnectedChanged="connected_changed",e.Speaking="speaking",e.Disposed="disposed"}(h||(h={}));class m extends l.b{constructor(e){super(),s()(this,"stream",void 0),s()(this,"sdpMetadataStreamId",void 0),s()(this,"userId",void 0),s()(this,"deviceId",void 0),s()(this,"purpose",void 0),s()(this,"speakingVolumeSamples",void 0),s()(this,"client",void 0),s()(this,"call",void 0),s()(this,"roomId",void 0),s()(this,"audioMuted",void 0),s()(this,"videoMuted",void 0),s()(this,"localVolume",1),s()(this,"measuringVolumeActivity",!1),s()(this,"audioContext",void 0),s()(this,"analyser",void 0),s()(this,"frequencyBinCount",void 0),s()(this,"speakingThreshold",u),s()(this,"speaking",!1),s()(this,"volumeLooperTimeout",void 0),s()(this,"_disposed",!1),s()(this,"_connected",!1),s()(this,"onAddTrack",(()=>{this.emit(h.NewStream,this.stream)})),s()(this,"onCallState",(e=>{e===d.f.Connected?this.connected=!0:e===d.f.Connecting&&(this.connected=!1)})),s()(this,"volumeLooper",(()=>{if(!this.analyser)return;if(!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let e=-1/0;for(const t of this.frequencyBinCount)t>e&&(e=t);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(h.VolumeChanged,e);let t=!1;for(const e of this.speakingVolumeSamples)if(e>this.speakingThreshold){t=!0;break}this.speaking!==t&&(this.speaking=t,this.emit(h.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,200)})),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(8).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(d.d.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(h.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){t!==e&&(e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?this.initVolumeMeasuring():this.measureVolumeActivity(!1),this.emit(h.NewStream,this.stream))}initVolumeMeasuring(){if(!this.hasAudioTrack)return;this.audioContext||(this.audioContext=(null===r&&(r=new AudioContext),a++,r)),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}getMember(){var e;const t=this.client.getRoom(this.roomId);return null!==(e=null==t?void 0:t.getMember(this.userId))&&void 0!==e?e:null}isLocal(){return this.userId===this.client.getUserId()&&(void 0===this.deviceId||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){null!==e&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),null!==t&&(this.videoMuted=t),this.emit(h.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(h.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){const e=this.client.getMediaHandler(),t=this.stream.clone();return c.a.log(`CallFeed clone() cloning stream (originalStreamId=${this.stream.id}, newStreamId${t.id})`),this.purpose===o.b.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new m({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t,n;clearTimeout(this.volumeLooperTimeout),null===(e=this.stream)||void 0===e||e.removeEventListener("addtrack",this.onAddTrack),null===(t=this.call)||void 0===t||t.removeListener(d.d.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,a--,0===a&&(null===(n=r)||void 0===n||n.close(),r=null)),this._disposed=!0,this.emit(h.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(h.LocalVolumeChanged,e)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return S})),n.d(t,"a",(function(){return E})),n.d(t,"d",(function(){return w})),n.d(t,"c",(function(){return _}));var i=n(127),s=n.n(i),o=n(1),r=n(123),a=n(128),c=n(122),l=n.n(c),d=n(259),u=n.n(d),h=n(120),m=n.n(h),p=n(276),g=n(121),v=n(146),f=n(136);class b extends m.a.PureComponent{constructor(){super(...arguments),l()(this,"onChange",(e=>{this.props.onChange(this.props.url,e.currentTarget.checked)}))}render(){return m.a.createElement("input",{type:"checkbox",onChange:this.onChange,checked:this.props.checked})}}class y extends m.a.PureComponent{constructor(e){super(e),l()(this,"onCancelClick",(()=>{this.props.onFinished(!1)})),l()(this,"onNextClick",(()=>{this.props.onFinished(!0,Object.keys(this.state.agreedUrls).filter((e=>this.state.agreedUrls[e])))})),l()(this,"onTermsCheckboxChange",((e,t)=>{this.setState({agreedUrls:Object.assign({},this.state.agreedUrls,{[e]:t})})})),this.state={agreedUrls:{}};for(const t of e.agreedUrls)this.state.agreedUrls[t]=!0}nameForServiceType(e,t){switch(e){case p.a.IS:return m.a.createElement("div",null,Object(g.a)("Identity server"),m.a.createElement("br",null),"(",t,")");case p.a.IM:return m.a.createElement("div",null,Object(g.a)("Integration manager"),m.a.createElement("br",null),"(",t,")")}}summaryForServiceType(e){switch(e){case p.a.IS:return m.a.createElement("div",null,Object(g.a)("Find others by phone or email"),m.a.createElement("br",null),Object(g.a)("Be found by phone or email"));case p.a.IM:return m.a.createElement("div",null,Object(g.a)("Use bots, bridges, widgets and sticker packs"))}}render(){const e=[];for(const t of this.props.policiesAndServicePairs){const n=u.a.parse(t.service.baseUrl),i=Object.values(t.policies);for(let s=0;s<i.length;++s){const o=i[s],r=Object(g.j)(Object.keys(o).filter((e=>"version"!==e)));let a,c;0===s&&(a=this.nameForServiceType(t.service.serviceType,n.host),c=this.summaryForServiceType(t.service.serviceType)),e.push(m.a.createElement("tr",{key:o[r].url},m.a.createElement("td",{className:"mx_TermsDialog_service"},a),m.a.createElement("td",{className:"mx_TermsDialog_summary"},c),m.a.createElement("td",null,o[r].name,m.a.createElement("a",{rel:"noreferrer noopener",target:"_blank",href:o[r].url},m.a.createElement("span",{className:"mx_TermsDialog_link"}))),m.a.createElement("td",null,m.a.createElement(b,{url:o[r].url,onChange:this.onTermsCheckboxChange,checked:Boolean(this.state.agreedUrls[o[r].url])}))))}}let t=!1;for(const e of this.props.policiesAndServicePairs){let n=0;for(const t of Object.values(e.policies)){let e=!1;for(const n of Object.keys(t))if("version"!==n&&this.state.agreedUrls[t[n].url]){e=!0;break}e&&++n}if(n===Object.keys(e.policies).length){t=!0;break}}return m.a.createElement(f.a,{fixedWidth:!1,onFinished:this.onCancelClick,title:Object(g.a)("Terms of Service"),contentId:"mx_Dialog_content",hasCancel:!1},m.a.createElement("div",{id:"mx_Dialog_content"},m.a.createElement("p",null,Object(g.a)("To continue you need to accept the terms of this service.")),m.a.createElement("table",{className:"mx_TermsDialog_termsTable"},m.a.createElement("tbody",null,m.a.createElement("tr",{className:"mx_TermsDialog_termsTableHeader"},m.a.createElement("th",null,Object(g.a)("Service")),m.a.createElement("th",null,Object(g.a)("Summary")),m.a.createElement("th",null,Object(g.a)("Document")),m.a.createElement("th",null,Object(g.a)("Accept"))),e))),m.a.createElement(v.a,{primaryButton:Object(g.a)("Next"),hasCancel:!0,onCancel:this.onCancelClick,onPrimaryButtonClick:this.onNextClick,primaryDisabled:!t}))}}class S extends Error{}class E{constructor(e,t,n){this.serviceType=e,this.baseUrl=t,this.accessToken=n}}async function w(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_;const n=e.map((e=>r.a.get().getTerms(e.serviceType,e.baseUrl))),i=(await Promise.all(n)).map(((t,n)=>({service:e[n],policies:t.policies}))),s=await r.a.get().getAccountData("m.accepted_terms");let a;a=s&&s.getContent()&&s.getContent().accepted?new Set(s.getContent().accepted):new Set;const c=[];for(const{service:e,policies:t}of i){const n={};for(const[e,i]of Object.entries(t)){let t=!1;for(const e of Object.keys(i))if("version"!==e&&a.has(i[e].url)){t=!0;break}t||(n[e]=i)}Object.keys(n).length>0&&c.push({service:e,policies:n})}const l=a.size;if(c.length>0){const e=await t(c,[...a]);o.a.log("User has agreed to URLs",e),e.forEach((e=>a.add(e)))}else o.a.log("User has already agreed to all required policies");if(a.size!==l){const e={accepted:Array.from(a)};await r.a.get().setAccountData("m.accepted_terms",e)}const d=i.map((e=>{const t=Array.from(a).filter((t=>{for(const n of Object.values(e.policies))for(const e of Object.keys(n))if("version"!==e&&n[e].url===t)return!0;return!1}));return 0===t.length?Promise.resolve():r.a.get().agreeToTerms(e.service.serviceType,e.service.baseUrl,e.service.accessToken,t)}));await Promise.all(d)}async function _(e,t,n){o.a.log("Terms that need agreement",e);const{finished:i}=a.b.createDialog(y,{policiesAndServicePairs:e,agreedUrls:t},s()("mx_TermsDialog",n)),[r,c]=await i;if(!r)throw new S;return c}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(122),s=n.n(i),o=n(130),r=n(1);class a{constructor(e){this.getFn=e,s()(this,"val",void 0),s()(this,"prom",void 0),s()(this,"done",!1)}get present(){return this.done}get cachedValue(){return this.val}get value(){return this.prom?this.prom:(this.prom=this.getFn(),this.prom.then((e=>(this.val=e,this.done=!0,e))))}}var c=n(160),l=n(548);class d{constructor(e){this.event=e,s()(this,"sourceUrl",void 0),s()(this,"thumbnailUrl",void 0),s()(this,"sourceBlob",void 0),s()(this,"thumbnailBlob",void 0),s()(this,"media",void 0),s()(this,"prepareSourceUrl",(async()=>{if(this.media.isEncrypted){const e=await this.sourceBlob.value;return URL.createObjectURL(e)}return this.media.srcHttp})),s()(this,"prepareThumbnailUrl",(async()=>{if(this.media.isEncrypted){const e=await this.thumbnailBlob.value;return null===e?null:URL.createObjectURL(e)}return this.media.thumbnailHttp})),s()(this,"fetchSource",(()=>{if(this.media.isEncrypted){const e=this.event.getContent();return Object(l.c)(e.file,e.info)}return this.media.downloadSource().then((e=>e.blob()))})),s()(this,"fetchThumbnail",(()=>{if(!this.media.hasThumbnail)return Promise.resolve(null);if(this.media.isEncrypted){var e;const t=this.event.getContent();return null!==(e=t.info)&&void 0!==e&&e.thumbnail_file?Object(l.c)(t.info.thumbnail_file,t.info.thumbnail_info):(r.a.warn("Media claims to have thumbnail and is encrypted, but no thumbnail_file found"),Promise.resolve(null))}return fetch(this.media.thumbnailHttp).then((e=>e.blob()))})),this.sourceUrl=new a(this.prepareSourceUrl),this.thumbnailUrl=new a(this.prepareThumbnailUrl),this.sourceBlob=new a(this.fetchSource),this.thumbnailBlob=new a(this.fetchThumbnail),this.media=Object(c.a)(this.event.getContent())}get fileName(){return this.event.getContent().filename||this.event.getContent().body||"download"}destroy(){this.media.isEncrypted&&(this.sourceUrl.cachedValue&&URL.revokeObjectURL(this.sourceUrl.cachedValue),this.thumbnailUrl.cachedValue&&URL.revokeObjectURL(this.thumbnailUrl.cachedValue))}static isEligible(e){if(!e)return!1;if(e.isRedacted())return!1;if(e.getType()===o.b.Sticker)return!0;if(e.getType()!==o.b.RoomMessage)return!1;const t=e.getContent();return!![o.e.Video,o.e.Audio,o.e.Image,o.e.File].includes(t.msgtype)||"string"==typeof t.url}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(255);class r extends o.c{constructor(e,t){super(t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.a),this.manager=e}async play(){return this.manager.pauseAllExcept(this),super.play()}destroy(){this.manager.destroyPlaybackInstance(this),super.destroy()}}class a{constructor(){s()(this,"instances",[])}static get instance(){return a.internalInstance||(a.internalInstance=new a),a.internalInstance}pauseAllExcept(e){this.instances.filter((t=>t!==e&&t.currentState===o.d.Playing)).forEach((e=>e.pause()))}destroyPlaybackInstance(e){this.instances=this.instances.filter((t=>t!==e))}createPlaybackInstance(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.a;const n=new r(this,e,t);return this.instances.push(n),n}}s()(a,"internalInstance",void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return I}));var i=n(131),s=n.n(i),o=n(122),r=n.n(o),a=n(120),c=n.n(a),l=n(180),d=n(1),u=n(121),h=n(166),m=n(123),p=n(125),g=n(129),v=n(126),f=n(158),b=n(128),y=n(145),S=n(465),E=n(151),w=n(178),_=n(140),C=n(170);var O=e=>{let{ts:t,onDatePicked:n}=e;const i=new Date(t),s=`${i.getFullYear()}-${`${i.getMonth()+1}`.padStart(2,"0")}-${`${i.getDate()}`.padStart(2,"0")}`,[o,r]=Object(a.useState)(s),[l,d,h]=Object(C.i)(),m=e=>{e.preventDefault(),n(o)};return c.a.createElement("form",{className:"mx_JumpToDatePicker_form",onSubmit:m},c.a.createElement("span",{className:"mx_JumpToDatePicker_label"},Object(u.a)("Jump to date")),c.a.createElement(_.a,{element:"input",type:"date",onInput:e=>r(e.target.value),value:o,className:"mx_JumpToDatePicker_datePicker",label:Object(u.a)("Pick a date to jump to"),onFocus:l,inputRef:h,tabIndex:d?0:-1}),c.a.createElement(C.a,{element:"button",type:"submit",kind:"primary",className:"mx_JumpToDatePicker_submitButton",onClick:m},Object(u.a)("Go")))};class I extends c.a.Component{constructor(e){super(e),r()(this,"settingWatcherRef",void 0),r()(this,"onContextMenuOpenClick",(e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})})),r()(this,"onContextMenuCloseClick",(()=>{this.closeMenu()})),r()(this,"closeMenu",(()=>{this.setState({contextMenuPosition:void 0})})),r()(this,"pickDate",(async e=>{const t=new Date(e).getTime(),n=m.a.get();try{const e=this.props.roomId,{event_id:i,origin_server_ts:s}=await n.timestampToEvent(e,t,l.a.Forward);d.a.log(`/timestamp_to_event: found ${i} (${s}) for timestamp=${t} (looking forward)`),p.a.dispatch({action:g.a.ViewRoom,event_id:i,highlighted:!0,room_id:e,metricsTrigger:void 0})}catch(e){const t=e.errcode||e.statusCode;void 0!==t&&b.b.createDialog(y.a,{title:Object(u.a)("Error"),description:Object(u.a)("Unable to find event at that date. (%(code)s)",{code:t})})}})),r()(this,"onLastWeekClicked",(()=>{const e=new Date;e.setDate(e.getDate()-7),this.pickDate(e),this.closeMenu()})),r()(this,"onLastMonthClicked",(()=>{const e=new Date;e.setMonth(e.getMonth()-1,1),this.pickDate(e),this.closeMenu()})),r()(this,"onTheBeginningClicked",(()=>{const e=new Date(0);this.pickDate(e),this.closeMenu()})),r()(this,"onDatePicked",(e=>{this.pickDate(e),this.closeMenu()})),this.state={jumpToDateEnabled:v.b.getValue("feature_jump_to_date")},this.settingWatcherRef=v.b.watchSetting("feature_jump_to_date",null,((e,t,n,i,s)=>{this.setState({jumpToDateEnabled:s})}))}componentWillUnmount(){this.settingWatcherRef&&v.b.unwatchSetting(this.settingWatcherRef)}getLabel(){const e=new Date(this.props.ts),t=!v.b.getValue(f.b.TimelineEnableRelativeDates);if(this.props.forExport||t)return Object(h.g)(e);const n=new Date,i=new Date,s=[Object(u.a)("Sunday"),Object(u.a)("Monday"),Object(u.a)("Tuesday"),Object(u.a)("Wednesday"),Object(u.a)("Thursday"),Object(u.a)("Friday"),Object(u.a)("Saturday")];return i.setDate(n.getDate()-1),e.toDateString()===n.toDateString()?Object(u.a)("Today"):e.toDateString()===i.toDateString()?Object(u.a)("Yesterday"):n.getTime()-e.getTime()<5184e5?s[e.getDay()]:Object(h.g)(e)}renderJumpToDateMenu(){let e;return this.state.contextMenuPosition&&(e=c.a.createElement(w.e,s()({},Object(S.a)(this.state.contextMenuPosition),{onFinished:this.onContextMenuCloseClick}),c.a.createElement(w.c,{first:!0},c.a.createElement(w.b,{label:Object(u.a)("Last week"),onClick:this.onLastWeekClicked}),c.a.createElement(w.b,{label:Object(u.a)("Last month"),onClick:this.onLastMonthClicked}),c.a.createElement(w.b,{label:Object(u.a)("The beginning of the room"),onClick:this.onTheBeginningClicked})),c.a.createElement(w.c,null,c.a.createElement(O,{ts:this.props.ts,onDatePicked:this.onDatePicked})))),c.a.createElement(E.c,{className:"mx_DateSeparator_jumpToDateMenu",onClick:this.onContextMenuOpenClick,isExpanded:!!this.state.contextMenuPosition,title:Object(u.a)("Jump to date")},c.a.createElement("h2",{"aria-hidden":"true"},this.getLabel()),c.a.createElement("div",{className:"mx_DateSeparator_chevron"}),e)}render(){const e=this.getLabel();let t;return t=this.state.jumpToDateEnabled?this.renderJumpToDateMenu():c.a.createElement("h2",{"aria-hidden":"true"},e),c.a.createElement("div",{className:"mx_DateSeparator",role:"separator",tabIndex:-1,"aria-label":e},c.a.createElement("hr",{role:"none"}),t,c.a.createElement("hr",{role:"none"}))}}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{constructor(e,t){this.roomId=e}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i=new(n(15).b)("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications")},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.SessionLoggedOut="Session.logged_out",e.NoConsent="no_consent"}(i||(i={}))},function(e,t,n){"use strict";let i,s,o;n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return o})),function(e){e.R0="/_matrix/client/r0",e.V1="/_matrix/client/v1",e.V3="/_matrix/client/v3",e.Unstable="/_matrix/client/unstable"}(i||(i={})),function(e){e.V2="/_matrix/identity/v2"}(s||(s={})),function(e){e.R0="/_matrix/media/r0"}(o||(o={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return h}));var i=n(13),s=n.n(i),o=n(1),r=n(190),a=n(130),c=n(149),l=n(226),d=n(141);let u;!function(e){e.Incoming="Call.incoming"}(u||(u={}));class h{constructor(e){s()(this,"calls",void 0),s()(this,"callEventBuffer",void 0),s()(this,"nextSeqByCall",new Map),s()(this,"toDeviceEventBuffers",new Map),s()(this,"client",void 0),s()(this,"candidateEventsByCall",void 0),s()(this,"eventBufferPromiseChain",void 0),s()(this,"onSync",(()=>{const e=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then((()=>this.evaluateEventBuffer(e))):this.eventBufferPromiseChain=this.evaluateEventBuffer(e)})),s()(this,"onRoomTimeline",(e=>{this.callEventBuffer.push(e)})),s()(this,"onToDeviceEvent",(e=>{const t=e.getContent();if(!t.call_id)return void this.callEventBuffer.push(e);if(this.nextSeqByCall.has(t.call_id)||this.nextSeqByCall.set(t.call_id,0),void 0===t.seq)return void this.callEventBuffer.push(e);const n=this.nextSeqByCall.get(t.call_id)||0;if(t.seq!==n){this.toDeviceEventBuffers.has(t.call_id)||this.toDeviceEventBuffers.set(t.call_id,[]);const n=this.toDeviceEventBuffers.get(t.call_id),i=n.findIndex((e=>e.getContent().seq>t.seq));-1===i?n.push(e):n.splice(i,0,e)}else{const n=t.call_id;this.callEventBuffer.push(e),this.nextSeqByCall.set(n,t.seq+1);const i=this.toDeviceEventBuffers.get(n);let s=i&&i.shift();for(;s&&s.getContent().seq===this.nextSeqByCall.get(n);)this.callEventBuffer.push(s),this.nextSeqByCall.set(n,s.getContent().seq+1),s=i.shift()}})),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(c.b.Sync,this.onSync),this.client.on(d.d.Timeline,this.onRoomTimeline),this.client.on(c.b.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(c.b.Sync,this.onSync),this.client.removeListener(d.d.Timeline,this.onRoomTimeline),this.client.removeListener(c.b.ToDeviceEvent,this.onToDeviceEvent)}async evaluateEventBuffer(e){await Promise.all(e.map((e=>this.client.decryptEventIfNeeded(e))));const t=e.filter((e=>{const t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")})),n=new Set;for(const e of t){const t=e.getType();t!==a.b.CallAnswer&&t!==a.b.CallHangup||n.add(e.getContent().call_id)}for(const e of t){const t=e.getType(),i=e.getContent().call_id;if(t!==a.b.CallInvite||!n.has(i))try{await this.handleCallEvent(e)}catch(e){o.a.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",e)}}}async handleCallEvent(e){var t,n;this.client.emit(c.b.ReceivedVoipEvent,e);const i=e.getContent(),s=e.getRoomId()||(null===(t=this.client.groupCallEventHandler.getGroupCallById(i.conf_id))||void 0===t||null===(n=t.room)||void 0===n?void 0:n.roomId),d=i.conf_id,h=e.getType(),m=e.getSender();let p,g,v=i.call_id?this.calls.get(i.call_id):void 0;if(d){if(g=this.client.groupCallEventHandler.getGroupCallById(d),!g)return void o.a.warn(`CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=${d}, type=${h})`);if(p=i.device_id,!p)return o.a.warn(`CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=${m})`),void g.emit(l.c.Error,new l.g(m));if(i.dest_session_id!==this.client.getSessionId())return void o.a.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring")}const f=m===this.client.credentials.userId&&(void 0===p||p===this.client.getDeviceId());if(s)if(h!==a.b.CallInvite)if(h!==a.b.CallCandidates){var b;if([a.b.CallHangup,a.b.CallReject].includes(h))v?v.state!==r.f.Ended&&(h===a.b.CallHangup?v.onHangupReceived(i):v.onRejectReceived(i),v.state===r.f.Ended&&this.calls.delete(i.call_id)):(v=null!==(b=Object(r.h)(this.client,s,{opponentDeviceId:p,opponentSessionId:i.sender_session_id}))&&void 0!==b?b:void 0,v&&(v.callId=i.call_id,v.initWithHangup(e),this.calls.set(i.call_id,v)));else if(v&&v.hasPeerConnection){if(e.getContent().party_id!==v.ourPartyId)switch(h){case a.b.CallAnswer:f?v.state===r.f.Ringing&&v.onAnsweredElsewhere(i):v.onAnswerReceived(e);break;case a.b.CallSelectAnswer:v.onSelectAnswerReceived(e);break;case a.b.CallNegotiate:v.onNegotiateReceived(e);break;case a.b.CallAssertedIdentity:case a.b.CallAssertedIdentityPrefix:v.onAssertedIdentityReceived(e);break;case a.b.CallSDPStreamMetadataChanged:case a.b.CallSDPStreamMetadataChangedPrefix:v.onSDPStreamMetadataChangedReceived(e)}}else o.a.info(`CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=${h})`)}else{if(f)return;v?v.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(i.call_id)||this.candidateEventsByCall.set(i.call_id,[]),this.candidateEventsByCall.get(i.call_id).push(e))}else{var y,S;if(f)return;if(e.getLocalAge()>i.lifetime-3e3)return;if(v&&v.state===r.f.Ended)return;if(v&&o.a.warn(`CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=${i.call_id})`),i.invitee&&i.invitee!==this.client.getUserId())return;const t=(null!==(y=this.client.getTurnServersExpiry())&&void 0!==y?y:0)-Date.now();if(o.a.info("CallEventHandler handleCallEvent() current turn creds expire in "+t+" ms"),v=null!==(S=Object(r.h)(this.client,s,{forceTURN:this.client.forceTURN,opponentDeviceId:p,groupCallId:d,opponentSessionId:i.sender_session_id}))&&void 0!==S?S:void 0,!v)return void o.a.log(`CallEventHandler handleCallEvent() this client does not support WebRTC (callId=${i.call_id})`);v.callId=i.call_id;try{await v.initWithInvite(e)}catch(e){var E;if(e instanceof r.b)if(e.code===l.b.UnknownDevice)null===(E=g)||void 0===E||E.emit(l.c.Error,e);else o.a.error(e)}if(this.calls.set(v.callId,v),this.candidateEventsByCall.get(v.callId))for(const e of this.candidateEventsByCall.get(v.callId))v.onRemoteIceCandidatesReceived(e);let n;for(const e of this.calls.values()){var w;const t=[r.f.WaitLocalMedia,r.f.CreateOffer,r.f.InviteSent].includes(e.state);if(v.roomId===e.roomId&&e.direction===r.a.Outbound&&(null===(w=v.getOpponentMember())||void 0===w?void 0:w.userId)===e.invitee&&t){n=e;break}}n?n.callId>v.callId?(o.a.log(`CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=${v.callId}, outgoingId=${n.callId})`),n.replacedBy(v)):(o.a.log(`CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=${v.callId}, outgoingId=${n.callId})`),v.hangup(r.c.Replaced,!0)):this.client.emit(u.Incoming,v)}}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return h}));var i=n(13),s=n.n(i),o=n(149),r=n(226),a=n(152),c=n(1),l=n(130),d=n(219);let u;!function(e){e.Incoming="GroupCall.incoming",e.Outgoing="GroupCall.outgoing",e.Ended="GroupCall.ended",e.Participants="GroupCall.participants"}(u||(u={}));class h{constructor(e){this.client=e,s()(this,"groupCalls",new Map),s()(this,"roomDeferreds",new Map),s()(this,"onRoomsChanged",(e=>{this.createGroupCallForRoom(e)})),s()(this,"onRoomStateChanged",((e,t)=>{if(e.getType()===l.b.GroupCallPrefix){const n=e.getStateKey(),i=e.getContent(),s=this.groupCalls.get(t.roomId);s||i["m.terminated"]?s&&s.groupCallId===n?i["m.terminated"]?s.terminate(!1):i["m.type"]!==s.type&&c.a.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=${t.roomId})`):s&&s.groupCallId!==n&&c.a.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=${t.roomId})`):this.createGroupCallFromRoomStateEvent(e)}}))}async start(){this.client.getSyncState()!==d.b.Syncing&&(c.a.debug("GroupCallEventHandler start() waiting for client to start syncing"),await new Promise((e=>{const t=()=>{if(this.client.getSyncState()===d.b.Syncing)return this.client.off(o.b.Sync,t),e()};this.client.on(o.b.Sync,t)})));const e=this.client.getRooms();for(const t of e)this.createGroupCallForRoom(t);this.client.on(o.b.Room,this.onRoomsChanged),this.client.on(a.b.Events,this.onRoomStateChanged)}stop(){this.client.removeListener(a.b.Events,this.onRoomStateChanged)}getRoomDeferred(e){let t=this.roomDeferreds.get(e);if(void 0===t){let n;t={prom:new Promise((e=>{n=e}))},t.resolve=n,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find((t=>t.groupCallId===e))}createGroupCallForRoom(e){const t=e.currentState.getStateEvents(l.b.GroupCallPrefix),n=t.sort(((e,t)=>t.getTs()-e.getTs()));for(const i of n){if(!i.getContent()["m.terminated"]){c.a.debug(`GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=${i.getStateKey()}, ts=${i.getTs()}, roomId=${e.roomId}, numOfPossibleCalls=${t.length})`),this.createGroupCallFromRoomStateEvent(i);break}}c.a.info(`GroupCallEventHandler createGroupCallForRoom() processed room (roomId=${e.roomId})`),this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){const t=e.getRoomId(),n=e.getContent(),i=this.client.getRoom(t);if(!i)return void c.a.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=${t})`);const s=e.getStateKey(),o=n["m.type"];if(!Object.values(r.f).includes(o))return void c.a.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=${o}, roomId=${t})`);const a=n["m.intent"];if(!Object.values(r.d).includes(a))return void c.a.warn(`Received invalid group call intent (type=${o}, roomId=${t})`);const l=Boolean(n["io.element.ptt"]);let d;if(null!=n&&n.dataChannelsEnabled&&null!=n&&n.dataChannelOptions){const{ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s}=n.dataChannelOptions;d={ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s}}const h=new r.a(this.client,i,o,l,a,s,(null==n?void 0:n.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,d,this.client.isVoipWithNoMediaAllowed);return this.groupCalls.set(i.roomId,h),this.client.emit(u.Incoming,h),h}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return S}));var i=n(1),s=n(357),o=n(16);const r="crypto.",a=r+"account",c=r+"cross_signing_keys",l=r+"notified_error_devices",d=r+"device_data",u=r+"inboundgroupsessions/",h=r+"inboundgroupsessions.withheld/",m=r+"rooms/",p=r+"sessionsneedingbackup";function g(e){return r+"sessions/"+e}function v(e){return r+"session.problems/"+e}function f(e,t){return u+e+"/"+t}function b(e,t){return h+e+"/"+t}function y(e){return m+e}class S extends s.a{static exists(e){const t=e.length;for(let i=0;i<t;i++){var n;if(null!==(n=e.key(i))&&void 0!==n&&n.startsWith(r))return!0}return!1}constructor(e){super(),this.store=e}countEndToEndSessions(e,t){let n=0;for(let e=0;e<this.store.length;++e){var i;null!==(i=this.store.key(e))&&void 0!==i&&i.startsWith(g(""))&&++n}t(n)}_getEndToEndSessions(e){const t=E(this.store,g(e)),n={};for(const[e,i]of Object.entries(t||{}))n[e]="string"==typeof i?{session:i}:i;return n}getEndToEndSession(e,t,n,i){i(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,n){n(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e){var n;if(null!==(n=this.store.key(e))&&void 0!==n&&n.startsWith(g(""))){const n=this.store.key(e).split("/")[1];for(const e of Object.values(this._getEndToEndSessions(n)))t(e)}}}storeEndToEndSession(e,t,n,i){const s=this._getEndToEndSessions(e)||{};s[t]=n,w(this.store,g(e),s)}async storeEndToEndSessionProblem(e,t,n){const i=v(e),s=E(this.store,i)||[];s.push({type:t,fixed:n,time:Date.now()}),s.sort(((e,t)=>e.time-t.time)),w(this.store,i,s)}async getEndToEndSessionProblem(e,t){const n=v(e),i=E(this.store,n)||[];if(!i.length)return null;const s=i[i.length-1];for(const e of i)if(e.time>t)return Object.assign({},e,{fixed:s.fixed});return s.fixed?null:s}async filterOutNotifiedErrorDevices(e){const t=E(this.store,l)||{},n=[];for(const i of e){const{userId:e,deviceInfo:s}=i;e in t?s.deviceId in t[e]||(n.push(i),Object(o.L)(t[e],s.deviceId,!0)):(n.push(i),Object(o.L)(t,e,{[s.deviceId]:!0}))}return w(this.store,l,t),n}getEndToEndInboundGroupSession(e,t,n,i){i(E(this.store,f(e,t)),E(this.store,b(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){const n=this.store.key(e);null!=n&&n.startsWith(u)&&t({senderKey:n.slice(u.length,u.length+43),sessionId:n.slice(u.length+44),sessionData:E(this.store,n)})}t(null)}addEndToEndInboundGroupSession(e,t,n,i){E(this.store,f(e,t))||this.storeEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSession(e,t,n,i){w(this.store,f(e,t),n)}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){w(this.store,b(e,t),n)}getEndToEndDeviceData(e,t){t(E(this.store,d))}storeEndToEndDeviceData(e,t){w(this.store,d,e)}storeEndToEndRoom(e,t,n){w(this.store,y(e),t)}getEndToEndRooms(e,t){const n={},i=y("");for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(null!=t&&t.startsWith(i)){n[t.slice(i.length)]=E(this.store,t)}}t(n)}getSessionsNeedingBackup(e){const t=E(this.store,p)||{},n=[];for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){const t=i.slice(0,43),s=i.slice(44);if(this.getEndToEndInboundGroupSession(t,s,null,(e=>{n.push({senderKey:t,sessionId:s,sessionData:e})})),e&&n.length>=e)break}return Promise.resolve(n)}countSessionsNeedingBackup(){const e=E(this.store,p)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=E(this.store,p)||{};for(const n of e)delete t[n.senderKey+"/"+n.sessionId];return w(this.store,p,t),Promise.resolve()}markSessionsNeedingBackup(e){const t=E(this.store,p)||{};for(const n of e)t[n.senderKey+"/"+n.sessionId]=!0;return w(this.store,p,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(a),Promise.resolve()}getAccount(e,t){t(E(this.store,a))}storeAccount(e,t){w(this.store,a,t)}getCrossSigningKeys(e,t){t(E(this.store,c))}getSecretStorePrivateKey(e,t,n){t(E(this.store,r+`ssss_cache.${n}`))}storeCrossSigningKeys(e,t){w(this.store,c,t)}storeSecretStorePrivateKey(e,t,n){w(this.store,r+`ssss_cache.${t}`,n)}doTxn(e,t,n){return Promise.resolve(n(null))}}function E(e,t){try{return JSON.parse(e.getItem(t))}catch(e){i.a.log("Error: Failed to get key %s: %s",t,e.message),i.a.log(e.stack)}return null}function w(e,t,n){e.setItem(t,JSON.stringify(n))}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var i=n(13),s=n.n(i),o=n(1),r=n(227),a=n(691);const c=49152;class l extends Error{constructor(){super(...arguments),s()(this,"data",{errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"})}}function d(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>c)throw new l(`Message too long (${e.length} bytes). The maximum for an encrypted message is ${c} bytes.`)}class u{constructor(e){this.cryptoStore=e,s()(this,"pickleKey","DEFAULT_KEY"),s()(this,"deviceCurve25519Key",null),s()(this,"deviceEd25519Key",null),s()(this,"maxOneTimeKeys",null),s()(this,"outboundGroupSessionStore",{}),s()(this,"inboundGroupSessionMessageIndexes",{}),s()(this,"sessionsInProgress",{}),s()(this,"olmPrekeyPromise",Promise.resolve())}static getOlmVersion(){return e.Olm.get_library_version()}async init(){let t,{pickleKey:n,fromExportedDevice:i}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const s=new e.Olm.Account;try{i?(n&&o.a.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=i.pickleKey,await this.initialiseFromExportedDevice(i,s)):(n&&(this.pickleKey=n),await this.initialiseAccount(s)),t=JSON.parse(s.identity_keys()),this.maxOneTimeKeys=s.max_number_of_one_time_keys()}finally{s.free()}this.deviceCurve25519Key=t.curve25519,this.deviceEd25519Key=t.ed25519}async initialiseFromExportedDevice(e,t){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT,r.a.STORE_SESSIONS],(t=>{this.cryptoStore.storeAccount(t,e.pickledAccount),e.sessions.forEach((e=>{const{deviceKey:n,sessionId:i}=e,s={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(n,i,s,t)}))})),t.unpickle(this.pickleKey,e.pickledAccount)}async initialiseAccount(e){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],(t=>{this.cryptoStore.getAccount(t,(n=>{null!==n?e.unpickle(this.pickleKey,n):(e.create(),n=e.pickle(this.pickleKey),this.cryptoStore.storeAccount(t,n))}))}))}getAccount(t,n){this.cryptoStore.getAccount(t,(t=>{const i=new e.Olm.Account;try{i.unpickle(this.pickleKey,t),n(i)}finally{i.free()}}))}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}async export(){const e={pickleKey:this.pickleKey};return await this.cryptoStore.doTxn("readonly",[r.a.STORE_ACCOUNT,r.a.STORE_SESSIONS],(t=>{this.cryptoStore.getAccount(t,(t=>{e.pickledAccount=t})),e.sessions=[],this.cryptoStore.getAllEndToEndSessions(t,(t=>{e.sessions.push(t)}))})),e}getSession(e,t,n,i){this.cryptoStore.getEndToEndSession(e,t,n,(e=>{this.unpickleSession(e,i)}))}unpickleSession(t,n){const i=new e.Olm.Session;try{i.unpickle(this.pickleKey,t.session);n(Object.assign({},t,{session:i}))}finally{i.free()}}saveSession(e,t,n){const i=t.session.session_id();o.a.debug(`Saving Olm session ${i} with device ${e}: ${t.session.describe()}`);const s=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,i,s,n)}getUtility(t){const n=new e.Olm.Utility;try{return t(n)}finally{n.free()}}async sign(e){let t;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_ACCOUNT],(n=>{this.getAccount(n,(n=>{t=n.sign(e)}))})),t}async getOneTimeKeys(){let e;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_ACCOUNT],(t=>{this.getAccount(t,(t=>{e=JSON.parse(t.one_time_keys())}))})),e}maxNumberOfOneTimeKeys(){var e;return null!==(e=this.maxOneTimeKeys)&&void 0!==e?e:-1}async markKeysAsPublished(){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.mark_keys_as_published(),this.storeAccount(e,t)}))}))}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],(t=>{this.getAccount(t,(n=>{n.generate_one_time_keys(e),this.storeAccount(t,n)}))}))}async generateFallbackKey(){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.generate_fallback_key(),this.storeAccount(e,t)}))}))}async getFallbackKey(){let e;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_ACCOUNT],(t=>{this.getAccount(t,(t=>{e=JSON.parse(t.unpublished_fallback_key())}))})),e}async forgetOldFallbackKey(){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.forget_old_fallback_key(),this.storeAccount(e,t)}))}))}async createOutboundSession(t,n){let i;return await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT,r.a.STORE_SESSIONS],(s=>{this.getAccount(s,(o=>{const r=new e.Olm.Session;try{r.create_outbound(o,t,n),i=r.session_id(),this.storeAccount(s,o);const e={session:r,lastReceivedMessageTs:Date.now()};this.saveSession(t,e,s)}finally{r.free()}}))}),o.a.withPrefix("[createOutboundSession]")),i}async createInboundSession(t,n,i){if(0!==n)throw new Error("Need messageType == 0 to create inbound session");let s;return await this.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT,r.a.STORE_SESSIONS],(o=>{this.getAccount(o,(r=>{const a=new e.Olm.Session;try{a.create_inbound_from(r,t,i),r.remove_one_time_keys(a),this.storeAccount(o,r);const e=a.decrypt(n,i),c={session:a,lastReceivedMessageTs:Date.now()};this.saveSession(t,c,o),s={payload:e,session_id:a.session_id()}}finally{a.free()}}))}),o.a.withPrefix("[createInboundSession]")),s}async getSessionIdsForDevice(e){const t=o.a.withPrefix("[getSessionIdsForDevice]");if(e in this.sessionsInProgress){t.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}let n;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_SESSIONS],(t=>{this.cryptoStore.getEndToEndSessions(e,t,(e=>{n=Object.keys(e)}))}),t),n}async getSessionIdForDevice(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;const i=await this.getSessionInfoForDevice(e,t,n);if(0===i.length)return null;let s=0;for(let e=1;e<i.length;e++){const t=i[e],n=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,o=i[s],r=void 0===o.lastReceivedMessageTs?0:o.lastReceivedMessageTs;(n>r||n===r&&t.sessionId<o.sessionId)&&(s=e)}return i[s].sessionId}async getSessionInfoForDevice(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.a;if(n=n.withPrefix("[getSessionInfoForDevice]"),e in this.sessionsInProgress&&!t){n.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}const i=[];return await this.cryptoStore.doTxn("readonly",[r.a.STORE_SESSIONS],(t=>{this.cryptoStore.getEndToEndSessions(e,t,(e=>{const t=Object.keys(e).sort();for(const n of t)this.unpickleSession(e[n],(e=>{i.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:n})}))}))}),n),i}async encryptMessage(e,t,n){let i;return d(n),await this.cryptoStore.doTxn("readwrite",[r.a.STORE_SESSIONS],(s=>{this.getSession(e,t,s,(r=>{const a=r.session.describe();o.a.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),i=r.session.encrypt(n),this.saveSession(e,r,s)}))}),o.a.withPrefix("[encryptMessage]")),i}async decryptMessage(e,t,n,i){let s;return await this.cryptoStore.doTxn("readwrite",[r.a.STORE_SESSIONS],(r=>{this.getSession(e,t,r,(a=>{const c=a.session.describe();o.a.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),s=a.session.decrypt(n,i),a.lastReceivedMessageTs=Date.now(),this.saveSession(e,a,r)}))}),o.a.withPrefix("[decryptMessage]")),s}async matchesSession(e,t,n,i){if(0!==n)return!1;let s;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_SESSIONS],(n=>{this.getSession(e,t,n,(e=>{s=e.session.matches_inbound(i)}))}),o.a.withPrefix("[matchesSession]")),s}async recordSessionProblem(e,t,n){o.a.info(`Recording problem on olm session with ${e} of type ${t}. Recreating: ${n}`),await this.cryptoStore.storeEndToEndSessionProblem(e,t,n)}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(t,n){const i=this.outboundGroupSessionStore[t];if(void 0===i)throw new Error("Unknown outbound group session "+t);const s=new e.Olm.OutboundGroupSession;try{return s.unpickle(this.pickleKey,i),n(s)}finally{s.free()}}createOutboundGroupSession(){const t=new e.Olm.OutboundGroupSession;try{return t.create(),this.saveOutboundGroupSession(t),t.session_id()}finally{t.free()}}encryptGroupMessage(e,t){return o.a.log(`encrypting msg with megolm session ${e}`),d(t),this.getOutboundGroupSession(e,(e=>{const n=e.encrypt(t);return this.saveOutboundGroupSession(e),n}))}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))}unpickleInboundGroupSession(t,n){const i=new e.Olm.InboundGroupSession;try{return i.unpickle(this.pickleKey,t.session),n(i)}finally{i.free()}}getInboundGroupSession(e,t,n,i,s){this.cryptoStore.getEndToEndInboundGroupSession(t,n,i,((t,n)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this.unpickleInboundGroupSession(t,(e=>{s(e,t,n)}))}else s(null,null,n)}))}async addInboundGroupSession(t,n,i,s,a,c,l){let d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};await this.cryptoStore.doTxn("readwrite",[r.a.STORE_INBOUND_GROUP_SESSIONS,r.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,r.a.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(r=>{this.getInboundGroupSession(t,n,s,r,((u,h)=>{const m=new e.Olm.InboundGroupSession;try{if(l?m.import_session(a):m.create(a),s!=m.session_id())throw new Error("Mismatched group session ID from senderKey: "+n);if(u&&(o.a.log(`Update for megolm session ${n}|${s}`),u.first_known_index()<=m.first_known_index())){if(!h.untrusted||d.untrusted)return void o.a.log(`Keeping existing megolm session ${n}|${s}`);if(u.first_known_index()<m.first_known_index())return void(u.export_session(m.first_known_index())===m.export_session(m.first_known_index())?(o.a.info(`Upgrading trust of existing megolm session ${n}|${s} based on newly-received trusted session`),h.untrusted=!1,this.cryptoStore.storeEndToEndInboundGroupSession(n,s,h,r)):o.a.warn(`Newly-received megolm session ${n}|$sessionId} does not match existing session! Keeping existing session`))}o.a.info(`Storing megolm session ${n}|${s} with first index `+m.first_known_index());const e=Object.assign({},d,{room_id:t,session:m.pickle(this.pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:i});this.cryptoStore.storeEndToEndInboundGroupSession(n,s,e,r),!u&&d.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(t,n,s,r)}finally{m.free()}}))}),o.a.withPrefix("[addInboundGroupSession]"))}async addInboundGroupSessionWithheld(e,t,n,i,s){await this.cryptoStore.doTxn("readwrite",[r.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(o=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,n,{room_id:e,code:i,reason:s},o)}))}async decryptGroupMessage(e,t,n,i,s,c){let l,d=null;if(await this.cryptoStore.doTxn("readwrite",[r.a.STORE_INBOUND_GROUP_SESSIONS,r.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(o=>{this.getInboundGroupSession(e,t,n,o,((e,r,u)=>{if(null===e||null===r)return u&&(l=new a.b("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",m(u),{session:t+"|"+n})),void(d=null);let h;try{h=e.decrypt(i)}catch(e){return void(l="OLM.UNKNOWN_MESSAGE_INDEX"===(null==e?void 0:e.message)&&u?new a.b("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",m(u),{session:t+"|"+n}):e)}let p=h.plaintext;if(void 0===p)p=h;else{const e=t+"|"+n+"|"+h.message_index;if(e in this.inboundGroupSessionMessageIndexes){const t=this.inboundGroupSessionMessageIndexes[e];if(t.id!==s||t.timestamp!==c)return void(l=new Error("Duplicate message index, possible replay attack: "+e))}this.inboundGroupSessionMessageIndexes[e]={id:s,timestamp:c}}r.session=e.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(t,n,r,o),d={result:p,keysClaimed:r.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:r.forwardingCurve25519KeyChain||[],untrusted:!!r.untrusted}}))}),o.a.withPrefix("[decryptGroupMessage]")),l)throw l;return d}async hasInboundSessionKeys(e,t,n){let i;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_INBOUND_GROUP_SESSIONS,r.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(s=>{this.cryptoStore.getEndToEndInboundGroupSession(t,n,s,(s=>{null!==s?e!==s.room_id?(o.a.warn(`requested keys for inbound group session ${t}|${n}, with incorrect room_id (expected ${s.room_id}, was ${e})`),i=!1):i=!0:i=!1}))}),o.a.withPrefix("[hasInboundSessionKeys]")),i}async getInboundGroupSessionKey(e,t,n,i){let s=null;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_INBOUND_GROUP_SESSIONS,r.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(o=>{this.getInboundGroupSession(e,t,n,o,((e,t)=>{if(null===e||null===t)return void(s=null);void 0===i&&(i=e.first_known_index());const n=e.export_session(i),o=(t.keysClaimed||{}).ed25519||null,r=t.forwardingCurve25519KeyChain||[],a="untrusted"in t?t.untrusted:r.length>0;s={chain_index:i,key:n,forwarding_curve25519_key_chain:r,sender_claimed_ed25519_key:o,shared_history:t.sharedHistory||!1,untrusted:a}}))}),o.a.withPrefix("[getInboundGroupSessionKey]")),s}exportInboundGroupSession(e,t,n){return this.unpickleInboundGroupSession(n,(i=>{const s=i.first_known_index();return{sender_key:e,sender_claimed_keys:n.keysClaimed,room_id:n.room_id,session_id:t,session_key:i.export_session(s),forwarding_curve25519_key_chain:n.forwardingCurve25519KeyChain||[],first_known_index:i.first_known_index(),"org.matrix.msc3061.shared_history":n.sharedHistory||!1}}))}async getSharedHistoryInboundGroupSessions(e){let t;return await this.cryptoStore.doTxn("readonly",[r.a.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(n=>{t=this.cryptoStore.getSharedHistoryInboundGroupSessions(e,n)}),o.a.withPrefix("[getSharedHistoryInboundGroupSessionsForRoom]")),t}verifySignature(e,t,n){this.getUtility((function(i){i.ed25519_verify(e,t,n)}))}}const h={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function m(e){return e.code&&e.code in h?h[e.code]:e.reason?e.reason:"decryption key withheld"}}).call(this,n(14))},function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return P})),n.d(t,"a",(function(){return D}));var i=n(13),s=n.n(i),o=n(426),r=n.n(o),a=n(430),c=n(368),l=n(1),d=n(708),u=n(130);const h=u.b.KeyVerificationStart,m=[u.b.KeyVerificationAccept,u.b.KeyVerificationKey,u.b.KeyVerificationMac];let p;const g=Object(c.a)("m.mismatched_sas","Mismatched short authentication string"),v=Object(c.a)("m.mismatched_commitment","Mismatched commitment"),f=[["🐶","dog"],["🐱","cat"],["🦁","lion"],["🐎","horse"],["🦄","unicorn"],["🐷","pig"],["🐘","elephant"],["🐰","rabbit"],["🐼","panda"],["🐓","rooster"],["🐧","penguin"],["🐢","turtle"],["🐟","fish"],["🐙","octopus"],["🦋","butterfly"],["🌷","flower"],["🌳","tree"],["🌵","cactus"],["🍄","mushroom"],["🌏","globe"],["🌙","moon"],["☁️","cloud"],["🔥","fire"],["🍌","banana"],["🍎","apple"],["🍓","strawberry"],["🌽","corn"],["🍕","pizza"],["🎂","cake"],["❤️","heart"],["🙂","smiley"],["🤖","robot"],["🎩","hat"],["👓","glasses"],["🔧","spanner"],["🎅","santa"],["👍","thumbs up"],["☂️","umbrella"],["⌛","hourglass"],["⏰","clock"],["🎁","gift"],["💡","light bulb"],["📕","book"],["✏️","pencil"],["📎","paperclip"],["✂️","scissors"],["🔒","lock"],["🔑","key"],["🔨","hammer"],["☎️","telephone"],["🏁","flag"],["🚂","train"],["🚲","bicycle"],["✈️","aeroplane"],["🚀","rocket"],["🏆","trophy"],["⚽","ball"],["🎸","guitar"],["🎺","trumpet"],["🔔","bell"],["⚓️","anchor"],["🎧","headphones"],["📁","folder"],["📌","pin"]];const b={decimal:d.a,emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map((e=>f[e]))}};function y(e,t){const n={};for(const i of t)i in b&&(n[i]=b[i](Array.from(e)));return n}const S={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function E(e,t){return function(n,i){const s=e[S[t]](n,i);return l.a.log("SAS calculateMAC:",t,[n,i],s),s}}const w={"curve25519-hkdf-sha256":function(e,t,n){const i=`${e.baseApis.getUserId()}|${e.baseApis.deviceId}|${e.ourSASPubKey}|`,s=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,o="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?i+s:s+i)+e.channel.transactionId;return t.generate_bytes(o,n)},curve25519:function(e,t,n){const i=`${e.baseApis.getUserId()}${e.baseApis.deviceId}`,s=`${e.userId}${e.deviceId}`,o="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?i+s:s+i)+e.channel.transactionId;return t.generate_bytes(o,n)}},_=["curve25519-hkdf-sha256","curve25519"],C=["sha256"],O=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],I=Object.keys(b),R=new Set(_),k=new Set(C),x=new Set(O),T=new Set(I);function j(e,t){return Array.isArray(e)?e.filter((e=>t.has(e))):[]}let P;!function(e){e.ShowSas="show_sas"}(P||(P={}));class D extends a.b{constructor(){super(...arguments),s()(this,"waitingForAccept",void 0),s()(this,"ourSASPubKey",void 0),s()(this,"theirSASPubKey",void 0),s()(this,"sasEvent",void 0),s()(this,"doVerification",(async()=>{await e.Olm.init(),p=p||new e.Olm.Utility,await this.baseApis.downloadKeys([this.userId]);let t=!1;do{try{return this.initiatedByMe?await this.doSendVerification():await this.doRespondVerification()}catch(e){if(!(e instanceof a.a))throw e;this.startEvent=e.startEvent,t=!0}}while(t)}))}static get NAME(){return"m.sas.v1"}get events(){return m}canSwitchStartEvent(e){if(e.getType()!==h)return!1;const t=e.getContent();return(null==t?void 0:t.method)===D.NAME&&!!this.waitingForAccept}async sendStart(){const e=this.channel.completeContent(h,{method:D.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:_,hashes:C,message_authentication_codes:O,short_authentication_string:I});return await this.channel.sendCompleted(h,e),e}async verifyAndCheckMAC(e,t,n,i){const s=w[e](this,n,6),o=new Promise(((e,o)=>{this.sasEvent={sas:y(s,t),confirm:async()=>{try{await this.sendMAC(n,i),e()}catch(e){o(e)}},cancel:()=>o(Object(c.h)()),mismatch:()=>o(g())},this.emit(P.ShowSas,this.sasEvent)})),[r]=await Promise.all([this.waitForEvent(u.b.KeyVerificationMac).then((e=>(this.expectedEvent=u.b.KeyVerificationDone,e))),o]),a=r.getContent();await this.checkMAC(n,a,i)}async doSendVerification(){let t,n;if(this.waitingForAccept=!0,t=this.startEvent?this.channel.completedContentFromEvent(this.startEvent):await this.sendStart(),!this.initiatedByMe)throw new a.a(this.startEvent);try{n=await this.waitForEvent(u.b.KeyVerificationAccept)}finally{this.waitingForAccept=!1}let i=n.getContent();const s=j(i.short_authentication_string,T);if(!(R.has(i.key_agreement_protocol)&&k.has(i.hash)&&x.has(i.message_authentication_code)&&s.length))throw Object(c.g)();if("string"!=typeof i.commitment)throw Object(c.c)();const o=i.key_agreement_protocol,l=i.message_authentication_code,d=i.commitment,h=new e.Olm.SAS;try{this.ourSASPubKey=h.get_pubkey(),await this.send(u.b.KeyVerificationKey,{key:this.ourSASPubKey}),n=await this.waitForEvent(u.b.KeyVerificationKey),i=n.getContent();const e=i.key+r.a.stringify(t);if(p.sha256(e)!==d)throw v();this.theirSASPubKey=i.key,h.set_their_key(i.key),await this.verifyAndCheckMAC(o,s,h,l)}finally{h.free()}}async doRespondVerification(){let t=this.channel.completedContentFromEvent(this.startEvent);const n=j(_,new Set(t.key_agreement_protocols))[0],i=j(C,new Set(t.hashes))[0],s=j(O,new Set(t.message_authentication_codes))[0],o=j(t.short_authentication_string,T);if(void 0===n||void 0===i||void 0===s||!o.length)throw Object(c.g)();const a=new e.Olm.SAS;try{const e=a.get_pubkey()+r.a.stringify(t);await this.send(u.b.KeyVerificationAccept,{key_agreement_protocol:n,hash:i,message_authentication_code:s,short_authentication_string:o,commitment:p.sha256(e)});t=(await this.waitForEvent(u.b.KeyVerificationKey)).getContent(),this.theirSASPubKey=t.key,a.set_their_key(t.key),this.ourSASPubKey=a.get_pubkey(),await this.send(u.b.KeyVerificationKey,{key:this.ourSASPubKey}),await this.verifyAndCheckMAC(n,o,a,s)}finally{a.free()}}sendMAC(e,t){const n={},i=[],s="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,o=`ed25519:${this.baseApis.deviceId}`;n[o]=E(e,t)(this.baseApis.getDeviceEd25519Key(),s+o),i.push(o);const r=this.baseApis.getCrossSigningId();if(r){const o=`ed25519:${r}`;n[o]=E(e,t)(r,s+o),i.push(o)}const a=E(e,t)(i.sort().join(","),s+"KEY_IDS");return this.send(u.b.KeyVerificationMac,{mac:n,keys:a})}async checkMAC(e,t,n){const i="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(t.keys!==E(e,n)(Object.keys(t.mac).sort().join(","),i+"KEY_IDS"))throw Object(c.d)();await this.verifyKeys(this.userId,t.mac,((t,s,o)=>{if(o!==E(e,n)(s.keys[t],i+t))throw Object(c.d)()}))}}}).call(this,n(14))},function(e,t,n){"use strict";n.d(t,"d",(function(){return d})),n.d(t,"c",(function(){return u})),n.d(t,"b",(function(){return h})),n.d(t,"g",(function(){return m})),n.d(t,"a",(function(){return p})),n.d(t,"f",(function(){return g})),n.d(t,"e",(function(){return f}));var i=n(13),s=n.n(i),o=n(1),r=n(159),a=n(16);function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const d="*",u="$ME",h="$LAZY";let m,p,g;!function(e){e.RequestFinished="FINISHED",e.Complete="COMPLETE"}(m||(m={}));class v{constructor(e){s()(this,"list",void 0),s()(this,"isModified",void 0),s()(this,"roomIndexToRoomId",{}),s()(this,"joinedCount",0),this.replaceList(e)}setModified(e){this.isModified=e}updateListRange(e){this.list.ranges=JSON.parse(JSON.stringify(e))}replaceList(e){e.filters=e.filters||{},e.ranges=e.ranges||[],this.list=JSON.parse(JSON.stringify(e)),this.isModified=!0,this.roomIndexToRoomId={},this.joinedCount=0}getList(e){let t={ranges:JSON.parse(JSON.stringify(this.list.ranges))};return(this.isModified||e)&&(t=JSON.parse(JSON.stringify(this.list))),t}isIndexInRange(e){for(const t of this.list.ranges)if(t[0]<=e&&e<=t[1])return!0;return!1}}!function(e){e.PreProcess="ExtState.PreProcess",e.PostProcess="ExtState.PostProcess"}(p||(p={})),function(e){e.RoomData="SlidingSync.RoomData",e.Lifecycle="SlidingSync.Lifecycle",e.List="SlidingSync.List"}(g||(g={}));class f extends r.b{constructor(e,t,n,i,o){super(),this.proxyBaseUrl=e,this.roomSubscriptionInfo=n,this.client=i,this.timeoutMS=o,s()(this,"lists",void 0),s()(this,"listModifiedCount",0),s()(this,"terminated",!1),s()(this,"needsResend",!1),s()(this,"txnId",null),s()(this,"txnIdDefers",[]),s()(this,"extensions",{}),s()(this,"desiredRoomSubscriptions",new Set),s()(this,"confirmedRoomSubscriptions",new Set),s()(this,"customSubscriptions",new Map),s()(this,"roomIdToCustomSubscription",new Map),s()(this,"pendingReq",void 0),s()(this,"abortController",void 0),this.lists=new Map,t.forEach(((e,t)=>{this.lists.set(t,new v(e))}))}addCustomSubscription(e,t){this.customSubscriptions.has(e)?o.a.warn(`addCustomSubscription: ${e} already exists as a custom subscription, ignoring.`):this.customSubscriptions.set(e,t)}useCustomSubscription(e,t){this.roomIdToCustomSubscription.get(e)!==t&&(this.roomIdToCustomSubscription.set(e,t),this.confirmedRoomSubscriptions.delete(e))}getListData(e){const t=this.lists.get(e);return t?{joinedCount:t.joinedCount,roomIndexToRoomId:Object.assign({},t.roomIndexToRoomId)}:null}getListParams(e){const t=this.lists.get(e);return t?t.getList(!0):null}setListRanges(e,t){const n=this.lists.get(e);return n?(n.updateListRange(t),this.resend()):Promise.reject(new Error("no list with key "+e))}setList(e,t){const n=this.lists.get(e);return n?(n.replaceList(t),this.lists.set(e,n)):this.lists.set(e,new v(t)),this.listModifiedCount+=1,this.resend()}getRoomSubscriptions(){return new Set(Array.from(this.desiredRoomSubscriptions))}modifyRoomSubscriptions(e){return this.desiredRoomSubscriptions=e,this.resend()}modifyRoomSubscriptionInfo(e){return this.roomSubscriptionInfo=e,this.confirmedRoomSubscriptions=new Set,this.resend()}registerExtension(e){if(this.extensions[e.name()])throw new Error(`registerExtension: ${e.name()} already exists as an extension`);this.extensions[e.name()]=e}getExtensionRequest(e){const t={};return Object.keys(this.extensions).forEach((n=>{t[n]=this.extensions[n].onRequest(e)})),t}onPreExtensionsResponse(e){Object.keys(e).forEach((t=>{this.extensions[t].when()==p.PreProcess&&this.extensions[t].onResponse(e[t])}))}onPostExtensionsResponse(e){Object.keys(e).forEach((t=>{this.extensions[t].when()==p.PostProcess&&this.extensions[t].onResponse(e[t])}))}invokeRoomDataListeners(e,t){t.required_state||(t.required_state=[]),t.timeline||(t.timeline=[]),this.emit(g.RoomData,e,t)}invokeLifecycleListeners(e,t,n){this.emit(g.Lifecycle,e,t,n)}shiftRight(e,t,n){const i=this.lists.get(e);if(i)for(let e=t;e>n;e--)i.isIndexInRange(e)&&(i.roomIndexToRoomId[e]=i.roomIndexToRoomId[e-1])}shiftLeft(e,t,n){const i=this.lists.get(e);if(i)for(let e=n;e<t;e++)i.isIndexInRange(e)&&(i.roomIndexToRoomId[e]=i.roomIndexToRoomId[e+1])}removeEntry(e,t){const n=this.lists.get(e);if(!n)return;let i=-1;for(const e in n.roomIndexToRoomId)Number(e)>i&&(i=Number(e));i<0||t>i||(this.shiftLeft(e,i,t),delete n.roomIndexToRoomId[i])}addEntry(e,t){const n=this.lists.get(e);if(!n)return;let i=-1;for(const e in n.roomIndexToRoomId)Number(e)>i&&(i=Number(e));i<0||t>i||this.shiftRight(e,i+1,t)}processListOps(e,t){let n=-1;const i=this.lists.get(t);i&&(e.ops.forEach((e=>{if(i)switch(e.op){case"DELETE":o.a.debug("DELETE",t,e.index,";"),delete i.roomIndexToRoomId[e.index],-1!==n&&this.removeEntry(t,n),n=e.index;break;case"INSERT":o.a.debug("INSERT",t,e.index,e.room_id,";"),i.roomIndexToRoomId[e.index]&&(n<0?this.addEntry(t,e.index):n>e.index?this.shiftRight(t,n,e.index):n<e.index&&this.shiftLeft(t,e.index,n)),n=-1,i.roomIndexToRoomId[e.index]=e.room_id;break;case"INVALIDATE":for(let t=e.range[0];t<=e.range[1];t++)delete i.roomIndexToRoomId[t];o.a.debug("INVALIDATE",t,e.range[0],e.range[1],";");break;case"SYNC":{const n=e.range[0];for(let t=n;t<=e.range[1];t++){const s=e.room_ids[t-n];if(!s)break;i.roomIndexToRoomId[t]=s}o.a.debug("SYNC",t,e.range[0],e.range[1],(e.room_ids||[]).join(" "),";");break}}})),-1!==n&&this.removeEntry(t,n))}resend(){var e;if(this.needsResend&&this.txnIdDefers.length>0)return this.txnIdDefers[this.txnIdDefers.length-1].promise;this.needsResend=!0,this.txnId=this.client.makeTxnId();const t=Object(a.m)();return this.txnIdDefers.push(l(l({},t),{},{txnId:this.txnId})),null===(e=this.abortController)||void 0===e||e.abort(),this.abortController=new AbortController,t.promise}resolveTransactionDefers(e){if(!e)return;let t=-1;for(let n=0;n<this.txnIdDefers.length;n++)if(this.txnIdDefers[n].txnId===e){t=n;break}if(-1!==t){for(let e=0;e<t;e++)this.txnIdDefers[e].reject(this.txnIdDefers[e].txnId);this.txnIdDefers[t].resolve(e),this.txnIdDefers=this.txnIdDefers.slice(t+1)}else o.a.warn(`resolveTransactionDefers: seen ${e} but it isn't a pending txn, ignoring.`)}stop(){var e;this.terminated=!0,null===(e=this.abortController)||void 0===e||e.abort(),this.removeAllListeners(g.Lifecycle),this.removeAllListeners(g.List),this.removeAllListeners(g.RoomData)}resetup(){var e;o.a.warn("SlidingSync: resetting connection info"),this.txnIdDefers.forEach((e=>{e.reject(e.txnId)})),this.txnIdDefers=[],this.lists.forEach((e=>{e.setModified(!0)})),this.confirmedRoomSubscriptions=new Set,this.needsResend=!0,null===(e=this.abortController)||void 0===e||e.abort(),this.abortController=new AbortController}async start(){let e;for(this.abortController=new AbortController;!this.terminated;){this.needsResend=!1;let t,n=!1;try{const i=this.listModifiedCount,s={};this.lists.forEach(((e,t)=>{s[t]=e.getList(!1)}));const r={lists:s,pos:e,timeout:this.timeoutMS,clientTimeout:this.timeoutMS+1e4,extensions:this.getExtensionRequest(void 0===e)},a=b(this.desiredRoomSubscriptions,this.confirmedRoomSubscriptions),c=b(this.confirmedRoomSubscriptions,this.desiredRoomSubscriptions);if(c.size>0&&(r.unsubscribe_rooms=Array.from(c)),a.size>0){r.room_subscriptions={};for(const e of a){const t=this.roomIdToCustomSubscription.get(e);let n=this.roomSubscriptionInfo;t&&this.customSubscriptions.has(t)&&(n=this.customSubscriptions.get(t)),r.room_subscriptions[e]=n}}this.txnId&&(r.txn_id=this.txnId,this.txnId=null),this.pendingReq=this.client.slidingSync(r,this.proxyBaseUrl,this.abortController.signal),t=await this.pendingReq,e=t.pos;for(const e of a)this.confirmedRoomSubscriptions.add(e);for(const e of c)this.confirmedRoomSubscriptions.delete(e);i!==this.listModifiedCount&&(o.a.debug("list modified during await call, not updating list"),n=!0),this.lists.forEach((e=>{e.setModified(!1)})),t.lists=t.lists||{},t.rooms=t.rooms||{},t.extensions=t.extensions||{},Object.keys(t.lists).forEach((e=>{const n=this.lists.get(e);n&&t&&(n.joinedCount=t.lists[e].count)})),this.invokeLifecycleListeners(m.RequestFinished,t)}catch(t){if(t.httpStatus){if(this.invokeLifecycleListeners(m.RequestFinished,null,t),400===t.httpStatus){this.resetup(),e=void 0,await Object(a.N)(50);continue}}else if(this.needsResend||"AbortError"===t.name)continue;o.a.error(t),await Object(a.N)(5e3)}if(!t)continue;this.onPreExtensionsResponse(t.extensions),Object.keys(t.rooms).forEach((e=>{this.invokeRoomDataListeners(e,t.rooms[e])}));const i=new Set;if(!n)for(const[e,n]of Object.entries(t.lists))n.ops=n.ops||[],n.ops.length>0&&i.add(e),this.processListOps(n,e);this.invokeLifecycleListeners(m.Complete,t),this.onPostExtensionsResponse(t.extensions),i.forEach((e=>{const t=this.lists.get(e);t&&this.emit(g.List,e,t.joinedCount,Object.assign({},t.roomIndexToRoomId))})),this.resolveTransactionDefers(t.txn_id)}}}const b=(e,t)=>{const n=new Set(e);for(const e of t)n.delete(e);return n}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(13),s=n.n(i),o=n(435),r=n(144),a=n(130),c=n(1),l=n(149),d=n(219),u=n(711),h=n(224),m=n(16);class p extends l.d{constructor(e,t,n,i){var u,h,m,p,g,v,f,b,y,S;super(i),this.widgetApi=e,this.capabilities=t,this.roomId=n,s()(this,"room",void 0),s()(this,"widgetApiReady",new Promise((e=>this.widgetApi.once("ready",e)))),s()(this,"lifecycle",void 0),s()(this,"syncState",null),s()(this,"onEvent",(async e=>{if(e.preventDefault(),e.detail.data.room_id===this.roomId){const t=new r.b(e.detail.data);await this.syncApi.injectRoomEvents(this.room,[],[t]),this.emit(l.b.Event,t),this.setSyncState(d.b.Syncing),c.a.info(`Received event ${t.getId()} ${t.getType()} ${t.getStateKey()}`)}else{const{event_id:t,room_id:n}=e.detail.data;c.a.info(`Received event ${t} for a different room ${n}; discarding`)}await this.ack(e)})),s()(this,"onToDevice",(async e=>{e.preventDefault();const t=new r.b({type:e.detail.data.type,sender:e.detail.data.sender,content:e.detail.data.content});e.detail.data.encrypted&&t.makeEncrypted(a.b.RoomMessageEncrypted,{},"",""),this.emit(l.b.ToDeviceEvent,t),this.setSyncState(d.b.Syncing),await this.ack(e)})),(null!==(u=t.sendEvent)&&void 0!==u&&u.length||null!==(h=t.receiveEvent)&&void 0!==h&&h.length||!0===t.sendMessage||Array.isArray(t.sendMessage)&&t.sendMessage.length||!0===t.receiveMessage||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||null!==(m=t.sendState)&&void 0!==m&&m.length||null!==(p=t.receiveState)&&void 0!==p&&p.length)&&e.requestCapabilityForRoomTimeline(n),null===(g=t.sendEvent)||void 0===g||g.forEach((t=>e.requestCapabilityToSendEvent(t))),null===(v=t.receiveEvent)||void 0===v||v.forEach((t=>e.requestCapabilityToReceiveEvent(t))),!0===t.sendMessage?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach((t=>e.requestCapabilityToSendMessage(t))),!0===t.receiveMessage?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach((t=>e.requestCapabilityToReceiveMessage(t))),null===(f=t.sendState)||void 0===f||f.forEach((t=>{let{eventType:n,stateKey:i}=t;return e.requestCapabilityToSendState(n,i)})),null===(b=t.receiveState)||void 0===b||b.forEach((t=>{let{eventType:n,stateKey:i}=t;return e.requestCapabilityToReceiveState(n,i)})),null===(y=t.sendToDevice)||void 0===y||y.forEach((t=>e.requestCapabilityToSendToDevice(t))),null===(S=t.receiveToDevice)||void 0===S||S.forEach((t=>e.requestCapabilityToReceiveToDevice(t))),t.turnServers&&e.requestCapability(o.MatrixCapabilities.MSC3846TurnServers),e.on(`action:${o.WidgetApiToWidgetAction.SendEvent}`,this.onEvent),e.on(`action:${o.WidgetApiToWidgetAction.SendToDevice}`,this.onToDevice),e.start()}async startClient(){var e,t;let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.lifecycle=new AbortController;const i=this.getUserId();i&&this.store.storeUser(new h.a(i)),n.slidingSync?this.syncApi=new u.a(n.slidingSync,this,n,this.buildSyncApiOptions()):this.syncApi=new d.a(this,n,this.buildSyncApiOptions()),this.room=this.syncApi.createRoom(this.roomId),this.store.storeRoom(this.room),await this.widgetApiReady,await Promise.all(null!==(e=null===(t=this.capabilities.receiveState)||void 0===t?void 0:t.map((async e=>{let{eventType:t,stateKey:n}=e;const i=(await this.widgetApi.readStateEvents(t,void 0,n,[this.roomId])).map((e=>new r.b(e)));await this.syncApi.injectRoomEvents(this.room,[],i),i.forEach((e=>{this.emit(l.b.Event,e),c.a.info(`Backfilled event ${e.getId()} ${e.getType()} ${e.getStateKey()}`)}))})))&&void 0!==e?e:[]),this.setSyncState(d.b.Syncing),c.a.info("Finished backfilling events"),this.capabilities.turnServers&&this.watchTurnServers()}stopClient(){this.widgetApi.off(`action:${o.WidgetApiToWidgetAction.SendEvent}`,this.onEvent),this.widgetApi.off(`action:${o.WidgetApiToWidgetAction.SendToDevice}`,this.onToDevice),super.stopClient(),this.lifecycle.abort()}async joinRoom(e){if(e===this.roomId)return this.room;throw new Error(`Unknown room: ${e}`)}async encryptAndSendEvent(e,t){let n;try{n=await this.widgetApi.sendRoomEvent(t.getType(),t.getContent(),e.roomId)}catch(n){throw this.updatePendingEventStatus(e,t,r.a.NOT_SENT),n}return e.updatePendingEvent(t,r.a.SENT,n.event_id),{event_id:n.event_id}}async sendStateEvent(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return await this.widgetApi.sendStateEvent(t,i,n,e)}async sendToDevice(e,t){return await this.widgetApi.sendToDevice(e,!1,Object(m.F)(t)),{}}async queueToDevice(e){let{eventType:t,batch:n}=e;const i=new m.b((()=>new Map));for(const{userId:e,deviceId:t,payload:s}of n)i.getOrCreate(e).set(t,s);await this.widgetApi.sendToDevice(t,!1,Object(m.F)(i))}async encryptAndSendToDevices(e,t){const n=new m.b((()=>new Map));for(const{userId:i,deviceInfo:{deviceId:s}}of e)n.getOrCreate(i).set(s,t);await this.widgetApi.sendToDevice(t.type,!0,Object(m.F)(n))}async checkTurnServers(){return this.turnServers.length>0}getSyncState(){return this.syncState}setSyncState(e){const t=this.syncState;this.syncState=e,this.emit(l.b.Sync,e,t)}async ack(e){await this.widgetApi.transport.reply(e.detail,{})}async watchTurnServers(){const e=this.widgetApi.getTurnServers(),t=()=>{e.return(void 0)};this.lifecycle.signal.addEventListener("abort",t);try{for await(const t of e)this.turnServers=[{urls:t.uris,username:t.username,credential:t.password}],this.emit(l.b.TurnServers,this.turnServers),c.a.log(`Received TURN server: ${t.uris}`)}catch(e){c.a.warn("Error watching TURN servers",e)}finally{this.lifecycle.signal.removeEventListener("abort",t)}}}},,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return m}));var i=n(13),s=n.n(i),o=n(1),r=n(16),a=n(130),c=n(18),l=n(518);function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let h;!function(e){e.Invite="invite",e.Leave="leave",e.Join="join"}(h||(h={}));class m{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.opts=e,s()(this,"accountData",{}),s()(this,"inviteRooms",{}),s()(this,"joinRooms",{}),s()(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach((e=>{this.accountData[e.type]=e}))}accumulateRooms(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach((n=>{this.accumulateRoom(n,h.Invite,e.rooms.invite[n],t)})),e.rooms.join&&Object.keys(e.rooms.join).forEach((n=>{this.accumulateRoom(n,h.Join,e.rooms.join[n],t)})),e.rooms.leave&&Object.keys(e.rooms.leave).forEach((n=>{this.accumulateRoom(n,h.Leave,e.rooms.leave[n],t)})))}accumulateRoom(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(t){case h.Invite:this.accumulateInviteState(e,n);break;case h.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,n,i);break;case h.Leave:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:o.a.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const n=this.inviteRooms[e];t.invite_state.events.forEach((e=>{let t=!1;for(let i=0;i<n.invite_state.events.length;i++){const s=n.invite_state.events[i];s.type===e.type&&s.state_key==e.state_key&&(n.invite_state.events[i]=e,t=!0)}t||n.invite_state.events.push(e)}))}accumulateJoinState(e,t){var n,i,s,o,d,h,m,g;let v=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_readReceipts:{},_threadReadReceipts:{}});const f=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((e=>{f._accountData[e.type]=e})),t.unread_notifications&&(f._unreadNotifications=t.unread_notifications),f._unreadThreadNotifications=null!==(n=null!==(i=t[l.a.stable])&&void 0!==i?i:t[l.a.unstable])&&void 0!==n?n:void 0,t.summary){const e="m.heroes",n="m.invited_member_count",i="m.joined_member_count",s=f._summary,o=t.summary;s[e]=o[e]||s[e],s[i]=o[i]||s[i],s[n]=o[n]||s[n]}if(null===(s=t.ephemeral)||void 0===s||null===(o=s.events)||void 0===o||o.forEach((e=>{e.type===a.b.Receipt&&e.content&&Object.keys(e.content).forEach((t=>{Object.entries(e.content[t]).forEach((n=>{let[i,s]=n;if(Object(r.w)(i))for(const n of Object.keys(s)){const s=e.content[t][i][n],r={data:e.content[t][i][n],type:i,eventId:t};var o;if(s.thread_id&&s.thread_id!==c.a)f._threadReadReceipts=u(u({},f._threadReadReceipts),{},{[s.thread_id]:u(u({},null!==(o=f._threadReadReceipts[s.thread_id])&&void 0!==o?o:{}),{},{[n]:r})});else f._readReceipts[n]=r}}))}))})),t.timeline&&t.timeline.limited&&(f._timeline=[]),null===(d=t.state)||void 0===d||null===(h=d.events)||void 0===h||h.forEach((e=>{p(f._currentState,e)})),null===(m=t.timeline)||void 0===m||null===(g=m.events)||void 0===g||g.forEach(((e,n)=>{var i;let s;if(p(f._currentState,e),v)s=e;else{s=Object.assign({},e),void 0!==s.unsigned&&(s.unsigned=Object.assign({},s.unsigned));const t=e.unsigned?e.unsigned.age:e.age;void 0!==t&&(s._localTs=Date.now()-t)}f._timeline.push({event:s,token:0===n&&null!==(i=t.timeline.prev_batch)&&void 0!==i?i:null})})),f._timeline.length>this.opts.maxTimelineEntries){for(let e=f._timeline.length-this.opts.maxTimelineEntries;e<f._timeline.length;e++)if(f._timeline[e].token){f._timeline=f._timeline.slice(e,f._timeline.length);break}}}getJSON(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach((e=>{t.invite[e]=this.inviteRooms[e]})),Object.keys(this.joinRooms).forEach((n=>{const i=this.joinRooms[n],s={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:i._unreadNotifications,unread_thread_notifications:i._unreadThreadNotifications,summary:i._summary};Object.keys(i._accountData).forEach((e=>{s.account_data.events.push(i._accountData[e])}));const o={type:a.b.Receipt,room_id:n,content:{}},c=new r.b((()=>new r.b((()=>new Map))));for(const[e,t]of Object.entries(i._readReceipts))c.getOrCreate(t.eventId).getOrCreate(t.type).set(e,t.data);for(const e of Object.values(i._threadReadReceipts))for(const[t,n]of Object.entries(e))c.getOrCreate(n.eventId).getOrCreate(n.type).set(t,n.data);o.content=Object(r.F)(c),c.size>0&&s.ephemeral.events.push(o),i._timeline.forEach((t=>{if(!s.timeline.prev_batch){if(!t.token)return;s.timeline.prev_batch=t.token}let n;var i;!e&&("_localTs"in(i=t.event)&&void 0!==i._localTs)?(n=Object.assign({},t.event),void 0!==n.unsigned&&(n.unsigned=Object.assign({},n.unsigned)),delete n._localTs,n.unsigned=n.unsigned||{},n.unsigned.age=Date.now()-t.event._localTs):n=t.event,s.timeline.events.push(n)}));const l=Object.create(null);for(let e=s.timeline.events.length-1;e>=0;e--){const t=s.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const n=Object(r.k)(t);n.unsigned&&(n.unsigned.prev_content&&(n.content=n.unsigned.prev_content),n.unsigned.prev_sender&&(n.sender=n.unsigned.prev_sender)),p(l,n)}Object.keys(i._currentState).forEach((e=>{Object.keys(i._currentState[e]).forEach((t=>{let n=i._currentState[e][t];l[e]&&l[e][t]&&(n=l[e][t]),s.state.events.push(n)}))})),t.join[n]=s}));const n=[];return Object.keys(this.accountData).forEach((e=>{n.push(this.accountData[e])})),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}getNextBatchToken(){return this.nextBatch}}function p(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return c}));var i=n(13),s=n.n(i),o=n(180);n(1);const r=function(){};class a{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.client=e,this.timelineSet=t,s()(this,"windowLimit",void 0),s()(this,"start",void 0),s()(this,"end",void 0),s()(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3}load(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;const n=n=>{if(!n)throw new Error("No timeline given to initFields");let i;const s=n.getEvents();if(e){if(i=s.findIndex((t=>t.getId()===e)),i<0)throw new Error("getEventTimeline result didn't include requested event")}else i=s.length;const o=Math.min(s.length,i+Math.ceil(t/2)),r=Math.max(0,o-t);this.start=new c(n,r-n.getBaseIndex()),this.end=new c(n,o-n.getBaseIndex()),this.eventCount=o-r};return this.timelineSet.getTimelineForEvent(e)?(n(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(n):(n(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){var t,n;if(e==o.b.BACKWARDS)return null!==(t=this.start)&&void 0!==t?t:null;if(e==o.b.FORWARDS)return null!==(n=this.end)&&void 0!==n?n:null;throw new Error("Invalid direction '"+e+"'")}extend(e,t){const n=this.getTimelineIndex(e);if(!n)return r("TimelineWindow: no timeline yet"),!1;const i=e==o.b.BACKWARDS?n.retreat(t):n.advance(t);if(i){this.eventCount+=i,r("TimelineWindow: increased cap by "+i+" (now "+this.eventCount+")");const t=this.eventCount-this.windowLimit;return t>0&&this.unpaginate(t,e!=o.b.BACKWARDS),!0}return!1}canPaginate(e){const t=this.getTimelineIndex(e);if(!t)return r("TimelineWindow: no timeline yet"),!1;if(e==o.b.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;const n=t.timeline.getNeighbouringTimeline(e),i=t.timeline.getPaginationToken(e);return Boolean(n)||Boolean(i)}async paginate(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5;const s=this.getTimelineIndex(e);if(!s)return r("TimelineWindow: no timeline yet"),!1;if(s.pendingPaginate)return s.pendingPaginate;if(this.extend(e,t))return!0;if(!n||0===i)return!1;if(!s.timeline.getPaginationToken(e))return r("TimelineWindow: no token"),!1;r("TimelineWindow: starting request");const a=this.client.paginateEventTimeline(s.timeline,{backwards:e==o.b.BACKWARDS,limit:t}).finally((function(){s.pendingPaginate=void 0})).then((n=>(r("TimelineWindow: request completed with result "+n),n?this.paginate(e,t,!0,i-1):this.paginate(e,t,!1,0))));return s.pendingPaginate=a,a}unpaginate(e,t){const n=t?this.start:this.end;if(!n)throw new Error(`Attempting to unpaginate startOfTimeline=${t} but don't have this direction`);if(e>this.eventCount||e<0)throw new Error(`Attemting to unpaginate ${e} events, but only have ${this.eventCount} in the timeline`);for(;e>0;){const i=t?n.advance(e):n.retreat(e);if(i<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=i,this.eventCount-=i,r("TimelineWindow.unpaginate: dropped "+i+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];const e=[];let t=this.start.timeline;for(;;){var n,i;const s=t.getEvents();let r=0,a=s.length;t===this.start.timeline&&(r=this.start.index+t.getBaseIndex()),t===(null===(n=this.end)||void 0===n?void 0:n.timeline)&&(a=this.end.index+t.getBaseIndex());for(let t=r;t<a;t++)e.push(s[t]);if(t===(null===(i=this.end)||void 0===i?void 0:i.timeline))break;t=t.getNeighbouringTimeline(o.b.FORWARDS)}return e}}class c{constructor(e,t){this.timeline=e,this.index=t,s()(this,"pendingPaginate",void 0)}minIndex(){return-1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;const n=this.timeline.getNeighbouringTimeline(e<0?o.b.BACKWARDS:o.b.FORWARDS);return n?(this.timeline=n,this.index=e<0?this.maxIndex():this.minIndex(),r("paginate: switched to new neighbour"),this.advance(e)):0}retreat(e){return-1*this.advance(-1*e)}}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var i=n(122),s=n.n(i),o=n(436),r=n(120),a=n.n(r),c=n(1),l=n(324),d=n(135);const u=new Error("User cancelled auth session");class h extends a.a.Component{constructor(e){super(e),s()(this,"authLogic",void 0),s()(this,"intervalId",null),s()(this,"stageComponent",Object(r.createRef)()),s()(this,"unmounted",!1),s()(this,"requestEmailToken",(async(e,t,n,i)=>{this.setState({busy:!0});try{return await this.props.requestEmailToken(e,t,n,i)}finally{this.setState({busy:!1})}})),s()(this,"authStateUpdated",((e,t)=>{const n=this.state.authStage;this.setState({busy:!1,authStage:e,stageState:t,errorText:t.error,errorCode:t.errcode},(()=>{if(n!==e)this.setFocus();else if(!t.error){var i,s;null===(i=this.stageComponent.current)||void 0===i||null===(s=i.attemptFailed)||void 0===s||s.call(i)}}))})),s()(this,"requestCallback",((e,t)=>this.props.makeRequest(e))),s()(this,"onBusyChanged",(e=>{e&&this.setState({busy:!0,errorText:void 0,errorCode:void 0})})),s()(this,"submitAuthDict",(e=>{this.authLogic.submitAuthDict(e)})),s()(this,"onPhaseChange",(e=>{var t,n,i;null===(t=(n=this.props).onStagePhaseChange)||void 0===t||t.call(n,null!==(i=this.state.authStage)&&void 0!==i?i:null,e||0)})),s()(this,"onStageCancel",(()=>{this.props.onAuthFinished(!1,u)})),s()(this,"onAuthStageFailed",(e=>{this.props.onAuthFinished(!1,e)})),s()(this,"setEmailSid",(e=>{this.authLogic.setEmailSid(e)})),this.state={busy:!1,submitButtonEnabled:!1},this.authLogic=new o.b({authData:this.props.authData,doRequest:this.requestCallback,busyChanged:this.onBusyChanged,inputs:this.props.inputs,stateUpdated:this.authStateUpdated,matrixClient:this.props.matrixClient,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.emailSid,requestEmailToken:this.requestEmailToken}),this.props.poll&&(this.intervalId=window.setInterval((()=>{this.authLogic.poll()}),2e3))}componentDidMount(){this.authLogic.attemptAuth().then((e=>{const t={emailSid:this.authLogic.getEmailSid(),clientSecret:this.authLogic.getClientSecret()};this.props.onAuthFinished(!0,e,t)})).catch((e=>{if(this.props.onAuthFinished(!1,e),c.a.error("Error during user-interactive auth:",e),this.unmounted)return;const t=e.message||e.toString();this.setState({errorText:t,errorCode:e.errcode})}))}componentWillUnmount(){this.unmounted=!0,null!==this.intervalId&&clearInterval(this.intervalId)}setFocus(){var e,t;null===(e=this.stageComponent.current)||void 0===e||null===(t=e.focus)||void 0===t||t.call(e)}render(){const e=this.state.authStage;if(!e)return this.state.busy?a.a.createElement(d.a,null):null;const t=Object(l.d)(e);return a.a.createElement(t,{ref:this.stageComponent,loginType:e,matrixClient:this.props.matrixClient,authSessionId:this.authLogic.getSessionId(),clientSecret:this.authLogic.getClientSecret(),stageParams:this.authLogic.getStageParams(e),submitAuthDict:this.submitAuthDict,errorText:this.state.errorText,errorCode:this.state.errorCode,busy:this.state.busy,inputs:this.props.inputs,stageState:this.state.stageState,fail:this.onAuthStageFailed,setEmailSid:this.setEmailSid,showContinue:!this.props.continueIsManaged,onPhaseChange:this.onPhaseChange,requestEmailToken:this.authLogic.requestEmailToken,continueText:this.props.continueText,continueKind:this.props.continueKind,onCancel:this.onStageCancel})}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i,s,o,r,a=n(120);function c(){return c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},c.apply(this,arguments)}function l(e){return a.createElement("svg",c({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 57 46",role:"presentation","aria-hidden":!0},e),i||(i=a.createElement("path",{fill:"#757575",d:"M4 17c-.5 0-.975.096-1.416.264L20 34.68l17.416-17.416A3.98 3.98 0 0036 17zM.264 19.584A3.98 3.98 0 000 21v21a4 4 0 004 4h32a4 4 0 004-4V21c0-.5-.096-.975-.264-1.416L21.16 38.16a1.64 1.64 0 01-.533.356 1.64 1.64 0 01-.627.125 1.64 1.64 0 01-.627-.125 1.64 1.64 0 01-.533-.356z"})),s||(s=a.createElement("path",{fill:"#8BC34A",fillOpacity:.1,d:"M57 16a16 16 0 01-16 16 16 16 0 01-16-16A16 16 0 0141 0a16 16 0 0116 16z"})),o||(o=a.createElement("path",{fill:"#fff",d:"M53 16a12 12 0 01-12 12 12 12 0 01-12-12A12 12 0 0141 4a12 12 0 0112 12z"})),r||(r=a.createElement("path",{fill:"#8BC34A",d:"M49 16a8 8 0 01-8 8 8 8 0 01-8-8 8 8 0 018-8 8 8 0 018 8z"})))}t.b="img/element-icons/email-prompt.af858ec.svg"},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(120);const s=Object(i.createContext)(void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var i=n(122),s=n.n(i),o=n(130),r=n(526),a=n(1),c=n(16);const l={timeline_limit:50,include_old_rooms:{timeline_limit:0,required_state:[[o.b.RoomCreate,""],[o.b.RoomTombstone,""],[o.b.SpaceChild,r.d],[o.b.SpaceParent,r.d],[o.b.RoomMember,r.c]]}},d="unencrypted",u=Object.assign({required_state:[[r.d,r.d],[o.b.RoomMember,r.c],[o.b.RoomMember,r.b]]},l),h=Object.assign({required_state:[[r.d,r.d]]},l);class m{constructor(){s()(this,"slidingSync",void 0),s()(this,"client",void 0),s()(this,"configureDefer",void 0),this.configureDefer=Object(c.m)()}static get instance(){return m.internalInstance}configure(e,t){return this.client=e,this.slidingSync=new r.e(t,new Map,h,e,2e4),this.slidingSync.addCustomSubscription(d,u),this.slidingSync.setList(m.ListSpaces,{ranges:[[0,20]],sort:["by_name"],slow_get_all_rooms:!0,timeline_limit:0,required_state:[[o.b.RoomJoinRules,""],[o.b.RoomAvatar,""],[o.b.RoomTombstone,""],[o.b.RoomEncryption,""],[o.b.RoomCreate,""],[o.b.SpaceChild,r.d],[o.b.SpaceParent,r.d],[o.b.RoomMember,r.c]],include_old_rooms:{timeline_limit:0,required_state:[[o.b.RoomCreate,""],[o.b.RoomTombstone,""],[o.b.SpaceChild,r.d],[o.b.SpaceParent,r.d],[o.b.RoomMember,r.c]]},filters:{room_types:["m.space"]}}),this.configureDefer.resolve(),this.slidingSync}async ensureListRegistered(e,t){a.a.debug("ensureListRegistered:::",e,t),await this.configureDefer.promise;let n=this.slidingSync.getListParams(e);if(n){const e=Object.assign({},n,t);if(JSON.stringify(n)===JSON.stringify(e))return a.a.debug("list matches, not sending, update => ",t),n;n=e}else n={ranges:[[0,20]],sort:["by_notification_level","by_recency"],timeline_limit:1,required_state:[[o.b.RoomJoinRules,""],[o.b.RoomAvatar,""],[o.b.RoomTombstone,""],[o.b.RoomEncryption,""],[o.b.RoomCreate,""],[o.b.RoomMember,r.c]],include_old_rooms:{timeline_limit:0,required_state:[[o.b.RoomCreate,""],[o.b.RoomTombstone,""],[o.b.SpaceChild,r.d],[o.b.SpaceParent,r.d],[o.b.RoomMember,r.c]]}},n=Object.assign(n,t);try{t.ranges&&1===Object.keys(t).length?await this.slidingSync.setListRanges(e,t.ranges):await this.slidingSync.setList(e,n)}catch(e){a.a.debug("ensureListRegistered: update failed txn_id=",e)}return this.slidingSync.getListParams(e)}async setRoomVisible(e,t){await this.configureDefer.promise;const n=this.slidingSync.getRoomSubscriptions();t?n.add(e):n.delete(e);const i=this.client.getRoom(e);let s=!this.client.isRoomEncrypted(e);i||(s=!1),a.a.log("SlidingSync setRoomVisible:",e,t,"shouldLazyLoad:",s),s&&this.slidingSync.useCustomSubscription(e,d);const o=this.slidingSync.modifyRoomSubscriptions(n);if(i)return e;try{await o}catch(n){a.a.warn("SlidingSync setRoomVisible:",e,t,"failed to confirm transaction")}return e}async startSpidering(e,t){await Object(c.N)(t);let n=e,i=!0,s=!0;for(;i;){const a=n+e-1;try{const t=[[0,e-1],[n,a]];s?await this.slidingSync.setList(m.ListSearch,{ranges:t,sort:["by_recency"],timeline_limit:0,required_state:[[o.b.RoomJoinRules,""],[o.b.RoomAvatar,""],[o.b.RoomTombstone,""],[o.b.RoomEncryption,""],[o.b.RoomCreate,""],[o.b.RoomMember,r.c]],filters:{not_room_types:["m.space"]}}):await this.slidingSync.setListRanges(m.ListSearch,t)}catch(e){}finally{await Object(c.N)(t)}i=a+1<this.slidingSync.getListData(m.ListSearch).joinedCount,n+=e,s=!1}}}s()(m,"ListSpaces","space_list"),s()(m,"ListSearch","search_list"),s()(m,"internalInstance",new m)},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(122),s=n.n(i),o=n(329);class r extends o.a{static clear(){r.itemCache.clear(),r.objectCache.clear()}constructor(){super(),r.storageListenerBound||(r.storageListenerBound=!0,window.addEventListener("storage",r.onStorageEvent))}getItem(e){if(!r.itemCache.has(e)){const t=localStorage.getItem(e);return r.itemCache.set(e,t),t}return r.itemCache.get(e)}getBoolean(e){const t=this.getItem(e);return"true"===t||"false"!==t&&null}getObject(e){if(!r.objectCache.has(e))try{const t=JSON.parse(localStorage.getItem(e));return r.objectCache.set(e,t),t}catch(e){return console.error("Failed to parse localStorage object",e),null}return r.objectCache.get(e)}setItem(e,t){r.itemCache.set(e,t),localStorage.setItem(e,t)}setBoolean(e,t){this.setItem(e,`${t}`)}setObject(e,t){r.objectCache.set(e,t),localStorage.setItem(e,JSON.stringify(t))}removeItem(e){localStorage.removeItem(e),r.itemCache.delete(e),r.objectCache.delete(e)}isSupported(){return void 0!==localStorage&&null!==localStorage}}s()(r,"itemCache",new Map),s()(r,"objectCache",new Map),s()(r,"storageListenerBound",!1),s()(r,"onStorageEvent",(e=>{null===e.key?r.clear():(r.itemCache.delete(e.key),r.objectCache.delete(e.key))}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var i=n(121);function s(e){return{undefined:Object(i.a)("Default"),0:Object(i.a)("Restricted"),[e]:Object(i.a)("Default"),50:Object(i.a)("Moderator"),100:Object(i.a)("Admin")}}function o(e,t){const n=s(t);return n[e]?n[e]:Object(i.a)("Custom (%(level)s)",{level:e})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i=n(122),s=n.n(i),o=n(161),r=n(1),a=n(152),c=n(123),l=n(505),d=n(126),u=n(121),h=n(125),m=n(138),p=n(129);class g{constructor(){s()(this,"_lists",[]),s()(this,"_roomIds",[]),s()(this,"mjolnirWatchRef",null),s()(this,"dispatcherRef",null),s()(this,"onAction",(e=>{"setup_mjolnir"===e.action&&(r.a.log("Setting up Mjolnir: after sync"),this.setup())})),s()(this,"onEvent",(e=>{c.a.get()&&this._roomIds.includes(e.getRoomId())&&l.a.includes(e.getType())&&this.updateLists(this._roomIds)}))}get roomIds(){return this._roomIds}get lists(){return this._lists}start(){this.mjolnirWatchRef=d.b.watchSetting("mjolnirRooms",null,this.onListsChanged.bind(this)),this.dispatcherRef=h.a.register(this.onAction),h.a.dispatch({action:p.a.DoAfterSyncPrepared,deferred_action:{action:"setup_mjolnir"}})}setup(){c.a.get()&&(this.updateLists(d.b.getValue("mjolnirRooms")),c.a.get().on(a.b.Events,this.onEvent))}stop(){this.mjolnirWatchRef&&(d.b.unwatchSetting(this.mjolnirWatchRef),this.mjolnirWatchRef=null),this.dispatcherRef&&(h.a.unregister(this.dispatcherRef),this.dispatcherRef=null),c.a.get()&&c.a.get().removeListener(a.b.Events,this.onEvent)}async getOrCreatePersonalList(){let e=d.b.getValue("mjolnirPersonalRoom");if(!e){const t=await c.a.get().createRoom({name:Object(u.a)("My Ban List"),topic:Object(u.a)("This is your list of users/servers you have blocked - don't leave the room!"),preset:o.d.PrivateChat});e=t.room_id,await d.b.setValue("mjolnirPersonalRoom",null,m.a.ACCOUNT,e),await d.b.setValue("mjolnirRooms",null,m.a.ACCOUNT,[e,...this._roomIds])}if(!e)throw new Error("Error finding a room ID to use");let t=this._lists.find((t=>t.roomId===e));return t||(t=new l.b(e)),t}getPersonalList(){const e=d.b.getValue("mjolnirPersonalRoom");if(!e)return null;let t=this._lists.find((t=>t.roomId===e));return t||(t=new l.b(e)),t}async subscribeToList(e){const t=[...this._roomIds,e];await d.b.setValue("mjolnirRooms",null,m.a.ACCOUNT,t),this._lists.push(new l.b(e))}async unsubscribeFromList(e){const t=this._roomIds.filter((t=>t!==e));await d.b.setValue("mjolnirRooms",null,m.a.ACCOUNT,t),this._lists=this._lists.filter((t=>t.roomId!==e))}onListsChanged(e,t,n,i){this.updateLists(i)}updateLists(e){if(c.a.get()&&(r.a.log("Updating Mjolnir ban lists to: "+e),this._lists=[],this._roomIds=e||[],e))for(const t of e)this._lists.push(new l.b(t))}isServerBanned(e){for(const t of this._lists)for(const n of t.serverRules)if(n.isMatch(e))return!0;return!1}isUserBanned(e){for(const t of this._lists)for(const n of t.userRules)if(n.isMatch(e))return!0;return!1}static sharedInstance(){return g.instance||(g.instance=new g),g.instance}}s()(g,"instance",null)},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(121),r=n(133),a=n(166),c=n(126);const l=s.a.forwardRef(((e,t)=>{let{mxEvent:n}=e;const l=Object(i.useContext)(r.a);let d=Object(o.a)("Message deleted");const u=n.getUnsigned(),h=u&&u.redacted_because&&u.redacted_because.sender;if(h&&h!==n.getSender()){const e=l.getRoom(n.getRoomId()),t=e&&e.getMember(h);d=Object(o.a)("Message deleted by %(name)s",{name:t?t.name:h})}const m=c.b.getValue("showTwelveHourTimestamps"),p=Object(a.c)(new Date(u.redacted_because.origin_server_ts),m),g=Object(o.a)("Message deleted on %(date)s",{date:p});return s.a.createElement("span",{className:"mx_RedactedBody",ref:t,title:g},d)}));t.a=l},function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return l})),n.d(t,"c",(function(){return d}));var i=n(744),s=n.n(i),o=n(196),r=n(160),a=n(745);class c extends Error{constructor(e){super(e.message),this.name="DownloadError",this.stack=e.stack}}class l extends Error{constructor(e){super(e.message),this.name="DecryptError",this.stack=e.stack}}async function d(e,t){const n=Object(r.a)({file:e});let i;try{const e=await n.downloadSource();if(!e.ok)throw Object(o.k)(e,await e.text());i=await e.arrayBuffer()}catch(e){throw new c(e)}try{const n=await s.a.decryptAttachment(i,e);let o=null!=t&&t.mimetype?t.mimetype.split(";")[0].trim():"";return o=Object(a.a)(o),new Blob([n],{type:o})}catch(e){throw new l(e)}}},,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(1),s=n(132),o=n(245),r=n(451);function a(){var e,t;const n=null!==(e=null===(t=Object(o.f)())||void 0===t?void 0:t.map_style_url)&&void 0!==e?e:s.b.get().map_style_url;if(!n)throw i.a.error("'map_style_url' missing from homeserver .well-known area, and missing from from config.json."),new Error(r.a.MapStyleUrlNotConfigured);return n}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"c",(function(){return u})),n.d(t,"d",(function(){return h})),n.d(t,"b",(function(){return m}));var i=n(559),s=n(30),o=n(1),r=n(121),a=n(560),c=n(557),l=n(451);const d=(e,t,n)=>{try{const s=Object(c.a)(),a=new i.Map({container:t,style:s,zoom:15,interactive:e,attributionControl:!1,locale:{"AttributionControl.ToggleAttribution":Object(r.a)("Toggle attribution"),"AttributionControl.MapFeedback":Object(r.a)("Map feedback"),"FullscreenControl.Enter":Object(r.a)("Enter fullscreen"),"FullscreenControl.Exit":Object(r.a)("Exit fullscreen"),"GeolocateControl.FindMyLocation":Object(r.a)("Find my location"),"GeolocateControl.LocationNotAvailable":Object(r.a)("Location not available"),"LogoControl.Title":Object(r.a)("Mapbox logo"),"NavigationControl.ResetBearing":Object(r.a)("Reset bearing to north"),"NavigationControl.ZoomIn":Object(r.a)("Zoom in"),"NavigationControl.ZoomOut":Object(r.a)("Zoom out")}});return a.addControl(new i.AttributionControl,"top-right"),a.on("error",(e=>{o.a.error("Failed to load map: check map_style_url in config.json has a valid URL and API key",e.error),null==n||n(new Error(l.a.MapStyleUrlNotReachable))})),a}catch(e){throw o.a.error("Failed to render map",e),e}},u=(e,t)=>new i.Marker({element:t,anchor:"bottom",offset:[0,-1]}).setLngLat({lon:e.longitude,lat:e.latitude}),h=e=>`https://www.openstreetmap.org/?mlat=${e.latitude}&mlon=${e.longitude}#map=16/${e.latitude}/${e.longitude}`,m=e=>{const t=e.getContent(),n=t[s.c.name];if(void 0!==n){const e=n.uri;if(void 0!==e)return h(Object(a.a)(e))}else{const e=t.geo_uri;if(e)return h(Object(a.a)(e))}return null}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i=e=>{function t(e){const t=parseFloat(e);return Number.isNaN(t)?null:t}const n=e.match(/^\s*geo:(.*?)\s*$/);if(!n)return;const i=n[1].split(";"),s=i[0].split(",");let o;for(const e of i.slice(1)){const n=e.match(/u=(.*)/);n&&(o=t(n[1]))}return{latitude:t(s[0]),longitude:t(s[1]),altitude:t(s[2]),accuracy:o,altitudeAccuracy:null,heading:null,speed:null}}},,,,function(e,t){},function(e,t){},,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(124);const d=["label","isExpanded","children","onClick","onContextMenu"],u=e=>{let{label:t,isExpanded:n,children:i,onClick:o,onContextMenu:a}=e,u=r()(e,d);return c.a.createElement(l.a,s()({},u,{onClick:o,onContextMenu:a||o,title:t,"aria-label":t,"aria-haspopup":!0,"aria-expanded":n}),i)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return S})),n.d(t,"b",(function(){return E}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a),l=n(186),d=n(1),u=n(125),h=n(123),m=n(168),p=n(133),g=n(129),v=n(163),f=n(165),b=n(173),y=n(187);let S;!function(e){e.UserMention="TYPE_USER_MENTION",e.RoomMention="TYPE_ROOM_MENTION",e.AtRoomMention="TYPE_AT_ROOM_MENTION"}(S||(S={}));class E extends r.a.Component{static roomNotifPos(e){return e.indexOf("@room")}static roomNotifLen(){return"@room".length}constructor(e){super(e),s()(this,"unmounted",!0),s()(this,"matrixClient",void 0),s()(this,"onMouseOver",(()=>{this.setState({hover:!0})})),s()(this,"onMouseLeave",(()=>{this.setState({hover:!1})})),s()(this,"onUserPillClicked",(e=>{e.preventDefault(),u.a.dispatch({action:g.a.ViewUser,member:this.state.member})})),this.state={resourceId:null,pillType:null,member:null,room:null,hover:!1}}load(){let e,t;if(this.props.url)if(this.props.inMessage){const n=Object(m.j)(this.props.url);e=n.primaryEntityId,t=n.sigil}else e=Object(m.d)(this.props.url),t=e?e[0]:void 0;const n=this.props.type||{"@":S.UserMention,"#":S.RoomMention,"!":S.RoomMention}[t];let i,s;switch(n){case S.AtRoomMention:s=this.props.room;break;case S.UserMention:{var o;const t=null===(o=this.props.room)||void 0===o?void 0:o.getMember(e);i=t,t||(i=new l.a(null,e),this.doProfileLookup(e,i))}break;case S.RoomMention:{const t="#"===e[0]?h.a.get().getRooms().find((t=>t.getCanonicalAlias()===e||t.getAltAliases().includes(e))):h.a.get().getRoom(e);s=t}}this.setState({resourceId:e,pillType:n,member:i,room:s})}componentDidMount(){this.unmounted=!1,this.matrixClient=h.a.get(),this.load()}componentDidUpdate(e){Object(y.c)(this.props,e)&&this.load()}componentWillUnmount(){this.unmounted=!0}doProfileLookup(e,t){h.a.get().getProfileInfo(e).then((e=>{this.unmounted||(t.name=e.displayname,t.rawDisplayName=e.displayname,t.events.member={getContent:()=>({avatar_url:e.avatar_url}),getDirectionalContent:function(){return this.getContent()}},this.setState({member:t}))})).catch((t=>{d.a.error("Could not retrieve profile data for "+e+":",t)}))}render(){const e=this.state.resourceId;let t,n,i,s=null,o=e,a=this.props.url;switch(this.state.pillType){case S.AtRoomMention:{const e=this.props.room;e&&(o="@room",this.props.shouldShowPillAvatar&&(s=r.a.createElement(f.a,{room:e,width:16,height:16,"aria-hidden":"true"})),t="mx_AtRoomPill")}break;case S.UserMention:{const e=this.state.member;e&&(n=e.userId,e.rawDisplayName=e.rawDisplayName||"",o=e.rawDisplayName,this.props.shouldShowPillAvatar&&(s=r.a.createElement(b.b,{member:e,width:16,height:16,"aria-hidden":"true",hideTitle:!0})),t="mx_UserPill",a=null,i=this.onUserPillClicked)}break;case S.RoomMention:{const n=this.state.room;n&&(o=n.name||e,this.props.shouldShowPillAvatar&&(s=r.a.createElement(f.a,{room:n,width:16,height:16,"aria-hidden":"true"}))),t=null!=n&&n.isSpaceRoom()?"mx_SpacePill":"mx_RoomPill"}}const l=c()("mx_Pill",t,{mx_UserPill_me:n===h.a.get().getUserId()});if(this.state.pillType){let t;return this.state.hover&&e&&(t=r.a.createElement(v.b,{label:e,alignment:v.a.Right})),r.a.createElement("bdi",null,r.a.createElement(p.a.Provider,{value:this.matrixClient},this.props.inMessage?r.a.createElement("a",{className:l,href:a,onClick:i,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},s,r.a.createElement("span",{className:"mx_Pill_linkText"},o),t):r.a.createElement("span",{className:l,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},s,r.a.createElement("span",{className:"mx_Pill_linkText"},o),t)))}return null}}},function(e,t,n){"use strict";function i(e){return e+"px"}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(361),c=n(130),l=n(983),d=n(123),u=n(125),h=n(129),m=n(139);class p extends r.a.Component{constructor(e,t){super(e,t),s()(this,"context",void 0),s()(this,"onReactionsChange",(()=>{this.setState({selectedEmojis:new Set(Object.keys(this.getReactions()))})})),s()(this,"onChoose",(e=>{const t=e.unicode;this.componentWillUnmount(),this.props.onFinished();const n=this.getReactions();return n.hasOwnProperty(t)?(this.props.mxEvent.isRedacted()||!this.context.canSelfRedact||(d.a.get().redactEvent(this.props.mxEvent.getRoomId(),n[t]),u.a.dispatch({action:h.a.FocusAComposer,context:this.context.timelineRenderingType})),!1):(d.a.get().sendEvent(this.props.mxEvent.getRoomId(),c.b.Reaction,{"m.relates_to":{rel_type:c.h.Annotation,event_id:this.props.mxEvent.getId(),key:t}}),u.a.dispatch({action:"message_sent"}),u.a.dispatch({action:h.a.FocusAComposer,context:this.context.timelineRenderingType}),!0)})),s()(this,"isEmojiDisabled",(e=>!!this.getReactions()[e]&&!this.context.canSelfRedact)),this.state={selectedEmojis:new Set(Object.keys(this.getReactions()))},this.addListeners()}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.addListeners(),this.onReactionsChange())}addListeners(){this.props.reactions&&(this.props.reactions.on(a.b.Add,this.onReactionsChange),this.props.reactions.on(a.b.Remove,this.onReactionsChange),this.props.reactions.on(a.b.Redaction,this.onReactionsChange))}componentWillUnmount(){this.props.reactions&&(this.props.reactions.removeListener(a.b.Add,this.onReactionsChange),this.props.reactions.removeListener(a.b.Remove,this.onReactionsChange),this.props.reactions.removeListener(a.b.Redaction,this.onReactionsChange))}getReactions(){var e,t;if(!this.props.reactions)return{};const n=d.a.get().getUserId(),i=null!==(e=null===(t=this.props.reactions.getAnnotationsBySender())||void 0===t?void 0:t[n])&&void 0!==e?e:new Set;return Object.fromEntries([...i].filter((e=>!e.isRedacted())).map((e=>[e.getRelation().key,e.getId()])))}render(){return r.a.createElement(l.d,{allowUnlisted:!0,onChoose:this.onChoose,isEmojiDisabled:this.isEmojiDisabled,selectedEmojis:this.state.selectedEmojis,showQuickReactions:!0})}}s()(p,"contextType",m.b),t.a=p},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(578),c=n(121),l=n(133),d=n(182),u=n(123),h=n(136),m=n(238),p=n(579),g=n(462),v=n(302);class f extends r.a.Component{constructor(e){super(e),s()(this,"onBack",(()=>{this.setState({isEditing:!1})})),this.state={isEditing:!1}}onEdit(){this.setState({isEditing:!0})}viewSourceContent(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=e.isEncrypted(),n=e.clearEvent,i=e.event,s=()=>Object(g.f)(i);if(t){const e=()=>Object(g.f)(n);return r.a.createElement(r.a.Fragment,null,r.a.createElement("details",{open:!0,className:"mx_ViewSource_details"},r.a.createElement("summary",null,r.a.createElement("span",{className:"mx_ViewSource_heading"},Object(c.a)("Decrypted event source"))),n?r.a.createElement(v.a,{getTextToCopy:e},r.a.createElement(a.a,{language:"json"},Object(g.f)(n))):r.a.createElement("div",null,Object(c.a)("Decrypted source unavailable"))),r.a.createElement("details",{className:"mx_ViewSource_details"},r.a.createElement("summary",null,r.a.createElement("span",{className:"mx_ViewSource_heading"},Object(c.a)("Original event source"))),r.a.createElement(v.a,{getTextToCopy:s},r.a.createElement(a.a,{language:"json"},Object(g.f)(i)))))}return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_ViewSource_heading"},Object(c.a)("Original event source")),r.a.createElement(v.a,{getTextToCopy:s},r.a.createElement(a.a,{language:"json"},Object(g.f)(i))))}editSourceContent(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=e.isState(),n=e.getRoomId();return t?r.a.createElement(l.a.Consumer,null,(t=>r.a.createElement(m.a.Provider,{value:{room:t.getRoom(n)}},r.a.createElement(p.b,{onBack:this.onBack,mxEvent:e})))):r.a.createElement(l.a.Consumer,null,(t=>r.a.createElement(m.a.Provider,{value:{room:t.getRoom(n)}},r.a.createElement(g.c,{onBack:this.onBack,mxEvent:e}))))}canSendStateEvent(e){const t=u.a.get(),n=t.getRoom(e.getRoomId());return!(null==n||!n.currentState.mayClientSendStateEvent(e.getType(),t))}render(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=this.state.isEditing,n=e.getRoomId(),i=e.getId(),s=e.isState()?this.canSendStateEvent(e):Object(d.c)(this.props.mxEvent);return r.a.createElement(h.a,{className:"mx_ViewSource",onFinished:this.props.onFinished,title:Object(c.a)("View Source")},r.a.createElement("div",{className:"mx_ViewSource_header"},r.a.createElement(v.a,{getTextToCopy:()=>n,border:!1},Object(c.a)("Room ID: %(roomId)s",{roomId:n})),r.a.createElement(v.a,{getTextToCopy:()=>i,border:!1},Object(c.a)("Event ID: %(eventId)s",{eventId:i})),e.threadRootId&&r.a.createElement(v.a,{getTextToCopy:()=>e.threadRootId,border:!1},Object(c.a)("Thread root ID: %(threadRootId)s",{threadRootId:e.threadRootId}))),t?this.editSourceContent():this.viewSourceContent(),!t&&s&&r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:()=>this.onEdit()},Object(c.a)("Edit"))))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(120),s=n.n(i),o=n(803),r=n.n(o);class a extends s.a.PureComponent{render(){const{children:e,language:t}=this.props,n=t?r.a.highlight(e,{language:t}):r.a.highlightAuto(e);return s.a.createElement("pre",{className:`mx_SyntaxHighlight hljs language-${n.language}`},s.a.createElement("code",{dangerouslySetInnerHTML:{__html:n.value}}))}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return g}));var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(121),c=n(238),l=n(133),d=n(462),u=n(580);const h=e=>{let{mxEvent:t,onBack:n}=e;const o=Object(i.useContext)(c.a),r=Object(i.useContext)(l.a),a=Object(i.useMemo)((()=>[Object(d.d)(null==t?void 0:t.getType()),Object(d.e)(null==t?void 0:t.getStateKey())]),[t]),u=t?Object(d.f)(t.getContent()):void 0;return s.a.createElement(d.a,{fieldDefs:a,defaultContent:u,onSend:async(e,t)=>{let[n,i]=e;await r.sendStateEvent(o.room.roomId,n,t,i)},onBack:n})},m=e=>{let{label:t,onClick:n}=e;const i=t.trim();return s.a.createElement("button",{className:r()("mx_DevTools_button",{mx_DevTools_RoomStateExplorer_button_hasSpaces:i.length!==t.length,mx_DevTools_RoomStateExplorer_button_emptyString:!i}),onClick:n},i?t:Object(a.a)("<%(count)s spaces>",{count:t.length}))},p=e=>{let{eventType:t,onBack:n}=e;const o=Object(i.useContext)(c.a),[r,a]=Object(i.useState)(""),[l,p]=Object(i.useState)(null),g=o.room.currentState.events.get(t);if(Object(i.useEffect)((()=>{1===g.size&&g.has("")?p(g.get("")):p(null)}),[g]),l){const e=()=>{1===(null==g?void 0:g.size)&&g.has("")?n():p(null)};return s.a.createElement(d.b,{mxEvent:l,onBack:e,Editor:h})}return s.a.createElement(c.b,{onBack:n},s.a.createElement(u.a,{query:r,onChange:a},Array.from(g.entries()).map((e=>{let[t,n]=e;return s.a.createElement(m,{key:t,label:t,onClick:()=>p(n)})}))))},g=e=>{let{onBack:t,setTool:n}=e;const o=Object(i.useContext)(c.a),[r,l]=Object(i.useState)(""),[d,g]=Object(i.useState)(null),v=o.room.currentState.events;if(null!==d){const e=()=>{g(null)};return s.a.createElement(p,{eventType:d,onBack:e})}return s.a.createElement(c.b,{onBack:t,actionLabel:Object(a.a)("Send custom state event"),onAction:async()=>{n(Object(a.a)("Send custom state event"),h)}},s.a.createElement(u.a,{query:r,onChange:l},Array.from(v.keys()).map((e=>s.a.createElement(m,{key:e,label:e,onClick:()=>g(e)})))))}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(121),r=n(140),a=n(581);t.a=e=>{var t,n;let{children:c,query:l,onChange:d}=e;const[u,h]=Object(i.useState)(20),[m,p]=Object(i.useState)(c);Object(i.useEffect)((()=>{let e=c;if(l){const t=l.toLowerCase();e=c.filter((e=>e.key.toString().toLowerCase().includes(t)))}p(e),h(20)}),[c,l]);return s.a.createElement(s.a.Fragment,null,s.a.createElement(r.a,{label:Object(o.a)("Filter results"),autoFocus:!0,size:64,type:"text",autoComplete:"off",value:l,onChange:e=>d(e.target.value),className:"mx_TextInputDialog_input mx_DevTools_RoomStateExplorer_query",key:null!==(t=null==c||null===(n=c[0])||void 0===n?void 0:n.key)&&void 0!==t?t:""}),m.length<1?Object(o.a)("No results found"):s.a.createElement(a.a,{getChildren:(e,t)=>m.slice(e,t),getChildCount:()=>m.length,truncateAt:u,createOverflowElement:(e,t)=>s.a.createElement("button",{className:"mx_DevTools_button",onClick:()=>{h((e=>e+50))}},Object(o.a)("and %(count)s others...",{count:e}))}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(121);class c extends r.a.Component{getChildren(e,t){return this.props.getChildren&&this.props.getChildCount?this.props.getChildren(e,t):r.a.Children.toArray(this.props.children).filter((e=>null!=e)).slice(e,t)}getChildCount(){return this.props.getChildren&&this.props.getChildCount?this.props.getChildCount():r.a.Children.toArray(this.props.children).filter((e=>null!=e)).length}render(){let e=null;const t=this.getChildCount();let n=t;if(this.props.truncateAt>=0){const i=t-this.props.truncateAt;i>1&&(e=this.props.createOverflowElement(i,t),n=this.props.truncateAt)}const i=this.getChildren(0,n);return r.a.createElement("div",{className:this.props.className},i,e)}}s()(c,"defaultProps",{truncateAt:2,createOverflowElement:(e,t)=>r.a.createElement("div",null,Object(a.a)("And %(count)s more...",{count:e}))})},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(264);const s=e=>{var t;return e.getType()===i.b&&(null===(t=e.getContent())||void 0===t?void 0:t.state)===i.c.Started}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(140),c=n(121),l=n(136),d=n(146);class u extends r.a.Component{constructor(e){super(e),s()(this,"field",Object(o.createRef)()),s()(this,"onOk",(async e=>{if(e.preventDefault(),this.props.validator&&(this.setState({busy:!0}),await this.field.current.validate({allowEmpty:!1}),!this.field.current.state.valid))return this.field.current.focus(),this.field.current.validate({allowEmpty:!1,focused:!0}),void this.setState({busy:!1});this.props.onFinished(!0,this.state.value)})),s()(this,"onCancel",(()=>{this.props.onFinished(!1)})),s()(this,"onChange",(e=>{this.setState({value:e.target.value})})),s()(this,"onValidate",(async e=>{const t=await this.props.validator(e);return this.setState({valid:t.valid}),t})),this.state={value:this.props.value,busy:!1,valid:!1}}componentDidMount(){this.props.focus&&this.field.current.focus()}render(){return r.a.createElement(l.a,{className:"mx_TextInputDialog",onFinished:this.props.onFinished,title:this.props.title,fixedWidth:this.props.fixedWidth},r.a.createElement("form",{onSubmit:this.onOk},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_TextInputDialog_label"},r.a.createElement("label",{htmlFor:"textinput"}," ",this.props.description," ")),r.a.createElement("div",null,r.a.createElement(a.a,{className:"mx_TextInputDialog_input",ref:this.field,type:"text",label:this.props.placeholder,value:this.state.value,onChange:this.onChange,onValidate:this.props.validator?this.onValidate:void 0})))),r.a.createElement(d.a,{primaryButton:this.state.busy?Object(c.a)(this.props.busyMessage):this.props.button,disabled:this.state.busy,onPrimaryButtonClick:this.onOk,onCancel:this.onCancel,hasCancel:this.props.hasCancel}))}}s()(u,"defaultProps",{title:"",value:"",description:"",busyMessage:Object(c.c)("Loading…"),focus:!0,hasCancel:!0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return S}));var i=n(122),s=n.n(i),o=n(120),r=n(141),a=n(224),c=n(186),l=n(144),d=n(121),u=n(463),h=n(168),m=n(230),p=n(181),g=n(126),v=n(158),f=n(136),b=n(302);const y=[{name:"Facebook",img:n(1445),url:e=>`https://www.facebook.com/sharer/sharer.php?u=${e}`},{name:"Twitter",img:n(1446),url:e=>`https://twitter.com/home?status=${e}`},{name:"LinkedIn",img:n(1447),url:e=>`https://www.linkedin.com/shareArticle?mini=true&url=${e}`},{name:"Reddit",img:n(1448),url:e=>`https://www.reddit.com/submit?url=${e}`},{name:"email",img:n(1449),url:e=>`mailto:?body=${e}`}];class S extends o.PureComponent{constructor(e){super(e),s()(this,"onLinkSpecificEventCheckboxClick",(()=>{this.setState({linkSpecificEvent:!this.state.linkSpecificEvent})}));let t=null;e.target instanceof r.c&&(t=new h.a(e.target),t.load()),this.state={linkSpecificEvent:this.props.target instanceof l.b,permalinkCreator:t}}static onLinkClick(e){e.preventDefault(),Object(m.d)(e.currentTarget)}getUrl(){let e;if(this.props.target instanceof r.c)if(this.state.linkSpecificEvent){const t=this.props.target.getLiveTimeline().getEvents();e=this.state.permalinkCreator.forEvent(t[t.length-1].getId())}else e=this.state.permalinkCreator.forShareableRoom();else this.props.target instanceof a.a||this.props.target instanceof c.a?e=Object(h.i)(this.props.target.userId):this.props.target instanceof l.b&&(e=this.state.linkSpecificEvent?this.props.permalinkCreator.forEvent(this.props.target.getId()):this.props.permalinkCreator.forShareableRoom());return e}render(){let e,t;if(this.props.target instanceof r.c){e=Object(d.a)("Share Room");this.props.target.getLiveTimeline().getEvents().length>0&&(t=o.createElement("div",null,o.createElement(p.b,{checked:this.state.linkSpecificEvent,onChange:this.onLinkSpecificEventCheckboxClick},Object(d.a)("Link to most recent message"))))}else this.props.target instanceof a.a||this.props.target instanceof c.a?e=Object(d.a)("Share User"):this.props.target instanceof l.b&&(e=Object(d.a)("Share Room Message"),t=o.createElement("div",null,o.createElement(p.b,{checked:this.state.linkSpecificEvent,onChange:this.onLinkSpecificEventCheckboxClick},Object(d.a)("Link to selected message"))));const n=this.getUrl(),i=encodeURIComponent(n),s=g.b.getValue(v.b.ShareQRCode),h=g.b.getValue(v.b.ShareSocial);let m;return(s||h)&&(m=o.createElement(o.Fragment,null,o.createElement("hr",null),o.createElement("div",{className:"mx_ShareDialog_split"},s&&o.createElement("div",{className:"mx_ShareDialog_qrcode_container"},o.createElement(u.a,{data:n,width:256})),h&&o.createElement("div",{className:"mx_ShareDialog_social_container"},y.map((e=>o.createElement("a",{rel:"noreferrer noopener",target:"_blank",key:e.name,title:e.name,href:e.url(i),className:"mx_ShareDialog_social_icon"},o.createElement("img",{src:e.img,alt:e.name,height:64,width:64})))))))),o.createElement(f.a,{title:e,className:"mx_ShareDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},o.createElement("div",{className:"mx_ShareDialog_content"},o.createElement(b.a,{getTextToCopy:()=>n},o.createElement("a",{title:Object(d.a)("Link to room"),href:n,onClick:S.onLinkClick},n)),t,m))}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(387),s=n(121);function o(e){var t,n;let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(s.a)("Attachment"),r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=o;if(null!==(t=e.body)&&void 0!==t&&t.length&&(c=e.body),a&&c.length>19){const e=c.split(".");let t=e.slice(0,e.length-1).join(".").substring(0,15);const n=e[e.length-1];t=t.replace(/\.*$/g,""),c=`${t}...${n}`}return null!==(n=e.info)&&void 0!==n&&n.size&&r&&(c+=" ("+Object(i.filesize)(e.info.size)+")"),c}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(120);function s(){const[e,t]=Object(i.useState)(!1);return[e,{onFocus:()=>t(!0),onBlur:()=>t(!1)}]}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(212),r=n(464);class a extends o.a{constructor(e){super(),this.defaultTheme=e}getValueOverride(e,t,n,i){if(!n)return null;if(a.isLogin)return this.defaultTheme;return Object(r.a)()[n]?null:this.defaultTheme}}s()(a,"isLogin",!1)},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i),o=n(1),r=n(149),a=n(132),c=n(123);class l{constructor(){s()(this,"domain",void 0),s()(this,"update",(async e=>{var t,n;let i=(null===(t=a.b.getObject("jitsi"))||void 0===t?void 0:t.get("preferred_domain"))||"meet.element.io";o.a.log("Attempting to get Jitsi conference information from homeserver");const s=null==e||null===(n=e["im.vector.riot.jitsi"])||void 0===n?void 0:n.preferredDomain;s&&(i=s),this.domain=i,o.a.log("Jitsi conference domain:",this.preferredDomain)}))}get preferredDomain(){return this.domain||"meet.element.io"}async getJitsiAuth(){if(!this.preferredDomain)return null;let e;try{const t=await fetch(`https://${this.preferredDomain}/.well-known/element/jitsi`);e=await t.json()}catch(e){return null}return e.auth?e.auth:null}start(){const e=c.a.get();e.on(r.b.ClientWellKnown,this.update),this.update(e.getClientWellKnown())}parsePreferredConferenceUrl(e){const t=new URL(e);return t.hostname!==this.preferredDomain?null:{conferenceId:t.pathname.substring(1),domain:t.hostname,isAudioOnly:!1}}static getInstance(){return l.instance||(l.instance=new l),l.instance}}s()(l,"instance",void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i),o=n(219),r=n(17),a=n(123),c=n(129);class l extends r.EventEmitter{constructor(e){super(),this.dispatcher=e,s()(this,"matrixClient",null),s()(this,"dispatcherRef",null),s()(this,"onAction",(async e=>{this.onDispatcherAction(e),"MatrixActions.sync"===e.action?e.prevState!==o.b.Prepared&&e.state===o.b.Prepared&&this.matrixClient!==e.matrixClient&&(this.matrixClient&&await this.onNotReady(),this.matrixClient=e.matrixClient,await this.onReady()):"on_client_not_viable"!==e.action&&e.action!==c.a.OnLoggedOut||this.matrixClient&&(await this.onNotReady(),this.matrixClient=null)}))}async start(){this.dispatcherRef=this.dispatcher.register(this.onAction);const e=a.a.get();e&&(this.matrixClient=e,await this.onReady())}get mxClient(){return this.matrixClient}useUnitTestClient(e){this.matrixClient=e}destroy(){null!==this.dispatcherRef&&this.dispatcher.unregister(this.dispatcherRef)}async onReady(){}async onNotReady(){}onDispatcherAction(e){}}},,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(466);const r=new o.a;class a{constructor(){}static for(e,t){if(!e||!t)throw new Error("An instance and key must be supplied");return new c(e,t)}static forgetAllFor(e){r.delete(e)}static forgetAll(){for(const e of r.keys())r.remove(e)}}s()(a,"Void",Symbol("void"));class c{constructor(e,t){this.instance=e,this.key=t}forget(){const e=r.get(this.instance);e&&(e.remove(this.key),e.size||r.remove(this.instance))}do(e){const t=r.getOrCreate(this.instance,new o.a);let n=t.get(this.key);return void 0===n&&(n=e(),t.set(this.key,n)),n}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return B}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(571),c=n.n(a),l=n(150),d=n(130),u=n(1),h=n(171),m=n(125),p=n(1001),g=n(390),v=n(982),f=n(256),b=n(182),y=n(876),S=n(418),E=n(287),w=n(133),_=n(129),C=n(313),O=n(251),I=n(123),R=n(153),k=n(126),x=n(467),T=n(139),j=n(821),P=n(343),D=n(877),N=n(143),M=n(191),A=n(229),L=n(275);function U(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function F(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?U(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):U(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function B(e,t){t&&(e["m.relates_to"]=F(F({},e["m.relates_to"]||{}),t))}class V extends r.a.Component{constructor(e,t){super(e,t),s()(this,"context",void 0),s()(this,"prepareToEncrypt",void 0),s()(this,"editorRef",Object(o.createRef)()),s()(this,"model",void 0),s()(this,"currentlyComposedEditorState",null),s()(this,"dispatcherRef",void 0),s()(this,"sendHistoryManager",void 0),s()(this,"onKeyDown",(e=>{var t,n,i,s;if(null!==(t=this.editorRef.current)&&void 0!==t&&t.isComposing(e))return;const o=(null===(n=this.props.relation)||void 0===n?void 0:n.key)===h.d.name,r=Object(R.a)().getMessageComposerAction(e);switch(r){case N.h.SendMessage:this.sendMessage(),e.preventDefault();break;case N.h.SelectPrevSendHistory:case N.h.SelectNextSendHistory:this.selectSendHistory(r===N.h.SelectPrevSendHistory)&&e.preventDefault();break;case N.h.ShowStickerPicker:if(!k.b.getValue("MessageComposerInput.showStickersButton"))return;this.props.toggleStickerPickerOpen(),e.preventDefault();break;case N.h.EditPrevMessage:if(null!==(i=this.editorRef.current)&&void 0!==i&&i.isSelectionCollapsed()&&null!==(s=this.editorRef.current)&&void 0!==s&&s.isCaretAtStart()){const t=this.context.liveTimeline.getEvents().concat(o?[]:this.props.room.getPendingEvents()),n=Object(b.g)({events:t,isForward:!1});n&&(e.preventDefault(),m.a.dispatch({action:_.a.EditEvent,event:n,timelineRenderingType:this.context.timelineRenderingType}))}break;case N.h.CancelReplyOrEdit:m.a.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType});break;default:this.prepareToEncrypt&&this.prepareToEncrypt()}})),s()(this,"shouldSaveStoredEditorState",(()=>!this.model.isEmpty||!!this.props.replyToEvent)),s()(this,"saveStoredEditorState",(()=>{if(this.shouldSaveStoredEditorState()){const e=y.a.createItem(this.model,this.props.replyToEvent);localStorage.setItem(this.editorStateKey,JSON.stringify(e))}else this.clearStoredEditorState()})),s()(this,"onAction",(e=>{var t;if(!this.props.disabled)switch(e.action){case"reply_to_event":case _.a.FocusSendMessageComposer:var n;if((null!==(t=e.context)&&void 0!==t?t:T.a.Room)===this.context.timelineRenderingType)null===(n=this.editorRef.current)||void 0===n||n.focus();break;case _.a.ComposerInsert:if(e.timelineRenderingType!==this.context.timelineRenderingType)break;if(e.composerType!==P.a.Send)break;var i;if(e.userId)null===(i=this.editorRef.current)||void 0===i||i.insertMention(e.userId);else if(e.event){var s;null===(s=this.editorRef.current)||void 0===s||s.insertQuotedMessage(e.event)}else if(e.text){var o;null===(o=this.editorRef.current)||void 0===o||o.insertPlaintext(e.text)}else if(e.emoji){var r;null===(r=this.editorRef.current)||void 0===r||r.insertEmoji(e.emoji)}}})),s()(this,"onPaste",(e=>{const{clipboardData:t}=e;return!(!t.files.length||t.types.includes("text/rtf"))&&(E.a.sharedInstance().sendContentListToRoom(Array.from(t.files),this.props.room.roomId,this.props.relation,this.props.mxClient,this.context.timelineRenderingType),!0)})),s()(this,"onChange",(()=>{this.props.onChange&&this.props.onChange(this.model)})),s()(this,"focusComposer",(()=>{var e;null===(e=this.editorRef.current)||void 0===e||e.focus()})),this.context=t,this.props.mxClient.isCryptoEnabled()&&this.props.mxClient.isRoomEncrypted(this.props.room.roomId)&&(this.prepareToEncrypt=Object(l.throttle)((()=>{this.props.mxClient.prepareToEncrypt(this.props.room)}),6e4,{leading:!0,trailing:!1})),window.addEventListener("beforeunload",this.saveStoredEditorState);const n=new f.a(this.props.room,this.props.mxClient),i=this.restoreStoredEditorState(n)||[];this.model=new p.a(i,n),this.dispatcherRef=m.a.register(this.onAction),this.sendHistoryManager=new y.a(this.props.room.roomId,"mx_cider_history_")}componentDidUpdate(e){var t,n,i;const s=(null===(t=this.props.relation)||void 0===t?void 0:t.key)===h.d.name,o=(null===(n=this.props.relation)||void 0===n?void 0:n.event_id)!==(null===(i=e.relation)||void 0===i?void 0:i.event_id);if(s&&o){var r;const e=new f.a(this.props.room,this.props.mxClient),t=this.restoreStoredEditorState(e)||[];this.model.reset(t),null===(r=this.editorRef.current)||void 0===r||r.focus()}}selectSendHistory(e){const t=e?-1:1;if(this.sendHistoryManager.currentIndex===this.sendHistoryManager.history.length){if(!e)return!1;this.currentlyComposedEditorState=this.model.serializeParts()}else if(this.sendHistoryManager.currentIndex+t===this.sendHistoryManager.history.length)return this.model.reset(this.currentlyComposedEditorState),this.sendHistoryManager.currentIndex=this.sendHistoryManager.history.length,!0;const{parts:n,replyEventId:i}=this.sendHistoryManager.getItem(t);var s;(m.a.dispatch({action:"reply_to_event",event:i?this.props.room.findEventById(i):null,context:this.context.timelineRenderingType}),n)&&(this.model.reset(n),null===(s=this.editorRef.current)||void 0===s||s.focus());return!0}sendQuickReaction(){const e=this.context.liveTimeline.getEvents(),t=this.model.parts[1].text;for(let n=e.length-1;n>=0;n--)if(e[n].getType()===d.b.RoomMessage){let i=!0;const s=e[n],o=I.a.get().getUserId(),r=this.props.room.relations.getChildEventsForEvent(s.getId(),d.h.Annotation,d.b.Reaction);if(r){i=![...r.getAnnotationsBySender()[o]||new Set].filter((e=>!e.isRedacted())).map((e=>e.getRelation().key)).includes(t)}i&&(I.a.get().sendEvent(s.getRoomId(),d.b.Reaction,{"m.relates_to":{rel_type:d.h.Annotation,event_id:s.getId(),key:t}}),m.a.dispatch({action:"message_sent"}));break}}async sendMessage(){var e,t,n;const i=this.model;if(i.isEmpty)return;const s={eventName:"Composer",isEditing:!1,isReply:!!this.props.replyToEvent,inThread:(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===h.d.name};if(s.inThread){var o;const e=this.props.room.findEventById(this.props.relation.event_id);s.startsThread=1===(null==e||null===(o=e.getThread())||void 0===o?void 0:o.events.length)}if(M.a.instance.trackEvent(s),k.b.getValue("MessageComposerInput.autoReplaceEmoji")){var r;const e=i.parts.length-1,t=i.parts[e].text.length;null===(r=this.editorRef.current)||void 0===r||r.replaceEmoticon(new j.a(e,t),v.a)}const a=this.props.replyToEvent;let l=!0,d=null;if(!Object(g.a)(i)&&Object(D.b)(this.model)){const[e,t,n]=Object(D.a)(this.model);if(e){var u,p;const n=(null===(u=this.props.relation)||void 0===u?void 0:u.rel_type)===h.d.name?null===(p=this.props.relation)||void 0===p?void 0:p.event_id:null;let i;if([d,i]=await Object(D.c)(e,t,this.props.room.roomId,null!=n?n:null),!i)return;var f,b;if(e.category===S.a.messages||e.category===S.a.effects){if(B(d,this.props.relation),a)Object(A.a)(d,a,{permalinkCreator:this.props.permalinkCreator,includeLegacyFallback:null===(f=null===(b=d.msgtype)||void 0===b?void 0:b.startsWith("m."))||void 0===f||f})}else l=!1}else{const e=await Object(D.d)(n);if(m.a.dispatch({action:_.a.FocusAComposer,context:this.context.timelineRenderingType}),!e)return}}if(function(e){const t=e.parts;if(0==t.length)return!1;const n=Object(g.g)(e);if(t.length<=2){const e=n.startsWith("+")||n.startsWith("+ "),t=n.match(c.a);if(e&&t&&1==t.length)return t[0]===n.substring(1)||t[0]===n.substring(2)}return!1}(i)&&(l=!1,this.sendQuickReaction()),l){var y;const{roomId:e}=this.props.room;if(d||(d=function(e,t,n,i){let s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];const o=Object(g.a)(e);o&&(e=Object(g.e)(e)),Object(g.d)(e,"//")&&(e=Object(g.f)(e,"/")),e=Object(g.h)(e);const r={msgtype:o?"m.emote":"m.text",body:Object(g.g)(e)},a=Object(g.c)(e,{forceHTML:!!t,useMarkdown:k.b.getValue("MessageComposerInput.useMarkdown")});return a&&(r.format="org.matrix.custom.html",r.formatted_body=a),B(r,n),t&&Object(A.a)(r,t,{permalinkCreator:i,includeLegacyFallback:s}),r}(i,a,this.props.relation,this.props.permalinkCreator,this.props.includeReplyLegacyFallback)),!d.body.trim())return;k.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(x.a)(d);const t=(null===(y=this.props.relation)||void 0===y?void 0:y.rel_type)===h.d.name?this.props.relation.event_id:null,n=Object(L.a)(e,(e=>this.props.mxClient.sendMessage(e,null!=t?t:null,d)),this.props.mxClient);a&&m.a.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType}),m.a.dispatch({action:"message_sent"}),O.CHAT_EFFECTS.forEach((e=>{if(Object(C.containsEmoji)(d,e.emojis)){var t;(null===(t=this.props.relation)||void 0===t?void 0:t.rel_type)!==h.d.name&&m.a.dispatch({action:`effects.${e.command}`})}})),k.b.getValue("Performance.addSendMessageTimingMetadata")&&n.then((t=>{Object(x.b)(this.props.mxClient,e,t.event_id)}))}this.sendHistoryManager.save(i,a),i.reset([]),null===(t=this.editorRef.current)||void 0===t||t.clearUndoHistory(),null===(n=this.editorRef.current)||void 0===n||n.focus(),this.clearStoredEditorState(),l&&k.b.getValue("scrollToBottomOnMessageSent")&&m.a.dispatch({action:"scroll_to_bottom",timelineRenderingType:this.context.timelineRenderingType})}componentWillUnmount(){m.a.unregister(this.dispatcherRef),window.removeEventListener("beforeunload",this.saveStoredEditorState),this.saveStoredEditorState()}get editorStateKey(){var e;let t=`mx_cider_state_${this.props.room.roomId}`;return(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===h.d.name&&(t+=`_${this.props.relation.event_id}`),t}clearStoredEditorState(){localStorage.removeItem(this.editorStateKey)}restoreStoredEditorState(e){var t;if((null===(t=this.props.relation)||void 0===t?void 0:t.key)===h.d.name)return null;const n=localStorage.getItem(this.editorStateKey);if(n)try{const{parts:t,replyEventId:i}=JSON.parse(n),s=t.map((t=>e.deserializePart(t)));return i&&m.a.dispatch({action:"reply_to_event",event:this.props.room.findEventById(i),context:this.context.timelineRenderingType}),s}catch(e){u.a.error(e)}return null}render(){var e;const t=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===h.d.name?this.props.relation.event_id:void 0;return r.a.createElement("div",{className:"mx_SendMessageComposer",onClick:this.focusComposer,onKeyDown:this.onKeyDown},r.a.createElement(v.b,{onChange:this.onChange,ref:this.editorRef,model:this.model,room:this.props.room,threadId:t,label:this.props.placeholder,placeholder:this.props.placeholder,onPaste:this.onPaste,disabled:this.props.disabled}))}}s()(V,"contextType",T.b),s()(V,"defaultProps",{includeReplyLegacyFallback:!0});const K=Object(w.c)(V);t.b=K},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(122),s=n.n(i);const o=(e,t,n)=>""===n.text[t].trim();class r{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;this.model=e,s()(this,"_start",void 0),s()(this,"_end",void 0),s()(this,"_lastStart",void 0),s()(this,"_initializedEmpty",void 0);const i=t.compare(n)<0;this._start=i?t:n,this._end=i?n:t,this._lastStart=this._start,this._initializedEmpty=this._start.index===this._end.index&&this._start.offset==this._end.offset}moveStartForwards(e){this._start=this._start.forwardsWhile(this.model,(()=>(e-=1)>=0))}wasInitializedEmpty(){return this._initializedEmpty}setWasEmpty(e){this._initializedEmpty=e}getLastStartingPosition(){return this._lastStart}setLastStartingPosition(e){this._lastStart=e}moveEndBackwards(e){this._end=this._end.backwardsWhile(this.model,(()=>(e-=1)>=0))}trim(){""!==this.text.trim()?(this._start=this._start.forwardsWhile(this.model,o),this._end=this._end.backwardsWhile(this.model,o)):this._start=this._end}expandBackwardsWhile(e){this._start=this._start.backwardsWhile(this.model,e)}expandForwardsWhile(e){this._end=this._end.forwardsWhile(this.model,e)}get text(){let e="";return this._start.iteratePartsBetween(this._end,this.model,((t,n,i)=>{const s=t.text.substring(n,i);e+=s})),e}replace(e){const t=e.reduce(((e,t)=>e+t.text.length),0);let n=0;return this._start.iteratePartsBetween(this._end,this.model,((e,t,i)=>{n+=i-t})),this.model.replaceRange(this._start,this._end,e),t-n}get parts(){const e=[];return this._start.iteratePartsBetween(this._end,this.model,((t,n,i)=>{const s=t.serialize();s.text=t.text.substring(n,i);const o=this.model.partCreator.deserializePart(s);e.push(o)})),e}get length(){let e=0;return this._start.iteratePartsBetween(this._end,this.model,((t,n,i)=>{e+=i-n})),e}get start(){return this._start}get end(){return this._end}}},function(e,t,n){"use strict";n.d(t,"d",(function(){return s})),n.d(t,"c",(function(){return o})),n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return d})),n.d(t,"e",(function(){return h}));var i=n(256);function s(e,t){const n=!t||t.type===i.b.Newline;return!e.acceptsCaret&&(n||!t.acceptsCaret)}function o(e,t){return!e.acceptsCaret&&t}function r(e,t){const n=e.nextSibling;n?e.parentElement.insertBefore(t,n):e.parentElement.appendChild(t)}const a="\ufeff";function c(){const e=document.createElement("span");return e.className="caretNode",e.appendChild(document.createTextNode(a)),e}function l(e){e.textContent!==a&&(e.textContent=a)}function d(e){return!!e&&e instanceof HTMLElement&&"SPAN"===e.tagName&&"caretNode"===e.className}function u(e){if(e)for(e=e.nextSibling;e;){const t=e;e=e.nextSibling,t.remove()}}function h(e,t){const n=t.parts.reduce(((e,t)=>{if(t.type===i.b.Newline)e.push([]);else{e[e.length-1].push(t)}return e}),[[]]);n.forEach(((t,n)=>{let i=e.childNodes[n];for(;i&&("DIV"!==i.tagName||i.className);)e.removeChild(i),i=e.childNodes[n];i||(i=document.createElement("div"),e.appendChild(i)),t.length?function(e,t){let n,i=null;const a=t[t.length-1];for(const u of t){for(i=n?i.nextSibling:e.firstChild,s(u,n)&&(d(i)?(l(i),i=i.nextSibling):e.insertBefore(c(),i));i&&!u.canUpdateDOMNode(i);){const t=i.nextSibling;e.removeChild(i),i=t}var h;if(i&&u?u.updateDOMNode(i):u&&(i=u.toDOMNode(),e.appendChild(i)),o(u,u===a))if(d(null===(h=i)||void 0===h?void 0:h.nextSibling))i=i.nextSibling,l(i);else{const e=c();r(i,e),i=e}n=u}u(i)}(i,t):function(e){let t=!1,n=e.firstChild;for(;n;){const e=n.nextSibling;t||"BR"!==n.tagName?n.remove():t=!0,n=e}t||e.appendChild(document.createElement("br"))}(i)})),n.length?u(e.children[n.length-1]):function(e){const t=e.firstChild;t&&(u(t),t.remove())}(e)}},,,,,function(e,t,n){"use strict";(function(e){n.d(t,"d",(function(){return u})),n.d(t,"e",(function(){return h})),n.d(t,"b",(function(){return m})),n.d(t,"a",(function(){return p})),n.d(t,"c",(function(){return g}));var i=n(122),s=n.n(i),o=n(1),r=n(225),a=n(1520);const c=5242880;class l{constructor(){s()(this,"logs",""),s()(this,"originalFunctions",{})}monkeyPatch(e){var t=this;const n={log:"I",info:"I",warn:"W",error:"E"};Object.keys(n).forEach((i=>{const s=n[i],o=e[i].bind(e);this.originalFunctions[i]=o,e[i]=function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];t.log(s,...n),o(...n)}}))}bypassRageshake(e){for(var t,n,i=arguments.length,s=new Array(i>1?i-1:0),o=1;o<i;o++)s[o-1]=arguments[o];null===(t=(n=this.originalFunctions)[e])||void 0===t||t.call(n,...s)}log(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];let s=`${(new Date).toISOString()} ${e} ${(n=n.map((e=>e instanceof DOMException?e.message+` (${e.name} | ${e.code})`:e instanceof Error?e.message+(e.stack?`\n${e.stack}`:""):"object"==typeof e?JSON.stringify(e,Object(a.a)()):e))).join(" ")}\n`;s=s.replace(/token=[a-zA-Z0-9-]+/gm,"token=xxxxx"),this.logs+=s}flush(e){if(e)return this.logs;const t=this.logs;return this.logs="",t}}class d{constructor(e,t){this.indexedDB=e,this.logger=t,s()(this,"id",void 0),s()(this,"index",0),s()(this,"db",null),s()(this,"flushPromise",null),s()(this,"flushAgainPromise",null),this.id="instance-"+Object(r.b)(16)}connect(){const e=this.indexedDB.open("logs");return new Promise(((t,n)=>{e.onsuccess=()=>{this.db=e.result,window.setInterval(this.flush.bind(this),3e4),t()},e.onerror=()=>{var t;const i="Failed to open log database: "+(null===(t=e.error)||void 0===t?void 0:t.name);o.a.error(i),n(new Error(i))},e.onupgradeneeded=()=>{const t=e.result,n=t.createObjectStore("logs",{keyPath:["id","index"]});n.createIndex("id","id",{unique:!1}),n.add(this.generateLogEntry(new Date+" ::: Log database was created."));t.createObjectStore("logslastmod",{keyPath:"id"}).add(this.generateLastModifiedTime())}}))}flush(){return this.flushPromise?(this.flushAgainPromise||(this.flushAgainPromise=this.flushPromise.then((()=>this.flush())).then((()=>{this.flushAgainPromise=null}))),this.flushAgainPromise):(this.flushPromise=new Promise(((e,t)=>{if(!this.db)return void t(new Error("No connected database"));const n=this.logger.flush();if(0===n.length)return void e();const i=this.db.transaction(["logs","logslastmod"],"readwrite"),s=i.objectStore("logs");i.oncomplete=t=>{e()},i.onerror=()=>{var e;o.a.error("Failed to flush logs : ",i.error),t(new Error("Failed to write logs: "+(null===(e=i.error)||void 0===e?void 0:e.message)))},s.add(this.generateLogEntry(n));i.objectStore("logslastmod").put(this.generateLastModifiedTime())})).then((()=>{this.flushPromise=null})),this.flushPromise)}async consume(){const e=this.db;function t(t,n){const i=e.transaction("logs","readonly").objectStore("logs");return new Promise(((e,s)=>{const o=i.index("id").openCursor(IDBKeyRange.only(t),"prev");let r="";o.onerror=()=>{var e;s(new Error("Query failed: "+(null===(e=o.error)||void 0===e?void 0:e.message)))},o.onsuccess=()=>{const t=o.result;t?(r=t.value.lines+r,r.length>=n?e(r):t.continue()):e(r)}}))}const n=await function(e,t,n){const i=e.openCursor(t);return new Promise(((e,t)=>{const s=[];i.onerror=()=>{var e;t(new Error("Query failed: "+(null===(e=i.error)||void 0===e?void 0:e.message)))},i.onsuccess=()=>{const t=i.result;t?(s.push(n(t)),t.continue()):e(s)}}))}(e.transaction("logslastmod","readonly").objectStore("logslastmod"),void 0,(e=>({id:e.value.id,ts:e.value.ts}))).then((e=>e.sort(((e,t)=>t.ts-e.ts)).map((e=>e.id))));let i=[];const s=[];let r=0;for(let e=0;e<n.length;e++){const o=await t(n[e],c-r);if(s.push({lines:o,id:n[e]}),r+=o.length,r>=c){i=n.slice(e+1);break}}return i.length>0&&(o.a.log("Removing logs: ",i),Promise.all(i.map((t=>function(t){return new Promise(((n,i)=>{const s=e.transaction(["logs","logslastmod"],"readwrite"),o=s.objectStore("logs"),r=o.index("id").openKeyCursor(IDBKeyRange.only(t));r.onsuccess=()=>{const e=r.result;e&&(o.delete(e.primaryKey),e.continue())},s.oncomplete=()=>{n()},s.onerror=()=>{var e;i(new Error(`Failed to delete logs for '${t}' : ${null===(e=r.error)||void 0===e?void 0:e.message}`))},s.objectStore("logslastmod").delete(t)}))}(t)))).then((()=>{o.a.log(`Removed ${i.length} old logs.`)}),(e=>{o.a.error(e)}))),s}generateLogEntry(e){return{id:this.id,lines:e,index:this.index++}}generateLastModifiedTime(){return{id:this.id,ts:Date.now()}}}function u(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return e.mx_rage_initPromise?e.mx_rage_initPromise:(e.mx_rage_logger=new l,e.mx_rage_logger.monkeyPatch(window.console),t?h():(e.mx_rage_initPromise=Promise.resolve(),e.mx_rage_initPromise))}function h(){if(e.mx_rage_initStoragePromise)return e.mx_rage_initStoragePromise;let t;o.a.log("Configuring rageshake persistence...");try{t=window.indexedDB}catch(e){}return t?(e.mx_rage_store=new d(t,e.mx_rage_logger),e.mx_rage_initStoragePromise=e.mx_rage_store.connect(),e.mx_rage_initStoragePromise):(e.mx_rage_initStoragePromise=Promise.resolve(),e.mx_rage_initStoragePromise)}function m(){e.mx_rage_store&&e.mx_rage_store.flush()}async function p(){e.mx_rage_store&&await e.mx_rage_store.consume()}async function g(){if(!e.mx_rage_logger)throw new Error("No console logger, did you forget to call init()?");return e.mx_rage_store?(await e.mx_rage_store.flush(),e.mx_rage_store.consume()):[{lines:e.mx_rage_logger.flush(!0),id:"-"}]}}).call(this,n(14))},function(e,t,n){"use strict";n.d(t,"b",(function(){return m})),n.d(t,"c",(function(){return p})),n.d(t,"a",(function(){return g}));var i=n(1521),s=n(132),o=n(123),r=n(126);async function a(){const e={};if(navigator.storage&&navigator.storage.persisted)try{e.storageManager_persisted=String(await navigator.storage.persisted())}catch(e){}else if(document.hasStorageAccess)try{e.storageManager_persisted=String(await document.hasStorageAccess())}catch(e){}if(navigator.storage&&navigator.storage.estimate)try{const t=await navigator.storage.estimate();if(e.storageManager_quota=String(t.quota),e.storageManager_usage=String(t.usage),t.usageDetails){const n=[];Object.keys(t.usageDetails).forEach((e=>{n.push(`${e}: ${String(t.usageDetails[e])}`)})),e.storageManager_usage=n.join(", ")}}catch(e){}return e}function c(e){return{username:e.credentials.userId,enabled_labs:l(),low_bandwidth:r.b.getValue("lowBandwidth")?"enabled":"disabled"}}function l(){const e=r.b.getFeatureSettingNames().filter((e=>r.b.getValue(e)));return e.length?e.join(", "):""}async function d(e){if(!e.isCryptoEnabled()||!e.crypto)return{};const t=[`ed25519:${e.getDeviceEd25519Key()}`];e.getDeviceCurve25519Key&&t.push(`curve25519:${e.getDeviceCurve25519Key()}`);const n=e.crypto.crossSigningInfo,i=e.crypto.secretStorage,s=e.getCrossSigningCacheCallbacks(),o=await e.crypto.getSessionBackupPrivateKey();return{device_keys:t.join(", "),cross_signing_ready:String(await e.isCrossSigningReady()),cross_signing_supported_by_hs:String(await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")),cross_signing_key:n.getId(),cross_signing_privkey_in_secret_storage:String(!!await n.isStoredInSecretStorage(i)),cross_signing_master_privkey_cached:String(!(!s||!await s.getCrossSigningKeyCache("master"))),cross_signing_user_signing_privkey_cached:String(!(!s||!await s.getCrossSigningKeyCache("user_signing"))),secret_storage_ready:String(await e.isSecretStorageReady()),secret_storage_key_in_account:String(!!await i.hasKey()),session_backup_key_in_secret_storage:String(!!await e.isKeyBackupKeyStored()),session_backup_key_cached:String(!!o),session_backup_key_well_formed:String(o instanceof Uint8Array)}}function u(e){const t={device_id:null==e?void 0:e.deviceId,mx_local_settings:localStorage.getItem("mx_local_settings")};if(window.Modernizr){const e=Object.keys(window.Modernizr).filter((e=>!1===window.Modernizr[e]));e.length>0&&(t.modernizr_missing_features=e.join(", "))}return t}async function h(){const e=o.a.get();return{user:c(e),crypto:await d(e),device:u(e),storage:await a()}}async function m(e,t,n){if(!s.b.getObject("sentry"))return;const o={contexts:await h(),extra:{user_text:e,issue_url:t}};n?i.captureException(n,o):t&&i.captureMessage(`Issue: ${t}`,o)}function p(e){s.b.get().sentry&&r.b.getValue("automaticErrorReporting")&&i.setUser({username:e})}async function g(e){if(!e)return;const t=[new i.Integrations.InboundFilters,new i.Integrations.FunctionToString,new i.Integrations.Breadcrumbs,new i.Integrations.HttpContext,new i.Integrations.Dedupe];r.b.getValue("automaticErrorReporting")&&(t.push(new i.Integrations.GlobalHandlers({onerror:!1,onunhandledrejection:!0})),t.push(new i.Integrations.TryCatch)),i.init({dsn:e.dsn,release:"1.11.26-sc.1",environment:e.environment,defaultIntegrations:!1,autoSessionTracking:!1,integrations:t,tracesSampleRate:1})}window.mxSendSentryReport=m},,,,,,,,,,,,,,,,,function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.Dm="dm",e.Invite="invite",e.CallTransfer="call_transfer"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a}));var i=n(204),s=n(126),o=n(138);let r;!function(e){e[e.Allowed=0]="Allowed",e[e.Denied=1]="Denied",e[e.Unknown=2]="Unknown"}(r||(r={}));class a{constructor(e){this.context=e}packSettingKey(e,t,n){let s=n;var o;t!==i.WidgetKind.Room&&(s=null===(o=this.context.client)||void 0===o?void 0:o.getUserId());if(t===i.WidgetKind.Modal&&(s="*MODAL*-"+s),!s)throw new Error("Failed to determine a location to check the widget's OIDC state with");return encodeURIComponent(`${s}::${e.templateUrl}`)}getOIDCState(e,t,n){var i,o;const a=this.packSettingKey(e,t,n),c=s.b.getValue("widgetOpenIDPermissions");return null!=c&&null!==(i=c.deny)&&void 0!==i&&i.includes(a)?r.Denied:null!=c&&null!==(o=c.allow)&&void 0!==o&&o.includes(a)?r.Allowed:r.Unknown}setOIDCState(e,t,n,i){const a=this.packSettingKey(e,t,n);let c=s.b.getValue("widgetOpenIDPermissions");c||(c={}),c.allow||(c.allow=[]),c.deny||(c.deny=[]),i===r.Allowed?c.allow.push(a):i===r.Denied?c.deny.push(a):(c.allow=c.allow.filter((e=>e!==a)),c.deny=c.deny.filter((e=>e!==a))),s.b.setValue("widgetOpenIDPermissions",null,o.a.DEVICE,c)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return w}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(130),c=n(161),l=n(132),d=n(201),u=n(121),h=n(123),m=n(140),p=n(627),g=n(240),v=n(146),f=n(136),b=n(864),y=n(153),S=n(143),E=n(312);class w extends r.a.Component{constructor(e){var t;super(e),s()(this,"supportsRestricted",void 0),s()(this,"nameField",Object(o.createRef)()),s()(this,"aliasField",Object(o.createRef)()),s()(this,"onKeyDown",(e=>{if(Object(y.a)().getAccessibilityAction(e)===S.h.Enter)this.onOk(),e.preventDefault(),e.stopPropagation()})),s()(this,"onOk",(async()=>{const e=document.activeElement;if(e&&e.blur(),await this.nameField.current.validate({allowEmpty:!1}),this.aliasField.current&&await this.aliasField.current.validate({allowEmpty:!1}),await new Promise((e=>this.setState({},e))),!this.state.nameIsValid||this.aliasField.current&&!this.aliasField.current.isValid){let e;this.state.nameIsValid?this.aliasField.current&&!this.aliasField.current.isValid&&(e=this.aliasField.current):e=this.nameField.current,e&&(e.focus(),e.validate({allowEmpty:!1,focused:!0}))}else this.props.onFinished(!0,this.roomCreateOptions())})),s()(this,"onCancel",(()=>{this.props.onFinished(!1)})),s()(this,"onNameChange",(e=>{this.setState({name:e.target.value})})),s()(this,"onTopicChange",(e=>{this.setState({topic:e.target.value})})),s()(this,"onJoinRuleChange",(e=>{this.setState({joinRule:e})})),s()(this,"onEncryptedChange",(e=>{this.setState({isEncrypted:e})})),s()(this,"onAliasChange",(e=>{this.setState({alias:e})})),s()(this,"onDetailsToggled",(e=>{this.setState({detailsOpen:e.target.open})})),s()(this,"onNoFederateChange",(e=>{this.setState({noFederate:e})})),s()(this,"onNameValidate",(async e=>{const t=await w.validateRoomName(e);return this.setState({nameIsValid:t.valid}),t})),this.supportsRestricted=!!this.props.parentSpace;let n=c.c.Invite;this.props.defaultPublic?n=c.c.Public:this.supportsRestricted&&(n=c.c.Restricted),this.state={isPublic:this.props.defaultPublic||!1,isEncrypted:null!==(t=this.props.defaultEncrypted)&&void 0!==t?t:Object(E.a)(),joinRule:n,name:this.props.defaultName||"",topic:"",alias:"",detailsOpen:!1,noFederate:!1===l.b.get().default_federate,nameIsValid:!1,canChangeEncryption:!0},h.a.get().doesServerForceEncryptionForPreset(c.d.PrivateChat).then((e=>this.setState({canChangeEncryption:!e})))}roomCreateOptions(){const e={},t=e.createOpts={};if(e.roomType=this.props.type,t.name=this.state.name,this.state.joinRule===c.c.Public){t.visibility=c.f.Public,t.preset=c.d.PublicChat,e.guestAccess=!1;const{alias:n}=this.state;t.room_alias_name=n.substring(1,n.indexOf(":"))}else e.encryption=!this.state.canChangeEncryption||this.state.isEncrypted;return this.state.topic&&(t.topic=this.state.topic),this.state.noFederate&&(t.creation_content={"m.federate":!1}),e.parentSpace=this.props.parentSpace,this.props.parentSpace&&this.state.joinRule===c.c.Restricted&&(e.joinRule=c.c.Restricted),e}componentDidMount(){this.nameField.current.focus()}render(){const e=this.props.type===a.j.ElementVideo;let t,n,i;if(this.state.joinRule===c.c.Public){const e=h.a.get().getDomain();t=r.a.createElement("div",{className:"mx_CreateRoomDialog_aliasContainer"},r.a.createElement(p.a,{ref:this.aliasField,onChange:this.onAliasChange,domain:e,value:this.state.alias}))}if(this.state.joinRule===c.c.Restricted?n=r.a.createElement("p",null,Object(u.a)("Everyone in <SpaceName/> will be able to find and join this room.",{},{SpaceName:()=>r.a.createElement("b",null,this.props.parentSpace.name)})," ",Object(u.a)("You can change this at any time from room settings.")):this.state.joinRule===c.c.Public&&this.props.parentSpace?n=r.a.createElement("p",null,Object(u.a)("Anyone will be able to find and join this room, not just members of <SpaceName/>.",{},{SpaceName:()=>r.a.createElement("b",null,this.props.parentSpace.name)})," ",Object(u.a)("You can change this at any time from room settings.")):this.state.joinRule===c.c.Public?n=r.a.createElement("p",null,Object(u.a)("Anyone will be able to find and join this room.")," ",Object(u.a)("You can change this at any time from room settings.")):this.state.joinRule===c.c.Invite&&(n=r.a.createElement("p",null,Object(u.a)("Only people invited will be able to find and join this room.")," ",Object(u.a)("You can change this at any time from room settings."))),this.state.joinRule!==c.c.Public){let t;t=Object(E.a)()?this.state.canChangeEncryption?e?Object(u.a)("You can't disable this later. The room will be encrypted but the embedded call will not."):Object(u.a)("You can't disable this later. Bridges & most bots won't work yet."):Object(u.a)("Your server requires encryption to be enabled in private rooms."):Object(u.a)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."),i=r.a.createElement(r.a.Fragment,null,r.a.createElement(g.a,{label:Object(u.a)("Enable end-to-end encryption"),onChange:this.onEncryptedChange,value:this.state.isEncrypted,className:"mx_CreateRoomDialog_e2eSwitch",disabled:!this.state.canChangeEncryption}),r.a.createElement("p",null,t))}let s,o=Object(u.a)("You might enable this if the room will only be used for collaborating with internal teams on your homeserver. This cannot be changed later.");return!1===l.b.get().default_federate&&(o=Object(u.a)("You might disable this if the room will be used for collaborating with external teams who have their own homeserver. This cannot be changed later.")),s=e?Object(u.a)("Create a video room"):this.props.parentSpace?Object(u.a)("Create a room"):this.state.joinRule===c.c.Public?Object(u.a)("Create a public room"):Object(u.a)("Create a private room"),r.a.createElement(f.a,{className:"mx_CreateRoomDialog",onFinished:this.props.onFinished,title:s,screenName:"CreateRoom"},r.a.createElement("form",{onSubmit:this.onOk,onKeyDown:this.onKeyDown},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement(m.a,{ref:this.nameField,label:Object(u.a)("Name"),onChange:this.onNameChange,onValidate:this.onNameValidate,value:this.state.name,className:"mx_CreateRoomDialog_name"}),r.a.createElement(m.a,{label:Object(u.a)("Topic (optional)"),onChange:this.onTopicChange,value:this.state.topic,className:"mx_CreateRoomDialog_topic"}),r.a.createElement(b.a,{label:Object(u.a)("Room visibility"),labelInvite:Object(u.a)("Private room (invite only)"),labelPublic:Object(u.a)("Public room"),labelRestricted:this.supportsRestricted?Object(u.a)("Visible to space members"):void 0,value:this.state.joinRule,onChange:this.onJoinRuleChange}),n,i,t,r.a.createElement("details",{onToggle:this.onDetailsToggled,className:"mx_CreateRoomDialog_details"},r.a.createElement("summary",{className:"mx_CreateRoomDialog_details_summary"},this.state.detailsOpen?Object(u.a)("Hide advanced"):Object(u.a)("Show advanced")),r.a.createElement(g.a,{label:Object(u.a)("Block anyone not part of %(serverName)s from ever joining this room.",{serverName:h.a.getHomeserverName()}),onChange:this.onNoFederateChange,value:this.state.noFederate}),r.a.createElement("p",null,o)))),r.a.createElement(v.a,{primaryButton:e?Object(u.a)("Create video room"):Object(u.a)("Create room"),onPrimaryButtonClick:this.onOk,onCancel:this.onCancel}))}}s()(w,"validateRoomName",Object(d.a)({rules:[{key:"required",test:async e=>{let{value:t}=e;return!!t},invalid:()=>Object(u.a)("Please enter a name for the room")}]}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(121),c=n(201),l=n(140),d=n(133);class u extends r.a.PureComponent{constructor(e,t){super(e,t),s()(this,"context",void 0),s()(this,"fieldRef",Object(o.createRef)()),s()(this,"onChange",(e=>{var t,n;null===(t=(n=this.props).onChange)||void 0===t||t.call(n,this.asFullAlias(e.target.value))})),s()(this,"onValidate",(async e=>{const t=await this.validationRules(e);return this.setState({isValid:t.valid}),t})),s()(this,"validationRules",Object(c.a)({rules:[{key:"hasDomain",test:async e=>{let{value:t}=e;return!(t&&!this.props.domain)||!(t.split(":").length<2)},invalid:()=>Object(a.a)("Missing domain separator e.g. (:domain.org)")},{key:"hasLocalpart",test:async e=>{let{value:t}=e;if(!t||this.props.domain)return!0;const n=t.split(":");return n.length<2||!(n[0].length<1)},invalid:()=>Object(a.a)("Missing room name or separator e.g. (my-room:domain.org)")},{key:"safeLocalpart",test:async e=>{let{value:t}=e;if(!t)return!0;if(this.props.domain){const e=this.asFullAlias(t),n=!this.props.domain||!t.includes(":");return!t.includes("#")&&n&&!t.includes(",")&&encodeURI(e)===e}return!0},invalid:()=>Object(a.a)("Some characters not allowed")},{key:"required",test:async e=>{let{value:t,allowEmpty:n}=e;return n||!!t},invalid:()=>Object(a.a)("Please provide an address")},this.props.roomId?{key:"matches",final:!0,test:async e=>{let{value:t}=e;if(!t)return!0;const n=this.context;try{return(await n.getRoomIdForAlias(this.asFullAlias(t))).room_id===this.props.roomId}catch(e){return console.log(e),!1}},invalid:()=>Object(a.a)("This address does not point at this room")}:{key:"taken",final:!0,test:async e=>{let{value:t}=e;if(!t)return!0;const n=this.context;try{return await n.getRoomIdForAlias(this.asFullAlias(t)),!1}catch(e){return console.log(e),!!e.errcode}},valid:()=>Object(a.a)("This address is available to use"),invalid:()=>this.props.domain?Object(a.a)("This address is already in use"):Object(a.a)("This address had invalid server or is already in use")}]})),this.state={isValid:!0}}asFullAlias(e){const t=`#${e}`;return this.props.domain?`${t}:${this.props.domain}`:t}get domainProps(){const{domain:e}=this.props,t=r.a.createElement("span",null,"#"),n=e?r.a.createElement("span",{title:`:${e}`},`:${e}`):r.a.createElement("span",null),i=e?255-e.length-2:254;return{prefix:t,postfix:n,value:e?this.props.value.substring(1,this.props.value.length-this.props.domain.length-1):this.props.value.substring(1),maxlength:i}}render(){const{prefix:e,postfix:t,value:n,maxlength:i}=this.domainProps;return r.a.createElement(l.a,{label:this.props.label||Object(a.a)("Room address"),className:"mx_RoomAliasField",prefixComponent:e,postfixComponent:t,ref:this.fieldRef,onValidate:this.onValidate,placeholder:this.props.placeholder||Object(a.a)("e.g. my-room"),onChange:this.onChange,value:n,maxLength:i,disabled:this.props.disabled,autoComplete:"off",onKeyDown:this.props.onKeyDown})}get isValid(){return this.state.isValid}validate(e){var t;return null===(t=this.fieldRef.current)||void 0===t?void 0:t.validate(e)}focus(){var e;null===(e=this.fieldRef.current)||void 0===e||e.focus()}}s()(u,"contextType",d.a)},function(e,t,n){"use strict";n.d(t,"c",(function(){return j})),n.d(t,"b",(function(){return M})),n.d(t,"a",(function(){return A}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a),l=n(130),d=n(161),u=n(1),h=n(121),m=n(148),p=n(151),g=n(221),v=n(133),f=n(867),b=n(124),y=n(140),S=n(201),E=n(627),w=n(128),_=n(866),C=n(126),O=n(153),I=n(143),R=n(123),k=n(476);function x(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function T(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?x(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):x(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const j=async function(e,t,n,i,s){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{};return Object(g.b)(T({createOpts:T({name:e,preset:t?d.d.PublicChat:d.d.PrivateChat,visibility:t&&await R.a.get().doesServerSupportUnstableFeature("org.matrix.msc3827.stable")?d.f.Public:d.f.Private,power_level_content_override:{events_default:100,invite:t?0:50},room_alias_name:t&&n?n.substring(1,n.indexOf(":")):void 0,topic:i},o),avatar:s,roomType:l.j.Space,historyVisibility:t?d.b.WorldReadable:d.b.Invited,spinner:!1,encryption:!1,andView:!0,inlineErrors:!0},r))},P=e=>{let{title:t,description:n,className:i,onClick:s}=e;return r.a.createElement(b.a,{className:c()("mx_SpaceCreateMenuType",i),onClick:s},r.a.createElement("h3",null,t),r.a.createElement("span",null,n))},D=Object(S.a)({rules:[{key:"required",test:async e=>{let{value:t}=e;return!!t},invalid:()=>Object(h.a)("Please enter a name for the space")}]}),N=e=>e.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9_-]+/gi,""),M=e=>{let{onClick:t}=e;return Object(k.a)()?r.a.createElement("div",{className:"mx_SpaceFeedbackPrompt"},r.a.createElement("span",{className:"mx_SpaceFeedbackPrompt_text"},Object(h.a)("Spaces are a new feature.")),r.a.createElement(b.a,{kind:"link_inline",onClick:()=>{t&&t(),w.b.createDialog(_.a,{title:Object(h.a)("Spaces feedback"),subheading:Object(h.a)("Thank you for trying Spaces. Your feedback will help inform the next versions."),rageshakeLabel:"spaces-feedback",rageshakeData:Object.fromEntries(["Spaces.allRoomsInHome","Spaces.enabledMetaSpaces"].map((e=>[e,String(C.b.getValue(e))])))})}},Object(h.a)("Give feedback."))):null},A=e=>{var t;let{busy:n,onSubmit:i,avatarUrl:s,setAvatar:a,name:c,setName:l,nameFieldRef:d,alias:u,aliasFieldRef:m,setAlias:p,showAliasField:g,topic:b,setTopic:S,children:w}=e;const _=null!==(t=Object(o.useContext)(v.a).getDomain())&&void 0!==t?t:void 0,C=e=>{if(Object(O.a)().getAccessibilityAction(e)===I.h.Enter)i(e)};return r.a.createElement("form",{className:"mx_SpaceBasicSettings",onSubmit:i},r.a.createElement(f.a,{avatarUrl:s,setAvatar:a,avatarDisabled:n}),r.a.createElement(y.a,{name:"spaceName",label:Object(h.a)("Name"),autoFocus:!0,value:c,onChange:e=>{const t=e.target.value;var n;u&&u!==`#${N(c)}:${_}`||(p(`#${N(t)}:${_}`),null===(n=m.current)||void 0===n||n.validate({allowEmpty:!0}));l(t)},onKeyDown:C,ref:d,onValidate:D,disabled:n,autoComplete:"off"}),g?r.a.createElement(E.a,{ref:m,onChange:p,domain:_,value:u,placeholder:c?N(c):Object(h.a)("e.g. my-space"),label:Object(h.a)("Address"),disabled:n,onKeyDown:C}):null,r.a.createElement(y.a,{name:"spaceTopic",element:"textarea",label:Object(h.a)("Description"),value:null!=b?b:"",onChange:e=>S(e.target.value),rows:3,disabled:n}),w)};t.d=e=>{let{onFinished:t}=e;const[n,i]=Object(o.useState)(null),[s,a]=Object(o.useState)(!1),[c,l]=Object(o.useState)(""),g=Object(o.useRef)(),[v,f]=Object(o.useState)(""),y=Object(o.useRef)(),[S,E]=Object(o.useState)(void 0),[w,_]=Object(o.useState)(""),C=async e=>{if(e.preventDefault(),!s){if(a(!0),g.current&&!await g.current.validate({allowEmpty:!1}))return g.current.focus(),g.current.validate({allowEmpty:!1,focused:!0}),void a(!1);if(y.current&&n===d.f.Public&&!await y.current.validate({allowEmpty:!1}))return y.current.focus(),y.current.validate({allowEmpty:!1,focused:!0}),void a(!1);try{await j(c,n===d.f.Public,v,w,S),t()}catch(e){u.a.error(e)}}};let O;return O=null===n?r.a.createElement(r.a.Fragment,null,r.a.createElement("h2",null,Object(h.a)("Create a space")),r.a.createElement("p",null,Object(h.a)("Spaces are a new way to group rooms and people. What kind of Space do you want to create? You can change this later.")),r.a.createElement(P,{title:Object(h.a)("Public"),description:Object(h.a)("Open space for anyone, best for communities"),className:"mx_SpaceCreateMenuType_public",onClick:()=>i(d.f.Public)}),r.a.createElement(P,{title:Object(h.a)("Private"),description:Object(h.a)("Invite only, best for yourself or teams"),className:"mx_SpaceCreateMenuType_private",onClick:()=>i(d.f.Private)}),r.a.createElement("p",null,Object(h.a)("To join a space you'll need an invite.")),r.a.createElement(M,{onClick:t})):r.a.createElement(r.a.Fragment,null,r.a.createElement(m.a,{className:"mx_SpaceCreateMenu_back",onClick:()=>i(null),title:Object(h.a)("Go back")}),r.a.createElement("h2",null,n===d.f.Public?Object(h.a)("Your public space"):Object(h.a)("Your private space")),r.a.createElement("p",null,Object(h.a)("Add some details to help people recognise it.")," ",Object(h.a)("You can change these anytime.")),r.a.createElement(A,{busy:s,onSubmit:C,setAvatar:E,name:c,setName:l,nameFieldRef:g,topic:w,setTopic:_,alias:v,setAlias:f,showAliasField:n===d.f.Public,aliasFieldRef:y}),r.a.createElement(b.a,{kind:"primary",onClick:C,disabled:s},s?Object(h.a)("Creating…"):Object(h.a)("Create"))),r.a.createElement(p.n,{left:72,top:62,chevronOffset:0,chevronFace:p.a.None,onFinished:t,wrapperClassName:"mx_SpaceCreateMenu_wrapper",managed:!1,focusLock:!0},O)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(120),s=n(503),o=n(631),r=n(630),a=n(142);const c=e=>{const t=Object(i.useMemo)((()=>s.a.forRoom(e)),[e]),[n,c]=Object(i.useState)(t.notificationVolume);Object(a.a)(t,o.b,(e=>{e===r.a.NotificationVolume&&c(t.notificationVolume)}));return[n,Object(i.useCallback)((e=>t.notificationVolume=e),[t])]}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(122),s=n.n(i),o=n(130),r=n(137),a=n(631),c=n(269),l=n(121);let d;!function(e){e[e.NotificationVolume=0]="NotificationVolume"}(d||(d={}));class u extends a.a{constructor(e){super(e,(e=>this.properties.get(e))),s()(this,"properties",new Map),s()(this,"onAccountData",(e=>{if(e.getType()===o.b.PushRules){this.properties.get(d.NotificationVolume)!==Object(c.c)(this.matrixClient,this.context.room.roomId)&&this.updateNotificationVolume()}}))}onClientChanged(e,t){this.properties.clear(),null==e||e.removeListener(r.ClientEvent.AccountData,this.onAccountData),t&&(t.on(r.ClientEvent.AccountData,this.onAccountData),this.updateNotificationVolume())}updateNotificationVolume(){const e=this.matrixClient?Object(c.c)(this.matrixClient,this.context.room.roomId):null;e?this.properties.set(d.NotificationVolume,e):this.properties.delete(d.NotificationVolume),this.markEchoReceived(d.NotificationVolume),this.emit(a.b,d.NotificationVolume)}get notificationVolume(){return this.getValue(d.NotificationVolume)}set notificationVolume(e){this.setValue(Object(l.a)("Change notification settings"),d.NotificationVolume,e,(async()=>Object(c.d)(this.context.room.roomId,e)),a.c)}}},function(e,t,n){"use strict";n.d(t,"c",(function(){return a})),n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i),o=n(17),r=n(632);async function a(){}const c="property_updated";class l extends o.EventEmitter{constructor(e,t){super(),this.context=e,this.lookupFn=t,s()(this,"cache",new Map),s()(this,"matrixClient",void 0)}setClient(e){const t=this.matrixClient;this.matrixClient=e,this.onClientChanged(t,e)}getValue(e){return this.cache.has(e)?this.cache.get(e).val:this.lookupFn(e)}cacheVal(e,t,n){this.cache.set(e,{txn:n,val:t}),this.emit(c,e)}decacheKey(e){this.cache.has(e)&&(this.context.disownTransaction(this.cache.get(e).txn),this.cache.delete(e),this.emit(c,e))}markEchoReceived(e){if(this.cache.has(e)){const t=this.cache.get(e).txn;this.context.disownTransaction(t),t.cancel()}this.decacheKey(e)}setValue(e,t,n,i,s){this.cache.has(t)&&this.cache.get(t).txn.cancel();const o=this.context.beginTransaction(e,i);this.cacheVal(t,n,o),o.when(r.b.Pending,(()=>this.cacheVal(t,n,o))).when(r.b.Error,(()=>s())),o.run()}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(870);let r;!function(e){e[e.Pending=0]="Pending",e[e.Success=1]="Success",e[e.Error=2]="Error"}(r||(r={}));class a extends o.a{constructor(e,t){super(),this.auditName=e,this.runFn=t,s()(this,"_status",r.Pending),s()(this,"didFail",!1),s()(this,"startTime",new Date)}get didPreviouslyFail(){return this.didFail}get status(){return this._status}run(){if(this.status===r.Success)throw new Error("Cannot re-run a successful echo transaction");this.setStatus(r.Pending),this.runFn().then((()=>this.setStatus(r.Success))).catch((()=>this.setStatus(r.Error)))}cancel(){this.setStatus(r.Success)}setStatus(e){this._status=e,e===r.Error?this.didFail=!0:e===r.Success&&(this.didFail=!1),this.notifyCondition(e)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(219);const s=e=>(t,n)=>{t!==i.b.Error&&n!==t&&e()}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(406),c=n(293);class l extends r.a.PureComponent{constructor(e){super(e),s()(this,"animationFrameFn",new a.a((()=>this.doUpdate()),(()=>requestAnimationFrame((()=>this.animationFrameFn.trigger()))))),s()(this,"onChange",(e=>{this.props.playback.skipTo(Number(e.target.value)*this.props.playback.durationSeconds)})),s()(this,"onMouseDown",(e=>{e.stopPropagation()})),this.state={percentage:Object(c.c)(this.props.playback.timeSeconds,0,this.props.playback.durationSeconds)},this.props.playback.liveData.onUpdate((()=>this.animationFrameFn.mark()))}doUpdate(){this.setState({percentage:Object(c.c)(this.props.playback.timeSeconds,0,this.props.playback.durationSeconds)})}left(){this.props.playback.skipTo(this.props.playback.timeSeconds-5)}right(){this.props.playback.skipTo(this.props.playback.timeSeconds+5)}render(){return r.a.createElement("input",{type:"range",className:"mx_SeekBar",tabIndex:this.props.tabIndex,onChange:this.onChange,onMouseDown:this.onMouseDown,min:0,max:1,value:this.state.percentage,step:.001,style:{"--fillTo":this.state.percentage},disabled:this.props.disabled})}}s()(l,"defaultProps",{tabIndex:0,disabled:!1})},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return c}));var i=n(122),s=n.n(i),o=n(159),r=n(195);let a;!function(e){e.CurrentChanged="current_changed"}(a||(a={}));class c extends o.b{constructor(e){super(),this.recordings=e,s()(this,"current",null),s()(this,"playbacks",new Map),s()(this,"onPlaybackStateChanged",((e,t)=>{switch(e){case r.m.Buffering:case r.m.Playing:this.pauseExcept(t),this.setCurrent(t);break;case r.m.Stopped:this.clearCurrent()}}))}setCurrent(e){this.current!==e&&(this.current=e,this.addPlayback(e),this.emit(a.CurrentChanged,e))}clearCurrent(){null!==this.current&&(this.current=null,this.emit(a.CurrentChanged,null))}getCurrent(){return this.current}getByInfoEvent(e,t){const n=e.getId();return this.playbacks.has(n)||this.addPlayback(new r.i(e,t,this.recordings)),this.playbacks.get(n)}addPlayback(e){const t=e.infoEvent.getId();this.playbacks.has(t)||(this.playbacks.set(t,e),e.on(r.l.StateChanged,this.onPlaybackStateChanged))}pauseExcept(e){for(const t of this.playbacks.values())t!==e&&t.pause()}destroy(){this.removeAllListeners();for(const e of this.playbacks.values())e.off(r.l.StateChanged,this.onPlaybackStateChanged);this.playbacks=new Map}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(195);const s=e=>{var t,n,s;return(null===(t=e.getType)||void 0===t?void 0:t.call(e))===i.g&&((null===(n=e.getContent)||void 0===n||null===(s=n.call(e))||void 0===s?void 0:s.state)===i.h.Started||e.isRedacted())}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(121),s=n(123),o=n(480);const r=e=>{var t;const n=null===(t=s.a.get())||void 0===t?void 0:t.getUserId();return n&&n===e.getSender()?Object(i.a)("You ended a voice broadcast",{}):Object(i.a)("%(senderName)s ended a voice broadcast",{senderName:Object(o.a)(e)})}},function(e,t,n){"use strict";n.d(t,"c",(function(){return l})),n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(121),c=n(283);let l;!function(e){e[e.Video=0]="Video"}(l||(l={}));const d=e=>{let{type:t,text:n,active:i,participantCount:o}=e;return s.a.createElement("span",{className:"mx_LiveContentSummary"},s.a.createElement("span",{className:r()("mx_LiveContentSummary_text",{mx_LiveContentSummary_text_video:t===l.Video,mx_LiveContentSummary_text_active:i})},n),o>0&&s.a.createElement(s.a.Fragment,null," • ",s.a.createElement("span",{className:"mx_LiveContentSummary_participants","aria-label":Object(a.a)("%(count)s participants",{count:o})},o)))},u=e=>{let{call:t}=e;return s.a.createElement(d,{type:l.Video,text:Object(a.a)("Video"),active:!1,participantCount:Object(c.f)(t)})}},,function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return l}));var i,s,o,r,a=n(120);function c(){return c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},c.apply(this,arguments)}function l(e){return a.createElement("svg",c({xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",viewBox:"0 0 24 23",role:"presentation","aria-hidden":!0},e),i||(i=a.createElement("defs",null,a.createElement("path",{id:"warning_svg__a",d:"M9.2 2.2c1.6-2.9 4.1-2.9 5.7 0l8.3 15.4c1.6 2.9.2 5.3-3.2 5.3H4c-3.3 0-4.7-2.4-3.2-5.3L9.2 2.2zm0 0"}))),s||(s=a.createElement("clipPath",{id:"warning_svg__b"},a.createElement("use",{xlinkHref:"#warning_svg__a",overflow:"visible"}))),o||(o=a.createElement("path",{clipPath:"url(#warning_svg__b)",fill:"#ff0064",d:"M-4.8-5h33.6v32.9H-4.8z"})),r||(r=a.createElement("g",null,a.createElement("defs",null,a.createElement("path",{id:"warning_svg__c",d:"M12.7 15l.3-9.6h-2l.3 9.6h1.4zm-.7 4.1c.7 0 1.2-.5 1.2-1.2s-.5-1.2-1.2-1.2-1.2.5-1.2 1.2.5 1.2 1.2 1.2zm0 0"})),a.createElement("clipPath",{id:"warning_svg__d"},a.createElement("use",{xlinkHref:"#warning_svg__c",overflow:"visible"})),a.createElement("path",{clipPath:"url(#warning_svg__d)",fill:"#fff",d:"M5.8.4h12.4v23.7H5.8z"}))))}t.default="img/warning.30e1625.svg"},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i,s=n(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M3 9.5a.5.5 0 01.5-.5h3a.5.5 0 01.5.5V22H3V9.5zM17 13.5a.5.5 0 01.5-.5h3a.5.5 0 01.5.5V22h-4v-8.5zM10 2.5a.5.5 0 01.5-.5h3a.5.5 0 01.5.5V22h-4V2.5z",fill:"currentColor"})))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i,s=n(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M12 2C8.13 2 5 5.215 5 9.19c0 4.284 4.42 10.19 6.24 12.44a.976.976 0 001.53 0C14.58 19.38 19 13.474 19 9.19 19 5.216 15.87 2 12 2zm0 9.759c-1.38 0-2.5-1.15-2.5-2.568 0-1.418 1.12-2.569 2.5-2.569s2.5 1.151 2.5 2.569c0 1.417-1.12 2.568-2.5 2.568z",fill:"currentColor"})))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i,s=n(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 26 14",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M3.654 13.153a.87.87 0 00.063-1.173c-2.41-2.93-2.41-7.185-.007-10.121A.885.885 0 003.654.673a.89.89 0 00-1.318.063c-2.93 3.582-2.93 8.765 0 12.354a.885.885 0 001.318.063zm2.529-2.529a.885.885 0 00.081-1.148 4.432 4.432 0 010-5.12.893.893 0 00-.081-1.148l-.007-.006c-.376-.377-1.016-.352-1.324.081a6.218 6.218 0 000 7.266c.314.433.948.458 1.33.075zm7.132-9.585c-2.429 0-4.392 2.018-4.392 4.512 0 2.688 2.773 6.394 3.915 7.805.25.31.709.31.96 0 1.136-1.411 3.909-5.117 3.909-7.805 0-2.494-1.964-4.512-4.392-4.512zm0 6.123c-.866 0-1.569-.722-1.569-1.611 0-.89.703-1.611 1.569-1.611s1.568.721 1.568 1.61c0 .89-.702 1.612-1.568 1.612zm8.994 4.818a.87.87 0 00.063 1.173.885.885 0 001.318-.063c2.93-3.589 2.93-8.772 0-12.354a.89.89 0 00-1.318-.063.885.885 0 00-.056 1.186c2.403 2.936 2.403 7.19-.007 10.12zm-2.547-2.504a.885.885 0 00.081 1.148c.383.383 1.017.358 1.33-.075a6.217 6.217 0 000-7.266c-.307-.433-.947-.458-1.323-.081l-.007.006a.893.893 0 00-.081 1.148 4.432 4.432 0 010 5.12z",fill:"currentColor"})))}},function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return r}));var i=n(120);const s=(e,t)=>{const n=Object(i.useRef)();Object(i.useEffect)((()=>{n.current=e}),[e]),Object(i.useEffect)((()=>{const e=window.setTimeout((()=>{var e;null===(e=n.current)||void 0===e||e.call(n)}),t);return()=>clearTimeout(e)}),[t])},o=(e,t)=>{const n=Object(i.useRef)();Object(i.useEffect)((()=>{n.current=e}),[e]),Object(i.useEffect)((()=>{const e=window.setInterval((()=>{var e;null===(e=n.current)||void 0===e||e.call(n)}),t);return()=>clearInterval(e)}),[t])},r=(e,t,n)=>{const[s,r]=Object(i.useState)(n);return o((()=>r((e=>e-1))),t),0===s&&e(),s}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i=e=>t=>{null==t||t.stopPropagation(),null==t||t.preventDefault(),e()}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(404),c=n(121),l=n(233),d=n(124),u=n(176);const h=e=>{let{error:t,isMinimised:n,className:i,onFinished:o,onClick:h}=e;return s.a.createElement("div",{"data-testid":"map-rendering-error",className:r()("mx_MapError",i,{mx_MapError_isMinimised:n}),onClick:h},s.a.createElement(a.Icon,{className:"mx_MapError_icon"}),s.a.createElement(u.a,{className:"mx_MapError_heading",size:"h3"},Object(c.a)("Unable to load map")),s.a.createElement("p",{className:"mx_MapError_message"},Object(l.e)(t)),o&&s.a.createElement(d.a,{element:"button",kind:"primary",onClick:o},Object(c.a)("OK")))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return r}));var i=n(123),s=n(121);function o(e,t){const n=i.a.get().getRoom(t),s=n&&n.getMember(e);return s?s.name:e}function r(e,t){const n=o(e,t);return n!==e?Object(s.a)("%(name)s (%(userId)s)",{name:n,userId:e}):e}},function(e,t,n){"use strict";var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(173),d=n(248),u=n(247);const h=["members","faceSize","overflow","tooltip","children"];t.a=e=>{let{members:t,faceSize:n,overflow:i,tooltip:o,children:a}=e,m=r()(e,h);const p=t.map(o?e=>c.a.createElement(l.b,{key:e.userId,member:e,width:n,height:n,hideTitle:!0}):e=>c.a.createElement(d.a,{key:e.userId,label:e.name},c.a.createElement(l.b,{member:e,width:n,height:n,viewUserOnClick:!m.onClick,hideTitle:!0}))),g=c.a.createElement(c.a.Fragment,null,i?c.a.createElement("span",{className:"mx_FacePile_more"}):null,p);return c.a.createElement("div",s()({},m,{className:"mx_FacePile"}),o?c.a.createElement(u.a,{class:"mx_FacePile_faces",tooltip:o},g):c.a.createElement("div",{className:"mx_FacePile_faces"},g),a)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a}));var i=n(120),s=n.n(i),o=n(166);const r=Object(i.memo)((e=>{let{delta:t}=e;return t<=0?null:s.a.createElement("div",{className:"mx_CallDuration"},Object(o.j)(t))})),a=e=>{let{groupCall:t}=e;const[n,o]=Object(i.useState)((()=>Date.now()));return Object(i.useEffect)((()=>{const e=window.setInterval((()=>o(Date.now())),1e3);return()=>clearInterval(e)}),[]),null===t.creationTs?null:s.a.createElement(r,{delta:n-t.creationTs})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(122),s=n.n(i),o=n(120),r=n(124),a=n(121);const c=["1","2","3","4","5","6","7","8","9","*","0","#"],l=["","ABC","DEF","GHI","JKL","MNO","PQRS","TUV","WXYZ","","+",""];var d;!function(e){e[e.Digit=0]="Digit",e[e.Dial=1]="Dial"}(d||(d={}));class u extends o.PureComponent{constructor(){super(...arguments),s()(this,"onClick",(e=>{this.props.onButtonPress(this.props.digit,e)}))}render(){switch(this.props.kind){case d.Digit:return o.createElement(r.a,{className:"mx_DialPad_button",onClick:this.onClick},this.props.digit,o.createElement("div",{className:"mx_DialPad_buttonSubText"},this.props.digitSubtext));case d.Dial:return o.createElement(r.a,{className:"mx_DialPad_button mx_DialPad_dialButton",onClick:this.onClick,"aria-label":Object(a.a)("Dial")})}}}class h extends o.PureComponent{render(){const e=[];for(let t=0;t<c.length;t++){const n=c[t],i=l[t];e.push(o.createElement(u,{key:n,kind:d.Digit,digit:n,digitSubtext:i,onButtonPress:this.props.onDigitPress}))}return this.props.hasDial&&e.push(o.createElement(u,{key:"dial",kind:d.Dial,onButtonPress:this.props.onDialPress})),o.createElement("div",{className:"mx_DialPad"},e)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(545),c=n(121),l=n(140),d=n(143),u=n(153),h=n(187);const m="SELECT_VALUE_CUSTOM";class p extends r.a.Component{constructor(e){super(e),s()(this,"onSelectChange",(e=>{if(e.target.value===m)this.setState({custom:!0});else{const t=parseInt(e.target.value);this.props.onChange(t,this.props.powerLevelKey),this.setState({selectValue:t})}})),s()(this,"onCustomChange",(e=>{this.setState({customValue:parseInt(e.target.value)})})),s()(this,"onCustomBlur",(e=>{e.preventDefault(),e.stopPropagation(),Number.isFinite(this.state.customValue)?this.props.onChange(this.state.customValue,this.props.powerLevelKey):this.initStateFromProps()})),s()(this,"onCustomKeyDown",(e=>{if(Object(u.a)().getAccessibilityAction(e)===d.h.Enter)e.preventDefault(),e.stopPropagation(),e.target.blur()})),this.state={levelRoleMap:{},options:[],customValue:this.props.value,selectValue:0}}componentDidMount(){this.initStateFromProps()}componentDidUpdate(e){Object(h.c)(this.props,e)&&this.initStateFromProps()}initStateFromProps(){const e=a.a(this.props.usersDefault),t=Object.keys(e).filter((e=>void 0===e||parseInt(e)<=this.props.maxValue||parseInt(e)==this.props.value)).map((e=>parseInt(e))),n=void 0===e[this.props.value];this.setState({levelRoleMap:e,options:t,custom:n,customValue:this.props.value,selectValue:n?m:this.props.value})}render(){let e;const t=void 0===this.props.label?Object(c.a)("Power level"):this.props.label;if(this.state.custom)e=r.a.createElement(l.a,{type:"number",label:t,max:this.props.maxValue,onBlur:this.onCustomBlur,onKeyDown:this.onCustomKeyDown,onChange:this.onCustomChange,value:String(this.state.customValue),disabled:this.props.disabled});else{const n=this.state.options.map((e=>({value:String(e),text:a.b(e,this.props.usersDefault)})));n.push({value:m,text:Object(c.a)("Custom level")});const i=n.map((e=>r.a.createElement("option",{value:e.value,key:e.value,"data-testid":`power-level-option-${e.value}`},e.text)));e=r.a.createElement(l.a,{element:"select",label:t,onChange:this.onSelectChange,value:String(this.state.selectValue),disabled:this.props.disabled,"data-testid":"power-level-select-element"},i)}return r.a.createElement("div",{className:"mx_PowerSelector"},e)}}s()(p,"defaultProps",{maxValue:1/0,usersDefault:0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(176);const d=["heading","children"],u=e=>{let{heading:t,children:n}=e,i=r()(e,d);return c.a.createElement("div",s()({},i,{className:"mx_SettingsSubsectionHeading"}),c.a.createElement(l.a,{className:"mx_SettingsSubsectionHeading_heading",size:"h3"},t),n)}},function(e,t,n){"use strict";n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return m}));var i=n(121),s=n(279),o=n(232),r=n(194),a=n(123),c=n(398);const l=()=>{s.default.setEnabled(!0);const e=a.a.get(),t=Object(c.d)(e.deviceId);e.setAccountData(t,{is_silenced:!1})},d=()=>{s.default.setPromptHidden(!0)},u="desktopnotifications",h=e=>{r.a.sharedInstance().addOrReplaceToast({key:u,title:e?Object(i.a)("Don't miss a reply"):Object(i.a)("Notifications"),props:{description:Object(i.a)("Enable desktop notifications"),acceptLabel:Object(i.a)("Enable"),onAccept:l,rejectLabel:Object(i.a)("Dismiss"),onReject:d},component:o.a,priority:30})},m=()=>{r.a.sharedInstance().dismissToast(u)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(125),r=n(337);class a{constructor(e,t){this.window=e,this.document=t,s()(this,"activeNowTimeout",void 0),s()(this,"activeRecentlyTimeout",void 0),s()(this,"attachedActiveNowTimers",[]),s()(this,"attachedActiveRecentlyTimers",[]),s()(this,"lastScreenX",0),s()(this,"lastScreenY",0),s()(this,"onPageVisibilityChanged",(e=>{"hidden"===this.document.visibilityState?(this.activeNowTimeout.abort(),this.activeRecentlyTimeout.abort()):this.onUserActivity(e)})),s()(this,"onWindowBlurred",(()=>{this.activeNowTimeout.abort(),this.activeRecentlyTimeout.abort()})),s()(this,"onUserActivity",(e=>{if(this.document.hasFocus()){if("mousemove"===e.type&&this.isMouseEvent(e)){if(e.screenX===this.lastScreenX&&e.screenY===this.lastScreenY)return;this.lastScreenX=e.screenX,this.lastScreenY=e.screenY}o.a.dispatch({action:"user_activity"}),this.activeNowTimeout.isRunning()?this.activeNowTimeout.restart():(this.activeNowTimeout.start(),o.a.dispatch({action:"user_activity_start"}),a.runTimersUntilTimeout(this.attachedActiveNowTimers,this.activeNowTimeout)),this.activeRecentlyTimeout.isRunning()?this.activeRecentlyTimeout.restart():(this.activeRecentlyTimeout.start(),a.runTimersUntilTimeout(this.attachedActiveRecentlyTimers,this.activeRecentlyTimeout))}})),this.activeNowTimeout=new r.a(700),this.activeRecentlyTimeout=new r.a(12e4)}static sharedInstance(){return void 0===window.mxUserActivity&&(window.mxUserActivity=new a(window,document)),window.mxUserActivity}timeWhileActiveNow(e){this.timeWhile(e,this.attachedActiveNowTimers),this.userActiveNow()&&e.start()}timeWhileActiveRecently(e){this.timeWhile(e,this.attachedActiveRecentlyTimers),this.userActiveRecently()&&e.start()}timeWhile(e,t){-1===t.indexOf(e)&&(t.push(e),e.finished().finally((()=>{const n=t.indexOf(e);-1!==n&&t.splice(n,1)})).catch((e=>{})))}start(){this.document.addEventListener("mousedown",this.onUserActivity),this.document.addEventListener("mousemove",this.onUserActivity),this.document.addEventListener("keydown",this.onUserActivity),this.document.addEventListener("visibilitychange",this.onPageVisibilityChanged),this.window.addEventListener("blur",this.onWindowBlurred),this.window.addEventListener("focus",this.onUserActivity),this.window.addEventListener("wheel",this.onUserActivity,{passive:!0,capture:!0})}stop(){this.document.removeEventListener("mousedown",this.onUserActivity),this.document.removeEventListener("mousemove",this.onUserActivity),this.document.removeEventListener("keydown",this.onUserActivity),this.window.removeEventListener("wheel",this.onUserActivity,{capture:!0}),this.document.removeEventListener("visibilitychange",this.onPageVisibilityChanged),this.window.removeEventListener("blur",this.onWindowBlurred),this.window.removeEventListener("focus",this.onUserActivity)}userActiveNow(){return this.activeNowTimeout.isRunning()}userActiveRecently(){return this.activeRecentlyTimeout.isRunning()}static async runTimersUntilTimeout(e,t){e.forEach((e=>e.start()));try{await t.finished()}catch(e){}e.forEach((e=>e.abort()))}isMouseEvent(e){return e.type.startsWith("mouse")}}},,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return T}));var i=n(122),s=n.n(i),o=n(16),r=n(189),a=n(203),c=n(125),l=n(130),d=n(121),u=n(123),h=n(192);function m(e){const t=u.a.get().getUserId();return"m.room.member"===e.getType()?e.getStateKey()===t:e.getSender()===t}function p(e,t){if(t!==h.a.DM)return!0;const n=u.a.get().getRoom(e);return!n||2!==n.currentState.getJoinedMemberCount()}function g(e){return e.sender?e.sender.name:e.getSender()}var v=n(199),f=n(229),b=n(264);var y=n(385),S=n(796),E=n(133);class w{constructor(){s()(this,"context",void 0)}getTextFor(e,t,n){let i=e.getContent();if(e.isRelation("m.replace")&&(i=e.getContent()["m.new_content"]),!i)return null;try{let s=new S.a({type:e.getType(),content:i}).question.text.trim();return s=Object(d.k)(s),n||m(e)||!p(e.getRoomId(),t)?s:Object(d.a)("%(senderName)s: %(message)s",{senderName:g(e),message:s})}catch(e){if(e instanceof y.a)return null;throw e}}}s()(w,"contextType",E.a);var _=n(126),C=n(164);var O=n(154),I=n(195),R=n(637);const k={"m.room.message":{isState:!1,previewer:new class{getTextFor(e,t,n){var i,s,o;let r=e.getContent();if(r[b.a])return null;if(e.isRelation(l.h.Replace)&&(r=e.getContent()["m.new_content"]),null===(i=r)||void 0===i||!i.body)return null;let a=r.body.trim();if(!a)return null;const c=null!==(s=r.msgtype)&&void 0!==s?s:l.e.Text,u="org.matrix.custom.html"===r.format&&r.formatted_body;if(u&&(a=r.formatted_body),null!==(o=e.getWireContent()["m.relates_to"])&&void 0!==o&&o["m.in_reply_to"]&&(a=u?(Object(f.d)(a)||"").trim():(Object(f.e)(a)||"").trim(),!a))return null;if(u){const e=Object(v.e)(a.replace(/<br\/?>/gi,"\n"));a=(new DOMParser).parseFromString(e,"text/html").documentElement.textContent}return a=Object(d.k)(a),c===l.e.Emote?Object(d.a)("* %(senderName)s %(emote)s",{senderName:g(e),emote:a}):n||m(e)||!p(e.getRoomId(),t)?a:Object(d.a)("%(senderName)s: %(message)s",{senderName:g(e),message:"⁨"+a})}}},"m.call.invite":{isState:!1,previewer:new class{getTextFor(e,t){return p(e.getRoomId(),t)?m(e)?Object(d.a)("You started a call"):Object(d.a)("%(senderName)s started a call",{senderName:g(e)}):m(e)?Object(d.a)("Waiting for answer"):Object(d.a)("%(senderName)s is calling",{senderName:g(e)})}}},"m.call.answer":{isState:!1,previewer:new class{getTextFor(e,t){return p(e.getRoomId(),t)?m(e)?Object(d.a)("You joined the call"):Object(d.a)("%(senderName)s joined the call",{senderName:g(e)}):Object(d.a)("Call in progress")}}},"m.call.hangup":{isState:!1,previewer:new class{getTextFor(e,t){return p(e.getRoomId(),t)?m(e)?Object(d.a)("You ended the call"):Object(d.a)("%(senderName)s ended the call",{senderName:g(e)}):Object(d.a)("Call ended")}}},"m.sticker":{isState:!1,previewer:new class{getTextFor(e,t,n){const i=e.getContent().body;return i?n||m(e)||!p(e.getRoomId(),t)?i:Object(d.a)("%(senderName)s: %(stickerName)s",{senderName:g(e),stickerName:i}):null}}},"m.reaction":{isState:!1,previewer:new class{getTextFor(e,t,n){const i=_.b.getValue("feature_roomlist_preview_reactions_dms"),s=_.b.getValue("feature_roomlist_preview_reactions_all"),o=e.getRoomId();if(!o)return null;if(!(s||i&&C.a.shared().getUserIdForRoomId(o)))return null;const r=e.getRelation();if(!r)return null;const a=r.key;return a?n||m(e)||!p(o,t)?a:Object(d.a)("%(senderName)s: %(reaction)s",{senderName:g(e),reaction:a}):null}}},[r.e.name]:{isState:!1,previewer:new w},[r.e.altName]:{isState:!1,previewer:new w},[I.g]:{isState:!0,previewer:new class{getTextFor(e,t,n){var i;return e.isRedacted()||(null===(i=e.getContent())||void 0===i?void 0:i.state)!==b.c.Stopped?null:Object(R.a)(e)}}}},x="im.vector.any";class T extends a.a{constructor(){super(c.a,{}),s()(this,"previews",new Map)}static get instance(){return T.internalInstance}static getPreviewChangedEventName(e){return`room_preview_changed:${null==e?void 0:e.roomId}`}async getPreviewForRoom(e,t){var n;if(!e)return null;this.previews.has(e.roomId)||await this.generatePreview(e,t);const i=this.previews.get(e.roomId);return i?i.has(t)?null!==(n=i.get(t))&&void 0!==n?n:null:i.get(x):null}generatePreviewForEvent(e){var t;const n=k[e.getType()];return null!==(t=null==n?void 0:n.previewer.getTextFor(e,void 0,!0))&&void 0!==t?t:""}async generatePreview(e,t){const n=e.timeline;if(!n)return;let i=this.previews.get(e.roomId);i||(i=new Map,this.previews.set(e.roomId,i)),i.has(x)||i.set(x,null),t&&!i.has(t)&&i.set(t,null);let s=!1;for(let t=n.length-1;t>=0&&t!==n.length-50;t--){const r=n[t];await this.matrixClient.decryptEventIfNeeded(r);const a=k[r.getType()];if(!a)continue;if(a.isState&&Object(o.u)(r.getStateKey()))continue;const c=a.previewer.getTextFor(r);if(!c)continue;s=s||c!==i.get(x),i.set(x,c);const l=Array.from(i.keys()).filter((e=>e!==x));for(const e of l){const t=e===x?void 0:e,n=a.previewer.getTextFor(r,t);n===c?(s=s||c!==i.get(e),i.delete(e)):(s=s||n!==i.get(e),i.set(e,n))}return void(s&&(this.previews.set(e.roomId,i),this.emit(O.b,this),this.emit(T.getPreviewChangedEventName(e),e)))}this.previews.set(e.roomId,new Map),this.emit(O.b,this),this.emit(T.getPreviewChangedEventName(e),e)}async onAction(e){if(this.matrixClient&&("MatrixActions.Room.timeline"===e.action||"MatrixActions.Event.decrypted"===e.action)){const t=e.event,n=e.hasOwnProperty("isLiveEvent")&&!e.isLiveEvent;if(!this.previews.has(t.getRoomId())||n)return;await this.generatePreview(this.matrixClient.getRoom(t.getRoomId()),x)}}}s()(T,"internalInstance",(()=>{const e=new T;return e.start(),e})())},,function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(121),r=n(133),a=n(136),c=n(462),l=n(130),d=n(238);var u=e=>{let{onBack:t}=e;const n=Object(i.useContext)(d.a),r=Object(i.useMemo)((()=>{const e={};return n.room.currentState.getStateEvents(l.b.RoomMember).forEach((t=>{var n;if("join"!==t.getContent().membership)return;const i=t.getSender().split(":")[1];e[i]=(null!==(n=e[i])&&void 0!==n?n:0)+1})),e}),[n.room]);return s.a.createElement(d.b,{onBack:t},s.a.createElement("table",null,s.a.createElement("thead",null,s.a.createElement("tr",null,s.a.createElement("th",null,Object(o.a)("Server")),s.a.createElement("th",null,Object(o.a)("Number of users")))),s.a.createElement("tbody",null,Object.entries(r).map((e=>{let[t,n]=e;return s.a.createElement("tr",{key:t},s.a.createElement("td",null,t),s.a.createElement("td",null,n))})))))},h=n(243),m=n(175),p=n(142);const g={[h.g.Unsent]:Object(o.c)("Unsent"),[h.g.Requested]:Object(o.c)("Requested"),[h.g.Ready]:Object(o.c)("Ready"),[h.g.Done]:Object(o.c)("Done"),[h.g.Started]:Object(o.c)("Started"),[h.g.Cancelled]:Object(o.c)("Cancelled")},v=e=>{let{txnId:t,request:n}=e;const[,r]=Object(i.useState)(),[a,c]=Object(i.useState)(n.timeout);return Object(p.c)(n,h.l.Change,r),Object(i.useEffect)((()=>{if(0==n.timeout)return;const e=window.setInterval((()=>{c(n.timeout)}),500);return()=>{clearInterval(e)}}),[n]),s.a.createElement("div",{className:"mx_DevTools_VerificationRequest"},s.a.createElement("dl",null,s.a.createElement("dt",null,Object(o.a)("Transaction")),s.a.createElement("dd",null,t),s.a.createElement("dt",null,Object(o.a)("Phase")),s.a.createElement("dd",null,g[n.phase]?Object(o.a)(g[n.phase]):n.phase),s.a.createElement("dt",null,Object(o.a)("Timeout")),s.a.createElement("dd",null,Math.floor(a/1e3)),s.a.createElement("dt",null,Object(o.a)("Methods")),s.a.createElement("dd",null,n.methods&&n.methods.join(", ")),s.a.createElement("dt",null,Object(o.a)("Requester")),s.a.createElement("dd",null,n.requestingUserId),s.a.createElement("dt",null,Object(o.a)("Observe only")),s.a.createElement("dd",null,JSON.stringify(n.observeOnly))))};var f=e=>{let{onBack:t}=e;const n=Object(i.useContext)(r.a),a=Object(i.useContext)(d.a),c=Object(p.d)(n,m.b.VerificationRequest,(()=>{var e,t;return null!==(e=null===(t=n.crypto.inRoomVerificationRequests.requestsByRoomId)||void 0===t?void 0:t.get(a.room.roomId))&&void 0!==e?e:new Map}));return s.a.createElement(d.b,{onBack:t},Array.from(c.entries()).reverse().map((e=>{let[t,n]=e;return s.a.createElement(v,{txnId:t,request:n,key:t})})),c.size<1&&Object(o.a)("No verification requests found"))},b=n(1),y=n(124),S=n(126),E=n(318),w=n(140);var _=e=>{let{onBack:t}=e;const[n,o]=Object(i.useState)(null),[r,a]=Object(i.useState)(!1);if(n&&r){const e=()=>{a(!1)};return s.a.createElement(I,{setting:n,onBack:e})}if(n){const e=()=>{o(null)},t=async()=>{a(!0)};return s.a.createElement(R,{setting:n,onBack:e,onEdit:t})}{const e=e=>{o(e)},n=e=>{o(e),a(!0)};return s.a.createElement(x,{onBack:t,onView:e,onEdit:n})}};const C=e=>{let{setting:t,roomId:n,level:i}=e;const o=S.b.canSetValue(t,n,i),r=o?"mx_DevTools_SettingsExplorer_mutable":"mx_DevTools_SettingsExplorer_immutable";return s.a.createElement("td",{className:r},s.a.createElement("code",null,o.toString()))};function O(e,t){const n={};for(const i of S.a)try{n[i]=S.b.getValueAt(i,e,t,!0,!0),void 0===n[i]&&(n[i]=null)}catch(e){b.a.warn(e)}return JSON.stringify(n,null,4)}const I=e=>{let{setting:t,onBack:n}=e;const r=Object(i.useContext)(d.a),[a,c]=Object(i.useState)(O(t,null)),[l,u]=Object(i.useState)(O(t,r.room.roomId));return s.a.createElement(d.b,{onBack:n,actionLabel:Object(o.a)("Save setting values"),onAction:async()=>{try{const e=JSON.parse(a),i=JSON.parse(l);for(const n of Object.keys(e)){b.a.log(`[Devtools] Setting value of ${t} at ${n} from user input`);try{const i=e[n];await S.b.setValue(t,null,n,i)}catch(e){b.a.warn(e)}}const s=r.room.roomId;for(const n of Object.keys(e)){b.a.log(`[Devtools] Setting value of ${t} at ${n} in ${s} from user input`);try{const e=i[n];await S.b.setValue(t,s,n,e)}catch(e){b.a.warn(e)}}n()}catch(e){return Object(o.a)("Failed to save settings.")+` (${e.message})`}}},s.a.createElement("h3",null,Object(o.a)("Setting:")," ",s.a.createElement("code",null,t)),s.a.createElement("div",{className:"mx_DevTools_SettingsExplorer_warning"},s.a.createElement("b",null,Object(o.a)("Caution:"))," ",Object(o.a)("This UI does NOT check the types of the values. Use at your own risk.")),s.a.createElement("div",null,Object(o.a)("Setting definition:"),s.a.createElement("pre",null,s.a.createElement("code",null,JSON.stringify(E.c[t],null,4)))),s.a.createElement("div",null,s.a.createElement("table",null,s.a.createElement("thead",null,s.a.createElement("tr",null,s.a.createElement("th",null,Object(o.a)("Level")),s.a.createElement("th",null,Object(o.a)("Settable at global")),s.a.createElement("th",null,Object(o.a)("Settable at room")))),s.a.createElement("tbody",null,S.a.map((e=>s.a.createElement("tr",{key:e},s.a.createElement("td",null,s.a.createElement("code",null,e)),s.a.createElement(C,{setting:t,level:e}),s.a.createElement(C,{setting:t,roomId:r.room.roomId,level:e}))))))),s.a.createElement("div",null,s.a.createElement(w.a,{id:"valExpl",label:Object(o.a)("Values at explicit levels"),type:"text",className:"mx_DevTools_textarea",element:"textarea",autoComplete:"off",value:a,onChange:e=>c(e.target.value)})),s.a.createElement("div",null,s.a.createElement(w.a,{id:"valExpl",label:Object(o.a)("Values at explicit levels in this room"),type:"text",className:"mx_DevTools_textarea",element:"textarea",autoComplete:"off",value:l,onChange:e=>u(e.target.value)})))},R=e=>{let{setting:t,onEdit:n,onBack:r}=e;const a=Object(i.useContext)(d.a);return s.a.createElement(d.b,{onBack:r,actionLabel:Object(o.a)("Edit values"),onAction:n},s.a.createElement("h3",null,Object(o.a)("Setting:")," ",s.a.createElement("code",null,t)),s.a.createElement("div",null,Object(o.a)("Setting definition:"),s.a.createElement("pre",null,s.a.createElement("code",null,JSON.stringify(E.c[t],null,4)))),s.a.createElement("div",null,Object(o.a)("Value:")," ",s.a.createElement("code",null,k(S.b.getValue(t)))),s.a.createElement("div",null,Object(o.a)("Value in this room:")," ",s.a.createElement("code",null,k(S.b.getValue(t,a.room.roomId)))),s.a.createElement("div",null,Object(o.a)("Values at explicit levels:"),s.a.createElement("pre",null,s.a.createElement("code",null,O(t,null)))),s.a.createElement("div",null,Object(o.a)("Values at explicit levels in this room:"),s.a.createElement("pre",null,s.a.createElement("code",null,O(t,a.room.roomId)))))};function k(e){return["boolean","number"].includes(typeof e)?e.toString():JSON.stringify(e)}const x=e=>{let{onBack:t,onView:n,onEdit:r}=e;const a=Object(i.useContext)(d.a),[c,l]=Object(i.useState)(""),u=Object(i.useMemo)((()=>{let e=Object.keys(E.c);if(c){const t=c.toLowerCase();e=e.filter((e=>e.toLowerCase().includes(t)))}return e}),[c]);return s.a.createElement(d.b,{onBack:t,className:"mx_DevTools_SettingsExplorer"},s.a.createElement(w.a,{label:Object(o.a)("Filter results"),autoFocus:!0,size:64,type:"text",autoComplete:"off",value:c,onChange:e=>l(e.target.value),className:"mx_TextInputDialog_input mx_DevTools_RoomStateExplorer_query"}),s.a.createElement("table",null,s.a.createElement("thead",null,s.a.createElement("tr",null,s.a.createElement("th",null,Object(o.a)("Setting ID")),s.a.createElement("th",null,Object(o.a)("Value")),s.a.createElement("th",null,Object(o.a)("Value in this room")))),s.a.createElement("tbody",null,u.map((e=>s.a.createElement("tr",{key:e},s.a.createElement("td",null,s.a.createElement(y.a,{kind:"link_inline",className:"mx_DevTools_SettingsExplorer_setting",onClick:()=>n(e)},s.a.createElement("code",null,e)),s.a.createElement(y.a,{alt:Object(o.a)("Edit setting"),onClick:()=>r(e),className:"mx_DevTools_SettingsExplorer_edit"},"✏")),s.a.createElement("td",null,s.a.createElement("code",null,k(S.b.getValue(e)))),s.a.createElement("td",null,s.a.createElement("code",null,k(S.b.getValue(e,a.room.roomId))))))))))};var T=n(579),j=n(239),P=n(154),D=n(580);var N=e=>{let{onBack:t}=e;const n=Object(i.useContext)(d.a),[r,a]=Object(i.useState)(""),[c,l]=Object(i.useState)(null),u=Object(p.b)(j.a.instance,P.b,(()=>j.a.instance.getApps(n.room.roomId)));if(c&&u.includes(c)){const e=()=>{l(null)},t=Array.from(Array.from(n.room.currentState.events.values()).map((e=>e.values()))).reduce(((e,t)=>(e.push(...t),e)),[]).find((e=>e.getId()===c.eventId));return t?s.a.createElement(T.b,{mxEvent:t,onBack:e}):s.a.createElement(d.b,{onBack:e},Object(o.a)("There was an error finding this widget."))}return s.a.createElement(d.b,{onBack:t},s.a.createElement(D.a,{query:r,onChange:a},u.map((e=>s.a.createElement("button",{className:"mx_DevTools_button",key:e.url+e.eventId,onClick:()=>l(e)},e.url)))))};const M=e=>{let{mxEvent:t,onBack:n}=e;const o=Object(i.useContext)(r.a),a=Object(i.useMemo)((()=>[Object(c.d)(null==t?void 0:t.getType())]),[t]),l=t?Object(c.f)(t.getContent()):void 0;return s.a.createElement(c.a,{fieldDefs:a,defaultContent:l,onSend:async(e,t)=>{let[n]=e;await o.setAccountData(n,t)},onBack:n})},A=e=>{let{mxEvent:t,onBack:n}=e;const o=Object(i.useContext)(d.a),a=Object(i.useContext)(r.a),l=Object(i.useMemo)((()=>[Object(c.d)(null==t?void 0:t.getType())]),[t]),u=t?Object(c.f)(t.getContent()):void 0;return s.a.createElement(c.a,{fieldDefs:l,defaultContent:u,onSend:async(e,t)=>{let[n]=e;await a.setRoomAccountData(o.room.roomId,n,t)},onBack:n})},L=e=>{let{events:t,Editor:n,actionLabel:o,onBack:r,setTool:a}=e;const[l,u]=Object(i.useState)(""),[h,m]=Object(i.useState)(null);if(h){const e=()=>{m(null)};return s.a.createElement(c.b,{mxEvent:h,onBack:e,Editor:n})}return s.a.createElement(d.b,{onBack:r,actionLabel:o,onAction:async()=>{a(o,n)}},s.a.createElement(D.a,{query:l,onChange:u},Array.from(t.entries()).map((e=>{let[t,n]=e;return s.a.createElement("button",{className:"mx_DevTools_button",key:t,onClick:()=>{m(n)}},t)}))))};var U=n(222),F=n(138),B=n(252),V=n(135),K=n(578),$=n(123);const H=Symbol("failed-to-load");var W,q=e=>{let{onBack:t}=e;const n=Object(i.useContext)(r.a),a=Object(B.a)((()=>n.getCapabilities(!0).catch((()=>H))),[n]),c=Object(B.a)((()=>n.getVersions().catch((()=>H))),[n]),l=Object(B.a)((async()=>{let e=n.getHomeserverUrl();try{const t=$.a.getHomeserverName(),n=await fetch(`https://${t}/.well-known/matrix/server`),i=await n.json();i["m.server"]&&(e=`https://${i["m.server"]}`)}catch(e){console.warn(e)}try{return(await fetch(`${e}/_matrix/federation/v1/version`)).json()}catch(e){console.warn(e)}return H}),[n]);let u;return u=a&&c&&l?s.a.createElement(s.a.Fragment,null,s.a.createElement("h4",null,Object(o.a)("Capabilities")),a!==H?s.a.createElement(K.a,{language:"json",children:JSON.stringify(a,null,4)}):s.a.createElement("div",null,Object(o.a)("Failed to load.")),s.a.createElement("h4",null,Object(o.a)("Client Versions")),c!==H?s.a.createElement(K.a,{language:"json",children:JSON.stringify(c,null,4)}):s.a.createElement("div",null,Object(o.a)("Failed to load.")),s.a.createElement("h4",null,Object(o.a)("Server Versions")),l!==H?s.a.createElement(K.a,{language:"json",children:JSON.stringify(l,null,4)}):s.a.createElement("div",null,Object(o.a)("Failed to load."))):s.a.createElement(V.a,null),s.a.createElement(d.b,{onBack:t},u)},G=n(302),z=n(141),J=n(629),Y=n(269),Q=n(205),X=n(376);!function(e){e[e.Room=0]="Room",e[e.Other=1]="Other"}(W||(W={}));const Z={[W.Room]:Object(o.c)("Room"),[W.Other]:Object(o.c)("Other")},ee={[W.Room]:[[Object(o.c)("Send custom timeline event"),c.c],[Object(o.c)("Explore room state"),T.a],[Object(o.c)("Explore room account data"),e=>{let{onBack:t,setTool:n}=e;const r=Object(i.useContext)(d.a);return s.a.createElement(L,{events:r.room.accountData,Editor:A,actionLabel:Object(o.a)("Send custom room account data event"),onBack:t,setTool:n})}],[Object(o.c)("View servers in room"),u],[Object(o.c)("Notifications debug"),function(e){var t,n;let{onBack:a}=e;const{room:c}=Object(i.useContext)(d.a),l=Object(i.useContext)(r.a),{color:u,count:h}=Object(Y.b)(c),[m]=Object(J.a)(c);return s.a.createElement(d.b,{onBack:a},s.a.createElement("section",null,s.a.createElement("h2",null,Object(o.a)("Room status")),s.a.createElement("ul",null,s.a.createElement("li",null,Object(o.a)("Room unread status: <strong>%(status)s</strong>, count: <strong>%(count)s</strong>",{status:Object(Q.b)(u),count:h},{strong:e=>s.a.createElement("strong",null,e)})),s.a.createElement("li",null,Object(o.a)("Notification state is <strong>%(notificationState)s</strong>",{notificationState:m},{strong:e=>s.a.createElement("strong",null,e)})),s.a.createElement("li",null,Object(o.a)(l.isRoomEncrypted(c.roomId)?Object(o.c)("Room is <strong>encrypted ✅</strong>"):Object(o.c)("Room is <strong>not encrypted 🚨</strong>"),{},{strong:e=>s.a.createElement("strong",null,e)})))),s.a.createElement("section",null,s.a.createElement("h2",null,Object(o.a)("Main timeline")),s.a.createElement("ul",null,s.a.createElement("li",null,Object(o.a)("Total: ")," ",c.getRoomUnreadNotificationCount(z.b.Total)),s.a.createElement("li",null,Object(o.a)("Highlight: ")," ",c.getRoomUnreadNotificationCount(z.b.Highlight)),s.a.createElement("li",null,Object(o.a)("Dot: ")," ",Object(X.b)(c)+""),function(e){const t=e.getRoomUnreadNotificationCount(z.b.Total),n=e.getRoomUnreadNotificationCount(z.b.Highlight),i=Object(X.b)(e);return t>0||n>0||i}(c)&&s.a.createElement(s.a.Fragment,null,s.a.createElement("li",null,Object(o.a)("User read up to: "),s.a.createElement("strong",null,null!==(t=null===(n=c.getReadReceiptForUserId(l.getSafeUserId()))||void 0===n?void 0:n.eventId)&&void 0!==t?t:Object(o.a)("No receipt found"))),s.a.createElement("li",null,Object(o.a)("Last event:"),s.a.createElement("ul",null,s.a.createElement("li",null,Object(o.a)("ID: ")," ",s.a.createElement("strong",null,c.timeline[c.timeline.length-1].getId())),s.a.createElement("li",null,Object(o.a)("Type: ")," ",s.a.createElement("strong",null,c.timeline[c.timeline.length-1].getType())),s.a.createElement("li",null,Object(o.a)("Sender: ")," ",s.a.createElement("strong",null,c.timeline[c.timeline.length-1].getSender()))))))),s.a.createElement("section",null,s.a.createElement("h2",null,Object(o.a)("Threads timeline")),s.a.createElement("ul",null,c.getThreads().filter((e=>function(e){const t=e.room.getThreadUnreadNotificationCount(e.id,z.b.Total),n=e.room.getThreadUnreadNotificationCount(e.id,z.b.Highlight),i=Object(X.b)(e);return t>0||n>0||i}(e))).map((e=>{var t,n,i,r,a;return s.a.createElement("li",{key:e.id},Object(o.a)("Thread Id: ")," ",e.id,s.a.createElement("ul",null,s.a.createElement("li",null,Object(o.a)("Total: "),s.a.createElement("strong",null,c.getThreadUnreadNotificationCount(e.id,z.b.Total))),s.a.createElement("li",null,Object(o.a)("Highlight: "),s.a.createElement("strong",null,c.getThreadUnreadNotificationCount(e.id,z.b.Highlight))),s.a.createElement("li",null,Object(o.a)("Dot: ")," ",s.a.createElement("strong",null,Object(X.b)(e)+"")),s.a.createElement("li",null,Object(o.a)("User read up to: "),s.a.createElement("strong",null,null!==(t=null===(n=e.getReadReceiptForUserId(l.getSafeUserId()))||void 0===n?void 0:n.eventId)&&void 0!==t?t:Object(o.a)("No receipt found"))),s.a.createElement("li",null,Object(o.a)("Last event:"),s.a.createElement("ul",null,s.a.createElement("li",null,Object(o.a)("ID: ")," ",s.a.createElement("strong",null,null===(i=e.lastReply())||void 0===i?void 0:i.getId())),s.a.createElement("li",null,Object(o.a)("Type: ")," ",s.a.createElement("strong",null,null===(r=e.lastReply())||void 0===r?void 0:r.getType())),s.a.createElement("li",null,Object(o.a)("Sender: ")," ",s.a.createElement("strong",null,null===(a=e.lastReply())||void 0===a?void 0:a.getSender()))))))})))))}],[Object(o.c)("Verification explorer"),f],[Object(o.c)("Active Widgets"),N]],[W.Other]:[[Object(o.c)("Explore account data"),e=>{let{onBack:t,setTool:n}=e;const a=Object(i.useContext)(r.a);return s.a.createElement(L,{events:a.store.accountData,Editor:M,actionLabel:Object(o.a)("Send custom account data event"),onBack:t,setTool:n})}],[Object(o.c)("Settings explorer"),_],[Object(o.c)("Server info"),q]]};t.a=e=>{let{roomId:t,onFinished:n}=e;const[c,l]=Object(i.useState)(null);let u,h;if(c){h=()=>{l(null)};const e=c[1];u=s.a.createElement(e,{onBack:h,setTool:(e,t)=>l([e,t])})}else{const e=()=>{n(!1)};u=s.a.createElement(d.b,{onBack:e},Object.entries(ee).map((e=>{let[t,n]=e;return s.a.createElement("div",{key:t},s.a.createElement("h3",null,Object(o.a)(Z[t])),n.map((e=>{let[t,n]=e;return s.a.createElement("button",{className:"mx_DevTools_button",key:t,onClick:()=>{l([t,n])}},Object(o.a)(t))})))})),s.a.createElement("div",null,s.a.createElement("h3",null,Object(o.a)("Options")),s.a.createElement(U.a,{name:"developerMode",level:F.a.ACCOUNT}),s.a.createElement(U.a,{name:"showHiddenEventsInTimeline",level:F.a.DEVICE}),s.a.createElement(U.a,{name:"enableWidgetScreenshots",level:F.a.ACCOUNT}),s.a.createElement(U.a,{name:E.a.VoiceBroadcastForceSmallChunks,level:F.a.DEVICE})))}const m=c?c[0]:Object(o.a)("Toolbox");return s.a.createElement(a.a,{className:"mx_QuestionDialog",onFinished:n,title:Object(o.a)("Developer Tools")},s.a.createElement(r.a.Consumer,null,(e=>s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"mx_DevTools_label_left"},m),s.a.createElement(G.a,{className:"mx_DevTools_label_right",getTextToCopy:()=>t,border:!1},Object(o.a)("Room ID: %(roomId)s",{roomId:t})),s.a.createElement("div",{className:"mx_DevTools_label_bottom"}),e.getRoom(t)&&s.a.createElement(d.a.Provider,{value:{room:e.getRoom(t)}},u)))))}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return te}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(122),c=n.n(a),l=n(120),d=n.n(l),u=n(144),h=n(130),m=n(186),p=n(189),g=n(171),v=n(123),f=n(125),b=n(121),y=n(128),S=n(459),E=n(126),w=n(199),_=n(182),C=n(178),O=n(799),I=n(129),R=n(230),k=n(151),x=n(576),T=n(577),j=n(386),P=n(584),D=n(139),N=n(13),M=n.n(N),A=n(55),L=n(460),U=n(385),F=n(797);function B(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function V(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?B(Object(n),!0).forEach((function(t){M()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):B(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class K extends L.a{constructor(e){super(e),M()(this,"pollEventId",void 0),M()(this,"closingMessage",void 0);const t=this.wireContent["m.relates_to"];if(!A.d.matches(null==t?void 0:t.rel_type)||"string"!=typeof(null==t?void 0:t.event_id))throw new U.a("Relationship must be a reference to an event");this.pollEventId=t.event_id,this.closingMessage=new F.a(this.wireFormat)}isEquivalentTo(e){return Object(A.e)(e,p.a)}serialize(){return{type:p.a.name,content:V({"m.relates_to":{rel_type:A.d.name,event_id:this.pollEventId},[p.a.name]:{}},this.closingMessage.serialize().content)}}static from(e,t){return new K({type:p.a.name,content:{"m.relates_to":{rel_type:A.d.name,event_id:e},[p.a.name]:{},[A.c.name]:t}})}}var $=n(157),H=n(319),W=n(145);class q extends d.a.Component{constructor(){super(...arguments),c()(this,"onFinished",(async e=>{if(e){const e=this.props.matrixClient.getRoom(this.props.event.getRoomId()),t=null==e?void 0:e.polls.get(this.props.event.getId());if(!t)throw new Error("No poll instance found in room.");try{const e=await t.getResponses(),n=Object(H.e)(this.props.event,e),i=""===n?Object(b.a)("The poll has ended. No votes were cast."):Object(b.a)("The poll has ended. Top answer: %(topAnswer)s",{topAnswer:n}),s=K.from(this.props.event.getId(),i).serialize();await this.props.matrixClient.sendEvent(this.props.event.getRoomId(),s.type,s.content)}catch(e){console.error("Failed to submit poll response event:",e),y.b.createDialog(W.a,{title:Object(b.a)("Failed to end poll"),description:Object(b.a)("Sorry, the poll did not end. Please try again.")})}}this.props.onFinished(e)}))}render(){return d.a.createElement($.a,{title:Object(b.a)("End Poll"),description:Object(b.a)("Are you sure you want to end this poll? This will show the final results of the poll and stop people from being able to vote."),button:Object(b.a)("End Poll"),onFinished:e=>this.onFinished(e)})}}var G=n(233),z=n(207),J=n(137);const Y=(e,t)=>{var n;const i=t.getRoom(e.getRoomId()),s=null==i||null===(n=i.currentState.beacons)||void 0===n?void 0:n.get(Object(J.getBeaconInfoIdentifier)(e)),o=null==s?void 0:s.latestLocationEvent;return null!=s&&s.isLive&&o?o:null};var Q=n(264);var X=n(384);const Z=["mxEvent","rightClick","link","eventTileOps","reactions","collapseReplyChain"],ee=e=>{var t;let{mxEvent:n,closeMenu:i}=e;const s=Object(l.useContext)(X.a),o=null==n||null===(t=n.getRelation())||void 0===t?void 0:t.rel_type;if(Boolean(o)&&o!==h.h.Thread)return null;return d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconReplyInThread",label:Object(b.a)("Reply in thread"),onClick:()=>{n.getThread()&&!n.isThreadRoot?f.a.dispatch({action:I.a.ShowThread,rootEvent:n.getThread().rootEvent,initialEvent:n,scroll_into_view:!0,highlighted:!0,push:s.isCard}):f.a.dispatch({action:I.a.ShowThread,rootEvent:n,push:s.isCard}),i()}})};class te extends d.a.Component{constructor(e){super(e),c()(this,"context",void 0),c()(this,"reactButtonRef",Object(l.createRef)()),c()(this,"checkPermissions",(()=>{const e=v.a.get(),t=e.getRoom(this.props.mxEvent.getRoomId()),n=t.currentState.maySendRedactionForEvent(this.props.mxEvent,e.credentials.userId)&&this.props.mxEvent.getType()!==h.b.RoomServerAcl&&this.props.mxEvent.getType()!==h.b.RoomEncryption;let i=t.currentState.mayClientSendStateEvent(h.b.RoomPinnedEvents,e)&&Object(_.d)(this.props.mxEvent);E.b.getValue("feature_pinning")||(i=!1),this.setState({canRedact:n,canPin:i})})),c()(this,"onResendReactionsClick",(()=>{for(const e of this.getUnsentReactions())S.a.resend(e);this.closeMenu()})),c()(this,"onJumpToRelatedEventClick",(e=>{f.a.dispatch({action:"view_room",room_id:this.props.mxEvent.getRoomId(),event_id:e,highlighted:!0})})),c()(this,"onReportEventClick",(()=>{f.a.dispatch({action:I.a.OpenReportEventDialog,event:this.props.mxEvent}),this.closeMenu()})),c()(this,"onViewSourceClick",(()=>{y.b.createDialog(T.a,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource"),this.closeMenu()})),c()(this,"onRedactClick",(()=>{const{mxEvent:e,onCloseDialog:t}=this.props;Object(j.a)({mxEvent:e,onCloseDialog:t}),this.closeMenu()})),c()(this,"onForwardClick",(e=>()=>{f.a.dispatch({action:I.a.OpenForwardDialog,event:e,permalinkCreator:this.props.permalinkCreator}),this.closeMenu()})),c()(this,"onPinClick",(()=>{var e,t;const n=v.a.get(),i=n.getRoom(this.props.mxEvent.getRoomId()),s=this.props.mxEvent.getId(),o=(null==i||null===(e=i.currentState)||void 0===e||null===(t=e.getStateEvents(h.b.RoomPinnedEvents,""))||void 0===t?void 0:t.getContent().pinned)||[];var r,a;o.includes(s)?o.splice(o.indexOf(s),1):(o.push(s),n.setRoomAccountData(i.roomId,O.a,{event_ids:[...(null===(r=i.getAccountData(O.a))||void 0===r||null===(a=r.getContent())||void 0===a?void 0:a.event_ids)||[],s]}));n.sendStateEvent(this.props.mxEvent.getRoomId(),h.b.RoomPinnedEvents,{pinned:o},""),this.closeMenu()})),c()(this,"closeMenu",(()=>{this.props.onFinished()})),c()(this,"onUnhidePreviewClick",(()=>{var e;null===(e=this.props.eventTileOps)||void 0===e||e.unhideWidget(),this.closeMenu()})),c()(this,"onQuoteClick",(()=>{f.a.dispatch({action:I.a.ComposerInsert,event:this.props.mxEvent,timelineRenderingType:this.context.timelineRenderingType}),this.closeMenu()})),c()(this,"onShareClick",(e=>{e.preventDefault(),y.b.createDialog(P.a,{target:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}),this.closeMenu()})),c()(this,"onCopyLinkClick",(e=>{e.preventDefault(),Object(R.b)(this.props.link),this.closeMenu()})),c()(this,"onCollapseReplyChainClick",(()=>{this.props.collapseReplyChain(),this.closeMenu()})),c()(this,"onCopyClick",(()=>{Object(R.b)(Object(R.c)()),this.closeMenu()})),c()(this,"onEditClick",(()=>{Object(_.e)(this.props.mxEvent,this.context.timelineRenderingType,this.props.getRelationsForEvent),this.closeMenu()})),c()(this,"onReplyClick",(()=>{f.a.dispatch({action:"reply_to_event",event:this.props.mxEvent,context:this.context.timelineRenderingType}),this.closeMenu()})),c()(this,"onReactClick",(()=>{this.setState({reactionPickerDisplayed:!0})})),c()(this,"onCloseReactionPicker",(()=>{this.setState({reactionPickerDisplayed:!1}),this.closeMenu()})),c()(this,"onEndPollClick",(()=>{const e=v.a.get();y.b.createDialog(q,{matrixClient:e,event:this.props.mxEvent,getRelationsForEvent:this.props.getRelationsForEvent},"mx_Dialog_endPoll"),this.closeMenu()})),c()(this,"viewInRoom",(()=>{f.a.dispatch({action:I.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0}),this.closeMenu()})),this.state={canRedact:!1,canPin:!1,reactionPickerDisplayed:!1}}componentDidMount(){v.a.get().on(m.b.PowerLevel,this.checkPermissions),this.checkPermissions()}componentWillUnmount(){const e=v.a.get();e&&e.removeListener(m.b.PowerLevel,this.checkPermissions)}isPinned(){const e=v.a.get().getRoom(this.props.mxEvent.getRoomId()).currentState.getStateEvents(h.b.RoomPinnedEvents,"");if(!e)return!1;const t=e.getContent();return t.pinned&&Array.isArray(t.pinned)&&t.pinned.includes(this.props.mxEvent.getId())}canEndPoll(e){return p.e.matches(e.getType())&&this.state.canRedact&&!Object(H.f)(e,v.a.get())}getReactions(e){const t=v.a.get().getRoom(this.props.mxEvent.getRoomId()),n=this.props.mxEvent.getId();return t.getPendingEvents().filter((t=>{const i=t.getRelation();return(null==i?void 0:i.rel_type)===h.h.Annotation&&i.event_id===n&&e(t)}))}getUnsentReactions(){return this.getReactions((e=>e.status===u.a.NOT_SENT))}render(){var e,t,n,i;const o=v.a.get(),a=o.getUserId(),c=this.props,{mxEvent:l,rightClick:h,link:m,eventTileOps:f,reactions:y,collapseReplyChain:S}=c,O=r()(c,Z);delete O.getRelationsForEvent,delete O.permalinkCreator;const I=l.status,T=this.getUnsentReactions().length,j=Object(_.k)(l),P=null===(e=this.props.permalinkCreator)||void 0===e?void 0:e.forEvent(this.props.mxEvent.getId()),N=!I||I===u.a.SENT,{timelineRenderingType:M,canReact:A,canSendMessages:L}=this.context,U=(M===D.a.Thread||M===D.a.ThreadsList)&&(null==l||null===(t=l.getThread())||void 0===t?void 0:t.rootEvent)===l;let F,B,V;l.isRedacted()||0===T||(F=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconResend",label:Object(b.a)("Resend %(unsentCount)s reaction(s)",{unsentCount:T}),onClick:this.onResendReactionsClick})),N&&this.state.canRedact&&(B=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconRedact",label:Object(b.a)("Remove"),onClick:this.onRedactClick}));const K=((e,t)=>Object(_.l)(e)?e:z.b.matches(e.getType())?Y(e,t):null)(l,o);if(K){const e=Object(G.b)(K);V=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconOpenInMapSite",onClick:null,label:Object(b.a)("Open in OpenStreetMap"),element:"a",href:e,target:"_blank",rel:"noreferrer noopener"})}let $;const H=((e,t)=>p.e.matches(e.getType())||p.a.matches(e.getType())||e.getType()===Q.b?null:z.b.matches(e.getType())?Y(e,t):e)(l,o);let W;j&&H&&($=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconForward",label:Object(b.a)("Forward"),onClick:this.onForwardClick(H)})),j&&this.state.canPin&&(W=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconPin",label:this.isPinned()?Object(b.a)("Unpin"):Object(b.a)("Pin"),onClick:this.onPinClick}));const q=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconSource",label:Object(b.a)("View source"),onClick:this.onViewSourceClick});let J,X,te,ne,ie,se,oe;null!=f&&f.isWidgetHidden()&&(J=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconUnhidePreview",label:Object(b.a)("Show preview"),onClick:this.onUnhidePreviewClick})),P&&(X=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconPermalink",onClick:this.onShareClick,label:Object(b.a)("Share"),element:"a",href:P,target:"_blank",rel:"noreferrer noopener"})),this.canEndPoll(l)&&(te=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconEndPoll",label:Object(b.a)("End Poll"),onClick:this.onEndPollClick})),f&&L&&(ne=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconQuote",label:Object(b.a)("Quote"),onClick:this.onQuoteClick})),"string"==typeof l.getContent().external_url&&Object(w.f)(l.getContent().external_url)&&(ie=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconLink",onClick:this.closeMenu,label:Object(b.a)("Source URL"),element:"a",target:"_blank",rel:"noreferrer noopener",href:l.getContent().external_url})),S&&(se=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconCollapse",label:Object(b.a)("Collapse reply thread"),onClick:this.onCollapseReplyChainClick}));const re=null===(n=l.getWireContent())||void 0===n||null===(i=n["m.relates_to"])||void 0===i?void 0:i.event_id;let ae,ce,le,de,ue,he,me,pe,ge,ve;re&&E.b.getValue("developerMode")&&(oe=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_jumpToEvent",label:Object(b.a)("View related event"),onClick:()=>this.onJumpToRelatedEventClick(re)})),l.getSender()!==a&&(ae=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconReport",label:Object(b.a)("Report"),onClick:this.onReportEventClick})),m&&(ce=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconCopy",onClick:this.onCopyLinkClick,label:Object(b.a)("Copy link"),element:"a",href:m,target:"_blank",rel:"noreferrer noopener"})),h&&Object(R.c)()&&(le=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconCopy",label:Object(b.a)("Copy"),triggerOnMouseDown:!0,onClick:this.onCopyClick})),h&&Object(_.c)(l)&&(de=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconEdit",label:Object(b.a)("Edit"),onClick:this.onEditClick})),h&&j&&L&&(ue=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconReply",label:Object(b.a)("Reply"),onClick:this.onReplyClick})),h&&j&&L&&g.e.hasServerSideSupport&&M!==D.a.Thread&&(he=d.a.createElement(ee,{mxEvent:l,closeMenu:this.closeMenu})),h&&j&&A&&(me=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconReact",label:Object(b.a)("React"),onClick:this.onReactClick,inputRef:this.reactButtonRef})),U&&(pe=d.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconViewInRoom",label:Object(b.a)("View in room"),onClick:this.viewInRoom})),(le||ce)&&(ge=d.a.createElement(C.c,null,le,ce)),(de||ue||me)&&(ve=d.a.createElement(C.c,null,me,ue,he,de));const fe=d.a.createElement(C.c,null,pe,V,te,ne,$,W,X,ae,ie,oe,J,q,F,se);let be,ye;if(B&&(be=d.a.createElement(C.c,{red:!0},B)),this.state.reactionPickerDisplayed){var Se;const e=null===(Se=this.reactButtonRef.current)||void 0===Se?void 0:Se.getBoundingClientRect();ye=d.a.createElement(k.n,s()({},Object(k.p)(e),{onFinished:this.closeMenu,managed:!1}),d.a.createElement(x.a,{mxEvent:l,onFinished:this.onCloseReactionPicker,reactions:y}))}return d.a.createElement(d.a.Fragment,null,d.a.createElement(C.e,s()({},O,{className:"mx_MessageContextMenu",compact:!0,"data-testid":"mx_MessageContextMenu"}),ge,ve,fe,be),ye)}}c()(te,"contextType",D.b)},,,function(e,t,n){"use strict";n.d(t,"b",(function(){return b})),n.d(t,"a",(function(){return y}));var i=n(120),s=n.n(i),o=n(121),r=n(132),a=n(232),c=n(194),l=n(157),d=n(135);const u=["vector-im/element-web","matrix-org/matrix-react-sdk","matrix-org/matrix-js-sdk"];class h extends s.a.Component{constructor(e){super(e),this.state={}}async fetchChanges(e,t,n){const i=`https://riot.im/github/repos/${e}/compare/${t}...${n}`;try{const t=await fetch(i);if(!t.ok)return void this.setState({[e]:t.statusText});const n=await t.json();this.setState({[e]:n.commits})}catch(t){this.setState({[e]:t.message})}}componentDidMount(){const e=this.props.newVersion.split("-"),t=this.props.version.split("-");if(null!=e&&null!=t)for(let n=0;n<u.length;n++){const i=t[2*n],s=e[2*n];this.fetchChanges(u[n],i,s)}}elementsForCommit(e){return s.a.createElement("li",{key:e.sha,className:"mx_ChangelogDialog_li"},s.a.createElement("a",{href:e.html_url,target:"_blank",rel:"noreferrer noopener"},e.commit.message.split("\n")[0]))}render(){const e=u.map((e=>{let t;return t=null==this.state[e]?s.a.createElement(d.a,{key:e}):"string"==typeof this.state[e]?Object(o.a)("Unable to load commit detail: %(msg)s",{msg:this.state[e]}):this.state[e].map(this.elementsForCommit),s.a.createElement("div",{key:e},s.a.createElement("h2",null,e),s.a.createElement("ul",null,t))})),t=s.a.createElement("div",{className:"mx_ChangelogDialog_content"},null==this.props.version||null==this.props.newVersion?s.a.createElement("h2",null,Object(o.a)("Unavailable")):e);return s.a.createElement(l.a,{title:Object(o.a)("Changelog"),description:t,button:Object(o.a)("Update"),onFinished:this.props.onFinished})}}var m=n(156),p=n(128);const g="update";function v(e){const t=e.split("-");return 5===t.length&&"react"===t[1]&&"js"===t[3]}function f(){var e;null===(e=m.a.get())||void 0===e||e.installUpdate()}const b=(e,t,n)=>{let i,d=Object(o.a)("What's new?");n?i=()=>{p.b.createDialog(l.a,{title:Object(o.a)("What's New"),description:s.a.createElement("pre",null,n),button:Object(o.a)("Update"),onFinished:e=>{e&&m.a.get()&&m.a.get().installUpdate()}})}:v(e)&&v(t)?i=()=>{p.b.createDialog(h,{version:e,newVersion:t,onFinished:e=>{e&&m.a.get()&&m.a.get().installUpdate()}})}:(i=f,d=Object(o.a)("Update"));const u=r.b.get().brand;c.a.sharedInstance().addOrReplaceToast({key:g,title:Object(o.a)("Update %(brand)s",{brand:u}),props:{description:Object(o.a)("New version of %(brand)s is available",{brand:u}),acceptLabel:d,onAccept:i,rejectLabel:Object(o.a)("Dismiss"),onReject:function(){var e;null===(e=m.a.get())||void 0===e||e.deferUpdate(t)}},component:a.a,priority:20})},y=()=>{c.a.sharedInstance().dismissToast(g)}},function(e,t,n){"use strict";n.d(t,"c",(function(){return c.d})),n.d(t,"a",(function(){return c.a})),n.d(t,"b",(function(){return c.c}));var i=n(13),s=n.n(i),o=n(1),r=n(200),a=n(365),c=n(427);const l=a.a.DeviceVerification;class d extends c.e{constructor(){super(...arguments),s()(this,"sessionPrepared",!1),s()(this,"prepPromise",null)}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then((()=>this.crypto.ensureOlmSessionsForUsers(e))).then((()=>{this.sessionPrepared=!0})).finally((()=>{this.prepPromise=null})),this.prepPromise)}async encryptMessage(e,t,n){const i=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId}));await this.ensureSession(i);const s={room_id:e.roomId,type:t,content:n},o={algorithm:r.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},a=[];for(const e of i){const t=this.crypto.getStoredDevicesForUser(e)||[];for(const n of t){n.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(n.verified!=l.BLOCKED&&a.push(r.encryptMessageForDevice(o.ciphertext,this.userId,this.deviceId,this.olmDevice,e,n,s)))}}return Promise.all(a).then((()=>o))}}class u extends c.b{async decryptEvent(e){const t=e.getWireContent(),n=t.sender_key,i=t.ciphertext;if(!i)throw new c.c("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in i))throw new c.c("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const s=i[this.olmDevice.deviceCurve25519Key];let o;try{o=await this.decryptMessage(n,s)}catch(e){throw new c.c("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:n,err:e})}const a=JSON.parse(o);if(a.recipient!=this.userId)throw new c.c("OLM_BAD_RECIPIENT","Message was intented for "+a.recipient);if(a.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new c.c("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:a.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});await this.crypto.deviceList.downloadKeys([e.getSender()],!1);const l=this.crypto.deviceList.getUserByIdentityKey(r.OLM_ALGORITHM,n);if(l!==e.getSender()&&null!=l)throw new c.c("OLM_BAD_SENDER","Message claimed to be from "+e.getSender(),{real_sender:l});if(a.sender!=e.getSender())throw new c.c("OLM_FORWARDED_MESSAGE","Message forwarded from "+a.sender,{reported_sender:e.getSender()});if(a.room_id!==e.getRoomId())throw new c.c("OLM_BAD_ROOM","Message intended for room "+a.room_id,{reported_room:e.getRoomId()||"ROOM_ID_UNDEFINED"});return{clearEvent:a,senderCurve25519Key:n,claimedEd25519Key:(a.keys||{}).ed25519||null}}decryptMessage(e,t){if(0!==t.type)return this.reallyDecryptMessage(e,t);{const n=this.olmDevice.olmPrekeyPromise.then((()=>this.reallyDecryptMessage(e,t)));return this.olmDevice.olmPrekeyPromise=n.catch((()=>{})),n}}async reallyDecryptMessage(e,t){const n=await this.olmDevice.getSessionIdsForDevice(e),i={};for(const s of n)try{const n=await this.olmDevice.decryptMessage(e,s,t.type,t.body);return o.a.log("Decrypted Olm message from "+e+" with session "+s),n}catch(n){if(await this.olmDevice.matchesSession(e,s,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+s+": "+n.message);i[s]=n.message}if(0!==t.type){if(0===n.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(i))}let s;try{s=await this.olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw i["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(i))}return o.a.log("created new inbound Olm session ID "+s.session_id+" with "+e),s.payload}}Object(c.g)(r.OLM_ALGORITHM,d,u);n(706)},function(e,t,n){"use strict";n.d(t,"a",(function(){return C}));var i=n(122),s=n.n(i),o=n(196),r=n(16),a=n(1),c=n(130),l=n(161),d=n(123),u=n(447),h=n(121),m=n(128),p=n(126),g=n(120),v=n.n(g),f=n(138),b=n(136);function y(e){let{onFinished:t,onGiveUp:n,onInviteAnyways:i,unknownProfileUsers:s}=e;const o=Object(g.useCallback)((()=>{i(),t(!0)}),[i,t]),r=Object(g.useCallback)((()=>{p.b.setValue("promptBeforeInviteUnknownUsers",null,f.a.ACCOUNT,!1),i(),t(!0)}),[i,t]),a=Object(g.useCallback)((()=>{n(),t(!1)}),[n,t]),c=s.map((e=>v.a.createElement("li",{key:e.userId},e.userId,": ",e.errorText)));return v.a.createElement(b.a,{className:"mx_RetryInvitesDialog",onFinished:a,title:Object(h.a)("The following users may not exist"),contentId:"mx_Dialog_content"},v.a.createElement("div",{id:"mx_Dialog_content"},v.a.createElement("p",null,Object(h.a)("Unable to find profiles for the Matrix IDs listed below - would you like to invite them anyway?")),v.a.createElement("ul",null,c)),v.a.createElement("div",{className:"mx_Dialog_buttons"},v.a.createElement("button",{onClick:a},Object(h.a)("Close")),v.a.createElement("button",{onClick:r},Object(h.a)("Invite anyway and never warn me again")),v.a.createElement("button",{onClick:o,autoFocus:!0},Object(h.a)("Invite anyway"))))}let S;!function(e){e.Invited="invited",e.Error="error"}(S||(S={}));const E=["M_NOT_FOUND","M_USER_NOT_FOUND","M_PROFILE_UNDISCLOSED","M_PROFILE_NOT_FOUND"],w="IO.ELEMENT.ALREADY_JOINED",_="IO.ELEMENT.ALREADY_INVITED";class C{constructor(e,t){this.roomId=e,this.progressCallback=t,s()(this,"matrixClient",void 0),s()(this,"canceled",!1),s()(this,"addresses",[]),s()(this,"busy",!1),s()(this,"_fatal",!1),s()(this,"completionStates",{}),s()(this,"errors",{}),s()(this,"deferred",null),s()(this,"reason",void 0),this.matrixClient=d.a.get()}get fatal(){return this._fatal}invite(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.addresses.length>0)throw new Error("Already inviting/invited");this.addresses.push(...e),this.reason=t;for(const e of this.addresses)null===Object(u.b)(e)&&(this.completionStates[e]=S.Error,this.errors[e]={errcode:"M_INVALID",errorText:Object(h.a)("Unrecognised address")});if(this.deferred=Object(r.m)(),this.inviteMore(0),!n||!this.roomId||!this.matrixClient.isRoomEncrypted(this.roomId))return this.deferred.promise;const i=this.matrixClient.getRoom(this.roomId),s=null==i?void 0:i.currentState.getStateEvents(c.b.RoomHistoryVisibility,""),o=null==s?void 0:s.getContent().history_visibility;return o!==l.b.WorldReadable&&o!==l.b.Shared?this.deferred.promise:this.deferred.promise.then((async e=>{const t=[];for(const[n,i]of Object.entries(e))i===S.Invited&&Object(u.b)(n)===u.a.MatrixUserId&&t.push(n);return a.a.log("Sharing history with",t),this.matrixClient.sendSharedHistoryKeys(this.roomId,t),e}))}cancel(){var e;this.busy&&(this.canceled=!0,null===(e=this.deferred)||void 0===e||e.reject(new Error("canceled")))}getCompletionState(e){return this.completionStates[e]}getErrorText(e){return this.errors[e]?this.errors[e].errorText:null}async inviteToRoom(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=Object(u.b)(t);if(i===u.a.Email)return this.matrixClient.inviteByEmail(e,t);if(i===u.a.MatrixUserId){const i=this.matrixClient.getRoom(e);if(!i)throw new Error("Room not found");const s=i.getMember(t);if("join"===(null==s?void 0:s.membership))throw new o.f({errcode:w,error:"Member already joined"});if("invite"===(null==s?void 0:s.membership))throw new o.f({errcode:_,error:"Member already invited"});if(!n&&p.b.getValue("promptBeforeInviteUnknownUsers",this.roomId))try{await this.matrixClient.getProfileInfo(t)}catch(e){switch(e.errcode){case"M_FORBIDDEN":throw new o.f({errcode:"M_PROFILE_UNDISCLOSED"});case"M_NOT_FOUND":throw new o.f({errcode:"M_USER_NOT_FOUND"});default:throw e}}return this.matrixClient.invite(e,t,this.reason)}throw new Error("Unsupported address")}doInvite(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise(((n,i)=>{a.a.log(`Inviting ${e}`);this.inviteToRoom(this.roomId,e,t).then((()=>{var t;this.canceled||(this.completionStates[e]=S.Invited,delete this.errors[e],n(),null===(t=this.progressCallback)||void 0===t||t.call(this))})).catch((s=>{var o;if(this.canceled)return;a.a.error(s);const r=this.roomId&&(null===(o=this.matrixClient.getRoom(this.roomId))||void 0===o?void 0:o.isSpaceRoom());let c,l=!1;switch(s.errcode){case"M_FORBIDDEN":c=r?Object(h.a)("You do not have permission to invite people to this space."):Object(h.a)("You do not have permission to invite people to this room."),l=!0;break;case _:c=r?Object(h.a)("User is already invited to the space"):Object(h.a)("User is already invited to the room");break;case w:c=r?Object(h.a)("User is already in the space"):Object(h.a)("User is already in the room");break;case"M_LIMIT_EXCEEDED":return void window.setTimeout((()=>{this.doInvite(e,t).then(n,i)}),5e3);case"M_NOT_FOUND":case"M_USER_NOT_FOUND":c=Object(h.a)("User does not exist");break;case"M_PROFILE_UNDISCLOSED":c=Object(h.a)("User may or may not exist");break;case"M_PROFILE_NOT_FOUND":if(!t)return a.a.warn(`User ${e} does not have a profile - inviting anyways automatically`),void this.doInvite(e,!0).then(n,i);break;case"M_BAD_STATE":c=Object(h.a)("The user must be unbanned before they can be invited.");break;case"M_UNSUPPORTED_ROOM_VERSION":c=r?Object(h.a)("The user's homeserver does not support the version of the space."):Object(h.a)("The user's homeserver does not support the version of the room.")}c||(c=Object(h.a)("Unknown server error")),this.completionStates[e]=S.Error,this.errors[e]={errorText:c,errcode:s.errcode},this.busy=!l,this._fatal=l,l?i(s):n()}))}))}inviteMore(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.canceled)return;if(e===this.addresses.length){var n;if(this.busy=!1,Object.keys(this.errors).length>0){const e=Object.keys(this.errors).filter((e=>E.includes(this.errors[e].errcode)));if(e.length>0){const t=()=>{const t=e.map((e=>this.doInvite(e,!0)));Promise.all(t).then((()=>{var e;return null===(e=this.deferred)||void 0===e?void 0:e.resolve(this.completionStates)}))};return p.b.getValue("promptBeforeInviteUnknownUsers",this.roomId)?(a.a.log("Showing failed to invite dialog..."),void m.b.createDialog(y,{unknownProfileUsers:e.map((e=>({userId:e,errorText:this.errors[e].errorText}))),onInviteAnyways:()=>t(),onGiveUp:()=>{var t;for(const t of e)this.completionStates[t]=S.Invited;null===(t=this.deferred)||void 0===t||t.resolve(this.completionStates)}})):void t()}}return void(null===(n=this.deferred)||void 0===n||n.resolve(this.completionStates))}const i=this.addresses[e];null!==Object(u.b)(i)&&this.completionStates[i]!==S.Invited?this.doInvite(i,t).then((()=>{this.inviteMore(e+1,t)})).catch((()=>{var e;return null===(e=this.deferred)||void 0===e?void 0:e.resolve(this.completionStates)})):this.inviteMore(e+1)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i),o=n(185);const r={};var a=n(220),c=n(397);class l{constructor(){}static get instance(){return l.internalInstance||(l.internalInstance=new l),l.internalInstance}async onNewInvitedRoom(e){await c.a.sharedInstance().onNewInvitedRoom(e)}isRoomVisible(e){if(!e)return!1;if(o.b.instance.getSupportsVirtualRooms()&&c.a.sharedInstance().isVirtualRoom(e))return!1;if(e.isSpaceRoom())return!1;if(Object(a.a)(e))return!1;const t=r.isRoomVisible;return!t||t(e)}}s()(l,"internalInstance",void 0)},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return A}));var i=n(131),s=n.n(i),o=n(122),r=n.n(o),a=n(120),c=n.n(a),l=n(1559),d=n(127),u=n.n(d),h=n(888),m=n(1),p=n(149),g=n(345),v=n(128),f=n(121),b=n(126),y=n(135),S=n(160),E=n(507),w=n(417),_=n(408),C=n(123),O=n(139),I=n(147);function R(e){return["image/gif","image/webp","image/png","image/apng","image/avif"].includes(e)}function k(e,t,n){return new Uint8Array(e.slice(t,t+n))}function x(e,t){return new DataView(e,t,4).getUint32(0)}function T(e,t,n){return String.fromCharCode.apply(null,Array.from(k(e,t,n)))}var j,P=n(586),D=n(633),N=n(481),M=n(548);!function(e){e[e.NoImage=0]="NoImage",e[e.Blurhash=1]="Blurhash"}(j||(j={}));class A extends c.a.Component{constructor(e){super(e),r()(this,"context",void 0),r()(this,"unmounted",!0),r()(this,"image",Object(a.createRef)()),r()(this,"timeout",void 0),r()(this,"sizeWatcher",void 0),r()(this,"reconnectedListener",void 0),r()(this,"onClick",(e=>{if(0===e.button&&!e.metaKey){var t;if(e.preventDefault(),!this.state.showImage)return void this.showImage();const n=this.props.mxEvent.getContent(),i={src:this.state.contentUrl,name:(null===(t=n.body)||void 0===t?void 0:t.length)>0?n.body:Object(f.a)("Attachment"),mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator};if(n.info&&(i.width=n.info.w,i.height=n.info.h,i.fileSize=n.info.size),this.image.current){const e=this.image.current.getBoundingClientRect();i.thumbnailInfo={width:e.width,height:e.height,positionX:e.x,positionY:e.y}}v.b.createDialog(w.a,i,"mx_Dialog_lightbox",null,!0)}})),r()(this,"onImageEnter",(e=>{if(this.setState({hover:!0}),!this.state.showImage||!this.state.isAnimated||b.b.getValue("autoplayGifs"))return;e.currentTarget.src=this.state.contentUrl})),r()(this,"onImageLeave",(e=>{var t;if(this.setState({hover:!1}),!this.state.showImage||!this.state.isAnimated||b.b.getValue("autoplayGifs"))return;e.currentTarget.src=null!==(t=this.state.thumbUrl)&&void 0!==t?t:this.state.contentUrl})),r()(this,"clearError",(()=>{C.a.get().off(p.b.Sync,this.reconnectedListener),this.setState({imgError:!1})})),r()(this,"onImageError",(()=>{this.clearBlurhashTimeout(),this.setState({imgError:!0}),C.a.get().on(p.b.Sync,this.reconnectedListener)})),r()(this,"onImageLoad",(()=>{let e;if(this.clearBlurhashTimeout(),this.props.onHeightChanged(),this.image.current){const{naturalWidth:t,naturalHeight:n}=this.image.current;e={naturalWidth:t,naturalHeight:n}}this.setState({imgLoaded:!0,loadedImageDimensions:e})})),this.reconnectedListener=Object(D.a)(this.clearError),this.state={imgError:!1,imgLoaded:!1,hover:!1,showImage:b.b.getValue("showImages"),placeholder:j.NoImage}}showImage(){localStorage.setItem("mx_ShowImage_"+this.props.mxEvent.getId(),"true"),this.setState({showImage:!0}),this.downloadImage()}getContentUrl(){return this.props.forExport?this.media.srcMxc:this.media.srcHttp}get media(){return Object(S.a)(this.props.mxEvent.getContent())}getThumbUrl(){const e=800,t=600,n=this.props.mxEvent.getContent(),i=Object(S.a)(n),s=n.info;if("image/svg+xml"===(null==s?void 0:s.mimetype)&&i.hasThumbnail)return i.getThumbnailHttp(e,t,"scale");if(this.state.isAnimated||1===window.devicePixelRatio||!s||!s.w||!s.h||!s.size)return i.getThumbnailOfSourceHttp(e,t);const o=s.w>e||s.h>t;return s.size>1048576&&o?i.getThumbnailOfSourceHttp(e,t):i.srcHttp}async downloadImage(){var e;if(this.state.contentUrl)return;let t,n;if(this.props.mediaEventHelper.media.isEncrypted)try{[n,t]=await Promise.all([this.props.mediaEventHelper.sourceUrl.value,this.props.mediaEventHelper.thumbnailUrl.value])}catch(e){if(this.unmounted)return;return e instanceof M.a?m.a.error("Unable to decrypt attachment: ",e):e instanceof M.b?m.a.error("Unable to download attachment to decrypt it: ",e):m.a.error("Error encountered when downloading encrypted attachment: ",e),void this.setState({error:e})}else t=this.getThumbUrl(),n=this.getContentUrl();const i=this.props.mxEvent.getContent();let s=R(null===(e=i.info)||void 0===e?void 0:e.mimetype);if(s&&!b.b.getValue("autoplayGifs")&&(!t||null==i||!i.info.thumbnail_info||R(i.info.thumbnail_info.mimetype))){const e=document.createElement("img"),r=new Promise(((t,n)=>{e.onload=t,e.onerror=n}));e.crossOrigin="Anonymous",e.src=n;try{await r}catch(e){return m.a.error("Unable to download attachment: ",e),void this.setState({error:e})}try{var o;const n=await this.props.mediaEventHelper.sourceBlob.value;if(await async function(e,t){switch(e){case"image/webp":{const e=await t.slice(0,17).arrayBuffer();if("RIFF"===T(e,0,4)&&"WEBP"===T(e,8,4)&&"VP8X"===T(e,12,4)){const[t]=k(e,16,1);return 0!=(2&t)}break}case"image/gif":{const e=new DataView(await t.arrayBuffer(),10),n=e.getUint8(0);let i=0;128&n&&(i=3*Math.pow(2,1+(7&n)));const s=3+i,o=e.getUint8(s),r=e.getUint8(s+1);let a=0;return 33&o&&249&r&&(a=e.getUint16(s+4)),!!a}case"image/png":case"image/apng":{const e=await t.arrayBuffer();if(Object(I.d)([137,80,78,71,13,10,26,10],Array.from(k(e,0,8))))return!1;for(let n=8;n<t.size;){const t=x(e,n);n+=4;const i=T(e,n,4);switch(n+=4,i){case"acTL":return!0;case"IDAT":return!1}n+=t+4}break}}return!1}(null===(o=i.info)||void 0===o?void 0:o.mimetype,n)||(s=!1),s){const n=await Object(E.b)(e,e.width,e.height,i.info.mimetype,!1);t=URL.createObjectURL(n.thumbnail)}}catch(e){m.a.warn("Unable to generate thumbnail for animated image: ",e)}}this.unmounted||this.setState({contentUrl:n,thumbUrl:t,isAnimated:s})}clearBlurhashTimeout(){this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0)}componentDidMount(){var e;this.unmounted=!1;(this.state.showImage||"true"===localStorage.getItem("mx_ShowImage_"+this.props.mxEvent.getId()))&&(this.downloadImage(),this.setState({showImage:!0})),null!==(e=this.props.mxEvent.getContent().info)&&void 0!==e&&e[E.a]&&(this.clearBlurhashTimeout(),this.timeout=window.setTimeout((()=>{this.state.imgLoaded&&this.state.imgError||this.setState({placeholder:j.Blurhash})}),150)),this.sizeWatcher=b.b.watchSetting("Images.size",null,(()=>{this.forceUpdate()}))}componentWillUnmount(){this.unmounted=!0,C.a.get().off(p.b.Sync,this.reconnectedListener),this.clearBlurhashTimeout(),b.b.unwatchSetting(this.sizeWatcher),this.state.isAnimated&&this.state.thumbUrl&&URL.revokeObjectURL(this.state.thumbUrl)}getBanner(e){return[O.a.ThreadsList,O.a.File].includes(this.context.timelineRenderingType)?null:c.a.createElement("span",{className:"mx_MImageBody_banner"},Object(P.a)(e,Object(f.a)("Image"),!0,!0))}messageContent(e,t,n,i){var s,o;let r,a;t||(t=e);let l=!1;if(null!==(s=n.info)&&void 0!==s&&s.w&&null!==(o=n.info)&&void 0!==o&&o.h)r=n.info.w,a=n.info.h,l="image/svg+xml"===n.info.mimetype;else{if(!this.state.loadedImageDimensions){let i;return i=this.state.showImage?c.a.createElement("img",{style:{display:"none"},src:t,ref:this.image,alt:n.body,onError:this.onImageError,onLoad:this.onImageLoad}):c.a.createElement(L,null),this.wrapImage(e,i)}r=this.state.loadedImageDimensions.naturalWidth,a=this.state.loadedImageDimensions.naturalHeight}const{w:d,h:m}=Object(_.b)(b.b.getValue("Images.size"),{w:r,h:a},null!=i?i:this.props.maxImageHeight);let p,g,v;if(!this.props.forExport&&!this.state.imgLoaded){var f;const e=u()("mx_MImageBody_placeholder",{"mx_MImageBody_placeholder--blurhash":null===(f=this.props.mxEvent.getContent().info)||void 0===f?void 0:f[E.a]});g=c.a.createElement("div",{className:e},this.getPlaceholder(d,m))}let y,S=Boolean(g);t&&!this.state.imgError&&(p=c.a.createElement("img",{className:"mx_MImageBody_thumbnail",src:t,ref:this.image,alt:n.body,onError:this.onImageError,onLoad:this.onImageLoad,onMouseEnter:this.onImageEnter,onMouseLeave:this.onImageLeave})),this.state.showImage||(p=c.a.createElement(L,{maxWidth:d}),S=!1),!this.state.isAnimated||b.b.getValue("autoplayGifs")||this.state.hover||(v=c.a.createElement("p",{className:"mx_MImageBody_gifLabel"},"GIF")),this.state.showImage&&this.state.hover&&(y=this.getBanner(n));const w=l?{maxHeight:m,maxWidth:d,width:d}:{maxHeight:m,maxWidth:d};this.props.forExport||(g=c.a.createElement(h.SwitchTransition,{mode:"out-in"},c.a.createElement(h.CSSTransition,{classNames:"mx_rtg--fade",key:`img-${S}`,timeout:300},S?g:c.a.createElement(c.a.Fragment,null))));const C=c.a.createElement("div",{className:"mx_MImageBody_thumbnail_container",style:{maxHeight:m,maxWidth:d,aspectRatio:`${r}/${a}`}},g,c.a.createElement("div",{style:w},p,v,y),!this.props.forExport&&!this.state.imgLoaded&&c.a.createElement("div",{style:{height:m,width:d}}),this.state.hover&&this.getTooltip());return this.wrapImage(e,C)}wrapImage(e,t){return c.a.createElement("a",{href:e,target:this.props.forExport?"_blank":void 0,onClick:this.onClick},t)}getPlaceholder(e,t){var n;const i=null===(n=this.props.mxEvent.getContent().info)||void 0===n?void 0:n[E.a];if(i){if(this.state.placeholder===j.NoImage)return null;if(this.state.placeholder===j.Blurhash)return c.a.createElement(l.Blurhash,{className:"mx_Blurhash",hash:i,width:e,height:t})}return c.a.createElement(y.a,{w:32,h:32})}getTooltip(){return null}getFileBody(){if(this.props.forExport)return null;return this.context.timelineRenderingType===O.a.Room||this.context.timelineRenderingType===O.a.Pinned||this.context.timelineRenderingType===O.a.Search||this.context.timelineRenderingType===O.a.Thread||this.context.timelineRenderingType===O.a.ThreadsList?void 0:c.a.createElement(g.a,s()({},this.props,{showGenericPlaceholder:!1}))}render(){const e=this.props.mxEvent.getContent();if(this.state.error){let e=Object(f.a)("Unable to show image due to error");return this.state.error instanceof M.a?e=Object(f.a)("Error decrypting image"):this.state.error instanceof M.b&&(e=Object(f.a)("Error downloading image")),c.a.createElement("div",{className:"sc_MImageBody_container"},c.a.createElement(N.a,{className:"mx_MImageBody"},e,this.props.scBubbleTimestamp),this.props.scBubbleActionBar)}let t,n=this.state.contentUrl;var i,s;if(this.props.forExport)n=null!==(i=this.props.mxEvent.getContent().url)&&void 0!==i?i:null===(s=this.props.mxEvent.getContent().file)||void 0===s?void 0:s.url,t=n;else if(this.state.isAnimated&&b.b.getValue("autoplayGifs"))t=n;else{var o;t=null!==(o=this.state.thumbUrl)&&void 0!==o?o:this.state.contentUrl}const r=this.messageContent(n,t,e),a=this.getFileBody();return c.a.createElement("div",{className:"sc_MImageBody_container"},c.a.createElement("div",{className:"mx_MImageBody"},r,a,this.props.scBubbleTimestamp),this.props.scBubbleActionBar)}}r()(A,"contextType",O.b);class L extends c.a.PureComponent{render(){const e=this.props.maxWidth?this.props.maxWidth+"px":null;let t="mx_HiddenImagePlaceholder";return this.props.hover&&(t+=" mx_HiddenImagePlaceholder_hover"),c.a.createElement("div",{className:t,style:{maxWidth:`min(100%, ${e}px)`}},c.a.createElement("div",{className:"mx_HiddenImagePlaceholder_button"},c.a.createElement("span",{className:"mx_HiddenImagePlaceholder_eye"}),c.a.createElement("span",null,Object(f.a)("Show image"))))}}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(13),s=n.n(i),o=n(361),r=n(144);class a{constructor(e,t){this.client=e,this.room=t,s()(this,"relations",new Map)}getChildEventsForEvent(e,t,n){var i,s;return null===(i=this.relations.get(e))||void 0===i||null===(s=i.get(t))||void 0===s?void 0:s.get(n)}getAllChildEventsForEvent(e){var t;const n=null!==(t=this.relations.get(e))&&void 0!==t?t:new Map,i=[];for(const e of n.values())for(const t of e.values())i.push(...t.getRelations());return i}aggregateParentEvent(e){const t=this.relations.get(e.getId());if(t)for(const n of t.values())for(const t of n.values())t.setTargetEvent(e)}aggregateChildEvent(e,t){if(e.isRedacted()||e.status===r.a.CANCELLED)return;const n=e.getRelation();if(!n)return;const i=()=>{e.isDecryptionFailure()?e.once(r.c.Decrypted,i):this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption())return void e.once(r.c.Decrypted,i);const{event_id:s,rel_type:a}=n,c=e.getType();let l=this.relations.get(s);l||(l=new Map,this.relations.set(s,l));let d=l.get(a);d||(d=new Map,l.set(a,d));let u=d.get(c);if(!u){var h,m,p;u=new o.a(a,c,this.client),d.set(c,u);const e=null!==(h=this.room)&&void 0!==h?h:null==t?void 0:t.room,n=null!==(m=null!==(p=null==t?void 0:t.findEventById(s))&&void 0!==p?p:null==e?void 0:e.findEventById(s))&&void 0!==m?m:null==e?void 0:e.getPendingEvent(s);n&&u.setTargetEvent(n)}u.addEvent(e)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return h}));var i=n(13),s=n.n(i),o=n(18),r=n(159),a=n(16),c=n(144),l=n(130),d=n(141);function u(e,t,n){var i;return new c.b({content:{[t.getId()]:{[n]:{[e]:{ts:t.getTs(),thread_id:null!==(i=t.threadRootId)&&void 0!==i?i:o.a}}}},type:l.b.Receipt,room_id:t.getRoomId()})}class h extends r.b{constructor(){super(...arguments),s()(this,"receipts",new a.b((()=>new Map))),s()(this,"receiptCacheByEventId",new Map),s()(this,"timeline",void 0)}getReadReceiptForUserId(e){var t,n;let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.b.Read;const[r,a]=null!==(t=null===(n=this.receipts.get(s))||void 0===n?void 0:n.get(e))&&void 0!==t?t:[null,null];return i?r:null!=a?a:r}getEventReadUpTo(e){var t,n,i,s,r;let a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const c=this.getUnfilteredTimelineSet(),l=this.getReadReceiptForUserId(e,a,o.b.Read),d=this.getReadReceiptForUserId(e,a,o.b.ReadPrivate);let u;var h,m;(null!=l&&l.eventId&&null!=d&&d.eventId&&(u=c.compareEventOrdering(null==l?void 0:l.eventId,null==d?void 0:d.eventId)),!u&&null!=l&&null!==(t=l.data)&&void 0!==t&&t.ts&&null!=d&&null!==(n=d.data)&&void 0!==n&&n.ts)&&(u=(null==l||null===(h=l.data)||void 0===h?void 0:h.ts)-(null==d||null===(m=d.data)||void 0===m?void 0:m.ts));return u?null!==(r=u<0?null==d?void 0:d.eventId:null==l?void 0:l.eventId)&&void 0!==r?r:null:null!==(i=null!==(s=null==d?void 0:d.eventId)&&void 0!==s?s:null==l?void 0:l.eventId)&&void 0!==i?i:null}addReceiptToStructure(e,t,n,i,s){var o,r;const a=this.receipts.getOrCreate(t);let c=a.get(n);c||(c=[null,null],a.set(n,c));let l=c[0];var d;s&&(l=null!==(d=c[1])&&void 0!==d?d:c[0]);if(l){const t=this.getUnfilteredTimelineSet().compareEventOrdering(l.eventId,e);if(null!==t&&t>=0)return}const u={eventId:e,data:i},h=s?c[0]:u,m=s?u:c[1];let p=null;h&&m&&(p=this.getUnfilteredTimelineSet().compareEventOrdering(h.eventId,m.eventId));const g=null===p||p<0,v=null!==(o=c[1])&&void 0!==o?o:c[0];s&&g?c[1]=u:s||(c[0]=u,g||(c[1]=null));if(v!==(null!==(r=c[1])&&void 0!==r?r:c[0])){if(v&&this.receiptCacheByEventId.get(v.eventId)){const e=v.eventId;this.receiptCacheByEventId.set(e,this.receiptCacheByEventId.get(e).filter((e=>e.type!==t||e.userId!==n))),this.receiptCacheByEventId.get(e).length<1&&this.receiptCacheByEventId.delete(e)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:n,type:t,data:i})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){const t=this.getReadReceiptForUserId(e,!1),n=this.timeline[this.timeline.length-1];n&&(null==t?void 0:t.eventId)===n.getId()&&e===n.getSender()&&(this.setUnread(d.b.Total,0),this.setUnread(d.b.Highlight,0))}addLocalEchoReceipt(e,t,n){this.addReceipt(u(e,t,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter((function(e){return a.w(e.type)})).map((function(e){return e.userId}))}hasUserReadEvent(e,t){var n;const i=this.getEventReadUpTo(e,!1);if(i===t)return!0;if(null!==(n=this.timeline)&&void 0!==n&&n.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(let e=(null===(s=this.timeline)||void 0===s?void 0:s.length)-1;e>=0;--e){var s;const n=this.timeline[e];if(n.getId()===t)return!1;if(n.getId()===i)return!0}return!1}}},,,,,function(e,t,n){"use strict";function i(e,t){return new Promise(((n,i)=>{let s=!0;const o=e.open(t);o.onupgradeneeded=()=>{s=!1},o.onblocked=()=>i(o.error),o.onsuccess=()=>{o.result.close(),s||e.deleteDatabase(t),n(s)},o.onerror=()=>i(o.error)}))}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i=n(13),s=n.n(i),o=n(366),r=n(1),a=n(200),c=n(427),l=n(524),d=n(130),u=n(707),h=n(16);function m(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?m(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):m(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function g(e){var t,n;const i=null==e||null===(t=e.currentState)||void 0===t?void 0:t.getStateEvents("m.room.history_visibility",""),s=null==i||null===(n=i.getContent())||void 0===n?void 0:n.history_visibility;return["world_readable","shared"].includes(s)}const v=e=>"string"==typeof e.ciphertext?!!e.ciphertext.length:!!Object.keys(e.ciphertext).length;class f{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.sessionId=e,this.sharedHistory=t,s()(this,"useCount",0),s()(this,"creationTime",void 0),s()(this,"sharedWithDevices",new h.b((()=>new Map))),s()(this,"blockedDevicesNotified",new h.b((()=>new Map))),this.creationTime=(new Date).getTime()}needsRotation(e,t){const n=(new Date).getTime()-this.creationTime;return(this.useCount>=e||n>=t)&&(r.a.log("Rotating megolm session after "+this.useCount+" messages, "+n+"ms"),!0)}markSharedWithDevice(e,t,n,i){this.sharedWithDevices.getOrCreate(e).set(t,{deviceKey:n,messageIndex:i})}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified.getOrCreate(e).set(t,!0)}sharedWithTooManyDevices(e){for(const[n,i]of this.sharedWithDevices){if(!e.has(n))return r.a.log("Starting new megolm session because we shared with "+n),!0;for(const[s]of i){var t;if(null===(t=e.get(n))||void 0===t||!t.get(s))return r.a.log("Starting new megolm session because we shared with "+n+":"+s),!0}}return!1}}class b extends c.e{constructor(e){var t,n,i,o;super(e),s()(this,"setupPromise",Promise.resolve(null)),s()(this,"outboundSessions",{}),s()(this,"sessionRotationPeriodMsgs",void 0),s()(this,"sessionRotationPeriodMs",void 0),s()(this,"encryptionPreparation",void 0),s()(this,"roomId",void 0),s()(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=r.a.withPrefix(`[${this.roomId} encryption]`),this.sessionRotationPeriodMsgs=null!==(t=null===(n=e.config)||void 0===n?void 0:n.rotation_period_msgs)&&void 0!==t?t:100,this.sessionRotationPeriodMs=null!==(i=null===(o=e.config)||void 0===o?void 0:o.rotation_period_ms)&&void 0!==i?i:6048e5}async ensureOutboundSession(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const s=this.setupPromise.then((async s=>{const o=g(e),r=await this.prepareSession(t,o,s);return await this.shareSession(t,o,i,n,r),r}));return this.setupPromise=s.catch((e=>(this.prefixedLogger.error("Failed to setup outbound session",e),null))),s}async prepareSession(e,t,n){var i,s;return n&&t!==n.sharedHistory&&(n=null),null!==(i=n)&&void 0!==i&&i.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(this.prefixedLogger.log("Starting new megolm session because we need to rotate."),n=null),null!==(s=n)&&void 0!==s&&s.sharedWithTooManyDevices(e)&&(n=null),n||(this.prefixedLogger.log("Starting new megolm session"),n=await this.prepareNewSession(t),this.prefixedLogger.log(`Started new megolm session ${n.sessionId}`),this.outboundSessions[n.sessionId]=n),n}async shareSession(e,t,n,i,s){const o={};for(const[t,n]of e)for(const[e,i]of n){var r;i.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(null!==(r=s.sharedWithDevices.get(t))&&void 0!==r&&r.get(e)||(o[t]=o[t]||[],o[t].push(i)))}const c=this.olmDevice.getOutboundGroupSessionKey(s.sessionId),l={type:"m.room_key",content:{algorithm:a.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:s.sessionId,session_key:c.key,chain_index:c.chain_index,"org.matrix.msc3061.shared_history":t}},[d,u]=await a.getExistingOlmSessions(this.olmDevice,this.baseApis,o);await Promise.all([(async()=>{const e=Array.from(u.entries()).map((e=>{let[t,n]=e;return Array.from(n.entries()).map((e=>{let[n,i]=e;return`${t}/${n}: ${i.sessionId}`}))})).flat(1);this.prefixedLogger.debug("Sharing keys with devices with existing Olm sessions:",e),await this.shareKeyWithOlmSessions(s,c,l,u),this.prefixedLogger.debug("Shared keys with existing Olm sessions")})(),(async()=>{const e=Array.from(d.entries()).map((e=>{let[t,n]=e;return n.map((e=>`${t}/${e.deviceId}`))})).flat(1);this.prefixedLogger.debug("Sharing keys (start phase 1) with devices without existing Olm sessions:",e);const t=[],i=Date.now(),o=[];await this.shareKeyWithDevices(s,c,l,d,t,n?1e4:2e3,o),this.prefixedLogger.debug("Shared keys (end phase 1) with devices without existing Olm sessions"),!n&&Date.now()-i<1e4?(async()=>{const e=new h.b((()=>[])),n=new Set;for(const e of o)n.add(e);const i=[];for(const{userId:s,deviceInfo:o}of t){const t=s.slice(s.indexOf(":")+1);n.has(t)?e.getOrCreate(s).push(o):i.push({userId:s,deviceInfo:o})}const r=Array.from(e.entries()).map((e=>{let[t,n]=e;return n.map((e=>`${t}/${e.deviceId}`))})).flat(1);r.length>0&&(this.prefixedLogger.debug("Sharing keys (start phase 2) with devices without existing Olm sessions:",r),await this.shareKeyWithDevices(s,c,l,e,i,3e4),this.prefixedLogger.debug("Shared keys (end phase 2) with devices without existing Olm sessions")),await this.notifyFailedOlmDevices(s,c,i)})():await this.notifyFailedOlmDevices(s,c,t)})(),(async()=>{this.prefixedLogger.debug(`There are ${i.size} blocked devices:`,Array.from(i.entries()).map((e=>{let[t,n]=e;return Array.from(n.entries()).map((e=>{let[n,i]=e;return`${t}/${n}`}))})).flat(1));const e=new h.b((()=>new Map));let t=0;for(const[o,r]of i)for(const[i,a]of r){var n;void 0===(null===(n=s.blockedDevicesNotified.get(o))||void 0===n?void 0:n.get(i))&&(e.getOrCreate(o).set(i,{device:a}),t++)}t&&(this.prefixedLogger.debug(`Notifying ${t} newly blocked devices:`,Array.from(e.entries()).map((e=>{let[t,n]=e;return Object.entries(n).map((e=>{let[n,i]=e;return`${t}/${n}`}))})).flat(1)),await this.notifyBlockedDevices(s,e),this.prefixedLogger.debug(`Notified ${t} newly blocked devices`))})()])}async prepareNewSession(e){const t=this.olmDevice.createOutboundGroupSession(),n=this.olmDevice.getOutboundGroupSessionKey(t);return await this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],t,n.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,t),new f(t,e)}getDevicesWithoutSessions(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];for(const[i,s]of t){const t=e.get(i);for(const e of s){const s=e.deviceId,o=null==t?void 0:t.get(s);null!=o&&o.sessionId||(n.push({userId:i,deviceInfo:e}),null==t||t.delete(s))}}return n}splitDevices(e){let t=[];const n=[t];for(const[i,s]of e){for(const e of s.values())t.push({userId:i,deviceInfo:e.device});t.length>20&&(t=[],n.push(t))}return 0===t.length&&n.pop(),n}encryptAndSendKeysToDevices(e,t,n,i){return this.crypto.encryptAndSendToDevices(n,i).then((()=>{for(const i of n)e.markSharedWithDevice(i.userId,i.deviceInfo.deviceId,i.deviceInfo.getIdentityKey(),t)})).catch((e=>{throw this.prefixedLogger.error("failed to encryptAndSendToDevices",e),e}))}async sendBlockedNotificationsToDevices(e,t,n){const i=new h.b((()=>new Map));for(const e of t){const t=e.userId,s=e.deviceInfo,r=s.deviceInfo.deviceId,a=p(p({},n),{},{code:s.code,reason:s.reason,[d.k]:Object(o.v4)()});"m.no_olm"===a.code&&(delete a.room_id,delete a.session_id),i.getOrCreate(t).set(r,a)}await this.baseApis.sendToDevice("m.room_key.withheld",i);for(const[t,n]of i)for(const i of n.keys())e.markNotifiedBlockedDevice(t,i)}async reshareKeyWithDevice(e,t,n,i){var s;const r=this.outboundSessions[t];if(!r)return void this.prefixedLogger.debug(`megolm session ${e}|${t} not found: not re-sharing keys`);if(!r.sharedWithDevices.has(n))return void this.prefixedLogger.debug(`megolm session ${e}|${t} never shared with user ${n}`);const c=null===(s=r.sharedWithDevices.get(n))||void 0===s?void 0:s.get(i.deviceId);if(void 0===c)return void this.prefixedLogger.debug(`megolm session ${e}|${t} never shared with device ${n}:${i.deviceId}`);if(c.deviceKey!==i.getIdentityKey())return void this.prefixedLogger.warn(`Megolm session ${e}|${t} has been shared with device ${i.deviceId} but with identity key ${c.deviceKey}. Key is now ${i.getIdentityKey()}!`);const l=await this.olmDevice.getInboundGroupSessionKey(this.roomId,e,t,c.messageIndex);if(!l)return void this.prefixedLogger.warn(`No inbound session key found for megolm session ${e}|${t}: not re-sharing keys`);await a.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[n,[i]]]));const u={type:"m.forwarded_room_key",content:{algorithm:a.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:t,session_key:l.key,chain_index:l.chain_index,sender_key:e,sender_claimed_ed25519_key:l.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:l.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":l.shared_history||!1}},h={algorithm:a.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.k]:Object(o.v4)()};await a.encryptMessageForDevice(h.ciphertext,this.userId,this.deviceId,this.olmDevice,n,i,u),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[n,new Map([[i.deviceId,h]])]])),this.prefixedLogger.debug(`Re-shared key for megolm session ${e}|${t} with ${n}:${i.deviceId}`)}async shareKeyWithDevices(e,t,n,i,s,o,r){const c=await a.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,i,!1,o,r,this.prefixedLogger);this.getDevicesWithoutSessions(c,i,s),await this.shareKeyWithOlmSessions(e,t,n,c)}async shareKeyWithOlmSessions(e,t,n,i){const s=this.splitDevices(i);for(let i=0;i<s.length;i++){const o=`megolm keys for ${e.sessionId} (slice ${i+1}/${s.length})`;try{this.prefixedLogger.debug(`Sharing ${o}`,s[i].map((e=>`${e.userId}/${e.deviceInfo.deviceId}`))),await this.encryptAndSendKeysToDevices(e,t.chain_index,s[i],n),this.prefixedLogger.debug(`Shared ${o}`)}catch(e){throw this.prefixedLogger.error(`Failed to share ${o}`),e}}}async notifyFailedOlmDevices(e,t,n){this.prefixedLogger.debug(`Notifying ${n.length} devices we failed to create Olm sessions`);for(const{userId:i,deviceInfo:s}of n){const n=s.deviceId;e.markSharedWithDevice(i,n,s.getIdentityKey(),t.chain_index)}const i=await this.olmDevice.filterOutNotifiedErrorDevices(n);this.prefixedLogger.debug(`Need to notify ${i.length} failed devices which haven't been notified before`);const s=new h.b((()=>new Map));for(const{userId:e,deviceInfo:t}of i)s.getOrCreate(e).set(t.deviceId,{device:{code:"m.no_olm",reason:l.b["m.no_olm"],deviceInfo:t}});await this.notifyBlockedDevices(e,s),this.prefixedLogger.debug(`Notified ${i.length} devices we failed to create Olm sessions`)}async notifyBlockedDevices(e,t){const n={room_id:this.roomId,session_id:e.sessionId,algorithm:a.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key},i=this.splitDevices(t);for(let t=0;t<i.length;t++)try{await this.sendBlockedNotificationsToDevices(e,i[t],n),this.prefixedLogger.log(`Completed blacklist notification for ${e.sessionId} (slice ${t+1}/${i.length})`)}catch(n){throw this.prefixedLogger.log(`blacklist notification for ${e.sessionId} (slice ${t+1}/${i.length}) failed`),n}}prepareToEncrypt(e){if(e.roomId!==this.roomId)throw new Error("MegolmEncryption.prepareToEncrypt called on unexpected room");if(null!=this.encryptionPreparation){const e=Date.now()-this.encryptionPreparation.startTime;return this.prefixedLogger.debug(`Already started preparing to encrypt for this room ${e}ms ago, skipping`),this.encryptionPreparation.cancel}this.prefixedLogger.debug("Preparing to encrypt events");let t=!1;const n=()=>t;return this.encryptionPreparation={startTime:Date.now(),promise:(async()=>{try{const t=await this.getDevicesInRoom(e,!1,n);if(null===t)return;const[i,s]=t;this.crypto.globalErrorOnUnknownDevices&&this.removeUnknownDevices(i),this.prefixedLogger.debug("Ensuring outbound megolm session"),await this.ensureOutboundSession(e,i,s,!0),this.prefixedLogger.debug("Ready to encrypt events")}catch(e){this.prefixedLogger.error("Failed to prepare to encrypt events",e)}finally{delete this.encryptionPreparation}})(),cancel:()=>{t=!0,delete this.encryptionPreparation}},this.encryptionPreparation.cancel}async encryptMessage(e,t,n){if(this.prefixedLogger.log("Starting to encrypt event"),null!=this.encryptionPreparation)try{await this.encryptionPreparation.promise}catch(e){}const i=this.isVerificationEvent(t,n),[s,o]=await this.getDevicesInRoom(e,i);this.crypto.globalErrorOnUnknownDevices&&this.checkForUnknownDevices(s);const r=await this.ensureOutboundSession(e,s,o),c={room_id:this.roomId,type:t,content:n},l=this.olmDevice.encryptGroupMessage(r.sessionId,JSON.stringify(c)),d={algorithm:a.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:l,session_id:r.sessionId,device_id:this.deviceId};return r.useCount++,d}isVerificationEvent(e,t){switch(e){case d.b.KeyVerificationCancel:case d.b.KeyVerificationDone:case d.b.KeyVerificationMac:case d.b.KeyVerificationStart:case d.b.KeyVerificationKey:case d.b.KeyVerificationReady:case d.b.KeyVerificationAccept:return!0;case d.b.RoomMessage:return t.msgtype===d.e.KeyVerificationRequest;default:return!1}}forceDiscardSession(){this.setupPromise=this.setupPromise.then((()=>null))}checkForUnknownDevices(e){const t=new h.b((()=>new Map));for(const[n,i]of e)for(const[e,s]of i)s.isUnverified()&&!s.isKnown()&&t.getOrCreate(n).set(e,s);if(t.size)throw new c.f("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(const[t,n]of e){for(const[e,t]of n)t.isUnverified()&&!t.isKnown()&&n.delete(e);0===n.size&&e.delete(t)}}async getDevicesInRoom(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;const i=await e.getEncryptionTargetMembers();this.prefixedLogger.debug(`Encrypting for users (shouldEncryptForInvitedMembers: ${e.shouldEncryptForInvitedMembers()}):`,i.map((e=>`${e.userId} (${e.membership})`)));const s=i.map((function(e){return e.userId}));let o=this.crypto.globalBlacklistUnverifiedDevices;const r=e.getBlacklistUnverifiedDevices();"boolean"==typeof r&&(o=r);const a=await this.crypto.downloadKeys(s,!1);if(!0===(null==n?void 0:n()))return null;const c=new h.b((()=>new Map));for(const[e,i]of a)for(const[s,r]of i){if(void 0!==n&&await Object(h.s)(),!0===(null==n?void 0:n()))return null;const a=this.crypto.checkDeviceTrust(e,s);if(r.isBlocked()||!a.isVerified()&&o&&!t){const t=c.getOrCreate(e),n=r.isBlocked();t.set(s,{code:n?"m.blacklisted":"m.unverified",reason:l.b[n?"m.blacklisted":"m.unverified"],deviceInfo:r}),i.delete(s)}}return[a,c]}}class y extends c.b{constructor(e){super(e),s()(this,"pendingEvents",new Map),s()(this,"olmlib",a),s()(this,"roomId",void 0),s()(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=r.a.withPrefix(`[${this.roomId} decryption]`)}async decryptEvent(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new c.c("MEGOLM_MISSING_FIELDS","Missing fields in input");let n;this.addEventToPendingList(e);try{n=await this.olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(n){if("DecryptionError"===n.name)throw n;let i="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw"OLM.UNKNOWN_MESSAGE_INDEX"===(null==n?void 0:n.message)&&(this.requestKeysForEvent(e),i="OLM_UNKNOWN_MESSAGE_INDEX"),new c.c(i,n instanceof Error?n.message:"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===n){this.crypto.backupManager.queryKeyBackupRateLimited(e.getRoomId(),t.session_id).catch((()=>{})),this.requestKeysForEvent(e);const n=await this.olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(n){this.prefixedLogger.info(`When handling UISI from ${e.getSender()} (sender key ${t.sender_key}): recent session problem with that sender:`,n);let i=S[n.type]||S.unknown;throw n.fixed&&(i+=" Trying to create a new secure channel and re-requesting the keys."),new c.c("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",i,{session:t.sender_key+"|"+t.session_id})}throw new c.c("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}n.untrusted||this.removeEventFromPendingList(e);const i=JSON.parse(n.result);if(i.room_id!==e.getRoomId())throw new c.c("MEGOLM_BAD_ROOM","Message intended for room "+i.room_id);return{clearEvent:i,senderCurve25519Key:n.senderKey,claimedEd25519Key:n.keysClaimed.ed25519,forwardingCurve25519KeyChain:n.forwardingCurve25519KeyChain,untrusted:n.untrusted}}requestKeysForEvent(e){const t=e.getWireContent(),n=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},n)}addEventToPendingList(e){var t;const n=e.getWireContent(),i=n.sender_key,s=n.session_id;this.pendingEvents.has(i)||this.pendingEvents.set(i,new Map);const o=this.pendingEvents.get(i);o.has(s)||o.set(s,new Set),null===(t=o.get(s))||void 0===t||t.add(e)}removeEventFromPendingList(e){const t=e.getWireContent(),n=t.sender_key,i=t.session_id,s=this.pendingEvents.get(n),o=null==s?void 0:s.get(i);o&&(o.delete(e),0===o.size&&s.delete(i),0===s.size&&this.pendingEvents.delete(n))}roomKeyFromEvent(e){const t=e.getSenderKey(),n=e.getContent(),i={};if(!(n.room_id&&n.session_key&&n.session_id&&n.algorithm))return void this.prefixedLogger.error("key event is missing fields");if(!a.isOlmEncrypted(e))return void this.prefixedLogger.error("key event not properly encrypted");n["org.matrix.msc3061.shared_history"]&&(i.sharedHistory=!0);return{senderKey:t,sessionId:n.session_id,sessionKey:n.session_key,extraSessionData:i,exportFormat:!1,roomId:n.room_id,algorithm:n.algorithm,forwardingKeyChain:[],keysClaimed:e.getKeysClaimed()}}forwardedRoomKeyFromEvent(e){const t=this.roomKeyFromEvent(e);if(!t)return;const n=e.getSenderKey(),i=e.getContent(),s=this.baseApis.crypto.deviceList.getUserByIdentityKey(a.OLM_ALGORITHM,n),o=i.sender_key,r=i.sender_claimed_ed25519_key;let c=Array.isArray(i.forwarding_curve25519_key_chain)?i.forwarding_curve25519_key_chain:[];if(c=c.slice(),c.push(n),s!==e.getSender())return void this.prefixedLogger.error("sending device does not belong to the user it claims to be from");if(!o)return void this.prefixedLogger.error("forwarded_room_key event is missing sender_key field");if(!r)return void this.prefixedLogger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");const l={ed25519:r};return t.senderKey=o,t.keysClaimed=l,t.exportFormat=!0,t.forwardingKeyChain=c,t.extraSessionData.untrusted=!0,t}async shouldAcceptForwardedKey(e,t){var n;const i=e.getSenderKey(),s=null!==(n=this.crypto.deviceList.getDeviceByIdentityKey(a.OLM_ALGORITHM,i))&&void 0!==n?n:void 0,o=this.crypto.checkDeviceInfoTrust(e.getSender(),s),r=e.getSender()===this.baseApis.getUserId(),c=o.isVerified()&&r,l=await this.wasRoomKeyRequested(e,t),d=this.wasRoomKeyForwardedByInviter(e,t),u=this.wasRoomKeyForwardedAsHistory(t);return l&&c||d&&u}async wasRoomKeyRequested(e,t){return(await this.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e.getSender(),"*",[u.b.Sent])).some((e=>e.requestBody.room_id===t.roomId&&e.requestBody.session_id===t.sessionId))}wasRoomKeyForwardedByInviter(e,t){var n,i,s;const o=this.baseApis.getRoom(t.roomId),r=e.getSenderKey();if(!r)return!1;const c=this.crypto.deviceList.getUserByIdentityKey(a.OLM_ALGORITHM,r);if(!c)return!1;const l=null==o||null===(n=o.getMember(this.userId))||void 0===n?void 0:n.events.member,d=(null==l?void 0:l.getSender())===c||(null==l||null===(i=l.getUnsigned())||void 0===i?void 0:i.prev_sender)===c&&"invite"===(null==l||null===(s=l.getPrevContent())||void 0===s?void 0:s.membership);return!(!o||!d)}wasRoomKeyForwardedAsHistory(e){return!(!this.baseApis.getRoom(e.roomId)||!e.extraSessionData.sharedHistory)}shouldParkForwardedKey(e){return!(this.baseApis.getRoom(e.roomId)||!e.extraSessionData.sharedHistory)}async parkForwardedKey(e,t){const n={senderId:e.getSender(),senderKey:t.senderKey,sessionId:t.sessionId,sessionKey:t.sessionKey,keysClaimed:t.keysClaimed,forwardingCurve25519KeyChain:t.forwardingKeyChain};await this.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],(e=>this.crypto.cryptoStore.addParkedSharedHistory(t.roomId,n,e)),r.a.withPrefix("[addParkedSharedHistory]"))}async addRoomKey(e){try{await this.olmDevice.addInboundGroupSession(e.roomId,e.senderKey,e.forwardingKeyChain,e.sessionId,e.sessionKey,e.keysClaimed,e.exportFormat,e.extraSessionData),await this.retryDecryption(e.senderKey,e.sessionId,!e.extraSessionData.untrusted)&&this.crypto.cancelRoomKeyRequest({algorithm:e.algorithm,room_id:e.roomId,session_id:e.sessionId,sender_key:e.senderKey}),await this.crypto.backupManager.backupGroupSession(e.senderKey,e.sessionId)}catch(e){this.prefixedLogger.error(`Error handling m.room_key_event: ${e}`)}}async onForwardedRoomKey(e){const t=this.forwardedRoomKeyFromEvent(e);t&&(await this.shouldAcceptForwardedKey(e,t)?await this.addRoomKey(t):this.shouldParkForwardedKey(t)&&await this.parkForwardedKey(e,t))}async onRoomKeyEvent(e){if("m.forwarded_room_key"==e.getType())await this.onForwardedRoomKey(e);else{const t=this.roomKeyFromEvent(e);if(!t)return;await this.addRoomKey(t)}}async onRoomKeyWithheldEvent(e){const t=e.getContent(),n=t.sender_key;"m.no_olm"===t.code?await this.onNoOlmWithheldEvent(e):"m.unavailable"===t.code||await this.olmDevice.addInboundGroupSessionWithheld(t.room_id,n,t.session_id,t.code,t.reason),t.session_id?await this.retryDecryption(n,t.session_id):await this.retryDecryptionFromSender(n)}async onNoOlmWithheldEvent(e){const t=e.getContent(),n=t.sender_key,i=e.getSender();if(this.prefixedLogger.warn(`${i}:${n} was unable to establish an olm session with us`),await this.olmDevice.getSessionIdForDevice(n))return this.prefixedLogger.debug("New session already created.  Not creating a new one."),void await this.olmDevice.recordSessionProblem(n,"no_olm",!0);let s=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,n);if(!s&&(await this.crypto.downloadKeys([i],!1),s=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,n),!s))return this.prefixedLogger.info("Couldn't find device for identity key "+n+": not establishing session"),void await this.olmDevice.recordSessionProblem(n,"no_olm",!1);await a.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[i,[s]]]),!1);const r={algorithm:a.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.k]:Object(o.v4)()};await a.encryptMessageForDevice(r.ciphertext,this.userId,void 0,this.olmDevice,i,s,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(n,"no_olm",!0),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[i,new Map([[s.deviceId,r]])]]))}hasKeysForKeyRequest(e){const t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){const t=e.userId,n=e.deviceId,i=this.crypto.getStoredDevice(t,n),s=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[t,[i]]])).then((e=>{var i;const o=null===(i=e.get(t))||void 0===i?void 0:i.get(n);return null!=o&&o.sessionId?(this.prefixedLogger.log("sharing keys for session "+s.sender_key+"|"+s.session_id+" with device "+t+":"+n),this.buildKeyForwardingMessage(s.room_id,s.sender_key,s.session_id)):null})).then((e=>{const s={algorithm:a.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.k]:Object(o.v4)()};return this.olmlib.encryptMessageForDevice(s.ciphertext,this.userId,void 0,this.olmDevice,t,i,e).then((()=>this.baseApis.sendToDevice("m.room.encrypted",new Map([[t,new Map([[n,s]])]]))))}))}async buildKeyForwardingMessage(e,t,n){const i=await this.olmDevice.getInboundGroupSessionKey(e,t,n);return{type:"m.forwarded_room_key",content:{algorithm:a.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:i.sender_claimed_ed25519_key,session_id:n,session_key:i.key,chain_index:i.chain_index,forwarding_curve25519_key_chain:i.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":i.shared_history||!1}}}importRoomKey(e){let{untrusted:t,source:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i={};return(t||e.untrusted)&&(i.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(i.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,i).then((()=>{"backup"!==n&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch((e=>{this.prefixedLogger.log("Failed to back up megolm session",e)})),this.retryDecryption(e.sender_key,e.session_id,!i.untrusted)}))}async retryDecryption(e,t,n){var i;const s=this.pendingEvents.get(e);if(!s)return!0;const o=s.get(t);if(!o)return!0;const r=[...o];return this.prefixedLogger.debug("Retrying decryption on events:",r.map((e=>`${e.getId()}`))),await Promise.all(r.map((async e=>{try{await e.attemptDecryption(this.crypto,{isRetry:!0,forceRedecryptIfUntrusted:n})}catch(e){}}))),!(null!==(i=this.pendingEvents.get(e))&&void 0!==i&&i.has(t))}async retryDecryptionFromSender(e){const t=this.pendingEvents.get(e);return!t||(this.pendingEvents.delete(e),await Promise.all([...t].map((async e=>{let[t,n]=e;await Promise.all([...n].map((async e=>{try{await e.attemptDecryption(this.crypto)}catch(e){}})))}))),!this.pendingEvents.has(e))}async sendSharedHistoryInboundSessions(e){await a.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,e);const t=await this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);this.prefixedLogger.log(`Sharing history in with users ${Array.from(e.keys())}`,t.map((e=>{let[t,n]=e;return`${t}|${n}`})));for(const[n,i]of t){const t=await this.buildKeyForwardingMessage(this.roomId,n,i),s=[],r=new Map;for(const[n,i]of e){const e=new Map;r.set(n,e);for(const r of i){const i={algorithm:a.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.k]:Object(o.v4)()};e.set(r.deviceId,i),s.push(a.encryptMessageForDevice(i.ciphertext,this.userId,void 0,this.olmDevice,n,r,t))}}await Promise.all(s);for(const[e,t]of r){for(const[n,i]of t)v(i)||(this.prefixedLogger.log("No ciphertext for device "+e+":"+n+": pruning"),t.delete(n));0===t.size&&(this.prefixedLogger.log("Pruned all devices for user "+e),r.delete(e))}if(0===r.size)return void this.prefixedLogger.log("No users left to send to: aborting");await this.baseApis.sendToDevice("m.room.encrypted",r)}}}const S={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};Object(c.g)(a.MEGOLM_ALGORITHM,b,y)},function(e,t,n){"use strict";n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return h}));var i=n(13),s=n.n(i),o=n(366),r=n(1),a=n(130),c=n(16);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let u;!function(e){e[e.Unsent=0]="Unsent",e[e.Sent=1]="Sent",e[e.CancellationPending=2]="CancellationPending",e[e.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend"}(u||(u={}));class h{constructor(e,t,n){this.baseApis=e,this.deviceId=t,this.cryptoStore=n,s()(this,"sendOutgoingRoomKeyRequestsTimer",void 0),s()(this,"sendOutgoingRoomKeyRequestsRunning",!1),s()(this,"clientRunning",!0)}stop(){r.a.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}async queueRoomKeyRequest(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=await this.cryptoStore.getOutgoingRoomKeyRequest(e);if(i)switch(i.state){case u.CancellationPendingAndWillResend:case u.Unsent:return;case u.CancellationPending:{const e=n?u.CancellationPendingAndWillResend:u.Sent;await this.cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,u.CancellationPending,{state:e,cancellationTxnId:this.baseApis.makeTxnId()});break}case u.Sent:if(n){const s=u.CancellationPendingAndWillResend,o=await this.cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,u.Sent,{state:s,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!o)return this.queueRoomKeyRequest(e,t,n);try{await this.sendOutgoingRoomKeyRequestCancellation(o,!0)}catch(e){r.a.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw new Error("unhandled state: "+i.state)}else await this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this.baseApis.makeTxnId(),state:u.Unsent})}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then((t=>{if(t)switch(t.state){case u.CancellationPending:case u.CancellationPendingAndWillResend:return;case u.Unsent:return r.a.log("deleting unnecessary room key request for "+m(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,u.Unsent);case u.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,u.Sent,{state:u.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then((t=>{t?this.sendOutgoingRoomKeyRequestCancellation(t).catch((e=>{r.a.error("Error sending room key request cancellation; will retry later.",e),this.startTimer()})):r.a.log("Tried to cancel room key request for "+m(e)+" but it was already cancelled in another tab")}));default:throw new Error("unhandled state: "+t.state)}}))}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[u.Sent])}async cancelAndResendAllOutgoingRequests(){const e=await this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(u.Sent);return Promise.all(e.map((e=>{let{requestBody:t,recipients:n}=e;return this.queueRoomKeyRequest(t,n,!0)})))}startTimer(){if(this.sendOutgoingRoomKeyRequestsTimer)return;this.sendOutgoingRoomKeyRequestsTimer=setTimeout((()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally((()=>{this.sendOutgoingRoomKeyRequestsRunning=!1})).catch((e=>{r.a.warn(`error in OutgoingRoomKeyRequestManager: ${e}`)}))}),500)}async sendOutgoingRoomKeyRequests(){if(!this.clientRunning)return void(this.sendOutgoingRoomKeyRequestsTimer=void 0);const e=await this.cryptoStore.getOutgoingRoomKeyRequestByState([u.CancellationPending,u.CancellationPendingAndWillResend,u.Unsent]);if(e)try{switch(e.state){case u.Unsent:await this.sendOutgoingRoomKeyRequest(e);break;case u.CancellationPending:await this.sendOutgoingRoomKeyRequestCancellation(e);break;case u.CancellationPendingAndWillResend:await this.sendOutgoingRoomKeyRequestCancellation(e,!0)}return this.sendOutgoingRoomKeyRequests()}catch(e){r.a.error("Error sending room key request; will retry later.",e),this.sendOutgoingRoomKeyRequestsTimer=void 0}else this.sendOutgoingRoomKeyRequestsTimer=void 0}sendOutgoingRoomKeyRequest(e){r.a.log(`Requesting keys for ${m(e.requestBody)} from ${p(e.recipients)}(id ${e.requestId})`);const t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then((()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,u.Unsent,{state:u.Sent})))}sendOutgoingRoomKeyRequestCancellation(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];r.a.log(`Sending cancellation for key request for ${m(e.requestBody)} to ${p(e.recipients)} (cancellation id ${e.cancellationTxnId})`);const n={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(n,e.recipients,e.cancellationTxnId).then((()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,u.CancellationPendingAndWillResend,{state:u.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,u.CancellationPending)))}sendMessageToDevices(e,t,n){const i=new c.b((()=>new Map));for(const n of t){i.getOrCreate(n.userId).set(n.deviceId,d(d({},e),{},{[a.k]:Object(o.v4)()}))}return this.baseApis.sendToDevice(a.b.RoomKeyRequest,i,n)}}function m(e){return e.room_id+" / "+e.session_id}function p(e){return`[${e.map((e=>`${e.userId}:${e.deviceId}`)).join(",")}]`}},function(e,t,n){"use strict";function i(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";(function(e,i){n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return g}));var s=n(13),o=n.n(s),r=n(426),a=n.n(r),c=n(200),l=n(227),d=n(327),u=n(1),h=n(196);const m="org.matrix.msc2697.v1.olm.libolm_pickle",p=6048e5;class g{constructor(e){this.crypto=e,o()(this,"inProgress",!1),o()(this,"timeoutId",void 0),o()(this,"key",void 0),o()(this,"keyInfo",void 0),o()(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){return this.crypto.cryptoStore.doTxn("readonly",[l.a.STORE_ACCOUNT],(t=>{this.crypto.cryptoStore.getSecretStorePrivateKey(t,(async t=>{if(t){const{key:n,keyInfo:s,deviceDisplayName:o,time:r}=t,a=e.from(this.crypto.olmDevice.pickleKey),l=await Object(d.b)(n,a,m);this.key=Object(c.decodeBase64)(l),this.keyInfo=s,this.deviceDisplayName=o;const u=Date.now(),h=Math.max(1,r+p-u);this.timeoutId=i.setTimeout(this.dehydrateDevice.bind(this),h)}}),"dehydration")}))}async setKeyAndQueueDehydration(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;await this.setKey(e,t,n)||this.dehydrateDevice()}async setKey(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;if(!e)return this.timeoutId&&(i.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[l.a.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)})),this.key=void 0,void(this.keyInfo=void 0);let s=!!this.key&&e.length==this.key.length;for(let t=0;s&&t<e.length;t++)e[t]!=this.key[t]&&(s=!1);return s||(this.key=e,this.keyInfo=t,this.deviceDisplayName=n),s}async dehydrateDevice(){if(this.inProgress)u.a.log("Dehydration already in progress -- not starting new dehydration");else{this.inProgress=!0,this.timeoutId&&(i.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const t=e.from(this.crypto.olmDevice.pickleKey),n=await Object(d.c)(Object(c.encodeBase64)(this.key),t,m);await this.crypto.cryptoStore.doTxn("readwrite",[l.a.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:n,deviceDisplayName:this.deviceDisplayName,time:Date.now()})})),u.a.log("Attempting to dehydrate device"),u.a.log("Creating account");const s=new i.Olm.Account;s.create();const o=JSON.parse(s.identity_keys()),r=s.max_number_of_one_time_keys();s.generate_one_time_keys(r/2),s.generate_fallback_key();const g=JSON.parse(s.one_time_keys()),v=JSON.parse(s.fallback_key());s.mark_keys_as_published();const f=s.pickle(new Uint8Array(this.key)),b={algorithm:m,account:f};this.keyInfo.passphrase&&(b.passphrase=this.keyInfo.passphrase),u.a.log("Uploading account to server");const y=(await this.crypto.baseApis.http.authedRequest(h.i.Put,"/dehydrated_device",void 0,{device_data:b,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;u.a.log("Preparing device keys",y);const S={algorithms:this.crypto.supportedAlgorithms,device_id:y,user_id:this.crypto.userId,keys:{[`ed25519:${y}`]:o.ed25519,[`curve25519:${y}`]:o.curve25519}},E=s.sign(a.a.stringify(S));S.signatures={[this.crypto.userId]:{[`ed25519:${y}`]:E}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(S,"self_signing"),u.a.log("Preparing one-time keys");const w={};for(const[e,t]of Object.entries(g.curve25519)){const n={key:t},i=s.sign(a.a.stringify(n));n.signatures={[this.crypto.userId]:{[`ed25519:${y}`]:i}},w[`signed_curve25519:${e}`]=n}u.a.log("Preparing fallback keys");const _={};for(const[e,t]of Object.entries(v.curve25519)){const n={key:t,fallback:!0},i=s.sign(a.a.stringify(n));n.signatures={[this.crypto.userId]:{[`ed25519:${y}`]:i}},_[`signed_curve25519:${e}`]=n}return u.a.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(h.i.Post,"/keys/upload/"+encodeURI(y),void 0,{device_keys:S,one_time_keys:w,"org.matrix.msc2732.fallback_keys":_}),u.a.log("Done dehydrating"),this.timeoutId=i.setTimeout(this.dehydrateDevice.bind(this),p),y}finally{this.inProgress=!1}}}stop(){this.timeoutId&&(i.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}}).call(this,n(53).Buffer,n(14))},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return f}));var i=n(13),s=n.n(i),o=n(149),r=n(1),a=n(200),c=n(431),l=n(16),d=n(227),u=n(432),h=n(327),m=n(15),p=n(175),g=n(428),v=n(196);class f{constructor(e,t){this.baseApis=e,this.getKey=t,s()(this,"algorithm",void 0),s()(this,"backupInfo",void 0),s()(this,"checkedForBackup",void 0),s()(this,"sendingBackups",void 0),s()(this,"sessionLastCheckAttemptedTime",{}),this.checkedForBackup=!1,this.sendingBackups=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){const t=E[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if("object"!=typeof e.auth_data)throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){const n=E[e.algorithm];if(!n)throw new Error("Unknown backup algorithm");return n.init(e.auth_data,t)}async enableKeyBackup(e){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=await f.makeAlgorithm(e,this.getKey),this.baseApis.emit(p.b.KeyBackupStatus,!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(p.b.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?Boolean(this.algorithm):null}async prepareKeyBackupVersion(e,t){const n=t?E[t]:w;if(!n)throw new Error("Unknown backup algorithm");const[i,s]=await n.prepare(e),o=Object(u.b)(i);return{algorithm:n.algorithmName,auth_data:s,recovery_key:o,privateKey:i}}async createKeyBackupVersion(e){this.algorithm=await f.makeAlgorithm(e,this.getKey)}async checkAndStart(){if(r.a.log("Checking key backup status..."),this.baseApis.isGuest())return r.a.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let e;try{var t;e=null!==(t=await this.baseApis.getKeyBackupVersion())&&void 0!==t?t:void 0}catch(e){return r.a.log("Error checking for active key backup",e),404===e.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const n=await this.isKeyBackupTrusted(e);return n.usable&&!this.backupInfo?(r.a.log(`Found usable key backup v${e.version}: enabling key backups`),await this.enableKeyBackup(e)):!n.usable&&this.backupInfo?(r.a.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):n.usable||this.backupInfo?n.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(r.a.log(`On backup version ${this.backupInfo.version} but found version ${e.version}: switching.`),this.disableKeyBackup(),await this.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):r.a.log(`Backup version ${e.version} still current`)):r.a.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:n}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async queryKeyBackupRateLimited(e,t){if(!this.backupInfo)return;const n=(new Date).getTime();(!this.sessionLastCheckAttemptedTime[t]||n-this.sessionLastCheckAttemptedTime[t]>5e3)&&(this.sessionLastCheckAttemptedTime[t]=n,await this.baseApis.restoreKeyBackupWithCache(e,t,this.backupInfo,{}))}async isKeyBackupTrusted(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.signatures))return r.a.info("Key backup is absent or missing required data"),t;const n=this.baseApis.getUserId(),i=await this.baseApis.crypto.getSessionBackupPrivateKey();if(i){let n=null;try{n=await f.makeAlgorithm(e,(async()=>i)),await n.keyMatches(i)&&(r.a.info("Backup is trusted locally"),t.trusted_locally=!0)}catch{}finally{var s;null===(s=n)||void 0===s||s.free()}}const o=e.auth_data.signatures[n]||{};for(const i of Object.keys(o)){const s=i.split(":");if("ed25519"!==s[0]){r.a.log("Ignoring unknown signature type: "+s[0]);continue}const o={deviceId:s[1]},c=this.baseApis.crypto.crossSigningInfo.getId();if(c===o.deviceId){o.crossSigningId=!0;try{await Object(a.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,n,o.deviceId,c),o.valid=!0}catch(e){r.a.warn("Bad signature from cross signing key "+c,e),o.valid=!1}t.sigs.push(o);continue}const l=this.baseApis.crypto.deviceList.getStoredDevice(n,o.deviceId);if(l){o.device=l,o.deviceTrust=this.baseApis.checkDeviceTrust(n,o.deviceId);try{await Object(a.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,n,l.deviceId,l.getFingerprint()),o.valid=!0}catch(t){r.a.info("Bad signature from key ID "+i+" userID "+this.baseApis.getUserId()+" device ID "+l.deviceId+" fingerprint: "+l.getFingerprint(),e.auth_data,t),o.valid=!1}}else o.valid=null,r.a.info("Ignoring signature from unknown key "+i);t.sigs.push(o)}return t.usable=t.sigs.some((e=>{var t;return e.valid&&(e.device&&(null===(t=e.deviceTrust)||void 0===t?void 0:t.isVerified())||e.crossSigningId)})),t}async scheduleKeyBackupSend(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4;if(!this.sendingBackups){this.sendingBackups=!0;try{const t=Math.random()*e;await Object(l.N)(t);let n=0;for(;;){if(!this.algorithm)return;try{if(0===await this.backupPendingKeys(200))return;n=0}catch(e){if(n++,r.a.log("Key backup request failed",e),e.data&&("M_NOT_FOUND"==e.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==e.data.errcode))throw await this.checkKeyBackup(),this.baseApis.crypto.emit(p.b.KeyBackupFailed,e.data.errcode),e}n&&await Object(l.N)(1e3*Math.pow(2,Math.min(n-1,4)))}}finally{this.sendingBackups=!1}}}async backupPendingKeys(e){const t=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let n=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit(p.b.KeyBackupSessionsRemaining,n);const i={};for(const e of t){var s;const t=e.sessionData.room_id;Object(l.L)(i,t,i[t]||{sessions:{}});const n=this.baseApis.crypto.olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);n.algorithm=a.MEGOLM_ALGORITHM;const o=(n.forwarding_curve25519_key_chain||[]).length,r=this.baseApis.crypto.deviceList.getUserByIdentityKey(a.MEGOLM_ALGORITHM,e.senderKey),c=null!==(s=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(a.MEGOLM_ALGORITHM,e.senderKey))&&void 0!==s?s:void 0,d=this.baseApis.crypto.checkDeviceInfoTrust(r,c).isVerified();Object(l.L)(i[t].sessions,e.sessionId,{first_message_index:n.first_known_index,forwarded_count:o,is_verified:d,session_data:await this.algorithm.encryptSession(n)})}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:i}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(t),n=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit(p.b.KeyBackupSessionsRemaining,n),t.length}async backupGroupSession(e,t){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[d.a.STORE_INBOUND_GROUP_SESSIONS,d.a.STORE_BACKUP],(e=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(e,(t=>{null!==t&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([t],e)}))}));const e=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit(p.b.KeyBackupSessionsRemaining,e),e}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}class b{constructor(e,t,n){this.authData=e,this.publicKey=t,this.getKey=n}static async init(t,n){if(!t||!("public_key"in t))throw new Error("auth_data missing required information");const i=new e.Olm.PkEncryption;return i.set_recipient_key(t.public_key),new b(t,i,n)}static async prepare(t){const n=new e.Olm.PkDecryption;try{const i={};if(t)if(t instanceof Uint8Array)i.public_key=n.init_with_private_key(t);else{const e=await Object(c.c)(t);i.private_key_salt=e.salt,i.private_key_iterations=e.iterations,i.public_key=n.init_with_private_key(e.key)}else i.public_key=n.generate_key();return(new e.Olm.PkEncryption).set_recipient_key(i.public_key),[n.get_private_key(),i]}finally{n.free()}}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}async encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}async decryptSessions(t){const n=await this.getKey(),i=new e.Olm.PkDecryption;try{if(i.init_with_private_key(n)!==this.authData.public_key)throw new v.f({errcode:o.d.RESTORE_BACKUP_ERROR_BAD_KEY});const e=[];for(const[n,s]of Object.entries(t))try{const t=JSON.parse(i.decrypt(s.session_data.ephemeral,s.session_data.mac,s.session_data.ciphertext));t.session_id=n,e.push(t)}catch(e){r.a.log("Failed to decrypt megolm session from backup",e,s)}return e}finally{i.free()}}async keyMatches(t){const n=new e.Olm.PkDecryption;let i;try{i=n.init_with_private_key(t)}finally{n.free()}return i===this.authData.public_key}free(){this.publicKey.free()}}s()(b,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");const y=new m.c("m.megolm_backup.v1.aes-hmac-sha2","org.matrix.msc3270.v1.aes-hmac-sha2");class S{constructor(e,t){this.authData=e,this.key=t}static async init(e,t){if(!e)throw new Error("auth_data missing");const n=await t();if(e.mac){const{mac:t}=await Object(h.a)(n,e.iv);if(e.mac.replace(/=+$/g,"")!==t.replace(/=+/g,""))throw new Error("Key does not match")}return new S(e,n)}static async prepare(e){let t;const n={};if(e)if(e instanceof Uint8Array)t=new Uint8Array(e);else{const i=await Object(c.c)(e);n.private_key_salt=i.salt,n.private_key_iterations=i.iterations,t=i.key}else t=function(e){const t=new Uint8Array(e);return g.b.getRandomValues(t),t}(32);const{iv:i,mac:s}=await Object(h.a)(t);return n.iv=i,n.mac=s,[t,n]}static checkBackupVersion(e){if(!("iv"in e.auth_data)||!("mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,Object(h.c)(JSON.stringify(t),this.key,e.session_id)}async decryptSessions(e){const t=[];for(const[n,i]of Object.entries(e))try{const e=JSON.parse(await Object(h.b)(i.session_data,this.key,n));e.session_id=n,t.push(e)}catch(e){r.a.log("Failed to decrypt megolm session from backup",e,i)}return t}async keyMatches(e){if(this.authData.mac){const{mac:t}=await Object(h.a)(e,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===t.replace(/=+/g,"")}return!0}free(){this.key.fill(0)}}s()(S,"algorithmName",y.name);const E={[b.algorithmName]:b,[S.algorithmName]:S},w=b}).call(this,n(14))},function(e,t,n){"use strict";n.d(t,"a",(function(){return E}));var i=n(13),s=n.n(i),o=n(141),r=n(1),a=n(16),c=n(180),l=n(149),d=n(219),u=n(196),h=n(526),m=n(130),p=n(152),g=n(186);class v{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return h.a.PreProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){if(e.device_lists&&await this.crypto.handleDeviceListChanges({oldSyncToken:"yep"},e.device_lists),e.device_one_time_keys_count){const t=e.device_one_time_keys_count.signed_curve25519||0;this.crypto.updateOneTimeKeyCount(t)}if(e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]){const t=e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"];this.crypto.setNeedsNewFallback(Array.isArray(t)&&!t.includes("signed_curve25519"))}this.crypto.onSyncCompleted({})}}class f{constructor(e,t){this.client=e,this.cryptoCallbacks=t,s()(this,"nextBatch",null)}name(){return"to_device"}when(){return h.a.PreProcess}onRequest(e){const t={since:null!==this.nextBatch?this.nextBatch:void 0};return e&&(t.limit=100,t.enabled=!0),t}async onResponse(e){const t=[];let n=e.events||[];n.length>0&&this.cryptoCallbacks&&(n=await this.cryptoCallbacks.preprocessToDeviceMessages(n)),n.map(this.client.getEventMapper()).map((e=>{if("m.key.verification.cancel"===e.getType()){const n=e.getContent().transaction_id;n&&t.push(n)}return e})).forEach((e=>{const n=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=n.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){const i=n.transaction_id;t.includes(i)&&e.flagCancelled()}this.client.emit(l.b.ToDeviceEvent,e)}else r.a.log("Ignoring undecryptable to-device event from "+e.getSender())})),this.nextBatch=e.next_batch}}class b{constructor(e){this.client=e}name(){return"account_data"}when(){return h.a.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){e.global&&e.global.length>0&&this.processGlobalAccountData(e.global);for(const t in e.rooms){const n=w(this.client,t,e.rooms[t]),i=this.client.getRoom(t);i?(i.addAccountData(n),n.forEach((e=>{this.client.emit(l.b.Event,e)}))):r.a.warn("got account data for room but room doesn't exist on client:",t)}}processGlobalAccountData(e){const t=w(this.client,void 0,e),n=t.reduce(((e,t)=>(e[t.getType()]=this.client.store.getAccountData(t.getType()),e)),{});this.client.store.storeAccountDataEvents(t),t.forEach((e=>{if(e.getType()===m.b.PushRules){const t=e.getContent();this.client.setPushRules(t)}const t=n[e.getType()];return this.client.emit(l.b.AccountData,e,t),e}))}}class y{constructor(e){this.client=e}name(){return"typing"}when(){return h.a.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){if(null!=e&&e.rooms)for(const t in e.rooms)_(this.client,t,[e.rooms[t]])}}class S{constructor(e){this.client=e}name(){return"receipts"}when(){return h.a.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){if(null!=e&&e.rooms)for(const t in e.rooms)_(this.client,t,[e.rooms[t]])}}class E{constructor(e,t,n,i){this.slidingSync=e,this.client=t,s()(this,"opts",void 0),s()(this,"syncOpts",void 0),s()(this,"syncState",null),s()(this,"syncStateData",void 0),s()(this,"lastPos",null),s()(this,"failCount",0),s()(this,"notifEvents",[]),this.opts=Object(d.d)(n),this.syncOpts=Object(d.e)(i),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[o.d.Timeline,o.d.TimelineReset]),this.slidingSync.on(h.f.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(h.f.RoomData,this.onRoomData.bind(this));const r=[new f(this.client,this.syncOpts.cryptoCallbacks),new b(this.client),new y(this.client),new S(this.client)];this.syncOpts.crypto&&r.push(new v(this.syncOpts.crypto)),r.forEach((e=>{this.slidingSync.registerExtension(e)}))}onRoomData(e,t){let n=this.client.store.getRoom(e);if(!n){if(!t.initial)return void r.a.debug("initial flag not set but no stored room exists for room ",e,t);n=Object(d.c)(this.client,e,this.opts)}this.processRoomData(this.client,n,t)}onLifecycle(e,t,n){switch(n&&r.a.debug("onLifecycle",e,n),e){case h.g.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(d.b.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(d.b.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case h.g.RequestFinished:if(n){if(this.failCount+=1,this.updateSyncState(this.failCount>3?d.b.Error:d.b.Reconnecting,{error:new u.f(n)}),this.shouldAbortSync(new u.f(n)))return}else this.failCount=0}}async syncLeftRooms(){return[]}async peek(e){return null}stopPeeking(){}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}createRoom(e){const{timelineSupport:t}=this.client,n=new o.c(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(n,[o.d.Name,o.d.Redaction,o.d.RedactionCancelled,o.d.Receipt,o.d.Tags,o.d.LocalEchoUpdated,o.d.AccountData,o.d.MyMembership,o.d.Timeline,o.d.TimelineReset]),this.registerStateListeners(n),n}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[p.b.Events,p.b.Members,p.b.NewMember,p.b.Update]),e.currentState.on(p.b.NewMember,((e,t,n)=>{var i;n.user=null!==(i=this.client.getUser(n.userId))&&void 0!==i?i:void 0,this.client.reEmitter.reEmit(n,[g.b.Name,g.b.Typing,g.b.PowerLevel,g.b.Membership])}))}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(r.a.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(d.b.Error,{error:e}),!0)}async processRoomData(e,t,n){n=function(e,t,n){if(!n.name)return n;for(const e of n.required_state)if(e.type===m.b.RoomName&&""===e.state_key)return e.content={name:n.name},n;return n.required_state.push({event_id:"$fake-sliding-sync-name-event-"+t,state_key:"",type:m.b.RoomName,content:{name:n.name},sender:e.getUserId(),origin_server_ts:(new Date).getTime()}),n}(e,t.roomId,n);const i=w(this.client,t.roomId,n.required_state);let s=w(this.client,t.roomId,n.timeline,!1);const r=[];if(n.initial){const e=new Set;t.getLiveTimeline().getEvents().forEach((t=>{e.add(t.getId())}));const i=[],o=[];let r=!1;for(let t=s.length-1;t>=0;t--){const n=s[t];e.has(n.getId())?r=!0:r?i.push(n):o.unshift(n)}s=o,i.length>0&&t.addEventsToTimeline(i,!0,t.getLiveTimeline(),n.prev_batch)}const d=this.client.isRoomEncrypted(t.roomId);if(null!=n.notification_count&&t.setUnreadNotificationCount(o.b.Total,n.notification_count),null!=n.highlight_count&&(!d||d&&t.getUnreadNotificationCount(o.b.Highlight)<=0)&&t.setUnreadNotificationCount(o.b.Highlight,n.highlight_count),Number.isInteger(n.invited_count)&&t.currentState.setInvitedMemberCount(n.invited_count),Number.isInteger(n.joined_count)&&t.currentState.setJoinedMemberCount(n.joined_count),n.invite_state){const e=w(this.client,t.roomId,n.invite_state);return this.injectRoomEvents(t,e),n.initial&&(t.recalculate(),this.client.store.storeRoom(t),this.client.emit(l.b.Room,t)),e.forEach((e=>{this.client.emit(l.b.Event,e)})),void t.updateMyMembership("invite")}var u;n.initial&&t.getLiveTimeline().setPaginationToken(null!==(u=n.prev_batch)&&void 0!==u?u:null,c.b.BACKWARDS);this.injectRoomEvents(t,i,s,n.num_live),t.addEphemeralEvents(r),t.updateMyMembership("join"),t.recalculate(),n.initial&&(e.store.storeRoom(t),e.emit(l.b.Room,t)),this.addNotifications(s);const h=async n=>{e.emit(l.b.Event,n),n.isState()&&n.getType()==m.b.RoomEncryption&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(t,n)};await a.D(i,h),await a.D(s,h),r.forEach((function(t){e.emit(l.b.Event,t)})),t.decryptCriticalEvents()}injectRoomEvents(e,t,n,i){n=n||[],t=t||[],i=i||0;const s=e.getLiveTimeline(),o=0==s.getEvents().length;if(o){for(const e of t)this.client.getPushActionsForEvent(e);s.initialiseState(t)}o||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));let r=[];i>0&&(r=n.slice(-1*i),n=n.slice(0,-1*r.length)),e.addLiveEvents(n,{fromCache:!0}),r.length>0&&e.addLiveEvents(r,{fromCache:!1}),e.recalculate(),this.resolveInvites(e)}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(n){if(n.requestedProfileInfo)return;n.requestedProfileInfo=!0;const i=t.getUser(n.userId);let s;s=i?Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):t.getProfileInfo(n.userId),s.then((function(t){const i=n.events.member;"invite"===i.getContent().membership&&(i.getContent().avatar_url=t.avatar_url,i.getContent().displayname=t.displayname,n.setMembershipEvent(i,e.currentState))}),(function(e){}))}))}retryImmediately(){return!0}async sync(){for(r.a.debug("Sliding sync init loop");!this.client.isGuest();)try{r.a.debug("Getting push rules...");const e=await this.client.getPushRules();r.a.debug("Got push rules"),this.client.pushRules=e;break}catch(e){if(r.a.error("Getting push rules failed",e),this.shouldAbortSync(e))return}await this.slidingSync.start()}stop(){r.a.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){const n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(l.b.Sync,this.syncState,n,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(const t of e){const e=this.client.getPushActionsForEvent(t);e&&e.notify&&e.tweaks&&e.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((e=>{var t;null===(t=this.client.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e)})),this.notifEvents=[]}}function w(e,t,n){let i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const s=e.getEventMapper({decrypt:i});return n.map((function(e){return e.room_id=t,s(e)}))}function _(e,t,n){const i=w(e,t,n),s=e.getRoom(t);s?(s.addEphemeralEvents(i),i.forEach((t=>{e.emit(l.b.Event,t)}))):r.a.warn("got ephemeral events for room but room doesn't exist on client:",t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i="matrix-js-sdk"},,,,,,,,function(e,t,n){},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(122),s=n.n(i);class o{get action(){return"NOT_USED"}constructor(e){s()(this,"fn",void 0),this.fn=e}}},function(e,t,n){"use strict";n.d(t,"c",(function(){return l})),n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return h}));var i=n(208),s=n(121),o=n(156),r=n(126),a=n(143);const c=()=>{var e;const t=r.b.getValue("MessageComposerInput.ctrlEnterToSend"),n={[a.h.SendMessage]:{default:{key:i.b.ENTER,ctrlOrCmdKey:t},displayName:Object(s.c)("Send message")},[a.h.NewLine]:{default:{key:i.b.ENTER,shiftKey:!t},displayName:Object(s.c)("New line")},[a.h.CompleteAutocomplete]:{default:{key:i.b.ENTER},displayName:Object(s.c)("Complete")},[a.h.ForceCompleteAutocomplete]:{default:{key:i.b.TAB},displayName:Object(s.c)("Force complete")},[a.h.SearchInRoom]:{default:{ctrlOrCmdKey:!0,key:i.b.F},displayName:Object(s.c)("Search (must be enabled)")}};return null!==(e=o.a.get())&&void 0!==e&&e.overrideBrowserShortcuts()&&(n[a.h.SwitchToSpaceByNumber]={default:{ctrlOrCmdKey:!0,key:a.e},displayName:Object(s.c)("Switch to space by number")}),n},l=()=>{var e;const t=null===(e=o.a.get())||void 0===e?void 0:e.overrideBrowserShortcuts();return Object.keys(a.f).filter((e=>{var n,s;return(null===(n=a.f[e])||void 0===n||null===(s=n.controller)||void 0===s||!s.settingDisabled)&&(!(a.i.includes(e)&&!i.a)&&!(a.d.includes(e)&&!t))})).reduce(((e,t)=>(e[t]=a.f[t],e)),{})},d=()=>[...Object.entries(c()),...Object.entries(l())].reduce(((e,t)=>{let[n,i]=t;return e[n]=i,e}),{}),u=e=>{var t;return null===(t=d()[e])||void 0===t?void 0:t.default},h=e=>{var t;const n=null===(t=d()[e])||void 0===t?void 0:t.displayName;return n&&Object(s.a)(n)}},,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(121);class c extends r.a.PureComponent{render(){return r.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",fill:"currentColor",width:this.props.w,height:this.props.h,className:this.props.className,"aria-label":Object(a.a)("Loading..."),role:"progressbar"},r.a.createElement("circle",{transform:"translate(8 0)",cx:"0",cy:"16",r:"0"},r.a.createElement("animate",{attributeName:"r",values:"0; 4; 0; 0",dur:"1.2s",repeatCount:"indefinite",begin:"0",keyTimes:"0;0.2;0.7;1",keySplines:"0.2 0.2 0.4 0.8;0.2 0.6 0.4 0.8;0.2 0.6 0.4 0.8",calcMode:"spline"})),r.a.createElement("circle",{transform:"translate(16 0)",cx:"0",cy:"16",r:"0"},r.a.createElement("animate",{attributeName:"r",values:"0; 4; 0; 0",dur:"1.2s",repeatCount:"indefinite",begin:"0.3",keyTimes:"0;0.2;0.7;1",keySplines:"0.2 0.2 0.4 0.8;0.2 0.6 0.4 0.8;0.2 0.6 0.4 0.8",calcMode:"spline"})),r.a.createElement("circle",{transform:"translate(24 0)",cx:"0",cy:"16",r:"0"},r.a.createElement("animate",{attributeName:"r",values:"0; 4; 0; 0",dur:"1.2s",repeatCount:"indefinite",begin:"0.6",keyTimes:"0;0.2;0.7;1",keySplines:"0.2 0.2 0.4 0.8;0.2 0.6 0.4 0.8;0.2 0.6 0.4 0.8",calcMode:"spline"})))}}s()(c,"defaultProps",{w:32,h:32,className:"mx_Spinner_icon"})},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return c}));var i=n(150),s=n(120),o=n.n(s),r=n(542);let a;function c(e){let{children:t}=e;const[n,c]=Object(s.useReducer)(((e,t)=>{switch(t.type){case a.Add:return[t.value,...e];case a.Remove:return e.length&&Object(i.isEqual)(e[0],t.value)?e.slice(1):e}}),[]);return o.a.createElement(r.a.Provider,{value:{state:n,dispatch:c}},t)}!function(e){e[e.Add=0]="Add",e[e.Remove=1]="Remove"}(a||(a={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(122),s=n.n(i),o=n(212);class r extends o.a{static set matrixClient(e){const t=r._matrixClient;r._matrixClient=e;for(const n of r.instances)n.initMatrixClient(t,e)}constructor(){super(),r.instances.push(this)}get client(){return r._matrixClient}}s()(r,"_matrixClient",void 0),s()(r,"instances",[])},function(e,t,n){"use strict";n.d(t,"c",(function(){return c})),n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return u}));var i=n(1),s=n(325),o=n(235),r=n(212),a=n(123);function c(){const e=new s.a(a.a.get()).getPushRuleById(".m.rule.master");return e?e.enabled&&!e.actions.includes(o.d.Notify):(i.a.warn("No master push rule! Notifications are disabled for this user."),!0)}function l(){let e=n(279);return e.default&&(e=e.default),e}class d extends r.a{getValueOverride(e,t,n,i){return!!l().isPossible()&&(null===n||"default"===i?!c():n)}onChange(e,t,n){l().supportsDesktopNotifications()&&l().setEnabled(n)}}class u extends r.a{getValueOverride(e,t,n){return!!l().isPossible()&&(null===n?!c():n)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i,s,o=n(120);function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},r.apply(this,arguments)}function a(e){return o.createElement("svg",r({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 65.631 67.981",role:"presentation","aria-hidden":!0},e),i||(i=o.createElement("defs",null,o.createElement("filter",{x:-.059,y:-.079,width:1.118,height:1.158,filterUnits:"objectBoundingBox",id:"icon-email-pill-avatar_svg__a"},o.createElement("feOffset",{dy:2,in:"SourceAlpha",result:"shadowOffsetOuter1"}),o.createElement("feGaussianBlur",{stdDeviation:16,in:"shadowOffsetOuter1",result:"shadowBlurOuter1"}),o.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0.473684211 0 0 0 0 1 0 0 0 0.241258741 0",in:"shadowBlurOuter1",result:"shadowMatrixOuter1"}),o.createElement("feMerge",null,o.createElement("feMergeNode",{in:"shadowMatrixOuter1"}),o.createElement("feMergeNode",{in:"SourceGraphic"}))))),s||(s=o.createElement("g",{filter:"url(#icon-email-pill-avatar_svg__a)",transform:"translate(-1493.716 -795.144) scale(3.40907)",fill:"none",fillRule:"evenodd",stroke:"#8BC34A",strokeLinecap:"round",strokeLinejoin:"round"},o.createElement("g",{transform:"translate(441.5 237.5)"},o.createElement("circle",{r:2.286,cy:5.714,cx:6.286}),o.createElement("path",{d:"M8.571 3.429v2.857a1.714 1.714 0 103.429 0v-.572a5.714 5.714 0 10-2.24 4.537"})))))}t.b="img/icon-email-pill-avatar.2068440.svg"},function(e,t,n){"use strict";n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return l}));var i=n(150),s=n(16),o=n(164);const r=(e,t)=>(n,i)=>{var o,r,a,c,l,d,u,h,m,p,g,v;const f=(null!==(o=null===(r=e[n.userId])||void 0===r?void 0:r.score)&&void 0!==o?o:0)+(null!==(a=null===(c=t[n.userId])||void 0===c?void 0:c.score)&&void 0!==a?a:0),b=null!==(l=null===(d=t[n.userId])||void 0===d?void 0:d.numRooms)&&void 0!==l?l:0,y=(null!==(u=null===(h=e[i.userId])||void 0===h?void 0:h.score)&&void 0!==u?u:0)+(null!==(m=null===(p=t[i.userId])||void 0===p?void 0:p.score)&&void 0!==m?m:0),S=null!==(g=null===(v=t[i.userId])||void 0===v?void 0:v.numRooms)&&void 0!==g?g:0;return f===y?b===S?Object(s.h)(n.userId,i.userId):S-b:y-f};function a(e){return e.getRooms().filter((e=>"join"===e.getMyMembership())).filter((e=>!o.a.shared().getUserIdForRoomId(e.roomId))).filter((e=>!Object.keys(e.tags).includes("m.lowpriority")))}function c(e){const t=(new Date).getTime(),n=t-36e5,s=a(e).flatMap((e=>Object(i.takeRight)(e.getLiveTimeline().getEvents(),50))).filter((e=>e.getTs()>n)),o=Object(i.groupBy)(s,(e=>e.getSender()));return Object(i.mapValues)(o,(e=>{if(!e.length)return;const s=Object(i.maxBy)(e,(e=>e.getTs())),o=Math.abs(t-s.getTs()),r=t-n-o;return{lastSpoke:s.getTs(),score:Math.max(1,r/9e5)}}))}function l(e){const t=a(e).filter((e=>e.getJoinedMemberCount()<200)).flatMap((e=>e.getJoinedMembers().map((t=>({member:t,roomSize:e.getJoinedMemberCount()}))))),n=Object(i.groupBy)(t,(e=>{let{member:t}=e;return t.userId}));return Object(i.mapValues)(n,(e=>{if(!e.length)return;const t=200*e.length,n=Object(i.sumBy)(e,(e=>e.roomSize));return{member:Object(i.minBy)(e,(e=>e.roomSize)).member,numRooms:e.length,score:Math.max(0,Math.pow(1-n/t,5))}}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(121);const s=15e3,o=75e3,r=45,a=75,c=23,l=26;function d(e){let t=Date.now()-e;const n=Math.abs(Math.ceil(t/6e4)),d=Math.ceil(n/60),u=Math.ceil(d/24);return t>=0?t<=s?Object(i.a)("a few seconds ago"):t<=o?Object(i.a)("about a minute ago"):n<=r?Object(i.a)("%(num)s minutes ago",{num:n}):n<=a?Object(i.a)("about an hour ago"):d<=c?Object(i.a)("%(num)s hours ago",{num:d}):d<=l?Object(i.a)("about a day ago"):Object(i.a)("%(num)s days ago",{num:u}):(t=Math.abs(t),t<=s?Object(i.a)("a few seconds from now"):t<=o?Object(i.a)("about a minute from now"):n<=r?Object(i.a)("%(num)s minutes from now",{num:n}):n<=a?Object(i.a)("about an hour from now"):d<=c?Object(i.a)("%(num)s hours from now",{num:d}):d<=l?Object(i.a)("about a day from now"):Object(i.a)("%(num)s days from now",{num:u}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(16);function s(e,t){const n=t.getUserId();for(const t of Object.keys(e.getContent()))for(const[s,o]of Object.entries(e.getContent()[t]))if(Object(i.w)(s)&&Object.keys(o||{}).includes(n))return!0;return!1}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i="filter_changed"},,function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const i=["image/jpeg","image/gif","image/png","image/apng","image/webp","image/avif","video/mp4","video/webm","video/ogg","video/quicktime","audio/mp4","audio/webm","audio/aac","audio/mpeg","audio/ogg","audio/wave","audio/wav","audio/x-wav","audio/x-pn-wav","audio/flac","audio/x-flac"];function s(e){return i.includes(e)?e:"application/octet-stream"}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){},,,,function(e,t){},,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(170);const d=["children","label","tooltip"],u=e=>{let{children:t,label:n,tooltip:i}=e,o=r()(e,d);const a=o["aria-label"]||n;return i?c.a.createElement(l.b,s()({},o,{role:"menuitem","aria-label":a,title:i}),t):c.a.createElement(l.a,s()({},o,{role:"menuitem","aria-label":a}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(170);const d=["children","label","active","disabled"],u=e=>{let{children:t,label:n,active:i,disabled:o}=e,a=r()(e,d);return c.a.createElement(l.a,s()({},a,{role:"menuitemcheckbox","aria-checked":i,"aria-disabled":o,disabled:o,"aria-label":n}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(170),d=n(181),u=n(143),h=n(153);const m=["children","label","onChange","onClose"],p=e=>{let{children:t,label:n,onChange:i,onClose:o}=e,a=r()(e,m);const[p,g,v]=Object(l.i)();return c.a.createElement(d.b,s()({},a,{role:"menuitemcheckbox","aria-label":n,onChange:i,onKeyDown:e=>{let t=!0;switch(Object(h.a)().getAccessibilityAction(e)){case u.h.Space:i();break;case u.h.Enter:i(),o();break;default:t=!1}t&&(e.stopPropagation(),e.preventDefault())},onKeyUp:e=>{switch(Object(h.a)().getAccessibilityAction(e)){case u.h.Space:case u.h.Enter:e.stopPropagation(),e.preventDefault()}},onFocus:p,inputRef:v,tabIndex:g?0:-1}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(170),d=n(237),u=n(143),h=n(153);const m=["children","label","onChange","onClose"],p=e=>{let{children:t,label:n,onChange:i,onClose:o}=e,a=r()(e,m);const[p,g,v]=Object(l.i)();return c.a.createElement(d.a,s()({},a,{role:"menuitemradio","aria-label":n,onChange:i,onKeyDown:e=>{let t=!0;switch(Object(h.a)().getAccessibilityAction(e)){case u.h.Space:i();break;case u.h.Enter:i(),o();break;default:t=!1}t&&(e.stopPropagation(),e.preventDefault())},onKeyUp:e=>{switch(Object(h.a)().getAccessibilityAction(e)){case u.h.Enter:case u.h.Space:e.stopPropagation(),e.preventDefault()}},onFocus:p,inputRef:v,tabIndex:g?0:-1}),t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return m}));var i=n(120),s=n.n(i),o=n(188),r=n.n(o),a=n(325),c=n(123),l=n(126),d=n(574),u=n(168);function h(e,t,n){var i;const o=null!==(i=c.a.get().getRoom(t.getRoomId()))&&void 0!==i?i:void 0,m=l.b.getValue("Pill.shouldShowPillAvatar");let p=e[0];for(;p;){let e=!1;if("PRE"===p.tagName||"CODE"===p.tagName||n.includes(p))p=p.nextSibling;else{if("A"===p.tagName&&p.getAttribute("href")){const t=p.getAttribute("href"),i=Object(u.j)(t);if(i&&!i.eventId){const i=document.createElement("span"),a=s.a.createElement(d.b,{url:t,inMessage:!0,room:o,shouldShowPillAvatar:m});r.a.render(a,i),p.parentNode.replaceChild(i,p),n.push(i),e=!0,p=i}}else if(p.nodeType===Node.TEXT_NODE&&!p.parentElement.classList.contains("mx_AtRoomPill")){let e=p;const i=[];for(;null!==e;){const t=d.b.roomNotifPos(e.textContent);let n=null;if(t>-1){let s=e;t>0&&(s=s.splitText(t)),s.textContent.length>d.b.roomNotifLen()&&(n=s.splitText(d.b.roomNotifLen())),i.push(s)}e=n}if(i.length>0){const e=new a.a(c.a.get()),l=e.getPushRuleById(".m.rule.roomnotif");if(l&&e.ruleMatchesEvent(l,t)){for(const e of i){p=e.nextSibling;const t=document.createElement("span"),i=s.a.createElement(d.b,{type:d.a.AtRoomMention,inMessage:!0,room:o,shouldShowPillAvatar:m});r.a.render(i,t),e.parentNode.replaceChild(t,e),n.push(t)}continue}}}p.childNodes&&p.childNodes.length&&!e&&h(p.childNodes,t,n),p=p.nextSibling}}}function m(e){for(const t of e)r.a.unmountComponentAtNode(t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(120),s=n(139),o=n(167);function r(e){let{userId:t="",member:n,forceHistorical:r=!1}=e;const a=Object(i.useContext)(s.b),c=Object(o.b)("useOnlyCurrentProfiles");return Object(i.useMemo)((()=>{const e=[s.a.ThreadsList,s.a.Thread];if(!r&&c||e.includes(a.timelineRenderingType)){var i;const e=null===(i=a.room)||void 0===i?void 0:i.getMember(t);if(e)return e}return n}),[r,n,a.room,a.timelineRenderingType,c,t])}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(120),s=n.n(i);function o(e,t){const n=[];return e.forEach(((i,s)=>{n.push(i,s===e.length-1?null:t)})),s.a.createElement("span",null,n)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return E}));var i,s=n(122),o=n.n(s),r=n(120),a=n.n(r),c=n(189),l=n(796),d=n(798),u=n(157),h=n(128),m=n(121),p=n(147),g=n(140),v=n(124),f=n(135),b=n(275);!function(e){e[e.Topic=0]="Topic",e[e.NewOption=1]="NewOption"}(i||(i={}));const y=2;function S(){return{title:Object(m.a)("Create poll"),actionLabel:Object(m.a)("Create Poll"),canSubmit:!1,question:"",options:Object(p.h)("",y),busy:!1,kind:c.b,autoFocusTarget:i.Topic}}class E extends d.a{constructor(e){super(e),o()(this,"addOptionRef",Object(r.createRef)()),o()(this,"onQuestionChange",(e=>{this.setState({question:e.target.value},(()=>this.checkCanSubmit()))})),o()(this,"onOptionChange",((e,t)=>{const n=Object(p.b)(this.state.options);n[e]=t.target.value,this.setState({options:n},(()=>this.checkCanSubmit()))})),o()(this,"onOptionRemove",(e=>{const t=Object(p.b)(this.state.options);t.splice(e,1),this.setState({options:t},(()=>this.checkCanSubmit()))})),o()(this,"onOptionAdd",(()=>{const e=Object(p.b)(this.state.options);e.push(""),this.setState({options:e,autoFocusTarget:i.NewOption},(()=>{var e,t;null===(e=this.addOptionRef.current)||void 0===e||null===(t=e.scrollIntoView)||void 0===t||t.call(e)}))})),o()(this,"onPollTypeChange",(e=>{this.setState({kind:c.b.matches(e.target.value)?c.b:c.c})})),this.state=e.editingMxEvent?function(e){const t=e.unstableExtensibleEvent;return null!=t&&t.isEquivalentTo(c.e)?{title:Object(m.a)("Edit poll"),actionLabel:Object(m.a)("Done"),canSubmit:!0,question:t.question.text,options:t.answers.map((e=>e.text)),busy:!1,kind:t.kind,autoFocusTarget:i.Topic}:S()}(e.editingMxEvent):S()}checkCanSubmit(){this.setState({canSubmit:!this.state.busy&&this.state.question.trim().length>0&&this.state.options.filter((e=>e.trim().length>0)).length>=2})}createEvent(){const e=l.a.from(this.state.question.trim(),this.state.options.map((e=>e.trim())).filter((e=>!!e)),this.state.kind.name).serialize();return this.props.editingMxEvent?{content:{"m.new_content":e.content,"m.relates_to":{rel_type:"m.replace",event_id:this.props.editingMxEvent.getId()}},type:e.type}:e}submit(){this.setState({busy:!0,canSubmit:!1});const e=this.createEvent();Object(b.a)(this.props.room.roomId,(t=>this.matrixClient.sendEvent(t,this.props.threadId,e.type,e.content)),this.matrixClient).then((()=>this.props.onFinished(!0))).catch((e=>{console.error("Failed to post poll:",e),h.b.createDialog(u.a,{title:Object(m.a)("Failed to post poll"),description:Object(m.a)("Sorry, the poll you tried to create was not posted."),button:Object(m.a)("Try again"),cancelButton:Object(m.a)("Cancel"),onFinished:e=>{e?this.setState({busy:!1,canSubmit:!0}):this.cancel()}})}))}cancel(){this.props.onFinished(!1)}renderContent(){return a.a.createElement("div",{className:"mx_PollCreateDialog"},a.a.createElement("h2",null,Object(m.a)("Poll type")),a.a.createElement(g.a,{element:"select",value:this.state.kind.name,onChange:this.onPollTypeChange},a.a.createElement("option",{key:c.b.name,value:c.b.name},Object(m.a)("Open poll")),a.a.createElement("option",{key:c.c.name,value:c.c.name},Object(m.a)("Closed poll"))),a.a.createElement("p",null,(e=this.state.kind,c.b.matches(e.name)?Object(m.a)("Voters see results as soon as they have voted"):Object(m.a)("Results are only revealed when you end the poll"))),a.a.createElement("h2",null,Object(m.a)("What is your poll question or topic?")),a.a.createElement(g.a,{id:"poll-topic-input",value:this.state.question,maxLength:340,label:Object(m.a)("Question or topic"),placeholder:Object(m.a)("Write something…"),onChange:this.onQuestionChange,usePlaceholderAsHint:!0,disabled:this.state.busy,autoFocus:this.state.autoFocusTarget===i.Topic}),a.a.createElement("h2",null,Object(m.a)("Create options")),this.state.options.map(((e,t)=>a.a.createElement("div",{key:`option_${t}`,className:"mx_PollCreateDialog_option"},a.a.createElement(g.a,{id:`pollcreate_option_${t}`,value:e,maxLength:340,label:Object(m.a)("Option %(number)s",{number:t+1}),placeholder:Object(m.a)("Write an option"),onChange:e=>this.onOptionChange(t,e),usePlaceholderAsHint:!0,disabled:this.state.busy,autoFocus:this.state.autoFocusTarget===i.NewOption&&t===this.state.options.length-1}),a.a.createElement(v.a,{onClick:()=>this.onOptionRemove(t),className:"mx_PollCreateDialog_removeOption",disabled:this.state.busy})))),a.a.createElement(v.a,{onClick:this.onOptionAdd,disabled:this.state.busy||this.state.options.length>=20,kind:"secondary",className:"mx_PollCreateDialog_addOption",inputRef:this.addOptionRef},Object(m.a)("Add option")),this.state.busy&&a.a.createElement("div",{className:"mx_PollCreateDialog_busy"},a.a.createElement(f.a,null)));var e}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(13),s=n.n(i),o=n(10),r=n(797),a=n(55),c=n(189),l=n(385),d=n(460);function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class m extends r.a{constructor(e){super(e),s()(this,"id",void 0);const t=e.content.id;if(!t||"string"!=typeof t)throw new l.a("Answer ID must be a non-empty string");this.id=t}serialize(){return{type:"org.matrix.sdk.poll.answer",content:h({id:this.id},this.serializeMMessageOnly())}}static from(e,t){return new m({type:"org.matrix.sdk.poll.answer",content:{id:e,[a.c.name]:t}})}}class p extends d.a{constructor(e){super(e),s()(this,"question",void 0),s()(this,"kind",void 0),s()(this,"rawKind",void 0),s()(this,"maxSelections",void 0),s()(this,"answers",void 0);const t=c.e.findIn(this.wireContent);if(null==t||!t.question)throw new l.a("A question is required");if(this.question=new r.a({type:"org.matrix.sdk.poll.question",content:t.question}),this.rawKind=t.kind,c.b.matches(this.rawKind)?this.kind=c.b:this.kind=c.c,this.maxSelections=Number.isFinite(t.max_selections)&&t.max_selections>0?t.max_selections:1,!Array.isArray(t.answers))throw new l.a("Poll answers must be an array");const n=t.answers.slice(0,20).map((e=>new m({type:"org.matrix.sdk.poll.answer",content:e})));if(n.length<=0)throw new l.a("No answers available");this.answers=n}isEquivalentTo(e){return Object(a.e)(e,c.e)}serialize(){return{type:c.e.name,content:{[c.e.name]:{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map((e=>e.serialize().content))},[a.c.name]:`${this.question.text}\n${this.answers.map(((e,t)=>`${t+1}. ${e.text}`)).join("\n")}`}}}static from(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new p({type:c.e.name,content:{[a.c.name]:e,[c.e.name]:{question:{[a.c.name]:e},kind:n instanceof o.NamespacedValue?n.name:n,max_selections:i,answers:t.map((e=>({id:[...Array(16)].map((()=>g.charAt(Math.floor(Math.random()*g.length)))).join(""),[a.c.name]:e})))}}})}}const g="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(13),s=n.n(i),o=n(460),r=n(55),a=n(33),c=n(385);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class u extends o.a{constructor(e){super(e),s()(this,"text",void 0),s()(this,"html",void 0),s()(this,"renderings",void 0);const t=r.b.findIn(this.wireContent),n=r.c.findIn(this.wireContent),i=r.a.findIn(this.wireContent);if(Object(a.b)(t)){if(!Array.isArray(t))throw new c.a("m.message contents must be an array");const e=t.find((e=>!Object(a.b)(e.mimetype)||"text/plain"===e.mimetype)),n=t.find((e=>"text/html"===e.mimetype));if(!e)throw new c.a("m.message is missing a plain text representation");this.text=e.body,this.html=null==n?void 0:n.body,this.renderings=t}else{if(!Object(a.a)(n))throw new c.a("Missing textual representation for event");this.text=n,this.html=i,this.renderings=[{body:n,mimetype:"text/plain"}],this.html&&this.renderings.push({body:this.html,mimetype:"text/html"})}}isEquivalentTo(e){return Object(r.e)(e,r.b)}serializeMMessageOnly(){let e={[r.b.name]:this.renderings};if(1===this.renderings.length){const t=this.renderings[0].mimetype;void 0!==t&&"text/plain"!==t||(e={[r.c.name]:this.renderings[0].body})}return e}serialize(){var e;return{type:"m.room.message",content:d(d({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!==(e=this.html)&&void 0!==e?e:void 0})}}static from(e,t){return new u({type:r.b.name,content:{[r.c.name]:e,[r.a.name]:t}})}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(439),c=n.n(a),l=n(123),d=n(133),u=n(121),h=n(124),m=n(143),p=n(153);class g extends r.a.PureComponent{constructor(e){super(e),s()(this,"onKeyDown",(e=>{if(Object(p.a)().getAccessibilityAction(e)===m.h.Escape)e.stopPropagation(),e.preventDefault(),this.cancel()})),s()(this,"onCancel",(()=>{this.cancel()})),s()(this,"onSubmit",(e=>{e.stopPropagation(),e.preventDefault(),this.state.canSubmit&&this.submit()}))}get matrixClient(){return l.a.get()}render(){return r.a.createElement(d.a.Provider,{value:this.matrixClient},r.a.createElement(c.a,{returnFocus:!0,lockProps:{onKeyDown:this.onKeyDown,role:"dialog","aria-labelledby":"mx_CompoundDialog_title","aria-describedby":"mx_CompoundDialog_content"},className:"mx_CompoundDialog mx_ScrollableBaseDialog"},r.a.createElement("div",{className:"mx_CompoundDialog_header"},r.a.createElement("h1",null,this.state.title),r.a.createElement(h.a,{onClick:this.onCancel,className:"mx_CompoundDialog_cancelButton","aria-label":Object(u.a)("Close dialog")})),r.a.createElement("form",{onSubmit:this.onSubmit,className:"mx_CompoundDialog_form"},r.a.createElement("div",{className:"mx_CompoundDialog_content"},this.renderContent()),r.a.createElement("div",{className:"mx_CompoundDialog_footer"},r.a.createElement(h.a,{onClick:this.onCancel,kind:"primary_outline"},Object(u.a)("Cancel")),r.a.createElement(h.a,{onClick:this.onSubmit,kind:"primary",disabled:!this.state.canSubmit,type:"submit",element:"button",className:"mx_Dialog_nonDialogButton"},this.state.actionLabel)))))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i="im.vector.room.read_pins"},function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return d}));var i=n(150),s=n(126),o=n(138);const r="recent_emoji",a=100;function c(){return s.b.getValue(r)||[]}function l(e){const t=c(),n=t.findIndex((t=>{let[n]=t;return n===e}));let i;n>=0?([i]=t.splice(n,1),i[1]++):i=[e,1],s.b.setValue(r,null,o.a.ACCOUNT,[i,...t].slice(0,a))}function d(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:24,t=c();t.length<1&&(!function(){const e=JSON.parse(window.localStorage.mx_reaction_count||"{}"),t=Object.entries(e).sort(((e,t)=>{let[,[n,i]]=e,[,[s,o]]=t;return o-i})).map((e=>{let[t,[n,i]]=e;return[t,n]}));s.b.setValue(r,null,o.a.ACCOUNT,t.slice(0,a))}(),t=c());return Object(i.orderBy)(t,"1","desc").slice(0,e).map((e=>{let[t]=e;return t}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o);class a{constructor(e,t,n){this.topCount=e,this.renderCount=t,this.bottomCount=n}contains(e){return!(!e.renderCount&&this.renderCount)&&(e.topCount>=this.topCount&&e.topCount+e.renderCount<=this.topCount+this.renderCount)}expand(e){if(0===this.renderCount)return this;const t=Math.min(e,this.topCount),n=Math.min(e,this.bottomCount);return new a(this.topCount-t,this.renderCount+t+n,this.bottomCount-n)}totalSize(){return this.topCount+this.renderCount+this.bottomCount}}class c extends r.a.Component{constructor(e){super(e),this.state={renderRange:null}}static getDerivedStateFromProps(e,t){const n=c.getVisibleRangeFromProps(e),i=n.expand(e.overflowMargin),s=n.expand(e.overflowItems);return!(!!t.renderRange&&s.totalSize()!==t.renderRange.totalSize())&&t.renderRange&&t.renderRange.contains(i)?null:{renderRange:s}}static getVisibleRangeFromProps(e){const{items:t,itemHeight:n,scrollTop:i,height:s}=e,o=t?t.length:0,r=Math.min(Math.max(0,Math.floor(i/n)),o),c=o-r,l=0!==s?Math.ceil(s/n):0,d=Math.min(l,c);return new a(r,d,c-d)}render(){const{itemHeight:e,items:t,renderItem:n}=this.props,{renderRange:i}=this.state,{topCount:s,renderCount:o,bottomCount:a}=i,c=s*e,l=a*e,d=(t||[]).slice(s,s+o),u=this.props.element||"div",h={style:{paddingTop:`${c}px`,paddingBottom:`${l}px`},className:this.props.className};return r.a.createElement(u,h,d.map(n))}}s()(c,"defaultProps",{overflowItems:20,overflowMargin:5})},function(e,t,n){"use strict";function i(e){const t=[],n=e.getContent().images;if(!n)return[];for(const e in n){const i=n[e];t.push({shortcodes:[e],url:i.url})}return t}n.d(t,"a",(function(){return i}))},,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(120),s=n.n(i),o=n(166);class r extends s.a.Component{render(){const e=new Date(this.props.ts);let t;return t=this.props.showRelative?Object(o.k)(e,this.props.showTwelveHour):this.props.showFullDate?Object(o.c)(e,this.props.showTwelveHour,this.props.showSeconds):this.props.showSeconds?Object(o.h)(e,this.props.showTwelveHour):Object(o.m)(e,this.props.showTwelveHour),s.a.createElement("span",{className:"mx_MessageTimestamp",title:Object(o.c)(e,this.props.showTwelveHour),"aria-hidden":!0},t)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return d}));var i=n(120),s=n.n(i),o=n(188),r=n.n(o),a=n(156),c=n(810);function l(e,t,n){var i;if(null===(i=a.a.get())||void 0===i||!i.needsUrlTooltips())return;let o=e[0];for(;o;){var d,u;if(t.includes(o)||n.includes(o))o=o.nextSibling;else{if("A"===o.tagName&&o.getAttribute("href")&&o.getAttribute("href")!==(null===(d=o.textContent)||void 0===d?void 0:d.trim())){let e=o.getAttribute("href");try{e=new URL(e,window.location.href).toString()}catch(e){}const t=s.a.createElement(c.a,{tooltip:e},s.a.createElement("span",{dangerouslySetInnerHTML:{__html:o.innerHTML}}));r.a.render(t,o),n.push(o)}else null!==(u=o.childNodes)&&void 0!==u&&u.length&&l(o.childNodes,t,n);o=o.nextSibling}}}function d(e){for(const t of e)r.a.unmountComponentAtNode(t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(247);const d=["children","tooltip"];class u extends c.a.Component{constructor(e){super(e)}render(){const e=this.props,{children:t,tooltip:n}=e,i=r()(e,d);return c.a.createElement(l.a,s()({tabIndex:-1,tooltip:n,onClick:e=>e.target.blur()},i),t)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(120);function s(e){const[t,n]=Object(i.useState)(!1);return[t,{onMouseOver:()=>n(!0),onMouseLeave:()=>n(!1),onMouseMove:t=>{n(!e(t))}}]}},,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return l}));var i=n(1487),s=n(1488),o=n(1489),r=n(1),a=n(356);function c(e){if(window.AudioContext)return new AudioContext(e);if(window.webkitAudioContext)return new window.webkitAudioContext(e);throw new Error("Unsupported browser")}function l(e){return new Promise((t=>{r.a.log("Decoder WASM path: "+i.a);const n=new Uint8Array(e),c=new Worker(o.a),l=new Worker(s.a);c.postMessage({command:"init",decoderSampleRate:a.c,outputBufferSampleRate:a.c}),l.postMessage({command:"init",wavBitDepth:24,wavSampleRate:a.c}),c.onmessage=e=>{null!==e.data?l.postMessage({command:"encode",buffers:e.data},e.data.map((e=>e.buffer))):l.postMessage({command:"done"})},l.onmessage=e=>{"page"===e.data.message&&t(new Blob([e.data.page],{type:"audio/wav"}).arrayBuffer())},c.postMessage({command:"decode",pages:n},[n.buffer])}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(822);class s{constructor(e,t){this.index=e,this.offset=t}compare(e){return this.index===e.index?this.offset-e.offset:this.index-e.index}iteratePartsBetween(e,t,n){if(-1===this.index||-1===e.index)return;const[i,s]=this.compare(e)<0?[this,e]:[e,this];if(i.index===s.index)n(t.parts[this.index],i.offset,s.offset);else{const e=t.parts[i.index];n(e,i.offset,e.text.length);for(let e=i.index+1;e<s.index;++e){const i=t.parts[e];n(i,0,i.text.length)}n(t.parts[s.index],0,s.offset)}}forwardsWhile(e,t){if(-1===this.index)return this;let{index:n,offset:i}=this;const{parts:o}=e;for(;n<o.length;){const e=o[n];for(;i<e.text.length;){if(!t(n,i,e))return new s(n,i);i+=1}if(n===o.length-1)return new s(n,i);n+=1,i=0}return this}backwardsWhile(e,t){if(-1===this.index)return this;let{index:n,offset:i}=this;const o=e.parts;for(;n>=0;){const e=o[n];for(;i>0;){if(!t(n,i-1,e))return new s(n,i);i-=1}if(0===n)return new s(n,i);n-=1,i=o[n].text.length}return this}asOffset(e){if(-1===this.index)return new i.a(0,!0);let t=0;for(let n=0;n<this.index;++n)t+=e.parts[n].text.length;t+=this.offset;const n=e.parts[this.index],s=!n||t>=n.text.length;return new i.a(t,s)}isAtEnd(e){if(0===e.parts.length)return!0;const t=e.parts.length-1,n=e.parts[t];return this.index===t&&this.offset===n.text.length}isAtStart(){return 0===this.index&&0===this.offset}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{constructor(e,t){this.offset=e,this.atNodeEnd=t}asPosition(e){return e.positionForOffset(this.offset,this.atNodeEnd)}add(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new i(this.offset+e,t)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(150);function s(e){const t=2*Math.PI/e.length;return Object(i.split)(e,"").map(((e,n)=>{if(" "===e)return e;const[i,s]=function(e,t){const n=127*t*Math.cos(e),i=127*t*Math.sin(e);return[n,i]}(n*t,1),[a,c,l]=function(e,t,n){let i=(e+16)/116;const s=.9505*o(i+t/500),a=1.089*o(i-n/200);i=o(i);const c=3.24096994*s-1.53738318*i-.49861076*a,l=-.96924364*s+1.8759675*i+.04155506*a,d=.05563008*s-.20397696*i+1.05697151*a;return[r(c),r(l),r(d)]}(75,i,s);return'<font color="#'+a.toString(16).padStart(2,"0")+c.toString(16).padStart(2,"0")+l.toString(16).padStart(2,"0")+'">'+e+"</font>"})).join("")}function o(e){return e>.2069?Math.pow(e,3):.1284*e-.01771}function r(e){const t=function(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055}(e),n=Math.min(Math.max(t,0),1);return Math.round(255*n)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return a}));var i=n(601),s=n(822);function o(e,t){const{offset:n,text:i}=r(e,t.focusNode,t.focusOffset);return{caret:n,text:i}}function r(e,t,n){const{node:o,characterOffset:r}=function(e,t){for(;e&&e.nodeType===Node.ELEMENT_NODE;){const n=e.childNodes.length;if(!n)break;t>=n?t=(e=e.lastChild).nodeType===Node.TEXT_NODE?e.textContent.length:Number.MAX_SAFE_INTEGER:(e=e.childNodes[t],t=0)}return{node:e,characterOffset:t}}(t,n),{text:a,offsetToNode:c}=function(e,t){let n=0,s=!1,o="";function r(e){s||e===t&&(s=!0),"BR"===e.tagName&&e.nextSibling&&(s||(n+=1),o+="\n");const r=e.nodeType===Node.TEXT_NODE&&function(e){const t=e.nodeValue;if(!t)return"";if(Object(i.b)(e.parentElement))return 1!==t.length?t.replace(i.a,""):"";return t}(e);return r&&(s||(n+=r.length),o+=r),!0}function a(e){var t;"DIV"===e.tagName&&"DIV"===(null===(t=e.nextSibling)||void 0===t?void 0:t.tagName)&&(o+="\n",s||(n+=1))}return function(e,t,n){let i=e.firstChild;for(;i&&i!==e;)if(t(i)&&i.firstChild)i=i.firstChild;else if(i.nextSibling)i=i.nextSibling;else{for(;i&&!i.nextSibling&&i!==e;)i=i.parentElement,i!==e&&n(i);i!==e&&(i=i.nextSibling)}}(e,r,a),{text:o,offsetToNode:n}}(e,o),l=function(e,t,n){if(!e)return new s.a(0,!1);let o=n===e.textContent.length;if(e.nodeType===Node.TEXT_NODE&&Object(i.b)(e.parentElement)){const t=e.nodeValue.indexOf(i.a);-1!==t&&t<n&&(n-=1),o=!0}return new s.a(t+n,o)}(o,c,r);return{offset:l,text:a}}function a(e,t,n){const i=r(e,n.focusNode,n.focusOffset).offset,s=r(e,n.anchorNode,n.anchorOffset).offset,o=i.asPosition(t),a=s.asPosition(t);return t.startRange(o,a)}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i="im.vector.is_virtual_room"},function(e,t,n){"use strict";n.d(t,"b",(function(){return b})),n.d(t,"a",(function(){return y}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(144),c=n(121),l=n(459),d=n(125),u=n(396),h=n(129),m=n(338),p=n(124),g=n(209),v=n(133),f=n(856);function b(e,t){return e?e.getPendingEvents().filter((function(e){const n=e.status===a.a.NOT_SENT,i=t===e.threadRootId;return n&&(!t||i)})):[]}class y extends r.a.PureComponent{constructor(e,t){super(e,t),s()(this,"unmounted",!1),s()(this,"onSyncStateChange",((e,t,n)=>{"SYNCING"===e&&"SYNCING"===t||this.unmounted||this.setState({syncState:e,syncStateData:n})})),s()(this,"onResendAllClick",(()=>{l.a.resendUnsentEvents(this.props.room).then((()=>{this.setState({isResending:!1})})),this.setState({isResending:!0}),d.a.fire(h.a.FocusSendMessageComposer)})),s()(this,"onCancelAllClick",(()=>{l.a.cancelUnsentEvents(this.props.room),d.a.fire(h.a.FocusSendMessageComposer)})),s()(this,"onRoomLocalEchoUpdated",((e,t)=>{if(t.roomId!==this.props.room.roomId)return;const n=b(this.props.room);this.setState({unsentMessages:n,isResending:n.length>0&&this.state.isResending})})),this.state={syncState:this.context.getSyncState(),syncStateData:this.context.getSyncStateData(),unsentMessages:b(this.props.room),isResending:!1}}componentDidMount(){const e=this.context;e.on("sync",this.onSyncStateChange),e.on("Room.localEchoUpdated",this.onRoomLocalEchoUpdated),this.checkSize()}componentDidUpdate(){this.checkSize()}componentWillUnmount(){this.unmounted=!0;const e=this.context;e&&(e.removeListener("sync",this.onSyncStateChange),e.removeListener("Room.localEchoUpdated",this.onRoomLocalEchoUpdated))}checkSize(){this.getSize()?this.props.onVisible&&this.props.onVisible():this.props.onHidden&&this.props.onHidden()}getSize(){return this.shouldShowConnectionError()?1:this.state.unsentMessages.length>0||this.state.isResending?2:0}shouldShowConnectionError(){const e=Boolean(this.state.syncStateData&&this.state.syncStateData.error&&"M_RESOURCE_LIMIT_EXCEEDED"===this.state.syncStateData.error.name);return"ERROR"===this.state.syncState&&!e}getUnsentMessageContent(){const e=this.state.unsentMessages;let t,n=null,i=null;for(const t of e){if(t.error&&"M_CONSENT_NOT_GIVEN"===t.error.errcode){n=t.error;break}if(t.error&&"M_RESOURCE_LIMIT_EXCEEDED"===t.error.errcode){i=t.error;break}}t=n?Object(c.a)("You can't send any messages until you review and agree to <consentLink>our terms and conditions</consentLink>.",{},{consentLink:e=>{var t;return r.a.createElement("a",{href:null===(t=n.data)||void 0===t?void 0:t.consent_uri,target:"_blank"},e)}}):i?Object(u.a)(i.data.limit_type,i.data.admin_contact,{monthly_active_user:Object(c.c)("Your message wasn't sent because this homeserver has hit its Monthly Active User Limit. Please <a>contact your service administrator</a> to continue using the service."),hs_disabled:Object(c.c)("Your message wasn't sent because this homeserver has been blocked by its administrator. Please <a>contact your service administrator</a> to continue using the service."),"":Object(c.c)("Your message wasn't sent because this homeserver has exceeded a resource limit. Please <a>contact your service administrator</a> to continue using the service.")}):Object(c.a)("Some of your messages have not been sent");let s=r.a.createElement(r.a.Fragment,null,r.a.createElement(p.a,{onClick:this.onCancelAllClick,className:"mx_RoomStatusBar_unsentCancelAllBtn"},Object(c.a)("Delete all")),r.a.createElement(p.a,{onClick:this.onResendAllClick,className:"mx_RoomStatusBar_unsentRetry"},Object(c.a)("Retry all")));return this.state.isResending&&(s=r.a.createElement(r.a.Fragment,null,r.a.createElement(g.a,{w:20,h:20}),r.a.createElement("span",null,Object(c.a)("Sending")))),r.a.createElement(f.a,{title:t,description:Object(c.a)("You can select all or individual messages to retry or delete"),notificationState:m.a.RED_EXCLAMATION,buttons:s})}render(){return this.shouldShowConnectionError()?r.a.createElement("div",{className:"mx_RoomStatusBar"},r.a.createElement("div",{role:"alert"},r.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar"},r.a.createElement("img",{src:n(858).default,width:"24",height:"24",title:"/!\\ ",alt:"/!\\ "}),r.a.createElement("div",null,r.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_title"},Object(c.a)("Connectivity to the server has been lost.")),r.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_desc"},Object(c.a)("Sent messages will be stored until your connection has returned.")))))):this.state.unsentMessages.length>0||this.state.isResending?this.getUnsentMessageContent():null}}s()(y,"contextType",v.a)},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(120),s=n.n(i),o=n(250);const r=e=>s.a.createElement("div",{className:"mx_RoomStatusBar mx_RoomStatusBar_unsentMessages"},s.a.createElement("div",{role:"alert"},s.a.createElement("div",{className:"mx_RoomStatusBar_unsentBadge"},s.a.createElement(o.a,{notification:e.notificationState})),s.a.createElement("div",null,s.a.createElement("div",{className:"mx_RoomStatusBar_unsentTitle"},e.title),e.description&&s.a.createElement("div",{className:"mx_RoomStatusBar_unsentDescription"},e.description)),s.a.createElement("div",{className:"mx_RoomStatusBar_unsentButtonBar"},e.buttons)))},function(e,t,n){"use strict";n.d(t,"a",(function(){return v}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l),u=n(214),h=n(124),m=n(205),p=n(167);const g=["symbol","count","color"];function v(e){let{symbol:t,count:n,color:i}=e,o=r()(e,g);const a=Object(p.b)("feature_hidebold");if(i===m.a.None||a&&i==m.a.Bold)return c.a.createElement(c.a.Fragment,null);const l=i>=m.a.Grey&&(!!n||!!t),v=null===t&&0===n;null===t&&n>0&&(t=Object(u.c)(n));const f=d()({mx_NotificationBadge:!0,mx_NotificationBadge_visible:!!v||l,mx_NotificationBadge_highlighted:i>=m.a.Red,mx_NotificationBadge_dot:v,mx_NotificationBadge_2char:t&&t.length>0&&t.length<3,mx_NotificationBadge_3char:t&&t.length>2});return o.onClick?c.a.createElement(h.a,s()({"aria-label":o.label},o,{className:f,onClick:o.onClick,onMouseOver:o.onMouseOver,onMouseLeave:o.onMouseLeave}),c.a.createElement("span",{className:"mx_NotificationBadge_count"},t),o.children):c.a.createElement("div",{className:f},c.a.createElement("span",{className:"mx_NotificationBadge_count"},t))}},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return a}));var i,s,o=n(120);function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},r.apply(this,arguments)}function a(e){return o.createElement("svg",r({id:"warning-triangle_svg__Layer_1",xmlns:"http://www.w3.org/2000/svg",x:0,y:0,viewBox:"0 0 14 12",xmlSpace:"preserve",role:"presentation","aria-hidden":!0},e),i||(i=o.createElement("style",null,".warning-triangle_svg__st0{fill:none;stroke:#424242;stroke-linecap:round;stroke-linejoin:round}")),s||(s=o.createElement("path",{className:"warning-triangle_svg__st0",d:"M6 1.5L1.2 9.3c-.2.3-.2.8 0 1.1.2.3.6.6 1 .6h9.7c.4 0 .8-.2 1-.6.2-.3.2-.8 0-1.1L8 1.5c-.2-.3-.6-.5-1-.5s-.8.2-1 .5zM7 4v3M7 9"})))}t.default="img/feather-customised/warning-triangle.9c96e17.svg"},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(137);const s=e=>{const[t]=e.currentState.getStateEvents(i.UNSTABLE_ELEMENT_FUNCTIONAL_USERS.name);return Array.isArray(null==t?void 0:t.getContent().service_members)?t.getContent().service_members:[]}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(859);const s=e=>{const t=Object(i.a)(e);return e.getJoinedMembers().filter((e=>!t.includes(e.userId)))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a),l=n(121),d=n(136),u=n(146),h=n(124),m=n(340),p=n(156);function g(){return p.a.get().getDesktopCapturerSources({thumbnailSize:{height:176,width:312},types:["screen","window"]})}let v;!function(e){e.Screens="screen",e.Windows="window"}(v||(v={}));class f extends r.a.Component{constructor(e){super(e),s()(this,"onClick",(()=>{this.props.onSelect(this.props.source)}))}render(){const e=c()({mx_desktopCapturerSourcePicker_source_thumbnail:!0,mx_desktopCapturerSourcePicker_source_thumbnail_selected:this.props.selected});return r.a.createElement(h.a,{className:"mx_desktopCapturerSourcePicker_source",title:this.props.source.name,onClick:this.onClick},r.a.createElement("img",{className:e,src:this.props.source.thumbnailURL}),r.a.createElement("span",{className:"mx_desktopCapturerSourcePicker_source_name"},this.props.source.name))}}class b extends r.a.Component{constructor(e){super(e),s()(this,"interval",void 0),s()(this,"onSelect",(e=>{this.setState({selectedSource:e})})),s()(this,"onShare",(()=>{this.props.onFinished(this.state.selectedSource.id)})),s()(this,"onTabChange",(()=>{this.setState({selectedSource:null})})),s()(this,"onCloseClick",(()=>{this.props.onFinished(null)})),this.state={selectedTab:v.Screens,sources:[],selectedSource:null}}async componentDidMount(){this.setState({sources:await g()}),this.interval=window.setInterval((async()=>{this.setState({sources:await g()})}),500)}componentWillUnmount(){clearInterval(this.interval)}getTab(e,t){const n=this.state.sources.filter((t=>t.id.startsWith(e))).map((e=>{var t;return r.a.createElement(f,{selected:(null===(t=this.state.selectedSource)||void 0===t?void 0:t.id)===e.id,source:e,onSelect:this.onSelect,key:e.id})}));return new m.a(e,t,null,r.a.createElement("div",{className:"mx_desktopCapturerSourcePicker_tab"},n))}render(){const e=[this.getTab("screen",Object(l.a)("Share entire screen")),this.getTab("window",Object(l.a)("Application window"))];return r.a.createElement(d.a,{className:"mx_desktopCapturerSourcePicker",onFinished:this.onCloseClick,title:Object(l.a)("Share content")},r.a.createElement(m.c,{tabs:e,tabLocation:m.b.TOP,onChange:this.onTabChange}),r.a.createElement(u.a,{primaryButton:Object(l.a)("Share"),hasCancel:!0,onCancel:this.onCloseClick,onPrimaryButtonClick:this.onShare,primaryDisabled:!this.state.selectedSource}))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(120),s=n.n(i),o=n(216),r=n(121),a=n(128);const c=()=>{a.b.createDialog(o.a,{title:Object(r.a)("Can’t start a call"),description:s.a.createElement("p",null,Object(r.a)("You can’t start a call as you are currently recording a live broadcast. Please end your live broadcast in order to start a call.")),hasCloseButton:!0})}},function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return o}));var i=n(147);function s(e,t){return e.size!==t.size||(!!Array.from(t).some((t=>!e.has(t)))||!!Array.from(e).some((e=>!t.has(e))))}function o(e,t){return Object(i.a)(Array.from(e),Array.from(t))}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(161),r=n(311);t.a=e=>{let{label:t,labelInvite:n,labelPublic:i,labelRestricted:a,value:c,width:l=448,onChange:d}=e;const u=[s.a.createElement("div",{key:o.c.Invite,className:"mx_JoinRuleDropdown_invite"},n),s.a.createElement("div",{key:o.c.Public,className:"mx_JoinRuleDropdown_public"},i)];return a&&u.unshift(s.a.createElement("div",{key:o.c.Restricted,className:"mx_JoinRuleDropdown_restricted"},a)),s.a.createElement(r.a,{id:"mx_JoinRuleDropdown",className:"mx_JoinRuleDropdown",onOptionChange:d,menuWidth:l,value:c,label:t},u)}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(16),r=n(121),a=n(124),c=n(230),l=n(168),d=n(236),u=n(123),h=n(223),m=n(158);t.a=e=>{var t;let{space:n,onFinished:p}=e;const[g,v]=Object(i.useState)(Object(r.a)("Click to copy"));return s.a.createElement("div",{className:"mx_SpacePublicShare"},s.a.createElement(a.a,{className:"mx_SpacePublicShare_shareButton",onClick:async()=>{const e=new l.a(n);e.load();const t=await Object(c.b)(e.forShareableRoom())?Object(r.a)("Copied!"):Object(r.a)("Failed to copy");v(t),await Object(o.N)(5e3),g===t&&v(Object(r.a)("Click to copy"))}},s.a.createElement("h3",null,Object(r.a)("Share invite link")),s.a.createElement("span",null,g)),n.canInvite(null===(t=u.a.get())||void 0===t?void 0:t.getUserId())&&Object(h.a)(m.a.InviteUsers)?s.a.createElement(a.a,{className:"mx_SpacePublicShare_inviteButton",onClick:()=>{p&&p(),Object(d.e)(n.roomId)}},s.a.createElement("h3",null,Object(r.a)("Invite people")),s.a.createElement("span",null,Object(r.a)("Invite with email or username"))):null)}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(157),r=n(121),a=n(140),c=n(132),l=n(393),d=n(181),u=n(128),h=n(216);t.a=e=>{let{title:t,subheading:n,children:m,rageshakeLabel:p,rageshakeData:g={},onFinished:v}=e;const[f,b]=Object(i.useState)(""),[y,S]=Object(i.useState)(!1);return s.a.createElement(o.a,{className:"mx_GenericFeatureFeedbackDialog",hasCancelButton:!0,title:t,description:s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"mx_GenericFeatureFeedbackDialog_subheading"},n," ",Object(r.a)("Your platform and username will be noted to help us use your feedback as much as we can.")," ",m),s.a.createElement(a.a,{id:"feedbackComment",label:Object(r.a)("Feedback"),type:"text",autoComplete:"off",value:f,element:"textarea",onChange:e=>{b(e.target.value)},autoFocus:!0}),s.a.createElement(d.b,{checked:y,onChange:e=>S(e.target.checked)},Object(r.a)("You may contact me if you have any follow up questions"))),button:Object(r.a)("Send feedback"),buttonDisabled:!f,onFinished:async e=>{if(!e)return v(!1);Object(l.c)(c.b.get().bug_report_endpoint_url,p,f,y,g),v(!0),u.b.createDialog(h.a,{title:t,description:Object(r.a)("Feedback sent! Thanks, we appreciate it!"),button:Object(r.a)("Close"),hasCloseButton:!1,fixedWidth:!1})}})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(120),s=n.n(i),o=n(121),r=n(124),a=n(140),c=n(294);const l=e=>{let{avatarUrl:t,avatarDisabled:n=!1,setAvatar:a}=e;const l=Object(i.useRef)(),[d,u]=Object(i.useState)(t);let h;return h=n?d?s.a.createElement("img",{className:"mx_SpaceBasicSettings_avatar",src:d,alt:""}):s.a.createElement("div",{className:"mx_SpaceBasicSettings_avatar"}):d?s.a.createElement(s.a.Fragment,null,s.a.createElement(r.a,{className:"mx_SpaceBasicSettings_avatar",onClick:()=>{var e;return null===(e=l.current)||void 0===e?void 0:e.click()},element:"img",src:d,alt:""}),s.a.createElement(r.a,{onClick:()=>{l.current.value="",u(void 0),a(void 0)},kind:"link",className:"mx_SpaceBasicSettings_avatar_remove","aria-label":Object(o.a)("Delete avatar")},Object(o.a)("Delete"))):s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"mx_SpaceBasicSettings_avatar",onClick:()=>{var e;return null===(e=l.current)||void 0===e?void 0:e.click()}}),s.a.createElement(r.a,{onClick:()=>{var e;return null===(e=l.current)||void 0===e?void 0:e.click()},kind:"link","aria-label":Object(o.a)("Upload avatar")},Object(o.a)("Upload"))),s.a.createElement("div",{className:"mx_SpaceBasicSettings_avatarContainer"},h,s.a.createElement("input",{type:"file",ref:l,onClick:c.a,onChange:e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;const n=e.target.files[0];a(n);const i=new FileReader;i.onload=e=>{var t;u(null===(t=e.target)||void 0===t?void 0:t.result)},i.readAsDataURL(n)},accept:"image/*"}))};t.b=e=>{let{avatarUrl:t,avatarDisabled:n=!1,setAvatar:i,name:r="",nameDisabled:c=!1,setName:d,topic:u="",topicDisabled:h=!1,setTopic:m}=e;return s.a.createElement("div",{className:"mx_SpaceBasicSettings"},s.a.createElement(l,{avatarUrl:t,avatarDisabled:n,setAvatar:i}),s.a.createElement(a.a,{name:"spaceName",label:Object(o.a)("Name"),autoFocus:!0,value:r,onChange:e=>d(e.target.value),disabled:c}),s.a.createElement(a.a,{name:"spaceTopic",element:"textarea",label:Object(o.a)("Description"),value:u,onChange:e=>m(e.target.value),rows:3,disabled:h}))}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return T})),n.d(t,"b",(function(){return j}));var i=n(122),s=n.n(i),o=n(127),r=n.n(o),a=n(478),c=n(120),l=n(1553),d=n(143),u=n(170),h=n(129),m=n(125),p=n(153),g=n(121),v=n(218),f=n(297),b=n(192),y=n(992),S=n(228),E=n(147),w=n(187),_=n(151),C=n(124),O=n(148),I=n(126),R=n(543),k=n(250),x=n(465);const T=32;Object(l.a)();class j extends c.Component{constructor(t){var n;super(t),n=this,s()(this,"headerButton",Object(c.createRef)()),s()(this,"sublistRef",Object(c.createRef)()),s()(this,"tilesRef",Object(c.createRef)()),s()(this,"dispatcherRef",void 0),s()(this,"layout",void 0),s()(this,"heightAtStart",void 0),s()(this,"notificationState",void 0),s()(this,"settingWatchers",void 0),s()(this,"slidingSyncMode",void 0),s()(this,"onListsLoading",((e,t)=>{this.props.tagId===e&&this.setState({roomsLoading:t})})),s()(this,"onListsUpdated",(()=>{const e={},t=this.state.rooms,n=Object(E.b)(S.c.instance.orderedLists[this.props.tagId]||[]);Object(E.e)(t,n)&&(e.rooms=n),Object.keys(e).length>0&&this.setState(e)})),s()(this,"onAction",(t=>{t.action===h.a.ViewRoom&&t.show_room_tile&&this.state.rooms&&e((()=>{const e=this.state.rooms.findIndex((e=>e.roomId===t.room_id));!this.state.isExpanded&&e>-1&&this.toggleCollapsed(),e>=this.numVisibleTiles&&(this.layout.visibleTiles=this.layout.tilesWithPadding(e+1,32),this.forceUpdate())}))})),s()(this,"onResize",((e,t,n,i)=>{const s=this.heightAtStart+i.height;this.applyHeightChange(s),this.setState({height:s})})),s()(this,"onResizeStart",(()=>{this.heightAtStart=this.state.height,this.setState({isResizing:!0})})),s()(this,"onResizeStop",((e,t,n,i)=>{const s=this.heightAtStart+i.height;this.applyHeightChange(s),this.setState({isResizing:!1,height:s})})),s()(this,"onShowAllClick",(async()=>{if(this.slidingSyncMode){const e=S.c.instance.getCount(this.props.tagId);await R.a.instance.ensureListRegistered(this.props.tagId,{ranges:[[0,e]]})}const e=this.numVisibleTiles,t=this.layout.tilesToPixelsWithPadding(this.numTiles,this.padding);this.applyHeightChange(t),this.setState({height:t},(()=>{this.focusRoomTile(e)}))})),s()(this,"onShowLessClick",(()=>{const e=this.layout.tilesToPixelsWithPadding(this.layout.defaultVisibleTiles,this.padding);this.applyHeightChange(e),this.setState({height:e})})),s()(this,"focusRoomTile",(e=>{if(!this.sublistRef.current)return;const t=this.sublistRef.current.querySelectorAll(".mx_RoomTile"),n=t&&t[e];n&&n.focus()})),s()(this,"onOpenMenuClick",(e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})})),s()(this,"onContextMenu",(e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,height:0}})})),s()(this,"onCloseMenu",(()=>{this.setState({contextMenuPosition:void 0})})),s()(this,"onUnreadFirstChanged",(()=>{const e=S.c.instance.getListOrder(this.props.tagId)===f.a.Importance?f.a.Natural:f.a.Importance;S.c.instance.setListOrder(this.props.tagId,e),this.forceUpdate()})),s()(this,"onTagSortChanged",(async e=>{S.c.instance.setTagSorting(this.props.tagId,e),this.forceUpdate()})),s()(this,"onMessagePreviewChanged",(()=>{this.layout.showPreviews=!this.layout.showPreviews,this.forceUpdate()})),s()(this,"onBadgeClick",(e=>{let t;e.preventDefault(),e.stopPropagation(),t=this.props.tagId===b.a.Invite?this.state.rooms&&this.state.rooms[0]:S.c.instance.orderedLists[this.props.tagId].find((e=>{const t=this.notificationState.getForRoom(e);return t.count>0&&t.color===this.notificationState.color})),t&&m.a.dispatch({action:h.a.ViewRoom,room_id:t.roomId,show_room_tile:!0,metricsTrigger:"WebRoomListNotificationBadge",metricsViaKeyboard:"click"!==e.type})})),s()(this,"onHeaderClick",(()=>{const t=this.headerButton.current.parentElement,n=t.parentElement.parentElement,i=n.parentElement.parentElement,s=Math.round(i.scrollTop),o=s<=Math.round(T),r=s>=Math.round(i.scrollHeight-i.offsetHeight),a=t.classList.contains("mx_RoomSublist_headerContainer_stickyTop"),c=t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom");if(c&&!r||a&&!o)n.scrollIntoView({behavior:"smooth"});else{const t=this.state.isExpanded;this.toggleCollapsed(),!t&&c&&e((()=>{n.scrollIntoView({behavior:"smooth"})}))}})),s()(this,"toggleCollapsed",(()=>{this.props.forceExpanded||(this.layout.isCollapsed=this.state.isExpanded,this.setState({isExpanded:!this.layout.isCollapsed}),this.props.onListCollapse&&this.props.onListCollapse(!this.layout.isCollapsed))})),s()(this,"onHeaderKeyDown",(e=>{switch(Object(p.a)().getRoomListAction(e)){case d.h.CollapseRoomListSection:e.stopPropagation(),this.state.isExpanded&&this.toggleCollapsed();break;case d.h.ExpandRoomListSection:if(e.stopPropagation(),this.state.isExpanded){if(this.sublistRef.current){const e=this.sublistRef.current.querySelector(".mx_RoomTile");e&&e.focus()}}else this.toggleCollapsed()}})),s()(this,"onKeyDown",(e=>{var t;switch(Object(p.a)().getAccessibilityAction(e)){case d.h.ArrowLeft:e.stopPropagation(),null===(t=this.headerButton.current)||void 0===t||t.focus();break;case d.h.ArrowRight:e.stopPropagation()}})),this.slidingSyncMode=I.b.getValue("feature_sliding_sync"),this.layout=y.a.instance.getLayoutFor(this.props.tagId),this.heightAtStart=0,this.notificationState=v.a.instance.getListState(this.props.tagId),this.state={isResizing:!1,isExpanded:!this.layout.isCollapsed,height:0,rooms:Object(E.b)(S.c.instance.orderedLists[this.props.tagId]||[]),baseFontSize:I.b.getValue("baseFontSize"),roomsLoading:!1},this.state=Object.assign(this.state,{height:this.calculateInitialHeight()}),this.settingWatchers=[I.b.watchSetting("baseFontSize",null,(function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];let[,,,s]=t;return n.setState({baseFontSize:s})}))]}calculateInitialHeight(){const e=Math.max(Math.floor(this.layout.visibleTiles),this.layout.minVisibleTiles),t=Math.min(this.numTiles,e);return this.layout.tilesToPixelsWithPadding(t,this.padding)}get padding(){let e=4;const t=this.numTiles>this.numVisibleTiles,n=this.numTiles>this.layout.defaultVisibleTiles;return(t||n)&&(e+=28),e}get extraTiles(){var e;return null!==(e=this.props.extraTiles)&&void 0!==e?e:null}get numTiles(){return j.calcNumTiles(this.state.rooms,this.extraTiles)}static calcNumTiles(e,t){return(e||[]).length+(t||[]).length}get numVisibleTiles(){if(this.slidingSyncMode)return this.state.rooms.length;const e=Math.ceil(this.layout.visibleTiles);return Math.min(e,this.numTiles)}componentDidUpdate(e,t){const n=e.extraTiles;j.calcNumTiles(t.rooms,n)!==this.numTiles&&this.setState({height:this.calculateInitialHeight()})}shouldComponentUpdate(e,t){if(Object(w.c)(this.props,e))return!0;const n=Object(w.b)(this.state,["rooms"]),i=Object(w.b)(t,["rooms"]);if(Object(w.c)(n,i))return!0;const s=this.props.extraTiles||[],o=e.extraTiles||[];if(s.length>0||o.length>0)return!0;if(j.calcNumTiles(t.rooms,o)!==this.numTiles)return!0;if(!t.isExpanded)return!1;if(this.state.rooms.length!==t.rooms.length)return!0;const r=this.state.rooms.slice(0,this.numVisibleTiles),a=t.rooms.slice(0,this.numVisibleTiles);return!!Object(E.e)(r,a)}componentDidMount(){var e;this.dispatcherRef=m.a.register(this.onAction),S.c.instance.on(S.b,this.onListsUpdated),S.c.instance.on(S.a,this.onListsLoading),null===(e=this.tilesRef.current)||void 0===e||e.addEventListener("scroll",this.onScrollPrevent,{passive:!0})}componentWillUnmount(){var e;m.a.unregister(this.dispatcherRef),S.c.instance.off(S.b,this.onListsUpdated),S.c.instance.off(S.a,this.onListsLoading),null===(e=this.tilesRef.current)||void 0===e||e.removeEventListener("scroll",this.onScrollPrevent);for(const e of this.settingWatchers)I.b.unwatchSetting(e)}applyHeightChange(e){const t=Math.ceil(this.layout.pixelsToTiles(e-this.padding));this.layout.visibleTiles=Math.min(this.numTiles,t)}renderVisibleTiles(){if(!this.state.isExpanded&&!this.props.forceExpanded)return[];const e=[];if(this.state.rooms){let t=this.state.rooms;this.props.forceExpanded||(t=t.slice(0,this.numVisibleTiles));for(const n of t)e.push(c.createElement(x.b,{room:n,key:`room-${n.roomId}`,showMessagePreview:this.layout.showPreviews,isMinimized:this.props.isMinimized,tag:this.props.tagId}))}return this.extraTiles&&e.push(...this.extraTiles),e.length>this.numVisibleTiles&&!this.props.forceExpanded?e.slice(0,this.numVisibleTiles):e}renderMenu(){if(this.props.tagId===b.a.Suggested||this.props.tagId===b.a.SavedItems)return null;let e;if(this.state.contextMenuPosition){let t,n=S.c.instance.getTagSorting(this.props.tagId)===f.b.Alphabetic,i=S.c.instance.getListOrder(this.props.tagId)===f.a.Importance;if(this.slidingSyncMode){const e=R.a.instance.slidingSync.getListParams(this.props.tagId);n="by_name"===((null==e?void 0:e.sort)||[])[0],i="by_notification_level"===((null==e?void 0:e.sort)||[])[0]}this.props.tagId!==b.a.Invite&&(t=c.createElement(c.Fragment,null,c.createElement("hr",null),c.createElement("div",null,c.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(g.a)("Appearance")),c.createElement(_.g,{onClose:this.onCloseMenu,onChange:this.onUnreadFirstChanged,checked:i},Object(g.a)("Show rooms with unread messages first")),c.createElement(_.g,{onClose:this.onCloseMenu,onChange:this.onMessagePreviewChanged,checked:this.layout.showPreviews},Object(g.a)("Show previews of messages"))))),e=c.createElement(_.n,{chevronFace:_.a.None,left:this.state.contextMenuPosition.left,top:this.state.contextMenuPosition.top+this.state.contextMenuPosition.height,onFinished:this.onCloseMenu},c.createElement("div",{className:"mx_RoomSublist_contextMenu"},c.createElement("div",null,c.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(g.a)("Sort by")),c.createElement(_.h,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(f.b.Recent),checked:!n,name:`mx_${this.props.tagId}_sortBy`},Object(g.a)("Activity")),c.createElement(_.h,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(f.b.Alphabetic),checked:n,name:`mx_${this.props.tagId}_sortBy`},Object(g.a)("A-Z"))),t))}return c.createElement(c.Fragment,null,c.createElement(_.c,{className:"mx_RoomSublist_menuButton",onClick:this.onOpenMenuClick,title:Object(g.a)("List options"),isExpanded:!!this.state.contextMenuPosition}),e)}renderHeader(){return c.createElement(u.e,{inputRef:this.headerButton},(e=>{let{onFocus:t,isActive:n,ref:i}=e;const s=n?0:-1;let o=Object(g.a)("Jump to first unread room.");this.props.tagId===b.a.Invite&&(o=Object(g.a)("Jump to first invite."));const a=c.createElement(k.a,{forceCount:!0,notification:this.notificationState,onClick:this.onBadgeClick,tabIndex:s,"aria-label":o,showUnsentTooltip:!0});let l;if(this.props.AuxButtonComponent){const e=this.props.AuxButtonComponent;l=c.createElement(e,{tabIndex:s})}const d=r()({mx_RoomSublist_collapseBtn:!0,mx_RoomSublist_collapseBtn_collapsed:!this.state.isExpanded&&!this.props.forceExpanded}),u=r()({mx_RoomSublist_headerContainer:!0,mx_RoomSublist_headerContainer_withAux:!!l}),h=c.createElement("div",{className:"mx_RoomSublist_badgeContainer"},a);let m=C.a;return this.props.isMinimized&&(m=O.a),c.createElement("div",{className:u,onKeyDown:this.onHeaderKeyDown,onFocus:t,"aria-label":this.props.label},c.createElement("div",{className:"mx_RoomSublist_stickableContainer"},c.createElement("div",{className:"mx_RoomSublist_stickable"},c.createElement(m,{onFocus:t,inputRef:i,tabIndex:s,className:"mx_RoomSublist_headerText",role:"treeitem","aria-expanded":this.state.isExpanded,"aria-level":1,onClick:this.onHeaderClick,onContextMenu:this.onContextMenu,title:this.props.isMinimized?this.props.label:void 0},c.createElement("span",{className:d}),c.createElement("span",null,this.props.label)),this.renderMenu(),this.props.isMinimized?null:h,this.props.isMinimized?null:l)),this.props.isMinimized?h:null,this.props.isMinimized?l:null)}))}onScrollPrevent(e){e.target.scrollTop=0}render(){var e;const t=this.renderVisibleTiles(),n=!(this.state.rooms.length||null!==(e=this.props.extraTiles)&&void 0!==e&&e.length||!0===this.props.alwaysVisible),i=r()({mx_RoomSublist:!0,mx_RoomSublist_hasMenuOpen:!!this.state.contextMenuPosition,mx_RoomSublist_minimized:this.props.isMinimized,mx_RoomSublist_hidden:n});let s;if(this.state.roomsLoading)s=c.createElement("div",{className:"mx_RoomSublist_skeletonUI"});else if(t.length>0&&this.props.forceExpanded)s=c.createElement("div",{className:"mx_RoomSublist_resizeBox mx_RoomSublist_resizeBox_forceExpanded"},c.createElement("div",{className:"mx_RoomSublist_tiles",ref:this.tilesRef},t));else if(t.length>0){const e=this.layout,n=Math.min(e.minVisibleTiles,this.numTiles),i=4+(n<this.numTiles?28:0),o=e.tilesToPixelsWithPadding(n,i),l=e.tilesToPixelsWithPadding(this.numTiles,this.padding),d=r()({mx_RoomSublist_showNButton:!0});let h;const m=this.slidingSyncMode&&S.c.instance.getCount(this.props.tagId)>this.state.rooms.length;if(l>this.state.height||m){const e=this.state.height-4-28,t=Math.floor(e/this.layout.tileHeight);let n=this.numTiles-t;this.slidingSyncMode&&(n=S.c.instance.getCount(this.props.tagId)-t);const i=Object(g.a)("Show %(count)s more",{count:n});let s=c.createElement("span",{className:"mx_RoomSublist_showNButtonText"},i);this.props.isMinimized&&(s=null),h=c.createElement(u.a,{role:"treeitem",onClick:this.onShowAllClick,className:d,"aria-label":i},c.createElement("span",{className:"mx_RoomSublist_showMoreButtonChevron mx_RoomSublist_showNButtonChevron"}),s)}else if(this.numTiles>this.layout.defaultVisibleTiles){const e=Object(g.a)("Show less");let t=c.createElement("span",{className:"mx_RoomSublist_showNButtonText"},e);this.props.isMinimized&&(t=null),h=c.createElement(u.a,{role:"treeitem",onClick:this.onShowLessClick,className:d,"aria-label":e},c.createElement("span",{className:"mx_RoomSublist_showLessButtonChevron mx_RoomSublist_showNButtonChevron"}),t)}const p={bottom:!0,bottomLeft:!1,bottomRight:!1,left:!1,right:!1,top:!1,topLeft:!1,topRight:!1};e.visibleTiles>=this.numTiles&&this.numTiles<=e.minVisibleTiles&&(p.bottom=!1);const v=r()({mx_RoomSublist_resizerHandles:!0,mx_RoomSublist_resizerHandles_showNButton:!!h});s=c.createElement(c.Fragment,null,c.createElement(a.Resizable,{size:{height:this.state.height/10*this.state.baseFontSize},minHeight:o/10*this.state.baseFontSize,maxHeight:l/10*this.state.baseFontSize,onResizeStart:this.onResizeStart,onResizeStop:this.onResizeStop,onResize:this.onResize,handleWrapperClass:v,handleClasses:{bottom:"mx_RoomSublist_resizerHandle"},className:"mx_RoomSublist_resizeBox",enable:p},c.createElement("div",{className:"mx_RoomSublist_tiles",ref:this.tilesRef},t),h))}else this.props.showSkeleton&&this.state.isExpanded&&(s=c.createElement("div",{className:"mx_RoomSublist_skeletonUI"}));return c.createElement("div",{ref:this.sublistRef,className:i,role:"group","aria-hidden":n,"aria-label":this.props.label,onKeyDown:this.onKeyDown},this.renderHeader(),s)}}}).call(this,n(54).setImmediate)},function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return r}));var i=n(122),s=n.n(i);class o{constructor(){}}function r(e,t){return!!e.match(/[\d.]+/)&&Number(e)>=Number(t)}s()(o,"RestrictedRooms","9")},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(1),r=n(147);class a{constructor(){s()(this,"listeners",[])}when(e,t){return this.listeners.push({condition:e,fn:t}),this}whenAnyOf(e,t){for(const n of e)this.when(n,t);return this}whenAnything(e){return this.listeners.push({condition:null,fn:e}),this}notifyCondition(e){const t=Object(r.b)(this.listeners);for(const n of t)if(null===n.condition||n.condition===e)try{n.fn(this)}catch(t){o.a.error(`Error calling whenable listener for ${e}:`,t)}}destroy(){this.listeners=[]}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(122),s=n.n(i),o=n(17),r=n.n(o),a=n(154);class c extends r.a{constructor(){super(...arguments),s()(this,"toasts",new Map)}static get instance(){return c._instance||(c._instance=new c),c._instance}get components(){return Array.from(this.toasts.values())}addToast(e){const t=Symbol();return this.toasts.set(t,e),this.emit(a.b),t}removeToast(e){this.toasts.delete(e),this.emit(a.b)}}s()(c,"_instance",void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return y}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(130),c=n(161),l=n(121),d=n(132),u=n(240),h=n(123),m=n(128),p=n(282),g=n(136),v=n(146),f=n(506),b=n(124);class y extends r.a.Component{constructor(e){var t;super(e),s()(this,"isPrivate",void 0),s()(this,"currentVersion",void 0),s()(this,"onProgressCallback",((e,t,n)=>{this.setState({progressText:e,progress:t,total:n})})),s()(this,"onContinue",(async()=>{var e,t;const n={continue:!0,invite:this.isPrivate&&this.state.inviteUsersToNewRoom};await(null===(e=(t=this.props).doUpgrade)||void 0===e?void 0:e.call(t,n,this.onProgressCallback)),this.props.onFinished(n)})),s()(this,"onCancel",(()=>{this.props.onFinished({continue:!1,invite:!1})})),s()(this,"onInviteUsersToggle",(e=>{this.setState({inviteUsersToNewRoom:e})})),s()(this,"openBugReportDialog",(e=>{e.preventDefault(),e.stopPropagation(),m.b.createDialog(p.a,{})}));const n=h.a.get().getRoom(this.props.roomId),i=null==n?void 0:n.currentState.getStateEvents(a.b.RoomJoinRules,"");this.isPrivate=null===(t=(null==i?void 0:i.getContent().join_rule)!==c.c.Public)||void 0===t||t,this.currentVersion=null==n?void 0:n.getVersion(),this.state={inviteUsersToNewRoom:!0}}render(){const e=d.b.get().brand;let t=null;this.isPrivate&&(t=r.a.createElement(u.a,{value:this.state.inviteUsersToNewRoom,onChange:this.onInviteUsersToggle,label:Object(l.a)("Automatically invite members from this room to the new one")}));const n=this.isPrivate?Object(l.a)("Upgrade private room"):Object(l.a)("Upgrade public room");let i,s=r.a.createElement("p",null,Object(l.a)("This usually only affects how the room is processed on the server. If you're having problems with your %(brand)s, please report a bug.",{brand:e}));return d.b.get().bug_report_endpoint_url&&(s=r.a.createElement("p",null,Object(l.a)("This usually only affects how the room is processed on the server. If you're having problems with your %(brand)s, please <a>report a bug</a>.",{brand:e},{a:e=>r.a.createElement(b.a,{kind:"link_inline",onClick:this.openBugReportDialog},e)}))),i=this.state.progressText?r.a.createElement("span",{className:"mx_RoomUpgradeWarningDialog_progress"},r.a.createElement(f.a,{value:this.state.progress,max:this.state.total}),r.a.createElement("div",{className:"mx_RoomUpgradeWarningDialog_progressText"},this.state.progressText)):r.a.createElement(v.a,{primaryButton:Object(l.a)("Upgrade"),onPrimaryButtonClick:this.onContinue,cancelButton:Object(l.a)("Cancel"),onCancel:this.onCancel}),r.a.createElement(g.a,{className:"mx_RoomUpgradeWarningDialog",hasCancel:!0,fixedWidth:!1,onFinished:this.props.onFinished,title:n},r.a.createElement("div",null,r.a.createElement("p",null,this.props.description||Object(l.a)("Upgrading a room is an advanced action and is usually recommended when a room is unstable due to bugs, missing features or security vulnerabilities.")),r.a.createElement("p",null,Object(l.a)("<b>Please note upgrading will make a new version of the room</b>. All current messages will stay in this archived room.",{},{b:e=>r.a.createElement("b",null,e)})),s,r.a.createElement("p",null,Object(l.a)("You'll upgrade this room from <oldVersion /> to <newVersion />.",{},{oldVersion:()=>r.a.createElement("code",null,this.currentVersion),newVersion:()=>r.a.createElement("code",null,this.props.targetVersion)})),t),i)}}},function(e,t,n){"use strict";var i,s=n(120),o=n.n(s),r=n(121),a=n(342),c=n(305),l=n(341),d=n(215),u=n(403),h=n(147);!function(e){e.All="All",e.Specific="Specific",e.None="None"}(i||(i={}));const m=e=>{let{filterPlaceholder:t,rooms:n,selected:i,onChange:a}=e;const[m,p]=Object(s.useState)(""),g=m.toLowerCase().trim(),v=Object(s.useMemo)((()=>{if(!g)return n;return new c.a(n,{keys:["name"],funcs:[e=>Object(h.n)([e.getCanonicalAlias(),...e.getAltAliases()])],shouldMatchWordsOnly:!1}).match(g)}),[n,g]);return o.a.createElement("div",{className:"mx_SpaceChildrenPicker"},o.a.createElement(l.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:t,onSearch:p,autoFocus:!0}),o.a.createElement(d.a,null,v.map((e=>o.a.createElement(u.b,{key:e.roomId,room:e,checked:i.has(e),onChange:t=>{a(t,e)}}))),v.length<1?o.a.createElement("span",{className:"mx_SpaceChildrenPicker_noResults"},Object(r.a)("No results")):void 0))};t.a=e=>{let{space:t,spaceChildren:n,selected:c,onChange:l,noneLabel:d,allLabel:u,specificLabel:h}=e;const[p,g]=Object(s.useState)(d?i.None:i.All);return Object(s.useEffect)((()=>{p===i.All?l(n):l([])}),[l,p,n]),o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SpaceChildrenPicker"},o.a.createElement(a.a,{name:"roomsToLeave",value:p,onChange:g,definitions:[{value:i.None,label:d},{value:i.All,label:u},{value:i.Specific,label:h}].filter((e=>e.label))})),p===i.Specific&&o.a.createElement(m,{filterPlaceholder:Object(r.a)("Search %(spaceName)s",{spaceName:t.name}),rooms:n,selected:c,onChange:(e,t)=>{l(e?[t,...c]:[...c].filter((e=>e!==t)))}}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return S}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(150),c=n(141),l=n(152),d=n(123),u=n(305),h=n(392),m=n(391),p=n(121),g=n(168),v=n(173),f=n(263);const b=/\B@\S*/g,y=/[^/,:; \t\n]\S*/g;class S extends m.a{constructor(e,t){super({commandRegex:b,forcedCommandRegex:y,renderingType:t}),s()(this,"matcher",void 0),s()(this,"users",void 0),s()(this,"room",void 0),s()(this,"onRoomTimeline",((e,t,n,i,s)=>{t&&(i||t.roomId===this.room.roomId&&s.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&!n&&s&&s.liveEvent&&this.onUserSpoke(e.sender))})),s()(this,"onRoomStateUpdate",(e=>{e.roomId===this.room.roomId&&(this.users=null)})),this.room=e,this.matcher=new u.a([],{keys:["name"],funcs:[e=>e.userId.slice(1)],shouldMatchWordsOnly:!1}),d.a.get().on(c.d.Timeline,this.onRoomTimeline),d.a.get().on(l.b.Update,this.onRoomStateUpdate)}destroy(){d.a.get()&&(d.a.get().removeListener(c.d.Timeline,this.onRoomTimeline),d.a.get().removeListener(l.b.Update,this.onRoomStateUpdate))}async getCompletions(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;this.users||this.makeUsers();const{command:s,range:o}=this.getCurrentCommand(e,t,n),a=null==s?void 0:s[0];if(a&&"@"!==a){const e=a.startsWith("@")?a.substring(1):a;return this.matcher.match(e,i).map((e=>{var n;const i=null===(n=f.a.getDisplayUserIdentifier)||void 0===n?void 0:n.call(f.a,e.userId,{roomId:this.room.roomId,withDisplayName:!0}),s=e.name||e.userId||"";return{completion:e.rawDisplayName,completionId:e.userId,type:"user",suffix:t.beginning&&0===o.start?": ":" ",href:Object(g.i)(e.userId),component:r.a.createElement(h.a,{title:s,description:i},r.a.createElement(v.b,{member:e,width:24,height:24})),range:o}}))}return[]}getName(){return Object(p.a)("Users")}makeUsers(){const e=this.room.getLiveTimeline().getEvents(),t={};for(const n of e)t[n.getSender()]=n.getTs();const n=d.a.get().credentials.userId;this.users=this.room.getJoinedMembers().filter((e=>{let{userId:t}=e;return t!==n})),this.users=this.users.concat(this.room.getMembersWithMembership("invite")),this.users=Object(a.sortBy)(this.users,(e=>1e20-t[e.userId]||1e20)),this.matcher.setObjects(this.users)}onUserSpoke(e){this.users&&e&&e.userId!==d.a.get().credentials.userId&&(this.users.splice(this.users.findIndex((t=>t.userId===e.userId)),1),this.users=[e,...this.users],this.matcher.setObjects(this.users))}renderCompletions(e){return r.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"presentation","aria-label":Object(p.a)("User Autocomplete")},e)}shouldForceComplete(){return!0}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(150),r=n(1);class a{constructor(e,t){s()(this,"history",[]),s()(this,"prefix",void 0),s()(this,"lastIndex",0),s()(this,"currentIndex",0),this.prefix=t+e;let n,i=0;for(;n=sessionStorage.getItem(`${this.prefix}[${i}]`);){try{this.history.push(JSON.parse(n))}catch(e){r.a.warn("Throwing away unserialisable history",e);break}++i}this.lastIndex=this.history.length-1,this.currentIndex=this.lastIndex+1}static createItem(e,t){return{parts:e.serializeParts(),replyEventId:t?t.getId():void 0}}save(e,t){const n=a.createItem(e,t);this.history.push(n),this.currentIndex=this.history.length,this.lastIndex+=1,sessionStorage.setItem(`${this.prefix}[${this.lastIndex}]`,JSON.stringify(n))}getItem(e){return this.currentIndex=Object(o.clamp)(this.currentIndex+e,0,this.history.length-1),this.history[this.currentIndex]}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return m})),n.d(t,"c",(function(){return p})),n.d(t,"d",(function(){return g}));var i=n(120),s=n.n(i),o=n(1),r=n(256),a=n(418),c=n(121),l=n(128),d=n(145),u=n(157);function h(e){const t=e.parts[0];if(t){if(t.type===r.b.Command&&t.text.startsWith("/")&&!t.text.startsWith("//"))return!0;if(t.text.startsWith("/")&&!t.text.startsWith("//")&&(t.type===r.b.Plain||t.type===r.b.PillCandidate))return!0}return!1}function m(e){const t=e.parts.reduce(((e,t)=>t.type===r.b.UserPill||t.type===r.b.RoomPill?e+t.resourceId:e+t.text),""),{cmd:n,args:i}=Object(a.d)(t);return[n,i,t]}async function p(e,t,n,i){const s=e.run(n,i,t);let r=null,u=s.error;if(s.promise)try{var h;if(e.category===a.a.messages||e.category===a.a.effects)r=null!==(h=await s.promise)&&void 0!==h?h:null;else await s.promise}catch(e){u=e}if(u){o.a.error("Command failure: %s",u);const e=!!s.promise?Object(c.c)("Server error"):Object(c.c)("Command error");let t;return t="string"==typeof u?u:u.translatedMessage?u.translatedMessage:u.message?u.message:Object(c.a)("Server unavailable, overloaded, or something else went wrong."),l.b.createDialog(d.a,{title:Object(c.a)(e),description:t}),[null,!1]}return o.a.log("Command success."),[r,!0]}async function g(e){const{finished:t}=l.b.createDialog(u.a,{title:Object(c.a)("Unknown Command"),description:s.a.createElement("div",null,s.a.createElement("p",null,Object(c.a)("Unrecognised command: %(commandText)s",{commandText:e})),s.a.createElement("p",null,Object(c.a)("You can use <code>/help</code> to list available commands. Did you mean to send this as a message?",{},{code:e=>s.a.createElement("code",null,e)})),s.a.createElement("p",null,Object(c.a)("Hint: Begin your message with <code>//</code> to start it with a slash.",{},{code:e=>s.a.createElement("code",null,e)}))),button:Object(c.a)("Send as message")}),[n]=await t;return n}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(137);const s=(e,t,n,s,o,r)=>({body:"Voice message",msgtype:i.MsgType.Audio,url:e,file:o,info:{duration:n,mimetype:t,size:s},"org.matrix.msc1767.text":"Voice message","org.matrix.msc1767.file":{url:e,file:o,name:"Voice message.ogg",mimetype:t,size:s},"org.matrix.msc1767.audio":{duration:n,waveform:r},"org.matrix.msc3245.voice":{}})},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(1),s=n(145),o=n(121),r=n(128),a=n(132);const c=async function(){let e,t,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];try{e=await navigator.mediaDevices.getUserMedia({audio:!0,video:n})}catch(i){if(n&&"NotFoundError"===i.name)try{e=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){t=e}else t=i}if(t){i.a.log("Failed to list userMedia devices",t);const e=a.b.get().brand;r.b.createDialog(s.a,{title:Object(o.a)("No media permissions"),description:Object(o.a)("You may need to manually permit %(brand)s to access your microphone/webcam",{brand:e})})}return e}},function(e,t,n){"use strict";n.d(t,"a",(function(){return v}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(120),c=n.n(a),l=n(143),d=n(629),u=n(153),h=n(121),m=n(269),p=n(178);const g=["room","onFinished"],v=e=>{let{room:t,onFinished:n}=e,i=r()(e,g);const[o,a]=Object(d.a)(t),v=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return i=>{i.preventDefault(),i.stopPropagation(),e(i);const s=Object(u.a)().getAccessibilityAction(i);t&&s!==l.h.Enter||n()}},f=c.a.createElement(p.d,{label:Object(h.a)("Use default"),active:o===m.a.AllMessages,iconClassName:"mx_RoomNotificationContextMenu_iconBell",onClick:v((()=>a(m.a.AllMessages)))}),b=c.a.createElement(p.d,{label:Object(h.a)("All messages"),active:o===m.a.AllMessagesLoud,iconClassName:"mx_RoomNotificationContextMenu_iconBellDot",onClick:v((()=>a(m.a.AllMessagesLoud)))}),y=c.a.createElement(p.d,{label:Object(h.a)("Mentions & Keywords"),active:o===m.a.MentionsOnly,iconClassName:"mx_RoomNotificationContextMenu_iconBellMentions",onClick:v((()=>a(m.a.MentionsOnly)))}),S=c.a.createElement(p.d,{label:Object(h.a)("Off"),active:o===m.a.Mute,iconClassName:"mx_RoomNotificationContextMenu_iconBellCrossed",onClick:v((()=>a(m.a.Mute)))});return c.a.createElement(p.e,s()({},i,{onFinished:n,className:"mx_RoomNotificationContextMenu",compact:!0}),c.a.createElement(p.c,{first:!0},f,b,y,S))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return R}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(1),c=n(120),l=n.n(c),d=n(143),u=n(997),h=n(133),m=n(125),p=n(142),g=n(153),v=n(121),f=n(234),b=n(126),y=n(268),S=n(218),E=n(192),w=n(228),_=n(164),C=n(398),O=n(178);const I=["room","onFinished","onPostMarkUnreadClick","onPostFavoriteClick","onPostLowPriorityClick","onPostInviteClick","onPostCopyLinkClick","onPostSettingsClick","onPostLeaveClick","onPostForgetClick"],R=e=>{let{room:t,onFinished:n,onPostMarkUnreadClick:i,onPostFavoriteClick:o,onPostLowPriorityClick:R,onPostInviteClick:k,onPostCopyLinkClick:x,onPostSettingsClick:T,onPostLeaveClick:j,onPostForgetClick:P}=e,D=r()(e,I);const N=Object(c.useContext)(h.a),M=Object(p.b)(w.c.instance,w.b,(()=>w.c.instance.getTagsForRoom(t))),A=Object(p.b)(S.a.instance,y.b.Update,(()=>S.a.instance.getRoomState(t))),L=Object(p.b)(t,"Room.accountData",(()=>Object(f.e)(t))),U=_.a.shared().getUserIdForRoomId(t.roomId),F=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return s=>{s.preventDefault(),s.stopPropagation(),e(s);const o=Object(g.a)().getAccessibilityAction(s);i&&o!==d.h.Enter||n(),null==t||t(s)}},B=(e,n)=>{if(n===E.a.Favourite||n===E.a.LowPriority){const e=n===E.a.Favourite?E.a.LowPriority:E.a.Favourite,i=w.c.instance.getTagsForRoom(t).includes(n),s=i?n:e,o=i?null:n;m.a.dispatch(u.a.tagRoom(N,t,s,o,void 0,0))}else a.a.warn(`Unexpected tag ${n} applied to ${t.roomId}`)},V=b.b.getValue("feature_mark_unread"),K=A.isUnread||V&&L,$=V?l.a.createElement(O.b,{onClick:F((e=>K?(b.b.getValue("feature_mark_unread")&&Object(f.g)(t,!1),void Object(C.b)(t,N)):void Object(f.g)(t)),i),label:K?Object(v.a)("Mark as read"):Object(v.a)("Mark as unread"),iconClassName:K?"mx_RoomGeneralContextMenu_markAsRead":"mx_RoomGeneralContextMenu_markAsUnread"}):null,H=M.includes(E.a.Favourite),W=l.a.createElement(O.a,{onClick:F((e=>B(0,E.a.Favourite)),o,!0),active:H,label:H?Object(v.a)("Favourited"):Object(v.a)("Favourite"),iconClassName:"mx_RoomGeneralContextMenu_iconStar"}),q=M.includes(E.a.LowPriority),G=l.a.createElement(O.a,{onClick:F((e=>B(0,E.a.LowPriority)),R,!0),active:q,label:Object(v.a)("Low Priority"),iconClassName:"mx_RoomGeneralContextMenu_iconArrowDown"});let z=null;t.canInvite(N.getUserId())&&!U&&(z=l.a.createElement(O.b,{onClick:F((()=>m.a.dispatch({action:"view_invite",roomId:t.roomId})),k),label:Object(v.a)("Invite"),iconClassName:"mx_RoomGeneralContextMenu_iconInvite"}));let J=null;U||(J=l.a.createElement(O.b,{onClick:F((()=>m.a.dispatch({action:"copy_room",room_id:t.roomId})),x),label:Object(v.a)("Copy room link"),iconClassName:"mx_RoomGeneralContextMenu_iconCopyLink"}));const Y=l.a.createElement(O.b,{onClick:F((()=>m.a.dispatch({action:"open_room_settings",room_id:t.roomId})),T),label:Object(v.a)("Settings"),iconClassName:"mx_RoomGeneralContextMenu_iconSettings"});let Q;return Q=M.includes(E.a.Archived)?l.a.createElement(O.b,{iconClassName:"mx_RoomGeneralContextMenu_iconSignOut",label:Object(v.a)("Forget Room"),className:"mx_IconizedContextMenu_option_red",onClick:F((()=>m.a.dispatch({action:"forget_room",room_id:t.roomId})),P)}):l.a.createElement(O.b,{onClick:F((()=>m.a.dispatch({action:"leave_room",room_id:t.roomId})),j),label:Object(v.a)("Leave"),className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_RoomGeneralContextMenu_iconSignOut"}),l.a.createElement(O.e,s()({},D,{onFinished:n,className:"mx_RoomGeneralContextMenu",compact:!0}),!M.includes(E.a.Archived)&&l.a.createElement(O.c,null,$,W,G,z,J,Y),l.a.createElement(O.c,{red:!0},Q))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return s}));const i=(e,t)=>`mx_edit_room_${e}_${t}`,s=e=>`mx_edit_state_${e}`},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(122),s=n.n(i);function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const a={imgSrc:"",imgStyle:null,style:"",textContent:""};let c,l;class d{constructor(e){this.iframeFn=e,s()(this,"onLoadPromise",void 0)}get iframe(){var e;const t=null===(e=this.iframeFn)||void 0===e?void 0:e.call(this);if(!t){const e=(c||(c=document.createElement("iframe"),document.body.appendChild(c),c.style.display="none",c.sandbox="allow-scripts allow-downloads allow-downloads-without-user-activation",l=new Promise((e=>{c.onload=()=>{e()},c.src="usercontent/"}))),{iframe:c,onLoadPromise:l});return this.onLoadPromise=e.onLoadPromise,e.iframe}return this.onLoadPromise=void 0,t}async download(e){var t;let{blob:n,name:i,autoDownload:s=!0,opts:o=a}=e;const c=this.iframe;this.onLoadPromise&&await this.onLoadPromise,null===(t=c.contentWindow)||void 0===t||t.postMessage(r(r({},o),{},{blob:n,download:i,auto:s}),"*")}}},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return r}));var i,s=n(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({viewBox:"-1 -1 12 14",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M.574 6.473a.573.573 0 00-.406.98l4.38 4.379a.575.575 0 00.812 0L9.745 7.46a.575.575 0 00-.81-.814L5.524 10.05 5.52.574a.575.575 0 00-1.148 0l.001 9.46L.98 6.643a.57.57 0 00-.406-.169z",fill:"currentColor",fillRule:"evenodd"})))}t.default="img/download.a6b50e0.svg"},,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var i=n(131),s=n.n(i),o=n(134),r=n.n(o),a=n(122),c=n.n(a),l=n(120),d=n.n(l),u=n(127),h=n.n(u),m=n(148),p=n(121),g=n(255);const v=["playback","playbackPhase"];class f extends d.a.PureComponent{constructor(e){super(e),c()(this,"onClick",(()=>{this.toggleState()}))}async toggleState(){await this.props.playback.toggle()}render(){const e=this.props,{playback:t,playbackPhase:n}=e,i=r()(e,v),o=t.isPlaying,a=n===g.d.Decoding,c=h()("mx_PlayPauseButton",{mx_PlayPauseButton_play:!o,mx_PlayPauseButton_pause:o,mx_PlayPauseButton_disabled:a});return d.a.createElement(m.a,s()({"data-testid":"play-pause-button",className:c,title:o?Object(p.a)("Pause"):Object(p.a)("Play"),onClick:this.onClick,disabled:a},i))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(344),c=n(255),l=n(154);class d extends r.a.PureComponent{constructor(e){super(e),s()(this,"onPlaybackUpdate",(e=>{e===c.d.Decoding&&(e=c.d.Stopped),this.setState({playbackPhase:e})})),s()(this,"onTimeUpdate",(e=>{this.setState({seconds:e[0],durationSeconds:e[1]})})),this.state={seconds:this.props.playback.clockInfo.timeSeconds,durationSeconds:this.props.playback.clockInfo.durationSeconds,playbackPhase:c.d.Stopped},this.props.playback.on(l.b,this.onPlaybackUpdate),this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}render(){let e=this.state.seconds;return this.state.playbackPhase===c.d.Stopped&&(e=Number.isFinite(this.props.defaultDisplaySeconds)?this.props.defaultDisplaySeconds:this.state.durationSeconds),r.a.createElement(a.a,{seconds:e,role:"timer"})}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(1),c=n(154),l=n(121),d=n(153),u=n(143);class h extends r.a.PureComponent{constructor(e){super(e),s()(this,"seekRef",Object(o.createRef)()),s()(this,"playPauseRef",Object(o.createRef)()),s()(this,"onKeyDown",(e=>{var t,n,i;let s=!0;switch(Object(d.a)().getAccessibilityAction(e)){case u.h.Space:null===(t=this.playPauseRef.current)||void 0===t||t.toggleState();break;case u.h.ArrowLeft:null===(n=this.seekRef.current)||void 0===n||n.left();break;case u.h.ArrowRight:null===(i=this.seekRef.current)||void 0===i||i.right();break;default:s=!1}s&&e.stopPropagation()})),s()(this,"onPlaybackUpdate",(e=>{this.setState({playbackPhase:e})})),this.state={playbackPhase:this.props.playback.currentState},this.props.playback.on(c.b,this.onPlaybackUpdate),this.props.playback.prepare().catch((e=>{a.a.error("Error processing audio file:",e),this.setState({error:!0})}))}render(){return r.a.createElement(r.a.Fragment,null,this.renderComponent(),this.state.error&&r.a.createElement("div",{className:"text-warning"},Object(l.a)("Error downloading audio")))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var i=n(131),s=n.n(i),o=n(120),r=n.n(o),a=n(209),c=n(121),l=n(1002),d=n(986),u=n(345),h=n(481);class m extends d.a{render(){return this.state.error?r.a.createElement(h.a,{className:"mx_MVoiceMessageBody"},Object(c.a)("Error processing voice message")):this.state.playback?r.a.createElement("span",{className:"mx_MVoiceMessageBody"},r.a.createElement(l.b,{playback:this.state.playback}),this.showFileBody&&r.a.createElement(u.a,s()({},this.props,{showGenericPlaceholder:!1})),this.props.scBubbleTimestamp):r.a.createElement("span",{className:"mx_MVoiceMessageBody"},r.a.createElement(a.a,null))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a);class l extends r.a.PureComponent{render(){return r.a.createElement("div",{className:"mx_Waveform"},this.props.relHeights.map(((e,t)=>{const n=this.props.progress,i=t/this.props.relHeights.length<=n&&n>0,s=c()({mx_Waveform_bar:!0,mx_Waveform_bar_100pct:i});return r.a.createElement("span",{key:t,style:{"--barHeight":e},className:s})})))}}s()(l,"defaultProps",{progress:1})},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(644),c=n(214),l=n(173);const d=e=>{let{tooltip:t,children:n}=e;const[o,r]=Object(i.useState)(!1);if(!t)return s.a.createElement(s.a.Fragment,null,n);return s.a.createElement("div",{onMouseEnter:()=>r(!0),onClick:e=>{e.stopPropagation(),r(!o)},onMouseLeave:()=>r(!1)},n,o&&t)},u=s.a.forwardRef(((e,t)=>{let{id:n,roomMember:i,useMemberColor:o,tooltip:u}=e;const h=o&&i?Object(c.f)(i.userId):"";return s.a.createElement("div",{ref:t,id:n,className:r()("mx_Marker",h,{mx_Marker_defaultColor:!h})},s.a.createElement(d,{tooltip:u},s.a.createElement("div",{className:"mx_Marker_border"},i?s.a.createElement(l.b,{member:i,width:36,height:36,viewUserOnClick:!1,hideTitle:!!u}):s.a.createElement(a.a,{className:"mx_Marker_icon"}))))}));t.a=u},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(137),r=n(166),a=n(142),c=n(646),l=n(121),d=n(273);const u=6e4,h=e=>{const t=Object(a.b)(e,o.BeaconEvent.Update,(()=>e.beaconInfo)),[n,s]=Object(i.useState)((()=>t?Object(d.d)(t):0));Object(i.useEffect)((()=>{t&&s(Object(d.d)(t))}),[t]);const r=Object(i.useCallback)((()=>{if(!t)return;const e=Object(d.d)(t);s(e)}),[t]);var l;return Object(c.b)(r,(l=n)>36e5?6e5:l>u?u:1e3),n};t.a=e=>{let{beacon:t}=e;const n=h(t),i=Object(r.b)(n),o=Object(l.a)("%(timeRemaining)s left",{timeRemaining:i});return s.a.createElement("span",{"data-test-id":"room-live-share-expiry",className:"mx_LiveTimeRemaining"},o)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i,s=n(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 12 12",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M11.468 2.04A1 1 0 0010.054.627L6.047 4.633 1.811.398A1 1 0 10.397 1.812l4.236 4.236-4.007 4.006A1 1 0 102.04 11.47l4.007-4.007 3.778 3.778a1 1 0 001.415-1.414L7.46 6.048l4.007-4.007z",fill:"#b3b3b3"})))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(120),s=n.n(i),o=n(121);function r(e){let{mxEvent:t}=e;return s.a.createElement("div",{className:"mx_DecryptionFailureBody mx_EventTile_content"},function(e){return null!=e&&e.isEncryptedDisabledForUnverifiedDevices?Object(o.a)("The sender has blocked you from receiving this message"):Object(o.a)("Unable to decrypt message")}(t))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(120),s=n.n(i),o=n(127),r=n.n(o),a=n(163),c=n(121),l=n(248);let d;!function(e){e.Info="info",e.Warning="warning"}(d||(d={}));class u extends s.a.PureComponent{constructor(e){super(e)}render(){const{tooltip:e,children:t,tooltipClassName:n,className:i,kind:o}=this.props,u=Object(c.a)("Information"),h=o!==d.Warning?"mx_InfoTooltip_icon_info":"mx_InfoTooltip_icon_warning";return s.a.createElement(l.a,{tooltipTargetClassName:r()("mx_InfoTooltip",i),className:"mx_InfoTooltip_container",tooltipClassName:r()("mx_InfoTooltip_tooltip",n),label:e||u,alignment:a.a.Right},s.a.createElement("span",{className:r()("mx_InfoTooltip_icon",h),"aria-label":u}),t)}}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(121),r=n(123),a=n(284),c=n(133),l=n(164),d=n(187),u=n(220);const h="m.megolm.v1.aes-sha2",m=Object(i.forwardRef)(((e,t)=>{let{mxEvent:n,timestamp:m}=e;const p=Object(i.useContext)(c.a),g=n.getRoomId(),v=r.a.get().isRoomEncrypted(g),f=n.getPrevContent(),b=n.getContent();if(!Object(d.c)(f,b))return null;if(b.algorithm===h&&v){let e;const t=l.a.shared().getUserIdForRoomId(g),n=null==p?void 0:p.getRoom(g);if(f.algorithm===h)e=Object(o.a)("Some encryption parameters have been changed.");else if(t){var y;const i=(null===(y=n.getMember(t))||void 0===y?void 0:y.rawDisplayName)||t;e=Object(o.a)("Messages here are end-to-end encrypted. Verify %(displayName)s in their profile - tap on their avatar.",{displayName:i})}else e=Object(u.a)(n)?Object(o.a)("Messages in this chat will be end-to-end encrypted."):Object(o.a)("Messages in this room are end-to-end encrypted. When people join, you can verify them in their profile, just tap on their avatar.");return s.a.createElement(a.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(o.a)("Encryption enabled"),subtitle:e,timestamp:m})}return v?s.a.createElement(a.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(o.a)("Encryption enabled"),subtitle:Object(o.a)("Ignored attempt to disable encryption"),timestamp:m}):s.a.createElement(a.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon mx_cryptoEvent_icon_warning",title:Object(o.a)("Encryption not enabled"),subtitle:Object(o.a)("The encryption used by this room isn't supported."),ref:t,timestamp:m})}));t.a=m},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.ListsUpdate="lists_update",e.ListsLoading="lists_loading"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(120),s=n.n(i),o=n(739),r=n(160),a=n(193);function c(e){let{user:t,size:n}=e;if(t.isEmail)return s.a.createElement("img",{className:"mx_SearchResultAvatar mx_SearchResultAvatar_threepidAvatar",alt:"",src:o.b,width:n,height:n});{const e=t.getMxcAvatarUrl();return s.a.createElement(a.a,{className:"mx_SearchResultAvatar",url:e?Object(r.b)(e).getSquareThumbnailHttp(n):null,name:t.name,idName:t.userId,width:n,height:n})}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(120),s=n(121),o=n(124);class r extends i.PureComponent{render(){return i.createElement("div",{className:"mx_DialPadBackspaceButtonWrapper"},i.createElement(o.a,{className:"mx_DialPadBackspaceButton",onClick:this.props.onBackspacePress,"aria-label":Object(s.a)("Backspace")}))}}},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return a}));var i,s,o=n(120);function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},r.apply(this,arguments)}function a(e){return o.createElement("svg",r({viewBox:"26 25 6 6",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0},e),i||(i=o.createElement("defs",null,o.createElement("filter",{x:"-5.9%",y:"-7.9%",width:"111.8%",height:"115.8%",filterUnits:"objectBoundingBox",id:"icon-pill-remove_svg__a"},o.createElement("feOffset",{dy:2,in:"SourceAlpha",result:"shadowOffsetOuter1"}),o.createElement("feGaussianBlur",{stdDeviation:16,in:"shadowOffsetOuter1",result:"shadowBlurOuter1"}),o.createElement("feColorMatrix",{values:"0 0 0 0 0 0 0 0 0 0.473684211 0 0 0 0 1 0 0 0 0.241258741 0",in:"shadowBlurOuter1",result:"shadowMatrixOuter1"}),o.createElement("feMerge",null,o.createElement("feMergeNode",{in:"shadowMatrixOuter1"}),o.createElement("feMergeNode",{in:"SourceGraphic"}))))),s||(s=o.createElement("g",{filter:"url(#icon-pill-remove_svg__a)",transform:"translate(-406 -215)",stroke:"#616161"},o.createElement("path",{d:"M438 240l-6 6m0-6l6 6"}))))}t.default="img/icon-pill-remove.bd7d4cf.svg"},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(130),c=n(121),l=n(123),d=n(124),u=n(909),h=n(128),m=n(125),p=n(129),g=n(302),v=n(126);function f(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class b extends r.a.Component{constructor(e){super(e),s()(this,"upgradeRoom",(()=>{const e=l.a.get().getRoom(this.props.roomId);h.b.createDialog(u.a,{room:e})})),s()(this,"onOldRoomClicked",(e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:p.a.ViewRoom,room_id:this.state.oldRoomId,event_id:this.state.oldEventId,metricsTrigger:"WebPredecessorSettings",metricsViaKeyboard:"click"!==e.type}),this.props.closeSettingsFn()}));const t=v.b.getValue("feature_dynamic_room_predecessors");this.state={};const n=l.a.get().getRoom(this.props.roomId);null==n||n.getRecommendedVersion().then((e=>{const i=n.currentState.getStateEvents(a.b.RoomTombstone,""),o={},r=n.findPredecessor(t);r&&(o.oldRoomId=r.roomId,o.oldEventId=r.eventId),this.setState(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?f(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({upgraded:!(null==i||!i.getContent().replacement_room),upgradeRecommendation:e},o))}))}render(){var e;const t=l.a.get().getRoom(this.props.roomId),n=null==t?void 0:t.isSpaceRoom();let i,s,o;if(!1===(null==t||null===(e=t.currentState.getStateEvents(a.b.RoomCreate,""))||void 0===e?void 0:e.getContent()["m.federate"])&&(i=r.a.createElement("div",null,Object(c.a)("This room is not accessible by remote Matrix servers"))),this.state.upgradeRecommendation&&this.state.upgradeRecommendation.needsUpgrade&&!this.state.upgraded&&(s=r.a.createElement("div",null,r.a.createElement("p",{className:"mx_SettingsTab_warningText"},Object(c.a)("<b>Warning</b>: upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>r.a.createElement("b",null,e),i:e=>r.a.createElement("i",null,e)})),r.a.createElement(d.a,{onClick:this.upgradeRoom,kind:"primary"},n?Object(c.a)("Upgrade this space to the recommended room version"):Object(c.a)("Upgrade this room to the recommended room version")))),this.state.oldRoomId){let e;var u,h;if(n)e=Object(c.a)("View older version of %(spaceName)s.",{spaceName:null!==(u=null==t?void 0:t.name)&&void 0!==u?u:this.state.oldRoomId});else e=Object(c.a)("View older messages in %(roomName)s.",{roomName:null!==(h=null==t?void 0:t.name)&&void 0!==h?h:this.state.oldRoomId});o=r.a.createElement(d.a,{element:"a",onClick:this.onOldRoomClicked},e)}return r.a.createElement("div",{className:"mx_SettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Advanced")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},null!=t&&t.isSpaceRoom()?Object(c.a)("Space information"):Object(c.a)("Room information")),r.a.createElement("div",null,r.a.createElement("span",null,Object(c.a)("Internal room ID")),r.a.createElement(g.a,{getTextToCopy:()=>this.props.roomId},this.props.roomId)),i),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Room version")),r.a.createElement("div",null,r.a.createElement("span",null,Object(c.a)("Room version:"))," ",null==t?void 0:t.getVersion()),o,s))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(128),c=n(121),l=n(401),d=n(136),u=n(145),h=n(146),m=n(135);class p extends r.a.Component{constructor(){super(...arguments),s()(this,"targetVersion",void 0),s()(this,"state",{busy:!0}),s()(this,"onCancelClick",(()=>{this.props.onFinished(!1)})),s()(this,"onUpgradeClick",(()=>{this.setState({busy:!0}),Object(l.b)(this.props.room,this.targetVersion,!1,!1).then((()=>{this.props.onFinished(!0)})).catch((e=>{a.b.createDialog(u.a,{title:Object(c.a)("Failed to upgrade room"),description:e&&e.message?e.message:Object(c.a)("The room upgrade could not be completed")})})).finally((()=>{this.setState({busy:!1})}))}))}async componentDidMount(){const e=await this.props.room.getRecommendedVersion();this.targetVersion=e.version,this.setState({busy:!1})}render(){let e;return e=this.state.busy?r.a.createElement(m.a,null):r.a.createElement(h.a,{primaryButton:Object(c.a)("Upgrade this room to version %(version)s",{version:this.targetVersion}),primaryButtonClass:"danger",hasCancel:!0,onPrimaryButtonClick:this.onUpgradeClick,onCancel:this.onCancelClick}),r.a.createElement(d.a,{className:"mx_RoomUpgradeDialog",onFinished:this.props.onFinished,title:Object(c.a)("Upgrade Room Version"),contentId:"mx_Dialog_content",hasCancel:!0},r.a.createElement("p",null,Object(c.a)("Upgrading this room requires closing down the current instance of the room and creating a new room in its place. To give room members the best possible experience, we will:")),r.a.createElement("ol",null,r.a.createElement("li",null,Object(c.a)("Create a new room with the same name, description and avatar")),r.a.createElement("li",null,Object(c.a)("Update any local room aliases to point to the new room")),r.a.createElement("li",null,Object(c.a)("Stop users from speaking in the old version of the room, and post a message advising users to move to the new room")),r.a.createElement("li",null,Object(c.a)("Put a link back to the old room at the start of the new room so people can see old messages"))),e)}}},function(e,t,n){"use strict";var i=n(131),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a),l=n(121),d=n(124);t.a=e=>{let{avatarUrl:t,avatarAltText:n,avatarName:i,uploadAvatar:a,removeAvatar:u}=e;const[h,m]=Object(o.useState)(!1),p={onMouseEnter:()=>m(!0),onMouseLeave:()=>m(!1)},g=Object(o.useRef)(`hover-text-${Math.random()}`);let v,f,b=r.a.createElement(d.a,s()({element:"div",onClick:null!=a?a:null,className:"mx_AvatarSetting_avatarPlaceholder","aria-labelledby":g.current},p));t&&(b=r.a.createElement(d.a,s()({element:"img",src:t,alt:n,"aria-label":n,onClick:null!=a?a:null},p))),a&&(v=r.a.createElement(d.a,s()({onClick:a,className:"mx_AvatarSetting_uploadButton","aria-labelledby":g.current},p))),t&&u&&(f=r.a.createElement(d.a,{onClick:u,kind:"link_sm"},Object(l.a)("Remove")));const y=c()({mx_AvatarSetting_avatar:!0,mx_AvatarSetting_avatar_hovering:h&&a});return r.a.createElement("div",{className:y},b,r.a.createElement("div",{className:"mx_AvatarSetting_hover","aria-hidden":"true"},r.a.createElement("div",{className:"mx_AvatarSetting_hoverBg"}),r.a.createElement("span",{id:g.current},Object(l.a)("Upload"))),v,f)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(120);const s=(e,t,n)=>{const[s,o]=Object(i.useState)(e);return[s,async i=>{o(i);try{await t(i)}catch(t){o(e()),n(t)}}]}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(176);t.a=e=>{let{heading:t,children:n}=e;return s.a.createElement("div",{className:"mx_SettingsTab"},s.a.createElement(o.a,{size:"h2"},t),s.a.createElement("div",{className:"mx_SettingsTab_sections"},n))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(197),s=n.n(i);let o;!function(e){e.Default="default",e.Round="round",e.ExtraRound="extraround",e.Mixed="mixed"}(o||(o={}));s.a.oneOf(Object.values(o))},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.Schildi="schildi",e.Classic="classic"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(168);function s(e){const t=Object(i.l)(e);if(!t||t===e)throw new Error("Failed to transform URI");window.location.hash=t}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return bt}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(130),c=n(207),l=n(30),d=n(189),u=n(144),h=n(126),m=n(546),p=n(547),g=Object(o.forwardRef)(((e,t)=>{let{mxEvent:n,children:i}=e;const s=n.getContent().body;return r.a.createElement("div",{className:"mx_UnknownBody",ref:t},s,i)})),v=n(512),f=n(133),b=n(1149),y=n(696),S=n(345),E=n(986),w=n(896),_=n(182);class C extends r.a.PureComponent{render(){return!this.props.forExport&&Object(_.m)(this.props.mxEvent)?r.a.createElement(w.a,this.props):r.a.createElement(E.a,this.props)}}var O=n(131),I=n.n(O),R=n(883),k=n(1),x=n(121),T=n(209),j=n(160),P=n(507),D=n(408),N=n(139),M=n(481);class A extends r.a.PureComponent{constructor(e){super(e),s()(this,"context",void 0),s()(this,"videoRef",r.a.createRef()),s()(this,"sizeWatcher",void 0),s()(this,"videoOnPlay",(async()=>{this.hasContentUrl()||this.state.fetchingData||this.state.error||(this.setState({fetchingData:!0}),this.props.mediaEventHelper.media.isEncrypted?(this.setState({decryptedUrl:await this.props.mediaEventHelper.sourceUrl.value,decryptedBlob:await this.props.mediaEventHelper.sourceBlob.value,fetchingData:!1},(()=>{this.videoRef.current&&this.videoRef.current.play()})),this.props.onHeightChanged()):this.setState({error:"No file given in content"}))})),s()(this,"getFileBody",(()=>this.props.forExport?null:this.showFileBody&&r.a.createElement(S.a,I()({},this.props,{showGenericPlaceholder:!1})))),this.state={fetchingData:!1,decryptedUrl:null,decryptedThumbnailUrl:null,decryptedBlob:null,error:null,posterLoading:!1,blurhashUrl:null}}getContentUrl(){var e;const t=this.props.mxEvent.getContent();if(this.props.forExport)return(null===(e=t.file)||void 0===e?void 0:e.url)||t.url;const n=Object(j.a)(t);return n.isEncrypted?this.state.decryptedUrl:n.srcHttp}hasContentUrl(){const e=this.getContentUrl();return e&&!e.startsWith("data:")}getThumbUrl(){if(this.props.forExport)return null;const e=this.props.mxEvent.getContent(),t=Object(j.a)(e);return t.isEncrypted&&this.state.decryptedThumbnailUrl?this.state.decryptedThumbnailUrl:this.state.posterLoading?this.state.blurhashUrl:t.hasThumbnail?t.thumbnailHttp:null}loadBlurhash(){var e;const t=null===(e=this.props.mxEvent.getContent())||void 0===e?void 0:e.info;if(!t[P.a])return;const n=document.createElement("canvas"),{w:i,h:s}=Object(D.b)(h.b.getValue("Images.size"),{w:t.w,h:t.h});n.width=i,n.height=s;const o=Object(R.decode)(t[P.a],i,s),r=n.getContext("2d"),a=r.createImageData(i,s);a.data.set(o),r.putImageData(a,0,0),this.setState({blurhashUrl:n.toDataURL(),posterLoading:!0});const c=this.props.mxEvent.getContent(),l=Object(j.a)(c);if(l.hasThumbnail){const e=new Image;e.onload=()=>{this.setState({posterLoading:!1})},e.src=l.thumbnailHttp}}async componentDidMount(){this.sizeWatcher=h.b.watchSetting("Images.size",null,(()=>{this.forceUpdate()}));try{this.loadBlurhash()}catch(e){k.a.error("Failed to load blurhash",e)}if(this.props.mediaEventHelper.media.isEncrypted&&null===this.state.decryptedUrl)try{const t=h.b.getValue("autoplayVideo"),n=await this.props.mediaEventHelper.thumbnailUrl.value;if(t)k.a.log("Preloading video"),this.setState({decryptedUrl:await this.props.mediaEventHelper.sourceUrl.value,decryptedThumbnailUrl:n,decryptedBlob:await this.props.mediaEventHelper.sourceBlob.value}),this.props.onHeightChanged();else{var e;k.a.log("NOT preloading video");const t=this.props.mxEvent.getContent();let i=null==t||null===(e=t.info)||void 0===e?void 0:e.mimetype;"video/quicktime"==i&&(i="video/mp4"),this.setState({decryptedUrl:`data:${i},`,decryptedThumbnailUrl:n||`data:${i},`,decryptedBlob:null})}}catch(e){k.a.warn("Unable to decrypt attachment: ",e),this.setState({error:e})}}componentWillUnmount(){h.b.unwatchSetting(this.sizeWatcher)}get showFileBody(){return this.context.timelineRenderingType!==N.a.Room&&this.context.timelineRenderingType!==N.a.Pinned&&this.context.timelineRenderingType!==N.a.Search}render(){var e,t,n,i;const s=this.props.mxEvent.getContent(),o=h.b.getValue("autoplayVideo");let a;null!==(e=s.info)&&void 0!==e&&e.w&&null!==(t=s.info)&&void 0!==t&&t.h&&(a=`${s.info.w}/${s.info.h}`);const{w:c,h:l}=Object(D.b)(h.b.getValue("Images.size"),{w:null===(n=s.info)||void 0===n?void 0:n.w,h:null===(i=s.info)||void 0===i?void 0:i.h}),d=r.a.createElement("div",{style:{width:c,height:l}});if(null!==this.state.error)return r.a.createElement(M.a,{className:"mx_MVideoBody"},Object(x.a)("Error decrypting video"),this.props.scBubbleActionBar,this.props.scBubbleTimestamp);if(!this.props.forExport&&void 0!==s.file&&null===this.state.decryptedUrl&&o)return r.a.createElement("span",{className:"mx_MVideoBody"},r.a.createElement("div",{className:"mx_MVideoBody_container",style:{maxWidth:c,maxHeight:l,aspectRatio:a}},r.a.createElement(T.a,null)),d,this.props.scBubbleActionBar,this.props.scBubbleTimestamp);const u=this.getContentUrl(),m=this.getThumbUrl();let p=null,g="metadata";s.info&&m&&(p=m,g="none");const v=this.getFileBody();return r.a.createElement("span",{className:"mx_MVideoBody"},r.a.createElement("div",{className:"mx_MVideoBody_container",style:{maxWidth:c,maxHeight:l,aspectRatio:a}},r.a.createElement("video",{className:"mx_MVideoBody",ref:this.videoRef,src:u,title:s.body,controls:!0,controlsList:"nodownload",preload:g,muted:o,autoPlay:o,poster:p,onPlay:this.videoOnPlay}),d),v,this.props.scBubbleActionBar,this.props.scBubbleTimestamp)}}s()(A,"contextType",N.b);var L=n(163);class U extends y.a{constructor(){super(...arguments),s()(this,"onClick",(e=>{e.preventDefault(),this.state.showImage||this.showImage()}))}wrapImage(e,t){let n=null;return this.state.showImage||(n=this.onClick),r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_MStickerBody_wrapper",onClick:n}," ",t," "),this.props.scBubbleTimestamp)}getPlaceholder(e,t){var i;return null!==(i=this.props.mxEvent.getContent().info)&&void 0!==i&&i[P.a]?super.getPlaceholder(e,t):r.a.createElement("img",{className:"mx_MStickerBody_placeholder",src:n(1569).default,width:"80",height:"80",onMouseEnter:this.onImageEnter,onMouseLeave:this.onImageLeave})}getTooltip(){const e=this.props.mxEvent&&this.props.mxEvent.getContent();return e&&e.body&&e.info&&e.info.w?r.a.createElement("div",{style:{left:e.info.w+"px"},className:"mx_MStickerBody_tooltip"},r.a.createElement(L.b,{label:e.body})):null}getFileBody(){return null}getBanner(e){return null}}var F=n(319),B=n(134),V=n.n(B),K=n(137),$=n(55),H=n(643),W=n(296),q=n(475);const G=["mxEvent"],z=e=>{const t=Object(o.useContext)(f.a),[n,i]=Object(o.useState)(),[s,r]=Object(o.useState)(!1),a=(e=>{const t=e.getRelation();return null==t?void 0:t.event_id})(e);return Object(o.useEffect)((()=>{var s;const o=t.getRoom(e.getRoomId());if(n||!o||!a)return;const c=o.getUnfilteredTimelineSet(),l=null==c||null===(s=c.getTimelineForEvent(a))||void 0===s?void 0:s.getEvents().find((e=>e.getId()===a));l?l.getSender()===e.getSender()&&i(l):(async(n,s)=>{r(!0);try{const r=await t.fetchRoomEvent(n,s),a=new K.MatrixEvent(r);null==o||o.processPollEvents([a,e]),a.getSender()===e.getSender()&&i(a)}catch(e){k.a.error("Failed to fetch related poll start event",e)}finally{r(!1)}})(o.roomId,a)}),[e,a,n,t]),{pollStartEvent:n,isLoadingPollStartEvent:s}},J=r.a.forwardRef(((e,t)=>{let{mxEvent:n}=e,i=V()(e,G);const{pollStartEvent:s,isLoadingPollStartEvent:o}=z(n);if(!s){const e=$.c.findIn(n.getContent())||Object(W.b)(n);return r.a.createElement(r.a.Fragment,null,r.a.createElement(H.a,{className:"mx_MPollEndBody_icon"}),!o&&e)}return r.a.createElement("div",null,r.a.createElement(q.a,null,Object(x.a)("Ended a poll")),r.a.createElement(F.d,I()({mxEvent:s},i)))}));var Y=n(225),Q=n(128),X=n(233),Z=n(248),ee=n(136),te=n(127),ne=n.n(te),ie=n(559),se=n(142),oe=n(245),re=n(558);var ae=n(145);const ce=e=>{let{id:t,centerGeoUri:n,onError:i,interactive:s,bounds:r,allowGeolocate:a}=e;const c=`mx_Map_${t}`,l=Object(o.useContext)(f.a),d=Object(se.b)(l,K.ClientEvent.ClientWellKnown,(e=>{var t;return null===(t=Object(oe.h)(e))||void 0===t?void 0:t.map_style_url})),u=(e=>{let{interactive:t,bodyId:n,onError:i}=e;const[s,r]=Object(o.useState)();return Object(o.useEffect)((()=>{try{r(Object(re.a)(!!t,n,i))}catch(e){null==i||i(e)}return()=>{s&&(s.remove(),r(void 0))}}),[t,n,i]),s})({interactive:s,bodyId:c,onError:i});Object(o.useEffect)((()=>{d&&u&&u.setStyle(d)}),[d,u]),Object(o.useEffect)((()=>{if(u&&n)try{const e=Object(X.i)(n);if(!e)throw new Error("Invalid geo URI");u.setCenter({lon:e.longitude,lat:e.latitude})}catch(e){k.a.error("Could not set map center")}}),[u,n]),Object(o.useEffect)((()=>{if(u&&r)try{const e=new ie.LngLatBounds([r.west,r.south],[r.east,r.north]);u.fitBounds(e,{padding:100,maxZoom:15})}catch(e){k.a.error("Invalid map bounds")}}),[u,r]);const[h,m]=Object(o.useState)(null);return Object(o.useEffect)((()=>{if(u){if(a&&!h){const e=new ie.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!1});m(e),u.addControl(e)}!a&&h&&(u.removeControl(h),m(null))}}),[u,h,a]),Object(o.useEffect)((()=>{if(h)return h.on("error",le),()=>{h.off("error",le)}}),[h]),{map:u,bodyId:c}},le=e=>{var t;k.a.error("Could not fetch location",e),Q.b.createDialog(ae.a,{title:Object(x.a)("Could not fetch location"),description:null!==(t=Object(X.j)(e.code))&&void 0!==t?t:""})};var de=e=>{let{bounds:t,centerGeoUri:n,children:i,className:s,allowGeolocate:o,id:a,interactive:c,onError:l,onClick:d}=e;const{map:u,bodyId:h}=ce({centerGeoUri:n,onError:l,id:a,interactive:c,bounds:t,allowGeolocate:o});return r.a.createElement("div",{className:ne()("mx_Map",s),id:h,onClick:e=>{e.target.classList.contains("maplibregl-ctrl-attrib-button")||d&&d()}},!!i&&!!u&&i({map:u}))},ue=n(898);var he,me=e=>{let{id:t,map:n,geoUri:i,roomMember:s,useMemberColor:a,tooltip:c}=e;const{onElementRef:l}=((e,t)=>{const[n,i]=Object(o.useState)(),s=Object(o.useCallback)((s=>{if(n||!s)return;const o=Object(X.i)(t);if(o){const t=Object(X.c)(o,s);t.addTo(e),i(t)}}),[n,t,e]);return Object(o.useEffect)((()=>{if(n){const e=Object(X.i)(t);e&&n.setLngLat({lon:e.longitude,lat:e.latitude})}}),[n,t]),Object(o.useEffect)((()=>()=>{n&&n.remove()}),[n]),{marker:n,onElementRef:s}})(n,i);return r.a.createElement("span",null,r.a.createElement(ue.a,{ref:l,id:t,roomMember:s,useMemberColor:a,tooltip:c}))},pe=n(124);function ge(){return ge=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ge.apply(this,arguments)}function ve(e){return o.createElement("svg",ge({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0},e),he||(he=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M8.783 2.783a.783.783 0 10-1.566 0v4.434H2.783a.783.783 0 000 1.566h4.434v4.435a.783.783 0 001.566 0V8.783h4.435a.783.783 0 000-1.566H8.783V2.783z",fill:"currentColor"})))}var fe;function be(){return be=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},be.apply(this,arguments)}function ye(e){return o.createElement("svg",be({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0},e),fe||(fe=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M2 8c0-.432.35-.783.783-.783h10.434a.783.783 0 110 1.566H2.783A.783.783 0 012 8z",fill:"currentColor"})))}var Se=e=>{let{map:t}=e;return r.a.createElement("div",{className:"mx_ZoomButtons"},r.a.createElement(pe.a,{onClick:()=>{t.zoomIn()},"data-testid":"map-zoom-in-button",title:Object(x.a)("Zoom in"),className:"mx_ZoomButtons_button"},r.a.createElement(ve,{className:"mx_ZoomButtons_icon"})),r.a.createElement(pe.a,{onClick:()=>{t.zoomOut()},"data-testid":"map-zoom-out-button",title:Object(x.a)("Zoom out"),className:"mx_ZoomButtons_button"},r.a.createElement(ye,{className:"mx_ZoomButtons_icon"})))};class Ee extends r.a.Component{constructor(e){super(e),s()(this,"getBodyId",(()=>`mx_LocationViewDialog_${this.props.mxEvent.getId()}`)),s()(this,"onError",(e=>{this.setState({error:e})})),this.state={error:void 0}}render(){const{mxEvent:e}=this.props,t=Object(X.f)(e.getContent())&&e.sender||void 0,n=Object(X.g)(e);return r.a.createElement(ee.a,{className:"mx_LocationViewDialog",onFinished:this.props.onFinished,fixedWidth:!1},r.a.createElement(de,{id:this.getBodyId(),centerGeoUri:n,onError:this.onError,interactive:!0,className:"mx_LocationViewDialog_map",allowGeolocate:!0},(e=>{let{map:i}=e;return r.a.createElement(r.a.Fragment,null,r.a.createElement(me,{map:i,id:`${this.getBodyId()}-marker`,geoUri:n,roomMember:t}),r.a.createElement(Se,{map:i}))})))}}var we=n(633);class _e extends r.a.Component{constructor(e){super(e),s()(this,"context",void 0),s()(this,"unmounted",!1),s()(this,"mapId",void 0),s()(this,"reconnectedListener",void 0),s()(this,"onClick",(()=>{Q.b.createDialog(Ee,{matrixClient:this.context,mxEvent:this.props.mxEvent},"mx_LocationViewDialog_wrapper",!1,!0)})),s()(this,"clearError",(()=>{this.context.off(K.ClientEvent.Sync,this.reconnectedListener),this.setState({error:void 0})})),s()(this,"onError",(e=>{this.unmounted||(this.setState({error:e}),this.context.off(K.ClientEvent.Sync,this.reconnectedListener),this.context.on(K.ClientEvent.Sync,this.reconnectedListener))}));const t=`${e.mxEvent.getId()}_${Object(Y.b)(8)}`;this.mapId=`mx_MLocationBody_${t}`,this.reconnectedListener=Object(we.a)(this.clearError),this.state={error:void 0}}componentWillUnmount(){this.unmounted=!0,this.context.off(K.ClientEvent.Sync,this.reconnectedListener)}render(){return this.state.error?r.a.createElement(Ce,{error:this.state.error,event:this.props.mxEvent}):r.a.createElement(Oe,{mxEvent:this.props.mxEvent,mapId:this.mapId,onError:this.onError,tooltip:Object(x.a)("Expand map"),onClick:this.onClick})}}s()(_e,"contextType",f.a);const Ce=e=>{var t,n;let{error:i,event:s}=e;const o=null==i?void 0:i.message,a=`${Object(x.a)("Unable to load map")}: ${Object(X.e)(o)}`,c=Object(X.f)(s.getContent())?Object(x.a)("Shared their location: ")+(null===(t=s.getContent())||void 0===t?void 0:t.body):Object(x.a)("Shared a location: ")+(null===(n=s.getContent())||void 0===n?void 0:n.body);return r.a.createElement("div",{className:"mx_EventTile_body mx_MLocationBody"},r.a.createElement("span",{className:o!==X.a.MapStyleUrlNotConfigured?"mx_EventTile_tileError":""},a),r.a.createElement("br",null),c)},Oe=e=>{let{mxEvent:t,mapId:n,tooltip:i,onError:s,onClick:o}=e;const a=Object(X.f)(t.getContent())?t.sender:void 0,c=Object(X.g)(t),l=r.a.createElement(de,{id:n,centerGeoUri:c,onClick:o,onError:s,className:"mx_MLocationBody_map"},(e=>{let{map:t}=e;return r.a.createElement(me,{map:t,id:`${n}-marker`,geoUri:c,roomMember:a})}));return r.a.createElement("div",{className:"mx_MLocationBody"},i?r.a.createElement(Z.a,{label:i,alignment:L.a.InnerBottom,maxParentWidth:450},l):l)};class Ie extends r.a.Component{constructor(){super(...arguments),s()(this,"onAllowClick",(e=>{e.preventDefault(),e.stopPropagation();const t=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;localStorage.setItem(t,"true"),this.props.onMessageAllowed()}))}render(){return r.a.createElement("div",{className:"mx_MjolnirBody"},r.a.createElement("i",null,Object(x.a)("You have ignored this user, so their message is hidden. <a>Show anyways.</a>",{},{a:e=>r.a.createElement(pe.a,{kind:"link_inline",onClick:this.onAllowClick},e)})))}}var Re=n(273);let ke;!function(e){e.Loading="Loading",e.Error="Error",e.Stopped="Stopped",e.Active="Active"}(ke||(ke={}));var xe=n(347),Te=n(899),je=n(166);const Pe=["beacon","displayStatus","displayLiveTimeRemaining","label","className","children","withIcon"],De=e=>{let{beacon:t}=e;const n=Object(je.m)(new Date(Object(Re.c)(t)));return r.a.createElement("span",{className:"mx_BeaconStatus_expiryTime"},Object(x.a)("Live until %(expiryTime)s",{expiryTime:n}))};var Ne=e=>{let{beacon:t,displayStatus:n,displayLiveTimeRemaining:i,label:s,className:o,children:a,withIcon:c}=e,l=V()(e,Pe);const d=n===ke.Loading||n===ke.Stopped;return r.a.createElement("div",I()({},l,{className:ne()("mx_BeaconStatus",`mx_BeaconStatus_${n}`,o)}),c&&r.a.createElement(xe.a,{className:"mx_BeaconStatus_icon",withError:n===ke.Error,isIdle:d}),r.a.createElement("div",{className:"mx_BeaconStatus_description"},n===ke.Loading&&r.a.createElement("span",{className:"mx_BeaconStatus_description_status"},Object(x.a)("Loading live location…")),n===ke.Stopped&&r.a.createElement("span",{className:"mx_BeaconStatus_description_status"},Object(x.a)("Live location ended")),n===ke.Error&&r.a.createElement("span",{className:"mx_BeaconStatus_description_status"},Object(x.a)("Live location error")),n===ke.Active&&t&&r.a.createElement(r.a.Fragment,null,r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"mx_BeaconStatus_label"},s),i?r.a.createElement(Te.a,{beacon:t}):r.a.createElement(De,{beacon:t})))),a)},Me=n(647);const Ae=["beacon","displayStatus"];var Le,Ue,Fe=e=>{let{beacon:t,displayStatus:n}=e,i=V()(e,Ae);const{hasLocationPublishError:s,hasStopSharingError:o,stoppingInProgress:a,onStopSharing:c,onResetLocationPublishError:l}=Object(Re.k)(null!=t&&t.identifier?[null==t?void 0:t.identifier]:[]),d=s||o?ke.Error:n;return r.a.createElement(Ne,I()({beacon:t,displayStatus:d,label:Object(x.a)("Live location enabled"),displayLiveTimeRemaining:!0},i),d===ke.Active&&r.a.createElement(pe.a,{"data-test-id":"beacon-status-stop-beacon",kind:"link",onClick:Object(Me.a)(c),className:"mx_OwnBeaconStatus_button mx_OwnBeaconStatus_destructiveButton",disabled:a},Object(x.a)("Stop")),s&&r.a.createElement(pe.a,{"data-test-id":"beacon-status-reset-wire-error",kind:"link",onClick:Object(Me.a)(l),className:"mx_OwnBeaconStatus_button mx_OwnBeaconStatus_destructiveButton"},Object(x.a)("Retry")),o&&r.a.createElement(pe.a,{"data-test-id":"beacon-status-stop-beacon-retry",kind:"link",onClick:Object(Me.a)(c),className:"mx_OwnBeaconStatus_button mx_OwnBeaconStatus_destructiveButton"},Object(x.a)("Retry")))},Be=n(648),Ve=n(644);function Ke(){return Ke=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},Ke.apply(this,arguments)}function $e(e){return o.createElement("svg",Ke({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 848 556",role:"presentation","aria-hidden":!0},e),o.createElement("mask",{id:"map_svg__a",style:{maskType:"alpha"},maskUnits:"userSpaceOnUse",x:0,y:0,width:848,height:556},Le||(Le=o.createElement("path",{fill:"currentColor",d:"M0 0h847.147v555.685H0z"}))),Ue||(Ue=o.createElement("g",{mask:"url(#map_svg__a)"},o.createElement("circle",{cx:424.936,cy:277.842,r:495.758}),o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M424.935 874.689c329.63 0 596.845-267.217 596.845-596.847S754.565-319.005 424.935-319.005c-329.629 0-596.846 267.218-596.846 596.847 0 329.63 267.217 596.847 596.846 596.847zM-46.544 6.905L920.48 442.347l-47.338 105.126-434.953-195.856-219.202 482.882-104.982-47.656L333.061 304.28-93.881 112.031-46.544 6.905z",fill:"currentColor"}))))}var He=n(135);const We=["className","isLoading","children"];var qe=e=>{let{className:t,isLoading:n,children:i}=e,s=V()(e,We);return r.a.createElement("div",I()({className:ne()("mx_MapFallback",t)},s),r.a.createElement($e,{className:"mx_MapFallback_bg"}),n?r.a.createElement(He.a,{h:32,w:32}):r.a.createElement(Ve.a,{className:"mx_MapFallback_icon"}),i)},Ge=n(645);var ze=e=>{var t;let{map:n,beacon:i,tooltip:s}=e;const a=Object(se.b)(i,K.BeaconEvent.LocationUpdate,(()=>i.latestLocationState)),c=Object(o.useContext)(f.a).getRoom(i.roomId);if(!a||!i.isLive)return null;const d=a.uri||"",u=(null===(t=i.beaconInfo)||void 0===t?void 0:t.assetType)===l.a.Self,h=null==c?void 0:c.getMember(i.beaconInfoOwner),m=u&&h?h:void 0;return r.a.createElement(me,{map:n,id:i.identifier,geoUri:d,roomMember:m,tooltip:s,useMemberColor:!0})};const Je=e=>{const t=e.filter((e=>!!e.latestLocationState)).map((e=>Object(X.i)(e.latestLocationState.uri)));if(!t.length)return;const n=[...t].sort(((e,t)=>t.latitude-e.latitude)),i=[...t].sort(((e,t)=>t.longitude-e.longitude));return n.length<1||i.length<1?void 0:{north:n[0].latitude,south:n[n.length-1].latitude,east:i[0].longitude,west:i[i.length-1].longitude}};var Ye,Qe=n(900),Xe=n(176),Ze=n(741),et=n(173);function tt(){return tt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},tt.apply(this,arguments)}function nt(e){return o.createElement("svg",tt({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 11 10",role:"presentation","aria-hidden":!0},e),Ye||(Ye=o.createElement("path",{d:"M8.5 5.5v3a1 1 0 01-1 1H2a1 1 0 01-1-1V3a1 1 0 011-1h3M7 .5h3v3M4.5 6L10 .5",fill:"none",fillRule:"evenodd",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})))}var it=n(302);var st=e=>{let{latestLocationState:t}=e;const[n,i]=Object(o.useState)();if(Object(o.useEffect)((()=>{if(null==t||!t.uri)return;const e=Object(X.i)(t.uri);i(e)}),[t]),!t||!n)return null;const s=`${n.latitude},${n.longitude}`,a=Object(X.h)(n);return r.a.createElement(r.a.Fragment,null,r.a.createElement(Z.a,{label:Object(x.a)("Open in OpenStreetMap")},r.a.createElement("a",{"data-testid":"open-location-in-osm",href:a,target:"_blank",rel:"noreferrer noopener"},r.a.createElement(nt,{className:"mx_ShareLatestLocation_icon"}))),r.a.createElement(it.a,{className:"mx_ShareLatestLocation_copy",border:!1,getTextToCopy:()=>s}))};const ot=["beacon"];var rt=e=>{var t,n;let{beacon:i}=e,s=V()(e,ot);const a=Object(se.b)(i,K.BeaconEvent.LocationUpdate,(()=>i.latestLocationState)),c=Object(o.useContext)(f.a).getRoom(i.roomId);if(!a||!i.isLive||!c)return null;const d=(null===(t=i.beaconInfo)||void 0===t?void 0:t.assetType)===l.a.Self,u=d?c.getMember(i.beaconInfoOwner):null,h=a.timestamp&&Object(Ze.a)(a.timestamp)||"";return r.a.createElement("li",I()({className:"mx_BeaconListItem"},s),d?r.a.createElement(et.b,{className:"mx_BeaconListItem_avatar",member:u,height:32,width:32}):r.a.createElement(xe.a,{className:"mx_BeaconListItem_avatarIcon"}),r.a.createElement("div",{className:"mx_BeaconListItem_info"},r.a.createElement(Ne,{className:"mx_BeaconListItem_status",beacon:i,label:(null==u?void 0:u.name)||(null===(n=i.beaconInfo)||void 0===n?void 0:n.description)||i.beaconInfoOwner,displayStatus:ke.Active},r.a.createElement("div",{className:"mx_BeaconListItem_interactions",onClick:Object(Me.a)((()=>{}))},r.a.createElement(st,{latestLocationState:a}))),r.a.createElement("span",{className:"mx_BeaconListItem_lastUpdated"},Object(x.a)("Updated %(humanizedUpdateTime)s",{humanizedUpdateTime:h}))))};var at=e=>{let{beacons:t,onBeaconClick:n,requestClose:i}=e;return r.a.createElement("div",{className:"mx_DialogSidebar"},r.a.createElement("div",{className:"mx_DialogSidebar_header"},r.a.createElement(Xe.a,{size:"h4"},Object(x.a)("View List")),r.a.createElement(pe.a,{className:"mx_DialogSidebar_closeButton",onClick:i,title:Object(x.a)("Close sidebar"),"data-testid":"dialog-sidebar-close"},r.a.createElement(Qe.a,{className:"mx_DialogSidebar_closeButtonIcon"}))),null!=t&&t.length?r.a.createElement("ol",{className:"mx_DialogSidebar_list"},t.map((e=>r.a.createElement(rt,{key:e.identifier,beacon:e,onClick:()=>n(e)})))):r.a.createElement("div",{className:"mx_DialogSidebar_noResults"},Object(x.a)("No live locations")))},ct=n(346);var lt=e=>{var t;let{roomId:n}=e;const i=(e=>Object(se.b)(ct.a.instance,ct.b.LivenessChange,(()=>{const[t]=ct.a.instance.getLiveBeaconIds(e);return ct.a.instance.getBeaconById(t)})))(n),s=Object(o.useContext)(f.a).getRoom(n);if(null==i||!i.isLive||!s)return null;const a=(null===(t=i.beaconInfo)||void 0===t?void 0:t.assetType)===l.a.Self,c=a?s.getMember(i.beaconInfoOwner):null;return r.a.createElement("div",{className:"mx_DialogOwnBeaconStatus"},a?r.a.createElement(et.b,{className:"mx_DialogOwnBeaconStatus_avatar",member:c,height:32,width:32}):r.a.createElement(xe.a,{className:"mx_DialogOwnBeaconStatus_avatarIcon"}),r.a.createElement(Fe,{className:"mx_DialogOwnBeaconStatus_status",beacon:i,displayStatus:ke.Active}))};var dt=e=>{let{beacon:t}=e;const n=(e=>{var t;const n=Object(o.useContext)(f.a);var i;if((null===(t=e.beaconInfo)||void 0===t?void 0:t.assetType)!==l.a.Self)return null===(i=e.beaconInfo)||void 0===i?void 0:i.description;const s=n.getRoom(e.roomId),r=null==s?void 0:s.getMember(e.beaconInfoOwner);return(null==r?void 0:r.rawDisplayName)||e.beaconInfoOwner})(t);return r.a.createElement("div",{className:"mx_BeaconStatusTooltip"},r.a.createElement(Ne,{beacon:t,label:n,displayStatus:ke.Active,displayLiveTimeRemaining:!0,className:"mx_BeaconStatusTooltip_inner"},r.a.createElement(st,{latestLocationState:t.latestLocationState})))};const ut=(e,t)=>{var n;let{beacon:i,ts:s}=t;const[r,a]=Object(o.useState)(Je(e)),[c,l]=Object(o.useState)((null==i||null===(n=i.latestLocationState)||void 0===n?void 0:n.uri)||(e=>{if(e)return Object(Re.f)({latitude:(e.north+e.south)/2,longitude:(e.east+e.west)/2,timestamp:Date.now()})})(r));return Object(o.useEffect)((()=>{var e,t;0!==s&&null!=i&&null!==(e=i.latestLocationState)&&void 0!==e&&e.uri&&(l(`${null==i||null===(t=i.latestLocationState)||void 0===t?void 0:t.uri};mxTs=${Date.now()}`),a(Je([i])))}),[i,s]),{bounds:r,centerGeoUri:c}};var ht=e=>{let{initialFocusedBeacon:t,roomId:n,matrixClient:i,onFinished:s}=e;const a=((e,t)=>{const n=t.getRoom(e);return Object(se.b)(null==n?void 0:n.currentState,K.RoomStateEvent.BeaconLiveness,(()=>{var e;return null==n||null===(e=n.currentState)||void 0===e?void 0:e.liveBeaconIds.map((e=>n.currentState.beacons.get(e)))}))})(n,i),[c,l]=Object(o.useState)({beacon:t,ts:0}),[d,u]=Object(o.useState)(!1),{bounds:h,centerGeoUri:m}=ut(a,c),[p,g]=Object(o.useState)();Object(o.useEffect)((()=>{p&&u(!0)}),[p]);const v=a.filter((e=>(null==e?void 0:e.beaconInfoOwner)===i.getUserId())).length>0;return r.a.createElement(ee.a,{className:"mx_BeaconViewDialog",onFinished:s,fixedWidth:!1},r.a.createElement(f.a.Provider,{value:i},m&&!p&&r.a.createElement(de,{id:"mx_BeaconViewDialog",bounds:h,centerGeoUri:m,interactive:!0,onError:g,className:"mx_BeaconViewDialog_map",allowGeolocate:!v},(e=>{let{map:t}=e;return r.a.createElement(r.a.Fragment,null,a.map((e=>r.a.createElement(ze,{key:e.identifier,map:t,beacon:e,tooltip:r.a.createElement(dt,{beacon:e})}))),r.a.createElement(Se,{map:t}))})),p&&r.a.createElement(Be.a,{error:p.message,isMinimised:!0}),!m&&!p&&r.a.createElement(qe,{"data-testid":"beacon-view-dialog-map-fallback",className:"mx_BeaconViewDialog_map"},r.a.createElement("span",{className:"mx_BeaconViewDialog_mapFallbackMessage"},Object(x.a)("No live locations")),r.a.createElement(pe.a,{kind:"primary",onClick:s,"data-testid":"beacon-view-dialog-fallback-close"},Object(x.a)("Close"))),d?r.a.createElement(at,{beacons:a,onBeaconClick:e=>{l({beacon:e,ts:Date.now()})},requestClose:()=>u(!1)}):r.a.createElement(pe.a,{kind:"primary",onClick:()=>u(!0),"data-testid":"beacon-view-dialog-open-sidebar",className:"mx_BeaconViewDialog_viewListButton"},r.a.createElement(Ge.a,{height:12})," ",Object(x.a)("View list")),r.a.createElement(lt,{roomId:n})))};var mt=r.a.forwardRef(((e,t)=>{let{mxEvent:n,getRelationsForEvent:i}=e;const{beacon:s,isLive:a,latestLocationState:l,waitingToStart:d}=(e=>{const t=Object(Re.j)(e),n=Object(se.b)(t,K.BeaconEvent.LivenessChange,(()=>null==t?void 0:t.isLive)),i=Object(se.b)(t,K.BeaconEvent.LocationUpdate,(()=>null==t?void 0:t.latestLocationState));if(!t)return{};const s=!!t&&Object(Re.g)(t),{description:o}=t.beaconInfo;return{beacon:t,description:o,isLive:n,waitingToStart:s,latestLocationState:i}})(n),u=(e=>{const[t,n]=Object(o.useState)(`${e}_${Object(Y.b)(8)}`);return Object(o.useEffect)((()=>{n(`${e}_${Object(Y.b)(8)}`)}),[e]),t})(n.getId()),h=Object(o.useContext)(f.a),[m,p]=Object(o.useState)(),g=(null==m?void 0:m.message)===X.a.MapStyleUrlNotConfigured||(null==m?void 0:m.message)===X.a.MapStyleUrlNotReachable,v=((e,t,n,i)=>n?ke.Error:i?ke.Loading:e?t?ke.Active:ke.Loading:ke.Stopped)(a,l,g?void 0:m,d),b=Object(X.f)(n.getContent())?n.sender:void 0,y=(null==s?void 0:s.beaconInfoOwner)===h.getUserId();((e,t,n)=>{const i=Object(o.useCallback)(((i,s)=>{var o;const r=n?n(e.getId(),K.RelationType.Reference,c.a.name):void 0;null==r||null===(o=r.getRelations())||void 0===o||o.forEach((e=>{t.redactEvent(e.getRoomId(),e.getId(),void 0,s.getContent())}))}),[e,t,n]);Object(o.useEffect)((()=>(e.addListener(K.MatrixEventEvent.BeforeRedaction,i),()=>{e.removeListener(K.MatrixEventEvent.BeforeRedaction,i)})),[e,i])})(n,h,i);const S=()=>{v===ke.Active&&Q.b.createDialog(ht,{roomId:n.getRoomId(),matrixClient:h,initialFocusedBeacon:s},"mx_BeaconViewDialog_wrapper",!1,!0)};let E;return E=v!==ke.Active||g?g?r.a.createElement(Be.a,{error:m.message,onClick:S,className:ne()("mx_MBeaconBody_mapError",{mx_MBeaconBody_mapErrorInteractive:v===ke.Active}),isMinimised:!0}):r.a.createElement(qe,{isLoading:v===ke.Loading,className:"mx_MBeaconBody_map mx_MBeaconBody_mapFallback"}):r.a.createElement(de,{id:u,centerGeoUri:l.uri,onError:p,onClick:S,className:"mx_MBeaconBody_map"},(e=>{let{map:t}=e;return r.a.createElement(me,{map:t,id:`${u}-marker`,geoUri:l.uri,roomMember:b,useMemberColor:!0})})),r.a.createElement("div",{className:"mx_MBeaconBody",ref:t},E,y?r.a.createElement(Fe,{className:"mx_MBeaconBody_chin",beacon:s,displayStatus:v,withIcon:!0}):r.a.createElement(Ne,{className:"mx_MBeaconBody_chin",beacon:s,displayStatus:v,label:Object(x.a)("View live location"),withIcon:!0}))})),pt=n(901),gt=n(195);const vt=new Map([[a.e.Text,b.a],[a.e.Notice,b.a],[a.e.Emote,b.a],[a.e.Image,y.a],[a.e.File,S.a],[a.e.Audio,C],[a.e.Video,A]]),ft=new Map([[a.b.Sticker,U],[d.e.name,F.d],[d.e.altName,F.d],[d.a.name,J],[d.a.altName,J],[c.b.name,mt],[c.b.altName,mt]]);class bt extends r.a.Component{constructor(e,t){super(e,t),s()(this,"body",Object(o.createRef)()),s()(this,"mediaHelper",void 0),s()(this,"bodyTypes",new Map(vt.entries())),s()(this,"evTypes",new Map(ft.entries())),s()(this,"context",void 0),s()(this,"getEventTileOps",(()=>{var e,t;return(null===(e=this.body.current)||void 0===e||null===(t=e.getEventTileOps)||void 0===t?void 0:t.call(e))||null})),s()(this,"onDecrypted",(()=>{var e;v.a.isEligible(this.props.mxEvent)&&(null===(e=this.mediaHelper)||void 0===e||e.destroy(),this.mediaHelper=new v.a(this.props.mxEvent))})),s()(this,"onTileUpdate",(()=>{this.forceUpdate()})),v.a.isEligible(this.props.mxEvent)&&(this.mediaHelper=new v.a(this.props.mxEvent)),this.updateComponentMaps()}componentDidMount(){this.props.mxEvent.addListener(u.c.Decrypted,this.onDecrypted)}componentWillUnmount(){var e;this.props.mxEvent.removeListener(u.c.Decrypted,this.onDecrypted),null===(e=this.mediaHelper)||void 0===e||e.destroy()}componentDidUpdate(e){var t;this.props.mxEvent!==e.mxEvent&&v.a.isEligible(this.props.mxEvent)&&(null===(t=this.mediaHelper)||void 0===t||t.destroy(),this.mediaHelper=new v.a(this.props.mxEvent));this.updateComponentMaps()}updateComponentMaps(){this.bodyTypes=new Map(vt.entries());for(const[t,n]of Object.entries(null!==(e=this.props.overrideBodyTypes)&&void 0!==e?e:{})){var e;this.bodyTypes.set(t,n)}this.evTypes=new Map(ft.entries());for(const[e,n]of Object.entries(null!==(t=this.props.overrideEventTypes)&&void 0!==t?t:{})){var t;this.evTypes.set(e,n)}}getMediaHelper(){return this.mediaHelper}render(){const e=this.props.mxEvent.getContent(),t=this.props.mxEvent.getType(),n=e.msgtype;let i=p.a;if(this.props.mxEvent.isRedacted()||(i=this.props.mxEvent.isDecryptionFailure()?pt.a:t&&this.evTypes.has(t)?this.evTypes.get(t):n&&this.bodyTypes.has(n)?this.bodyTypes.get(n):e.url?this.bodyTypes.get(a.e.File):g,(l.c.matches(t)||t===a.b.RoomMessage&&n===a.e.Location)&&(i=_e),t===gt.g&&(null==e?void 0:e.state)===gt.h.Started&&(i=gt.b)),h.b.getValue("feature_mjolnir")){const e=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;if(!("true"===localStorage.getItem(e))){const e=this.props.mxEvent.getSender().split(":").slice(1).join(":"),t=m.a.sharedInstance().isUserBanned(this.props.mxEvent.getSender()),n=m.a.sharedInstance().isServerBanned(e);(t||n)&&(i=Ie)}}return i?r.a.createElement(i,{ref:this.body,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,forExport:this.props.forExport,maxImageHeight:this.props.maxImageHeight,replacingEventId:this.props.replacingEventId,editState:this.props.editState,onHeightChanged:this.props.onHeightChanged,onMessageAllowed:this.onTileUpdate,permalinkCreator:this.props.permalinkCreator,mediaEventHelper:this.mediaHelper,scBubble:this.props.scBubble,scBubbleTimestamp:this.props.scBubbleTimestamp,scBubbleActionBar:this.props.scBubbleActionBar,youtubeEmbedPlayer:this.props.youtubeEmbedPlayer,getRelationsForEvent:this.props.getRelationsForEvent,isSeeingThroughMessageHiddenForModeration:this.props.isSeeingThroughMessageHiddenForModeration}):null}}s()(bt,"contextType",f.a)},,function(e,t,n){"use strict";n.d(t,"a",(function(){return ye})),n.d(t,"b",(function(){return Ce}));var i=n(122),s=n.n(i),o=n(127),r=n.n(o),a=n(120),c=n.n(a),l=n(875),d=n.n(l),u=n(1);class h{constructor(){s()(this,"stack",[]),s()(this,"newlyTypedCharCount",0),s()(this,"currentIndex",-1),s()(this,"changedSinceLastPush",!1),s()(this,"lastCaret",null),s()(this,"nonWordBoundarySinceLastPush",!1),s()(this,"addedSinceLastPush",!1),s()(this,"removedSinceLastPush",!1)}clear(){this.stack=[],this.newlyTypedCharCount=0,this.currentIndex=-1,this.changedSinceLastPush=!1,this.lastCaret=null,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}shouldPush(e,t){if(t&&("insertText"===e||"deleteContentForward"===e||"deleteContentBackward"===e)){if(t.added&&(this.addedSinceLastPush=!0),t.removed&&(this.removedSinceLastPush=!0),this.addedSinceLastPush!==this.removedSinceLastPush){const e=t.added?t.added:t.removed,n=" "===e||"\t"===e||"\n"===e;return!(!this.nonWordBoundarySinceLastPush||!n)||(n||(this.nonWordBoundarySinceLastPush=!0),this.newlyTypedCharCount+=e.length,this.newlyTypedCharCount>10)}return!0}return!0}pushState(e,t){for(;this.currentIndex<this.stack.length-1;)this.stack.pop();const n=e.serializeParts();this.stack.push({parts:n,caret:t}),this.currentIndex=this.stack.length-1,this.lastCaret=null,this.changedSinceLastPush=!1,this.newlyTypedCharCount=0,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}tryPush(e,t,n,i){if("historyUndo"===n||"historyRedo"===n)return!1;const s=this.shouldPush(n,i);return s?this.pushState(e,t):(this.lastCaret=t,this.changedSinceLastPush=!0),s}ensureLastChangesPushed(e){this.changedSinceLastPush&&this.pushState(e,this.lastCaret)}canUndo(){return this.currentIndex>=1||this.changedSinceLastPush}canRedo(){return this.currentIndex<this.stack.length-1}undo(e){if(this.canUndo())return this.ensureLastChangesPushed(e),this.currentIndex-=1,this.stack[this.currentIndex]}redo(){if(this.canRedo())return this.changedSinceLastPush=!1,this.currentIndex+=1,this.stack[this.currentIndex]}}var m=n(601),p=n(600),g=n(256);function v(e,t,n){n instanceof p.a?function(e,t,n){const i=document.getSelection();i.removeAllRanges();const s=document.createRange(),o=f(e,t,n.start);s.setStart(o.node,o.offset);const r=f(e,t,n.end);s.setEnd(r.node,r.offset),i.addRange(s)}(e,t,n):function(e,t,n){if(t.isEmpty)return;const i=document.createRange(),{node:s,offset:o}=f(e,t,n);i.setStart(s,o),i.collapse(!0);const r=document.getSelection();if(1===r.rangeCount){const e=r.getRangeAt(0);if(e.startContainer===i.startContainer&&e.startOffset===i.startOffset&&e.collapsed===i.collapsed)return}r.removeAllRanges(),r.addRange(i)}(e,t,n)}function f(e,t,n){const{offset:i,lineIndex:s,nodeIndex:o}=function(e,t){const{parts:n}=e,i=t.index,s=function(e,t){let n,i=0,s=-1;for(let o=0;o<=t;++o){const r=e[o];if(r.type===g.b.Newline)i+=1,s=-1,n=void 0;else{if(s+=1,Object(m.d)(r,n)&&(s+=1),o<t){const t=e[o+1],n=!t||t.type===g.b.Newline;Object(m.c)(r,n)&&(s+=1)}n=r}}return{lineIndex:i,nodeIndex:s}}(n,i),{lineIndex:o}=s;let{nodeIndex:r}=s,{offset:a}=t;-1===r?a=0:({nodeIndex:r,offset:a}=function(e,t,n,i){const s=e[t];if(s&&!s.acceptsCaret)if(0===i){n-=1;const o=e[t-1];Object(m.d)(s,o)||(i=o.text.length)}else n+=1,i=0;return{nodeIndex:n,offset:i}}(n,i,r,a));return{lineIndex:o,nodeIndex:r,offset:a}}(t,n),r=e.childNodes[s];let a;return-1===o?a=r:(a=r.childNodes[o],a.nodeType===Node.ELEMENT_NODE&&a.firstChild&&(a=a.firstChild)),{node:a,offset:i}}var b=n(121),y=n(148);let S;!function(e){e.Bold="bold",e.Italics="italics",e.Strikethrough="strikethrough",e.Code="code",e.Quote="quote",e.InsertLink="insert_link"}(S||(S={}));class E extends c.a.PureComponent{constructor(e){super(e),s()(this,"formatBarRef",Object(a.createRef)()),this.state={visible:!1}}render(){const e=r()("mx_MessageComposerFormatBar",{mx_MessageComposerFormatBar_shown:this.state.visible});return c.a.createElement("div",{className:e,ref:this.formatBarRef},c.a.createElement(w,{label:Object(b.a)("Bold"),onClick:()=>this.props.onAction(S.Bold),icon:"Bold",shortcut:this.props.shortcuts.bold,visible:this.state.visible}),c.a.createElement(w,{label:Object(b.a)("Italics"),onClick:()=>this.props.onAction(S.Italics),icon:"Italic",shortcut:this.props.shortcuts.italics,visible:this.state.visible}),c.a.createElement(w,{label:Object(b.a)("Strikethrough"),onClick:()=>this.props.onAction(S.Strikethrough),icon:"Strikethrough",visible:this.state.visible}),c.a.createElement(w,{label:Object(b.a)("Code block"),onClick:()=>this.props.onAction(S.Code),icon:"Code",shortcut:this.props.shortcuts.code,visible:this.state.visible}),c.a.createElement(w,{label:Object(b.a)("Quote"),onClick:()=>this.props.onAction(S.Quote),icon:"Quote",shortcut:this.props.shortcuts.quote,visible:this.state.visible}),c.a.createElement(w,{label:Object(b.a)("Insert link"),onClick:()=>this.props.onAction(S.InsertLink),icon:"InsertLink",shortcut:this.props.shortcuts.insert_link,visible:this.state.visible}))}showAt(e){if(!this.formatBarRef.current)return;this.setState({visible:!0});const t=this.formatBarRef.current.parentElement.getBoundingClientRect();this.formatBarRef.current.style.left=e.left-t.left+"px";const n=this.formatBarRef.current.clientHeight/2,i=n+(n+2),s=Math.max(e.top-t.top-i,-i);this.formatBarRef.current.style.top=`${s}px`}hide(){this.setState({visible:!1})}}class w extends c.a.PureComponent{render(){const e=`mx_MessageComposerFormatBar_button mx_MessageComposerFormatBar_buttonIcon${this.props.icon}`;let t;this.props.shortcut&&(t=c.a.createElement("div",{className:"mx_MessageComposerFormatBar_tooltipShortcut"},this.props.shortcut));const n=c.a.createElement("div",null,c.a.createElement("div",{className:"mx_Tooltip_title"},this.props.label),c.a.createElement("div",{className:"mx_Tooltip_sub"},t));return c.a.createElement(y.a,{element:"button",type:"button",onClick:this.props.onClick,title:this.props.label,tooltip:n,className:e})}}var _=n(468);function C(e,t){if(e.wasInitializedEmpty()?function(e){e.expandForwardsWhile(R),e.expandBackwardsWhile(R),e.trim()}(e):e.trim(),0!==e.length)switch(t){case S.Bold:D(e,"**");break;case S.Italics:D(e,"_");break;case S.Strikethrough:D(e,"<del>","</del>");break;case S.Code:!function(e){const{model:t,parts:n}=e,{partCreator:i}=t,s=e.length>0&&e.text.startsWith("```")&&e.text.endsWith("```")&&e.text.includes("\n"),o=n.some((e=>e.type===g.b.Newline));if(s){var r,a;n.shift(),n.pop(),"\n"===(null===(r=n[0])||void 0===r?void 0:r.text)&&"\n"===(null===(a=n[n.length-1])||void 0===a?void 0:a.text)&&(n.shift(),n.pop())}else{if(!o){const t=Object(_.a)(e.text),n=e.text.startsWith("`")&&e.text.endsWith("`");return void D(e,"`".repeat(n?t:t+1))}n.unshift(i.plain("```"),i.newline()),k(e)||n.unshift(i.newline()),n.push(i.newline(),i.plain("```")),x(e)||n.push(i.newline())}O(e,n)}(e);break;case S.Quote:!function(e){const{model:t,parts:n}=e,{partCreator:i}=t;for(let e=0;e<n.length;++e){n[e].type===g.b.Newline&&n.splice(e+1,0,i.plain("> "))}n.unshift(i.plain("> ")),k(e)||n.unshift(i.newline());x(e)||n.push(i.newline());n.push(i.newline()),O(e,n)}(e);break;case S.InsertLink:T(e)}}function O(e,t){const{model:n}=e;n.transform((()=>{const i=e.length,s=e.replace(t),o=e.start.asOffset(n),r=o.add(i+s);return n.startRange(o.asPosition(n),r.asPosition(n))}))}function I(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const{model:s}=e;s.transform((()=>{const o=e.length,r=e.replace(t);return e.start.asOffset(s).add(o+r+n,i).asPosition(s)}))}const R=(e,t,n)=>" "!==n.text[t]&&n.type===g.b.Plain;function k(e){const{model:t}=e,n=0!==e.start.offset,i=0===e.start.index,s=!i&&t.parts[e.start.index-1].type===g.b.Newline;return!n&&(i||s)}function x(e){const{model:t}=e,n=t.parts[e.end.index],i=e.end.offset!==n.text.length,s=e.end.index===t.parts.length-1,o=!s&&t.parts[e.end.index+1].type===g.b.Newline;return!i&&(s||o)}function T(e,t){const{model:n}=e,{partCreator:i}=n,s=/\[(.*?)]\(.*?\)/g;if(s.test(e.text)){const t=e.text.replace(s,"$1");I(e,[i.plain(t)],0)}else I(e,[i.plain("["+e.text+"]("+(null!=t?t:"")+")")],-1)}const j=e=>!e.text||!/\S/.test(e.text),P=e=>e.type===g.b.Newline;function D(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;const{model:i,parts:s}=e,{partCreator:o}=i,r=[];let a=0;for(let e=2;e<s.length;e++)j(s[e-2])&&P(s[e-1])&&!P(s[e])&&!j(s[e])&&(a=e),P(s[e-1])&&P(s[e])?(r.push([a,e-1]),a=e+1):P(s[e-2])&&j(s[e-1])&&P(s[e])&&(r.push([a,e-2]),a=e+1);const c=s.map(j).lastIndexOf(!1);a<=c&&r.push([a,c+1]);let l=0;if(r.forEach((e=>{let[i,r]=e;const a=i+l,c=r+l;if(c-a>0&&s[a].text.startsWith(t)&&s[c-1].text.endsWith(n)){const e=s[a].serialize();e.text=e.text.slice(t.length),s[a]=o.deserializePart(e);const i=s[c-1].serialize(),r=i.text;i.text=r.substring(0,r.length-n.length),s[c-1]=o.deserializePart(i)}else s.splice(c,0,o.plain(n)),s.splice(a,0,o.plain(t)),l+=2})),e.wasInitializedEmpty()&&t===n){const i=e.text.startsWith(t)&&e.text.endsWith(n);!function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:i;const{model:o}=e,r=e.getLastStartingPosition(),a=r.offset-e.start.offset,c=e.length-a;if(n){if(a<i)return void I(e,t,-(e.length-2*s));if(c<s)return void I(e,t,0,!0)}o.transform((()=>{const n=Math.sign(e.replace(t)),a=c===s;return r.asOffset(o).add(n*i,a).asPosition(o)}))}(e,s,i,t.length)}else O(e,s)}var N=n(824),M=n(150),A=n(391),L=n(305),U=n(392),F=n(418);const B=/(^\/\w*)(?: .*)?/g;class V extends A.a{constructor(e,t){super({commandRegex:B,renderingType:t}),s()(this,"matcher",void 0),this.matcher=new L.a(F.c,{keys:["command","args","description"],funcs:[e=>{let{aliases:t}=e;return t.join(" ")}],context:t})}async getCompletions(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;const{command:s,range:o}=this.getCurrentCommand(e,t);if(!s)return[];let r=[];if(s[0]!==s[1]){const e=s[1].slice(1);if(F.b.has(e)&&F.b.get(e).isEnabled()){if(F.b.get(e).hideCompletionAfterSpace)return[];r=[F.b.get(e)]}}else r="/"===e?F.c:this.matcher.match(s[1],i);return r.filter((e=>{const t=!e.renderingTypes||e.renderingTypes.includes(this.renderingType);return e.isEnabled()&&t})).map((e=>{let t=e.getCommand()+" ";const n=e.aliases.find((e=>`/${e}`===s[1]));return(n||e.getCommand()===s[1])&&(t=s[0]),{completion:t,type:"command",component:c.a.createElement(U.b,{title:`/${n||e.command}`,subtitle:e.args,description:Object(b.a)(e.description)}),range:o}}))}getName(){return"*️⃣ "+Object(b.a)("Commands")}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"presentation","aria-label":Object(b.a)("Command Autocomplete")},e)}}var K=n(123),$=n(168),H=n(165);const W=/\B#\S*/g;function q(e,t){return{room:e,matchName:arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",displayedAlias:t}}class G extends A.a{constructor(e,t){super({commandRegex:W,renderingType:t}),s()(this,"matcher",void 0),this.matcher=new L.a([],{keys:["displayedAlias","matchName"]})}getRooms(){return K.a.get().getVisibleRooms().filter((e=>!e.isSpaceRoom()))}async getCompletions(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;const{command:s,range:o}=this.getCurrentCommand(e,t,n);if(s){let e=this.getRooms().reduce(((e,t)=>{if(t.getCanonicalAlias()&&(e=e.concat(q(t,t.getCanonicalAlias(),t.name))),t.getAltAliases().length){const n=t.getAltAliases().map((e=>q(t,e)));e=e.concat(n)}return e}),[]);e=e.filter((t=>{const n=t.room.currentState.getStateEvents("m.room.tombstone","");if(n&&n.getContent()&&n.getContent().replacement_room){return!e.some((e=>e.room.roomId===n.getContent().replacement_room))}return!0})),this.matcher.setObjects(e);const t=s[0];let n=this.matcher.match(t,i);return n=Object(M.sortBy)(n,[e=>{return t=e.displayedAlias,n=e.room,t===n.getCanonicalAlias()?0:1;var t,n},e=>e.displayedAlias.length]),n=Object(M.uniqBy)(n,(e=>e.room)),n.map((e=>({completion:e.displayedAlias,completionId:e.room.roomId,type:"room",suffix:" ",href:Object($.h)(e.displayedAlias),component:c.a.createElement(U.a,{title:e.room.name,description:e.displayedAlias},c.a.createElement(H.a,{width:24,height:24,room:e.room})),range:o}))).filter((e=>!!e.completion&&e.completion.length>0))}return[]}getName(){return Object(b.a)("Rooms")}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"presentation","aria-label":Object(b.a)("Room Autocomplete")},e)}}var z=n(874),J=n(126),Y=n(381),Q=n(160),X=n(802),Z=n(800),ee=n(147);const te=new RegExp("("+d.a.source+"|(?:^|\\s):[+-\\w]*:?)$","g"),ne=Y.b.sort(((e,t)=>e.group===t.group?e.order-t.order:e.group-t.group)).map(((e,t)=>({emoji:e,_orderBy:t})));function ie(e,t){if(Array.isArray(t))return Math.min(...t.map((t=>ie(e,t))));const n=t.indexOf(e);return-1===n?1/0:n}class se extends A.a{constructor(e,t){var n,i;super({commandRegex:te,renderingType:t}),s()(this,"matcher",void 0),s()(this,"nameMatcher",void 0),s()(this,"customEmojiMatcher",void 0),s()(this,"recentlyUsed",void 0),this.matcher=new L.a(ne,{keys:[],funcs:[e=>e.emoji.shortcodes.map((e=>`:${e}:`))],shouldMatchWordsOnly:!1}),this.nameMatcher=new L.a(ne,{keys:["emoji.label"],shouldMatchWordsOnly:!0});let o=e.currentState.getStateEvents("im.ponies.room_emotes").flatMap((e=>Object(X.a)(e)));const r=K.a.get(),a=null===(n=r.getAccountData("im.ponies.emote_rooms"))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.rooms;for(const e in a){const t=r.getRoom(e).currentState.getStateEvents("im.ponies.room_emotes").flatMap((e=>Object(X.a)(e)));o=[...o,...t]}const c=o.map(((e,t)=>({emoji:e,_orderBy:t})));this.customEmojiMatcher=new L.a(c,{keys:[],funcs:[e=>{var t;return null===(t=e.emoji)||void 0===t?void 0:t.shortcodes.map((e=>`:${e}:`))}],shouldMatchWordsOnly:!0}),this.recentlyUsed=Array.from(new Set(Object(ee.n)(Z.b().map(Y.d))))}async getCompletions(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;if(!J.b.getValue("MessageComposerInput.suggestEmoji"))return[];let s=[];const{command:o,range:r}=this.getCurrentCommand(e,t);if(o&&o[0].length>2){let e=[];const t=o[0];e=this.matcher.match(t,i),e=e.concat(this.nameMatcher.match(t,i)),e=e.concat(this.customEmojiMatcher.match(t,i));const n=[];n.push((e=>ie(t,e.emoji.emoticon||""))),n.push((e=>ie(t,e.emoji.shortcodes[0])));const a=t.replace(/^:(.*?):?$/,"$1");n.push((e=>Math.min(...e.emoji.shortcodes.map((e=>ie(a,e)))))),t.length>1&&n.push((e=>e.emoji.shortcodes[0].length)),n.push((e=>e._orderBy)),e=Object(M.sortBy)(Object(M.uniq)(e),n),e=e.slice(0,20);const l=[];this.recentlyUsed.forEach((e=>{0===e.shortcodes[0].indexOf(a)&&l.push({emoji:e,_orderBy:0})}));for(let e=0;e<l.length;e++)if(l[e].emoji.shortcodes[0]===a){const t=l[e];for(let t=e;t>0;t--)l[t]=l[t-1];l[0]=t;break}e=l.concat(e),e=Object(M.uniqBy)(e,"emoji"),s=e.map((e=>{if("unicode"in e.emoji)return{completion:e.emoji.unicode,component:c.a.createElement(U.a,{title:`:${e.emoji.shortcodes[0]}:`,"aria-label":e.emoji.unicode},c.a.createElement("span",null,e.emoji.unicode)),range:r};{let t;try{t=Object(Q.b)(e.emoji.url).getThumbnailOfSourceHttp(24,24,"scale")}catch(e){u.a.error(e)}return{completion:e.emoji.shortcodes[0],type:"customEmoji",completionId:e.emoji.url,component:c.a.createElement(U.a,{title:`:${e.emoji.shortcodes[0]}:`},c.a.createElement("img",{className:"mx_customEmoji_image",src:t,alt:e.emoji.shortcodes[0]})),range:r}}})).slice(0,20)}return s}getName(){return"😃 "+Object(b.a)("Emoji")}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"presentation","aria-label":Object(b.a)("Emoji Autocomplete")},e)}}const oe=/@\S*/g;class re extends A.a{constructor(e,t){super({commandRegex:oe,renderingType:t}),this.room=e}async getCompletions(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=K.a.get();if(!this.room.currentState.mayTriggerNotifOfType("room",i.credentials.userId))return[];const{command:s,range:o}=this.getCurrentCommand(e,t,n);return null!=s&&s[0]&&s[0].length>1&&["@room","@channel","@everyone","@here"].some((e=>e.startsWith(s[0])))?[{completion:"@room",completionId:"@room",type:"at-room",suffix:" ",component:c.a.createElement(U.a,{title:"@room",description:Object(b.a)("Notify the whole room")},c.a.createElement(H.a,{width:24,height:24,room:this.room})),range:o}]:[]}getName(){return"❗️ "+Object(b.a)("Room Notification")}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"presentation","aria-label":Object(b.a)("Notification Autocomplete")},e)}}var ae=n(400);var ce=n(139);const le=[z.a,G,se,re,V,class extends G{getRooms(){return K.a.get().getVisibleRooms().filter((e=>e.isSpaceRoom()))}getName(){return Object(b.a)("Spaces")}renderCompletions(e){return c.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(b.a)("Space Autocomplete")},e)}}];class de{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ce.a.Room;s()(this,"room",void 0),s()(this,"providers",void 0),this.room=e,this.providers=le.map((n=>new n(e,t)))}destroy(){this.providers.forEach((e=>{e.destroy()}))}async getCompletions(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;const s=await Promise.all(this.providers.map((async s=>Object(ae.b)(s.getCompletions(e,t,n,i),null,3e3))));return Object(ee.n)(s.map(((i,s)=>{if(i&&i.length)return{completions:i,provider:this.providers[s],command:this.providers[s].getCurrentCommand(e,t,n)}})))}}const ue=e=>`mx_Autocomplete_Completion_${e}`;class he extends c.a.PureComponent{constructor(e){super(e),s()(this,"autocompleter",void 0),s()(this,"queryRequested",void 0),s()(this,"debounceCompletionsRequest",void 0),s()(this,"containerRef",Object(a.createRef)()),s()(this,"hide",(()=>{this.setState({hide:!0,selectionOffset:1,completions:[],completionList:[]})})),s()(this,"onConfirmCompletion",(()=>{this.onCompletionClicked(this.state.selectionOffset)})),s()(this,"onCompletionClicked",(e=>{const t=this.countCompletions();return!(0===t||e<1||e>t)&&(this.props.onConfirm(this.state.completionList[e-1]),this.hide(),!0)})),this.state={completions:[],completionList:[],selectionOffset:1,shouldShowCompletions:!0,hide:!1,forceComplete:!1}}componentDidMount(){this.autocompleter=new de(this.props.room,this.context.timelineRenderingType),this.applyNewProps()}applyNewProps(e,t){t&&this.props.room.roomId!==t.roomId&&(this.autocompleter.destroy(),this.autocompleter=new de(this.props.room)),e!==this.props.query&&this.complete(this.props.query,this.props.selection)}componentWillUnmount(){this.autocompleter.destroy()}complete(e,t){if(this.queryRequested=e,this.debounceCompletionsRequest&&clearTimeout(this.debounceCompletionsRequest),""===e)return this.setState({completions:[],completionList:[],selectionOffset:1,hide:!0}),Promise.resolve(null);let n=J.b.getValue("autocompleteDelay");return(this.state.completions.length>0||this.state.forceComplete)&&(n=0),new Promise((i=>{this.debounceCompletionsRequest=window.setTimeout((()=>{i(this.processQuery(e,t))}),n)}))}processQuery(e,t){return this.autocompleter.getCompletions(e,t,this.state.forceComplete,20).then((t=>{e===this.queryRequested&&this.processCompletions(t)}))}processCompletions(e){const t=Object(M.flatMap)(e,(e=>e.completions));let n=1;if(t.length>0){const e=this.state.selectionOffset<=1?null:this.state.completionList[this.state.selectionOffset-1].completion;n=t.findIndex((t=>t.completion===e)),-1===n?n=1:n++}let i=!0;e.some((e=>!!e.command.command))&&(i=!1,this.props.onSelectionChange&&this.props.onSelectionChange(n-1)),this.setState({completions:e,completionList:t,selectionOffset:n,hide:i,forceComplete:!1})}hasSelection(){return this.countCompletions()>0&&0!==this.state.selectionOffset}countCompletions(){return this.state.completionList.length}moveSelection(e){const t=this.countCompletions();if(0===t)return;const n=(this.state.selectionOffset+e+t-1)%t;this.setSelection(1+n)}onEscape(e){0!==this.countCompletions()&&(e.preventDefault(),this.hide())}forceComplete(){return new Promise((e=>{this.setState({forceComplete:!0,hide:!1},(()=>{this.complete(this.props.query,this.props.selection).then((()=>{e(this.countCompletions())}))}))}))}setSelection(e){this.setState({selectionOffset:e,hide:!1}),this.props.onSelectionChange&&this.props.onSelectionChange(e-1)}componentDidUpdate(e){this.applyNewProps(e.query,e.room);const t=this.refs[`completion${this.state.selectionOffset}`];t?t.scrollIntoView({behavior:"auto",block:"nearest"}):this.containerRef.current&&this.containerRef.current.scrollTo({top:0})}render(){let e=1;const t=this.state.completions.map(((t,n)=>{const i=t.completions.map(((t,n)=>{const i=e===this.state.selectionOffset,s=r()("mx_Autocomplete_Completion",{selected:i}),o=e;e++;return c.a.cloneElement(t.component,{key:n,ref:`completion${o}`,id:ue(o-1),className:s,onClick:()=>{this.onCompletionClicked(o)},"aria-selected":i})}));return i.length>0?c.a.createElement("div",{key:n,className:"mx_Autocomplete_ProviderSection",role:"presentation"},c.a.createElement("div",{className:"mx_Autocomplete_provider_name"},t.provider.getName()),t.provider.renderCompletions(i)):null})).filter((e=>!!e));return!this.state.hide&&t.length>0?c.a.createElement("div",{id:"mx_Autocomplete",className:"mx_Autocomplete",ref:this.containerRef,role:"listbox"},t):null}}s()(he,"contextType",ce.b);var me=n(208),pe=n(153),ge=n(143),ve=n(374),fe=n(155);const be=new RegExp("(?:^|\\s)("+d.a.source+")\\s|:^$"),ye=new RegExp("(?:^|\\s)("+d.a.source+")$"),Se=['"',"_","`","'","*","~","$"],Ee=new Map([["(",")"],["[","]"],["{","}"],["<",">"]]);function we(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(me.a?"⌘":Object(b.a)(ge.a[me.b.CONTROL]))+(t?"+"+Object(b.a)(ge.a[me.b.SHIFT]):"")+(n?"+"+Object(b.a)(ge.a[me.b.ALT]):"")+"+"+e}function _e(e){return{anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,isCollapsed:e.isCollapsed,rangeCount:e.rangeCount,type:e.type}}class Ce extends c.a.Component{constructor(e){super(e),s()(this,"editorRef",Object(a.createRef)()),s()(this,"autocompleteRef",Object(a.createRef)()),s()(this,"formatBarRef",Object(a.createRef)()),s()(this,"modifiedFlag",!1),s()(this,"isIMEComposing",!1),s()(this,"hasTextSelected",!1),s()(this,"_isCaretAtEnd",void 0),s()(this,"lastCaret",void 0),s()(this,"lastSelection",void 0),s()(this,"useMarkdownHandle",void 0),s()(this,"emoticonSettingHandle",void 0),s()(this,"shouldShowPillAvatarSettingHandle",void 0),s()(this,"surroundWithHandle",void 0),s()(this,"historyManager",new h),s()(this,"updateEditorState",((e,t,n)=>{if(Object(m.e)(this.editorRef.current,this.props.model),e){try{v(this.editorRef.current,this.props.model,e)}catch(e){u.a.error(e)}const t=e instanceof p.a?e.end:e;this.setLastCaretFromPosition(t)}const{isEmpty:i}=this.props.model;this.props.placeholder&&(i?this.showPlaceholder():this.hidePlaceholder()),i&&this.formatBarRef.current.hide(),this.setState({autoComplete:this.props.model.autoComplete,showVisualBell:!n&&this.state.showVisualBell}),this.historyManager.tryPush(this.props.model,e,t,n);let s=!this.props.model.isEmpty&&!!t;if(s&&"command"===this.props.model.parts[0].type){const{cmd:e}=Object(F.e)(this.props.model.parts[0].text),t=F.b.get(e);t&&t.isEnabled()&&t.category===F.a.messages||(s=!1)}fe.b.instance.typingStore.setSelfTyping(this.props.room.roomId,this.props.threadId,s),this.props.onChange&&this.props.onChange()})),s()(this,"onCompositionStart",(()=>{this.isIMEComposing=!0,this.hidePlaceholder()})),s()(this,"onCompositionEnd",(()=>{this.isIMEComposing=!1;const e=navigator.userAgent.toLowerCase();e.includes("safari/")&&!e.includes("chrome/")?this.onInput({inputType:"insertCompositionText"}):Promise.resolve().then((()=>{this.onInput({inputType:"insertCompositionText"})}))})),s()(this,"onCutCopy",((e,t)=>{const n=document.getSelection(),i=n.toString();if(i){const{model:s}=this.props,o=Object(N.b)(this.editorRef.current,s,n),r=o.parts.map((e=>e.serialize()));e.clipboardData.setData("application/x-element-composer",JSON.stringify(r)),e.clipboardData.setData("text/plain",i),"cut"===t&&(this.modifiedFlag=!0,I(o,[])),e.preventDefault()}})),s()(this,"onCopy",(e=>{this.onCutCopy(e,"copy")})),s()(this,"onCut",(e=>{this.onCutCopy(e,"cut")})),s()(this,"onPaste",(e=>{var t,n;if(e.preventDefault(),null!==(t=(n=this.props).onPaste)&&void 0!==t&&t.call(n,e,this.props.model))return!0;const{model:i}=this.props,{partCreator:s}=i,o=e.clipboardData.getData("text/plain"),r=e.clipboardData.getData("application/x-element-composer");let a;if(r){a=JSON.parse(r).map((e=>s.deserializePart(e)))}else a=Object(_.c)(o,s,{shouldEscape:!1});this.modifiedFlag=!0;const c=Object(N.b)(this.editorRef.current,i,document.getSelection());o&&c.length>0&&ve.d.test(o)&&!ve.d.test(c.text)?T(c,o):I(c,a)})),s()(this,"onInput",(e=>{if(this.isIMEComposing)return;this.modifiedFlag=!0;const t=document.getSelection(),{caret:n,text:i}=Object(N.a)(this.editorRef.current,t);this.props.model.update(i,e.inputType,n)})),s()(this,"onBlur",(()=>{document.removeEventListener("selectionchange",this.onSelectionChange)})),s()(this,"onFocus",(()=>{document.addEventListener("selectionchange",this.onSelectionChange),this.lastSelection=null,this.refreshLastCaretIfNeeded()})),s()(this,"onSelectionChange",(()=>{const{isEmpty:e}=this.props.model;this.refreshLastCaretIfNeeded();const t=document.getSelection();var n;if(this.hasTextSelected&&t.isCollapsed)this.hasTextSelected=!1,null===(n=this.formatBarRef.current)||void 0===n||n.hide();else if(!t.isCollapsed&&!e){this.hasTextSelected=!0;const e=Object(N.b)(this.editorRef.current,this.props.model,t);if(this.formatBarRef.current&&this.state.useMarkdown&&e.text.trim()){const e=t.getRangeAt(0).getBoundingClientRect();this.formatBarRef.current.showAt(e)}}})),s()(this,"onKeyDown",(e=>{var t;const n=this.props.model;let i=!1;if(this.state.surroundWith&&"Caret"!==document.getSelection().type){const t=Object(N.b)(this.editorRef.current,this.props.model,document.getSelection());t.trim(),[...Ee.keys(),...Se].includes(e.key)&&(this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,D(t,e.key,Ee.get(e.key)),i=!0)}const s=Object(pe.a)().getAutocompleteAction(e),o=Object(pe.a)().getAccessibilityAction(e);if(null!==(t=n.autoComplete)&&void 0!==t&&t.hasCompletions()){const t=n.autoComplete;switch(s){case ge.h.ForceCompleteAutocomplete:case ge.h.CompleteAutocomplete:this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,t.confirmCompletion(),i=!0;break;case ge.h.PrevSelectionInAutocomplete:t.selectPreviousSelection(),i=!0;break;case ge.h.NextSelectionInAutocomplete:t.selectNextSelection(),i=!0;break;case ge.h.CancelAutocomplete:t.onEscape(e),i=!0;break;default:return}}else s!==ge.h.ForceCompleteAutocomplete||this.state.showVisualBell?[ge.h.Delete,ge.h.Backspace].includes(o)&&this.formatBarRef.current.hide():(this.tabCompleteName(),i=!0);if(i)return e.preventDefault(),void e.stopPropagation();switch(Object(pe.a)().getMessageComposerAction(e)){case ge.h.FormatBold:this.onFormatAction(S.Bold),i=!0;break;case ge.h.FormatItalics:this.onFormatAction(S.Italics),i=!0;break;case ge.h.FormatCode:this.onFormatAction(S.Code),i=!0;break;case ge.h.FormatQuote:this.onFormatAction(S.Quote),i=!0;break;case ge.h.FormatLink:this.onFormatAction(S.InsertLink),i=!0;break;case ge.h.EditRedo:if(this.historyManager.canRedo()){const{parts:e,caret:t}=this.historyManager.redo();n.reset(e,t,"historyRedo")}i=!0;break;case ge.h.EditUndo:if(this.historyManager.canUndo()){const{parts:e,caret:t}=this.historyManager.undo(this.props.model);n.reset(e,t,"historyUndo")}i=!0;break;case ge.h.NewLine:this.insertText("\n"),i=!0;break;case ge.h.MoveCursorToStart:v(this.editorRef.current,n,{index:0,offset:0}),i=!0;break;case ge.h.MoveCursorToEnd:v(this.editorRef.current,n,{index:n.parts.length-1,offset:n.parts[n.parts.length-1].text.length}),i=!0}i&&(e.preventDefault(),e.stopPropagation())})),s()(this,"onAutoCompleteConfirm",(e=>{this.modifiedFlag=!0,this.props.model.autoComplete.onComponentConfirm(e)})),s()(this,"onAutoCompleteSelectionChange",(e=>{this.modifiedFlag=!0,this.setState({completionIndex:e})})),s()(this,"configureUseMarkdown",(()=>{const e=J.b.getValue("MessageComposerInput.useMarkdown");this.setState({useMarkdown:e}),!e&&this.formatBarRef.current&&this.formatBarRef.current.hide()})),s()(this,"configureEmoticonAutoReplace",(()=>{this.props.model.setTransformCallback(this.transform)})),s()(this,"configureShouldShowPillAvatar",(()=>{const e=J.b.getValue("Pill.shouldShowPillAvatar");this.setState({showPillAvatar:e})})),s()(this,"surroundWithSettingChanged",(()=>{const e=J.b.getValue("MessageComposerInput.surroundWith");this.setState({surroundWith:e})})),s()(this,"transform",(e=>{J.b.getValue("MessageComposerInput.autoReplaceEmoji")&&this.replaceEmoticon(e,be)})),s()(this,"onFormatAction",(e=>{if(!this.state.useMarkdown)return;const t=Object(N.b)(this.editorRef.current,this.props.model,document.getSelection());this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,C(t,e)})),this.state={showPillAvatar:J.b.getValue("Pill.shouldShowPillAvatar"),useMarkdown:J.b.getValue("MessageComposerInput.useMarkdown"),surroundWith:J.b.getValue("MessageComposerInput.surroundWith"),showVisualBell:!1},this.useMarkdownHandle=J.b.watchSetting("MessageComposerInput.useMarkdown",null,this.configureUseMarkdown),this.emoticonSettingHandle=J.b.watchSetting("MessageComposerInput.autoReplaceEmoji",null,this.configureEmoticonAutoReplace),this.configureEmoticonAutoReplace(),this.shouldShowPillAvatarSettingHandle=J.b.watchSetting("Pill.shouldShowPillAvatar",null,this.configureShouldShowPillAvatar),this.surroundWithHandle=J.b.watchSetting("MessageComposerInput.surroundWith",null,this.surroundWithSettingChanged)}componentDidUpdate(e){const t=this.props.disabled!==e.disabled,n=this.props.placeholder!==e.placeholder;if(this.props.placeholder&&(n||t)){const{isEmpty:e}=this.props.model;e?this.showPlaceholder():this.hidePlaceholder()}}replaceEmoticon(e,t){const{model:n}=this.props,i=n.startRange(e);let s=9;i.expandBackwardsWhile(((e,t)=>{const i=n.parts[e];return s-=1,s>=0&&[g.b.Plain,g.b.PillCandidate,g.b.Newline].includes(i.type)}));const o=t.exec(i.text);if(o&&(s>=0||0!==o.index)){const e=o[1].replace("-",""),t=Y.c.get(e)||Y.c.get(e.toLowerCase());if(t){const{partCreator:e}=n,s=o[0],r=" "===s[0]?1:0;return i.moveStartForwards(o.index+r),["\n"," "].includes(s[s.length-1])&&i.moveEndBackwards(1),i.replace([e.emoji(t.unicode)])}}}showPlaceholder(){const e=this.props.placeholder.replace(/'/g,"\\'");this.editorRef.current.style.setProperty("--placeholder",`'${e}'`),this.editorRef.current.classList.add("mx_BasicMessageComposer_inputEmpty")}hidePlaceholder(){this.editorRef.current.classList.remove("mx_BasicMessageComposer_inputEmpty"),this.editorRef.current.style.removeProperty("--placeholder")}isComposing(e){return!!(this.isIMEComposing||e.nativeEvent&&e.nativeEvent.isComposing)}insertText(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"insertText";const n=document.getSelection(),{caret:i,text:s}=Object(N.a)(this.editorRef.current,n),o=s.slice(0,i.offset)+e+s.slice(i.offset);i.offset+=e.length,this.modifiedFlag=!0,this.props.model.update(o,t,i)}setLastCaretFromPosition(e){const{model:t}=this.props;this._isCaretAtEnd=e.isAtEnd(t),this.lastCaret=e.asOffset(t),this.lastSelection=_e(document.getSelection())}refreshLastCaretIfNeeded(){if(!this.editorRef.current)return;const e=document.getSelection();if(!this.lastSelection||(t=this.lastSelection,n=e,t.anchorNode!==n.anchorNode||t.anchorOffset!==n.anchorOffset||t.focusNode!==n.focusNode||t.focusOffset!==n.focusOffset||t.isCollapsed!==n.isCollapsed||t.rangeCount!==n.rangeCount||t.type!==n.type)){this.lastSelection=_e(e);const{caret:t,text:n}=Object(N.a)(this.editorRef.current,e);this.lastCaret=t,this._isCaretAtEnd=t.offset===n.length}var t,n;return this.lastCaret}clearUndoHistory(){this.historyManager.clear()}getCaret(){return this.lastCaret}isSelectionCollapsed(){return!this.lastSelection||this.lastSelection.isCollapsed}isCaretAtStart(){return 0===this.getCaret().offset}isCaretAtEnd(){return this._isCaretAtEnd}async tabCompleteName(){try{await new Promise((e=>this.setState({showVisualBell:!1},e)));const{model:e}=this.props,t=this.getCaret(),n=e.positionForOffset(t.offset,t.atNodeEnd),i=e.startRange(n);i.expandBackwardsWhile(((e,t,n)=>" "!==n.text[t]&&"+"!==n.text[t]&&(n.type===g.b.Plain||n.type===g.b.PillCandidate||n.type===g.b.Command)));const{partCreator:s}=e;await e.transform((()=>{const n=i.replace([s.pillCandidate(i.text)]);return e.positionForOffset(t.offset+n,!0)})),e.autoComplete?(await e.autoComplete.startSelection(),e.autoComplete.hasSelection()||(this.setState({showVisualBell:!0}),e.autoComplete.close())):this.setState({showVisualBell:!0})}catch(e){u.a.error(e)}}isModified(){return this.modifiedFlag}componentWillUnmount(){document.removeEventListener("selectionchange",this.onSelectionChange),this.editorRef.current.removeEventListener("input",this.onInput,!0),this.editorRef.current.removeEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.removeEventListener("compositionend",this.onCompositionEnd,!0),J.b.unwatchSetting(this.useMarkdownHandle),J.b.unwatchSetting(this.emoticonSettingHandle),J.b.unwatchSetting(this.shouldShowPillAvatarSettingHandle),J.b.unwatchSetting(this.surroundWithHandle)}componentDidMount(){const e=this.props.model;e.setUpdateCallback(this.updateEditorState);e.partCreator.setAutoCompleteCreator(Object(g.c)((()=>this.autocompleteRef.current),(e=>new Promise((t=>this.setState({query:e},t)))))),this.updateEditorState(this.getInitialCaretPosition()),this.editorRef.current.addEventListener("input",this.onInput,!0),this.editorRef.current.addEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.addEventListener("compositionend",this.onCompositionEnd,!0),this.editorRef.current.focus()}getInitialCaretPosition(){let e;if(this.props.initialCaret){const t=this.props.initialCaret;e=this.props.model.positionForOffset(t.offset,t.atNodeEnd)}else e=this.props.model.getPositionAtEnd();return e}render(){let e;if(this.state.autoComplete){const t=this.state.query,n=t.length;e=c.a.createElement("div",{className:"mx_BasicMessageComposer_AutoCompleteWrapper"},c.a.createElement(he,{ref:this.autocompleteRef,query:t,onConfirm:this.onAutoCompleteConfirm,onSelectionChange:this.onAutoCompleteSelectionChange,selection:{beginning:!0,end:n,start:n},room:this.props.room}))}const t=r()("mx_BasicMessageComposer",{mx_BasicMessageComposer_input_error:this.state.showVisualBell}),n=r()("mx_BasicMessageComposer_input",{mx_BasicMessageComposer_input_shouldShowPillAvatar:this.state.showPillAvatar,mx_BasicMessageComposer_input_disabled:this.props.disabled}),i={[S.Bold]:we("B"),[S.Italics]:we("I"),[S.Code]:we("E"),[S.Quote]:we(">",!0),[S.InsertLink]:we("L",!0)},{completionIndex:s}=this.state,o=Boolean(this.state.autoComplete);let a;return o&&s>=0&&(a=ue(s)),c.a.createElement("div",{className:t},e,c.a.createElement(E,{ref:this.formatBarRef,onAction:this.onFormatAction,shortcuts:i}),c.a.createElement("div",{className:n,contentEditable:!this.props.disabled||null,tabIndex:0,onBlur:this.onBlur,onFocus:this.onFocus,onCopy:this.onCopy,onCut:this.onCut,onPaste:this.onPaste,onKeyDown:this.onKeyDown,ref:this.editorRef,"aria-label":this.props.label,role:"textbox","aria-multiline":"true","aria-autocomplete":"list","aria-haspopup":"listbox","aria-expanded":!!o||void 0,"aria-owns":o?"mx_Autocomplete":void 0,"aria-activedescendant":a,dir:"auto","aria-disabled":this.props.disabled,"data-testid":"basicmessagecomposer"}))}focus(){this.editorRef.current.focus()}insertMention(e){this.modifiedFlag=!0;const{model:t}=this.props,{partCreator:n}=t,i=this.props.room.getMember(e),s=i?i.rawDisplayName:e,o=this.getCaret(),r=t.positionForOffset(o.offset,o.atNodeEnd),a=n.createMentionParts(0===o.offset,s,e);t.transform((()=>{const e=t.insert(a,r);return t.positionForOffset(o.offset+e,!0)})),this.focus()}insertQuotedMessage(e){this.modifiedFlag=!0;const{model:t}=this.props,{partCreator:n}=t,i=Object(_.b)(e,n,{isQuotedMessage:!0});i.push(n.newline()),i.push(n.newline()),t.transform((()=>{const e=t.insert(i,t.positionForOffset(0));return t.positionForOffset(e,!0)})),this.focus()}insertPlaintext(e){this.modifiedFlag=!0;const{model:t}=this.props,{partCreator:n}=t,i=this.getCaret(),s=t.positionForOffset(i.offset,i.atNodeEnd);t.transform((()=>{const o=t.insert(n.plainWithEmoji(e),s);return t.positionForOffset(i.offset+o,!0)}))}insertEmoji(e){this.modifiedFlag=!0;const{model:t}=this.props,{partCreator:n}=t,i=this.getCaret(),s=t.positionForOffset(i.offset,i.atNodeEnd);let o;o="unicode"in e?n.emoji(e.unicode):n.customEmoji(e.shortcodes[0],e.url),t.transform((()=>{const e=t.insert([o],s);return t.positionForOffset(i.offset+e,!0)}))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return L})),n.d(t,"c",(function(){return U})),n.d(t,"b",(function(){return F}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(121),c=n(800),l=n(381),d=n(215),u=n(127),h=n.n(u),m=n(1),p=n(153),g=n(143),v=n(160);class f extends r.a.PureComponent{constructor(){super(...arguments),s()(this,"onKeyDown",(e=>{let t=!0;switch(Object(p.a)().getAccessibilityAction(e)){case g.h.ArrowLeft:this.changeCategoryRelative(-1);break;case g.h.ArrowRight:this.changeCategoryRelative(1);break;case g.h.Home:this.changeCategoryAbsolute(0);break;case g.h.End:this.changeCategoryAbsolute(this.props.categories.length-1,-1);break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())})),s()(this,"onWheel",(e=>{e.preventDefault(),1===e.deltaMode?e.currentTarget.scrollLeft+=20*e.deltaY:e.currentTarget.scrollLeft+=e.deltaY}))}findNearestEnabled(e,t){e+=this.props.categories.length;const n=[...this.props.categories,...this.props.categories,...this.props.categories];for(;e<n.length&&e>=0;){if(n[e].enabled)return e%this.props.categories.length;e+=t>0?1:-1}}changeCategoryRelative(e){const t=this.props.categories.findIndex((e=>e.visible));this.changeCategoryAbsolute(t+e,e)}changeCategoryAbsolute(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const n=this.props.categories[this.findNearestEnabled(e,t)];n&&(this.props.onAnchorClick(n.id),n.ref.current.focus())}render(){return r.a.createElement("nav",{className:"mx_EmojiPicker_header",role:"tablist","aria-label":Object(a.a)("Categories"),onKeyDown:this.onKeyDown,onWheel:this.onWheel},this.props.categories.map((e=>{let t,n;if(e.representativeEmoji){let i;try{i=Object(v.b)(e.representativeEmoji.url).getThumbnailOfSourceHttp(24,24,"scale")}catch(e){m.a.error(e)}t=r.a.createElement("img",{className:"mx_customEmoji_image",src:i,alt:e.representativeEmoji.shortcodes[0]}),n=h()("mx_EmojiPicker_anchor","mx_CustomEmojiCategory",{mx_EmojiPicker_anchor_visible:e.visible})}else n=h()(`mx_EmojiPicker_anchor mx_EmojiPicker_anchor_${e.id}`,{mx_EmojiPicker_anchor_visible:e.visible});return r.a.createElement("button",{disabled:!e.enabled,key:e.id,ref:e.ref,className:n,onClick:()=>this.props.onAnchorClick(e.id),title:e.name,role:"tab",tabIndex:e.visible?0:-1,"aria-selected":e.visible,"aria-controls":`mx_EmojiPicker_category_${e.id}`},t)})))}}var b=f;class y extends r.a.PureComponent{constructor(){super(...arguments),s()(this,"inputRef",r.a.createRef()),s()(this,"onKeyDown",(e=>{if(Object(p.a)().getAccessibilityAction(e)===g.h.Enter)this.props.onEnter(),e.stopPropagation(),e.preventDefault()}))}componentDidMount(){window.setTimeout((()=>{var e;return null===(e=this.inputRef.current)||void 0===e?void 0:e.focus()}),0)}render(){let e;return e=this.props.query?r.a.createElement("button",{onClick:()=>this.props.onChange(""),className:"mx_EmojiPicker_search_icon mx_EmojiPicker_search_clear",title:Object(a.a)("Cancel search")}):r.a.createElement("span",{className:"mx_EmojiPicker_search_icon"}),r.a.createElement("div",{className:"mx_EmojiPicker_search"},r.a.createElement("input",{autoFocus:!0,type:"text",placeholder:Object(a.a)("Search"),value:this.props.query,onChange:e=>this.props.onChange(e.target.value),onKeyDown:this.onKeyDown,ref:this.inputRef}),e)}}var S=y;class E extends r.a.PureComponent{render(){const{unicode:e,label:t,shortcodes:[n]}=this.props.emoji;return r.a.createElement("div",{className:"mx_EmojiPicker_footer mx_EmojiPicker_preview"},r.a.createElement("div",{className:"mx_EmojiPicker_preview_emoji"},e),r.a.createElement("div",{className:"mx_EmojiPicker_preview_text"},r.a.createElement("div",{className:"mx_EmojiPicker_name mx_EmojiPicker_preview_name"},t),r.a.createElement("div",{className:"mx_EmojiPicker_shortcode"},n)))}}var w=E,_=n(151);class C extends r.a.PureComponent{render(){const{onClick:e,onMouseEnter:t,onMouseLeave:n,emoji:i,selectedEmojis:s}=this.props;let o;if("unicode"in i){const e=s&&s.has(i.unicode);o=r.a.createElement("div",{className:"mx_EmojiPicker_item "+(e?"mx_EmojiPicker_item_selected":"")},i.unicode)}else{let e;try{e=Object(v.b)(i.url).getThumbnailOfSourceHttp(24,24,"scale")}catch(e){m.a.error(e)}o=r.a.createElement("div",{className:"mx_EmojiPicker_item"},r.a.createElement("img",{className:"mx_customEmoji_image",src:e,alt:i.shortcodes[0]}))}return r.a.createElement(_.d,{element:"li",onClick:()=>e(i),onMouseEnter:()=>t(i),onMouseLeave:()=>n(i),className:"mx_EmojiPicker_item_wrapper",label:"unicode"in i?i.unicode:i.shortcodes[0],disabled:this.props.disabled},o)}}var O=C;const I=["👍","👎","😄","🎉","😕","❤️","🚀","👀"].map((e=>{const t=Object(l.d)(e);if(!t)throw new Error(`Emoji ${e} doesn't exist in emojibase`);return t}));class R extends r.a.Component{constructor(e){super(e),s()(this,"onMouseEnter",(e=>{this.setState({hover:e})})),s()(this,"onMouseLeave",(()=>{this.setState({hover:void 0})})),this.state={}}render(){return r.a.createElement("section",{className:"mx_EmojiPicker_footer mx_EmojiPicker_quick mx_EmojiPicker_category"},r.a.createElement("h2",{className:"mx_EmojiPicker_quick_header mx_EmojiPicker_category_label"},this.state.hover?r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"mx_EmojiPicker_name"},this.state.hover.label),r.a.createElement("span",{className:"mx_EmojiPicker_shortcode"},this.state.hover.shortcodes[0])):Object(a.a)("Quick Reactions")),r.a.createElement("ul",{className:"mx_EmojiPicker_list","aria-label":Object(a.a)("Quick Reactions")},I.map((e=>r.a.createElement(O,{key:e.hexcode,emoji:e,onClick:this.props.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,selectedEmojis:this.props.selectedEmojis})))))}}var k=R,x=n(801);class T extends r.a.PureComponent{constructor(){super(...arguments),s()(this,"renderEmojiRow",(e=>{const{onClick:t,onMouseEnter:n,onMouseLeave:i,selectedEmojis:s,emojis:o}=this.props,a=o.slice(8*e,8*(e+1)).filter((e=>e));return r.a.createElement("div",{key:e},a.map((e=>{var o,a;return r.a.createElement(O,{key:"hexcode"in e?e.hexcode:e.shortcodes[0],emoji:e,selectedEmojis:s,onClick:t,onMouseEnter:n,onMouseLeave:i,disabled:null===(o=(a=this.props).isEmojiDisabled)||void 0===o?void 0:o.call(a,"unicode"in e?e.unicode:e.shortcodes[0])})})))}))}render(){const{emojis:e,name:t,heightBefore:n,viewportHeight:i,scrollTop:s}=this.props;if(!e||0===e.length)return null;const o=new Array(Math.ceil(e.length/F));for(let e=0;e<o.length;++e)o[e]=e;const a=s,c=a+i,l=n+L,d=l+o.length*U,u=Math.max(a,l),h=Math.min(c,d),m=Math.max(0,h-u),p=Math.max(0,s-l);return r.a.createElement("section",{id:`mx_EmojiPicker_category_${this.props.id}`,className:"mx_EmojiPicker_category","data-category-id":this.props.id,role:"tabpanel","aria-label":t},r.a.createElement("h2",{className:"mx_EmojiPicker_category_label"},t),r.a.createElement(x.a,{element:"ul",className:"mx_EmojiPicker_list",itemHeight:U,items:o,scrollTop:p,height:m,overflowItems:3,overflowMargin:0,renderItem:this.renderEmojiRow}))}}var j=T,P=n(124),D=n(802),N=n(147);function M(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function A(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?M(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):M(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const L=20,U=35,F=8;class B extends r.a.Component{constructor(e){let t;if(super(e),s()(this,"recentlyUsed",void 0),s()(this,"memoizedDataByCategory",void 0),s()(this,"allEmojis",void 0),s()(this,"categories",void 0),s()(this,"shortcodes_to_custom_emoji",{}),s()(this,"scrollRef",r.a.createRef()),s()(this,"onScroll",(()=>{var e;const t=null===(e=this.scrollRef.current)||void 0===e?void 0:e.containerRef.current;this.setState({scrollTop:t.scrollTop,viewportHeight:t.clientHeight}),this.updateVisibility()})),s()(this,"updateVisibility",(()=>{var e;const t=null===(e=this.scrollRef.current)||void 0===e?void 0:e.containerRef.current,n=t.getBoundingClientRect();for(const e of this.categories){const i=t.querySelector(`[data-category-id="${e.id}"]`);if(!i){e.visible=!1,e.ref.current.classList.remove("mx_EmojiPicker_anchor_visible");continue}const s=i.getBoundingClientRect(),o=s.y-n.y,r=s.y+s.height-n.y;e.visible=o<n.height&&r>0,e.visible?(e.ref.current.classList.add("mx_EmojiPicker_anchor_visible"),e.ref.current.setAttribute("aria-selected","true"),e.ref.current.setAttribute("tabindex","0"),e.ref.current.scrollIntoView()):(e.ref.current.classList.remove("mx_EmojiPicker_anchor_visible"),e.ref.current.setAttribute("aria-selected","false"),e.ref.current.setAttribute("tabindex","-1"))}})),s()(this,"scrollToCategory",(e=>{var t,n;null===(t=this.scrollRef.current)||void 0===t||null===(n=t.containerRef.current)||void 0===n||n.querySelector(`[data-category-id="${e}"]`).scrollIntoView()})),s()(this,"onChangeFilter",(e=>{const t=e.toLowerCase().trim();for(const e of this.categories){let n;n=t.includes(this.state.filter)?this.memoizedDataByCategory[e.id]:this.allEmojis[e.id],n=n.filter((e=>this.emojiMatchesFilter(e,t))),n=n.sort(((e,n)=>{const i=e.shortcodes[0].indexOf(t),s=n.shortcodes[0].indexOf(t);return-1==i||-1==s?s-i:0==i&&0==s?e.shortcodes[0].length-n.shortcodes[0].length:i-s})),this.memoizedDataByCategory[e.id]=n,e.enabled=n.length>0,e.ref.current&&(e.ref.current.disabled=!e.enabled)}this.setState({filter:e}),window.setTimeout(this.updateVisibility,0)})),s()(this,"emojiMatchesFilter",((e,t)=>{var n;return"label"in e?e.label.toLowerCase().includes(t)||(Array.isArray(e.emoticon)?e.emoticon.some((e=>e.includes(t))):null===(n=e.emoticon)||void 0===n?void 0:n.includes(t))||e.shortcodes.some((e=>e.toLowerCase().includes(t)))||e.unicode.split("‍").includes(t):e.shortcodes.some((e=>e.toLowerCase().includes(t)))})),s()(this,"onEnterFilter",(()=>{var e,t;const n=null===(e=this.scrollRef.current)||void 0===e||null===(t=e.containerRef.current)||void 0===t?void 0:t.querySelector(".mx_EmojiPicker_item");n&&n.click()})),s()(this,"onHoverEmoji",(e=>{this.setState({previewEmoji:e})})),s()(this,"onHoverEmojiEnd",(()=>{this.setState({previewEmoji:void 0})})),s()(this,"onClickEmoji",(e=>{!1!==this.props.onChoose(e)&&c.a("unicode"in e?e.unicode:`:${e.shortcodes[0]}:`)})),s()(this,"reactWith",(e=>{this.props.onChoose({label:null,group:null,hexcode:null,order:null,shortcodes:[],unicode:e})})),this.state={filter:"",scrollTop:0,viewportHeight:280},e.room){t=e.room.currentState.getStateEvents("im.ponies.room_emotes").flatMap((e=>Object(D.a)(e)))}else t=[];t.forEach((e=>{null==e||e.shortcodes.forEach((t=>{this.shortcodes_to_custom_emoji[`:${t}:`]=e}))})),this.recentlyUsed=Array.from(new Set(Object(N.n)(c.b().map((e=>Object(l.d)(e)||this.shortcodes_to_custom_emoji[e]))))),this.allEmojis=A({recent:this.recentlyUsed,room:t},l.a),this.memoizedDataByCategory=A({},this.allEmojis),this.categories=[{id:"recent",name:Object(a.a)("Frequently Used"),enabled:this.recentlyUsed.length>0,visible:this.recentlyUsed.length>0,ref:r.a.createRef()},{id:"people",name:Object(a.a)("Smileys & People"),enabled:!0,visible:!0,ref:r.a.createRef()},{id:"nature",name:Object(a.a)("Animals & Nature"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"foods",name:Object(a.a)("Food & Drink"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"activity",name:Object(a.a)("Activities"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"places",name:Object(a.a)("Travel & Places"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"objects",name:Object(a.a)("Objects"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"symbols",name:Object(a.a)("Symbols"),enabled:!0,visible:!1,ref:r.a.createRef()},{id:"flags",name:Object(a.a)("Flags"),enabled:!0,visible:!1,ref:r.a.createRef()}],t.length>0&&this.categories.splice(1,0,{id:"room",name:Object(a.a)("Room Emoji"),representativeEmoji:t[0],enabled:!0,visible:!0,ref:r.a.createRef()})}static categoryHeightForEmojiCount(e){return 0===e?0:L+Math.ceil(e/F)*U}render(){let e=0;return r.a.createElement("div",{className:"mx_EmojiPicker","data-testid":"mx_EmojiPicker"},r.a.createElement(b,{categories:this.categories,onAnchorClick:this.scrollToCategory}),r.a.createElement(S,{query:this.state.filter,onChange:this.onChangeFilter,onEnter:this.onEnterFilter}),r.a.createElement(d.a,{className:"mx_EmojiPicker_body",ref:this.scrollRef,onScroll:this.onScroll},this.categories.map((t=>{const n=this.memoizedDataByCategory[t.id],i=r.a.createElement(j,{key:t.id,id:t.id,name:t.name,heightBefore:e,viewportHeight:this.state.viewportHeight,scrollTop:this.state.scrollTop,emojis:n,onClick:this.onClickEmoji,onMouseEnter:this.onHoverEmoji,onMouseLeave:this.onHoverEmojiEnd,isEmojiDisabled:this.props.isEmojiDisabled,selectedEmojis:this.props.selectedEmojis}),s=B.categoryHeightForEmojiCount(n.length);return e+=s,i}))),this.props.allowUnlisted&&this.state.filter&&r.a.createElement(P.a,{kind:"link",onClick:()=>this.reactWith(this.state.filter)},Object(a.a)('React with "%(reaction)s"',{reaction:this.state.filter})),this.state.previewEmoji||!this.props.showQuickReactions?r.a.createElement(w,{emoji:this.state.previewEmoji}):r.a.createElement(k,{onClick:this.onClickEmoji,selectedEmojis:this.props.selectedEmojis}))}}t.d=B},function(e,t,n){"use strict";n.d(t,"a",(function(){return H}));var i,s=n(122),o=n.n(s),r=n(120),a=n.n(r),c=n(130),l=n(152),d=n(1),u=n(150),h=n(16),m=n(121),p=n(123),g=n(124),v=n(128),f=n(145),b=n(653),y=n(348),S=n(126),E=n(195),w=n(206),_=n(132),C=n(874),O=n(131),I=n.n(O),R=n(127),k=n.n(R),x=n(208),T=n(907);function j(){return j=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},j.apply(this,arguments)}function P(e){return r.createElement("svg",j({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),i||(i=r.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M12.133 8.067a4.067 4.067 0 11-8.133 0 4.067 4.067 0 018.133 0zM13 11.599a6.067 6.067 0 10-1.4 1.4c.028.038.06.074.094.108l2.6 2.6a1 1 0 101.414-1.414l-2.6-2.6a1.005 1.005 0 00-.108-.094z"})))}var D=n(587);const N=e=>{var t;let{provider:n,renderSuggestion:i,renderSelection:s,maxSuggestions:o=5,placeholder:c,onSelectionChange:l,selection:d,additionalFilter:u}=e;const[h,m]=Object(r.useState)(""),[p,g]=Object(r.useState)([]),[v,f]=Object(D.a)(),b=Object(r.useRef)(null),y=Object(r.useRef)(null),S=()=>{var e;null==y||null===(e=y.current)||void 0===e||e.focus()},E=e=>{const t=[...d],n=d.findIndex((t=>t.completionId===e.completionId));n>=0?t.splice(n,1):t.push(e),l(t),S()},w=e=>{const t=[...d],n=d.findIndex((t=>t.completionId===e.completionId));n>=0&&(t.splice(n,1),l(t))};return a.a.createElement("div",{className:"mx_AutocompleteInput"},a.a.createElement("div",{ref:b,className:k()({mx_AutocompleteInput_editor:!0,"mx_AutocompleteInput_editor--focused":v,"mx_AutocompleteInput_editor--has-suggestions":p.length>0}),onClick:()=>{S()},"data-testid":"autocomplete-editor"},a.a.createElement(P,{className:"mx_AutocompleteInput_search_icon",width:16,height:16}),d.map((e=>a.a.createElement(M,{key:e.completionId,item:e,onClick:w,render:s}))),a.a.createElement("input",I()({ref:y,type:"text",onKeyDown:e=>{const t=e.ctrlKey||e.shiftKey||e.metaKey;!h&&d.length>0&&e.key===x.b.BACKSPACE&&!t&&w(d[d.length-1])},onChange:async e=>{const t=e.target.value.trim();m(t);let i=await n.getCompletions(h,{start:h.length,end:h.length},!0,o);u&&(i=i.filter(u)),g(i)},value:h,autoComplete:"off",placeholder:0===d.length&&0===h.length?c:void 0,"data-testid":"autocomplete-input"},f))),v&&p.length?a.a.createElement("div",{className:"mx_AutocompleteInput_matches",style:{top:null===(t=b.current)||void 0===t?void 0:t.clientHeight},"data-testid":"autocomplete-matches"},p.map((e=>a.a.createElement(A,{key:e.completionId,item:e,selection:d,onClick:E,render:i})))):null)},M=e=>{let{item:t,onClick:n,render:i}=e;const s=e=>a.a.createElement("span",{className:"mx_AutocompleteInput_editor_selection","data-testid":`autocomplete-selection-item-${t.completionId}`},a.a.createElement("span",{className:"mx_AutocompleteInput_editor_selection_pill"},e),a.a.createElement(g.a,{className:"mx_AutocompleteInput_editor_selection_remove_button",onClick:()=>n(t),"data-testid":`autocomplete-selection-remove-button-${t.completionId}`},a.a.createElement(T.Icon,{width:8,height:8})));return s(i?i(t):a.a.createElement("span",{className:"mx_AutocompleteInput_editor_selection_text"},t.completion))},A=e=>{let{item:t,selection:n,onClick:i,render:s}=e;const o=n.some((e=>e.completionId===t.completionId)),r=k()({mx_AutocompleteInput_suggestion:!0,"mx_AutocompleteInput_suggestion--selected":o}),c=e=>a.a.createElement("div",{className:r,onMouseDown:e=>{e.preventDefault(),i(t)},"data-testid":`autocomplete-suggestion-item-${t.completionId}`},e);return c(s?s(t):a.a.createElement(a.a.Fragment,null,a.a.createElement("span",{className:"mx_AutocompleteInput_suggestion_title"},t.completion),a.a.createElement("span",{className:"mx_AutocompleteInput_suggestion_description"},t.completionId)))};var L=n(133);const U=e=>{let{room:t,defaultUserLevel:n}=e;const i=Object(r.useContext)(L.a),s=Object(r.useRef)(new C.a(t)),[o,l]=Object(r.useState)(!1),[d,u]=Object(r.useState)(n),[h,p]=Object(r.useState)([]),S=Object(r.useCallback)((e=>F(t,e,n)),[t,n]);return a.a.createElement("form",{style:{display:"flex"},onSubmit:async e=>{e.preventDefault(),l(!0);const s=B(h),o=t.currentState.getStateEvents(c.b.RoomPowerLevels,"");if(null!==o)try{await i.setPowerLevel(t.roomId,s,d,o),p([]),u(n)}catch(e){v.b.createDialog(f.a,{title:Object(m.a)("Error"),description:Object(m.a)("Failed to change power level")})}finally{l(!1)}else v.b.createDialog(f.a,{title:Object(m.a)("Error"),description:Object(m.a)("Failed to change power level")})}},a.a.createElement(y.a,{legend:Object(m.a)("Add privileged users"),description:Object(m.a)("Give one or multiple users in this room more privileges"),style:{flexGrow:1}},a.a.createElement(N,{provider:s.current,placeholder:Object(m.a)("Search users in this room…"),onSelectionChange:p,selection:h,additionalFilter:S}),a.a.createElement(b.a,{value:d,onChange:u}),a.a.createElement(g.a,{type:"submit",element:"button",kind:"primary",disabled:!h.length||o,onClick:null,"data-testid":"add-privileged-users-submit-button"},Object(m.a)("Apply"))))},F=(e,t,n)=>{if(void 0===t.completionId)return!1;const i=e.getMember(t.completionId);return null!==i&&i.powerLevel<=n},B=e=>e.filter((e=>void 0!==e.completionId)).map((e=>e.completionId)),V={[c.b.RoomAvatar]:{isState:!0},[c.b.RoomName]:{isState:!0},[c.b.RoomCanonicalAlias]:{isState:!0},[c.b.SpaceChild]:{isState:!0,hideForRoom:!0},[c.b.RoomHistoryVisibility]:{isState:!0,hideForSpace:!0},[c.b.RoomPowerLevels]:{isState:!0},[c.b.RoomTopic]:{isState:!0},[c.b.RoomTombstone]:{isState:!0,hideForSpace:!0},[c.b.RoomEncryption]:{isState:!0,hideForSpace:!0},[c.b.RoomServerAcl]:{isState:!0,hideForSpace:!0},[c.b.RoomPinnedEvents]:{isState:!0,hideForSpace:!0},[c.b.Reaction]:{isState:!1,hideForSpace:!0},[c.b.RoomRedaction]:{isState:!1,hideForSpace:!0},[w.d.CALL_EVENT_TYPE.name]:{isState:!0,hideForSpace:!0},[w.d.MEMBER_EVENT_TYPE.name]:{isState:!0,hideForSpace:!0},"im.vector.modular.widgets":{isState:!0,hideForSpace:!0},[E.g]:{isState:!0,hideForSpace:!0}};function K(e,t){const n=parseInt(e);return isNaN(n)?t:n}class $ extends a.a.Component{constructor(){super(...arguments),o()(this,"onUnbanClick",(()=>{p.a.get().unban(this.props.member.roomId,this.props.member.userId).catch((e=>{d.a.error("Failed to unban: "+e),v.b.createDialog(f.a,{title:Object(m.a)("Error"),description:Object(m.a)("Failed to unban")})}))}))}render(){let e;this.props.canUnban&&(e=a.a.createElement(g.a,{className:"mx_RolesRoomSettingsTab_unbanBtn",kind:"danger_sm",onClick:this.onUnbanClick},Object(m.a)("Unban")));const t=this.props.member.name===this.props.member.userId?null:this.props.member.userId;return a.a.createElement("li",null,e,a.a.createElement("span",{title:Object(m.a)("Banned by %(displayName)s",{displayName:this.props.by})},a.a.createElement("strong",null,this.props.member.name)," ",t,this.props.reason?" "+Object(m.a)("Reason")+": "+this.props.reason:""))}}class H extends a.a.Component{constructor(){super(...arguments),o()(this,"onRoomStateUpdate",(e=>{e.roomId===this.props.roomId&&this.onThisRoomMembership()})),o()(this,"onThisRoomMembership",Object(u.throttle)((()=>{this.forceUpdate()}),200,{leading:!0,trailing:!0})),o()(this,"onPowerLevelsChanged",((e,t)=>{const n=p.a.get(),i=n.getRoom(this.props.roomId).currentState.getStateEvents(c.b.RoomPowerLevels,"");let s=i&&i.getContent()||{};s=Object.assign({},s);const o="event_levels_";if(t.startsWith(o))s.events=Object.assign({},s.events||{}),s.events[t.slice(o.length)]=e;else{const n=t.split(".");let i,o=s;for(const e of n)o[e]||(o[e]={}),i=o,o=o[e];i[n[n.length-1]]=e}n.sendStateEvent(this.props.roomId,c.b.RoomPowerLevels,s).catch((e=>{d.a.error(e),v.b.createDialog(f.a,{title:Object(m.a)("Error changing power level requirement"),description:Object(m.a)("An error occurred changing the room's power level requirements. Ensure you have sufficient permissions and try again.")})}))})),o()(this,"onUserPowerLevelChanged",((e,t)=>{const n=p.a.get(),i=n.getRoom(this.props.roomId).currentState.getStateEvents(c.b.RoomPowerLevels,"");let s=i&&i.getContent()||{};s=Object.assign({},s),s.users||(s.users={}),s.users[t]=e,n.sendStateEvent(this.props.roomId,c.b.RoomPowerLevels,s).catch((e=>{d.a.error(e),v.b.createDialog(f.a,{title:Object(m.a)("Error changing power level"),description:Object(m.a)("An error occurred changing the user's power level. Ensure you have sufficient permissions and try again.")})}))}))}componentDidMount(){p.a.get().on(l.b.Update,this.onRoomStateUpdate)}componentWillUnmount(){const e=p.a.get();e&&e.removeListener(l.b.Update,this.onRoomStateUpdate)}populateDefaultPlEvents(e,t,n){for(const i of Object.keys(V))i in e||(e[i]=V[i].isState?t:n)}render(){const e=p.a.get(),t=e.getRoom(this.props.roomId),n=null==t?void 0:t.isSpaceRoom(),i=null==t?void 0:t.currentState.getStateEvents(c.b.RoomPowerLevels,""),s=i&&i.getContent()||{},o=null==t?void 0:t.currentState.mayClientSendStateEvent(c.b.RoomPowerLevels,e),r={[c.b.RoomAvatar]:n?Object(m.c)("Change space avatar"):Object(m.c)("Change room avatar"),[c.b.RoomName]:n?Object(m.c)("Change space name"):Object(m.c)("Change room name"),[c.b.RoomCanonicalAlias]:n?Object(m.c)("Change main address for the space"):Object(m.c)("Change main address for the room"),[c.b.SpaceChild]:Object(m.c)("Manage rooms in this space"),[c.b.RoomHistoryVisibility]:Object(m.c)("Change history visibility"),[c.b.RoomPowerLevels]:Object(m.c)("Change permissions"),[c.b.RoomTopic]:n?Object(m.c)("Change description"):Object(m.c)("Change topic"),[c.b.RoomTombstone]:Object(m.c)("Upgrade the room"),[c.b.RoomEncryption]:Object(m.c)("Enable room encryption"),[c.b.RoomServerAcl]:Object(m.c)("Change server ACLs"),[c.b.Reaction]:Object(m.c)("Send reactions"),[c.b.RoomRedaction]:Object(m.c)("Remove messages sent by me"),"im.vector.modular.widgets":n?null:Object(m.c)("Modify widgets"),[E.g]:Object(m.c)("Voice broadcasts")};S.b.getValue("feature_pinning")&&(r[c.b.RoomPinnedEvents]=Object(m.c)("Manage pinned events")),S.b.getValue("feature_group_calls")&&(r[w.d.CALL_EVENT_TYPE.name]=Object(m.c)("Start %(brand)s calls"),r[w.d.MEMBER_EVENT_TYPE.name]=Object(m.c)("Join %(brand)s calls"));const l={users_default:{desc:Object(m.a)("Default role"),defaultValue:0},events_default:{desc:Object(m.a)("Send messages"),defaultValue:0,hideForSpace:!0},invite:{desc:Object(m.a)("Invite users"),defaultValue:0},state_default:{desc:Object(m.a)("Change settings"),defaultValue:50},kick:{desc:Object(m.a)("Remove users"),defaultValue:50},ban:{desc:Object(m.a)("Ban users"),defaultValue:50},redact:{desc:Object(m.a)("Remove messages sent by others"),defaultValue:50,hideForSpace:!0},"notifications.room":{desc:Object(m.a)("Notify everyone"),defaultValue:50,hideForSpace:!0}},d=s.events||{},g=s.users||{},v=K(s.ban,l.ban.defaultValue),f=K(s.users_default,l.users_default.defaultValue);let C=g[e.getUserId()];void 0===C&&(C=f),this.populateDefaultPlEvents(d,K(s.state_default,l.state_default.defaultValue),K(s.events_default,l.events_default.defaultValue));let O,I=a.a.createElement("div",null,Object(m.a)("No users have specific privileges in this room"));if(Object.keys(g).length){const t=[],n=[];Object.keys(g).forEach((i=>{if(!Number.isInteger(g[i]))return;const s=i===e.getUserId(),r=o&&(g[i]<C||s);g[i]>f?t.push(a.a.createElement(b.a,{value:g[i],disabled:!r,label:i,key:i,powerLevelKey:i,onChange:this.onUserPowerLevelChanged})):g[i]<f&&n.push(a.a.createElement(b.a,{value:g[i],disabled:!r,label:i,key:i,powerLevelKey:i,onChange:this.onUserPowerLevelChanged}))}));const i=(e,t)=>{const n=e.key,i=t.key,s=g[i]-g[n];return 0!==s?s:Object(h.h)(n.toLocaleLowerCase(),i.toLocaleLowerCase())};t.sort(i),n.sort(i),t.length&&(I=a.a.createElement(y.a,{legend:Object(m.a)("Privileged Users")},t)),n.length&&(O=a.a.createElement(y.a,{legend:Object(m.a)("Muted Users")},n))}const R=null==t?void 0:t.getMembersWithMembership("ban");let k;if(null!=R&&R.length){const e=C>=v;k=a.a.createElement(y.a,{legend:Object(m.a)("Banned users")},a.a.createElement("ul",null,R.map((n=>{var i;const s=null===(i=n.events.member)||void 0===i?void 0:i.getContent(),o=null==t?void 0:t.getMember(n.events.member.getSender());let r=n.events.member.getSender();return o&&(r=o.name),a.a.createElement($,{key:n.userId,canUnban:e,member:n,reason:s.reason,by:r})}))))}const x=Object.keys(l).map(((e,t)=>{const i=l[e];if(n&&i.hideForSpace)return null;const r=K(Object(u.get)(s,e),i.defaultValue);return a.a.createElement("div",{key:t,className:""},a.a.createElement(b.a,{label:i.desc,value:r,usersDefault:f,disabled:!o||C<r,powerLevelKey:e,onChange:this.onPowerLevelsChanged}))})).filter(Boolean);e.isRoomEncrypted(this.props.roomId)&&delete d[c.b.RoomEncryption];const T=Object.keys(d).map(((e,t)=>{var i,s;if(n&&null!==(i=V[e])&&void 0!==i&&i.hideForSpace)return null;if(!n&&null!==(s=V[e])&&void 0!==s&&s.hideForRoom)return null;let c=r[e];if(c){var l;const e=null!==(l=_.b.get("element_call").brand)&&void 0!==l?l:_.a.element_call.brand;c=Object(m.a)(c,{brand:e})}else c=Object(m.a)("Send %(eventType)s events",{eventType:e});return a.a.createElement("div",{className:"",key:e},a.a.createElement(b.a,{label:c,value:d[e],usersDefault:f,disabled:!o||C<d[e],powerLevelKey:"event_levels_"+e,onChange:this.onPowerLevelsChanged}))})).filter(Boolean);return a.a.createElement("div",{className:"mx_SettingsTab mx_RolesRoomSettingsTab"},a.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(m.a)("Roles & Permissions")),I,o&&null!==t&&a.a.createElement(U,{room:t,defaultUserLevel:f}),O,k,a.a.createElement(y.a,{legend:Object(m.a)("Permissions"),description:n?Object(m.a)("Select the roles required to change various parts of the space"):Object(m.a)("Select the roles required to change various parts of the room")},x,T))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return I}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(1),c=n(130),l=n(121),d=n(140),u=n(124);class h extends r.a.Component{constructor(){super(...arguments),s()(this,"state",{verifyRemove:!1}),s()(this,"onRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})})),s()(this,"onDontRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})})),s()(this,"onActuallyRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.props.onRemove&&this.props.onRemove(this.props.index),this.setState({verifyRemove:!1})}))}render(){return this.state.verifyRemove?r.a.createElement("div",{className:"mx_EditableItem"},r.a.createElement("span",{className:"mx_EditableItem_promptText"},Object(l.a)("Are you sure?")),r.a.createElement(u.a,{onClick:this.onActuallyRemove,kind:"primary_sm",className:"mx_EditableItem_confirmBtn"},Object(l.a)("Yes")),r.a.createElement(u.a,{onClick:this.onDontRemove,kind:"danger_sm",className:"mx_EditableItem_confirmBtn"},Object(l.a)("No"))):r.a.createElement("div",{className:"mx_EditableItem"},r.a.createElement("div",{onClick:this.onRemove,className:"mx_EditableItem_delete",title:Object(l.a)("Remove"),role:"button"}),r.a.createElement("span",{className:"mx_EditableItem_item"},this.props.value))}}class m extends r.a.PureComponent{constructor(){super(...arguments),s()(this,"onItemAdded",(e=>{var t,n;e.stopPropagation(),e.preventDefault(),null===(t=(n=this.props).onItemAdded)||void 0===t||t.call(n,this.props.newItem)})),s()(this,"onItemRemoved",(e=>{var t,n;null===(t=(n=this.props).onItemRemoved)||void 0===t||t.call(n,e)})),s()(this,"onNewItemChanged",(e=>{var t,n;null===(t=(n=this.props).onNewItemChanged)||void 0===t||t.call(n,e.target.value)}))}renderNewItemField(){return r.a.createElement("form",{onSubmit:this.onItemAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},r.a.createElement(d.a,{label:this.props.placeholder,type:"text",autoComplete:"off",value:this.props.newItem||"",onChange:this.onNewItemChanged,list:this.props.suggestionsListId}),r.a.createElement(u.a,{onClick:this.onItemAdded,kind:"primary",type:"submit",disabled:!this.props.newItem},Object(l.a)("Add")))}render(){const e=this.props.items.map(((e,t)=>this.props.canRemove?r.a.createElement(h,{key:e,index:t,value:e,onRemove:this.onItemRemoved}):r.a.createElement("li",{key:e},e))),t=this.props.canRemove?e:r.a.createElement("ul",null,e),n=this.props.items.length>0?this.props.itemsLabel:this.props.noItemsLabel;return r.a.createElement("div",{className:"mx_EditableItemList",id:this.props.id},r.a.createElement("div",{className:"mx_EditableItemList_label"},n),t,this.props.canEdit?this.renderNewItemField():r.a.createElement("div",null))}}var p=n(135),g=n(145),v=n(128),f=n(161),b=n(240),y=n(123);var S={};class E extends r.a.PureComponent{constructor(e){super(e),s()(this,"onRoomPublishChange",(()=>{const e=this.state.isRoomPublished,t=!e;this.setState({isRoomPublished:t});y.a.get().setRoomDirectoryVisibility(this.props.roomId,t?f.f.Public:f.f.Private).catch((()=>{this.setState({isRoomPublished:e})}))})),this.state={isRoomPublished:!1}}componentDidMount(){y.a.get().getRoomDirectoryVisibility(this.props.roomId).then((e=>{this.setState({isRoomPublished:"public"===e.visibility})}))}render(){var e;const t=y.a.get(),n="invite"!==t.getRoom(this.props.roomId).getJoinRule();(!1===(null===(e=S.requireCanonicalAliasAccessToPublish)||void 0===e?void 0:e.call(S))||this.props.canSetCanonicalAlias)&&(n||this.state.isRoomPublished);return r.a.createElement(b.a,{value:this.state.isRoomPublished,onChange:this.onRoomPublishChange,disabled:!1,label:Object(l.a)("Publish this room to the public in %(domain)s's room directory?",{domain:t.getDomain()})})}}var w=n(627),_=n(133),C=n(348);class O extends m{constructor(){super(...arguments),s()(this,"aliasField",Object(o.createRef)()),s()(this,"onAliasAdded",(async e=>{e.preventDefault(),await this.aliasField.current.validate({allowEmpty:!1}),this.aliasField.current.isValid?this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem):(this.aliasField.current.focus(),this.aliasField.current.validate({allowEmpty:!1,focused:!0}))}))}renderNewItemField(){return r.a.createElement("form",{onSubmit:this.onAliasAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},r.a.createElement(w.a,{ref:this.aliasField,onChange:e=>{var t,n;return null===(t=(n=this.props).onNewItemChanged)||void 0===t?void 0:t.call(n,e)},value:this.props.newItem||"",domain:this.props.domain,roomId:this.props.roomId}),r.a.createElement(u.a,{onClick:this.onAliasAdded,kind:"primary"},Object(l.a)("Add")))}}class I extends r.a.Component{constructor(e,t){super(e,t),s()(this,"context",void 0),s()(this,"onNewAliasChanged",(e=>{this.setState({newAlias:e})})),s()(this,"onLocalAliasAdded",(e=>{if(!e||0===e.length)return;const t=this.context.getDomain();e.includes(":")||(e+=":"+t),this.context.createAlias(e,this.props.roomId).then((()=>{this.setState({localAliases:this.state.localAliases.concat(e),newAlias:null}),this.state.canonicalAlias||this.changeCanonicalAlias(e)})).catch((e=>{a.a.error(e),v.b.createDialog(g.a,{title:Object(l.a)("Error creating address"),description:Object(l.a)("There was an error creating that address. It may not be allowed by the server or a temporary failure occurred.")})}))})),s()(this,"onLocalAliasDeleted",(e=>{const t=this.state.localAliases[e];this.context.deleteAlias(t).then((()=>{const e=this.state.localAliases.filter((e=>e!==t));this.setState({localAliases:e}),this.state.canonicalAlias===t&&this.changeCanonicalAlias(null)})).catch((e=>{let t;a.a.error(e),t="M_FORBIDDEN"===e.errcode?Object(l.a)("You don't have permission to delete the address."):Object(l.a)("There was an error removing that address. It may no longer exist or a temporary error occurred."),v.b.createDialog(g.a,{title:Object(l.a)("Error removing address"),description:t})}))})),s()(this,"onLocalAliasesToggled",(e=>{e.target.open&&(this.props.canSetCanonicalAlias||0!==this.state.localAliases.length||this.loadLocalAliases()),this.setState({detailsOpen:e.currentTarget.open})})),s()(this,"onCanonicalAliasChange",(e=>{this.changeCanonicalAlias(e.target.value)})),s()(this,"onNewAltAliasChanged",(e=>{this.setState({newAltAlias:e})})),s()(this,"onAltAliasAdded",(e=>{const t=this.state.altAliases.slice();t.some((t=>t.trim()===e.trim()))||(t.push(e.trim()),this.changeAltAliases(t),this.setState({newAltAlias:""}))})),s()(this,"onAltAliasDeleted",(e=>{const t=this.state.altAliases.slice();t.splice(e,1),this.changeAltAliases(t)}));const n={altAliases:[],localAliases:[],canonicalAlias:null,updatingCanonicalAlias:!1,localAliasesLoading:!1,detailsOpen:!1};if(e.canonicalAliasEvent){const t=e.canonicalAliasEvent.getContent(),i=t.alt_aliases;Array.isArray(i)&&(n.altAliases=i.slice()),n.canonicalAlias=t.alias}this.state=n}componentDidMount(){this.props.canSetCanonicalAlias&&this.loadLocalAliases()}async loadLocalAliases(){this.setState({localAliasesLoading:!0});try{const e=this.context;let t=[];const n=await e.getLocalAliases(this.props.roomId);Array.isArray(null==n?void 0:n.aliases)&&(t=n.aliases),this.setState({localAliases:t}),0===t.length&&this.setState({detailsOpen:!0})}finally{this.setState({localAliasesLoading:!1})}}changeCanonicalAlias(e){if(!this.props.canSetCanonicalAlias)return;const t=this.state.canonicalAlias;this.setState({canonicalAlias:e,updatingCanonicalAlias:!0});const n={alt_aliases:this.state.altAliases};e&&(n.alias=e),this.context.sendStateEvent(this.props.roomId,c.b.RoomCanonicalAlias,n,"").catch((e=>{a.a.error(e),v.b.createDialog(g.a,{title:Object(l.a)("Error updating main address"),description:Object(l.a)("There was an error updating the room's main address. It may not be allowed by the server or a temporary failure occurred.")}),this.setState({canonicalAlias:t})})).finally((()=>{this.setState({updatingCanonicalAlias:!1})}))}changeAltAliases(e){if(!this.props.canSetCanonicalAlias)return;this.setState({updatingCanonicalAlias:!0});const t={};this.state.canonicalAlias&&(t.alias=this.state.canonicalAlias),e&&(t.alt_aliases=e),this.context.sendStateEvent(this.props.roomId,c.b.RoomCanonicalAlias,t,"").then((()=>{this.setState({altAliases:e})})).catch((e=>{a.a.error(e),v.b.createDialog(g.a,{title:Object(l.a)("Error updating main address"),description:Object(l.a)("There was an error updating the room's alternative addresses. It may not be allowed by the server or a temporary failure occurred.")})})).finally((()=>{this.setState({updatingCanonicalAlias:!1})}))}getAliases(){return this.state.altAliases.concat(this.getLocalNonAltAliases())}getLocalNonAltAliases(){const{altAliases:e}=this.state;return this.state.localAliases.filter((t=>!e.includes(t)))}render(){var e;const t=this.context,n=t.getDomain(),i=null===(e=t.getRoom(this.props.roomId))||void 0===e?void 0:e.isSpaceRoom();let s=!1;const o=this.state.canonicalAlias||"",a=r.a.createElement(d.a,{onChange:this.onCanonicalAliasChange,value:o,disabled:this.state.updatingCanonicalAlias||!this.props.canSetCanonicalAlias,element:"select",id:"canonicalAlias",label:Object(l.a)("Main address")},r.a.createElement("option",{value:"",key:"unset"},Object(l.a)("not specified")),this.getAliases().map(((e,t)=>(e===this.state.canonicalAlias&&(s=!0),r.a.createElement("option",{value:e,key:t},e)))),s||!this.state.canonicalAlias?"":r.a.createElement("option",{value:this.state.canonicalAlias,key:"arbitrary"},this.state.canonicalAlias));let c;return c=this.state.localAliasesLoading?r.a.createElement(p.a,null):r.a.createElement(O,{id:"roomAliases",items:this.state.localAliases,newItem:this.state.newAlias,onNewItemChanged:this.onNewAliasChanged,canRemove:this.props.canSetAliases,canEdit:this.props.canSetAliases,onItemAdded:this.onLocalAliasAdded,onItemRemoved:this.onLocalAliasDeleted,noItemsLabel:i?Object(l.a)("This space has no local addresses"):Object(l.a)("This room has no local addresses"),placeholder:Object(l.a)("Local address"),domain:n}),r.a.createElement("div",{className:"mx_AliasSettings"},r.a.createElement(C.a,{"data-testid":"published-address-fieldset",legend:Object(l.a)("Published Addresses"),description:r.a.createElement(r.a.Fragment,null,i?Object(l.a)("Published addresses can be used by anyone on any server to join your space."):Object(l.a)("Published addresses can be used by anyone on any server to join your room.")," ",Object(l.a)("To publish an address, it needs to be set as a local address first."))},a,this.props.hidePublishSetting?null:r.a.createElement(E,{roomId:this.props.roomId,canSetCanonicalAlias:this.props.canSetCanonicalAlias}),r.a.createElement("datalist",{id:"mx_AliasSettings_altRecommendations"},this.getLocalNonAltAliases().map((e=>r.a.createElement("option",{value:e,key:e}))),";"),r.a.createElement(O,{id:"roomAltAliases",items:this.state.altAliases,newItem:this.state.newAltAlias,onNewItemChanged:this.onNewAltAliasChanged,canRemove:this.props.canSetCanonicalAlias,canEdit:this.props.canSetCanonicalAlias,onItemAdded:this.onAltAliasAdded,onItemRemoved:this.onAltAliasDeleted,suggestionsListId:"mx_AliasSettings_altRecommendations",itemsLabel:Object(l.a)("Other published addresses:"),noItemsLabel:Object(l.a)("No other published addresses yet, add one below"),placeholder:Object(l.a)("New published address (e.g. #alias:server)"),roomId:this.props.roomId})),r.a.createElement(C.a,{"data-testid":"local-address-fieldset",legend:Object(l.a)("Local Addresses"),description:i?Object(l.a)("Set addresses for this space so users can find this space through your homeserver (%(localDomain)s)",{localDomain:n}):Object(l.a)("Set addresses for this room so users can find this room through your homeserver (%(localDomain)s)",{localDomain:n})},r.a.createElement("details",{onToggle:this.onLocalAliasesToggled,open:this.state.detailsOpen},r.a.createElement("summary",null,this.state.detailsOpen?Object(l.a)("Show less"):Object(l.a)("Show more")),c)))}}s()(I,"contextType",_.a),s()(I,"defaultProps",{canSetAliases:!1,canSetCanonicalAlias:!1})},function(e,t,n){"use strict";n.d(t,"a",(function(){return P}));var i=n(131),s=n.n(i),o=n(122),r=n.n(o),a=n(120),c=n.n(a),l=n(1),d=n(209),u=n(121),h=n(893),m=n(214),p=n(344);class g extends c.a.PureComponent{constructor(e){super(e),r()(this,"onTimeUpdate",(e=>{this.setState({durationSeconds:e[1]})})),this.state={durationSeconds:this.props.playback.clockInfo.durationSeconds},this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}render(){return c.a.createElement(p.a,{seconds:this.state.durationSeconds})}}var v=n(634),f=n(894),b=n(895),y=n(255);class S extends b.a{renderFileSize(){const e=this.props.playback.sizeBytes;return e?`(${Object(m.a)(e)})`:null}renderComponent(){return c.a.createElement("div",{className:"mx_MediaBody mx_AudioPlayer_container",tabIndex:0,onKeyDown:this.onKeyDown},c.a.createElement("div",{className:"mx_AudioPlayer_primaryContainer"},c.a.createElement(h.a,{playback:this.props.playback,playbackPhase:this.state.playbackPhase,tabIndex:-1,ref:this.playPauseRef}),c.a.createElement("div",{className:"mx_AudioPlayer_mediaInfo"},c.a.createElement("span",{className:"mx_AudioPlayer_mediaName"},this.props.mediaName||Object(u.a)("Unnamed audio")),c.a.createElement("div",{className:"mx_AudioPlayer_byline"},c.a.createElement(g,{playback:this.props.playback}),"  ",this.renderFileSize()))),c.a.createElement("div",{className:"mx_AudioPlayer_seek"},c.a.createElement(v.a,{playback:this.props.playback,tabIndex:-1,disabled:this.state.playbackPhase===y.d.Decoding,ref:this.seekRef}),c.a.createElement(f.a,{playback:this.props.playback,defaultDisplaySeconds:0})))}}var E=n(345),w=n(513),_=n(182),C=n(130),O=n(154),I=n(123),R=n(147),k=n(155);class x{constructor(e){this.room=e,r()(this,"playbacks",new Map),r()(this,"clockStates",new Map),r()(this,"playbackIdOrder",[]),r()(this,"currentPlaybackId",null),r()(this,"recentFullPlays",new Set),this.loadClocks(),k.b.instance.roomViewStore.addRoomListener(this.room.roomId,(e=>{e&&(this.currentPlaybackId=null,this.recentFullPlays=new Set,this.playbackIdOrder=[])}))}static forRoom(e){const t=I.a.get().getRoom(e);if(!t)throw new Error("Unknown room");if(x.queues.has(t.roomId))return x.queues.get(t.roomId);const n=new x(t);return x.queues.set(t.roomId,n),n}persistClocks(){localStorage.setItem(`mx_voice_message_clocks_${this.room.roomId}`,JSON.stringify(Array.from(this.clockStates.entries())))}loadClocks(){const e=localStorage.getItem(`mx_voice_message_clocks_${this.room.roomId}`);e&&(this.clockStates=new Map(JSON.parse(e)))}unsortedEnqueue(e,t){this.playbacks.set(e.getId(),t),t.on(O.b,(n=>this.onPlaybackStateChange(t,e,n))),t.clockInfo.liveData.onUpdate((n=>this.onPlaybackClock(t,e,n)))}onPlaybackStateChange(e,t,n){const i=this.currentPlaybackId===t.getId();if(n===y.d.Stopped&&this.clockStates.has(t.getId())&&!i)e.skipTo(this.clockStates.get(t.getId()));else if(n===y.d.Stopped&&(this.clockStates.delete(t.getId()),i)){this.recentFullPlays.add(this.currentPlaybackId);const e=Object(R.b)(this.playbackIdOrder),n=e.pop();if(n===this.currentPlaybackId){const i=e.pop();if(i){const t=this.playbacks.get(i);t?(this.playbackIdOrder=e,w.a.instance.pauseAllExcept(t),t.play()):l.a.warn(`Voice message queue desync: Missing playback for next message: Current=${this.currentPlaybackId} Last=${n} Next=${i}`)}else{const n=Object(R.b)(this.room.getLiveTimeline().getEvents());let i,s=!1;for(const e of n){if(e.getId()===t.getId()){s=!0;continue}if(!s)continue;if(!Object(_.m)(e)){const t=e.getType();if(t!==C.b.RoomMessage&&t!==C.b.Sticker)continue;break}const n=this.playbacks.has(e.getId()),o=this.recentFullPlays.has(e.getId());if(n&&!o){i=e;break}}if(i){this.playbackIdOrder=e;const t=this.playbacks.get(i.getId());w.a.instance.pauseAllExcept(t),t.play()}else this.recentFullPlays=new Set,this.playbackIdOrder=[]}}else l.a.warn(`Voice message queue desync: Expected playback stop to be last in order. Current=${this.currentPlaybackId} Last=${n} EventID=${t.getId()}`)}if(n===y.d.Playing){const e=this.playbackIdOrder;if(this.currentPlaybackId!==t.getId()&&this.currentPlaybackId&&(0===e.length||e[e.length-1]!==this.currentPlaybackId)){const t=this.playbacks.get(this.currentPlaybackId);t.currentState!==y.d.Playing&&t.currentState!==y.d.Paused||e.push(this.currentPlaybackId)}this.currentPlaybackId=t.getId(),0!==e.length&&e[e.length-1]===this.currentPlaybackId||e.push(this.currentPlaybackId)}n!==y.d.Paused&&n!==y.d.Stopped||this.persistClocks()}onPlaybackClock(e,t,n){e.currentState!==y.d.Decoding&&e.currentState!==y.d.Stopped&&this.clockStates.set(t.getId(),n[0])}}r()(x,"queues",new Map);var T=n(139),j=n(481);class P extends c.a.PureComponent{constructor(e){super(e),r()(this,"context",void 0),this.state={}}async componentDidMount(){var e,t;let n;try{try{const e=await this.props.mediaEventHelper.sourceBlob.value;n=await e.arrayBuffer()}catch(e){return this.setState({error:e}),void l.a.warn("Unable to decrypt audio message",e)}}catch(e){return this.setState({error:e}),void l.a.warn("Unable to decrypt/download audio message",e)}const i=this.props.mxEvent.getContent(),s=null==i||null===(e=i["org.matrix.msc1767.audio"])||void 0===e||null===(t=e.waveform)||void 0===t?void 0:t.map((e=>e/1024)),o=w.a.instance.createPlaybackInstance(n,s);o.clockInfo.populatePlaceholdersFrom(this.props.mxEvent),this.setState({playback:o}),Object(_.m)(this.props.mxEvent)&&x.forRoom(this.props.mxEvent.getRoomId()).unsortedEnqueue(this.props.mxEvent,o)}componentWillUnmount(){var e;null===(e=this.state.playback)||void 0===e||e.destroy()}get showFileBody(){return this.context.timelineRenderingType!==T.a.Room&&this.context.timelineRenderingType!==T.a.Pinned&&this.context.timelineRenderingType!==T.a.Search}render(){if(this.state.error)return c.a.createElement(j.a,{className:"mx_MAudioBody"},Object(u.a)("Error processing audio message"));if(this.props.forExport){var e;const t=this.props.mxEvent.getContent(),n=(null===(e=t.file)||void 0===e?void 0:e.url)||t.url;return c.a.createElement("span",{className:"mx_MAudioBody"},c.a.createElement("audio",{src:n,controls:!0}))}return this.state.playback?c.a.createElement("span",{className:"mx_MAudioBody"},c.a.createElement(S,{playback:this.state.playback,mediaName:this.props.mxEvent.getContent().body}),this.showFileBody&&c.a.createElement(E.a,s()({},this.props,{showGenericPlaceholder:!1})),this.props.scBubbleTimestamp):c.a.createElement("span",{className:"mx_MAudioBody"},c.a.createElement(d.a,null))}}r()(P,"contextType",T.b)},function(e,t,n){"use strict";n.d(t,"c",(function(){return C})),n.d(t,"a",(function(){return O})),n.d(t,"d",(function(){return I})),n.d(t,"b",(function(){return k}));var i=n(175),s=n(123),o=n(125),r=n(128),a=n(184),c=n(254),l=n(120),d=n.n(l),u=n(121),h=n(271),m=n(124),p=n(136);var g=e=>{let t,n,{device:i,user:o,onFinished:r}=e;return s.a.get().getUserId()===o.userId?(n=Object(u.a)("You signed in to a new session without verifying it:"),t=Object(u.a)("Verify your other session using one of the options below.")):(n=Object(u.a)("%(name)s (%(userId)s) signed in to a new session without verifying it:",{name:o.displayName,userId:o.userId}),t=Object(u.a)("Ask this user to verify their session, or manually verify it below.")),d.a.createElement(p.a,{onFinished:r,className:"mx_UntrustedDeviceDialog",title:d.a.createElement(d.a.Fragment,null,d.a.createElement(h.b,{status:h.a.Warning,size:24,hideTooltip:!0}),Object(u.a)("Not Trusted"))},d.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},d.a.createElement("p",null,n),d.a.createElement("p",null,i.getDisplayName()," (",i.deviceId,")"),d.a.createElement("p",null,t)),d.a.createElement("div",{className:"mx_Dialog_buttons"},d.a.createElement(m.a,{kind:"primary_outline",onClick:()=>r("legacy")},Object(u.a)("Manually verify by text")),d.a.createElement(m.a,{kind:"primary_outline",onClick:()=>r("sas")},Object(u.a)("Interactively verify by emoji")),d.a.createElement(m.a,{kind:"primary",onClick:()=>r(!1)},Object(u.a)("Done"))))},v=n(122),f=n.n(v),b=n(214),y=n(157);class S extends d.a.Component{constructor(){super(...arguments),f()(this,"onLegacyFinished",(e=>{e&&s.a.get().setDeviceVerified(this.props.userId,this.props.device.deviceId,!0),this.props.onFinished(e)}))}render(){let e;e=s.a.get().getUserId()===this.props.userId?Object(u.a)("Confirm by comparing the following with the User Settings in your other session:"):Object(u.a)("Confirm this user's session by comparing the following with their User Settings:");const t=b.e(this.props.device.getFingerprint()),n=d.a.createElement("div",null,d.a.createElement("p",null,e),d.a.createElement("div",{className:"mx_DeviceVerifyDialog_cryptoSection"},d.a.createElement("ul",null,d.a.createElement("li",null,d.a.createElement("label",null,Object(u.a)("Session name"),":")," ",d.a.createElement("span",null,this.props.device.getDisplayName())),d.a.createElement("li",null,d.a.createElement("label",null,Object(u.a)("Session ID"),":")," ",d.a.createElement("span",null,d.a.createElement("code",null,this.props.device.deviceId))),d.a.createElement("li",null,d.a.createElement("label",null,Object(u.a)("Session key"),":")," ",d.a.createElement("span",null,d.a.createElement("code",null,d.a.createElement("b",null,t)))))),d.a.createElement("p",null,Object(u.a)("If they don't match, the security of your communication may be compromised.")));return d.a.createElement(y.a,{title:Object(u.a)("Verify session"),description:n,button:Object(u.a)("Verify session"),onFinished:this.onLegacyFinished})}}var E=n(174),w=n(309);async function _(){const e=s.a.get();if(!e.isCryptoEnabled())return!1;return!!e.getCrossSigningId("user_signing")||(await Object(c.b)(),!1)}async function C(e,t){const n=s.a.get();n.isGuest()?o.a.dispatch({action:"require_registration"}):n.getCryptoTrustCrossSignedDevices()&&!await _()||r.b.createDialog(g,{user:e,device:t,onFinished:async s=>{if("sas"===s){const s=n.legacyDeviceVerification(e.userId,t.deviceId,i.e.SAS);R({member:e,verificationRequestPromise:s})}else"legacy"===s&&r.b.createDialog(S,{userId:e.userId,device:t})}})}async function O(e){const t=s.a.get();if(t.isGuest())return void o.a.dispatch({action:"require_registration"});if(t.getCryptoTrustCrossSignedDevices()&&!await _())return;R({member:e,verificationRequestPromise:t.requestVerification(e.userId)})}async function I(e){if(s.a.get().isGuest())return void o.a.dispatch({action:"require_registration"});if(!await _())return;R({member:e,verificationRequest:k(e)})}function R(e){E.a.instance.roomPhaseHistory.some((e=>e.phase==a.a.RoomSummary))?E.a.instance.pushCard({phase:a.a.EncryptionPanel,state:e}):E.a.instance.setCards([{phase:a.a.RoomSummary},{phase:a.a.RoomMemberInfo,state:{member:e.member}},{phase:a.a.EncryptionPanel,state:e}])}function k(e){const t=s.a.get(),n=Object(w.a)(t,e.userId);if(n)return t.findVerificationRequestDMInProgress(n.roomId)}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(122),s=n.n(i),o=n(137),r=n(227),a=n(504),c=n(523);function l(){return new Worker(n.p+"dcea4edb483c918df37e.worker.js")}function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const h=window.localStorage;let m;try{m=window.indexedDB}catch(e){}function p(e){const t={useAuthorizationHeader:!0};return m&&h?t.store=new a.a({indexedDB:m,dbName:"riot-web-sync",localStorage:h,workerFactory:()=>new l}):h&&(t.store=new o.MemoryStore({localStorage:h})),t.cryptoStore=m?new r.a(m,"matrix-js-sdk:crypto"):h?new c.a(h):new o.MemoryCryptoStore,Object(o.createClient)(u(u({},t),e))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return oe}));var i,s,o=n(122),r=n.n(o),a=n(120),c=n.n(a),l=n(127),d=n.n(l),u=n(186),h=n(1);function m(){return m=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},m.apply(this,arguments)}function p(e){return a.createElement("svg",m({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),i||(i=a.createElement("circle",{cx:10,cy:10,r:9.5,stroke:"#787878"})),s||(s=a.createElement("path",{d:"M9.792 14h1.415V8H9.791v6zm.711-6.852c.45 0 .817-.343.817-.765 0-.426-.367-.77-.817-.77-.453 0-.82.344-.82.77 0 .422.367.765.82.765z",fill:"#787878"})))}var g=n(739),v=n(121),f=n(123),b=n(168),y=n(164),S=n(132),E=n(331),w=n(446),_=n(740),C=n(372),O=n(292),I=n(741),R=n(236),k=n(129),x=n(192),T=n(228),j=n(126),P=n(158),D=n(160),N=n(193),M=n(905),A=n(124),L=n(230),U=n(140),F=n(340),B=n(652),V=n(157),K=n(135),$=n(136),H=n(906),W=n(185),q=n(263),G=n(302),z=n(143),J=n(153),Y=n(416),Q=n(624),X=n(128),Z=n(125),ee=n(312);var te;!function(e){e.UserDirectory="users",e.DialPad="dialpad"}(te||(te={}));class ne extends c.a.PureComponent{constructor(){super(...arguments),r()(this,"onRemove",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onRemove(this.props.member)}))}render(){const e=c.a.createElement(M.a,{user:this.props.member,size:20});let t;return this.props.onRemove&&(t=c.a.createElement(A.a,{className:"mx_InviteDialog_userTile_remove",onClick:this.onRemove},c.a.createElement("img",{src:n(907).default,alt:Object(v.a)("Remove"),width:8,height:8}))),c.a.createElement("span",{className:"mx_InviteDialog_userTile"},c.a.createElement("span",{className:"mx_InviteDialog_userTile_pill"},e,c.a.createElement("span",{className:"mx_InviteDialog_userTile_name"},this.props.member.name)),t)}}const ie=e=>e instanceof u.a?new Y.a({user_id:e.userId,display_name:e.name,avatar_url:e.getMxcAvatarUrl()}):e;class se extends c.a.PureComponent{constructor(){super(...arguments),r()(this,"onClick",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onToggle(this.props.member)}))}highlightName(e){if(!this.props.highlightWord)return e;const t=e.toLowerCase(),n=this.props.highlightWord.toLowerCase(),i=[];let s,o=0;for(;(s=t.indexOf(n,o))>=0;){s>o&&i.push(c.a.createElement("span",{key:o+"begin"},e.substring(o,s))),o=s;const t=e.substring(o,n.length+o);i.push(c.a.createElement("span",{className:"mx_InviteDialog_tile--room_highlight",key:o+"bold"},t)),o+=t.length}return o<e.length&&i.push(c.a.createElement("span",{key:o+"end"},e.substring(o))),i}render(){let e;if(this.props.lastActiveTs){const t=Object(I.a)(this.props.lastActiveTs);e=c.a.createElement("span",{className:"mx_InviteDialog_tile--room_time"},t)}const t=this.props.member.isEmail?c.a.createElement(g.a,{width:36,height:36}):c.a.createElement(N.a,{url:this.props.member.getMxcAvatarUrl()?Object(D.b)(this.props.member.getMxcAvatarUrl()).getSquareThumbnailHttp(36):null,name:this.props.member.name,idName:this.props.member.userId,width:36,height:36});let n;this.props.isSelected&&(n=c.a.createElement("div",{className:"mx_InviteDialog_tile--room_selected"}));const i=c.a.createElement("span",{className:"mx_InviteDialog_tile_avatarStack"},t,n),s=q.a.getDisplayUserIdentifier(this.props.member.userId,{withDisplayName:!0}),o=this.props.member.isEmail?Object(v.a)("Invite by email"):this.highlightName(s||this.props.member.userId);return c.a.createElement("div",{className:"mx_InviteDialog_tile mx_InviteDialog_tile--room",onClick:this.onClick},i,c.a.createElement("span",{className:"mx_InviteDialog_tile_nameStack"},c.a.createElement("div",{className:"mx_InviteDialog_tile_nameStack_name"},this.highlightName(this.props.member.name)),c.a.createElement("div",{className:"mx_InviteDialog_tile_nameStack_userId"},o)),e)}}class oe extends c.a.PureComponent{constructor(e){if(super(e),r()(this,"debounceTimer",null),r()(this,"editorRef",Object(a.createRef)()),r()(this,"numberEntryFieldRef",Object(a.createRef)()),r()(this,"unmounted",!1),r()(this,"encryptionByDefault",!1),r()(this,"onConsultFirstChange",(e=>{this.setState({consultFirst:e.target.checked})})),r()(this,"startDm",(async()=>{this.setState({busy:!0});try{const e=f.a.get(),t=this.convertFilter();await Object(Y.e)(e,t),this.props.onFinished(!0)}catch(e){h.a.error(e),this.setState({busy:!1,errorText:Object(v.a)("We couldn't create your DM.")})}})),r()(this,"inviteUsers",(async()=>{if(this.props.kind!==Q.a.Invite)return;this.setState({busy:!0}),this.convertFilter();const e=this.convertFilter().map((e=>e.userId)),t=f.a.get().getRoom(this.props.roomId);if(!t)return h.a.error("Failed to find the room to invite users to"),void this.setState({busy:!1,errorText:Object(v.a)("Something went wrong trying to invite the users.")});try{const n=await Object(R.a)(this.props.roomId,e,!0);this.shouldAbortAfterInviteError(n,t)||this.props.onFinished(!0)}catch(e){h.a.error(e),this.setState({busy:!1,errorText:Object(v.a)("We couldn't invite those users. Please check the users you want to invite and try again.")})}})),r()(this,"transferCall",(async()=>{if(this.props.kind===Q.a.CallTransfer){if(this.state.currentTabId==te.UserDirectory){this.convertFilter();const e=this.convertFilter().map((e=>e.userId));if(e.length>1)return void this.setState({errorText:Object(v.a)("A call can only be transferred to a single user.")});W.b.instance.startTransferToMatrixID(this.props.call,e[0],this.state.consultFirst)}else W.b.instance.startTransferToPhoneNumber(this.props.call,this.state.dialPadValue,this.state.consultFirst);this.props.onFinished(!0)}})),r()(this,"onKeyDown",(e=>{if(this.state.busy)return;let t=!1;const n=e.currentTarget.value.trim();switch(Object(J.a)().getAccessibilityAction(e)){case z.h.Backspace:if(n||this.state.targets.length<=0)break;this.removeMember(this.state.targets[this.state.targets.length-1]),t=!0;break;case z.h.Space:if(!n||!n.includes("@")||n.includes(" "))break;this.convertFilter(),t=!0;break;case z.h.Enter:if(!n)break;this.convertFilter(),t=!0}t&&e.preventDefault()})),r()(this,"onCancel",(()=>{this.props.onFinished(!1)})),r()(this,"updateSuggestions",(async e=>{if(f.a.get().searchUserDirectory({term:e}).then((async t=>{if(e===this.state.filterText){if(t.results||(t.results=[]),"@"===e[0]&&e.indexOf(":")>1)try{const n=await f.a.get().getProfileInfo(e);n&&t.results.splice(0,0,{user_id:e,display_name:n.displayname,avatar_url:n.avatar_url})}catch(n){h.a.warn("Non-fatal error trying to make an invite for a user ID"),h.a.warn(n);const i=Object(b.e)(e);Object(b.c)(i)&&t.results.splice(0,0,{user_id:e,display_name:e})}this.setState({serverResultsMixin:t.results.map((e=>({userId:e.user_id,user:new Y.a(e)})))})}})).catch((e=>{h.a.error("Error searching user directory:"),h.a.error(e),this.setState({serverResultsMixin:[]})})),this.state.canUseIdentityServer){if(E.a(e)&&this.canInviteThirdParty()&&j.b.getValue(P.b.IdentityServer)){this.setState({threepidResultsMixin:[{user:new Y.b(e),userId:e}]});try{const t=new O.a,n=await t.getAccessToken();if(!n)return;if(e!==this.state.filterText)return;const i=await f.a.get().lookupThreePid("email",e,n);if(e!==this.state.filterText)return;if(!i||!i.mxid)return;const s=await f.a.get().getProfileInfo(i.mxid);if(e!==this.state.filterText||!s)return;this.setState({threepidResultsMixin:[...this.state.threepidResultsMixin,{user:new Y.a({user_id:i.mxid,display_name:s.displayname,avatar_url:s.avatar_url}),userId:e}]})}catch(e){h.a.error("Error searching identity server:"),h.a.error(e),this.setState({threepidResultsMixin:[]})}}}else this.setState({tryingIdentityServer:!0})})),r()(this,"updateFilter",(e=>{const t=e.target.value;this.setState({filterText:t}),this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout((()=>{this.updateSuggestions(t)}),150)})),r()(this,"showMoreRecents",(()=>{this.setState({numRecentsShown:this.state.numRecentsShown+5})})),r()(this,"showMoreSuggestions",(()=>{this.setState({numSuggestionsShown:this.state.numSuggestionsShown+5})})),r()(this,"toggleMember",(e=>{if(!this.state.busy){let t=this.state.filterText,n=this.state.targets.map((e=>e));const i=n.indexOf(e);i>=0?n.splice(i,1):(this.props.kind===Q.a.CallTransfer&&n.length>0&&(n=[]),n.push(e),t=""),this.setState({targets:n,filterText:t}),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()}})),r()(this,"removeMember",(e=>{const t=this.state.targets.map((e=>e)),n=t.indexOf(e);n>=0&&(t.splice(n,1),this.setState({targets:t})),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()})),r()(this,"onPaste",(async e=>{if(this.state.filterText)return;e.preventDefault();const t=e.clipboardData.getData("text"),n=[...this.state.recents,...this.state.suggestions,...this.state.serverResultsMixin,...this.state.threepidResultsMixin],i=[],s=[],o=[],r=this.parseFilter(t);for(const t of r){const r=n.find((e=>e.userId===t));if(r)this.canInviteMore([...this.state.targets,...i])?i.push(r.user):o.push(t);else if(E.a(t))this.canInviteThirdParty([...this.state.targets,...i])?i.push(new Y.b(t)):o.push(t);else if("@"===t[0])try{const e=await f.a.get().getProfileInfo(t);i.push(new Y.a({user_id:t,display_name:null==e?void 0:e.displayname,avatar_url:null==e?void 0:e.avatar_url}))}catch(e){h.a.error("Error looking up profile for "+t),h.a.error(e),s.push(t)}else s.push(t)}this.unmounted||(s.length>0&&X.b.createDialog(V.a,{title:Object(v.a)("Failed to find the following users"),description:Object(v.a)("The following users might not exist or are invalid, and cannot be invited: %(csvNames)s",{csvNames:s.join(", ")}),button:Object(v.a)("OK")}),o?this.setState({filterText:o.join(" "),targets:[...this.state.targets,...i]}):this.setState({targets:[...this.state.targets,...i]}))})),r()(this,"onClickInputArea",(e=>{e.preventDefault(),e.stopPropagation(),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()})),r()(this,"onUseDefaultIdentityServerClick",(e=>{e.preventDefault(),Object(w.d)(),this.setState({canUseIdentityServer:!0,tryingIdentityServer:!1})})),r()(this,"onManageSettingsClick",(e=>{e.preventDefault(),Z.a.fire(k.a.ViewUserSettings),this.props.onFinished(!1)})),r()(this,"onDialFormSubmit",(e=>{e.preventDefault(),this.transferCall()})),r()(this,"onDialChange",(e=>{this.setState({dialPadValue:e.currentTarget.value})})),r()(this,"onDigitPress",((e,t)=>{var n;(this.setState({dialPadValue:this.state.dialPadValue+e}),"click"===t.type)&&(null===(n=this.numberEntryFieldRef.current)||void 0===n||n.focus())})),r()(this,"onDeletePress",(e=>{var t;0!==this.state.dialPadValue.length&&(this.setState({dialPadValue:this.state.dialPadValue.slice(0,-1)}),"click"===e.type&&(null===(t=this.numberEntryFieldRef.current)||void 0===t||t.focus()))})),r()(this,"onTabChange",(e=>{this.setState({currentTabId:e})})),e.kind===Q.a.Invite&&!e.roomId)throw new Error("When using InviteKind.Invite a roomId is required for an InviteDialog");if(e.kind===Q.a.CallTransfer&&!e.call)throw new Error("When using InviteKind.CallTransfer a call is required for an InviteDialog");const t=new Set([f.a.get().getUserId()]),n=S.b.get("welcome_user_id");if(n&&t.add(n),function(e){return e.kind===Q.a.Invite}(e)){const n=f.a.get().getRoom(e.roomId);if(!n)throw new Error("Room ID given to InviteDialog does not look like a room");n.getMembersWithMembership("invite").forEach((e=>t.add(e.userId))),n.getMembersWithMembership("join").forEach((e=>t.add(e.userId))),n.getMembersWithMembership("ban").forEach((e=>t.add(e.userId)))}this.state={targets:[],filterText:this.props.initialText||"",recents:oe.buildRecents(t),numRecentsShown:3,suggestions:this.buildSuggestions(t),numSuggestionsShown:3,serverResultsMixin:[],threepidResultsMixin:[],canUseIdentityServer:!!f.a.get().getIdentityServerUrl(),tryingIdentityServer:!1,consultFirst:!1,dialPadValue:"",currentTabId:te.UserDirectory,busy:!1}}componentDidMount(){this.encryptionByDefault=Object(ee.a)(),this.props.initialText&&this.updateSuggestions(this.props.initialText)}componentWillUnmount(){this.unmounted=!0}static buildRecents(e){const t=y.a.shared().getUniqueRoomsWithIndividuals(),n=T.c.instance.orderedLists[x.a.DM]||[],i=f.a.get().getUserId();for(const e of n){const n=e.getJoinedMembers().filter((e=>e.userId!==i));for(const i of n)t[i.userId]||(h.a.warn(`Adding DM room for ${i.userId} as ${e.roomId} from tag, not DM map`),t[i.userId]=e)}const s=[];for(const n in t){if(e.has(n)){h.a.warn(`[Invite:Recents] Excluding ${n} from recents`);continue}const i=t[n],o=i.getMember(n);if(!o){h.a.warn(`[Invite:Recents] ${n} is missing a member object in their own DM (${i.roomId})`);continue}const r=["m.room.message","m.room.encrypted","m.sticker"],a=20;let c=0;if(i.timeline&&i.timeline.length)for(let e=i.timeline.length-1;e>=0;e--){const t=i.timeline[e];if(r.includes(t.getType())){c=t.getTs();break}if(i.timeline.length-e>a)break}c?s.push({userId:n,user:ie(o),lastActive:c}):h.a.warn(`[Invite:Recents] ${n} (${i.roomId}) has a weird last timestamp: ${c}`)}return s||h.a.warn("[Invite:Recents] No recents to suggest!"),s.sort(((e,t)=>t.lastActive-e.lastActive)),s}buildSuggestions(e){const t=f.a.get(),n=Object(_.a)(t),i=Object(_.b)(t),s=Object(_.c)(n,i);return Object.values(i).map((e=>{let{member:t}=e;return t})).filter((t=>!e.has(t.userId))).sort(s).map((e=>({userId:e.userId,user:ie(e)})))}shouldAbortAfterInviteError(e,t){this.setState({busy:!1});const n=new Map(this.state.targets.map((e=>[e.userId,e])));return!Object(R.d)(e.states,t,e.inviter,n)}convertFilter(){if(!this.state.filterText||!this.state.filterText.includes("@"))return this.state.targets||[];if(!this.canInviteMore())return this.state.targets;let e;if(this.state.filterText.startsWith("@")?e=new Y.a({user_id:this.state.filterText}):j.b.getValue(P.b.IdentityServer)&&this.canInviteThirdParty()&&(e=new Y.b(this.state.filterText)),!e)return this.state.targets;const t=[...this.state.targets||[],e];return this.setState({targets:t,filterText:""}),t}parseFilter(e){return e.split(/[\s,]+/).map((e=>e.trim())).filter((e=>!!e))}renderSection(e){let t="recents"===e?this.state.recents:this.state.suggestions,n="recents"===e?this.state.numRecentsShown:this.state.numSuggestionsShown;const i="recents"===e?this.showMoreRecents.bind(this):this.showMoreSuggestions.bind(this);let s="recents"===e?Object(v.a)("Recent Conversations"):Object(v.a)("Suggestions");this.props.kind===Q.a.Invite&&(s="recents"===e?Object(v.a)("Recently Direct Messaged"):Object(v.a)("Suggestions"));let o=[],r=[];const a=this.state.serverResultsMixin||this.state.threepidResultsMixin;if(this.state.filterText&&a&&"suggestions"===e){const e=e=>!t.some((t=>t.userId===e.userId))&&!o.some((t=>t.userId===e.userId))&&!r.some((t=>t.userId===e.userId));r=this.state.serverResultsMixin.filter(e),o=this.state.threepidResultsMixin.filter(e)}const l=o.length>0||r.length>0;if(0===t.length&&!l)return null;if(this.canInviteThirdParty()||(o=o.filter((e=>e instanceof Y.b))),this.state.filterText){const e=this.state.filterText.toLowerCase();if(t=t.filter((t=>t.user.name.toLowerCase().includes(e)||t.userId.toLowerCase().includes(e))),0===t.length&&!l)return c.a.createElement("div",{className:"mx_InviteDialog_section"},c.a.createElement("h3",null,s),c.a.createElement("p",null,Object(v.a)("No results")))}t=[...o,...t,...r],n===t.length-1&&n++;const d=t.slice(0,n);let u;d.length<t.length&&(u=c.a.createElement("div",{className:"mx_InviteDialog_section_showMore"},c.a.createElement(A.a,{onClick:i,kind:"link"},Object(v.a)("Show more"))));const h=d.map((t=>{return c.a.createElement(se,{member:t.user,lastActiveTs:(n=t,"recents"===e?n.lastActive:void 0),key:t.user.userId,onToggle:this.toggleMember,highlightWord:this.state.filterText,isSelected:this.state.targets.some((e=>e.userId===t.userId))});var n}));return c.a.createElement("div",{className:"mx_InviteDialog_section"},c.a.createElement("h3",null,s),h,u)}renderEditor(){const e=this.props.kind==Q.a.CallTransfer&&0===this.state.targets.length&&0===this.state.filterText.length,t=this.state.targets.map((e=>c.a.createElement(ne,{member:e,onRemove:this.state.busy?void 0:this.removeMember,key:e.userId}))),n=c.a.createElement("input",{type:"text",onKeyDown:this.onKeyDown,onChange:this.updateFilter,value:this.state.filterText,ref:this.editorRef,onPaste:this.onPaste,autoFocus:!0,disabled:this.state.busy||this.props.kind==Q.a.CallTransfer&&this.state.targets.length>0,autoComplete:"off",placeholder:e?Object(v.a)("Search"):void 0,"data-testid":"invite-dialog-input"});return c.a.createElement("div",{className:"mx_InviteDialog_editor",onClick:this.onClickInputArea},t,n)}renderIdentityServerWarning(){if(!this.state.tryingIdentityServer||this.state.canUseIdentityServer||!j.b.getValue(P.b.IdentityServer))return null;const e=Object(w.c)();return e?c.a.createElement("div",{className:"mx_InviteDialog_identityServer"},Object(v.a)("Use an identity server to invite by email. <default>Use the default (%(defaultIdentityServerName)s)</default> or manage in <settings>Settings</settings>.",{defaultIdentityServerName:Object(C.a)(e)},{default:e=>c.a.createElement(A.a,{kind:"link_inline",onClick:this.onUseDefaultIdentityServerClick},e),settings:e=>c.a.createElement(A.a,{kind:"link_inline",onClick:this.onManageSettingsClick},e)})):c.a.createElement("div",{className:"mx_InviteDialog_identityServer"},Object(v.a)("Use an identity server to invite by email. Manage in <settings>Settings</settings>.",{},{settings:e=>c.a.createElement(A.a,{kind:"link_inline",onClick:this.onManageSettingsClick},e)}))}async onLinkClick(e){e.preventDefault(),Object(L.d)(e.currentTarget)}get screenName(){if(this.props.kind===Q.a.Dm)return"StartChat"}canInviteMore(e){return e=e||this.state.targets,this.canInviteThirdParty(e)||!e.some((e=>e instanceof Y.b))}canInviteThirdParty(e){return e=e||this.state.targets,this.props.kind!==Q.a.Dm||0===e.length||!this.encryptionByDefault}hasFilterAtLeastOneEmail(){return!!this.state.filterText&&this.parseFilter(this.state.filterText).some((e=>E.a(e)))}render(){let e,t,n,i,s,o,r,a;this.state.busy&&(e=c.a.createElement(K.a,{w:20,h:20}));let l=c.a.createElement("span",null);const u=j.b.getValue(P.b.IdentityServer),h=this.state.targets.length>0||this.state.filterText&&this.state.filterText.includes("@"),m=f.a.get(),g=m.getUserId();if(this.props.kind===Q.a.Dm){t=Object(v.a)("Direct Messages"),n=u?Object(v.a)("Start a conversation with someone using their name, email address or username (like <userId/>).",{},{userId:()=>c.a.createElement("a",{href:Object(b.i)(g),rel:"noreferrer noopener",target:"_blank"},g)}):Object(v.a)("Start a conversation with someone using their name or username (like <userId/>).",{},{userId:()=>c.a.createElement("a",{href:Object(b.i)(g),rel:"noreferrer noopener",target:"_blank"},g)}),i=Object(v.a)("Go"),s=this.startDm,r=c.a.createElement("div",{className:"mx_InviteDialog_section_hidden_suggestions_disclaimer"},c.a.createElement("span",null,Object(v.a)("Some suggestions may be hidden for privacy.")),c.a.createElement("p",null,Object(v.a)("If you can't see who you're looking for, send them your invite link below.")));const e=Object(b.i)(f.a.get().getUserId());a=c.a.createElement("div",{className:"mx_InviteDialog_footer"},c.a.createElement("h3",null,Object(v.a)("Or send invite link")),c.a.createElement(G.a,{getTextToCopy:()=>Object(b.i)(f.a.get().getUserId())},c.a.createElement("a",{href:e,onClick:this.onLinkClick},e)))}else if(this.props.kind===Q.a.Invite){var y;const e=this.props.roomId,o=null===(y=f.a.get())||void 0===y?void 0:y.getRoom(e),r=null==o?void 0:o.isSpaceRoom();let a;if(t=r?Object(v.a)("Invite to %(spaceName)s",{spaceName:(null==o?void 0:o.name)||Object(v.a)("Unnamed Space")}):Object(v.a)("Invite to %(roomName)s",{roomName:(null==o?void 0:o.name)||Object(v.a)("Unnamed Room")}),a=r?u?Object(v.c)("Invite someone using their name, email address, username (like <userId/>) or <a>share this space</a>."):Object(v.c)("Invite someone using their name, username (like <userId/>) or <a>share this space</a>."):u?Object(v.c)("Invite someone using their name, email address, username (like <userId/>) or <a>share this room</a>."):Object(v.c)("Invite someone using their name, username (like <userId/>) or <a>share this room</a>."),n=Object(v.a)(a,{},{userId:()=>c.a.createElement("a",{href:Object(b.i)(g),rel:"noreferrer noopener",target:"_blank"},g),a:t=>c.a.createElement("a",{href:Object(b.h)(e),rel:"noreferrer noopener",target:"_blank"},t)}),i=Object(v.a)("Invite"),s=this.inviteUsers,m.isRoomEncrypted(this.props.roomId)){const e=m.getRoom(this.props.roomId).currentState.getStateEvents("m.room.history_visibility",""),t=e&&e.getContent()&&e.getContent().history_visibility;"world_readable"!==t&&"shared"!==t||(l=c.a.createElement("p",{className:"mx_InviteDialog_helpText"},c.a.createElement(p,{height:14,width:14})," "+Object(v.a)("Invited people will be able to read old messages.")))}}else this.props.kind===Q.a.CallTransfer&&(t=Object(v.a)("Transfer"),o=c.a.createElement("div",{className:"mx_InviteDialog_transferConsultConnect"},c.a.createElement("label",null,c.a.createElement("input",{type:"checkbox",checked:this.state.consultFirst,onChange:this.onConsultFirstChange}),Object(v.a)("Consult first")),c.a.createElement(A.a,{kind:"secondary",onClick:this.onCancel,className:"mx_InviteDialog_transferConsultConnect_pushRight"},Object(v.a)("Cancel")),c.a.createElement(A.a,{kind:"primary",onClick:this.transferCall,className:"mx_InviteDialog_transferButton",disabled:!h&&""===this.state.dialPadValue},Object(v.a)("Transfer"))));const S=this.props.kind==Q.a.CallTransfer?null:c.a.createElement(A.a,{kind:"primary",onClick:s,className:"mx_InviteDialog_goButton",disabled:this.state.busy||!h},i);let E=null,w=null;!this.canInviteMore()||this.hasFilterAtLeastOneEmail()&&!this.canInviteThirdParty()?w=c.a.createElement("div",{className:"mx_InviteDialog_oneThreepid"},Object(v.a)("Invites by email can only be sent one at a time")):E=c.a.createElement("div",{className:"mx_InviteDialog_userSections"},this.renderSection("recents"),this.renderSection("suggestions"),r);const _=c.a.createElement(c.a.Fragment,null,c.a.createElement("p",{className:"mx_InviteDialog_helpText"},n),c.a.createElement("div",{className:"mx_InviteDialog_addressBar"},this.renderEditor(),c.a.createElement("div",{className:"mx_InviteDialog_buttonAndSpinner"},S,e)),l,this.renderIdentityServerWarning(),c.a.createElement("div",{className:"error"},this.state.errorText),w,E,a);let C;if(this.props.kind===Q.a.CallTransfer){const e=[];e.push(new F.a(te.UserDirectory,Object(v.c)("User Directory"),"mx_InviteDialog_userDirectoryIcon",_));const t=c.a.createElement(H.a,{onBackspacePress:this.onDeletePress});let n;n=0!==this.state.dialPadValue.length?c.a.createElement(U.a,{ref:this.numberEntryFieldRef,className:"mx_InviteDialog_dialPadField",id:"dialpad_number",value:this.state.dialPadValue,autoFocus:!0,onChange:this.onDialChange,postfixComponent:t}):c.a.createElement(U.a,{ref:this.numberEntryFieldRef,className:"mx_InviteDialog_dialPadField",id:"dialpad_number",value:this.state.dialPadValue,autoFocus:!0,onChange:this.onDialChange});const i=c.a.createElement("div",{className:"mx_InviteDialog_dialPad"},c.a.createElement("form",{onSubmit:this.onDialFormSubmit},n),c.a.createElement(B.a,{hasDial:!1,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress}));e.push(new F.a(te.DialPad,Object(v.c)("Dial pad"),"mx_InviteDialog_dialPadIcon",i)),C=c.a.createElement(c.a.Fragment,null,c.a.createElement(F.c,{tabs:e,initialTabId:this.state.currentTabId,tabLocation:F.b.TOP,onChange:this.onTabChange}),o)}else C=c.a.createElement(c.a.Fragment,null,_,o);return c.a.createElement($.a,{className:d()({mx_InviteDialog_transfer:this.props.kind===Q.a.CallTransfer,mx_InviteDialog_other:this.props.kind!==Q.a.CallTransfer,mx_InviteDialog_hasFooter:!!a}),hasCancel:!0,onFinished:this.props.onFinished,title:t,screenName:this.screenName},c.a.createElement("div",{className:"mx_InviteDialog_content"},C))}}r()(oe,"defaultProps",{kind:Q.a.Dm,initialText:""})},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(122),s=n.n(i),o=n(1),r=n(477),a=n(126);class c{constructor(e){this.tagId=e,s()(this,"_n",0),s()(this,"_previews",!0),s()(this,"_collapsed",!1);const t=localStorage.getItem(this.key);if(t){const e=JSON.parse(t);this._n=e.numTiles,this._previews=e.showPreviews,this._collapsed=e.collapsed}}get isCollapsed(){return this._collapsed}set isCollapsed(e){this._collapsed=e,this.save()}get showPreviews(){return this._previews}set showPreviews(e){this._previews=e,this.save()}get tileHeight(){const e=a.b.getValue("roomListStyle");return e==r.a.Compact?30:e==r.a.Intermediate?44:60}get key(){return`mx_sublist_layout_${this.tagId}_boxed`}get visibleTiles(){return 0===this._n?this.defaultVisibleTiles:Math.max(this._n,this.minVisibleTiles)}set visibleTiles(e){this._n=e,this.save()}get minVisibleTiles(){return 1}get defaultVisibleTiles(){return 50}tilesWithPadding(e,t){return this.pixelsToTiles(this.tilesToPixelsWithPadding(e,t))}tilesToPixelsWithPadding(e,t){return this.tilesToPixels(e)+t}tilesToPixels(e){return e*this.tileHeight}pixelsToTiles(e){return e/this.tileHeight}reset(){localStorage.removeItem(this.key)}save(){localStorage.setItem(this.key,JSON.stringify(this.serialize()))}serialize(){return{numTiles:this.visibleTiles,showPreviews:this.showPreviews,collapsed:this.isCollapsed}}}var l=n(203),d=n(125);class u extends l.a{constructor(){super(d.a),s()(this,"layoutMap",new Map)}static get instance(){return this.internalInstance||(this.internalInstance=new u,this.internalInstance.start()),u.internalInstance}ensureLayoutExists(e){this.layoutMap.has(e)||this.layoutMap.set(e,new c(e))}getLayoutFor(e){return this.layoutMap.has(e)||this.layoutMap.set(e,new c(e)),this.layoutMap.get(e)}async resetLayouts(){o.a.warn("Resetting layouts for room list");for(const e of this.layoutMap.values())e.reset()}async onNotReady(){this.layoutMap.clear()}async onAction(e){}}s()(u,"internalInstance",void 0),window.mxRoomListLayoutStore=u.instance},,function(e,t,n){"use strict";n.d(t,"a",(function(){return v}));var i=n(122),s=n.n(i),o=n(1495),r=n(150),a=n(1),c=n(374);const l=["sub","sup","del","u"],d=["text","softbreak","linebreak","paragraph","document"];function u(e){if(null!=e.literal&&null!=e.literal.match('^<((div|span) data-mx-maths="[^"]*"|/(div|span))>$'))return!0;if(null!=e.literal&&null!=e.literal.match("^<img data-mx-emoticon"))return!0;const t=/^<\/?(.*)>$/.exec(e.literal);if(t&&2==t.length){const e=t[1];return l.indexOf(e)>-1}return!1}function h(e){let t=e;for(;t.parent;)t=t.parent;return t.firstChild!=t.lastChild}function m(e){let t=e,n="";for(;null!==t&&"softbreak"!==t.type&&"linebreak"!==t.type;){const{literal:e,type:i}=t;if("text"===i&&e){let t=0,i=e[t];for(;" "!==i&&null!==i&&t<=e.length&&" "!==i;)i&&(n+=i),t+=1,i=e[t];if(" "===i)break}t=t.next}return n}const p={emph:"_",strong:"__"},g=e=>{let t="";const n=e.walker();let i;for(;i=n.next();){const e=i.node,n=e.literal;i.entering&&"text"===e.type&&n&&(t+=n)}return t};class v{constructor(e){s()(this,"input",void 0),s()(this,"parsed",void 0),this.input=e;const t=new o.Parser;this.parsed=t.parse(this.input),this.parsed=this.repairLinks(this.parsed)}repairLinks(e){const t=e.walker();let n=null,i="",s=!1,r=null,l=!1;for(;n=t.next();){const{node:e}=n;if("paragraph"===e.type&&(s=!!n.entering),s){if("softbreak"===e.type||"linebreak"===e.type||"text"===e.type&&" "===e.literal){i="";continue}if("text"===e.type){const[n,...s]=e.literal.split(/( )/);e.literal=n,i+=n,s.reverse().forEach((n=>{if(n){const i=new o.Node("text");i.literal=n,e.insertAfter(i),t.resumeAt(i,!0)}}))}if(("emph"===e.type||"strong"===e.type)&&"text"===r.type)if(n.entering){const t=c.d.find(i);for(const{value:s}of t)if(e.firstChild.literal){const t=p[e.type],d=`${t}${g(e)}${t}`,u=s+d+m(e);if(1===c.d.find(u).length){const t=new o.Node("text");t.literal=d,r.insertAfter(t),e.firstChild.literal="",n=e.walker().next(),e.unlink(),r.insertAfter(n.node),l=!0}else a.a.error("Markdown links escaping found too many links for following text: ",i),a.a.error("Markdown links escaping found too many links for modified text: ",u)}}else l&&(e.unlink(),l=!1)}r=e}return e}isPlainText(){const e=this.parsed.walker();let t;for(;t=e.next();){const e=t.node;if(!(d.indexOf(e.type)>-1)){if("html_inline"!=e.type&&"html_block"!=e.type)return!1;if(u(e))return!1}}return!0}toHTML(){let{externalLinks:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=new o.HtmlRenderer({safe:!1,softbreak:"<br />"}),n=t.paragraph;return t.paragraph=function(e,t){var i;("block_quote"===(null===(i=e.parent)||void 0===i?void 0:i.type)||h(e))&&n.call(this,e,t)},t.link=function(t,n){const i=this.attrs(t);n?(i.push(["href",this.esc(t.destination)]),t.title&&i.push(["title",this.esc(t.title)]),e&&(i.push(["target","_blank"]),i.push(["rel","noreferrer noopener"])),this.tag("a",i)):this.tag("/a")},t.html_inline=function(e){u(e)?this.lit(e.literal):this.lit(Object(r.escape)(e.literal))},t.html_block=function(e){t.html_inline(e)},t.render(this.parsed)}toPlaintext(){const e=new o.HtmlRenderer({safe:!1});return e.paragraph=function(e,t){h(e)&&!t&&e.next&&this.lit("\n\n")},e.html_block=function(e){this.lit(e.literal),h(e)&&e.next&&this.lit("\n\n")},e.render(this.parsed)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return K})),n.d(t,"b",(function(){return z}));var i=n(122),s=n.n(i),o=(n(131),n(130)),r=n(120),a=n.n(r),c=n(127),l=n.n(c),d=n(170),u=n(133),h=n(223),m=n(129),p=n(125),g=n(142),v=n(121),f=n(123),b=n(162),y=n(126),S=n(167),E=n(158),w=n(218),_=n(192),C=n(154),O=n(228),I=n(211),R=n(179),k=n(147),x=n(187),T=n(253),j=n(477),P=n(151),D=n(165),N=n(288),M=n(178),A=n(148),L=n(250),U=n(811);function F(e){let{isSelected:t,isMinimized:n,notificationState:i,displayName:s,onClick:o,avatar:r}=e;const[,{onMouseOver:c,onMouseLeave:u}]=Object(U.a)((()=>!1)),h=l()({mx_ExtraTile:!0,mx_RoomTile:!0,mx_RoomTile_selected:t,mx_RoomTile_minimized:n});let m=null;i&&(m=a.a.createElement(L.a,{notification:i,forceCount:!1}));let p=s;"string"!=typeof p&&(p=""),p=p.replace(":",":​");const g=l()({mx_RoomTile_title:!0,mx_RoomTile_titleHasUnreadEvents:null==i?void 0:i.isUnread});let v=a.a.createElement("div",{className:"mx_RoomTile_titleContainer"},a.a.createElement("div",{title:p,className:g,tabIndex:-1,dir:"auto"},p));n&&(v=null);let f=d.a;return n&&(f=d.b),a.a.createElement(f,{className:h,onMouseEnter:c,onMouseLeave:u,onClick:o,role:"treeitem",title:n?p:void 0},a.a.createElement("div",{className:"mx_RoomTile_avatarContainer"},r),a.a.createElement("div",{className:"mx_RoomTile_details"},a.a.createElement("div",{className:"mx_RoomTile_primaryDetails"},v,a.a.createElement("div",{className:"mx_RoomTile_badgeContainer"},m))))}var B=n(868),V=n(155);const K=[_.a.Invite,_.a.SavedItems,_.a.Favourite,_.a.Unified,_.a.DM,_.a.Untagged,_.a.LowPriority,_.a.ServerNotice,_.a.Suggested,_.a.Archived],$=[_.a.DM,_.a.Untagged],H=[_.a.Unified],W=e=>{let{tabIndex:t,dispatcher:n=p.a}=e;const[i,s,o,r]=Object(P.q)(),c=(Object(g.b)(R.a.instance,I.d,(()=>R.a.instance.activeSpaceRoom)),Object(h.a)(E.a.CreateRooms));Object(h.a)(E.a.InviteUsers);return c?a.a.createElement(a.a.Fragment,null,a.a.createElement(A.a,{tabIndex:t,onClick:e=>{n.dispatch({action:"view_create_chat"}),b.b.trackInteraction("WebRoomListRoomsSublistPlusMenuCreateChatItem",e)},className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":Object(v.a)("Start chat"),title:Object(v.a)("Start chat")})):null},q=e=>{let{tabIndex:t}=e;const[n,i,s,r]=Object(P.q)(),c=Object(g.b)(R.a.instance,I.d,(()=>R.a.instance.activeSpaceRoom)),l=Object(h.a)(E.a.CreateRooms),d=Object(S.a)("feature_video_rooms"),u=Object(S.a)("feature_element_call_video_rooms");let y,w;if(c){const e=c.currentState.maySendStateEvent(o.b.SpaceChild,f.a.get().getUserId());y=a.a.createElement(M.c,{first:!0},a.a.createElement(M.b,{label:Object(v.a)("Explore rooms"),iconClassName:"mx_RoomList_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),r(),p.a.dispatch({action:m.a.ViewRoom,room_id:c.roomId,metricsTrigger:void 0}),b.b.trackInteraction("WebRoomListRoomsSublistPlusMenuExploreRoomsItem",e)}}),l?a.a.createElement(a.a.Fragment,null,a.a.createElement(M.b,{label:Object(v.a)("New room"),iconClassName:"mx_RoomList_iconNewRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),r(),Object(T.g)(c),b.b.trackInteraction("WebRoomListRoomsSublistPlusMenuCreateRoomItem",e)},disabled:!e,tooltip:e?void 0:Object(v.a)("You do not have permissions to create new rooms in this space")}),d&&a.a.createElement(M.b,{label:Object(v.a)("New video room"),iconClassName:"mx_RoomList_iconNewVideoRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),r(),Object(T.g)(c,u?o.j.UnstableCall:o.j.ElementVideo)},disabled:!e,tooltip:e?void 0:Object(v.a)("You do not have permissions to create new rooms in this space")},a.a.createElement(N.a,null)),a.a.createElement(M.b,{label:Object(v.a)("Add existing room"),iconClassName:"mx_RoomList_iconAddExistingRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),r(),Object(T.e)(c)},disabled:!e,tooltip:e?void 0:Object(v.a)("You do not have permissions to add rooms to this space")})):null),w=a.a.createElement(A.a,{tabIndex:t,onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(T.g)(c)},className:"mx_RoomSublist_auxButton mx_RoomSublist_auxGroupButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip",disabled:!e,"aria-label":e?Object(v.a)("Create new room"):Object(v.a)("You do not have permissions to add rooms to this space"),title:e?Object(v.a)("Create new room"):Object(v.a)("You do not have permissions to add rooms to this space")})}else y=a.a.createElement(M.c,{first:!0},l&&a.a.createElement(a.a.Fragment,null,a.a.createElement(M.b,{label:Object(v.a)("Explore public rooms"),iconClassName:"mx_RoomList_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),r(),b.b.trackInteraction("WebRoomListRoomsSublistPlusMenuExploreRoomsItem",e),p.a.fire(m.a.ViewRoomDirectory)}}),d&&a.a.createElement(M.b,{label:Object(v.a)("New video room"),iconClassName:"mx_RoomList_iconNewVideoRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),r(),p.a.dispatch({action:"view_create_room",type:u?o.j.UnstableCall:o.j.ElementVideo})}},a.a.createElement(N.a,null))),a.a.createElement(M.b,{label:Object(v.a)("Explore public rooms"),iconClassName:"mx_RoomList_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),r(),b.b.trackInteraction("WebRoomListRoomsSublistPlusMenuExploreRoomsItem",e),p.a.fire(m.a.ViewRoomDirectory)}})),w=a.a.createElement(A.a,{tabIndex:t,onClick:e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"view_create_room"})},className:"mx_RoomSublist_auxButton mx_RoomSublist_auxGroupButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":Object(v.a)("Create new room"),title:Object(v.a)("Create new room")});return w},G={[_.a.Invite]:{sectionLabel:Object(v.c)("Invites"),isInvite:!0,defaultHidden:!1},[_.a.Favourite]:{sectionLabel:Object(v.c)("Favourites"),isInvite:!1,defaultHidden:!1},[_.a.SavedItems]:{sectionLabel:Object(v.c)("Saved Items"),isInvite:!1,defaultHidden:!1},[_.a.Unified]:{sectionLabel:Object(v.c)("Normal priority"),isInvite:!1,defaultHidden:!1,AuxButtonComponent:e=>a.a.createElement(a.a.Fragment,null,W(e),q(e))},[_.a.DM]:{sectionLabel:Object(v.c)("People"),isInvite:!1,defaultHidden:!1,AuxButtonComponent:W},[_.a.Untagged]:{sectionLabel:Object(v.c)("Rooms"),isInvite:!1,defaultHidden:!1,AuxButtonComponent:q},[_.a.LowPriority]:{sectionLabel:Object(v.c)("Low priority"),isInvite:!1,defaultHidden:!1},[_.a.ServerNotice]:{sectionLabel:Object(v.c)("System Alerts"),isInvite:!1,defaultHidden:!1},[_.a.Archived]:{sectionLabel:Object(v.c)("Historical"),isInvite:!1,defaultHidden:!0},[_.a.Suggested]:{sectionLabel:Object(v.c)("Suggested Rooms"),isInvite:!1,defaultHidden:!1}};class z extends a.a.PureComponent{constructor(e){super(e),s()(this,"dispatcherRef",void 0),s()(this,"unifiedRoomListWatcherRef",void 0),s()(this,"treeRef",Object(r.createRef)()),s()(this,"favouriteMessageWatcher",void 0),s()(this,"context",void 0),s()(this,"onUnifiedRoomListChange",(()=>{this.setState({unifiedRoomList:y.b.getValue("unifiedRoomList")})})),s()(this,"onRoomViewStoreUpdate",(()=>{var e;this.setState({currentRoomId:null!==(e=V.b.instance.roomViewStore.getRoomId())&&void 0!==e?e:void 0})})),s()(this,"onAction",(e=>{if(e.action===m.a.ViewRoomDelta){const t=e,n=V.b.instance.roomViewStore.getRoomId(),i=this.getRoomDelta(n,t.delta,t.unread);i&&p.a.dispatch({action:m.a.ViewRoom,room_id:i.roomId,show_room_tile:!0,metricsTrigger:"WebKeyboardShortcut",metricsViaKeyboard:!0})}else e.action===m.a.PstnSupportUpdated&&this.updateLists()})),s()(this,"getRoomDelta",(function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=O.c.instance.orderedLists,s=[];K.forEach((t=>{let o=i[t];n&&(o=o.filter((t=>{const n=w.a.instance.getRoomState(t);return n.room.roomId===e||n.isUnread}))),s.push(...o)}));const o=s.findIndex((t=>t.roomId===e)),[r]=s.slice((o+t)%s.length);return r})),s()(this,"updateSuggestedRooms",(e=>{this.setState({suggestedRooms:e})})),s()(this,"updateLists",(()=>{const e=O.c.instance.orderedLists,t=Object.keys(this.state.sublists),n=Object.keys(e);let i=Object(k.d)(t,n);if(!i)for(const t of n){const n=this.state.sublists[t],s=e[t];if(n.length!==s.length){i=!0;break}}if(i){const t=Object(x.f)(e,n),i=Object(x.e)(t,((e,t)=>Object(k.b)(t)));this.setState({sublists:i},(()=>{this.props.onResize()}))}})),this.state={sublists:{},suggestedRooms:R.a.instance.suggestedRooms,unifiedRoomList:y.b.getValue("unifiedRoomList"),feature_favourite_messages:y.b.getValue("feature_favourite_messages")},this.unifiedRoomListWatcherRef=y.b.watchSetting("unifiedRoomList",null,this.onUnifiedRoomListChange)}componentDidMount(){var e=this;this.dispatcherRef=p.a.register(this.onAction),V.b.instance.roomViewStore.on(C.b,this.onRoomViewStoreUpdate),R.a.instance.on(I.e,this.updateSuggestedRooms),O.c.instance.on(O.b,this.updateLists),this.favouriteMessageWatcher=y.b.watchSetting("feature_favourite_messages",null,(function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];let[,,,s]=n;e.setState({feature_favourite_messages:s})})),this.updateLists()}componentWillUnmount(){R.a.instance.off(I.e,this.updateSuggestedRooms),O.c.instance.off(O.b,this.updateLists),y.b.unwatchSetting(this.favouriteMessageWatcher),this.dispatcherRef&&p.a.unregister(this.dispatcherRef),y.b.unwatchSetting(this.unifiedRoomListWatcherRef),V.b.instance.roomViewStore.off(C.b,this.onRoomViewStoreUpdate)}renderSuggestedRooms(){return this.state.suggestedRooms.map((e=>{var t;const n=e.name||e.canonical_alias||(null===(t=e.aliases)||void 0===t?void 0:t[0])||Object(v.a)("Empty room"),i=a.a.createElement(D.a,{oobData:{name:n,avatarUrl:e.avatar_url},width:32,height:32,resizeMethod:"crop"});return a.a.createElement(F,{isMinimized:this.props.isMinimized,isSelected:this.state.currentRoomId===e.room_id,displayName:n,avatar:i,onClick:t=>{var i;p.a.dispatch({action:m.a.ViewRoom,room_alias:e.canonical_alias||(null===(i=e.aliases)||void 0===i?void 0:i[0]),room_id:e.room_id,via_servers:e.viaServers,oob_data:{avatarUrl:e.avatar_url,name:n},metricsTrigger:"RoomList",metricsViaKeyboard:"click"!==t.type})},key:`suggestedRoomTile_${e.room_id}`})}))}renderFavoriteMessagesList(){const e=a.a.createElement(D.a,{oobData:{name:"Favourites"},width:32,height:32,resizeMethod:"crop"});return[a.a.createElement(F,{isMinimized:this.props.isMinimized,isSelected:!1,displayName:"Favourite Messages",avatar:e,onClick:()=>"",key:"favMessagesTile_key"})]}renderSublists(){var e;const t=!(null!==(e=this.state.suggestedRooms)&&void 0!==e&&e.length)&&Object.values(O.c.instance.orderedLists).every((e=>!(null!=e&&e.length)));return K.map((e=>{let n;e===_.a.Suggested?n=this.renderSuggestedRooms():this.state.feature_favourite_messages&&e===_.a.SavedItems&&(n=this.renderFavoriteMessagesList());const i=G[e];if(!i)throw new Error(`Tag ${e} does not have aesthetics`);let s=(this.state.unifiedRoomList?H:$).includes(e);(this.props.activeSpace===I.a.Favourites&&e!==_.a.Favourite||this.props.activeSpace===I.a.People&&e!==_.a.DM||this.props.activeSpace===I.a.Orphans&&e===_.a.DM||!Object(I.h)(this.props.activeSpace)&&e===_.a.DM&&!y.b.getValue("Spaces.showPeopleInSpace",this.props.activeSpace))&&(s=!1);let o=!1;return(this.props.activeSpace===I.a.Favourites&&e===_.a.Favourite||this.props.activeSpace===I.a.People&&e===_.a.DM)&&(o=!0),a.a.createElement(B.b,{key:`sublist-${e}`,tagId:e,forRooms:!0,startAsHidden:i.defaultHidden,label:i.sectionLabelRaw?i.sectionLabelRaw:Object(v.a)(i.sectionLabel),AuxButtonComponent:i.AuxButtonComponent,isMinimized:this.props.isMinimized,showSkeleton:t,extraTiles:n,resizeNotifier:this.props.resizeNotifier,alwaysVisible:s,onListCollapse:this.props.onListCollapse,forceExpanded:o})}))}focus(){var e,t;const n=null===(e=this.treeRef.current)||void 0===e?void 0:e.querySelectorAll('[role="treeitem"]');n&&(null===(t=[...n].find((e=>null!==e.offsetParent)))||void 0===t||t.focus())}render(){const e=y.b.getValue("roomListStyle"),t=l()({mx_RoomList:!0,mx_RoomList_Compact:e===j.a.Compact,mx_RoomList_Intermediate:e===j.a.Intermediate,mx_RoomList_Roomy:e===j.a.Roomy}),n=this.renderSublists();return a.a.createElement(d.d,{handleHomeEnd:!0,handleUpDown:!0,onKeyDown:this.props.onKeyDown},(e=>{let{onKeyDownHandler:i}=e;return a.a.createElement("div",{onFocus:this.props.onFocus,onBlur:this.props.onBlur,onKeyDown:i,className:t,role:"tree","aria-label":Object(v.a)("Rooms"),ref:this.treeRef},n)}))}}s()(z,"contextType",u.a)},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i,s=n(122),o=n.n(s),r=n(120),a=n.n(r),c=n(387);function l(){return l=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},l.apply(this,arguments)}function d(e){return r.createElement("svg",l({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 15 18",role:"presentation","aria-hidden":!0},e),i||(i=r.createElement("g",{stroke:"#B8BEC9",fill:"none",fillRule:"evenodd",strokeLinecap:"round",strokeLinejoin:"round"},r.createElement("path",{d:"M8.313 1H2.625C1.728 1 1 1.716 1 2.6v12.8c0 .884.728 1.6 1.625 1.6h9.75c.897 0 1.625-.716 1.625-1.6V6.6L8.312 1z"}),r.createElement("path",{d:"M8.313 1v5.6H14"}))))}var u=n(121),h=n(745),m=n(136),p=n(146);class g extends a.a.Component{constructor(e){super(e),o()(this,"objectUrl",void 0),o()(this,"mimeType",void 0),o()(this,"onCancelClick",(()=>{this.props.onFinished(!1)})),o()(this,"onUploadClick",(()=>{this.props.onFinished(!0)})),o()(this,"onUploadAllClick",(()=>{this.props.onFinished(!0,!0)})),this.mimeType=Object(h.a)(e.file.type);const t=new Blob([e.file],{type:this.mimeType});this.objectUrl=URL.createObjectURL(t)}componentWillUnmount(){this.objectUrl&&URL.revokeObjectURL(this.objectUrl)}render(){let e;e=this.props.totalFiles>1&&void 0!==this.props.currentIndex?Object(u.a)("Upload files (%(current)s of %(total)s)",{current:this.props.currentIndex+1,total:this.props.totalFiles}):Object(u.a)("Upload files");const t=`mx-uploadconfirmdialog-${this.props.file.name}`;let n,i,s;return this.mimeType.startsWith("image/")?n=a.a.createElement("img",{className:"mx_UploadConfirmDialog_imagePreview",src:this.objectUrl,"aria-labelledby":t}):this.mimeType.startsWith("video/")?n=a.a.createElement("video",{className:"mx_UploadConfirmDialog_imagePreview",src:this.objectUrl,playsInline:!0,controls:!1}):i=a.a.createElement(d,{className:"mx_UploadConfirmDialog_fileIcon",height:18,width:18}),this.props.currentIndex+1<this.props.totalFiles&&(s=a.a.createElement("button",{onClick:this.onUploadAllClick},Object(u.a)("Upload all"))),a.a.createElement(m.a,{className:"mx_UploadConfirmDialog",fixedWidth:!1,onFinished:this.onCancelClick,title:e,contentId:"mx_Dialog_content"},a.a.createElement("div",{id:"mx_Dialog_content"},a.a.createElement("div",{className:"mx_UploadConfirmDialog_previewOuter"},a.a.createElement("div",{className:"mx_UploadConfirmDialog_previewInner"},n&&a.a.createElement("div",null,n),a.a.createElement("div",{id:t},i,this.props.file.name," (",Object(c.filesize)(this.props.file.size),")")))),a.a.createElement(p.a,{primaryButton:Object(u.a)("Upload"),hasCancel:!1,onPrimaryButtonClick:this.onUploadClick,focus:!0},s))}}o()(g,"defaultProps",{totalFiles:1})},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(1),s=n(721);var o=n(128),r=n(234),a=n(121),c=n(228),l=n(297),d=n(192),u=n(145);class h{static tagRoom(e,t,n,h,m,p){let g=null;const v=c.c.instance;if(h&&v.getTagSorting(h)===l.b.Manual){const e=[...v.orderedLists[h]];e.sort(((e,t)=>e.tags[h].order-t.tags[h].order));const t=h===n&&m<p?1:0,i=t+p-1,s=t+p,o=i<=0?0:e[i].tags[h].order,r=s>=e.length?1:e[s].tags[h].order;g={order:(o+r)/2}}return f="RoomListActions.tagRoom",b=()=>{const s=[],c=t.roomId;if(void 0===n&&h===d.a.DM||n===d.a.DM&&void 0===h)return r.d(t,h===d.a.DM).catch((e=>{i.a.error("Failed to set DM tag "+e),o.b.createDialog(u.a,{title:Object(a.a)("Failed to set direct message tag"),description:e&&e.message?e.message:Object(a.a)("Operation failed")})}));const l=n!==h;if(n&&n!==d.a.DM&&l){const t=e.deleteRoomTag(c,n).catch((function(e){i.a.error("Failed to remove tag "+n+" from room: "+e),o.b.createDialog(u.a,{title:Object(a.a)("Failed to remove tag %(tagName)s from room",{tagName:n}),description:e&&e.message?e.message:Object(a.a)("Operation failed")})}));s.push(t)}if(h&&h!==d.a.DM&&(l||g)){g=g||{};const t=e.setRoomTag(c,h,g).catch((function(e){throw i.a.error("Failed to add tag "+h+" to room: "+e),o.b.createDialog(u.a,{title:Object(a.a)("Failed to add tag %(tagName)s to room",{tagName:h}),description:e&&e.message?e.message:Object(a.a)("Operation failed")}),e}));s.push(t)}return Promise.all(s)},y=()=>({room:t,oldTag:n,newTag:h,metaData:g}),new s.a((e=>{e({action:f+".pending",request:"function"==typeof y?y():void 0}),b().then((t=>{e({action:f+".success",result:t})})).catch((t=>{e({action:f+".failure",err:t})}))}));var f,b,y}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return d})),n.d(t,"d",(function(){return a})),n.d(t,"c",(function(){return c}));var i=n(120),s=n.n(i);const o=Object(i.lazy)((()=>Promise.all([n.e(6),n.e(10),n.e(11),n.e(42)]).then(n.bind(null,1726)))),r=Object(i.lazy)((()=>Promise.all([n.e(6),n.e(10),n.e(34)]).then(n.bind(null,1727)))),a=async(e,t,i)=>{const{sendMessage:s}=await Promise.all([n.e(6),n.e(35)]).then(n.bind(null,988));return s(e,t,i)},c=async()=>{const{richToPlain:e,plainToRich:t}=await n.e(6).then(n.t.bind(null,680,7));return{richToPlain:e,plainToRich:t}};function l(e){return s.a.createElement(i.Suspense,{fallback:s.a.createElement("div",null)},s.a.createElement(o,e))}function d(e){return s.a.createElement(i.Suspense,{fallback:s.a.createElement("div",null)},s.a.createElement(r,e))}},function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(161),r=n(130),a=n(342),c=n(121),l=n(124),d=n(165),u=n(179),h=n(128),m=n(141),p=n(136),g=n(341),v=n(215),f=n(181),b=n(133);const y=e=>{let{room:t,checked:n,onChange:i}=e;const o=t instanceof m.c;let r;if(o){r=Object(c.a)("%(count)s members",{count:t.getJoinedMemberCount()});const e=u.a.instance.getChildRooms(t.roomId).length;e>0&&(r+=" · "+Object(c.a)("%(count)s rooms",{count:e}))}return s.a.createElement("label",{className:"mx_ManageRestrictedJoinRuleDialog_entry"},s.a.createElement("div",null,s.a.createElement("div",null,o?s.a.createElement(d.a,{room:t,height:20,width:20}):s.a.createElement(d.a,{oobData:t,height:20,width:20}),s.a.createElement("span",{className:"mx_ManageRestrictedJoinRuleDialog_entry_name"},t.name)),r&&s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_entry_description"},r)),s.a.createElement(f.b,{onChange:i?e=>i(e.target.checked):null,checked:n,disabled:!i}))},S=(e,t)=>{const n=t.client;Array.from(u.a.instance.getKnownParents(t.roomId)).map((e=>n.getRoom(e))).forEach((t=>{e.has(t)||(e.add(t),S(e,t))}))};var E=e=>{let{room:t,selected:n=[],onFinished:o}=e;const r=t.client,[a,d]=Object(i.useState)(new Set(n)),[u,h]=Object(i.useState)(""),m=u.toLowerCase().trim(),[f,E]=Object(i.useMemo)((()=>{const e=new Set;return S(e,t),[Array.from(e),n.map((e=>{const t=r.getRoom(e);return t?"join"===t.getMyMembership()&&t.isSpaceRoom()?void 0:t:{roomId:e,name:e}})).filter(Boolean)]}),[r,n,t]),[w,_]=Object(i.useMemo)((()=>[f.filter((e=>e.name.toLowerCase().includes(m))),E.filter((e=>e.name.toLowerCase().includes(m)))]),[f,E,m]),C=(e,t)=>{e?a.add(t.roomId):a.delete(t.roomId),d(new Set(a))};let O;return a.size<1&&(O=s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section_info"},Object(c.a)("You're removing all spaces. Access will default to invite only"))),s.a.createElement(p.a,{title:Object(c.a)("Select spaces"),className:"mx_ManageRestrictedJoinRuleDialog",onFinished:o,fixedWidth:!1},s.a.createElement("p",null,Object(c.a)("Decide which spaces can access this room. If a space is selected, its members can find and join <RoomName/>.",{},{RoomName:()=>s.a.createElement("b",null,t.name)})),s.a.createElement(b.a.Provider,{value:r},s.a.createElement(g.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:Object(c.a)("Search spaces"),onSearch:h,autoFocus:!0}),s.a.createElement(v.a,{className:"mx_ManageRestrictedJoinRuleDialog_content"},w.length>0?s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section"},s.a.createElement("h3",null,t.isSpaceRoom()?Object(c.a)("Spaces you know that contain this space"):Object(c.a)("Spaces you know that contain this room")),w.map((e=>s.a.createElement(y,{key:e.roomId,room:e,checked:a.has(e.roomId),onChange:t=>{C(t,e)}})))):void 0,_.length>0?s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section"},s.a.createElement("h3",null,Object(c.a)("Other spaces or rooms you might not know")),s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_section_info"},s.a.createElement("div",null,Object(c.a)("These are likely ones other room admins are a part of."))),_.map((e=>s.a.createElement(y,{key:e.roomId,room:e,checked:a.has(e.roomId),onChange:t=>{C(t,e)}})))):null,w.length+_.length<1?s.a.createElement("span",{className:"mx_ManageRestrictedJoinRuleDialog_noResults"},Object(c.a)("No results")):void 0),s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_footer"},O,s.a.createElement("div",{className:"mx_ManageRestrictedJoinRuleDialog_footer_buttons"},s.a.createElement(l.a,{kind:"primary_outline",onClick:()=>o()},Object(c.a)("Cancel")),s.a.createElement(l.a,{kind:"primary",onClick:()=>o(Array.from(a))},Object(c.a)("Confirm"))))))},w=n(872),_=n(401),C=n(147),O=n(911),I=n(125),R=n(415),k=n(129),x=n(869);t.a=e=>{var t;let{room:n,promptUpgrade:i,aliasWarning:m,onError:p,beforeChange:g,closeSettingsFn:v}=e;const f=n.client,b=Object(x.b)(n.getVersion(),x.a.RestrictedRooms),y=!b&&i?x.a.RestrictedRooms:void 0,S=!n.currentState.mayClientSendStateEvent(r.b.RoomJoinRules,f),[T,j]=Object(O.a)((()=>{var e;return null===(e=n.currentState.getStateEvents(r.b.RoomJoinRules,""))||void 0===e?void 0:e.getContent()}),(e=>f.sendStateEvent(n.roomId,r.b.RoomJoinRules,e,"")),p),{join_rule:P=o.c.Invite}=T||{},D=P===o.c.Restricted?null===(t=T.allow)||void 0===t?void 0:t.filter((e=>e.type===o.e.RoomMembership)).map((e=>e.room_id)):void 0,N=async()=>{var e;let t=D;null!==(e=t)&&void 0!==e&&e.length||!u.a.instance.activeSpaceRoom||(t=[u.a.instance.activeSpaceRoom.roomId]);const{finished:i}=h.b.createDialog(E,{room:n,selected:t},"mx_ManageRestrictedJoinRuleDialog_wrapper"),[s]=await i;return s},M=[{value:o.c.Invite,label:Object(c.a)("Private (invite only)"),description:Object(c.a)("Only invited people can join."),checked:P===o.c.Invite||P===o.c.Restricted&&!(null!=D&&D.length)},{value:o.c.Public,label:Object(c.a)("Public"),description:s.a.createElement(s.a.Fragment,null,Object(c.a)("Anyone can find and join."),m)}];if(b||y||P===o.c.Restricted){let e,t;if(y&&(e=s.a.createElement("span",{className:"mx_JoinRuleSettings_upgradeRequired"},Object(c.a)("Upgrade required"))),P===o.c.Restricted&&null!=D&&D.length){const e=D.map((e=>f.getRoom(e))).filter((e=>null==e?void 0:e.isSpaceRoom())).slice(0,4);let n;e.length<D.length&&(n=e.length>0?Object(c.a)("& %(count)s more",{count:D.length-e.length}):Object(c.a)("Currently, %(count)s spaces have access",{count:D.length}));const i=e=>{Object(C.d)(D||[],e)&&(e.length?j({join_rule:o.c.Restricted,allow:e.map((e=>({type:o.e.RoomMembership,room_id:e})))}):j({join_rule:o.c.Invite}))},r=async()=>{const e=await N();Array.isArray(e)&&(e.length>0?i(e):A(o.c.Invite))};t=s.a.createElement("div",null,s.a.createElement("span",null,Object(c.a)("Anyone in a space can find and join. <a>Edit which spaces can access here.</a>",{},{a:e=>s.a.createElement(l.a,{disabled:S,onClick:r,kind:"link_inline"},e)})),s.a.createElement("div",{className:"mx_JoinRuleSettings_spacesWithAccess"},s.a.createElement("h4",null,Object(c.a)("Spaces with access")),e.map((e=>s.a.createElement("span",{key:e.roomId},s.a.createElement(d.a,{room:e,height:32,width:32}),e.name))),n&&s.a.createElement("span",null,n)))}else t=u.a.instance.activeSpaceRoom?Object(c.a)("Anyone in <spaceName/> can find and join. You can select other spaces too.",{},{spaceName:()=>s.a.createElement("b",null,u.a.instance.activeSpaceRoom.name)}):Object(c.a)("Anyone in a space can find and join. You can select multiple spaces.");M.splice(1,0,{value:o.c.Restricted,label:s.a.createElement(s.a.Fragment,null,Object(c.a)("Space members"),e),description:t,checked:P===o.c.Restricted&&!(null==D||!D.length)})}const A=async e=>{const t=T.join_rule;let i;if(e===o.c.Restricted){var a;if(t===o.c.Restricted||b){if(i=await N(),!Array.isArray(i))return}else if(y){const e=y;let t;const i=f.getUserId();return Array.from(u.a.instance.getKnownParents(n.roomId)).some((e=>{var t;return!(null!==(t=f.getRoom(e))&&void 0!==t&&t.currentState.maySendStateEvent(r.b.SpaceChild,i))}))&&(t=s.a.createElement("b",null,Object(c.a)("This room is in some spaces you're not an admin of. In those spaces, the old room will still be shown, but people will be prompted to join the new one."))),void h.b.createDialog(w.a,{roomId:n.roomId,targetVersion:e,description:s.a.createElement(s.a.Fragment,null,Object(c.a)("This upgrade will allow members of selected spaces access to this room without an invite."),t),doUpgrade:async(t,i)=>{const s=await Object(_.b)(n,e,t.invite,!0,!0,!0,(e=>{const t=2+e.updateSpacesTotal+e.inviteUsersTotal;e.roomUpgraded?e.roomSynced?e.inviteUsersProgress<e.inviteUsersTotal?i(Object(c.a)("Sending invites... (%(progress)s out of %(count)s)",{progress:e.inviteUsersProgress,count:e.inviteUsersTotal}),2+e.inviteUsersProgress,t):e.updateSpacesProgress<e.updateSpacesTotal&&i(Object(c.a)("Updating spaces... (%(progress)s out of %(count)s)",{progress:e.updateSpacesProgress,count:e.updateSpacesTotal}),2+e.inviteUsersProgress+e.updateSpacesProgress,t):i(Object(c.a)("Loading new room"),1,t):i(Object(c.a)("Upgrading room"),0,t)}));v(),I.a.dispatch({action:k.a.ViewRoom,room_id:s,metricsTrigger:void 0}),I.a.dispatch({action:"open_room_settings",initial_tab_id:R.b})}})}null!==(a=i)&&void 0!==a&&a.length||(e=o.c.Invite)}if(t===e&&!i)return;if(g&&!await g(e))return;const l={join_rule:e};var d;e===o.c.Restricted&&(l.allow=null===(d=i)||void 0===d?void 0:d.map((e=>({type:o.e.RoomMembership,room_id:e}))));j(l)};return s.a.createElement(a.a,{name:"joinRule",value:P,onChange:A,definitions:M,disabled:S,className:"mx_JoinRuleSettings_radioButton"})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var i,s=n(120),o=n.n(s),r=n(127),a=n.n(r),c=n(121);function l(){return l=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},l.apply(this,arguments)}function d(e){return s.createElement("svg",l({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 12 12",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M10.667 1.333H9.333V.667C9.333.3 9.033 0 8.667 0H3.333c-.366 0-.666.3-.666.667v.666H1.333C.6 1.333 0 1.933 0 2.667v.666c0 1.7 1.28 3.087 2.927 3.294A3.34 3.34 0 005.333 8.6v2.067h-2c-.366 0-.666.3-.666.666 0 .367.3.667.666.667h5.334c.366 0 .666-.3.666-.667 0-.366-.3-.666-.666-.666h-2V8.6a3.34 3.34 0 002.406-1.973C10.72 6.42 12 5.033 12 3.333v-.666c0-.734-.6-1.334-1.333-1.334zm-9.334 2v-.666h1.334v2.546a2.007 2.007 0 01-1.334-1.88zm9.334 0c0 .867-.56 1.6-1.334 1.88V2.667h1.334v.666z",fill:"currentColor"})))}var u=n(237);const h=e=>{let{isWinner:t,answer:n,voteCount:i,displayVoteCount:s}=e;const r=s?Object(c.a)("%(count)s votes",{count:i}):"";return o.a.createElement("div",{className:"mx_PollOption_content"},o.a.createElement("div",{className:"mx_PollOption_optionText"},n.text),o.a.createElement("div",{className:"mx_PollOption_optionVoteCount"},t&&o.a.createElement(d,{className:"mx_PollOption_winnerIcon"}),r))},m=e=>{let{isChecked:t,children:n,answer:i}=e;return o.a.createElement("div",{className:a()("mx_PollOption_endedOption",{mx_PollOption_endedOptionWinner:t}),"data-value":i.id},n)},p=e=>{let{pollId:t,isChecked:n,children:i,answer:s,onOptionSelected:r}=e;return o.a.createElement(u.a,{className:"mx_PollOption_live-option",name:`poll_answer_select-${t}`,value:s.id,checked:n,onChange:()=>null==r?void 0:r(s.id)},i)},g=e=>{let{pollId:t,answer:n,voteCount:i,totalVoteCount:s,displayVoteCount:r,isEnded:c,isChecked:l,onOptionSelected:d}=e;const u=a()({mx_PollOption:!0,mx_PollOption_checked:l,mx_PollOption_ended:c}),g=c&&l,v=0===s?0:Math.round(100*i/s),f=c?m:p;return o.a.createElement("div",{"data-testid":`pollOption-${n.id}`,className:u,onClick:()=>null==d?void 0:d(n.id)},o.a.createElement(f,{pollId:t,answer:n,isChecked:l,onOptionSelected:d},o.a.createElement(h,{isWinner:g,answer:n,voteCount:i,displayVoteCount:r})),o.a.createElement("div",{className:"mx_PollOption_popularityBackground"},o.a.createElement("div",{className:"mx_PollOption_popularityAmount",style:{width:`${v}%`}})))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(122),s=n.n(i);function o(e,t){const n=Math.min(e.length,t.length);for(let i=0;i<n;++i)if(e[i]!==t[i])return i;return n}function r(e,t,n){const i=n-(t.length-e.length);return function(e,t){const n=Math.min(e.length,t.length),i=e.slice(0,n)===t.slice(0,n);if(i&&e.length>t.length)return{removed:e.slice(n),at:n};if(i&&e.length<t.length)return{added:t.slice(n),at:n};{const n=o(e,t);return{removed:e.slice(n),added:t.slice(n),at:n}}}(e.substring(0,i),t.substring(0,n))}var a=n(821),c=n(600);class l{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.updateCallback=n,s()(this,"_parts",void 0),s()(this,"_partCreator",void 0),s()(this,"activePartIdx",null),s()(this,"_autoComplete",null),s()(this,"autoCompletePartIdx",null),s()(this,"autoCompletePartCount",0),s()(this,"transformCallback",null),s()(this,"onAutoComplete",(e=>{var t;let n,{replaceParts:i,close:s}=e;if(i){this._parts.splice(this.autoCompletePartIdx,this.autoCompletePartCount,...i),this.autoCompletePartCount=i.length;const e=i[i.length-1],t=this.autoCompletePartIdx+i.length-1;n=new a.a(t,e.text.length)}s&&(this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0),null===(t=this.updateCallback)||void 0===t||t.call(this,n)})),this._parts=e,this._partCreator=t,this.transformCallback=null}setTransformCallback(e){this.transformCallback=e}setUpdateCallback(e){this.updateCallback=e}get partCreator(){return this._partCreator}get isEmpty(){return 0===this._parts.reduce(((e,t)=>e+t.text.length),0)}clone(){const e=this.parts.map((e=>this.partCreator.deserializePart(e.serialize())));return new l(e,this._partCreator,this.updateCallback)}insertPart(e,t){this._parts.splice(e,0,t),this.activePartIdx>=e&&++this.activePartIdx,this.autoCompletePartIdx>=e&&++this.autoCompletePartIdx}removePart(e){this._parts.splice(e,1),e===this.activePartIdx?this.activePartIdx=null:this.activePartIdx>e&&--this.activePartIdx,e===this.autoCompletePartIdx?this.autoCompletePartIdx=null:this.autoCompletePartIdx>e&&--this.autoCompletePartIdx}replacePart(e,t){this._parts.splice(e,1,t)}get parts(){return this._parts}get autoComplete(){return this.activePartIdx===this.autoCompletePartIdx?this._autoComplete:null}getPositionAtEnd(){if(this._parts.length){const e=this._parts.length-1,t=this._parts[e];return new a.a(e,t.text.length)}return new a.a(-1,0)}serializeParts(){return this._parts.map((e=>e.serialize()))}diff(e,t,n){const i=this.parts.reduce(((e,t)=>e+t.text),"");return"deleteByDrag"===t?function(e,t){if(e===t)return{};const n=o(e,t),i=e.length-t.length;return{at:n,removed:e.slice(n,n+i)}}(i,e):r(i,e,n.offset)}reset(e,t,n){this._parts=e.map((e=>this._partCreator.deserializePart(e))),t||(t=this.getPositionAtEnd()),this._autoComplete&&(this._autoComplete=null,this.autoCompletePartIdx=null),this.updateCallback(t,n)}insert(e,t){const n=this.splitAt(t);let i=0;for(let t=0;t<e.length;++t){const s=e[t];i+=s.text.length,this.insertPart(n+t,s)}return i}update(e,t,n){var i;const s=this.diff(e,t,n),o=this.positionForOffset(s.at,n.atNodeEnd);let r=0;s.removed&&(r=this.removeText(o,s.removed.length));let a=0;s.added&&(a=this.addText(o,s.added,t)),this.mergeAdjacentParts();const c=s.at-r+a;let l=this.positionForOffset(c,!0);const d="insertFromPaste"!==t&&"insertFromDrop"!==t,u=this.setActivePart(l,d);if(this.transformCallback){const e=this.getTransformAddedLen(l,t,s);l=this.positionForOffset(c+e,!0)}return null===(i=this.updateCallback)||void 0===i||i.call(this,l,t,s),u}getTransformAddedLen(e,t,n){var i;const s=null===(i=this.transformCallback)||void 0===i?void 0:i.call(this,e,t,n);return Number.isFinite(s)?s:0}setActivePart(e,t){const{index:n}=e,i=this._parts[n];if(i){if(n!==this.activePartIdx&&(this.activePartIdx=n,t&&this.activePartIdx!==this.autoCompletePartIdx)){const e=i.createAutoComplete(this.onAutoComplete);e&&(this._autoComplete=e,this.autoCompletePartIdx=n,this.autoCompletePartCount=1)}if(this.autoComplete)return this.autoComplete.onPartUpdate(i,e)}else this.activePartIdx=null,this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0;return Promise.resolve()}mergeAdjacentParts(){let e;for(let i=0;i<this._parts.length;++i){var t,n;let s=this._parts[i];const o=!s.text.length,r=!o&&e&&(null===(t=(n=e).merge)||void 0===t?void 0:t.call(n,s));(o||r)&&(s=e,this.removePart(i),--i),e=s}}removeText(e,t){let{index:n,offset:i}=e,s=0;for(;t>0;){let e=this._parts[n];const o=Math.min(t,e.text.length-i);if(o)if(e.canEdit){const t=e.remove(i,o);"string"==typeof t&&this.replacePart(n,this._partCreator.createDefaultPart(t)),e=this._parts[n],e.text.length?n+=1:this.removePart(n)}else s+=i,this.removePart(n);else n+=1;t-=o,i=0}return s}splitAt(e){if(-1===e.index)return 0;if(0===e.offset)return e.index;const t=this._parts[e.index];if(e.offset>=t.text.length)return e.index+1;const n=t.split(e.offset);return this.insertPart(e.index+1,n),e.index+1}addText(e,t,n){let{index:i}=e;const{offset:s}=e;let o=t.length;const r=this._parts[i];if(r)if(r.canEdit)if(r.validateAndInsert(s,t,n))t=null;else{const e=r.split(s);i+=1,this.insertPart(i,e)}else 0!==s&&(o+=r.text.length-s,i+=1);else i<0&&(i=0);let a=t;for(;a;){const e=this._partCreator.createPartForInput(a,i,n),t=a;if(a=e.appendUntilRejected(a,n),a===t){console.error(`Failed to update model for input (str ${a}) (type ${n})`);break}this.insertPart(i,e),i+=1}return o}positionForOffset(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=0;const i=this._parts.findIndex((i=>{const s=i.text.length;return!!(t&&n+s>=e||!t&&n+s>e)||(n+=s,!1)}));return-1===i?this.getPositionAtEnd():new a.a(i,e-n)}startRange(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;return new c.a(this,e,t)}replaceRange(e,t,n){const i=t.asOffset(this),s=this.splitAt(e);t=i.asPosition(this);for(let e=this.splitAt(t)-1;e>=s;--e)this.removePart(e);let o=s;for(const e of n)this.insertPart(o,e),o+=1;this.mergeAdjacentParts()}transform(e){var t;const n=e();let i=null;return i=n instanceof c.a?Promise.resolve():this.setActivePart(n,!0),null===(t=this.updateCallback)||void 0===t||t.call(this,n),i}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return v})),n.d(t,"b",(function(){return f}));var i=n(120),s=n.n(i),o=n(893),r=n(894),a=n(895),c=n(634),l=n(122),d=n.n(l),u=n(147),h=n(897),m=n(255),p=n(293);class g extends s.a.PureComponent{constructor(e){super(e),d()(this,"onWaveformUpdate",(e=>{this.setState({heights:this.toHeights(e)})})),d()(this,"onTimeUpdate",(e=>{const t=Number(Object(p.c)(e[0],0,e[1]).toFixed(3));this.setState({progress:t})})),this.state={heights:this.toHeights(this.props.playback.waveform),progress:0},this.props.playback.waveformData.onUpdate(this.onWaveformUpdate),this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}toHeights(e){const t=Object(u.h)(0,m.b);return Object(u.j)(e,m.b,t)}render(){return s.a.createElement(h.a,{relHeights:this.state.heights,progress:this.state.progress})}}let v;!function(e){e[e.Composer=0]="Composer",e[e.Timeline=1]="Timeline"}(v||(v={}));class f extends a.a{renderComposerLook(){return s.a.createElement(s.a.Fragment,null,s.a.createElement(r.a,{playback:this.props.playback}),s.a.createElement(g,{playback:this.props.playback}))}renderTimelineLook(){return s.a.createElement(s.a.Fragment,null,s.a.createElement("div",{className:"mx_RecordingPlayback_timelineLayoutMiddle"},s.a.createElement(g,{playback:this.props.playback}),s.a.createElement(c.a,{playback:this.props.playback,tabIndex:0,disabled:this.state.playbackPhase===m.d.Decoding,ref:this.seekRef})),s.a.createElement(r.a,{playback:this.props.playback}))}renderComponent(){let e;switch(this.props.layout){case v.Composer:e=this.renderComposerLook();break;case v.Timeline:default:e=this.renderTimelineLook()}return s.a.createElement("div",{className:"mx_MediaBody mx_VoiceMessagePrimaryContainer",onKeyDown:this.onKeyDown},s.a.createElement(o.a,{playback:this.props.playback,playbackPhase:this.state.playbackPhase,ref:this.playPauseRef}),e)}}},,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return d}));var i=n(13),s=n.n(i),o=n(16),r=n(421),a=n(363),c=n(519),l=n(422);class d{constructor(e,t){var n;this.eventEmitter=e,this.opts=t,s()(this,"abortController",new AbortController),o.f(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=null===(n=t.useAuthorizationHeader)||void 0===n||n}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(t,n){return this.opts.fetchFn?this.opts.fetchFn(t,n):e.fetch(t,n)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,n,i,s){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");let o,a;e===r.a.Get?o=n:a=n;const c=this.getUrl(t,o,i,this.opts.idBaseUrl),l={json:!0,headers:{}};return s&&(l.headers.Authorization=`Bearer ${s}`),this.requestOtherUrl(e,c,a,l)}authedRequest(e,t,n,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};n||(n={}),this.opts.accessToken&&(this.opts.useAuthorizationHeader?(s.headers||(s.headers={}),s.headers.Authorization||(s.headers.Authorization="Bearer "+this.opts.accessToken),n.access_token&&delete n.access_token):n.access_token||(n.access_token=this.opts.accessToken));const o=this.request(e,t,n,i,s);return o.catch((e=>{"M_UNKNOWN_TOKEN"!=e.errcode||null!=s&&s.inhibitLogoutEmit?"M_CONSENT_NOT_GIVEN"==e.errcode&&this.eventEmitter.emit(c.a.NoConsent,e.message,e.data.consent_uri):this.eventEmitter.emit(c.a.SessionLoggedOut,e)})),o}request(e,t,n,i,s){const o=this.getUrl(t,n,null==s?void 0:s.prefix,null==s?void 0:s.baseUrl);return this.requestOtherUrl(e,o,i,s)}async requestOtherUrl(e,t,n){var i,s,o,r;let c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const d=Object.assign({},c.headers||{}),u=null===(i=c.json)||void 0===i||i,h=u&&(null==n||null===(s=n.constructor)||void 0===s?void 0:s.name)===Object.name;u&&(h&&!d["Content-Type"]&&(d["Content-Type"]="application/json"),d.Accept||(d.Accept="application/json"));const m=null!==(o=c.localTimeoutMs)&&void 0!==o?o:this.opts.localTimeoutMs,p=null!==(r=c.keepAlive)&&void 0!==r&&r,g=[this.abortController.signal];let v;void 0!==m&&g.push(Object(l.d)(m)),c.abortSignal&&g.push(c.abortSignal),v=h?JSON.stringify(n):n;const{signal:f,cleanup:b}=Object(l.a)(g);let y;try{y=await this.fetch(t,{signal:f,method:e,body:v,headers:d,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:p})}catch(e){if("AbortError"===e.name)throw e;throw new a.a("fetch failed",e)}finally{b()}if(!y.ok)throw Object(l.b)(y,await y.text());return this.opts.onlyData?u?y.json():y.text():y}getUrl(e,t,n,i){const s=new URL((null!=i?i:this.opts.baseUrl)+(null!=n?n:this.opts.prefix)+e);return t&&o.n(t,s.searchParams),s}}}).call(this,n(14))},,function(e,t,n){"use strict";(function(e){n.d(t,"b",(function(){return l})),n.d(t,"a",(function(){return d}));var i=n(1);const s=1e3;let o,r=0;const a=[],c=function(){};function l(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),s=2;s<n;s++)i[s-2]=arguments[s];(t=t||0)<0&&(t=0);const o=Date.now()+t,l=r++;c("setTimeout: scheduling cb",l,"at",o,"(delay",t,")");const d={runAt:o,func:e,params:i,key:l},h=function(e,t){let n=0,i=e.length;for(;n<i;){const s=n+i>>1;t(e[s])>0?i=s:n=s+1}return n}(a,(function(e){return e.runAt-o}));return a.splice(h,0,d),u(),l}function d(e){if(0===a.length)return;let t;for(t=0;t<a.length;t++){if(a[t].key==e){a.splice(t,1);break}}0===t&&u()}function u(){o&&e.clearTimeout(o);const t=a[0];if(!t)return void c("scheduleRealCallback: no more callbacks, not rescheduling");const n=Date.now(),i=Math.min(t.runAt-n,s);c("scheduleRealCallback: now:",n,"delay:",i),o=e.setTimeout(h,i)}function h(){const t=Date.now();c("runCallbacks: now:",t);const n=[];for(;;){const e=a[0];if(!e||e.runAt>t)break;const i=a.shift();c("runCallbacks: popping",i.key),n.push(i)}u();for(const t of n)try{t.func.apply(e,t.params)}catch(e){i.a.error("Uncaught exception in callback function",e)}}}).call(this,n(14))},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(13),s=n.n(i);class o{constructor(){s()(this,"accountData",new Map),s()(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}storeEvents(e,t,n,i){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}async getPendingEvents(e){return[]}setPendingEvents(e,t){return Promise.resolve()}async saveToDeviceBatches(e){return Promise.resolve()}getOldestToDeviceBatch(){return Promise.resolve(null)}async removeToDeviceBatch(e){return Promise.resolve()}}},,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(13),s=n.n(i),o=n(227);class r{constructor(e){this.cryptoStore=e,s()(this,"roomEncryption",{})}async init(){await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ROOMS],(e=>{this.cryptoStore.getEndToEndRooms(e,(e=>{this.roomEncryption=e}))}))}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this.roomEncryption[e]=t,await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ROOMS],(n=>{this.cryptoStore.storeEndToEndRoom(e,t,n)}))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return l})),n.d(t,"c",(function(){return d}));var i=n(13),s=n.n(i),o=n(1),r=n(16);class a{constructor(e){this.db=e,s()(this,"nextTxnId",0),e.onversionchange=()=>{o.a.log(`versionchange for indexeddb ${this.db.name}: closing`),e.close()}}async startup(){return this}async deleteAllData(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise(((n,i)=>{const s=this.db.transaction("outgoingRoomKeyRequests","readwrite");s.onerror=i,this._getOutgoingRoomKeyRequest(s,t,(i=>{if(i)return o.a.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void n(i);o.a.log(`enqueueing key request for ${t.room_id} / `+t.session_id),s.oncomplete=()=>{n(e)};s.objectStore("outgoingRoomKeyRequests").add(e)}))}))}getOutgoingRoomKeyRequest(e){return new Promise(((t,n)=>{const i=this.db.transaction("outgoingRoomKeyRequests","readonly");i.onerror=n,this._getOutgoingRoomKeyRequest(i,e,(e=>{t(e)}))}))}_getOutgoingRoomKeyRequest(e,t,n){const i=e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]);i.onsuccess=()=>{const e=i.result;if(!e)return void n(null);const s=e.value;r.j(s.requestBody,t)?n(s):e.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,n=0;const i=this.db.transaction("outgoingRoomKeyRequests","readonly"),s=i.objectStore("outgoingRoomKeyRequests"),o=e[n];return s.index("state").openCursor(o).onsuccess=function i(){const s=this.result;if(s)return void(t=s.value);if(n++,n>=e.length)return;const o=e[n];this.source.openCursor(o).onsuccess=i},h(i).then((()=>t))}getAllOutgoingRoomKeyRequestsByState(e){return new Promise(((t,n)=>{const i=this.db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)}))}getOutgoingRoomKeyRequestsByTarget(e,t,n){let i=0;const s=[];const o=this.db.transaction("outgoingRoomKeyRequests","readonly"),r=o.objectStore("outgoingRoomKeyRequests"),a=n[i];return r.index("state").openCursor(a).onsuccess=function o(){const r=this.result;if(r){const n=r.value;n.recipients.some((n=>n.userId===e&&n.deviceId===t))&&s.push(n),r.continue()}else{if(i++,i>=n.length)return;const e=n[i];this.source.openCursor(e).onsuccess=o}},h(o).then((()=>s))}updateOutgoingRoomKeyRequest(e,t,n){let i=null;const s=this.db.transaction("outgoingRoomKeyRequests","readwrite");return s.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(){const e=this.result;if(!e)return;const s=e.value;s.state==t?(Object.assign(s,n),e.update(s),i=s):o.a.warn(`Cannot update room key request from ${t} as it was already updated to ${s.state}`)},h(s).then((()=>i))}deleteOutgoingRoomKeyRequest(e,t){const n=this.db.transaction("outgoingRoomKeyRequests","readwrite"),i=n.objectStore("outgoingRoomKeyRequests").openCursor(e);return i.onsuccess=()=>{const e=i.result;if(!e)return;const n=e.value;n.state==t?e.delete():o.a.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`)},h(n)}getAccount(e,t){const n=e.objectStore("account").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(t){u(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const n=e.objectStore("account").get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(t){u(e,t)}}}getSecretStorePrivateKey(e,t,n){const i=e.objectStore("account").get(`ssss_cache:${n}`);i.onsuccess=function(){try{t(i.result||null)}catch(t){u(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,n){e.objectStore("account").put(n,`ssss_cache:${t}`)}countEndToEndSessions(e,t){const n=e.objectStore("sessions").count();n.onsuccess=function(){try{t(n.result)}catch(t){u(e,t)}}}getEndToEndSessions(e,t,n){const i=t.objectStore("sessions").index("deviceKey").openCursor(e),s={};i.onsuccess=function(){const e=i.result;if(e)s[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{n(s)}catch(e){u(t,e)}}}getEndToEndSession(e,t,n,i){const s=n.objectStore("sessions").get([e,t]);s.onsuccess=function(){try{s.result?i({session:s.result.session,lastReceivedMessageTs:s.result.lastReceivedMessageTs}):i(null)}catch(e){u(n,e)}}}getAllEndToEndSessions(e,t){const n=e.objectStore("sessions").openCursor();n.onsuccess=function(){try{const e=n.result;e?(t(e.value),e.continue()):t(null)}catch(t){u(e,t)}}}storeEndToEndSession(e,t,n,i){i.objectStore("sessions").put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,n){const i=this.db.transaction("session_problems","readwrite");i.objectStore("session_problems").put({deviceKey:e,type:t,fixed:n,time:Date.now()}),await h(i)}async getEndToEndSessionProblem(e,t){let n=null;const i=this.db.transaction("session_problems","readwrite"),s=i.objectStore("session_problems").index("deviceKey").getAll(e);return s.onsuccess=()=>{const e=s.result;if(!e.length)return void(n=null);e.sort(((e,t)=>e.time-t.time));const i=e[e.length-1];for(const s of e)if(s.time>t)return void(n=Object.assign({},s,{fixed:i.fixed}));n=i.fixed?null:i},await h(i),n}async filterOutNotifiedErrorDevices(e){const t=this.db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),n=[];return await Promise.all(e.map((e=>new Promise((i=>{const{userId:s,deviceInfo:o}=e,r=t.get([s,o.deviceId]);r.onsuccess=function(){r.result||(t.put({userId:s,deviceId:o.deviceId}),n.push(e)),i()}}))))),n}getEndToEndInboundGroupSession(e,t,n,i){let s=!1,o=!1;const r=n.objectStore("inbound_group_sessions").get([e,t]);r.onsuccess=function(){try{s=r.result?r.result.session:null,!1!==o&&i(s,o)}catch(e){u(n,e)}};const a=n.objectStore("inbound_group_sessions_withheld").get([e,t]);a.onsuccess=function(){try{o=a.result?a.result.session:null,!1!==s&&i(s,o)}catch(e){u(n,e)}}}getAllEndToEndInboundGroupSessions(e,t){const n=e.objectStore("inbound_group_sessions").openCursor();n.onsuccess=function(){const i=n.result;if(i){try{t({senderKey:i.value.senderCurve25519Key,sessionId:i.value.sessionId,sessionData:i.value.session})}catch(t){u(e,t)}i.continue()}else try{t(null)}catch(t){u(e,t)}}}addEndToEndInboundGroupSession(e,t,n,i){const s=i.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:n});s.onerror=n=>{var r;"ConstraintError"===(null===(r=s.error)||void 0===r?void 0:r.name)?(n.stopPropagation(),n.preventDefault(),o.a.log("Ignoring duplicate inbound group session: "+e+" / "+t)):u(i,new Error("Failed to add inbound group session: "+s.error))}}storeEndToEndInboundGroupSession(e,t,n,i){i.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:n})}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){i.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:n})}getEndToEndDeviceData(e,t){const n=e.objectStore("device_data").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(t){u(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,n){n.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const n={},i=e.objectStore("rooms").openCursor();i.onsuccess=function(){const s=i.result;if(s)n[s.key]=s.value,s.continue();else try{t(n)}catch(t){u(e,t)}}}getSessionsNeedingBackup(e){return new Promise(((t,n)=>{const i=[],s=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");s.onerror=n,s.oncomplete=function(){t(i)};const o=s.objectStore("sessions_needing_backup"),r=s.objectStore("inbound_group_sessions"),a=o.openCursor();a.onsuccess=function(){const t=a.result;if(t){const n=r.get(t.key);n.onsuccess=function(){i.push({senderKey:n.result.senderCurve25519Key,sessionId:n.result.sessionId,sessionData:n.result.session})},(!e||i.length<e)&&t.continue()}}}))}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise(((e,n)=>{const i=t.count();i.onerror=n,i.onsuccess=()=>e(i.result)}))}async unmarkSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");await Promise.all(e.map((e=>new Promise(((t,i)=>{const s=n.delete([e.senderKey,e.sessionId]);s.onsuccess=t,s.onerror=i})))))}async markSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");await Promise.all(e.map((e=>new Promise(((t,i)=>{const s=n.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});s.onsuccess=t,s.onerror=i})))))}addSharedHistoryInboundGroupSession(e,t,n,i){i||(i=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));const s=i.objectStore("shared_history_inbound_group_sessions"),o=s.get([e]);o.onsuccess=()=>{const{sessions:i}=o.result||{sessions:[]};i.push([t,n]),s.put({roomId:e,sessions:i})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));const n=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise(((e,t)=>{n.onsuccess=()=>{const{sessions:t}=n.result||{sessions:[]};e(t)},n.onerror=t}))}addParkedSharedHistory(e,t,n){n||(n=this.db.transaction("parked_shared_history","readwrite"));const i=n.objectStore("parked_shared_history"),s=i.get([e]);s.onsuccess=()=>{const{parked:n}=s.result||{parked:[]};n.push(t),i.put({roomId:e,parked:n})}}takeParkedSharedHistory(e,t){t||(t=this.db.transaction("parked_shared_history","readwrite"));const n=t.objectStore("parked_shared_history").openCursor(e);return new Promise(((e,t)=>{n.onsuccess=()=>{const t=n.result;if(!t)return void e([]);const i=t.value;t.delete(),e(i)},n.onerror=t}))}doTxn(e,t,n){arguments.length>3&&void 0!==arguments[3]||o.a;const i=this.db.transaction(t,e),s=h(i),r=n(i);return s.then((()=>r))}}const c=[e=>{!function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e)},e=>{e.createObjectStore("account")},e=>{e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")},e=>{e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("device_data")},e=>{e.createObjectStore("rooms")},e=>{e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},e=>{e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},e=>{e.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],l=c.length;function d(e,t){o.a.log(`Upgrading IndexedDBCryptoStore from version ${t} to ${l}`),c.forEach(((n,i)=>{t<=i&&n(e)}))}function u(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function h(e){return new Promise(((t,n)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&n(e._mx_abortexception),t(null)},e.onerror=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(o.a.log("Error performing indexeddb txn",t),n(e.error))},e.onabort=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(o.a.log("Error performing indexeddb txn",t),n(e.error))}}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var i=n(13),s=n.n(i),o=n(1),r=n(365),a=n(367),c=n(200),l=n(227),d=n(16),u=n(159),h=n(175);let m;!function(e){e[e.NotTracked=0]="NotTracked",e[e.PendingDownload=1]="PendingDownload",e[e.DownloadInProgress=2]="DownloadInProgress",e[e.UpToDate=3]="UpToDate"}(m||(m={}));class p extends u.b{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:250;super(),this.cryptoStore=t,this.keyDownloadChunkSize=i,s()(this,"devices",{}),s()(this,"crossSigningInfo",{}),s()(this,"userByIdentityKey",{}),s()(this,"deviceTrackingStatus",{}),s()(this,"syncToken",null),s()(this,"keyDownloadsInProgressByUser",new Map),s()(this,"dirty",!1),s()(this,"savePromise",null),s()(this,"resolveSavePromise",null),s()(this,"savePromiseTime",null),s()(this,"saveTimer",null),s()(this,"hasFetched",null),s()(this,"serialiser",void 0),this.serialiser=new g(e,n,this)}async load(){await this.cryptoStore.doTxn("readonly",[l.a.STORE_DEVICE_DATA],(e=>{this.cryptoStore.getEndToEndDeviceData(e,(e=>{var t;this.hasFetched=Boolean(e&&e.devices),this.devices=e?e.devices:{},this.crossSigningInfo=e&&e.crossSigningInfo||{},this.deviceTrackingStatus=e?e.trackingStatus:{},this.syncToken=null!==(t=null==e?void 0:e.syncToken)&&void 0!==t?t:null,this.userByIdentityKey={};for(const e of Object.keys(this.devices)){const t=this.devices[e];for(const n of Object.keys(t)){const i=t[n].keys["curve25519:"+n];void 0!==i&&(this.userByIdentityKey[i]=e)}}}))}));for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]==m.DownloadInProgress&&(this.deviceTrackingStatus[e]=m.PendingDownload)}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}async saveIfDirty(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;if(!this.dirty)return Promise.resolve(!1);const t=Date.now()+e;this.savePromiseTime&&t<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let n=this.savePromise;if(null===n&&(n=new Promise((e=>{this.resolveSavePromise=e})),this.savePromise=n),null===this.saveTimer){const n=this.resolveSavePromise;this.savePromiseTime=t,this.saveTimer=setTimeout((()=>{o.a.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[l.a.STORE_DEVICE_DATA],(e=>{var t;this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:null!==(t=this.syncToken)&&void 0!==t?t:void 0},e)})).then((()=>{this.dirty=!1,null==n||n(!0)}),(e=>{o.a.error("Failed to save device tracking data",this.syncToken),o.a.error(e)}))}),e)}return n}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){const n=[],i=[];if(e.forEach((e=>{const s=this.deviceTrackingStatus[e];this.keyDownloadsInProgressByUser.has(e)?(o.a.log(`downloadKeys: already have a download in progress for ${e}: awaiting its result`),i.push(this.keyDownloadsInProgressByUser.get(e))):(t||s!=m.UpToDate)&&n.push(e)})),0!=n.length){o.a.log("downloadKeys: downloading for",n);const e=this.doKeyDownload(n);i.push(e)}return 0===i.length&&o.a.log("downloadKeys: already have all necessary keys"),Promise.all(i).then((()=>this.getDevicesFromStore(e)))}getDevicesFromStore(e){const t=new Map;return e.forEach((e=>{var n;const i=new Map;null===(n=this.getStoredDevicesForUser(e))||void 0===n||n.forEach((function(e){i.set(e.deviceId,e)})),t.set(e,i)})),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){const t=this.devices[e];if(!t)return null;const n=[];for(const e in t)t.hasOwnProperty(e)&&n.push(r.a.fromStorage(t[e],e));return n}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?a.a.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){const n=this.devices[e];if(null!=n&&n[t])return r.a.fromStorage(n[t],t)}getUserByIdentityKey(e,t){return e!==c.OLM_ALGORITHM&&e!==c.MEGOLM_ALGORITHM?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const n=this.getUserByIdentityKey(e,t);if(!n)return null;const i=this.devices[n];if(!i)return null;for(const e in i){if(!i.hasOwnProperty(e))continue;const n=i[e];for(const i in n.keys){if(!n.keys.hasOwnProperty(i))continue;if(0!==i.indexOf("curve25519:"))continue;if(n.keys[i]==t)return r.a.fromStorage(n,e)}}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(o.a.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=m.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(o.a.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=m.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=m.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(o.a.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=m.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this.deviceTrackingStatus)){this.deviceTrackingStatus[t]==m.PendingDownload&&e.push(t)}return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(void 0!==this.devices[e])for(const[t,n]of Object.entries(this.devices[e])){const e=n.keys["curve25519:"+t];delete this.userByIdentityKey[e]}this.devices[e]=t;for(const[n,i]of Object.entries(t)){const t=i.keys["curve25519:"+n];this.userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then((()=>{n(!0)}),(t=>{throw o.a.error("Error downloading keys for "+e+":",t),n(!1),t}));e.forEach((e=>{this.keyDownloadsInProgressByUser.set(e,t);this.deviceTrackingStatus[e]==m.PendingDownload&&(this.deviceTrackingStatus[e]=m.DownloadInProgress)}));const n=n=>{this.emit(h.b.WillUpdateDevices,e,!this.hasFetched),e.forEach((e=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser.get(e)!==t)return void o.a.log("Another update in the queue for",e,"- not marking up-to-date");this.keyDownloadsInProgressByUser.delete(e);this.deviceTrackingStatus[e]==m.DownloadInProgress&&(n?(this.deviceTrackingStatus[e]=m.UpToDate,o.a.log("Device list for",e,"now up to date")):this.deviceTrackingStatus[e]=m.PendingDownload)})),this.saveIfDirty(),this.emit(h.b.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}}class g{constructor(e,t,n){this.baseApis=e,this.olmDevice=t,this.deviceList=n,s()(this,"downloadInProgress",!1),s()(this,"keyDownloadsQueuedByUser",{}),s()(this,"queuedQueryDeferred",void 0),s()(this,"syncToken",void 0)}updateDevicesForUsers(e,t){return e.forEach((e=>{this.keyDownloadsQueuedByUser[e]=!0})),this.queuedQueryDeferred||(this.queuedQueryDeferred=Object(d.m)()),this.syncToken=t,this.downloadInProgress?(o.a.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");const e=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};const t=this.queuedQueryDeferred;this.queuedQueryDeferred=void 0,o.a.log("Starting key download for",e),this.downloadInProgress=!0;const n={};this.syncToken&&(n.token=this.syncToken);const i=[];for(let t=0;t<e.length;t+=this.deviceList.keyDownloadChunkSize){const s=e.slice(t,t+this.deviceList.keyDownloadChunkSize);i.push((()=>this.baseApis.downloadKeysForUsers(s,n)))}return Object(d.g)(i,3).then((async t=>{const n=Object.assign({},...t.map((e=>e.device_keys||{}))),i=Object.assign({},...t.map((e=>e.master_keys||{}))),s=Object.assign({},...t.map((e=>e.self_signing_keys||{}))),r=Object.assign({},...t.map((e=>e.user_signing_keys||{})));for(const t of e){await Object(d.N)(5);try{await this.processQueryResponseForUser(t,n[t],{master:null==i?void 0:i[t],self_signing:null==s?void 0:s[t],user_signing:null==r?void 0:r[t]})}catch(e){o.a.error(`Error processing keys for ${t}:`,e)}}})).then((()=>{o.a.log("Completed key download for "+e),this.downloadInProgress=!1,null==t||t.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()}),(n=>{o.a.warn("Error downloading keys for "+e+":",n),this.downloadInProgress=!1,null==t||t.reject(n)})),t.promise}async processQueryResponseForUser(e,t,n){o.a.log("got device keys for "+e+":",t),o.a.log("got cross-signing keys for "+e+":",n);{const n={},i=this.deviceList.getRawStoredDevicesForUser(e);i&&Object.keys(i).forEach((e=>{const t=r.a.fromStorage(i[e],e);n[e]=t})),await async function(e,t,n,i,s,r){let a=!1;for(const e in n)if(n.hasOwnProperty(e)&&!(e in i)){if(t===s&&e===r){o.a.warn(`Local device ${e} missing from sync, skipping removal`);continue}o.a.log("Device "+t+":"+e+" has been removed"),delete n[e],a=!0}for(const s in i){if(!i.hasOwnProperty(s))continue;const r=i[s];r.user_id===t?r.device_id===s?await v(e,n,r)&&(a=!0):o.a.warn("Mismatched device_id "+r.device_id+" in keys from "+t+":"+s):o.a.warn("Mismatched user_id "+r.user_id+" in keys from "+t+":"+s)}return a}(this.olmDevice,e,n,t||{},this.baseApis.getUserId(),this.baseApis.deviceId);const s={};Object.keys(n).forEach((e=>{s[e]=n[e].toStorage()})),this.deviceList.setRawStoredDevicesForUser(e,s)}if(n&&(n.master||n.self_signing||n.user_signing)){const t=this.deviceList.getStoredCrossSigningForUser(e)||new a.a(e);t.setKeys(n),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this.deviceList.emit(h.b.UserCrossSigningUpdated,e)}}}async function v(e,t,n){if(!n.keys)return!1;const i=n.device_id,s=n.user_id,a="ed25519:"+i,l=n.keys[a];if(!l)return o.a.warn("Device "+s+":"+i+" has no ed25519 key"),!1;const d=n.unsigned||{},u=n.signatures||{};try{await c.verifySignature(e,n,s,i,l)}catch(e){return o.a.warn("Unable to verify signature on device "+s+":"+i+":"+e),!1}let h;if(i in t){if(h=t[i],h.getFingerprint()!=l)return o.a.warn("Ed25519 key for device "+s+":"+i+" has changed"),!1}else t[i]=h=new r.a(i);return h.keys=n.keys||{},h.algorithms=n.algorithms||[],h.unsigned=d,h.signatures=u,!0}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(13),s=n.n(i),o=n(1),r=n(144),a=n(367),c=n(227),l=n(196),d=n(149),u=n(159);class h{constructor(e,t){s()(this,"accountDataClientAdapter",void 0),s()(this,"crossSigningCallbacks",void 0),s()(this,"ssssCryptoCallbacks",void 0),s()(this,"crossSigningKeys",void 0),s()(this,"keySignatures",void 0),s()(this,"keyBackupInfo",void 0),s()(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new p(e),this.crossSigningCallbacks=new g,this.ssssCryptoCallbacks=new v(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,n){this.keySignatures||(this.keySignatures={});const i=this.keySignatures[e]||{};this.keySignatures[e]=i,i[t]=n}async setAccountData(e,t){await this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter.values;return new m(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}async persist(e){if(this.crossSigningKeys){const n=Object(a.d)(e.cryptoStore,e.olmDevice);for(const e of["master","self_signing","user_signing"]){var t;o.a.log(`Cache ${e} cross-signing private key locally`);const i=this.crossSigningCallbacks.privateKeys.get(e);await(null===(t=n.storeCrossSigningKeyCache)||void 0===t?void 0:t.call(n,e,i))}await e.cryptoStore.doTxn("readwrite",[c.a.STORE_ACCOUNT],(t=>{e.cryptoStore.storeCrossSigningKeys(t,this.crossSigningKeys.keys)}))}this.sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey)}}class m{constructor(e,t,n,i){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=n,this.keySignatures=i}async apply(e){const t=e.baseApis;if(this.crossSigningKeys){var n,i;const s={};for(const[e,t]of Object.entries(this.crossSigningKeys.keys))s[e+"_key"]=t;await(null===(n=(i=this.crossSigningKeys).authUpload)||void 0===n?void 0:n.call(i,(e=>t.uploadDeviceSigningKeys(e,s)))),e.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(const[e,n]of this.accountData)await t.setAccountData(e,n);this.keySignatures&&await t.uploadKeySignatures(this.keySignatures),this.keyBackupInfo&&(this.keyBackupInfo.version?await t.http.authedRequest(l.i.Put,"/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:l.a.V3}):await t.http.authedRequest(l.i.Post,"/room_keys/version",void 0,this.keyBackupInfo,{prefix:l.a.V3}))}}class p extends u.b{constructor(e){super(),this.existingValues=e,s()(this,"values",new Map)}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this.values.get(e);if(t)return t;const n=this.existingValues.get(e);return n?n.getContent():null}setAccountData(e,t){const n=this.values.get(e);return this.values.set(e,t),Promise.resolve().then((()=>{const i=new r.b({type:e,content:t});return this.emit(d.b.AccountData,i,n),{}}))}}class g{constructor(){s()(this,"privateKeys",new Map)}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){var n;return Promise.resolve(null!==(n=this.privateKeys.get(e))&&void 0!==n?n:null)}saveCrossSigningKeys(e){for(const[t,n]of Object.entries(e))this.privateKeys.set(t,n)}}class v{constructor(e){this.delegateCryptoCallbacks=e,s()(this,"privateKeys",new Map)}async getSecretStorageKey(e,t){var n;let{keys:i}=e;for(const e of Object.keys(i)){const t=this.privateKeys.get(e);if(t)return[e,t]}if(null!=this&&null!==(n=this.delegateCryptoCallbacks)&&void 0!==n&&n.getSecretStorageKey){const e=await this.delegateCryptoCallbacks.getSecretStorageKey({keys:i},t);if(e){const[t,n]=e;this.privateKeys.set(t,n)}return e}return null}addPrivateKey(e,t,n){var i,s;this.privateKeys.set(e,n),null===(i=this.delegateCryptoCallbacks)||void 0===i||null===(s=i.cacheSecretStorageKey)||void 0===s||s.call(i,e,t,n)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return p}));var i=n(13),s=n.n(i),o=n(366),r=n(1),a=n(200),c=n(225),l=n(327),d=n(149),u=n(16),h=n(130);const m="m.secret_storage.v1.aes-hmac-sha2";class p{constructor(e,t,n){this.accountDataAdapter=e,this.cryptoCallbacks=t,this.baseApis=n,s()(this,"requests",new Map)}async getDefaultKeyId(){const e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise(((t,n)=>{const i=n=>{"m.secret_storage.default_key"===n.getType()&&n.getContent().key===e&&(this.accountDataAdapter.removeListener(d.b.AccountData,i),t())};this.accountDataAdapter.on(d.b.AccountData,i),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch((e=>{this.accountDataAdapter.removeListener(d.b.AccountData,i),n(e)}))}))}async addKey(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;const i={algorithm:e};if(t.name&&(i.name=t.name),e!==m)throw new Error(`Unknown key algorithm ${e}`);if(t.passphrase&&(i.passphrase=t.passphrase),t.key){const{iv:e,mac:n}=await Object(l.a)(t.key);i.iv=e,i.mac=n}if(!n)do{n=Object(c.b)(32)}while(await this.accountDataAdapter.getAccountDataFromServer(`m.secret_storage.key.${n}`));return await this.accountDataAdapter.setAccountData(`m.secret_storage.key.${n}`,i),{keyId:n,keyInfo:i}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return Boolean(await this.getKey(e))}async checkKey(e,t){if(t.algorithm===m){if(t.mac){const{mac:n}=await Object(l.a)(e,t.iv);return t.mac.replace(/=+$/g,"")===n.replace(/=+$/g,"")}return!0}throw new Error("Unknown algorithm")}async store(e,t,n){const i={};if(!n){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");n=[e]}if(0===n.length)throw new Error("Zero keys given to encrypt with!");for(const s of n){const n=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+s);if(!n)throw new Error("Unknown key: "+s);if(n.algorithm===m){const o={[s]:n},[,r]=await this.getSecretStorageKey(o,e);i[s]=await r.encrypt(t)}else r.a.warn("unknown algorithm for secret storage key "+s+": "+n.algorithm)}await this.accountDataAdapter.setAccountData(e,{encrypted:i})}async get(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted)throw new Error("Content is not encrypted!");const n={};for(const e of Object.keys(t.encrypted)){const i=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e),s=t.encrypted[e];i.algorithm===m&&s.iv&&s.ciphertext&&s.mac&&(n[e]=i)}if(0===Object.keys(n).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);const[i,s]=await this.getSecretStorageKey(n,e),o=t.encrypted[i];return s.decrypt(o)}async isStored(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(null==t||!t.encrypted)return null;const n={};for(const e of Object.keys(t.encrypted)){const i=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);if(!i)continue;const s=t.encrypted[e];i.algorithm===m&&s.iv&&s.ciphertext&&s.mac&&(n[e]=i)}return Object.keys(n).length?n:null}request(e,t){const n=this.baseApis.makeTxnId(),i=Object(u.m)();this.requests.set(n,{name:e,devices:t,deferred:i});const s={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:n,[h.k]:Object(o.v4)()},a=new Map;for(const e of t)a.set(e,s);return r.a.info(`Request secret ${e} from ${t}, id ${n}`),this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),a]])),{requestId:n,promise:i.promise,cancel:e=>{const s={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:n},o=new Map;for(const e of t)o.set(e,s);this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),o]])),i.reject(new Error(e||"Cancelled"))}}}async onRequestReceived(e){const t=e.getSender(),n=e.getContent();if(t!==this.baseApis.getUserId()||!(n.name&&n.action&&n.requesting_device_id&&n.request_id))return;const i=n.requesting_device_id;if("request_cancellation"===n.action);else if("request"===n.action){if(i===this.baseApis.deviceId)return;if(r.a.info("received request for secret ("+t+", "+i+", "+n.request_id+")"),!this.cryptoCallbacks.onSecretRequested)return;const e=await this.cryptoCallbacks.onSecretRequested(t,i,n.request_id,n.name,this.baseApis.checkDeviceTrust(t,i));if(e){r.a.info(`Preparing ${n.name} secret for ${i}`);const s={type:"m.secret.send",content:{request_id:n.request_id,secret:e}},c={algorithm:a.OLM_ALGORITHM,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{},[h.k]:Object(o.v4)()};await a.ensureOlmSessionsForDevices(this.baseApis.crypto.olmDevice,this.baseApis,new Map([[t,[this.baseApis.getStoredDevice(t,i)]]])),await a.encryptMessageForDevice(c.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,t,this.baseApis.getStoredDevice(t,i),s);const l=new Map([[t,new Map([[i,c]])]]);r.a.info(`Sending ${n.name} secret for ${i}`),this.baseApis.sendToDevice("m.room.encrypted",l)}else r.a.info(`Request denied for ${n.name} secret for ${i}`)}}onSecretReceived(e){if(e.getSender()!==this.baseApis.getUserId())return;if(!a.isOlmEncrypted(e))return void r.a.error("secret event not properly encrypted");const t=e.getContent();if(this.baseApis.crypto.deviceList.getUserByIdentityKey(a.OLM_ALGORITHM,e.getSenderKey()||"")!==e.getSender())return void r.a.error("sending device does not belong to the user it claims to be from");r.a.log("got secret share for request",t.request_id);const n=this.requests.get(t.request_id);if(n){const i=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(a.OLM_ALGORITHM,e.getSenderKey());if(!i)return void r.a.log("secret share from unknown device with key",e.getSenderKey());if(!n.devices.includes(i.deviceId))return void r.a.log("unsolicited secret share from device",i.deviceId);if(!this.baseApis.crypto.checkDeviceInfoTrust(e.getSender(),i).isVerified())return void r.a.log("secret share from unverified device");r.a.log(`Successfully received secret ${n.name} from ${i.deviceId}`),n.deferred.resolve(t.secret)}}async getSecretStorageKey(e,t){if(!this.cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const n=await this.cryptoCallbacks.getSecretStorageKey({keys:e},t);if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[i,s]=n;if(!e[i])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[i].algorithm===m){return[i,{encrypt:function(e){return Object(l.c)(e,s,t)},decrypt:function(e){return Object(l.b)(e,s,t)}}]}throw new Error("Unknown key type: "+e[i].algorithm)}}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(13),s=n.n(i),o=n(243),r=n(1);const a=n(130).b.RoomMessage,c="m.reference",l="m.relates_to";class d{constructor(e,t,n){this.client=e,this.roomId=t,this.userId=n,s()(this,"requestEventId",void 0)}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){if(d.getEventType(e)!==o.i)return;const n=t.getUserId(),i=e.getSender(),s=e.getContent().to;return i===n?s:s===n?i:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===o.i}canCreateRequest(e){return d.canCreateRequest(e)}static getTransactionId(e){if(d.getEventType(e)===o.i)return e.getId();{const t=e.getRelation();if((null==t?void 0:t.rel_type)===c)return t.event_id}}static validateEvent(e,t){const n=d.getTransactionId(e);if("string"!=typeof n||0===n.length)return!1;const i=d.getEventType(e),s=e.getContent();if(i===o.i){if(!s||"string"!=typeof s.to||!s.to.length)return r.a.log("InRoomChannel: validateEvent: no valid to "+(s&&s.to)),!1;if(!d.getOtherPartyUserId(e,t))return r.a.log(`InRoomChannel: validateEvent: not directed to or sent by me: ${e.getSender()}, ${s&&s.to}`),!1}return o.k.validateEvent(i,e,t)}static getEventType(e){const t=e.getType();if(t===a){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===o.i)return o.i}}return t&&t!==o.i?t:""}async handleEvent(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t.hasEventId(e.getId()))return;const i=d.getEventType(e);if(e.getRoomId()!==this.roomId)return;if(!this.userId){const t=d.getOtherPartyUserId(e,this.client);t&&(this.userId=t)}const s=this.client.getUserId(),o=e.getSender();if(this.userId&&o!==s&&o!==this.userId)return void r.a.log(`InRoomChannel: ignoring verification event from non-participating sender ${o}`);this.requestEventId||(this.requestEventId=d.getTransactionId(e));const a=!!e.getUnsigned().transaction_id,c=e.getSender()===this.client.getUserId();return t.handleEvent(i,e,n,a,c)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t[l]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==o.i&&e!==o.h&&e!==o.j||(t.from_device=this.client.getDeviceId()),e===o.i?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:o.i,to:this.userId,from_device:t.from_device,methods:t.methods}:t[l]={rel_type:c,event_id:this.transactionId},t}send(e,t){const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n=e;e===o.i&&(n=a);const i=await this.client.sendEvent(this.roomId,n,t);e===o.i&&(this.requestEventId=i.event_id)}}class u{constructor(){s()(this,"requestsByRoomId",new Map)}getRequest(e){const t=e.getRoomId(),n=d.getTransactionId(e);return this.getRequestByTxnId(t,n)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){const n=this.requestsByRoomId.get(e);if(n)return n.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),d.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,n){let i=this.requestsByRoomId.get(e);i||(i=new Map,this.requestsByRoomId.set(e,i)),i.set(t,n)}removeRequest(e){const t=e.getRoomId(),n=this.requestsByRoomId.get(t);n&&(n.delete(d.getTransactionId(e)),0===n.size&&this.requestsByRoomId.delete(t))}findRequestInProgress(e){const t=this.requestsByRoomId.get(e);if(t)for(const e of t.values())if(e.pending)return e}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var i=n(13),s=n.n(i),o=n(225),r=n(1),a=n(243),c=n(368),l=n(144);class d{constructor(e,t,n,i,o){this.client=e,this.userId=t,this.devices=n,this.transactionId=i,this.deviceId=o,s()(this,"request",void 0)}isToDevices(e){if(e.length===this.devices.length){for(const t of e)if(!this.devices.includes(t))return!1;return!0}return!1}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===a.i||e===a.j}canCreateRequest(e){return d.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return r.a.warn("Ignoring flagged verification request from "+e.getSender()),!1;const n=e.getContent();if(!n)return r.a.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!n.transaction_id)return r.a.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const i=e.getType();if(i===a.i){if(!Number.isFinite(n.timestamp))return r.a.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&n.from_device==t.getDeviceId())return r.a.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return a.k.validateEvent(i,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=e.getType(),s=e.getContent();if(i===a.i||i===a.h||i===a.j){this.transactionId||(this.transactionId=s.transaction_id);const e=s.from_device;if(!this.deviceId&&this.devices.includes(e)&&(this.deviceId=e),!this.deviceId||this.deviceId!==e){const t=this.completeContent(a.a,Object(c.b)(Object(c.f)()));return this.sendToDevices(a.a,t,[e])}}const o=t.phase===a.e||t.phase===a.c;await t.handleEvent(e.getType(),e,n,!1,!1);const r=t.phase===a.e||t.phase===a.c;if((i===a.j||i===a.h)&&!o&&r&&this.deviceId){const e=this.devices.filter((e=>e!==this.deviceId&&e!==this.client.getDeviceId()));if(e.length){const t=this.completeContent(a.a,{code:"m.accepted",reason:"Verification request accepted by another device"});await this.sendToDevices(a.a,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==a.i&&e!==a.h&&e!==a.j||(t.from_device=this.client.getDeviceId()),e===a.i&&(t.timestamp=Date.now()),t}send(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e!==a.i&&e!==a.j||this.transactionId||(this.transactionId=d.makeTransactionId());const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n;n=e===a.i||e===a.a&&!this.deviceId?await this.sendToDevices(e,t,this.devices):await this.sendToDevices(e,t,[this.deviceId]);const i=new l.b({sender:this.client.getUserId(),content:t,type:e});return await this.request.handleEvent(e,i,!0,!0,!0),n}async sendToDevices(e,t,n){if(n.length){const i=new Map;for(const e of n)i.set(e,t);await this.client.sendToDevice(e,new Map([[this.userId,i]]))}}static makeTransactionId(){return Object(o.b)(32)}}class u{constructor(){s()(this,"requestsByUserId",new Map)}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),d.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const n=this.requestsByUserId.get(e);if(n)return n.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),d.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,n){let i=this.requestsByUserId.get(e);i||(i=new Map,this.requestsByUserId.set(e,i)),i.set(t,n)}removeRequest(e){const t=e.getSender(),n=this.requestsByUserId.get(t);n&&(n.delete(d.getTransactionId(e)),0===n.size&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){const n=this.requestsByUserId.get(e);if(n)for(const e of n.values())if(e.pending&&e.channel.isToDevices(t))return e}getRequestsInProgress(e){const t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter((e=>e.pending)):[]}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(13),s=n.n(i),o=n(430);class r extends o.b{constructor(){super(...arguments),s()(this,"doVerification",(async()=>{throw new Error("Verification is not possible with this method")}))}static factory(e,t,n,i,s,o){return new r(e,t,n,i,s,o)}static get NAME(){return"org.matrix.illegal_method"}}},function(e,t,n){"use strict";let i;n.d(t,"a",(function(){return i})),function(e){e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(13),s=n.n(i),o=n(144),r=n(130);function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){let n=Boolean(t.preventReEmit);const i=!1!==t.decrypt;return function s(a){t.toDevice&&delete a.room_id;const l=e.getRoom(a.room_id);let d;l&&void 0===a.state_key&&(d=l.findEventById(a.event_id)),!d||d.status?d=new o.b(a):(d.setUnsigned(c(c({},d.getUnsigned()),a.unsigned)),n=!0);const u=d.getServerAggregatedRelation(r.h.Replace);if(null!=u&&u.content){const e=s(u);d.makeReplaced(e)}const h=null==l?void 0:l.findThreadForEvent(d);return h&&d.setThread(h),d.isEncrypted()&&(n||e.reEmitter.reEmit(d,[o.c.Decrypted]),i&&e.decryptEventIfNeeded(d)),n||(e.reEmitter.reEmit(d,[o.c.Replaced,o.c.VisibilityChange]),null==l||l.reEmitter.reEmit(d,[o.c.BeforeRedaction])),d}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(13),s=n.n(i),o=n(159),r=n(226),a=n(1);let c;!function(e){e.LocalStreamsChanged="local_streams_changed"}(c||(c={}));class l extends o.b{constructor(e){super(),this.client=e,s()(this,"audioInput",void 0),s()(this,"audioSettings",void 0),s()(this,"videoInput",void 0),s()(this,"localUserMediaStream",void 0),s()(this,"userMediaStreams",[]),s()(this,"screensharingStreams",[]),s()(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}async setAudioInput(e){a.a.info(`MediaHandler setAudioInput() running (deviceId=${e})`),this.audioInput!==e&&(this.audioInput=e,await this.updateLocalUsermediaStreams())}async setAudioSettings(e){a.a.info(`MediaHandler setAudioSettings() running (opts=${JSON.stringify(e)})`),this.audioSettings=Object.assign({},e),await this.updateLocalUsermediaStreams()}async setVideoInput(e){a.a.info(`MediaHandler setVideoInput() running (deviceId=${e})`),this.videoInput!==e&&(this.videoInput=e,await this.updateLocalUsermediaStreams())}async setMediaInputs(e,t){a.a.log(`MediaHandler setMediaInputs() running (audioInput: ${e} videoInput: ${t})`),this.audioInput=e,this.videoInput=t,await this.updateLocalUsermediaStreams()}async updateLocalUsermediaStreams(){if(0===this.userMediaStreams.length)return;const e=new Map;for(const t of this.client.callEventHandler.calls.values())e.set(t.callId,{audio:t.hasLocalUserMediaAudioTrack,video:t.hasLocalUserMediaVideoTrack});for(const e of this.userMediaStreams){a.a.log(`MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=${e.id})`);for(const t of e.getTracks())t.stop()}this.userMediaStreams=[],this.localUserMediaStream=void 0;for(const t of this.client.callEventHandler.calls.values()){if(t.callHasEnded()||!e.has(t.callId))continue;const{audio:n,video:i}=e.get(t.callId);a.a.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=${t.callId})`);const s=await this.getUserMediaStream(n,i);t.callHasEnded()||await t.updateLocalUsermediaStream(s)}for(const e of this.client.groupCallEventHandler.groupCalls.values()){if(!e.localCallFeed)continue;a.a.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=${e.groupCallId})`);const t=await this.getUserMediaStream(!0,e.type===r.f.Video);e.state!==r.e.Ended&&await e.updateLocalUsermediaStream(t)}this.emit(c.LocalStreamsChanged)}async hasAudioDevice(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind)).length>0}catch(e){return a.a.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}}async hasVideoDevice(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)).length>0}catch(e){return a.a.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}}async getUserMediaStream(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this.getMediaStreamPromise?this.getMediaStreamPromise=this.getMediaStreamPromise.then((()=>this.getUserMediaStreamInternal(e,t,n))):this.getMediaStreamPromise=this.getUserMediaStreamInternal(e,t,n),this.getMediaStreamPromise}async getUserMediaStreamInternal(e,t,n){const i=e&&await this.hasAudioDevice(),s=t&&await this.hasVideoDevice();let o,r=!0;var l,d,u,h;this.localUserMediaStream?(i!==this.localUserMediaStream.getAudioTracks().length>0&&(r=!1),s!==this.localUserMediaStream.getVideoTracks().length>0&&(r=!1),i&&(null===(l=this.localUserMediaStream.getAudioTracks()[0])||void 0===l||null===(d=l.getSettings())||void 0===d?void 0:d.deviceId)!==this.audioInput&&(r=!1),s&&(null===(u=this.localUserMediaStream.getVideoTracks()[0])||void 0===u||null===(h=u.getSettings())||void 0===h?void 0:h.deviceId)!==this.videoInput&&(r=!1)):r=!1;if(r){var m;if(o=this.localUserMediaStream.clone(),a.a.log(`MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=${null===(m=this.localUserMediaStream)||void 0===m?void 0:m.id} newStreamId=${o.id} shouldRequestAudio=${i} shouldRequestVideo=${s})`),!i)for(const e of o.getAudioTracks())o.removeTrack(e);if(!s)for(const e of o.getVideoTracks())o.removeTrack(e)}else{const e=this.getUserMediaContraints(i,s);o=await navigator.mediaDevices.getUserMedia(e),a.a.log(`MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=${o.id}, shouldRequestAudio=${i}, shouldRequestVideo=${s}, constraints=${JSON.stringify(e)})`);for(const e of o.getTracks()){const t=e.getSettings();"audio"===e.kind?this.audioInput=t.deviceId:"video"===e.kind&&(this.videoInput=t.deviceId)}n&&(this.localUserMediaStream=o)}return n&&this.userMediaStreams.push(o),this.emit(c.LocalStreamsChanged),o}stopUserMediaStream(e){a.a.log(`MediaHandler stopUserMediaStream() stopping (streamId=${e.id})`);for(const t of e.getTracks())t.stop();const t=this.userMediaStreams.indexOf(e);-1!==t&&(a.a.debug(`MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=${e.id})`,e.id),this.userMediaStreams.splice(t,1)),this.emit(c.LocalStreamsChanged),this.localUserMediaStream===e&&(this.localUserMediaStream=void 0)}async getScreensharingStream(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(0===this.screensharingStreams.length){const n=this.getScreenshareContraints(t);t.desktopCapturerSourceId?(a.a.debug(`MediaHandler getScreensharingStream() calling getUserMedia() (opts=${JSON.stringify(t)})`),e=await navigator.mediaDevices.getUserMedia(n)):(a.a.debug(`MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=${JSON.stringify(t)})`),e=await navigator.mediaDevices.getDisplayMedia(n))}else{const t=this.screensharingStreams[this.screensharingStreams.length-1];a.a.log(`MediaHandler getScreensharingStream() cloning (streamId=${t.id})`),e=t.clone()}return n&&this.screensharingStreams.push(e),this.emit(c.LocalStreamsChanged),e}stopScreensharingStream(e){a.a.debug(`MediaHandler stopScreensharingStream() stopping stream (streamId=${e.id})`);for(const t of e.getTracks())t.stop();const t=this.screensharingStreams.indexOf(e);-1!==t&&(a.a.debug(`MediaHandler stopScreensharingStream() splicing stream out (streamId=${e.id})`),this.screensharingStreams.splice(t,1)),this.emit(c.LocalStreamsChanged)}stopAllStreams(){for(const e of this.userMediaStreams){a.a.log(`MediaHandler stopAllStreams() stopping (streamId=${e.id})`);for(const t of e.getTracks())t.stop()}for(const e of this.screensharingStreams)for(const t of e.getTracks())t.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(c.LocalStreamsChanged)}getUserMediaContraints(e,t){const n=!!navigator.webkitGetUserMedia;return{audio:!!e&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0},video:!!t&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:n?{exact:640}:{ideal:640},height:n?{exact:360}:{ideal:360}}}}getScreenshareContraints(e){const{desktopCapturerSourceId:t,audio:n}=e;return t?{audio:null!=n&&n,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:null!=n&&n,video:!0}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(13),s=n.n(i),o=n(130),r=n(1),a=n(149),c=n(434),l=n(219),d=n(16);class u{constructor(e){this.client=e,s()(this,"sending",!1),s()(this,"running",!0),s()(this,"retryTimeout",null),s()(this,"retryAttempts",0),s()(this,"sendQueue",(async()=>{if(null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.sending||!this.running)return;let e;r.a.debug("Attempting to send queued to-device messages"),this.sending=!0;try{for(;this.running&&(e=await this.client.store.getOldestToDeviceBatch(),null!==e);)await this.sendBatch(e),await this.client.store.removeToDeviceBatch(e.id),this.retryAttempts=0;if(!this.running)return;r.a.debug("All queued to-device messages sent")}catch(t){++this.retryAttempts;const n=c.a.RETRY_BACKOFF_RATELIMIT(null,this.retryAttempts,t);if(-1===n)return void(4===Math.floor(t.httpStatus/100)?(r.a.error("Fatal error when sending to-device message - dropping to-device batch!",t),await this.client.store.removeToDeviceBatch(e.id)):r.a.info("Automatic retry limit reached for to-device messages."));r.a.info(`Failed to send batch of to-device messages. Will retry in ${n}ms`,t),this.retryTimeout=setTimeout(this.sendQueue,n)}finally{this.sending=!1}})),s()(this,"onResumedSync",((e,t)=>{e===l.b.Syncing&&t!==l.b.Syncing&&(r.a.info("Resuming queue after resumed sync"),this.sendQueue())}))}start(){this.running=!0,this.sendQueue(),this.client.on(a.b.Sync,this.onResumedSync)}stop(){this.running=!1,null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(a.b.Sync,this.onResumedSync)}async queueBatch(e){const t=[];for(let n=0;n<e.batch.length;n+=20){const i={eventType:e.eventType,batch:e.batch.slice(n,n+20),txnId:this.client.makeTxnId()};t.push(i);const s=i.batch.map((e=>`${e.userId}/${e.deviceId} (msgid ${e.payload[o.k]})`));r.a.info(`Enqueuing batch of to-device messages. type=${e.eventType} txnid=${i.txnId}`,s)}await this.client.store.saveToDeviceBatches(t),this.sendQueue()}async sendBatch(e){const t=new d.b((()=>new Map));for(const n of e.batch)t.getOrCreate(n.userId).set(n.deviceId,n.payload);r.a.info(`Sending batch of ${e.batch.length} to-device messages with ID ${e.id} and txnId ${e.txnId}`),await this.client.sendToDevice(e.eventType,t,e.txnId)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(10),s=n(180),o=n(161),r=n(16);const a=new i.UnstableValue("m.policies","org.matrix.msc3847.policies"),c=new i.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites");var l;let d;!function(e){e.Ban="m.ban"}(l||(l={})),function(e){e.User="m.policy.user",e.Room="m.policy.room",e.Server="m.policy.server"}(d||(d={}));class u{constructor(e){this.client=e}async addRule(e,t,n){const i=await this.getOrCreateTargetRoom();return(await this.client.sendStateEvent(i.roomId,e,{entity:t,reason:n,recommendation:l.Ban})).event_id}async removeRule(e){await this.client.redactEvent(e.getRoomId(),e.getId())}async addSource(e){await this.client.joinRoom(e);const t=(await this.getOrCreateSourceRooms()).map((e=>e.roomId));return!t.includes(e)&&(t.push(e),await this.withIgnoreInvitesPolicies((e=>{e.sources=t})),!0)}async getRuleForInvite(e){let{sender:t,roomId:n}=e;const i=await this.getOrCreateSourceRooms(),o=t.split(":")[1],a=n.split(":")[1];for(const e of i){const i=e.getUnfilteredTimelineSet().getLiveTimeline().getState(s.b.FORWARDS);for(const{scope:e,entities:s}of[{scope:d.Room,entities:[n]},{scope:d.User,entities:[t]},{scope:d.Server,entities:[o,a]}]){const t=i.getStateEvents(e);for(const e of t){const t=e.getContent();if((null==t?void 0:t.recommendation)!=l.Ban)continue;const n=null==t?void 0:t.entity;if(!n)continue;let i;try{i=new RegExp(Object(r.r)(n,!1))}catch(e){continue}for(const t of s)if(t&&i.test(t))return e}}}return null}async getOrCreateTargetRoom(){let e=this.getIgnoreInvitesPolicies().target;if("string"!=typeof e&&(e=null),e){const t=this.client.getRoom(e);if(t)return t;e=null}return e=(await this.client.createRoom({name:"Individual Policy Room",preset:o.d.PrivateChat})).room_id,await this.withIgnoreInvitesPolicies((t=>{t.target=e})),this.client.getRoom(e)}async getOrCreateSourceRooms(){let e=this.getIgnoreInvitesPolicies().sources,t=!1;Array.isArray(e)||(t=!0,e=[]);let n=e.filter((e=>"string"==typeof e)).map((e=>this.client.getRoom(e))).filter((e=>!!e));if(n.length!=e.length&&(t=!0),0==n.length){t=!0,n=[await this.getOrCreateTargetRoom()]}return t&&await this.withIgnoreInvitesPolicies((t=>{t.sources=e})),n}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}async withIgnoreInvitesPolicies(e){const{policies:t,ignoreInvitesPolicies:n}=this.getPoliciesAndIgnoreInvitesPolicies();e(n),t[c.name]=n,await this.client.setAccountData(a.name,t)}getPoliciesAndIgnoreInvitesPolicies(){let e={};for(const n of[a.name,a.altName]){var t;if(!n)continue;const i=null===(t=this.client.getAccountData(n))||void 0===t?void 0:t.getContent();if(i){e=i;break}}let n={},i=!1;for(const t of[c.name,c.altName]){if(!t)continue;const s=e[t];if(s&&"object"==typeof s){n=s,i=!0;break}}return i||(e[c.name]=n),{policies:e,ignoreInvitesPolicies:n}}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(1),c=n(121),l=n(136),d=n(146),u=n(135);class h extends r.a.Component{constructor(){super(...arguments),s()(this,"unmounted",!1),s()(this,"state",{}),s()(this,"onWrapperCancelClick",(()=>{this.props.onFinished()}))}componentDidMount(){a.a.log("Starting load of AsyncWrapper for modal"),this.props.prom.then((e=>{if(this.unmounted)return;const t=e.default?e.default:e;this.setState({component:t})})).catch((e=>{a.a.warn("AsyncWrapper promise failed",e),this.setState({error:e})}))}componentWillUnmount(){this.unmounted=!0}render(){if(this.state.component){const e=this.state.component;return r.a.createElement(e,this.props)}return this.state.error?r.a.createElement(l.a,{onFinished:this.props.onFinished,title:Object(c.a)("Error")},Object(c.a)("Unable to load! Check your network connectivity and try again."),r.a.createElement(d.a,{primaryButton:Object(c.a)("Dismiss"),onPrimaryButtonClick:this.onWrapperCancelClick,hasCancel:!1})):r.a.createElement(u.a,null)}}},function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return v}));var i,s,o,r,a,c,l,d,u,h,m,p=n(120);function g(){return g=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},g.apply(this,arguments)}function v(e){return p.createElement("svg",g({viewBox:"0 0 50.8 50.8",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0},e),i||(i=p.createElement("defs",null,p.createElement("filter",{id:"element-desktop-logo_svg__c",colorInterpolationFilters:"sRGB"},p.createElement("feFlood",{floodColor:"#000",floodOpacity:.8,result:"flood"}),p.createElement("feComposite",{in:"flood",in2:"SourceGraphic",operator:"out",result:"composite1"}),p.createElement("feGaussianBlur",{in:"composite1",result:"blur",stdDeviation:8}),p.createElement("feOffset",{result:"offset"}),p.createElement("feComposite",{in:"offset",in2:"SourceGraphic",operator:"atop",result:"composite2"})),p.createElement("filter",{id:"element-desktop-logo_svg__b",colorInterpolationFilters:"sRGB"},p.createElement("feFlood",{floodColor:"#000",floodOpacity:.8,result:"flood"}),p.createElement("feComposite",{in:"flood",in2:"SourceGraphic",operator:"out",result:"composite1"}),p.createElement("feGaussianBlur",{in:"composite1",result:"blur",stdDeviation:8}),p.createElement("feOffset",{result:"offset"}),p.createElement("feComposite",{in:"offset",in2:"SourceGraphic",operator:"atop",result:"composite2"})),p.createElement("filter",{id:"element-desktop-logo_svg__e",colorInterpolationFilters:"sRGB"},p.createElement("feFlood",{floodColor:"#000",floodOpacity:.8,result:"flood"}),p.createElement("feComposite",{in:"flood",in2:"SourceGraphic",operator:"out",result:"composite1"}),p.createElement("feGaussianBlur",{in:"composite1",result:"blur",stdDeviation:8}),p.createElement("feOffset",{result:"offset"}),p.createElement("feComposite",{in:"offset",in2:"SourceGraphic",operator:"atop",result:"composite2"})),p.createElement("filter",{id:"element-desktop-logo_svg__d",colorInterpolationFilters:"sRGB"},p.createElement("feFlood",{floodColor:"#000",floodOpacity:.8,result:"flood"}),p.createElement("feComposite",{in:"flood",in2:"SourceGraphic",operator:"out",result:"composite1"}),p.createElement("feGaussianBlur",{in:"composite1",result:"blur",stdDeviation:8}),p.createElement("feOffset",{result:"offset"}),p.createElement("feComposite",{in:"offset",in2:"SourceGraphic",operator:"atop",result:"composite2"})),p.createElement("filter",{id:"element-desktop-logo_svg__f",colorInterpolationFilters:"sRGB"},p.createElement("feFlood",{floodColor:"#000",floodOpacity:.502,result:"flood"}),p.createElement("feComposite",{in:"flood",in2:"SourceGraphic",operator:"out",result:"composite1"}),p.createElement("feGaussianBlur",{in:"composite1",result:"blur",stdDeviation:5}),p.createElement("feOffset",{result:"offset"}),p.createElement("feComposite",{in:"offset",in2:"SourceGraphic",operator:"atop",result:"composite2"})),p.createElement("filter",{id:"element-desktop-logo_svg__a",colorInterpolationFilters:"sRGB"},p.createElement("feFlood",{floodColor:"#000",floodOpacity:.502,result:"flood"}),p.createElement("feComposite",{in:"flood",in2:"SourceGraphic",operator:"out",result:"composite1"}),p.createElement("feGaussianBlur",{in:"composite1",result:"blur",stdDeviation:1.5}),p.createElement("feOffset",{result:"offset"}),p.createElement("feComposite",{in:"offset",in2:"SourceGraphic",operator:"atop",result:"composite2"})))),s||(s=p.createElement("path",{transform:"rotate(37.82 -3.984 62.926)",d:"M-7.304 22.852s-7.428-.647-8.942-1.192c-1.664-.598-2.603-1.165-3.68-2.07-2.394-2.015-4.083-5.909-5.937-7.273-2.122-1.562-7.469-2.59-7.469-2.59L-16.868.972s-2.25 5.015-2.028 7.641c.184 2.172.928 4.132 2.717 5.948 1.428 1.45 11.225 4.183 8.401 3.319",fill:"#fdd835",filter:"url(#element-desktop-logo_svg__a)"})),o||(o=p.createElement("path",{transform:"translate(.076 5.266) scale(.26458)",d:"M81.874 145.81c-1.442-.464-3.955-1.879-9.499-5.344-4.001-2.502-4.906-3.003-7.502-4.151-2.91-1.288-5.079-2.065-11.214-4.022l-1.834-.585v-.505c0-2.136 3.355-10.912 8.84-23.133C67.63 92.554 75.323 77.478 77.42 75.237c.344-.367.517-.466 1.3-.74 5.295-1.851 9.952-2.533 17.3-2.533 6.958 0 11.343.604 16.457 2.265 1.687.548 1.75.576 2.09.964 3.064 3.48 15.436 28.825 21.982 45.03 2.318 5.738 3.488 9.22 3.638 10.83.051.544.047.558-.203.687-.14.072-1.539.534-3.107 1.026-5.857 1.839-9.664 3.341-12.97 5.12-.582.313-2.571 1.512-4.419 2.664s-3.915 2.427-4.596 2.833c-1.444.862-4.03 2.189-4.729 2.427-1.06.36-5.003.257-9.163-.24-2.166-.26-2.597-.285-4.979-.285-2.38 0-2.815.024-4.994.282-2.673.318-4.969.467-7.07.461-1.25-.004-1.493-.03-2.08-.219z",fill:"#8bc34a",filter:"url(#element-desktop-logo_svg__b)"})),r||(r=p.createElement("path",{transform:"translate(.076 5.266) scale(.26458)",d:"M33.825 131.8l-4.61-1.22-5.458-3.196-1.733.256c-1.728.255-1.737.257-2.727.754l-.993.498.063-.25c.034-.136.515-2.138 1.067-4.447l1.004-4.198 8.478-26.87 9.087-19.107 6.364-10.061 10.23-6.88.625.321c.88.454 4.957 2.786 6.59 3.772 4.838 2.917 7.137 4.806 13.549 11.134l2.367 2.336-.391.404c-1.243 1.279-4.05 6.308-8.318 14.899-8.896 17.906-17.081 37.206-17.347 40.903-.044.606-.071.69-.236.726-.203.044-12.886 1.467-12.958 1.454-.024-.004-2.118-.557-4.653-1.228z",fill:"#8bc34a",filter:"url(#element-desktop-logo_svg__c)"})),a||(a=p.createElement("path",{transform:"translate(.076 5.266) scale(.26458)",d:"M112.7 74.102a43.534 43.534 0 00-8.18-1.876c-2.291-.286-3.524-.358-7.081-.413-7.811-.12-12.37.44-17.832 2.195l-1.7.546-2.41-2.38c-5.146-5.082-7.783-7.395-10.499-9.206-2.059-1.373-6.544-4.037-9.478-5.629l-.773-.42.004-.854c.003-.47.057-2.227.121-3.904l.116-3.05 1.816-6.01 20.344-8.629 2.124-.211c2.54-.253 7.727-.685 10.786-.9 2.686-.187 8.714-.211 11.225-.044 3.791.252 9.524.73 12.419 1.037l1.193.126 20.317 8.623 1.81 6.035.094 2.683c.052 1.475.119 3.22.149 3.879l.054 1.196-.473.254c-3.943 2.116-9.638 5.566-11.426 6.922-2 1.516-4.566 3.843-8.314 7.537l-3.007 2.964z",fill:"#8bc34a",filter:"url(#element-desktop-logo_svg__d)"})),c||(c=p.createElement("path",{d:"M11.921 22.022c.12-.227 3.025-5.081 3.03-5.065a8.7 8.7 0 01-.183.65l-.191.629-.073 2.083-1.271.853c-.7.469-1.283.856-1.297.861-.014.005-.02 0-.015-.011zM37.75 21.193c-.707-.475-1.288-.866-1.292-.87-.003-.003-.023-.469-.044-1.035l-.037-1.028-.2-.664c-.109-.365-.194-.667-.19-.672s.696 1.145 1.535 2.554c.839 1.41 1.522 2.567 1.518 2.57-.004.004-.585-.381-1.29-.855z",fill:"#43a047"})),l||(l=p.createElement("path",{transform:"translate(.076 5.266) scale(.26458)",d:"M146.8 132.28c-3.5-.404-6.374-.738-6.386-.742-.012-.004-.023-.156-.023-.338-.001-.589-.42-2.203-1.091-4.208-4.29-12.82-20.967-48.002-24.643-51.99l-.34-.37 2.941-2.906c5.308-5.244 7.637-7.22 11.113-9.421 2.175-1.378 5.786-3.485 8.462-4.938l.551-.299 10.215 6.844 6.41 10.122 9.107 19.165 8.472 26.884 1.049 4.376c.576 2.406 1.037 4.39 1.023 4.407s-.44-.192-.949-.465l-.925-.496-3.532-.528-5.456 3.197-4.664 1.23c-2.566.675-4.733 1.224-4.817 1.219-.084-.005-3.017-.34-6.517-.744z",fill:"#8bc34a",filter:"url(#element-desktop-logo_svg__e)"})),d||(d=p.createElement("path",{transform:"translate(.076 5.266) scale(.26458)",d:"M23.473 157.16l-3.456-1.68-3.077.401c-1.693.22-3.16.414-3.262.43-.158.025-.334-.239-1.201-1.799l-1.016-1.828 2.559-4.386 1.216-4.76c.67-2.619 1.284-4.864 1.367-4.99.082-.126 1.05-1.468 2.148-2.981 1.952-2.688 1.998-2.761 1.98-3.15-.01-.219-.082-1.179-.158-2.133-.076-.955-.126-1.848-.11-1.986l.029-.249 1.591-.239 1.591-.238 5.442 3.17 9.385 2.477 6.552-.734c6.306-.707 6.563-.73 6.861-.589.17.08 1.597.551 3.171 1.046 5.599 1.76 9.032 3.1 12.4 4.84.746.384 2.986 1.714 4.98 2.955a326.218 326.218 0 005.012 3.07c1.715 1.004 3.916 2.084 4.618 2.264 1.104.283 5.013.14 8.931-.327 2.166-.258 2.623-.284 4.95-.285 2.332-.001 2.778.024 4.95.28 2.788.33 4.825.467 6.974.467 1.414 0 1.607-.02 2.263-.227 1.484-.469 3.71-1.715 9.556-5.352 3.713-2.309 4.696-2.866 6.662-3.772 2.871-1.323 5.864-2.432 10.68-3.958 1.467-.464 2.813-.915 2.991-1.001.32-.155.412-.147 6.883.582l6.559.74 4.563-1.196c2.51-.658 4.692-1.254 4.849-1.326.157-.072 1.433-.803 2.836-1.625l2.551-1.495 1.598.233c.879.128 1.623.258 1.654.29.031.03-.028 1.092-.132 2.358l-.19 2.301 4.324 5.979 2.422 9.528 1.287 2.212c.984 1.691 1.266 2.244 1.201 2.35-.047.078-.494.886-.993 1.798-.783 1.429-.937 1.657-1.118 1.657-.115 0-1.593-.18-3.284-.401l-3.075-.401-6.892 3.342-28.758-1.806-4.387-2.824-5.303-1.529-8.618-2.482-3.315-.954-5.038-.844c-5.77-.966-9.892-1.576-12.114-1.794-1.453-.142-1.63-.142-3.067 0-2.686.264-8.425 1.129-14.455 2.178l-2.98.519-17.059 4.93-4.317 2.789-1.156.08c-.636.044-6.884.437-13.884.872s-12.95.813-13.222.837c-.493.045-.496.044-3.95-1.634z",fill:"#e4bf15",filter:"url(#element-desktop-logo_svg__f)"})),u||(u=p.createElement("path",{d:"M13.755 40.096l-3.486.393-2.475-.652-1.44-.842-.907.133-.563.293.57-2.393 2.243-7.113 2.412-5.078 1.697-2.678 2.72-1.824",fill:"none",stroke:"#33691e",strokeWidth:1.323})),h||(h=p.createElement("path",{d:"M20.678 25.027c-.77.28-7.286 14.178-6.907 15.086.046.11 2.905.755 4.793 1.932 1.499.934 2.927 1.873 3.434 1.879 1.951.02 2.317-.217 3.478-.217s1.528.238 3.478.217c.507-.006 1.935-.945 3.434-1.879 1.888-1.177 4.747-1.821 4.794-1.932.378-.908-6.138-14.805-6.908-15.086-1.823-.666-3.18-.744-4.798-.744s-2.975.078-4.798.744z",fill:"none",stroke:"#33691e",strokeWidth:1.323})),m||(m=p.createElement("path",{d:"M37.197 40.096l3.486.393 2.476-.652 1.439-.842.907.133.563.293-.57-2.393-2.242-7.113-2.413-5.078-1.696-2.678-2.72-1.824M30.274 25.027s1.89-1.95 2.97-2.766c.989-.748 3.182-1.926 3.182-1.926l-.072-2.07-.485-1.613-5.396-2.29s-3.327-.352-4.997-.352-4.997.352-4.997.352l-5.396 2.29-.486 1.613-.072 2.07s2.194 1.178 3.184 1.926c1.079.815 2.969 2.766 2.969 2.766M15.083 16.652l-3.277 5.507M35.87 16.652l3.276 5.507",fill:"none",stroke:"#33691e",strokeWidth:1.323})))}t.default="img/element-desktop-logo.b04e0e4.svg"},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return d}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(1),c=n(121);const l="mx_recaptcha";class d extends r.a.Component{constructor(e){super(e),s()(this,"captchaWidgetId",void 0),s()(this,"recaptchaContainer",Object(o.createRef)()),this.state={errorText:void 0}}componentDidMount(){if(this.isRecaptchaReady())this.onCaptchaLoaded();else{var e;a.a.log("Loading recaptcha script..."),window.mxOnRecaptchaLoaded=()=>{this.onCaptchaLoaded()};const t=document.createElement("script");t.setAttribute("src","https://www.recaptcha.net/recaptcha/api.js?onload=mxOnRecaptchaLoaded&render=explicit"),null===(e=this.recaptchaContainer.current)||void 0===e||e.appendChild(t)}}componentWillUnmount(){this.resetRecaptcha()}isRecaptchaReady(){return"undefined"!=typeof window&&void 0!==e.grecaptcha&&"function"==typeof e.grecaptcha.render}renderRecaptcha(t){var n;if(!this.isRecaptchaReady())throw a.a.error("grecaptcha not loaded!"),new Error("Recaptcha did not load successfully");const i=this.props.sitePublicKey;if(!i)throw a.a.error("No public key for recaptcha!"),new Error("This server has not supplied enough information for Recaptcha authentication");a.a.info("Rendering to %s",t),this.captchaWidgetId=null===(n=e.grecaptcha)||void 0===n?void 0:n.render(t,{sitekey:i,callback:this.props.onCaptchaResponse})}resetRecaptcha(){var t,n;this.captchaWidgetId&&(null===(t=e)||void 0===t||null===(n=t.grecaptcha)||void 0===n||n.reset(this.captchaWidgetId))}onCaptchaLoaded(){a.a.log("Loaded recaptcha script.");try{this.renderRecaptcha(l),this.setState({errorText:void 0})}catch(e){this.setState({errorText:e.toString()})}}render(){let e;return this.state.errorText&&(e=r.a.createElement("div",{className:"error"},this.state.errorText)),r.a.createElement("div",{ref:this.recaptchaContainer},r.a.createElement("p",null,Object(c.a)("This homeserver would like to make sure you are not a robot.")),r.a.createElement("div",{id:l}),e)}}s()(d,"defaultProps",{onCaptchaResponse:()=>{}})}).call(this,n(14))},,,,,,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return B}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(188),c=n.n(a),l=n(803),d=n.n(l),u=n(130),h=n(199),m=n(166),p=n(128),g=n(125),v=n(121),f=n(151),b=n(126),y=n(792),S=n(809),E=n(286),w=n(168),_=n(230),C=n(148),O=n(198),I=n(129),R=n(1450),k=n(1451),x=n(157),T=n(1709),j=n(1555),P=n(1712),D=n(139),N=n(124),M=n(374),A=n(229),L=n(998);function U(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function F(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?U(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):U(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class B extends r.a.Component{constructor(t){super(t),s()(this,"contentRef",Object(o.createRef)()),s()(this,"unmounted",!1),s()(this,"pills",[]),s()(this,"tooltips",[]),s()(this,"context",void 0),s()(this,"onCancelClick",(()=>{this.setState({widgetHidden:!0}),e.localStorage&&e.localStorage.setItem("hide_preview_"+this.props.mxEvent.getId(),"1"),this.forceUpdate()})),s()(this,"onEmoteSenderClick",(()=>{const e=this.props.mxEvent;g.a.dispatch({action:I.a.ComposerInsert,userId:e.getSender(),timelineRenderingType:this.context.timelineRenderingType})})),s()(this,"onBodyLinkClick",(e=>{let t=e.target;if(t.classList.contains(M.e.className))return;if("A"!==t.nodeName&&(t=t.closest("a")),!t)return;const n=Object(w.l)(t.href);n!==t.href&&(e.preventDefault(),window.location.hash=n)})),s()(this,"getEventTileOps",(()=>({isWidgetHidden:()=>this.state.widgetHidden,unhideWidget:()=>{this.setState({widgetHidden:!1}),e.localStorage&&e.localStorage.removeItem("hide_preview_"+this.props.mxEvent.getId())}}))),s()(this,"onStarterLinkClick",((e,t)=>{t.preventDefault();const n=E.a.sharedInstance();if(!n.hasManager())return void n.openNoManagerDialog();const i=n.getPrimaryManager(),s=i.getScalarClient();s.connect().then((()=>{const t=s.getStarterLink(e),n=i.uiUrl;p.b.createDialog(x.a,{title:Object(v.a)("Add an Integration"),description:r.a.createElement("div",null,Object(v.a)("You are about to be taken to a third-party site so you can authenticate your account for use with %(integrationsUrl)s. Do you wish to continue?",{integrationsUrl:n})),button:Object(v.a)("Continue"),onFinished(e){if(!e)return;const n=window.screen.width>1024?1024:window.screen.width,i=window.screen.height>800?800:window.screen.height,s=(window.screen.width-n)/2,o=`height=${i}, width=${n}, top=${(window.screen.height-i)/2}, left=${s},`;window.open(t,"_blank",o).opener=null}})}))})),s()(this,"openHistoryDialog",(async()=>{p.b.createDialog(T.a,{mxEvent:this.props.mxEvent})})),this.state={links:[],widgetHidden:!1}}componentDidMount(){this.props.editState||this.applyFormatting()}applyFormatting(){const e=this.contentRef.current,t=b.b.getValue("showCodeLineNumbers");if(this.activateSpoilers([e]),Object(y.a)([e],this.props.mxEvent,this.pills),h.h(e),this.calculateUrlPreview(),Object(S.a)([e],this.pills,this.tooltips),"org.matrix.custom.html"===this.props.mxEvent.getContent().format){const e=c.a.findDOMNode(this).getElementsByTagName("pre");if(e.length>0)for(let n=0;n<e.length;n++){if("mx_EventTile_pre_container"==e[n].parentElement.className)continue;0==e[n].getElementsByTagName("code").length&&this.addCodeElement(e[n]);const i=this.wrapInDiv(e[n]);this.handleCodeBlockExpansion(e[n]),this.addCodeExpansionButton(i,e[n]),this.addCodeCopyButton(i),t&&this.addLineNumbers(e[n])}const n=c.a.findDOMNode(this).getElementsByTagName("code");n.length>0&&window.setTimeout((()=>{if(!this.unmounted)for(let e=0;e<n.length;e++)this.highlightCode(n[e])}),10)}}addCodeElement(e){const t=document.createElement("code");t.append(...e.childNodes),e.appendChild(t)}addCodeExpansionButton(e,t){if(Math.round(t.offsetHeight/O.b.instance.windowHeight*100)<30)return;const n=document.createElement("span");n.className="mx_EventTile_button ","mx_EventTile_collapsedCodeBlock"==t.className?n.className+="mx_EventTile_expandButton":n.className+="mx_EventTile_collapseButton",n.onclick=async()=>{n.className="mx_EventTile_button ","mx_EventTile_collapsedCodeBlock"==t.className?(t.className="",n.className+="mx_EventTile_collapseButton"):(t.className="mx_EventTile_collapsedCodeBlock",n.className+="mx_EventTile_expandButton"),this.props.onHeightChanged()},e.appendChild(n)}addCodeCopyButton(e){const t=document.createElement("span");t.className="mx_EventTile_button mx_EventTile_copyButton ";e.getElementsByClassName("mx_EventTile_button").length>0&&(t.className+="mx_EventTile_buttonBottom"),t.onclick=async()=>{const e=t.parentElement.getElementsByTagName("code")[0],n=await Object(_.b)(e.textContent),i=t.getBoundingClientRect(),{close:s}=f.m(R.a,F(F({},Object(f.p)(i,0)),{},{chevronFace:f.a.None,message:n?Object(v.a)("Copied!"):Object(v.a)("Failed to copy")}));t.onmouseleave=s},e.appendChild(t)}wrapInDiv(e){const t=document.createElement("div");return t.className="mx_EventTile_pre_container",t.dir="auto",e.parentNode.replaceChild(t,e),t.appendChild(e),t}handleCodeBlockExpansion(e){b.b.getValue("expandCodeByDefault")||(e.className="mx_EventTile_collapsedCodeBlock")}addLineNumbers(e){const t=e.innerHTML.replace(/\n(<\/code>)?$/,"").split(/\n/).length,n=document.createElement("span");n.className="mx_EventTile_lineNumbers";for(let e=1;e<=t;e++){const t=document.createElement("span");t.textContent=e.toString(),n.appendChild(t)}e.prepend(n),e.append(document.createElement("span"))}highlightCode(e){if(e.textContent.length>4096)return void console.log("Code block is bigger than highlight limit ("+e.textContent.length+" > 4096): not highlighting");let t;for(const n of e.className.split(/\s+/))if(n.startsWith("language-")){const e=n.split("-",2)[1];if(d.a.getLanguage(e)){t=e;break}}t?e.innerHTML=d.a.highlight(e.textContent,{language:t}).value:b.b.getValue("enableSyntaxHighlightLanguageDetection")&&e.parentElement instanceof HTMLPreElement&&(e.innerHTML=d.a.highlightAuto(e.textContent).value)}componentDidUpdate(e){if(!this.props.editState){const t=e.editState&&!this.props.editState;(e.replacingEventId!==this.props.replacingEventId||t)&&this.applyFormatting()}}componentWillUnmount(){this.unmounted=!0,Object(y.b)(this.pills),Object(S.b)(this.tooltips)}shouldComponentUpdate(e,t){return e.mxEvent.getId()!==this.props.mxEvent.getId()||e.highlights!==this.props.highlights||e.replacingEventId!==this.props.replacingEventId||e.highlightLink!==this.props.highlightLink||e.showUrlPreview!==this.props.showUrlPreview||e.youtubeEmbedPlayer!==this.props.youtubeEmbedPlayer||e.editState!==this.props.editState||t.links!==this.state.links||t.widgetHidden!==this.state.widgetHidden||e.isSeeingThroughMessageHiddenForModeration!==this.props.isSeeingThroughMessageHiddenForModeration}calculateUrlPreview(){if(this.props.showUrlPreview){let e=this.findLinks([this.contentRef.current]);if(e.length){if(e=Array.from(new Set(e)),this.setState({links:e}),window.localStorage){const e=!!window.localStorage.getItem("hide_preview_"+this.props.mxEvent.getId());this.setState({widgetHidden:e})}}else this.state.links.length&&this.setState({links:[]})}}activateSpoilers(e){let t=e[0];for(;t;){if("SPAN"===t.tagName&&"string"==typeof t.getAttribute("data-mx-spoiler")){const e=document.createElement("span"),n=t.getAttribute("data-mx-spoiler");t.removeAttribute("data-mx-spoiler");const i=r.a.createElement(k.a,{reason:n,contentHtml:t.outerHTML});c.a.render(i,e),t.parentNode.replaceChild(e,t),t=e}t.childNodes&&t.childNodes.length&&this.activateSpoilers(t.childNodes),t=t.nextSibling}}findLinks(e){let t=[];for(let n=0;n<e.length;n++){const i=e[n];if("A"===i.tagName&&i.getAttribute("href"))this.isLinkPreviewable(i)&&t.push(i.getAttribute("href"));else{if("PRE"===i.tagName||"CODE"===i.tagName||"BLOCKQUOTE"===i.tagName)continue;i.children&&i.children.length&&(t=t.concat(this.findLinks(i.children)))}}return t}isLinkPreviewable(e){if(!e.getAttribute("href").startsWith("http://")&&!e.getAttribute("href").startsWith("https://"))return!1;if(e.textContent.indexOf("/")>-1)return!0;{const t=e.getAttribute("href").match(/^https?:\/\/(.*?)(\/|$)/)[1];return!Object(w.f)(t)&&!e.textContent.toLowerCase().trim().startsWith(t.toLowerCase())}}renderEditedMarker(){const e=this.props.mxEvent.replacingEventDate(),t=e&&Object(m.a)(e),n=r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Tooltip_title"},Object(v.a)("Edited at %(date)s",{date:t})),r.a.createElement("div",{className:"mx_Tooltip_sub"},Object(v.a)("Click to view edits")));return r.a.createElement(C.a,{className:"mx_EventTile_edited",onClick:this.openHistoryDialog,title:Object(v.a)("Edited at %(date)s. Click to view edits.",{date:t}),tooltip:n},r.a.createElement("span",null,`(${Object(v.a)("edited")})`))}renderPendingModerationMarker(){let e;const t=this.props.mxEvent.messageVisibility();switch(t.visible){case!0:throw new Error("renderPendingModerationMarker should only be applied to hidden messages");case!1:e=t.reason?Object(v.a)("Message pending moderation: %(reason)s",{reason:t.reason}):Object(v.a)("Message pending moderation")}return r.a.createElement("span",{className:"mx_EventTile_pendingModeration"},`(${e})`)}render(){if(this.props.editState){return b.b.getValue("feature_wysiwyg_composer")?r.a.createElement(L.a,{editorStateTransfer:this.props.editState,className:"mx_EventTile_content"}):r.a.createElement(j.a,{editState:this.props.editState,className:"mx_EventTile_content"})}const e=this.props.mxEvent,t=e.getContent();let n=!1,i=!1;const s=!e.replacingEvent()&&!!Object(A.b)(e);i=t.msgtype===u.e.Emote,n=t.msgtype===u.e.Notice;let o,a=h.c(t,this.props.highlights,{disableBigEmoji:i||!b.b.getValue("TextualBody.enableBigEmoji"),stripReplyFallback:s,ref:this.contentRef,returnString:!1});return this.props.replacingEventId&&(a=r.a.createElement(r.a.Fragment,null,a,this.renderEditedMarker())),this.props.isSeeingThroughMessageHiddenForModeration&&(a=r.a.createElement(r.a.Fragment,null,a,this.renderPendingModerationMarker())),this.props.highlightLink?a=r.a.createElement("a",{href:this.props.highlightLink},a):t.data&&"string"==typeof t.data["org.matrix.neb.starter_link"]&&(a=r.a.createElement(N.a,{kind:"link_inline",onClick:this.onStarterLinkClick.bind(this,t.data["org.matrix.neb.starter_link"])},a)),this.state.links.length&&!this.state.widgetHidden&&this.props.showUrlPreview&&(o=r.a.createElement(P.a,{links:this.state.links,mxEvent:this.props.mxEvent,onCancelClick:this.onCancelClick,onHeightChanged:this.props.onHeightChanged,youtubeEmbedPlayer:this.props.youtubeEmbedPlayer})),i?r.a.createElement("div",{className:"mx_MEmoteBody mx_EventTile_content",onClick:this.onBodyLinkClick},"* ",r.a.createElement("span",{className:"mx_MEmoteBody_sender",onClick:this.onEmoteSenderClick},e.sender?e.sender.name:e.getSender())," ",a,o,this.props.scBubbleTimestamp):n?r.a.createElement("div",{className:"mx_MNoticeBody mx_EventTile_content",onClick:this.onBodyLinkClick,dir:"auto"},a,o,this.props.scBubbleTimestamp):r.a.createElement("div",{className:"mx_MTextBody mx_EventTile_content",onClick:this.onBodyLinkClick,dir:"auto"},a,o,this.props.scBubbleTimestamp)}}s()(B,"contextType",D.b)}).call(this,n(14))},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/social/facebook.c272141.png"},function(e,t){e.exports="img/social/twitter-2.ede880b.png"},function(e,t){e.exports="img/social/linkedin.7f6ba82.png"},function(e,t){e.exports="img/social/reddit.95349c0.png"},function(e,t){e.exports="img/social/email-1.05522c5.png"},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(120),s=n.n(i);class o extends s.a.Component{render(){return s.a.createElement("div",{className:"mx_Tooltip mx_Tooltip_visible",style:{display:"block"}},this.props.message)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o);class a extends r.a.Component{constructor(e){super(e),s()(this,"toggleVisible",(e=>{this.state.visible||(e.preventDefault(),e.stopPropagation()),this.setState({visible:!this.state.visible})})),this.state={visible:!1}}render(){const e=this.props.reason?r.a.createElement("span",{className:"mx_EventTile_spoiler_reason"},"("+this.props.reason+")"):null;return r.a.createElement("span",{className:"mx_EventTile_spoiler"+(this.state.visible?" visible":""),onClick:this.toggleVisible},e," ",r.a.createElement("span",{className:"mx_EventTile_spoiler_content",dangerouslySetInnerHTML:{__html:this.props.contentHtml}}))}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){e.exports=n.p+"recorder-worklet.305bebd.js"},,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));const i=()=>{const e=new WeakSet;return(t,n)=>{if("object"==typeof n&&null!==n){if(e.has(n))return"<$ cycle-trimmed $>";e.add(n)}return n}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";function i(){window.TouchEvent||(window.TouchEvent=class extends UIEvent{get altKey(){return!1}get changedTouches(){return[]}get ctrlKey(){return!1}get metaKey(){return!1}get shiftKey(){return!1}get targetTouches(){return[]}get touches(){return[]}get rotation(){return 0}get scale(){return 0}constructor(e,t){super(e,t)}})}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(120),s=n.n(i),o=n(121),r=n(283),a=n(206),c=n(638);const l=e=>{let t,n,{call:i}=e;switch(Object(r.c)(i)){case a.c.Disconnected:t=Object(o.a)("Video"),n=!1;break;case a.c.Connecting:t=Object(o.a)("Joining…"),n=!0;break;case a.c.Connected:case a.c.Disconnecting:t=Object(o.a)("Joined"),n=!0}return s.a.createElement(c.a,{type:c.c.Video,text:t,active:n,participantCount:Object(r.f)(i)})}},function(e,t,n){"use strict";var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(127),c=n.n(a),l=n(144),d=n(130),u=n(1),h=n(121),m=n(125),p=n(1001),g=n(824),v=n(390),f=n(182),b=n(468),y=n(256),S=n(982),E=n(418),w=n(129),_=n(153),C=n(876),O=n(124),I=n(386),R=n(126),k=n(133),x=n(139),T=n(343),j=n(877),P=n(143),D=n(191),N=n(882);function M(e,t){const n=Object(v.a)(e);n&&(e=Object(v.e)(e));const i=!!t.replyEventId;let s="",o="";i&&(s=function(e){const t=e.getContent().body.split("\n").map((e=>e.trim()));return t.length>2&&t[0].startsWith("> ")&&0===t[1].length?`${t[0]}\n\n`:""}(t),o=function(e){const t=e.getContent().formatted_body;if(!t)return"";const n=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return n&&n.outerHTML||""}(t));const r=Object(v.g)(e),a={msgtype:n?d.e.Emote:d.e.Text,body:r},c={msgtype:a.msgtype,body:`${s} * ${r}`},l=Object(v.c)(e,{forceHTML:i,useMarkdown:R.b.getValue("MessageComposerInput.useMarkdown")});l&&(a.format="org.matrix.custom.html",a.formatted_body=l,c.format=a.format,c.formatted_body=`${o} * ${l}`);const u={"m.new_content":a,"m.relates_to":{rel_type:"m.replace",event_id:t.getId()}};return Object.assign(u,c)}class A extends r.a.Component{constructor(e,t){super(e),s()(this,"context",void 0),s()(this,"editorRef",Object(o.createRef)()),s()(this,"dispatcherRef",void 0),s()(this,"model",null),s()(this,"onKeyDown",(e=>{var t;if(null!==(t=this.editorRef.current)&&void 0!==t&&t.isComposing(e))return;switch(Object(_.a)().getMessageComposerAction(e)){case P.h.SendMessage:this.sendEdit(),e.stopPropagation(),e.preventDefault();break;case P.h.CancelReplyOrEdit:e.stopPropagation(),this.cancelEdit();break;case P.h.EditPrevMessage:{var n,i;if(null!==(n=this.editorRef.current)&&void 0!==n&&n.isModified()||null===(i=this.editorRef.current)||void 0===i||!i.isCaretAtStart())return;const t=Object(f.g)({events:this.events,isForward:!1,fromEventId:this.props.editState.getEvent().getId()});t&&(m.a.dispatch({action:w.a.EditEvent,event:t,timelineRenderingType:this.context.timelineRenderingType}),e.preventDefault());break}case P.h.EditNextMessage:{var s,o;if(null!==(s=this.editorRef.current)&&void 0!==s&&s.isModified()||null===(o=this.editorRef.current)||void 0===o||!o.isCaretAtEnd())return;const t=Object(f.g)({events:this.events,isForward:!0,fromEventId:this.props.editState.getEvent().getId()});t?m.a.dispatch({action:w.a.EditEvent,event:t,timelineRenderingType:this.context.timelineRenderingType}):this.cancelEdit(),e.preventDefault();break}}})),s()(this,"cancelEdit",(()=>{this.endEdit()})),s()(this,"saveStoredEditorState",(()=>{const e=C.a.createItem(this.model);this.clearPreviousEdit(),localStorage.setItem(this.editorRoomKey,this.props.editState.getEvent().getId()),localStorage.setItem(this.editorStateKey,JSON.stringify(e))})),s()(this,"sendEdit",(async()=>{if(this.state.saveDisabled)return;const e=this.props.editState.getEvent();if(D.a.instance.trackEvent({eventName:"Composer",isEditing:!0,inThread:!(null==e||!e.getThread()),isReply:!!e.replyEventId}),R.b.getValue("MessageComposerInput.autoReplaceEmoji")){var t,n;const e=null===(t=this.editorRef.current)||void 0===t?void 0:t.getCaret(),i=this.model.positionForOffset(e.offset,e.atNodeEnd);null===(n=this.editorRef.current)||void 0===n||n.replaceEmoticon(i,S.a)}const i=M(this.model,e),s=i["m.new_content"];let o=!0;if(""===(null==s?void 0:s.body))return this.cancelPreviousPendingEdit(),void Object(I.a)({mxEvent:e,onCloseDialog:()=>{this.cancelEdit()}});if(this.isContentModified(s)){const t=e.getRoomId();if(!Object(v.a)(this.model)&&Object(j.b)(this.model)){const[n,s,a]=Object(j.a)(this.model);if(n){var r;const a=(null==e||null===(r=e.getThread())||void 0===r?void 0:r.id)||null,[c,l]=await Object(j.c)(n,s,t,a);if(!l)return;n.category===E.a.messages||n.category===E.a.effects?i["m.new_content"]=c:o=!1}else{const e=await Object(j.d)(a);if(m.a.dispatch({action:w.a.FocusAComposer,context:this.context.timelineRenderingType}),!e)return}}if(o){this.cancelPreviousPendingEdit();const e=this.props.editState.getEvent().threadRootId||null;this.props.mxClient.sendMessage(t,e,i),m.a.dispatch({action:"message_sent"})}}this.endEdit()})),s()(this,"onChange",(()=>{var e;this.state.saveDisabled&&null!==(e=this.editorRef.current)&&void 0!==e&&e.isModified()&&this.setState({saveDisabled:!1})})),s()(this,"onAction",(e=>{if(this.editorRef.current)if(e.action===w.a.ComposerInsert){if(e.timelineRenderingType!==this.context.timelineRenderingType)return;if(e.composerType!==T.a.Edit)return;var t;if(e.userId)null===(t=this.editorRef.current)||void 0===t||t.insertMention(e.userId);else if(e.event){var n;null===(n=this.editorRef.current)||void 0===n||n.insertQuotedMessage(e.event)}else if(e.text){var i;null===(i=this.editorRef.current)||void 0===i||i.insertPlaintext(e.text)}else if(e.emoji){var s;null===(s=this.editorRef.current)||void 0===s||s.insertEmoji(e.emoji)}}else e.action===w.a.FocusEditMessageComposer&&this.editorRef.current.focus()})),this.context=t;const n=this.createEditorModel(),i=this.props.editState.getEvent(),r=M(this.model,i);this.state={saveDisabled:!n||!this.isContentModified(r["m.new_content"])},window.addEventListener("beforeunload",this.saveStoredEditorState),this.dispatcherRef=m.a.register(this.onAction)}getRoom(){return this.props.mxClient.getRoom(this.props.editState.getEvent().getRoomId())}endEdit(){localStorage.removeItem(this.editorRoomKey),localStorage.removeItem(this.editorStateKey),m.a.dispatch({action:w.a.EditEvent,event:null,timelineRenderingType:this.context.timelineRenderingType}),m.a.dispatch({action:w.a.FocusSendMessageComposer,context:this.context.timelineRenderingType})}get editorRoomKey(){return Object(N.a)(this.props.editState.getEvent().getRoomId(),this.context.timelineRenderingType)}get editorStateKey(){return Object(N.b)(this.props.editState.getEvent().getId())}get events(){const e=this.context.liveTimeline.getEvents(),t=this.getRoom().getPendingEvents(),n=Boolean(this.props.editState.getEvent().getThread());return e.concat(n?[]:t)}get shouldSaveStoredEditorState(){return null!==localStorage.getItem(this.editorRoomKey)}restoreStoredEditorState(e){const t=localStorage.getItem(this.editorStateKey);if(t)try{const{parts:n}=JSON.parse(t);return n.map((t=>e.deserializePart(t)))}catch(e){u.a.error("Error parsing editing state: ",e)}}clearPreviousEdit(){localStorage.getItem(this.editorRoomKey)&&localStorage.removeItem(`mx_edit_state_${localStorage.getItem(this.editorRoomKey)}`)}isContentModified(e){const t=this.props.editState.getEvent().getContent();return t.msgtype!==e.msgtype||t.body!==e.body||t.format!==e.format||t.formatted_body!==e.formatted_body}cancelPreviousPendingEdit(){const e=this.props.editState.getEvent().replacingEvent();!e||e.status!==l.a.QUEUED&&e.status!==l.a.NOT_SENT||this.props.mxClient.cancelPendingEvent(e)}componentWillUnmount(){const e=document.getSelection();let t;var n;e.focusNode&&(t=Object(g.a)(null===(n=this.editorRef.current)||void 0===n?void 0:n.editorRef.current,e).caret);const i=this.model.serializeParts();this.props.editState.setEditorState(t,i),window.removeEventListener("beforeunload",this.saveStoredEditorState),this.shouldSaveStoredEditorState&&this.saveStoredEditorState(),m.a.unregister(this.dispatcherRef)}createEditorModel(){const{editState:e}=this.props,t=this.getRoom(),n=new y.a(t,this.props.mxClient);let i,s=!1;if(e.hasEditorState())i=e.getSerializedParts().map((e=>n.deserializePart(e)));else{const t=this.restoreStoredEditorState(n);i=t||Object(b.b)(e.getEvent(),n,{shouldEscape:R.b.getValue("MessageComposerInput.useMarkdown")}),s=!!t}return this.model=new p.a(i,n),this.saveStoredEditorState(),s}render(){var e,t,n;return r.a.createElement("div",{className:c()("mx_EditMessageComposer",this.props.className),onKeyDown:this.onKeyDown},r.a.createElement(S.b,{ref:this.editorRef,model:this.model,room:this.getRoom(),threadId:null===(e=this.props.editState)||void 0===e||null===(t=e.getEvent())||void 0===t||null===(n=t.getThread())||void 0===n?void 0:n.id,initialCaret:this.props.editState.getCaret(),label:Object(h.a)("Edit message"),onChange:this.onChange}),r.a.createElement("div",{className:"mx_EditMessageComposer_buttons"},r.a.createElement(O.a,{kind:"secondary",onClick:this.cancelEdit},Object(h.a)("Cancel")),r.a.createElement(O.a,{kind:"primary",onClick:this.sendEdit,disabled:this.state.saveDisabled},Object(h.a)("Save"))))}}s()(A,"contextType",x.b);const L=Object(k.c)(A);t.a=L},,,function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return r}));var i,s=n(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),i||(i=s.createElement("path",{d:"M21.276 4.696a1.579 1.579 0 10-2.233-2.233l-7.151 7.151-7.151-7.15a1.579 1.579 0 10-2.233 2.232l7.15 7.151-7.457 7.458a1.579 1.579 0 002.233 2.233l7.458-7.458 7.457 7.458a1.579 1.579 0 002.233-2.233l-7.458-7.458 7.152-7.15z",fill:"#757575"})))}t.default="img/cancel.ad0185f.svg"},,,,,,,,,,,function(e,t,n){"use strict";n.r(t),n.d(t,"Icon",(function(){return a}));var i,s,o=n(120);function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},r.apply(this,arguments)}function a(e){return o.createElement("svg",r({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 500 500",role:"presentation","aria-hidden":!0},e),i||(i=o.createElement("path",{fill:"#8BC34A",d:"M250 500c138.571 0 250-111.43 250-250C500 111.429 388.571 0 250 0S0 111.429 0 250c0 138.57 111.429 250 250 250z",opacity:.15})),s||(s=o.createElement("path",{fill:"none",stroke:"#8BC34A",strokeWidth:12,strokeMiterlimit:10,d:"M249 430c-98.996 0-180-81.003-180-180 0-98.998 81.005-180 180-180 98.994 0 180 81.001 180 180 0 98.997-81.005 180-180 180zm72.8-200.8c17.685 0 31.201-13.518 31.201-31.2s-13.519-31.2-31.201-31.2c-17.682 0-31.2 13.518-31.2 31.2s13.518 31.2 31.2 31.2zm-145.6 0c17.682 0 31.2-13.518 31.2-31.2s-13.519-31.2-31.2-31.2c-17.683 0-31.201 13.518-31.201 31.2s13.519 31.2 31.201 31.2zM249 364.4c48.883 0 89.436-30.164 106.081-72.801H142.919C159.564 334.236 200.117 364.4 249 364.4z"})))}t.default="img/icons-show-stickers.9a3a457.svg"},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(122),s=n.n(i),o=n(1571),r=n(179),a=n(211);class c{constructor(e){var t=this;this.store=e,s()(this,"filter",new o.a),s()(this,"activeSpace",r.a.instance.activeSpace),s()(this,"allRoomsInHome",r.a.instance.allRoomsInHome),s()(this,"onSelectedSpaceUpdated",(function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.allRoomsInHome;if(e===t.activeSpace&&n===t.allRoomsInHome)return;const i=c.needsFilter(t.activeSpace,t.allRoomsInHome),s=c.needsFilter(e,n);t.activeSpace=e,t.allRoomsInHome=n,s&&t.updateFilter(),!i&&s?t.store.addFilter(t.filter):i&&!s&&t.store.removeFilter(t.filter)})),s()(this,"onHomeBehaviourUpdated",(e=>{this.onSelectedSpaceUpdated(this.activeSpace,e)})),s()(this,"updateFilter",(()=>{this.filter.updateSpace(this.activeSpace)})),c.needsFilter(this.activeSpace,this.allRoomsInHome)&&(this.updateFilter(),e.addFilter(this.filter)),r.a.instance.on(a.d,this.onSelectedSpaceUpdated),r.a.instance.on(a.b,this.onHomeBehaviourUpdated)}static needsFilter(e,t){return!(e===a.a.Home&&t)}}},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return u}));var i=n(122),s=n.n(i),o=n(17),r=n(743),a=n(179),c=n(211),l=n(863),d=n(126);class u extends o.EventEmitter{constructor(){var t;super(...arguments),t=this,s()(this,"roomIds",new Set),s()(this,"userIds",new Set),s()(this,"showPeopleInSpace",!0),s()(this,"space",c.a.Home),s()(this,"onStoreUpdate",(async function(){let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const i=t.roomIds;t.roomIds=new Set(a.a.instance.getSpaceFilteredRoomIds(t.space));const s=t.userIds;t.userIds=new Set(a.a.instance.getSpaceFilteredUserIds(t.space));const o=t.showPeopleInSpace;t.showPeopleInSpace=Object(c.h)(t.space[0])||d.b.getValue("Spaces.showPeopleInSpace",t.space),(n||o!==t.showPeopleInSpace||Object(l.b)(i,t.roomIds)||Object(l.b)(s,t.userIds))&&(t.emit(r.a),e((()=>{t.emit(r.a)})))}))}isVisible(e){return a.a.instance.isRoomInSpace(this.space,e.roomId)}updateSpace(e){a.a.instance.off(this.space,this.onStoreUpdate),a.a.instance.on(this.space=e,this.onStoreUpdate),this.onStoreUpdate(!0)}destroy(){a.a.instance.off(this.space,this.onStoreUpdate)}}}).call(this,n(54).setImmediate)},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var i=n(122),s=n.n(i),o=n(1),r=n(526),a=n(192),c=n(297),l=n(203),d=n(904),u=n(211),h=n(228),m=n(154);const p={[c.b.Alphabetic]:["by_name","by_recency"],[c.b.Recent]:["by_notification_level","by_recency"],[c.b.Manual]:["by_recency"]},g={[a.a.Invite]:{is_invite:!0},[a.a.Favourite]:{tags:["m.favourite"]},[a.a.DM]:{is_dm:!0,is_invite:!1,not_tags:["m.favourite","m.lowpriority"]},[a.a.Untagged]:{is_dm:!1,is_invite:!1,not_room_types:["m.space"],not_tags:["m.favourite","m.lowpriority"]},[a.a.LowPriority]:{tags:["m.lowpriority"],not_tags:["m.favourite"]}},v=d.a.ListsUpdate;class f extends l.a{constructor(e,t){super(e),this.context=t,s()(this,"tagIdToSortAlgo",{}),s()(this,"tagMap",{}),s()(this,"counts",{}),s()(this,"stickyRoomId",void 0),s()(this,"onSelectedSpaceUpdated",((e,t)=>{var n;o.a.info("SlidingRoomListStore.onSelectedSpaceUpdated",e);const i=a.a.Untagged,s=g[i],r=null===(n=s.spaces)||void 0===n?void 0:n[0];s.spaces=e&&e!=u.a.Home?[e]:void 0,r!==e&&(this.context.spaceStore.traverseSpace(e,(t=>{t!==e&&(s.spaces||(s.spaces=[]),s.spaces.push(t))}),!1),this.emit(h.a,i,!0),this.context.slidingSyncManager.ensureListRegistered(i,{filters:s}).then((()=>{this.emit(h.a,i,!1)})))})),this.setMaxListeners(20)}async setTagSorting(e,t){switch(o.a.info("SlidingRoomListStore.setTagSorting ",e,t),this.tagIdToSortAlgo[e]=t,t){case c.b.Alphabetic:await this.context.slidingSyncManager.ensureListRegistered(e,{sort:p[c.b.Alphabetic]});break;case c.b.Recent:await this.context.slidingSyncManager.ensureListRegistered(e,{sort:p[c.b.Recent]});break;case c.b.Manual:o.a.error("cannot enable manual sort in sliding sync mode");break;default:o.a.error("unknown sort mode: ",t)}}getTagSorting(e){let t=this.tagIdToSortAlgo[e];return t||(o.a.warn("SlidingRoomListStore.getTagSorting: no sort algorithm for tag ",e),t=c.b.Recent),t}getCount(e){return this.counts[e]||0}setListOrder(e,t){}getListOrder(e){return c.a.Natural}async addFilter(e){}removeFilter(e){}getTagsForRoom(e){const t=[];for(const n in this.tagIdToSortAlgo){const i=this.context.slidingSyncManager.slidingSync.getListData(n);if(i)for(const s in i.roomIndexToRoomId){if(i.roomIndexToRoomId[s]===e.roomId){t.push(n);break}}}return t}async manualRoomUpdate(e,t){}get orderedLists(){return this.tagMap}refreshOrderedLists(e,t){const n=this.tagMap;this.stickyRoomId=this.context.roomViewStore.getRoomId();let i=-1;const s=(n[e]||[]).findIndex((e=>e.roomId===this.stickyRoomId)),r=Object.keys(t).map((e=>Number(e))).sort(((e,t)=>e-t)),a=new Set,c=r.map((e=>{const n=t[e];if(a.has(n)&&o.a.error("room "+n+" already has an index position: duplicate room!"),a.add(n),!n)throw new Error("index "+e+" has no room ID: Map => "+JSON.stringify(t));return n===this.stickyRoomId&&(i=e),n}));if(o.a.debug(`SlidingRoomListStore.refreshOrderedLists ${e} sticky: ${this.stickyRoomId}`,`${s} -> ${i}`,"rooms:",c.length<30?c:c.length),this.stickyRoomId&&s>=0&&i>=0){const e=c[s];c[s]=this.stickyRoomId,c[i]=e}const l=[];c.forEach((e=>{const t=this.matrixClient.getRoom(e);t&&l.push(t)})),n[e]=l,this.tagMap=n}onSlidingSyncListUpdate(e,t,n){this.counts[e]=t,this.refreshOrderedLists(e,n),this.emit(v)}onRoomViewStoreUpdated(){if(this.context.roomViewStore.getRoomId()===this.stickyRoomId)return;let e=!1;const t=this.stickyRoomId;for(const n in this.orderedLists){if(this.orderedLists[n].find((e=>e.roomId===t))){const t=this.context.slidingSyncManager.slidingSync.getListData(n);if(!t)continue;this.refreshOrderedLists(n,t.roomIndexToRoomId),e=!0}}this.stickyRoomId=this.context.roomViewStore.getRoomId(),e&&this.emit(v)}async onReady(){o.a.info("SlidingRoomListStore.onReady"),this.context.slidingSyncManager.slidingSync.on(r.f.List,this.onSlidingSyncListUpdate.bind(this)),this.context.roomViewStore.addListener(m.b,this.onRoomViewStoreUpdated.bind(this)),this.context.spaceStore.on(u.d,this.onSelectedSpaceUpdated.bind(this)),this.context.spaceStore.activeSpace&&this.onSelectedSpaceUpdated(this.context.spaceStore.activeSpace,!1),a.b.forEach((e=>{const t=g[e];if(!t)return void o.a.info("SlidingRoomListStore.onReady unsupported list ",e);const n=c.b.Recent;this.tagIdToSortAlgo[e]=n,this.emit(h.a,e,!0),this.context.slidingSyncManager.ensureListRegistered(e,{filters:t,sort:p[n]}).then((()=>{this.emit(h.a,e,!1)}))}))}async resetStore(){}regenerateAllLists(e){let{trigger:t=!0}=e}async onNotReady(){await this.resetStore()}async onAction(e){}async onDispatchAsync(e){}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return v})),n.d(t,"a",(function(){return b}));var i=n(120),s=n.n(i),o=n(121),r=n(165),a=n(123),c=n(125),l=n(129),d=n(194),u=n(148),h=n(638),m=n(283),p=n(314),g=n(241);const v=e=>`call_${e}`;function f(e){let{onClick:t,call:n}=e;const i=Object(m.d)(n);return s.a.createElement(u.a,{className:"mx_IncomingCallToast_joinButton",onClick:t,disabled:null!==i,tooltip:i,kind:"primary"},Object(o.a)("Join"))}function b(e){var t;let{callEvent:n}=e;const b=n.getRoomId(),y=null!==(t=a.a.get().getRoom(b))&&void 0!==t?t:void 0,S=Object(m.a)(b),E=Object(i.useCallback)((()=>{d.a.sharedInstance().dismissToast(v(n.getStateKey()))}),[n]),w=Object(p.a)(y,Object(i.useCallback)((e=>e.getStateEvents(n.getType(),n.getStateKey())),[n]));Object(i.useEffect)((()=>{"m.terminated"in w.getContent()&&E()}),[w,E]),Object(g.a)(c.a,Object(i.useCallback)((e=>{e.action===l.a.ViewRoom&&e.room_id===b&&e.view_call&&E()}),[b,E]));const _=Object(i.useCallback)((e=>{e.stopPropagation(),c.a.dispatch({action:l.a.ViewRoom,room_id:null==y?void 0:y.roomId,view_call:!0,metricsTrigger:void 0}),E()}),[y,E]),C=Object(i.useCallback)((e=>{e.stopPropagation(),E()}),[E]);return s.a.createElement(s.a.Fragment,null,s.a.createElement(r.a,{room:null!=y?y:void 0,height:24,width:24}),s.a.createElement("div",{className:"mx_IncomingCallToast_content"},s.a.createElement("div",{className:"mx_IncomingCallToast_info"},s.a.createElement("span",{className:"mx_IncomingCallToast_room"},y?y.name:Object(o.a)("Unknown room")),s.a.createElement("div",{className:"mx_IncomingCallToast_message"},Object(o.a)("Video call started")),S?s.a.createElement(h.b,{call:S}):s.a.createElement(h.a,{type:h.c.Video,text:Object(o.a)("Video"),active:!1,participantCount:0})),S?s.a.createElement(f,{onClick:_,call:S}):s.a.createElement(u.a,{className:"mx_IncomingCallToast_joinButton",onClick:_,kind:"primary"},Object(o.a)("Join"))),s.a.createElement(u.a,{className:"mx_IncomingCallToast_closeButton",onClick:C,title:Object(o.a)("Close")}))}},function(e,t){e.exports="img/betas/video_rooms.c485b71.png"},,,,,,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return c}));var i=n(315),s=n.n(i);function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const a={bgColor:"#d00",textColor:"#fff",fontFamily:"sans-serif",fontWeight:"bold",isUp:!1,isLeft:!1};class c{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s()(this,"browser",{ff:void 0!==window.InstallTrigger,opera:!!window.opera||navigator.userAgent.includes("Opera")}),s()(this,"params",void 0),s()(this,"canvas",void 0),s()(this,"baseImage",void 0),s()(this,"context",void 0),s()(this,"icons",void 0),s()(this,"isReady",!1),s()(this,"readyCb",void 0),this.params=r(r({},a),e),this.icons=c.getIcons(),this.canvas=document.createElement("canvas"),this.baseImage=document.createElement("img");const t=this.icons[this.icons.length-1];t.hasAttribute("href")?(this.baseImage.setAttribute("crossOrigin","anonymous"),this.baseImage.onload=()=>{this.canvas.height=this.baseImage.height>0?this.baseImage.height:32,this.canvas.width=this.baseImage.width>0?this.baseImage.width:32,this.context=this.canvas.getContext("2d"),this.ready()},this.baseImage.setAttribute("src",t.getAttribute("href"))):(this.canvas.height=this.baseImage.height=32,this.canvas.width=this.baseImage.width=32,this.context=this.canvas.getContext("2d"),this.ready())}reset(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height)}options(e,t){const n={n:"number"==typeof e?Math.abs(e):e,len:(""+e).length,x:.4,y:.4,w:.6,h:.6};return t.isUp&&(n.y<.6?n.y=n.y-.4:n.y=n.y-2*n.y+(1-n.w)),t.isLeft&&(n.x<.6?n.x=n.x-.4:n.x=n.x-2*n.x+(1-n.h)),n.x=this.canvas.width*n.x,n.y=this.canvas.height*n.y,n.w=this.canvas.width*n.w,n.h=this.canvas.height*n.h,n}circle(e,t){const n=r(r({},this.params),t),i=this.options(e,n);let s=!1;2===i.len?(i.x=i.x-.4*i.w,i.w=1.4*i.w,s=!0):i.len>=3&&(i.x=i.x-.65*i.w,i.w=1.65*i.w,s=!0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height),this.context.beginPath();const o=Math.floor(i.h*(i.n>99?.85:1))+"px";if(this.context.font=`${n.fontWeight} ${o} ${n.fontFamily}`,this.context.textAlign="center",s?(this.context.moveTo(i.x+i.w/2,i.y),this.context.lineTo(i.x+i.w-i.h/2,i.y),this.context.quadraticCurveTo(i.x+i.w,i.y,i.x+i.w,i.y+i.h/2),this.context.lineTo(i.x+i.w,i.y+i.h-i.h/2),this.context.quadraticCurveTo(i.x+i.w,i.y+i.h,i.x+i.w-i.h/2,i.y+i.h),this.context.lineTo(i.x+i.h/2,i.y+i.h),this.context.quadraticCurveTo(i.x,i.y+i.h,i.x,i.y+i.h-i.h/2),this.context.lineTo(i.x,i.y+i.h/2),this.context.quadraticCurveTo(i.x,i.y,i.x+i.h/2,i.y)):this.context.arc(i.x+i.w/2,i.y+i.h/2,i.h/2,0,2*Math.PI),this.context.fillStyle=n.bgColor,this.context.fill(),this.context.closePath(),this.context.beginPath(),this.context.stroke(),this.context.fillStyle=n.textColor,"number"==typeof i.n&&i.n>999){const e=(i.n>9999?9:Math.floor(i.n/1e3))+"k+";this.context.fillText(e,Math.floor(i.x+i.w/2),Math.floor(i.y+i.h-.2*i.h))}else this.context.fillText(""+i.n,Math.floor(i.x+i.w/2),Math.floor(i.y+i.h-.15*i.h));this.context.closePath()}ready(){var e;this.isReady||(this.isReady=!0,null===(e=this.readyCb)||void 0===e||e.call(this))}setIcon(t){e((()=>{this.setIconSrc(t.toDataURL("image/png"))}))}setIconSrc(e){if(this.browser.ff||this.browser.opera){var t;const n=this.icons[this.icons.length-1],i=window.document.createElement("link");this.icons=[i],i.setAttribute("rel","icon"),i.setAttribute("type","image/png"),window.document.getElementsByTagName("head")[0].appendChild(i),i.setAttribute("href",e),null===(t=n.parentNode)||void 0===t||t.removeChild(n)}else this.icons.forEach((t=>{t.setAttribute("href",e)}))}badge(e,t){this.isReady?("string"==typeof e||e>0?this.circle(e,t):this.reset(),this.setIcon(this.canvas)):this.readyCb=()=>{this.badge(e,t)}}static getLinks(){const e=[],t=window.document.getElementsByTagName("head")[0].getElementsByTagName("link");for(const n of t)/(^|\s)icon(\s|$)/i.test(n.getAttribute("rel"))&&e.push(n);return e}static getIcons(){let e=c.getLinks();return 0===e.length&&(e=[window.document.createElement("link")],e[0].setAttribute("rel","icon"),window.document.getElementsByTagName("head")[0].appendChild(e[0])),e.forEach((e=>{e.setAttribute("type","image/png")})),e}}}).call(this,n(54).setImmediate)},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return I})),n.d(t,"a",(function(){return k}));var i=n(122),s=n.n(i),o=n(16),r=n(17),a=n(1),c=n(164),l=n(147),d=n(192),u=n(246),h=n(297);var m=n(448);const p={[h.b.Recent]:new m.a,[h.b.Alphabetic]:new class{sortRooms(e,t){return e.sort(((e,t)=>Object(o.h)(e.name,t.name)))}},[h.b.Manual]:new class{sortRooms(e,t){const n=e=>e.tags[t].order||0;return e.sort(((e,t)=>n(e)-n(t)))}}};function g(e,t,n){return function(e){if(!p[e])throw new Error(`${e} is not a known algorithm`);return p[e]}(n).sortRooms(e,t)}class v{constructor(e,t){this.tagId=e,s()(this,"cachedOrderedRooms",void 0),s()(this,"sortingAlgorithm",void 0),this.setSortAlgorithm(t)}get orderedRooms(){return this.cachedOrderedRooms||[]}setSortAlgorithm(e){if(!e)throw new Error("A sorting algorithm must be defined");this.sortingAlgorithm=e,this.setRooms(this.orderedRooms)}getRoomIndex(e){let t=this.cachedOrderedRooms.indexOf(e);return-1===t&&(a.a.warn(`Degrading performance to find missing room in "${this.tagId}": ${e.roomId}`),t=this.cachedOrderedRooms.findIndex((t=>t.roomId===e.roomId))),t}}var f=n(205),b=n(218);const y=[f.a.Unsent,f.a.Red,f.a.Grey,f.a.Bold,f.a.None];class S extends v{constructor(e,t){super(e,t),s()(this,"indices",{})}categorizeRooms(e){const t={[f.a.Unsent]:[],[f.a.Red]:[],[f.a.Grey]:[],[f.a.Bold]:[],[f.a.None]:[]};for(const n of e){t[this.getRoomCategory(n)].push(n)}return t}getRoomCategory(e){return b.a.instance.getRoomState(e).color}setRooms(e){if(this.sortingAlgorithm===h.b.Manual)this.cachedOrderedRooms=g(e,this.tagId,this.sortingAlgorithm);else{const t=this.categorizeRooms(e);for(const e of Object.keys(t)){const n=e,i=t[n];t[n]=g(i,this.tagId,this.sortingAlgorithm)}const n=[],i={};for(const e of y)i[e]=n.length,n.push(...t[e]);this.indices=i,this.cachedOrderedRooms=n}}handleSplice(e,t){if(t===d.c.NewRoom){const t=this.getRoomCategory(e);this.alterCategoryPositionBy(t,1,this.indices),this.cachedOrderedRooms.splice(this.indices[t],0,e),this.sortCategory(t)}else{if(t!==d.c.RoomRemoved)throw new Error(`Unhandled splice: ${t}`);{const t=this.getRoomIndex(e);if(-1===t)return a.a.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`),!1;const n=this.getCategoryFromIndices(t,this.indices);this.alterCategoryPositionBy(n,-1,this.indices),this.cachedOrderedRooms.splice(t,1)}}return!0}handleRoomUpdate(e,t){if(t===d.c.NewRoom||t===d.c.RoomRemoved)return this.handleSplice(e,t);if(t!==d.c.Timeline&&t!==d.c.ReadReceipt)throw new Error(`Unsupported update cause: ${t}`);const n=this.getRoomCategory(e);if(this.sortingAlgorithm===h.b.Manual)return;const i=this.getRoomIndex(e);if(-1===i)throw new Error(`Room ${e.roomId} has no index in ${this.tagId}`);const s=this.getCategoryFromIndices(i,this.indices);return s!==n&&(this.moveRoomIndexes(1,s,n,this.indices),this.cachedOrderedRooms.splice(i,1),this.cachedOrderedRooms.splice(this.indices[n],0,e)),this.sortCategory(n),!0}sortCategory(e){const t=e===y[y.length-1]?Number.MAX_SAFE_INTEGER:this.indices[y[y.indexOf(e)+1]],n=this.indices[e],i=t-n,s=g(this.cachedOrderedRooms.splice(n,i),this.tagId,this.sortingAlgorithm);this.cachedOrderedRooms.splice(n,0,...s)}getCategoryFromIndices(e,t){for(let n=0;n<y.length;n++){const i=y[n],s=n===y.length-1,o=t[i],r=s?Number.MAX_SAFE_INTEGER:t[y[n+1]];if(e>=o&&e<r)return i}throw new Error("Programming error: somehow you've ended up with an index that isn't in a category")}moveRoomIndexes(e,t,n,i){this.alterCategoryPositionBy(t,-e,i),this.alterCategoryPositionBy(n,+e,i)}alterCategoryPositionBy(e,t,n){const i=y.indexOf(e)+1;if(t>0)for(let e=i;e<y.length;e++){n[y[e]]+=Math.abs(t)}else if(t<0)for(let e=i;e<y.length;e++){n[y[e]]-=Math.abs(t)}for(let e=1;e<=y.length;e++){const t=y[e-1],i=y[e];n[t]>n[i]&&a.a.warn(`!! Room list index corruption: ${t} (i:${n[t]}) is greater than ${i} (i:${n[i]}) - category indices are likely desynced from reality`)}}}class E extends v{constructor(e,t){super(e,t)}setRooms(e){this.cachedOrderedRooms=g(e,this.tagId,this.sortingAlgorithm)}handleRoomUpdate(e,t){const n=t===d.c.NewRoom||t===d.c.RoomRemoved,i=t===d.c.Timeline||t===d.c.ReadReceipt;if(!n&&!i)throw new Error(`Unsupported update cause: ${t}`);if(t===d.c.NewRoom)this.cachedOrderedRooms.push(e);else if(t===d.c.RoomRemoved){const t=this.getRoomIndex(e);t>=0?this.cachedOrderedRooms.splice(t,1):a.a.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`)}return this.cachedOrderedRooms=g(this.cachedOrderedRooms,this.tagId,this.sortingAlgorithm),!0}}const w={[h.a.Natural]:(e,t)=>new E(e,t),[h.a.Importance]:(e,t)=>new S(e,t)};function _(e,t,n){if(!w[e])throw new Error(`${e} is not a known algorithm`);return w[e](t,n)}var C=n(693),O=n(310);const I="list_updated_event",R=[d.c.Timeline,d.c.ReadReceipt];class k extends r.EventEmitter{constructor(){super(...arguments),s()(this,"_cachedRooms",{}),s()(this,"_cachedStickyRooms",{}),s()(this,"_stickyRoom",null),s()(this,"_lastStickyRoom",null),s()(this,"sortAlgorithms",null),s()(this,"listAlgorithms",null),s()(this,"algorithms",null),s()(this,"rooms",[]),s()(this,"roomIdsToTags",{}),s()(this,"updatesInhibited",!1),s()(this,"unifiedRoomList",void 0),s()(this,"onActiveCalls",(()=>{this.recalculateStickyRoom(),this.recalculateActiveCallRooms(),this.updatesInhibited||this.emit(I,!0)}))}start(){O.a.instance.on(O.b.ActiveCalls,this.onActiveCalls)}stop(){O.a.instance.off(O.b.ActiveCalls,this.onActiveCalls)}get stickyRoom(){return this._stickyRoom?this._stickyRoom.room:null}get knownRooms(){return this.rooms}get hasTagSortingMap(){return!!this.sortAlgorithms}set cachedRooms(e){this._cachedRooms=e,this.recalculateStickyRoom(),this.recalculateActiveCallRooms()}get cachedRooms(){return this._cachedRooms}setStickyRoom(e){try{this.updateStickyRoom(e)}catch(e){a.a.warn("Failed to update sticky room",e)}}getTagSorting(e){return this.sortAlgorithms?this.sortAlgorithms[e]:null}setTagSorting(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");if(!this.sortAlgorithms)throw new Error("this.sortAlgorithms must be defined before calling setTagSorting");if(!this.algorithms)throw new Error("this.algorithms must be defined before calling setTagSorting");this.sortAlgorithms[e]=t;const n=this.algorithms[e];n.setSortAlgorithm(t),this._cachedRooms[e]=n.orderedRooms,this.recalculateStickyRoom(e),this.recalculateActiveCallRooms(e)}getListOrdering(e){return this.listAlgorithms?this.listAlgorithms[e]:null}setListOrdering(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");if(!this.sortAlgorithms)throw new Error("this.sortAlgorithms must be defined before calling setListOrdering");if(!this.listAlgorithms)throw new Error("this.listAlgorithms must be defined before calling setListOrdering");if(!this.algorithms)throw new Error("this.algorithms must be defined before calling setListOrdering");this.listAlgorithms[e]=t;const n=_(t,e,this.sortAlgorithms[e]);this.algorithms[e]=n,n.setRooms(this._cachedRooms[e]),this._cachedRooms[e]=n.orderedRooms,this.recalculateStickyRoom(e),this.recalculateActiveCallRooms(e)}setUnifiedRoomList(e){this.unifiedRoomList=e}updateStickyRoom(e){this.doUpdateStickyRoom(null),this._lastStickyRoom=null}doUpdateStickyRoom(e){var t,n;if(null!==(t=e)&&void 0!==t&&t.isSpaceRoom()&&"invite"!==e.getMyMembership()&&(e=null),e&&!C.a.instance.isRoomVisible(e)&&(e=null),this._lastStickyRoom=this._stickyRoom||{},!e){if(this._stickyRoom){const e=this._stickyRoom.room;return this._stickyRoom=null,void this.handleRoomUpdate(e,d.c.NewRoom)}return}let i=null===(n=this.roomIdsToTags[e.roomId])||void 0===n?void 0:n[0];if(!i)throw new Error(`${e.roomId} does not belong to a tag and cannot be sticky`);let s=(this.getOrderedRoomsWithoutSticky()[i]||[]).indexOf(e);const o=!!this._lastStickyRoom.room&&this._lastStickyRoom.room.roomId===e.roomId;if(this._lastStickyRoom.tag&&i!==this._lastStickyRoom.tag&&o&&s<0&&(a.a.warn(`Sticky room ${e.roomId} changed tags during sticky room handling`),s=0),s<0)throw new Error(`${e.roomId} does not appear to be known and cannot be sticky`);const r=this._stickyRoom;if(this._stickyRoom=null,this.recalculateStickyRoom(),r&&r.room&&r.room.roomId!==e.roomId&&this.handleRoomUpdate(r.room,d.c.NewRoom),this.handleRoomUpdate(e,d.c.RoomRemoved),this._stickyRoom=this.stickyRoomMightBeModified(),this._stickyRoom){if(this._stickyRoom.room!==e){if(this._stickyRoom.room.roomId!==e.roomId)throw new Error("Sticky room changed while the sticky room was changing");a.a.warn("Sticky room changed references")}a.a.warn(`Sticky room changed tag & position from ${i} / ${s} to ${this._stickyRoom.tag} / ${this._stickyRoom.position}`),i=this._stickyRoom.tag,s=this._stickyRoom.position}r&&r.tag===i&&r.position<=s&&s++,this._stickyRoom={room:e,position:s,tag:i},this.recalculateStickyRoom(),this.recalculateActiveCallRooms(i),r&&r.tag!==i&&this.recalculateActiveCallRooms(r.tag),this.updatesInhibited||this.emit(I)}stickyRoomMightBeModified(){return this._stickyRoom}initCachedStickyRooms(){this._cachedStickyRooms={};for(const e of Object.keys(this.cachedRooms))this._cachedStickyRooms[e]=[...this.cachedRooms[e]]}recalculateStickyRoom(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this._stickyRoom){if(this._cachedStickyRooms){if(this._cachedStickyRooms=null,this.updatesInhibited)return;this.emit(I)}return}this._cachedStickyRooms&&e||this.initCachedStickyRooms(),e&&this._cachedStickyRooms&&(this._cachedStickyRooms[e]=[...this.cachedRooms[e]]);const t=this._stickyRoom;!t||e&&e!==t.tag||!this._cachedStickyRooms||this._cachedStickyRooms[t.tag].splice(t.position,0,t.room),this.updatesInhibited||this.emit(I)}recalculateActiveCallRooms(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(e){if(O.a.instance.activeCalls.size){this._cachedStickyRooms||this.initCachedStickyRooms();const t=this._cachedStickyRooms[e],n=new Set([...O.a.instance.activeCalls].map((e=>e.roomId))),i=[],s=[];for(const e of t)(n.has(e.roomId)?i:s).push(e);this._cachedStickyRooms[e]=[...i,...s]}}else for(const e of Object.keys(this.cachedRooms)){if(!e)throw new Error("Unexpected recursion: falsy tag");this.recalculateActiveCallRooms(e)}}populateTags(e,t){if(!e)throw new Error("Sorting map cannot be null or empty");if(!t)throw new Error("Ordering ma cannot be null or empty");if(Object(l.d)(Object.keys(e),Object.keys(t)))throw new Error("Both maps must contain the exact same tags");this.sortAlgorithms=e,this.listAlgorithms=t,this.algorithms={};for(const t of Object.keys(e))this.algorithms[t]=_(this.listAlgorithms[t],t,this.sortAlgorithms[t]);return this.setKnownRooms(this.rooms)}getOrderedRooms(){return this._cachedStickyRooms||this.cachedRooms}getOrderedRoomsWithoutSticky(){return this.cachedRooms}setKnownRooms(e){if(Object(o.u)(e))throw new Error("Array of rooms cannot be null");if(!this.sortAlgorithms)throw new Error("Cannot set known rooms without a tag sorting map");this.updatesInhibited||a.a.warn("Resetting known rooms, initiating regeneration");const t=this._stickyRoom;t&&this.updateStickyRoom(null),this.rooms=e;const n={};for(const e in this.sortAlgorithms)n[e]=[];if(!e.length)return this.generateFreshTags(n),void(this.cachedRooms=n);const i=Object(u.d)(e);for(const e of i[u.a.Invite])n[d.a.Invite].push(e);for(const e of i[u.a.Leave])n[d.a.Archived].push(e);for(const e of i[u.a.Join]){const t=this.getTagsOfJoinedRoom(e);let i=!1;if(t.length>0)for(const s of t)Object(o.u)(n[s])||(n[s].push(e),i=!0);i||(c.a.shared().getUserIdForRoomId(e.roomId)?this.unifiedRoomList?n[d.a.Unified].push(e):n[d.a.DM].push(e):this.unifiedRoomList?n[d.a.Unified].push(e):n[d.a.Untagged].push(e))}this.generateFreshTags(n),this.cachedRooms=n,this.updateTagsFromCache(),t&&t.room&&(this.updateStickyRoom(t.room),this._stickyRoom&&this._stickyRoom.room&&this._stickyRoom.tag!==t.tag&&(this._stickyRoom.position=0,this.recalculateStickyRoom(this._stickyRoom.tag)))}getTagsForRoom(e){const t=[],n=Object(u.b)(e.getMyMembership());return n===u.a.Invite?t.push(d.a.Invite):n===u.a.Leave?t.push(d.a.Archived):t.push(...this.getTagsOfJoinedRoom(e)),t.length||(this.unifiedRoomList?t.push(d.a.Unified):t.push(d.a.Untagged)),t}getTagsOfJoinedRoom(e){let t=Object.keys(e.tags||{});return 0===t.length&&c.a.shared().getUserIdForRoomId(e.roomId)&&(t=this.unifiedRoomList?[d.a.Unified]:[d.a.DM]),t}updateTagsFromCache(){const e={},t=Object.keys(this.cachedRooms);for(const n of t){const t=this.cachedRooms[n];for(const i of t)e[i.roomId]||(e[i.roomId]=[]),e[i.roomId].push(n)}this.roomIdsToTags=e}generateFreshTags(e){if(!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");for(const t of Object.keys(e)){const n=this.algorithms[t];if(!n)throw new Error(`No algorithm for ${t}`);n.setRooms(e[t]),e[t]=n.orderedRooms}}handleRoomUpdate(e,t){var n,i;if(!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");const s=(null===(n=this._stickyRoom)||void 0===n||null===(i=n.room)||void 0===i?void 0:i.roomId)===e.roomId;if(t===d.c.NewRoom){var r;const n=(null===(r=this._lastStickyRoom)||void 0===r?void 0:r.room)===e,i=this.roomIdsToTags[e.roomId],o=i&&i.length>0;o&&!n&&(a.a.warn(`${e.roomId} is reportedly new but is already known - assuming TagChange instead`),t=d.c.PossibleTagChange);let c=this.rooms.includes(e);if(o&&!c&&(a.a.warn(`${e.roomId} might be a reference change - attempting to update reference`),this.rooms=this.rooms.map((t=>t.roomId===e.roomId?e:t)),c=this.rooms.includes(e),c||a.a.warn(`${e.roomId} is still not referenced. It may be sticky.`)),o&&!c&&!s)throw new Error(`${e.roomId} is missing from room array but is known - trying to find duplicate`);o&&s&&this._stickyRoom&&(this._stickyRoom.room=e),t!==d.c.NewRoom||s||c||this.rooms.push(e)}let c=!1;if(t===d.c.PossibleTagChange){const n=this.roomIdsToTags[e.roomId]||[],i=this.getTagsForRoom(e),o=Object(l.a)(n,i);if(!(o.removed.length>0||o.added.length>0))return!1;for(const t of o.removed){const n=this.algorithms[t];if(!n)throw new Error(`No algorithm for ${t}`);n.handleRoomUpdate(e,d.c.RoomRemoved),this._cachedRooms[t]=n.orderedRooms,this.recalculateStickyRoom(t),this.recalculateActiveCallRooms(t)}for(const t of o.added){const n=this.algorithms[t];if(!n)throw new Error(`No algorithm for ${t}`);n.handleRoomUpdate(e,d.c.NewRoom),this._cachedRooms[t]=n.orderedRooms}this.roomIdsToTags[e.roomId]=i,t=d.c.Timeline,c=!0,c&&s&&(this._lastStickyRoom?this._stickyRoom={room:e,tag:this.roomIdsToTags[e.roomId][0],position:0}:this.setStickyRoom(e))}if(t!==d.c.NewRoom&&t!==d.c.RoomRemoved&&this.stickyRoom===e)return!1;if(!this.roomIdsToTags[e.roomId]){if(R.includes(t))return!1;const n=this.getTagsForRoom(e).filter((e=>!Object(o.u)(this.cachedRooms[e])));if(!n.length)throw new Error(`Tags cannot be determined for ${e.roomId}`);this.roomIdsToTags[e.roomId]=n}const u=this.roomIdsToTags[e.roomId];if(!u)return a.a.warn(`No tags known for "${e.name}" (${e.roomId})`),!1;let h=c;for(const n of u){const i=this.algorithms[n];if(!i)throw new Error(`No algorithm for ${n}`);i.handleRoomUpdate(e,t),this._cachedRooms[n]=i.orderedRooms,this.recalculateStickyRoom(n),this.recalculateActiveCallRooms(n),h=!0}return h}}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return W}));var i=n(122),s=n.n(i),o=n(120),r=n.n(o),a=n(130),c=n(16),l=n(1),d=n(123),u=n(121),h=n(166),m=n(126),p=n(136),g=n(389),v=n(135),f=n(144),b=n(127),y=n.n(b),S=n(199),E=n(1452),w=n(1453);const _=function(){let e;return function(t){return e||(e=document.createElement("textarea")),e.innerHTML=t,e.value}}();function C(e){const t={stripReplyFallback:!0,returnString:!0};return"org.matrix.custom.html"===e.format?Object(S.c)(e,null,t):function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(Object(S.c)(e,null,t))}function O(e){const t=document.createElement(Object(S.d)(e)?"div":"span");return t.className="mx_EditHistoryMessage_insertion",t.appendChild(e),t}function I(e){const t=document.createElement(Object(S.d)(e)?"div":"span");return t.className="mx_EditHistoryMessage_deletion",t.appendChild(e),t}function R(e){if("#text"===e.nodeName)return j(e.data);{const t=document.createElement(e.nodeName);for(const[n,i]of Object.entries(e.attributes))t.setAttribute(n,i.value);for(const n of e.childNodes)t.appendChild(R(n));return t}}function k(e,t,n){t?e.insertBefore(n,t):e.appendChild(n)}function x(e,t){for(let n=0;n<e.length-1;++n)if(e[n]!==t[n])return!1;const n=e.length-1;return t[n]>=e[n]}function T(e,t){if("removeTextElement"===e.action||"removeElement"===e.action){const n=1;for(const i of t)x(e.route,i.route)&&(i.route[e.route.length-1]+=n)}}function j(e){return document.createTextNode(_(e))}function P(e,t,n){const{refNode:i,refParentNode:s}=function(e,t){let n,i=e;const s=arguments.length>2&&void 0!==arguments[2]&&arguments[2]?t.length-1:t.length;for(let e=0;e<s;++e){var o;n=i,i=null===(o=i)||void 0===o?void 0:o.childNodes[t[e]]}return{refNode:i,refParentNode:n}}(e,t.route);switch(t.action){case"replaceElement":{if(!i)return void console.warn("Unable to apply replaceElement operation due to missing node");const e=document.createElement("span"),n=I(R(t.oldValue)),s=O(R(t.newValue));e.appendChild(n),e.appendChild(s),i.parentNode.replaceChild(e,i);break}case"removeTextElement":{if(!i)return void console.warn("Unable to apply removeTextElement operation due to missing node");const e=I(j(t.value));i.parentNode.replaceChild(e,i);break}case"removeElement":{if(!i)return void console.warn("Unable to apply removeElement operation due to missing node");const e=I(R(t.element));i.parentNode.replaceChild(e,i);break}case"modifyTextElement":{if(!i)return void console.warn("Unable to apply modifyTextElement operation due to missing node");const e=n.diff_main(t.oldValue,t.newValue);n.diff_cleanupSemantic(e);const s=document.createElement("span");for(const[t,n]of e){let e=j(n);t<0?e=I(e):t>0&&(e=O(e)),s.appendChild(e)}i.parentNode.replaceChild(s,i);break}case"addElement":if(!s)return void console.warn("Unable to apply addElement operation due to missing node");k(s,i,O(R(t.element)));break;case"addTextElement":if(!s)return void console.warn("Unable to apply addTextElement operation due to missing node");k(s,i,O(j("\n"!==t.value?t.value:"")));break;case"removeAttribute":case"addAttribute":case"modifyAttribute":{if(!i)return void console.warn(`Unable to apply ${t.action} operation due to missing node`);const e=I(i.cloneNode(!0)),n=i.cloneNode(!0);"addAttribute"===t.action||"modifyAttribute"===t.action?n.setAttribute(t.name,t.newValue):n.removeAttribute(t.name);const s=O(n),o=document.createElement(Object(S.d)(i)?"div":"span");o.appendChild(e),o.appendChild(s),i.parentNode.replaceChild(o,i);break}default:l.a.warn("MessageDiffUtils::editBodyDiffToHtml: diff action not supported atm",t)}}var D=n(792),N=n(809),M=n(128),A=n(547),L=n(124),U=n(386),F=n(145);class B extends r.a.PureComponent{constructor(e){super(e),s()(this,"onParentFinished",(async e=>{if(e){this.setState({isRedacting:!0});try{await this.props.redact(),this.props.onFinished(!0)}catch(e){const t=e.errcode||e.statusCode;void 0!==t?this.setState({redactionErrorCode:t}):this.props.onFinished(!0)}}else this.props.onFinished(!1)})),this.state={isRedacting:!1,redactionErrorCode:null}}render(){if(this.state.isRedacting){if(this.state.redactionErrorCode){const e=this.state.redactionErrorCode;return r.a.createElement(F.a,{onFinished:this.props.onFinished,title:Object(u.a)("Error"),description:Object(u.a)("You cannot delete this message. (%(code)s)",{code:e})})}return r.a.createElement(p.a,{onFinished:this.props.onFinished,hasCancel:!1,title:Object(u.a)("Removing…")},r.a.createElement(v.a,null))}return r.a.createElement(U.b,{onFinished:this.onParentFinished})}}var V=n(577);function K(e){const t=e.getOriginalContent();return t["m.new_content"]||t}class $ extends r.a.PureComponent{constructor(e){super(e),s()(this,"content",Object(o.createRef)()),s()(this,"pills",[]),s()(this,"tooltips",[]),s()(this,"onAssociatedStatusChanged",(()=>{this.setState({sendStatus:this.props.mxEvent.getAssociatedStatus()})})),s()(this,"onRedactClick",(async()=>{const e=this.props.mxEvent,t=d.a.get();M.b.createDialog(B,{redact:async()=>{await t.redactEvent(e.getRoomId(),e.getId())}},"mx_Dialog_confirmredact")})),s()(this,"onViewSourceClick",(()=>{M.b.createDialog(V.a,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource")}));const t=d.a.get(),{userId:n}=t.credentials,i=this.props.mxEvent,r=t.getRoom(i.getRoomId());i.localRedactionEvent()&&i.localRedactionEvent().on(f.c.Status,this.onAssociatedStatusChanged);const a=r.currentState.maySendRedactionForEvent(i,n);this.state={canRedact:a,sendStatus:i.getAssociatedStatus()}}pillifyLinks(){this.content.current&&Object(D.a)(this.content.current.children,this.props.mxEvent,this.pills)}tooltipifyLinks(){this.content.current&&Object(N.a)(this.content.current.children,this.pills,this.tooltips)}componentDidMount(){this.pillifyLinks(),this.tooltipifyLinks()}componentWillUnmount(){Object(D.b)(this.pills),Object(N.b)(this.tooltips);const e=this.props.mxEvent;e.localRedactionEvent()&&e.localRedactionEvent().off(f.c.Status,this.onAssociatedStatusChanged)}componentDidUpdate(){this.pillifyLinks(),this.tooltipifyLinks()}renderActionBar(){let e,t;return this.props.mxEvent.isRedacted()||this.props.isBaseEvent||!this.state.canRedact||(e=r.a.createElement(L.a,{onClick:this.onRedactClick},Object(u.a)("Remove"))),m.b.getValue("developerMode")&&(t=r.a.createElement(L.a,{onClick:this.onViewSourceClick},Object(u.a)("View Source"))),r.a.createElement("div",{className:"mx_MessageActionBar"},e,t)}render(){const{mxEvent:e}=this.props,t=K(e);let n;if(e.isRedacted())n=r.a.createElement(A.a,{mxEvent:this.props.mxEvent});else{let i;if(i=this.props.previousEdit?function(e,t){const n=`<div>${C(e)}</div>`,i=`<div>${C(t)}</div>`,s=(new w.DiffDOM).diff(n,i),o=new E.diff_match_patch,a=(new DOMParser).parseFromString(n,"text/html").body.children[0];for(let e=0;e<s.length;++e){const t=s[e];P(a,t,o),T(t,s.slice(e+1))}const c=a.innerHTML,l=y()({mx_EventTile_body:!0,"markdown-body":!0});return r.a.createElement("span",{key:"body",className:l,dangerouslySetInnerHTML:{__html:c}})}(K(this.props.previousEdit),t):S.c(t,null,{stripReplyFallback:!0,returnString:!1}),"m.emote"===e.getContent().msgtype){const t=e.sender?e.sender.name:e.getSender();n=r.a.createElement("div",{className:"mx_EventTile_content",ref:this.content},"* ",r.a.createElement("span",{className:"mx_MEmoteBody_sender"},t)," ",i)}else n=r.a.createElement("div",{className:"mx_EventTile_content",ref:this.content},i)}const i=Object(h.m)(new Date(e.getTs()),this.props.isTwelveHour),s=-1!==["sending","queued","encrypting"].indexOf(this.state.sendStatus),o=y()({mx_EventTile:!0,mx_EventTile_sending:s});return r.a.createElement("li",null,r.a.createElement("div",{className:o},r.a.createElement("div",{className:"mx_EventTile_line"},r.a.createElement("span",{className:"mx_MessageTimestamp"},i),n,this.renderActionBar())))}}var H=n(514);class W extends r.a.PureComponent{constructor(e){super(e),s()(this,"loadMoreEdits",(async e=>{if(e||!this.state.nextBatch&&!this.state.isLoading)return!1;const t={from:this.state.nextBatch},n=this.props.mxEvent.getRoomId(),i=this.props.mxEvent.getId(),s=d.a.get(),{resolve:o,reject:r,promise:u}=Object(c.m)();let h;try{h=await s.relations(n,i,a.h.Replace,a.b.RoomMessage,t)}catch(e){return e.errcode&&l.a.error("fetching /relations failed with error",e),this.setState({error:e},(()=>r(e))),u}const m=h.events;return this.locallyRedactEventsIfNeeded(m),this.setState({originalEvent:this.state.originalEvent||h.originalEvent,events:this.state.events.concat(m),nextBatch:h.nextBatch,isLoading:!1},(()=>{const e=!!this.state.nextBatch;o(e)})),u})),this.state={originalEvent:null,error:null,events:[],nextBatch:null,isLoading:!0,isTwelveHour:m.b.getValue("showTwelveHourTimestamps")}}locallyRedactEventsIfNeeded(e){const t=this.props.mxEvent.getRoomId(),n=d.a.get().getRoom(t).getPendingEvents();for(const t of e){const e=n.find((e=>e.getType()===a.b.RoomRedaction&&e.getAssociatedId()===t.getId()));e&&t.markLocallyRedacted(e)}}componentDidMount(){this.loadMoreEdits()}renderEdits(){const e=[];let t,n=this.state.events;this.state.originalEvent&&!this.state.nextBatch&&(n=n.concat(this.state.originalEvent));const i=this.props.mxEvent.getId();return n.forEach(((s,o)=>{t&&!Object(h.o)(t.getDate()||void 0,s.getDate()||void 0)||e.push(r.a.createElement("li",{key:s.getTs()+"~"},r.a.createElement(H.a,{roomId:s.getRoomId(),ts:s.getTs()})));const a=s.getId()===i;e.push(r.a.createElement($,{key:s.getId(),previousEdit:a?null:n[o+1],isBaseEvent:a,mxEvent:s,isTwelveHour:this.state.isTwelveHour})),t=s})),e}render(){let e;if(this.state.error){const{error:t}=this.state;e="M_UNRECOGNIZED"===t.errcode?r.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(u.a)("Your homeserver doesn't seem to support this feature.")):t.errcode?r.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(u.a)("Something went wrong!")):r.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(u.a)("Cannot reach homeserver"),r.a.createElement("br",null),Object(u.a)("Ensure you have a stable internet connection, or get in touch with the server admin"))}else e=this.state.isLoading?r.a.createElement(v.a,null):r.a.createElement(g.a,{className:"mx_MessageEditHistoryDialog_scrollPanel",onFillRequest:this.loadMoreEdits,stickyBottom:!1,startAtBottom:!1},r.a.createElement("ul",{className:"mx_MessageEditHistoryDialog_edits"},this.renderEdits()));return r.a.createElement(p.a,{className:"mx_MessageEditHistoryDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(u.a)("Message edits")},e)}}},,,function(e,t,n){"use strict";var i=n(120),s=n.n(i),o=n(1),r=n(407),a=n(122),c=n.n(a),l=n(572),d=n(1556),u=n.n(d),h=(n(1557),n(199)),m=n(126),p=n(128);var g=n(160),v=n(417),f=n(408),b=n(810),y=n(156);class S extends s.a.Component{constructor(){super(...arguments),c()(this,"image",Object(i.createRef)()),c()(this,"sizeWatcher",void 0),c()(this,"onImageClick",(e=>{const t=this.props.preview;if(0!=e.button||e.metaKey)return;e.preventDefault();let n=t["og:image"];n&&n.startsWith("mxc://")&&(n=Object(g.b)(n).srcHttp);const i={src:n,width:t["og:image:width"],height:t["og:image:height"],name:t["og:title"]||t["og:description"]||this.props.link,fileSize:t["matrix:image:size"],link:this.props.link};if(this.image.current){const e=this.image.current.getBoundingClientRect();i.thumbnailInfo={width:e.width,height:e.height,positionX:e.x,positionY:e.y}}p.b.createDialog(v.a,i,"mx_Dialog_lightbox",null,!0)}))}componentDidMount(){this.sizeWatcher=m.b.watchSetting("Images.size",null,(()=>{this.forceUpdate()}))}render(){var e,t,n;const i=this.props.preview;if(!i||0===Object.keys(i).length)return s.a.createElement("div",null);let o=i["og:image"];m.b.getValue("showImages")||(o=null);o&&o.startsWith("mxc://")&&(o=Object(g.b)(o).getThumbnailOfSourceHttp(100,100,"scale"));let r,a=null;i["og:image:width"]&&i["og:image:height"]&&(a=function(e,t,n,i){if(!e||!t)return null;if(e<n&&t<i)return t;const s=n/e,o=i/t;return s<o?Math.floor(s*t):Math.floor(o*t)}(i["og:image:width"],i["og:image:height"],100,100)),o&&(r=s.a.createElement("div",{className:"mx_LinkPreviewWidget_image",style:{height:a}},s.a.createElement("img",{ref:this.image,style:{maxWidth:100,maxHeight:100},src:o,onClick:this.onImageClick,alt:""})));const c=Object(l.decode)(i["og:description"]||""),d=null!==(e=null===(t=i["og:title"])||void 0===t?void 0:t.trim())&&void 0!==e?e:"",p=s.a.createElement("a",{href:this.props.link,target:"_blank",rel:"noreferrer noopener"},d),v=(null===(n=y.a.get())||void 0===n?void 0:n.needsUrlTooltips())&&this.props.link!==d;if(this.props.youtubeEmbedPlayer&&this.props.link.match(/^https?:\/\/(m[.]|www[.])?(youtube[.]com\/watch[?]v=|youtu[.]be\/)([\w-]+)(\S+)?$/)){let e;this.props.link.includes("watch?v=")?e=this.props.link.split("watch?v=")[1].split("&")[0]:this.props.link.includes("youtu.be/")&&(e=this.props.link.split("youtu.be/")[1].split("&")[0]);const t=Object(f.b)(m.b.getValue("Images.size"),{w:i["og:image:width"],h:i["og:image:height"]});return s.a.createElement("div",{className:"mx_LinkPreviewWidget sc_LinkPreviewWidget_youtubeEmbed"},s.a.createElement("div",{className:"mx_LinkPreviewWidget_wrapImageCaption"},s.a.createElement("div",{className:"mx_LinkPreviewWidget_image sc_LinkPreviewWidget_youtubePlayer",style:{flexBasis:t.w,maxHeight:t.h}},s.a.createElement(u.a,{id:e,title:d,adNetwork:!1,noCookie:!0,thumbnail:o})),s.a.createElement("div",{className:"mx_LinkPreviewWidget_caption sc_LinkPreviewWidget_youtubeCaption"},s.a.createElement("div",{className:"mx_LinkPreviewWidget_title"},v?s.a.createElement(b.a,{tooltip:new URL(this.props.link,window.location.href).toString()},p):p,i["og:site_name"]&&s.a.createElement("span",{className:"mx_LinkPreviewWidget_siteName"}," - "+i["og:site_name"])),s.a.createElement("div",{className:"mx_LinkPreviewWidget_description"},s.a.createElement(h.a,null,c)))))}return s.a.createElement("div",{className:"mx_LinkPreviewWidget",dir:"auto"},s.a.createElement("div",{className:"mx_LinkPreviewWidget_wrapImageCaption"},r,s.a.createElement("div",{className:"mx_LinkPreviewWidget_caption"},s.a.createElement("div",{className:"mx_LinkPreviewWidget_title"},v?s.a.createElement(b.a,{tooltip:new URL(this.props.link,window.location.href).toString()},p):p,i["og:site_name"]&&s.a.createElement("span",{className:"mx_LinkPreviewWidget_siteName"}," - "+i["og:site_name"])),s.a.createElement("div",{className:"mx_LinkPreviewWidget_description"},s.a.createElement(h.a,null,c)))),this.props.children)}}var E=n(124),w=n(121),_=n(133),C=n(252);const O=(e,t,n)=>Promise.all(t.map((async t=>{try{const i=await e.getUrlPreview(t,n);if(i&&Object.keys(i).length>0)return[t,i]}catch(e){o.a.error("Failed to get URL preview: "+e)}}))).then((e=>e.filter(Boolean)));t.a=e=>{let{links:t,mxEvent:o,onCancelClick:a,onHeightChanged:c,youtubeEmbedPlayer:l}=e;const d=Object(i.useContext)(_.a),[u,h]=Object(r.a)(),m=o.getTs(),p=Object(C.a)((async()=>O(d,t,m)),[t,m],[]);Object(i.useEffect)((()=>{c()}),[c,u,p]);const g=u?p:p.slice(0,2);let v;return p.length>2&&(v=s.a.createElement(E.a,{onClick:h},u?Object(w.a)("Collapse"):Object(w.a)("Show %(count)s other previews",{count:p.length-g.length}))),s.a.createElement("div",{className:"mx_LinkPreviewGroup"},g.map(((e,t)=>{let[i,r]=e;return s.a.createElement(S,{youtubeEmbedPlayer:l,key:i,link:i,preview:r,mxEvent:o},0===t?s.a.createElement(E.a,{className:"mx_LinkPreviewGroup_hide",onClick:a,"aria-label":Object(w.a)("Close preview")},s.a.createElement("img",{className:"mx_filterFlipColor",alt:"",role:"presentation",src:n(1558).default,width:"18",height:"18"})):void 0)})),v)}},,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(13),s=n.n(i),o=n(180);class r{constructor(e){this.ourEvent=e,s()(this,"timeline",void 0),s()(this,"ourEventIndex",0),s()(this,"paginateTokens",{[o.a.Backward]:null,[o.a.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.paginateTokens[e?o.a.Backward:o.a.Forward]}setPaginateToken(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.paginateTokens[t?o.a.Backward:o.a.Forward]=null!=e?e:null}addEvents(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class a{static fromJson(e,t){const n=e.context||{};let i=(n.events_before||[]).map(t),s=(n.events_after||[]).map(t);const o=new r(t(e.result)),c=o.ourEvent.threadRootId;return i=i.filter((e=>e.threadRootId===c)),s=s.filter((e=>e.threadRootId===c)),o.setPaginateToken(n.start,!0),o.addEvents(i,!0),o.addEvents(s,!1),o.setPaginateToken(n.end,!1),new a(e.rank,o)}constructor(e,t){this.rank=e,this.context=t}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return f})),n.d(t,"b",(function(){return y}));var i=n(13),s=n.n(i),o=n(35),r=n.n(o),a=n(130),c=n(1),l=n(16),d=n(180);function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class m{constructor(e,t,n){this.client=e,this.indexEvent=t,this.directory=n}get id(){const e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return!0===this.indexEvent.getContent().active}get version(){var e;return null!==(e=this.indexEvent.getContent().version)&&void 0!==e?e:1}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,a.p.name,{},this.id),await this.client.redactEvent(this.roomId,this.id);const e=(await this.getVersionHistory())[1];e&&await e.delete()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}async setName(e){await this.client.sendStateEvent(this.roomId,a.p.name,h(h({},this.indexEvent.getContent()),{},{name:e}),this.id)}isLocked(){return this.indexEvent.getContent().locked||!1}async setLocked(e){await this.client.sendStateEvent(this.roomId,a.p.name,h(h({},this.indexEvent.getContent()),{},{locked:e}),this.id)}async getFileInfo(){const e=(await this.getFileEvent()).getOriginalContent().file,t=this.client.mxcUrlToHttp(e.url);if(!t)throw new Error(`No HTTP URL available for ${e.url}`);return{info:e,httpUrl:t}}async getFileEvent(){const e=this.client.getRoom(this.roomId);if(!e)throw new Error("Unknown room");let t=e.getUnfilteredTimelineSet().findEventById(this.id);for(;!t&&e.getLiveTimeline().getState(d.b.BACKWARDS).paginationToken;)await this.client.scrollback(e,100),t=e.getUnfilteredTimelineSet().findEventById(this.id);if(!t)throw new Error("Failed to find event");return await this.client.decryptEventIfNeeded(t,{emit:!0,isRetry:!0}),t}async createNewVersion(e,t,n,i){const s=await this.directory.createFile(e,t,n,h(h({},null!=i?i:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:a.h.Replace,event_id:this.id}}));return await this.client.sendStateEvent(this.roomId,a.p.name,{active:!0,name:e,version:this.version+1},s.event_id),await this.client.sendStateEvent(this.roomId,a.p.name,h(h({},this.indexEvent.getContent()),{},{active:!1}),this.id),s}async getVersionHistory(){const e=[];e.push(this);const t=this.client.getRoom(this.roomId);if(!t)throw new Error("Invalid or unknown room");const n=[...t.getLiveTimeline().getEvents()].reverse();let i,s=await this.getFileEvent();do{if(i=n.find((e=>e.replacingEventId()===s.getId())),i){const t=this.directory.getFile(i.getId());if(!t)break;e.push(t),s=i}}while(i);return e}}var p=n(706);function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){s()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const f={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[a.b.RoomPowerLevels]:100,[a.b.RoomHistoryVisibility]:100,[a.b.RoomTombstone]:100,[a.b.RoomEncryption]:100,[a.b.RoomName]:50,[a.b.RoomMessage]:50,[a.b.RoomMessageEncrypted]:50,[a.b.Sticker]:50},users:{}};let b;!function(e){e.Viewer="viewer",e.Editor="editor",e.Owner="owner"}(b||(b={}));class y{constructor(e,t){if(this.client=e,this.roomId=t,s()(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const e=this.room.currentState.getStateEvents(a.b.SpaceParent);return null==e||!e.length||e.every((e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t.via)}))}async setName(e){await this.client.sendStateEvent(this.roomId,a.b.RoomName,{name:e},"")}async invite(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=[this.retryInvite(e)];return t&&i.push(...this.getDirectories().map((i=>i.invite(e,t,n)))),Promise.all(i).then((()=>{n&&Object(p.a)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[e])}))}retryInvite(e){return Object(l.M)((async()=>{await this.client.invite(this.roomId,e).catch((e=>{if("M_FORBIDDEN"===(null==e?void 0:e.errcode))throw new r.a.AbortError(e);throw e}))}))}async setPermissions(e,t){var n;const i=this.room.currentState.getStateEvents(a.b.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");const s=(null==i?void 0:i.getContent())||{},o=s.users_default||0,r=s.events_default||50,c=(null===(n=s.events)||void 0===n?void 0:n[a.b.RoomPowerLevels])||100,l=s.users||{};switch(t){case b.Viewer:l[e]=o;break;case b.Editor:l[e]=r;break;case b.Owner:l[e]=c;break;default:throw new Error("Invalid role: "+t)}s.users=l,await this.client.sendStateEvent(this.roomId,a.b.RoomPowerLevels,s,"")}getPermissions(e){var t,n;const i=this.room.currentState.getStateEvents(a.b.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");const s=(null==i?void 0:i.getContent())||{},o=s.users_default||0,r=s.events_default||50,c=(null===(t=s.events)||void 0===t?void 0:t[a.b.RoomPowerLevels])||100,l=(null===(n=s.users)||void 0===n?void 0:n[e])||o;return l>=c?b.Owner:l>=r?b.Editor:b.Viewer}async createDirectory(e){const t=await this.client.unstableCreateFileTree(e);return await this.client.sendStateEvent(this.roomId,a.b.SpaceChild,{via:[this.client.getDomain()]},t.roomId),await this.client.sendStateEvent(t.roomId,a.b.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}getDirectories(){const e=[],t=this.room.currentState.getStateEvents(a.b.SpaceChild);for(const n of t)try{const t=n.getStateKey();if(t){const n=this.client.unstableGetFileTreeSpace(t);n&&e.push(n)}}catch(e){c.a.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find((t=>t.roomId===e))}async delete(){const e=this.getDirectories();for(const t of e)await t.delete();const t=["invite","knock","join"],n=this.room.currentState.getStateEvents(a.b.RoomMember);for(const e of n){if(e.getStateKey()!==this.client.getUserId()&&t.includes(e.getContent().membership)){const t=e.getStateKey();if(!t)throw new Error("State key not found for branch");await this.client.kick(this.roomId,t,"Room deleted")}}await this.client.leave(this.roomId)}getOrderedChildren(e){const t=e.map((e=>({roomId:e.getStateKey(),order:e.getContent().order}))).filter((e=>e.roomId));return t.sort(((e,t)=>{if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return Object(l.x)(e.order,t.order);{var n,i,s,o;const r=this.client.getRoom(e.roomId),c=this.client.getRoom(t.roomId);if(!r||!c)return Object(l.x)(e.roomId,t.roomId);const d=null!==(n=null===(i=r.currentState.getStateEvents(a.b.RoomCreate,""))||void 0===i?void 0:i.getTs())&&void 0!==n?n:0,u=null!==(s=null===(o=c.currentState.getStateEvents(a.b.RoomCreate,""))||void 0===o?void 0:o.getTs())&&void 0!==s?s:0;return d===u?Object(l.x)(e.roomId,t.roomId):d-u}})),t}getParentRoom(){const e=this.room.currentState.getStateEvents(a.b.SpaceParent)[0];if(!e)throw new Error("Expected to have a parent in a non-top level space");const t=e.getStateKey();if(!t)throw new Error("No state key found for parent");const n=this.client.getRoom(t);if(!n)throw new Error("Unable to locate room for parent");return n}getOrder(){if(this.isTopLevel)return-1;const e=this.getParentRoom().currentState.getStateEvents(a.b.SpaceChild);return this.getOrderedChildren(e).findIndex((e=>e.roomId===this.roomId))}async setOrder(e){var t;if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const n=this.getParentRoom(),i=n.currentState.getStateEvents(a.b.SpaceChild),s=this.getOrderedChildren(i);e=Math.max(Math.min(e,s.length-1),0);const o=this.getOrder()<e;o&&e===s.length-1?e--:o||0!==e||e++;const r=s[o?e:e-1],c=s[o?e+1:e];let d=l.a[0],u=!1;if(r)if(e===s.length-1)null!=c&&c.order&&(d=Object(l.z)(c.order));else{const e=null==r?void 0:r.order,t=null==c?void 0:c.order;e&&t?d=e===t?Object(l.z)(e):Object(l.d)(e,t):e?d=Object(l.z)(e):t?d=Object(l.C)(t):u=!0}else null!=c&&c.order&&(d=Object(l.C)(c.order));if(u){let t;for(let i=0;i<=e;i++){const e=s[i];if(0===i&&(t=e.order),e.order)t=e.order;else{var h;t=t?Object(l.z)(t):l.a[0];const i=n.currentState.getStateEvents(a.b.SpaceChild,e.roomId),s=null!==(h=null==i?void 0:i.getContent())&&void 0!==h?h:{via:[this.client.getDomain()]};await this.client.sendStateEvent(n.roomId,a.b.SpaceChild,v(v({},s),{},{order:t}),e.roomId)}}t&&(d=Object(l.z)(t))}const m=n.currentState.getStateEvents(a.b.SpaceChild,this.roomId),p=null!==(t=null==m?void 0:m.getContent())&&void 0!==t?t:{via:[this.client.getDomain()]};await this.client.sendStateEvent(n.roomId,a.b.SpaceChild,v(v({},p),{},{order:d}),this.roomId)}async createFile(e,t,n,i){var s;const{content_uri:o}=await this.client.uploadContent(t,{includeFilename:!1});n.url=o;const r={msgtype:a.e.File,body:e,url:o,file:n};(i=null!==(s=i)&&void 0!==s?s:{})["m.new_content"]&&(i["m.new_content"]=r);const c=await this.client.sendMessage(this.roomId,v(v(v({},i),r),{},{[a.q.name]:{}}));return await this.client.sendStateEvent(this.roomId,a.p.name,{active:!0,name:e},c.event_id),c}getFile(e){const t=this.room.currentState.getStateEvents(a.p.name,e);return t?new m(this.client,t,this):null}listFiles(){return this.listAllFiles().filter((e=>e.isActive))}listAllFiles(){var e;return(null!==(e=this.room.currentState.getStateEvents(a.p.name))&&void 0!==e?e:[]).map((e=>new m(this.client,e,this)))}}}]]);
//# sourceMappingURL=init.js.map