(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{1007:function(e,t,a){"use strict";a.d(t,"d",(function(){return c})),a.d(t,"b",(function(){return d})),a.d(t,"c",(function(){return p})),a.d(t,"a",(function(){return g}));var n=a(235);class i{static encodeActions(e){const t=e.notify,a=e.sound,i=e.highlight;if(t){const e=[n.d.Notify];return a&&e.push({set_tweak:"sound",value:a}),i?e.push({set_tweak:"highlight"}):e.push({set_tweak:"highlight",value:!1}),e}return[n.d.DontNotify]}static decodeActions(e){let t,a=!1,i=!1;for(let s=0;s<e.length;++s){const o=e[s];if(o===n.d.Notify)a=!0;else if(o===n.d.DontNotify)a=!1;else{if("object"!=typeof o)return null;if("sound"===o.set_tweak)t=o.value;else{if("highlight"!==o.set_tweak)return null;i=o.value}}}void 0===i&&(i=!0);const s={notify:a,highlight:i};return void 0!==t&&(s.sound=t),s}}var s=a(122),o=a.n(s);const r=i.encodeActions;class l{}o()(l,"ACTION_NOTIFY",r({notify:!0})),o()(l,"ACTION_NOTIFY_DEFAULT_SOUND",r({notify:!0,sound:"default"})),o()(l,"ACTION_NOTIFY_RING_SOUND",r({notify:!0,sound:"ring"})),o()(l,"ACTION_HIGHLIGHT",r({notify:!0,highlight:!0})),o()(l,"ACTION_HIGHLIGHT_DEFAULT_SOUND",r({notify:!0,sound:"default",highlight:!0})),o()(l,"ACTION_DONT_NOTIFY",r({notify:!1})),o()(l,"ACTION_DISABLED",void 0);let c=function(e){return e.Off="off",e.On="on",e.Loud="loud",e}({});class d{static actionsFor(e){return e===c.On?l.ACTION_NOTIFY:e===c.Loud?l.ACTION_HIGHLIGHT_DEFAULT_SOUND:[]}static contentRuleVectorStateKind(e){const t=i.decodeActions(e.actions);if(!t)return null;let a=0;t.sound&&a++,t.highlight&&a++;let n=null;switch(a){case 0:n=c.On;break;case 2:n=c.Loud}return n}}o()(d,"OFF",c.Off),o()(d,"ON",c.On),o()(d,"LOUD",c.Loud),o()(d,"states",c);var m=a(1),h=a(121);class u{constructor(e){o()(this,"description",void 0),o()(this,"vectorStateToActions",void 0),o()(this,"syncedRuleIds",void 0),this.description=e.description,this.vectorStateToActions=e.vectorStateToActions,this.syncedRuleIds=e.syncedRuleIds}ruleToVectorState(e){let t=!1;e&&(t=e.enabled);for(const a of Object.values(d.states)){const n=this.vectorStateToActions[a];if(n){if(t&&JSON.stringify(i.decodeActions(e.actions))===JSON.stringify(i.decodeActions(n)))return a}else if(!t)return a}m.a.error(`Cannot translate rule actions into Vector rule state. Rule: ${JSON.stringify(e)}, Expected: ${JSON.stringify(this.vectorStateToActions)}`)}}const p={".m.rule.contains_display_name":new u({description:Object(h.d)("Messages containing my display name"),vectorStateToActions:{[c.On]:l.ACTION_NOTIFY,[c.Loud]:l.ACTION_HIGHLIGHT_DEFAULT_SOUND,[c.Off]:l.ACTION_DISABLED}}),".m.rule.contains_user_name":new u({description:Object(h.d)("Messages containing my username"),vectorStateToActions:{[c.On]:l.ACTION_NOTIFY,[c.Loud]:l.ACTION_HIGHLIGHT_DEFAULT_SOUND,[c.Off]:l.ACTION_DISABLED}}),".m.rule.roomnotif":new u({description:Object(h.d)("Messages containing @room"),vectorStateToActions:{[c.On]:l.ACTION_NOTIFY,[c.Loud]:l.ACTION_HIGHLIGHT,[c.Off]:l.ACTION_DISABLED}}),".m.rule.room_one_to_one":new u({description:Object(h.d)("Messages in one-to-one chats"),vectorStateToActions:{[c.On]:l.ACTION_NOTIFY,[c.Loud]:l.ACTION_NOTIFY_DEFAULT_SOUND,[c.Off]:l.ACTION_DONT_NOTIFY},syncedRuleIds:[n.f.PollStartOneToOne,n.f.PollStartOneToOneUnstable,n.f.PollEndOneToOne,n.f.PollEndOneToOneUnstable]}),".m.rule.encrypted_room_one_to_one":new u({description:Object(h.d)("Encrypted messages in one-to-one chats"),vectorStateToActions:{[c.On]:l.ACTION_NOTIFY,[c.Loud]:l.ACTION_NOTIFY_DEFAULT_SOUND,[c.Off]:l.ACTION_DONT_NOTIFY}}),".m.rule.message":new u({description:Object(h.d)("Messages in group chats"),vectorStateToActions:{[c.On]:l.ACTION_NOTIFY,[c.Loud]:l.ACTION_NOTIFY_DEFAULT_SOUND,[c.Off]:l.ACTION_DONT_NOTIFY},syncedRuleIds:[n.f.PollStart,n.f.PollStartUnstable,n.f.PollEnd,n.f.PollEndUnstable]}),".m.rule.encrypted":new u({description:Object(h.d)("Encrypted messages in group chats"),vectorStateToActions:{[c.On]:l.ACTION_NOTIFY,[c.Loud]:l.ACTION_NOTIFY_DEFAULT_SOUND,[c.Off]:l.ACTION_DONT_NOTIFY}}),".m.rule.invite_for_me":new u({description:Object(h.d)("When I'm invited to a room"),vectorStateToActions:{[c.On]:l.ACTION_NOTIFY,[c.Loud]:l.ACTION_NOTIFY_DEFAULT_SOUND,[c.Off]:l.ACTION_DISABLED}}),".m.rule.call":new u({description:Object(h.d)("Call invitation"),vectorStateToActions:{[c.On]:l.ACTION_NOTIFY,[c.Loud]:l.ACTION_NOTIFY_RING_SOUND,[c.Off]:l.ACTION_DISABLED}}),".m.rule.suppress_notices":new u({description:Object(h.d)("Messages sent by bot"),vectorStateToActions:{[c.On]:l.ACTION_DISABLED,[c.Loud]:l.ACTION_NOTIFY_DEFAULT_SOUND,[c.Off]:l.ACTION_DONT_NOTIFY}}),".m.rule.tombstone":new u({description:Object(h.d)("When rooms are upgraded"),vectorStateToActions:{[c.On]:l.ACTION_NOTIFY,[c.Loud]:l.ACTION_HIGHLIGHT,[c.Off]:l.ACTION_DISABLED}})};class g{static parseContentRules(e){const t=g.categoriseContentRules(e);return t.loud.length?{vectorState:c.Loud,rules:t.loud,externalRules:[...t.loud_but_disabled,...t.on,...t.on_but_disabled,...t.other]}:t.loud_but_disabled.length?{vectorState:c.Off,rules:t.loud_but_disabled,externalRules:[...t.on,...t.on_but_disabled,...t.other]}:t.on.length?{vectorState:c.On,rules:t.on,externalRules:[...t.on_but_disabled,...t.other]}:t.on_but_disabled.length?{vectorState:c.Off,rules:t.on_but_disabled,externalRules:t.other}:{vectorState:c.On,rules:[],externalRules:t.other}}static categoriseContentRules(e){const t={on:[],on_but_disabled:[],loud:[],loud_but_disabled:[],other:[]};for(const a in e.global)for(let i=0;i<Object.keys(e.global[a]).length;++i){const s=e.global[a][i];if("."!==s.rule_id[0]&&a===n.e.ContentSpecific)switch(s.kind=a,d.contentRuleVectorStateKind(s)){case c.On:s.enabled?t.on.push(s):t.on_but_disabled.push(s);break;case c.Loud:s.enabled?t.loud.push(s):t.loud_but_disabled.push(s);break;default:t.other.push(s)}}return t}}},1018:function(e,t,a){"use strict";var n=a(120),i=a.n(n),s=a(124),o=a(121),r=a(250),l=a(132),c=a(129),d=a(122),m=a.n(d),h=a(332),u=a(1),p=a(359),g=a(137),b=a(141),v=a(237),f=a(204);class E extends i.a.PureComponent{constructor(e){super(e),m()(this,"defaultServer",void 0),m()(this,"fieldRef",Object(n.createRef)()),m()(this,"validatedConf",void 0),m()(this,"onDefaultChosen",(()=>{this.setState({defaultChosen:!0})})),m()(this,"onOtherChosen",(()=>{this.setState({defaultChosen:!1})})),m()(this,"onHomeserverChange",(e=>{this.setState({otherHomeserver:e.target.value})})),m()(this,"validate",Object(f.a)({deriveData:async e=>{let{value:t}=e,a=t.trim();if(!a.includes("://"))try{const e=await h.a.findClientConfig(a);return this.validatedConf=p.a.buildValidatedConfigFromDiscovery(a,e),{}}catch(e){u.a.error(`Attempted ${a} as a server_name but it failed`,e)}a.includes("://")||(a="https://"+a);try{return this.validatedConf=await p.a.validateServerConfigWithStaticUrls(a),{}}catch(e){u.a.error(e);if(p.a.authComponentStateForError(e).serverErrorIsFatal){let t=Object(o.b)("Unable to validate homeserver");return e.translatedMessage&&(t=e.translatedMessage),{error:t}}try{return this.validatedConf=await p.a.validateServerConfigWithStaticUrls(a,null,!0),{}}catch(e){return u.a.error(e),{error:Object(o.b)("Invalid URL")}}}},rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(o.b)("Specify a homeserver")},{key:"valid",test:async function(e,t){let{value:a}=e,{error:n}=t;return!a||!n},invalid:function(e){let{error:t}=e;return null!=t?t:null}}]})),m()(this,"onHomeserverValidate",(e=>this.validate(e))),m()(this,"onSubmit",(async e=>{e.preventDefault();if(!await this.fieldRef.current.validate({allowEmpty:!1})&&!this.state.defaultChosen)return this.fieldRef.current.focus(),void this.fieldRef.current.validate({allowEmpty:!1,focused:!0});this.props.onFinished(this.state.defaultChosen?this.defaultServer:this.validatedConf)}));const t=l.b.get();this.defaultServer=t.validated_server_config;const{serverConfig:a}=this.props;let i="";a.isDefault||(i=a.isNameResolvable&&a.hsName?a.hsName:a.hsUrl),this.state={defaultChosen:a.isDefault,otherHomeserver:i}}render(){let e;"matrix.org"===this.defaultServer.hsName&&(e=Object(o.b)("Matrix.org is the biggest public homeserver in the world, so it's a good place for many."));let t=this.defaultServer.hsName;return this.defaultServer.hsNameIsDifferent&&(t=i.a.createElement(r.a,{class:"mx_Login_underlinedServerName",tooltip:this.defaultServer.hsUrl},this.defaultServer.hsName)),i.a.createElement(g.a,{title:this.props.title||Object(o.b)("Sign into your homeserver"),className:"mx_ServerPickerDialog",contentId:"mx_ServerPickerDialog",onFinished:this.props.onFinished,fixedWidth:!1,hasCancel:!0},i.a.createElement("form",{className:"mx_Dialog_content",id:"mx_ServerPickerDialog",onSubmit:this.onSubmit},i.a.createElement("p",null,Object(o.b)("We call the places where you can host your account 'homeservers'.")," ",e),i.a.createElement(v.a,{name:"defaultChosen",value:"true",checked:this.state.defaultChosen,onChange:this.onDefaultChosen},t),i.a.createElement(v.a,{name:"defaultChosen",value:"false",className:"mx_ServerPickerDialog_otherHomeserverRadio",checked:!this.state.defaultChosen,onChange:this.onOtherChosen,childrenInLabel:!1,"aria-label":Object(o.b)("Other homeserver")},i.a.createElement(b.a,{type:"text",className:"mx_ServerPickerDialog_otherHomeserver",label:Object(o.b)("Other homeserver"),onChange:this.onHomeserverChange,onFocus:this.onOtherChosen,ref:this.fieldRef,onValidate:this.onHomeserverValidate,value:this.state.otherHomeserver,validateOnChange:!1,validateOnFocus:!1,autoFocus:!0,id:"mx_homeserverInput"})),i.a.createElement("p",null,Object(o.b)("Use your preferred Matrix homeserver if you have one, or host your own.")),i.a.createElement(s.a,{className:"mx_ServerPickerDialog_continue",kind:"primary",onClick:this.onSubmit},Object(o.b)("Continue")),i.a.createElement("h2",null,Object(o.b)("Learn more")),i.a.createElement("a",{href:"https://matrix.org/faq/#what-is-a-homeserver%3F",target:"_blank",rel:"noreferrer noopener"},Object(o.b)("About homeservers"))))}}var y=a(219);const _=()=>{const e=l.b.get().brand;c.b.createDialog(y.a,{title:Object(o.b)("Server Options"),description:Object(o.b)("You can use the custom server options to sign into other Matrix servers by specifying a different homeserver URL. This allows you to use %(brand)s with an existing Matrix account on a different homeserver.",{brand:e}),button:Object(o.b)("Dismiss"),hasCloseButton:!1,fixedWidth:!1},"mx_ServerPicker_helpDialog")};t.a=e=>{let{title:t,dialogTitle:a,serverConfig:n,onServerConfigChange:d}=e;const m=l.b.get("disable_custom_urls");let h;if(!m&&d){const e=()=>{((e,t,a)=>{c.b.createDialog(E,{title:e,serverConfig:t,onFinished:a})})(a,n,(e=>{e&&d(e)}))};h=i.a.createElement(s.a,{className:"mx_ServerPicker_change",kind:"link",onClick:e},Object(o.b)("Edit"))}let u,p=n.isNameResolvable?n.hsName:n.hsUrl;return n.hsNameIsDifferent&&(p=i.a.createElement(r.a,{class:"mx_Login_underlinedServerName",tooltip:n.hsUrl},n.hsName)),"matrix.org"===n.hsName&&(u=i.a.createElement("span",{className:"mx_ServerPicker_desc"},Object(o.b)("Join millions for free on the largest public server"))),i.a.createElement("div",{className:"mx_ServerPicker"},i.a.createElement("h2",null,t||Object(o.b)("Homeserver")),m?null:i.a.createElement(s.a,{className:"mx_ServerPicker_help",onClick:_,"aria-label":Object(o.b)("Help")}),i.a.createElement("span",{className:"mx_ServerPicker_server",title:"string"==typeof p?p:void 0},p),h,u)}},1028:function(e,t,a){"use strict";a.d(t,"a",(function(){return x}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(127),l=a.n(r),c=a(146),d=a(130),m=a(1),h=a(121),u=a(125),p=a(128),g=a(957),b=a(701);class v extends b.a{constructor(){super(...arguments),i()(this,"onClick",(e=>{e.preventDefault()}))}wrapImage(e,t){return t}render(){if(this.state.error)return super.render();const e=this.props.mxEvent.getContent(),t=this.state.contentUrl?this.messageContent(this.state.contentUrl,this.state.thumbUrl,e,44):void 0;return o.a.createElement("div",{className:"mx_MImageReplyBody"},t)}}var f=a(184),E=a(666),y=a(354),_=a(175),S=a(920),w=a(243);function O(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function C(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?O(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):O(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class x extends o.a.PureComponent{constructor(){super(...arguments),i()(this,"anchorElement",Object(s.createRef)()),i()(this,"onDecrypted",(()=>{this.forceUpdate(),this.props.onHeightChanged&&this.props.onHeightChanged()})),i()(this,"onEventRequiresUpdate",(()=>{this.forceUpdate()})),i()(this,"onClick",(e=>{const t=e.target;"a"===t.tagName.toLowerCase()&&null!==t.closest("a")&&t!==this.anchorElement.current||(e.preventDefault(),this.props.toggleExpandedQuote&&e.shiftKey?this.props.toggleExpandedQuote():u.a.dispatch({action:p.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0}))}))}componentDidMount(){this.props.mxEvent.on(c.c.Decrypted,this.onDecrypted),this.props.mxEvent.on(c.c.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.on(c.c.Replaced,this.onEventRequiresUpdate)}componentWillUnmount(){this.props.mxEvent.removeListener(c.c.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(c.c.BeforeRedaction,this.onEventRequiresUpdate),this.props.mxEvent.removeListener(c.c.Replaced,this.onEventRequiresUpdate)}render(){const e=this.props.mxEvent,t=e.getContent().msgtype,a=e.getType(),{hasRenderer:n,isInfoMessage:i,isSeeingThroughMessageHiddenForModeration:s}=Object(E.a)(e,!1);if(!n){const{mxEvent:e}=this.props;return m.a.warn(`Event type not supported: type:${e.getType()} isState:${e.isState()}`),o.a.createElement("div",{className:"mx_ReplyTile mx_ReplyTile_info mx_MNoticeBody"},Object(h.b)("This event could not be displayed"))}const r=l()("mx_ReplyTile",{mx_ReplyTile_inline:t===d.e.Emote,mx_ReplyTile_info:i&&!e.isRedacted(),mx_ReplyTile_audio:t===d.e.Audio,mx_ReplyTile_video:t===d.e.Video});let c,u="#";this.props.permalinkCreator&&(u=this.props.permalinkCreator.forEvent(e.getId()));i||a===d.b.RoomCreate||(c=o.a.createElement("div",{className:"mx_ReplyTile_sender"},o.a.createElement(_.b,{member:e.sender,fallbackUserId:e.getSender(),width:16,height:16}),o.a.createElement(g.a,{mxEvent:e,userNameColorMode:this.props.userNameColorMode})));const p={[d.e.Image]:v,[d.e.Audio]:Object(f.m)(e)?S.a:y.a,[d.e.Video]:y.a},b={[d.b.Sticker]:v};return o.a.createElement("div",{className:r},o.a.createElement("a",{href:u,onClick:this.onClick,ref:this.anchorElement},c,Object(w.f)(C(C({},this.props),{},{ref:void 0,youtubeEmbedPlayer:!1,showUrlPreview:!1,overrideBodyTypes:p,overrideEventTypes:b,maxImageHeight:96,isSeeingThroughMessageHiddenForModeration:s,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),!1)))}}i()(x,"defaultProps",{onHeightChanged:()=>{}})},1633:function(e,t,a){"use strict";(function(e){var t=a(136);if(e.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");let n;e.__js_sdk_entrypoint=!0;try{n=e.indexedDB}catch(e){}n&&t.setCryptoStoreFactory((()=>new t.IndexedDBCryptoStore(n,"matrix-js-sdk:crypto")));e.matrixcs=t}).call(this,a(14))},1634:function(e,t,a){"use strict";var n=a(122),i=a.n(n),s=a(1),o=a(123),r=a(125),l=a(353);var c=function(e){return e.Online="online",e.Offline="offline",e.Unavailable="unavailable",e}(c||{});t.a=new class{constructor(){i()(this,"unavailableTimer",null),i()(this,"dispatcherRef",null),i()(this,"state",null),i()(this,"onAction",(e=>{var t;"user_activity"===e.action&&(this.setState(c.Online),null===(t=this.unavailableTimer)||void 0===t||t.restart())}))}async start(){for(this.unavailableTimer=new l.a(18e4),this.dispatcherRef=r.a.register(this.onAction);this.unavailableTimer;)try{await this.unavailableTimer.finished(),this.setState(c.Unavailable)}catch(e){}}stop(){this.dispatcherRef&&(r.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.unavailableTimer&&(this.unavailableTimer.abort(),this.unavailableTimer=null)}getState(){return this.state}async setState(e){if(e===this.state)return;const t=this.state;if(this.state=e,!o.a.get().isGuest())try{await o.a.get().setPresence({presence:this.state}),s.a.info("Presence:",e)}catch(e){s.a.error("Failed to set presence:",e),this.state=t}}}},1635:function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-colr.4d2d834.woff2"},1636:function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-sbix.b1b6461.woff2"},1637:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M2 3.05v6.22C2 15.63 9 17 9 17s7-1.37 7-7.73V3.05L9 1 2 3.05zm9.94 2.47c.19-.18.49-.17.67.02.16.18.16.45.02.63l-4.22 5.11-.03.04c-.28.34-.79.39-1.13.11a.29.29 0 01-.077-.067.912.912 0 00-.023-.023L5.34 9.26c-.2-.24-.18-.6.06-.8.2-.18.49-.18.7-.04l1.57 1.1 4.27-4z",fill:"#010101"})))}t.default="img/e2e/verified-deprecated.85c94e6.svg"},1639:function(e,t,a){"use strict";t.a={}},1640:function(e,t,a){"use strict";var n=a(120),i=a.n(n),s=a(159),o=a(121),r=a(132);t.a=e=>{const t=r.b.get().brand,a=Object(o.b)("%(brand)s now uses 3-5x less memory, by only loading information about other users when needed. Please wait whilst we resynchronise with the server!",{brand:t});return i.a.createElement(s.a,{hasCancelButton:!1,title:Object(o.b)("Updating %(brand)s",{brand:t}),description:i.a.createElement("div",null,a),button:Object(o.b)("OK"),onFinished:e.onFinished})}},1641:function(e,t,a){"use strict";var n=a(120),i=a.n(n),s=a(159),o=a(121),r=a(132);t.a=e=>{const t=r.b.get().brand,a=Object(o.b)("You've previously used %(brand)s on %(host)s with lazy loading of members enabled. In this version lazy loading is disabled. As the local cache is not compatible between these two settings, %(brand)s needs to resync your account.",{brand:t,host:e.host}),n=Object(o.b)("If the other version of %(brand)s is still open in another tab, please close it as using %(brand)s on the same host with both lazy loading enabled and disabled simultaneously will cause issues.",{brand:t});return i.a.createElement(s.a,{hasCancelButton:!1,title:Object(o.b)("Incompatible local cache"),description:i.a.createElement("div",null,i.a.createElement("p",null,a),i.a.createElement("p",null,n)),button:Object(o.b)("Clear cache and resync"),onFinished:e.onFinished})}},1642:function(e,t,a){"use strict";a.d(t,"a",(function(){return p}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(132),l=a(129),c=a(121),d=a(159),m=a(270),h=a(137),u=a(148);class p extends o.a.Component{constructor(){super(...arguments),i()(this,"sendBugReport",(()=>{l.b.createDialog(m.a,{error:this.props.error})})),i()(this,"onClearStorageClick",(()=>{l.b.createDialog(d.a,{title:Object(c.b)("Sign out"),description:o.a.createElement("div",null,Object(c.b)("Sign out and remove encryption keys?")),button:Object(c.b)("Sign out"),danger:!0,onFinished:this.props.onFinished})})),i()(this,"onRefreshClick",(()=>{window.location.reload()}))}render(){const e=r.b.get().brand,t=o.a.createElement("button",{onClick:this.onClearStorageClick,className:"danger"},Object(c.b)("Clear Storage and Sign Out"));let a;return a=r.b.get().bug_report_endpoint_url?o.a.createElement(u.a,{primaryButton:Object(c.b)("Send Logs"),onPrimaryButtonClick:this.sendBugReport,focus:!0,hasCancel:!1},t):o.a.createElement(u.a,{primaryButton:Object(c.b)("Refresh"),onPrimaryButtonClick:this.onRefreshClick,focus:!0,hasCancel:!1},t),o.a.createElement(h.a,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(c.b)("Unable to restore session"),contentId:"mx_Dialog_content",hasCancel:!1},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.b)("We encountered an error trying to restore your previous session.")),o.a.createElement("p",null,Object(c.b)("If you have previously used a more recent version of %(brand)s, your session may be incompatible with this version. Close this window and return to the more recent version.",{brand:e})),o.a.createElement("p",null,Object(c.b)("Clearing your browser's storage may fix the problem, but will sign you out and cause any encrypted chat history to become unreadable."))),a)}}},1643:function(e,t,a){"use strict";a.d(t,"a",(function(){return p}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(132),l=a(129),c=a(121),d=a(137),m=a(148),h=a(270),u=a(124);class p extends o.a.Component{constructor(){super(...arguments),i()(this,"sendBugReport",(e=>{e.preventDefault(),l.b.createDialog(h.a,{})})),i()(this,"onSignOutClick",(()=>{this.props.onFinished(!0)}))}render(){let e;return r.b.get().bug_report_endpoint_url&&(e=Object(c.b)("To help us prevent this in future, please <a>send us logs</a>.",{},{a:e=>o.a.createElement(u.a,{kind:"link_inline",onClick:this.sendBugReport},e)})),o.a.createElement(d.a,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(c.b)("Missing session data"),contentId:"mx_Dialog_content",hasCancel:!1},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o.a.createElement("p",null,Object(c.b)("Some session data, including encrypted message keys, is missing. Sign out and sign in to fix this, restoring keys from backup.")),o.a.createElement("p",null,Object(c.b)("Your browser likely removed this data when running low on disk space.")," ",e)),o.a.createElement(m.a,{primaryButton:Object(c.b)("Sign out"),onPrimaryButtonClick:this.onSignOutClick,focus:!0,hasCancel:!1}))}}},1644:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({viewBox:"-1 -1 13 13",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("g",{stroke:"#4A4A4A",strokeWidth:2.82,strokeLinecap:"square",fill:"none",fillRule:"evenodd"},i.createElement("path",{d:"M6 2.229V9.77M2.229 6H9.77"}))))}t.default="img/plus.e8a5e12.svg"},1645:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return Ye}));var n=a(131),i=a.n(n),s=a(122),o=a.n(s),r=a(120),l=a.n(r),c=a(136),d=a(215),m=a(297),h=a(16),u=a(1),p=a(150),g=a(172),b=(a(1646),a(1647),a(163)),v=a(961),f=a(123),E=a(158),y=a(132),_=a(125),S=a(281),w=a(129),O=a(236),C=a(234),x=a(493),j=(a(1648),a(1649),a(446)),k=a(223),R=a(121),I=a(126),T=a(585),N=a(965),P=a(396),D=a(1650),M=a(359),A=a(167),U=a(343),L=a(490),F=a(413),B=a(196),V=a(452),W=a(1741),z=a(128),H=a(985),K=a(1714),G=a(661),q=a(147),$=a(222),Y=a(138),J=a(956),Q=a(157),X=a(1715),Z=a(1716),ee=a(498),te=a(229),ae=a(194),ne=a(302),ie=a(135),se=a(159),oe=a(1742),re=a(588),le=a(1720),ce=a(1749),de=a(1721),me=a(1752),he=a(1743),ue=a(1753),pe=a(1754),ge=a(1755),be=a(421),ve=a(1729),fe=a(1756),Ee=a(199),ye=a(1757),_e=a(168),Se=a(230),we=a(192),Oe=a(617),Ce=a(186),xe=a(257),je=a(124),ke=a(379),Re=a(19),Ie=a(516),Te=a(319),Ne=a(185),Pe=a(176),De=a(139),Me=a(1750),Ae=a(224),Ue=a(154),Le=a(1730),Fe=a(197),Be=a(231),Ve=a(966),We=a(320),ze=a(201),He=a(203);function Ke(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Ge(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Ke(Object(a),!0).forEach((function(t){o()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Ke(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const qe=["register","login","forgot_password","start_sso","start_cas","welcome"],$e=[z.a.ViewUserSettings,"view_create_chat","view_create_room"];class Ye extends l.a.PureComponent{constructor(t){if(super(t),o()(this,"firstSyncComplete",!1),o()(this,"firstSyncPromise",void 0),o()(this,"screenAfterLogin",void 0),o()(this,"tokenLogin",void 0),o()(this,"focusComposer",void 0),o()(this,"subTitleStatus",void 0),o()(this,"prevWindowWidth",void 0),o()(this,"voiceBroadcastResumer",void 0),o()(this,"loggedInView",void 0),o()(this,"dispatcherRef",void 0),o()(this,"themeWatcher",void 0),o()(this,"fontWatcher",void 0),o()(this,"stores",void 0),o()(this,"onWindowResized",(()=>{this.warnInConsole()})),o()(this,"warnInConsole",Object(p.throttle)((()=>{const t="15px",a=Object(R.b)("Wait!"),n=Object(R.b)("If someone told you to copy/paste something here, there is a high likelihood you're being scammed!"),i=Object(R.b)("If you know what you're doing, Element is open-source, be sure to check out our GitHub (https://github.com/vector-im/element-web/) and contribute!");e.mx_rage_logger.bypassRageshake("log",`%c${a}\n%c${n}\n%c${i}`,"font-size:50px; color:blue;",`font-size:${t}; color:red;`,`font-size:${t};`)}),1e3)),o()(this,"onAction",(e=>{var t;if(null!==(t=f.a.get())&&void 0!==t&&t.isGuest()&&$e.includes(e.action))return _.a.dispatch({action:z.a.DoAfterSyncPrepared,deferred_action:e}),void _.a.dispatch({action:"require_registration"});switch(e.action){case"MatrixActions.accountData":if("m.identity_server"===e.event_type){const t=e.event_content?e.event_content.base_url:null;t?(f.a.get().setIdentityServerUrl(t),localStorage.removeItem("mx_is_access_token"),localStorage.setItem("mx_is_url",t)):(f.a.get().setIdentityServerUrl(void 0),localStorage.removeItem("mx_is_access_token"),localStorage.removeItem("mx_is_url")),_.a.dispatch({action:"id_server_changed"})}break;case"logout":Ce.b.instance.hangupAllCalls(),Promise.all([...[...Te.a.instance.activeCalls].map((e=>e.disconnect())),Object(Fe.D)(this.stores)]).finally((()=>x.i()));break;case"require_registration":Object(N.b)(e);break;case"start_registration":if(x.g()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.startRegistration(e.params||{});break;case"start_login":if(x.g()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.viewLogin();break;case"start_password_recovery":this.setStateForNewView({view:ke.a.FORGOT_PASSWORD}),this.notifyNewScreen("forgot_password");break;case"start_chat":Object(k.b)({dmUserId:e.user_id});break;case"leave_room":this.leaveRoom(e.room_id);break;case"forget_room":this.forgetRoom(e.room_id);break;case"copy_room":this.copyRoom(e.room_id);break;case"reject_invite":w.b.createDialog(se.a,{title:Object(R.b)("Reject invitation"),description:Object(R.b)("Are you sure you want to reject the invitation?"),onFinished:t=>{if(t){const t=w.b.createDialog(ie.a,void 0,"mx_Dialog_spinner");f.a.get().leave(e.room_id).then((()=>{t.close(),this.state.currentRoomId===e.room_id&&_.a.dispatch({action:z.a.ViewHomePage})}),(e=>{t.close(),w.b.createDialog(q.a,{title:Object(R.b)("Failed to reject invitation"),description:e.toString()})}))}}});break;case"view_user_info":this.viewUser(e.userId,e.subAction);break;case"MatrixActions.RoomState.events":{const t=e.event;t.getType()===c.EventType.RoomCanonicalAlias&&t.getRoomId()===this.state.currentRoomId&&this.viewRoom({action:z.a.ViewRoom,room_id:this.state.currentRoomId,metricsTrigger:void 0});break}case z.a.ViewRoom:{const t=this.viewRoom(e);e.deferred_action&&t.then((()=>{_.a.dispatch(e.deferred_action)}));break}case z.a.ViewUserDeviceSettings:Object(Le.a)(I.b.getValue("feature_new_device_manager"));break;case z.a.ViewUserSettings:{const t=e;w.b.createDialog(oe.a,{initialTabId:t.initialTabId},void 0,!1,!0),this.viewSomethingBehindModal();break}case"view_create_room":this.createRoom(e.public,e.defaultName,e.type),this.viewSomethingBehindModal();break;case z.a.ViewRoomDirectory:w.b.createDialog(Ve.b,{initialText:e.initialText,initialFilter:Ve.a.PublicRooms},"mx_SpotlightDialog_wrapper",!1,!0),this.viewSomethingBehindModal();break;case"view_welcome_page":this.viewWelcome();break;case z.a.ViewHomePage:this.viewHome(e.justRegistered);break;case z.a.ViewStartChatOrReuse:this.chatCreateOrReuse(e.user_id);break;case"view_create_chat":Object(O.f)(e.initialText||""),this.viewSomethingBehindModal();break;case"view_invite":{const t=f.a.get().getRoom(e.roomId);null!=t&&t.isSpaceRoom()?Object(xe.i)(t):Object(O.e)(e.roomId);break}case"view_last_screen":this.showScreenAfterLogin();break;case"hide_left_panel":this.setState({collapseLhs:!0},(()=>{this.state.resizeNotifier.notifyLeftHandleResized()}));break;case"show_left_panel":this.setState({collapseLhs:!1},(()=>{this.state.resizeNotifier.notifyLeftHandleResized()}));break;case z.a.OpenDialPad:w.b.createDialog(X.a,{},"mx_Dialog_dialPadWrapper");break;case z.a.OnLoggedIn:this.stores.client=f.a.get(),this.tokenLogin||x.g()||this.state.view===ke.a.LOGIN||this.state.view===ke.a.REGISTER||this.state.view===ke.a.COMPLETE_SECURITY||this.state.view===ke.a.E2E_SETUP||this.state.view===ke.a.USE_CASE_SELECTION||this.onLoggedIn();break;case"on_client_not_viable":this.onSoftLogout();break;case z.a.OnLoggedOut:this.onLoggedOut();break;case"will_start_client":this.setState({ready:!1},(()=>{this.onWillStartClient()}));break;case"client_started":this.onClientStarted();break;case"send_event":this.onSendEvent(e.room_id,e.event);break;case"aria_hide_main_app":this.setState({hideToSRUsers:!0});break;case"aria_unhide_main_app":this.setState({hideToSRUsers:!1});break;case z.a.PseudonymousAnalyticsAccept:Object(H.b)(),I.b.setValue("pseudonymousAnalyticsOptIn",null,Y.a.ACCOUNT,!0);break;case z.a.PseudonymousAnalyticsReject:Object(H.b)(),I.b.setValue("pseudonymousAnalyticsOptIn",null,Y.a.ACCOUNT,!1);break;case z.a.ShowThread:{const{rootEvent:t,initialEvent:a,highlighted:n,scrollIntoView:i,push:s}=e,o={phase:Ne.a.ThreadView,state:{threadHeadEvent:t,initialEvent:a,isInitialEventHighlighted:n,initialEventScrollIntoView:i}};null!=s&&s?Pe.a.instance.pushCard(o):Pe.a.instance.setCards([{phase:Ne.a.ThreadPanel},o]),_.a.dispatch({action:z.a.FocusSendMessageComposer,context:De.a.Thread});break}}})),o()(this,"handleResize",(()=>{const e=1e3,t=Ee.b.instance.windowWidth;this.prevWindowWidth<e&&t>=e&&_.a.dispatch({action:"show_left_panel"}),this.prevWindowWidth>=e&&t<e&&_.a.dispatch({action:"hide_left_panel"}),this.prevWindowWidth=t,this.state.resizeNotifier.notifyWindowResized()})),o()(this,"onRegisterClick",(()=>{this.showScreen("register")})),o()(this,"onLoginClick",(()=>{this.showScreen("login")})),o()(this,"onForgotPasswordClick",(()=>{this.showScreen("forgot_password")})),o()(this,"onRegisterFlowComplete",((e,t)=>this.onUserCompletedLoginFlow(e,t))),o()(this,"onUpdateStatusIndicator",((e,t)=>{const a=e.numUnreadStates;E.a.get()&&(E.a.get().setErrorStatus(t===d.b.Error),E.a.get().setNotificationCount(a)),this.subTitleStatus="",t===d.b.Error&&(this.subTitleStatus+=`[${Object(R.b)("Offline")}] `),a>0?this.subTitleStatus+=`[${a}]`:e.color>=He.a.Bold&&(this.subTitleStatus+="*"),this.setPageSubtitle()})),o()(this,"onServerConfigChange",(e=>{this.setState({serverConfig:e})})),o()(this,"makeRegistrationUrl",(e=>{var t;return null!==(t=this.props.startingFragmentQueryParams)&&void 0!==t&&t.referrer&&(e.referrer=this.props.startingFragmentQueryParams.referrer),this.props.makeRegistrationUrl(e)})),o()(this,"onUserCompletedLoginFlow",(async(e,t)=>{this.stores.accountPasswordStore.setPassword(t),await x.k(e),await this.postLoginSetup(),fe.b.instance.stop(fe.a.LOGIN),fe.b.instance.stop(fe.a.REGISTER)})),o()(this,"onCompleteSecurityE2eSetupFinished",(()=>{this.onLoggedIn()})),this.stores=Ue.b.instance,this.stores.constructEagerStores(),this.state={view:ke.a.LOADING,collapseLhs:!1,currentRoomId:null,currentUserId:null,hideToSRUsers:!1,syncError:null,resizeNotifier:new D.a,ready:!1},this.loggedInView=Object(r.createRef)(),y.b.put(this.props.config),this.firstSyncComplete=!1,this.firstSyncPromise=Object(h.m)(),this.props.config.sync_timeline_limit&&(f.a.opts.initialSyncLimit=this.props.config.sync_timeline_limit),this.screenAfterLogin=this.props.initialScreenAfterLogin,this.screenAfterLogin){const e=this.screenAfterLogin.params||{};if(this.screenAfterLogin.screen.startsWith("room/")&&e.signurl&&e.email){const t=this.screenAfterLogin.screen.substring("room/".length);J.a.instance.storeInvite(t,e)}}this.prevWindowWidth=Ee.b.instance.windowWidth||1e3,Ee.b.instance.on(Ee.a.Resize,this.handleResize),this.state.resizeNotifier.on("middlePanelResized",this.dispatchTimelineResize),$.a.instance.on($.b,this.onUpdateStatusIndicator),x.g()&&x.h(),this.dispatcherRef=_.a.register(this.onAction),this.themeWatcher=new U.a,this.fontWatcher=new L.a,this.themeWatcher.start(),this.fontWatcher.start(),this.focusComposer=!1,this.subTitleStatus="",x.g()||x.a(this.props.realQueryParams,this.props.defaultDeviceDisplayName,this.getFragmentAfterLogin()).then((async e=>{var t;if(null!==(t=this.props.realQueryParams)&&void 0!==t&&t.loginToken&&this.props.onTokenLoginCompleted(),e)return this.tokenLogin=!0,await x.j({ignoreGuest:!0}),this.postLoginSetup();const a=this.screenAfterLogin?this.screenAfterLogin.screen:null;return!!await this.loadSession()||("login"!==a&&"register"!==a&&"forgot_password"!==a||this.showScreenAfterLogin(),!1)})),Object(Oe.a)(y.b.get("sentry"))}async postLoginSetup(){const e=f.a.get(),t=e.isCryptoEnabled();t||this.onLoggedIn();const a=[this.firstSyncPromise.promise];let n=!1;t&&a.push((async()=>{n=await e.userHasCrossSigningKeys()})()),this.setState({pendingInitialSync:!0}),await Promise.all(a),t?(n?!1===ne.a.SHOW_ENCRYPTION_SETUP_UI?this.onLoggedIn():this.setStateForNewView({view:ke.a.COMPLETE_SECURITY}):await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")?this.setStateForNewView({view:ke.a.E2E_SETUP}):this.onLoggedIn(),this.setState({pendingInitialSync:!1})):this.setState({pendingInitialSync:!1})}setState(e,t){this.shouldTrackPageChange(this.state,Ge(Ge({},this.state),e))&&this.startPageChangeTimer(),super.setState(e,t)}componentDidMount(){window.addEventListener("resize",this.onWindowResized)}componentDidUpdate(e,t){if(this.shouldTrackPageChange(t,this.state)){const e=this.stopPageChangeTimer();b.b.instance.trackPageChange(this.state.view,this.state.page_type,e)}this.focusComposer&&(_.a.fire(z.a.FocusSendMessageComposer),this.focusComposer=!1)}componentWillUnmount(){x.m(),_.a.unregister(this.dispatcherRef),this.themeWatcher.stop(),this.fontWatcher.stop(),Ee.b.destroy(),this.state.resizeNotifier.removeListener("middlePanelResized",this.dispatchTimelineResize),window.removeEventListener("resize",this.onWindowResized),this.stores.accountPasswordStore.clearPassword(),this.voiceBroadcastResumer&&this.voiceBroadcastResumer.destroy()}getFallbackHsUrl(){var e;if(null!==(e=this.props.serverConfig)&&void 0!==e&&e.isDefault)return this.props.config.fallback_hs_url}getServerProperties(){let e=this.state.serverConfig;return e||(e=this.props.serverConfig),e||(e=y.b.get("validated_server_config")),{serverConfig:e}}loadSession(){return Promise.resolve().then((()=>x.h({fragmentQueryParams:this.props.startingFragmentQueryParams,enableGuest:this.props.enableGuest,guestHsUrl:this.getServerProperties().serverConfig.hsUrl,guestIsUrl:this.getServerProperties().serverConfig.isUrl,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName}))).then((e=>(e||(J.a.instance.pickBestInvite()?_.a.dispatch({action:"start_registration"}):_.a.dispatch({action:"view_welcome_page"})),e)))}startPageChangeTimer(){fe.b.instance.start(fe.a.PAGE_CHANGE)}stopPageChangeTimer(){const e=fe.b.instance;e.stop(fe.a.PAGE_CHANGE);const t=e.getEntries({name:fe.a.PAGE_CHANGE}).pop();return t?t.duration:null}shouldTrackPageChange(e,t){return e.currentRoomId!==t.currentRoomId||e.view!==t.view||e.page_type!==t.page_type}setStateForNewView(e){if(void 0===e.view)throw new Error("setStateForNewView with no view!");this.setState(Ge({currentUserId:void 0,justRegistered:!1},e))}setPage(e){this.setState({page_type:e})}async startRegistration(e){const t={view:ke.a.REGISTER};if(e.client_secret&&e.session_id&&e.hs_url&&e.is_url&&e.sid){t.serverConfig=await M.a.validateServerConfigWithStaticUrls(e.hs_url,e.is_url);const a=y.b.get("validated_server_config");a&&a.hsUrl===t.serverConfig.hsUrl&&(t.serverConfig.hsName=a.hsName,t.serverConfig.hsNameIsDifferent=a.hsNameIsDifferent,t.serverConfig.isDefault=a.isDefault,t.serverConfig.isNameResolvable=a.isNameResolvable),t.register_client_secret=e.client_secret,t.register_session_id=e.session_id,t.register_id_sid=e.sid}this.setStateForNewView(t),T.a.isLogin=!0,this.themeWatcher.recheck(),this.notifyNewScreen("register")}async viewRoom(e){var t;if(this.focusComposer=!0,e.room_alias?u.a.log(`Switching to room alias ${e.room_alias} at event ${e.event_id}`):u.a.log(`Switching to room id ${e.room_id} at event ${e.event_id}`),!this.firstSyncComplete){if(!this.firstSyncPromise)return void u.a.warn("Cannot view a room before first sync. room_id:",e.room_id);await this.firstSyncPromise.promise}let a=e.room_alias||e.room_id;const n=f.a.get().getRoom(e.room_id);if(n){var i;n.decryptAllEvents();const e=C.c(n);e&&(a=e,Object(F.b)(e,n.roomId)),null===(i=localStorage)||void 0===i||i.setItem("mx_last_room_id",n.roomId)}let s="#"===a[0]&&e.room_id===this.state.currentRoomId;var o,r,l,c;(Object(Ae.a)(this.state.currentRoomId)&&(s=!0),e.room_id===this.state.currentRoomId)&&(e.threepid_invite=null!==(o=e.threepid_invite)&&void 0!==o?o:this.state.threepidInvite,e.oob_data=null!==(r=e.oob_data)&&void 0!==r?r:this.state.roomOobData,e.forceTimeline=null!==(l=e.forceTimeline)&&void 0!==l?l:this.state.forceTimeline,e.justCreatedOpts=null!==(c=e.justCreatedOpts)&&void 0!==c?c:this.state.roomJustCreatedOpts);e.event_id&&e.highlighted&&(a+="/"+e.event_id),this.setState({view:ke.a.LOGGED_IN,currentRoomId:null!==(t=e.room_id)&&void 0!==t?t:null,page_type:j.a.RoomView,threepidInvite:e.threepid_invite,roomOobData:e.oob_data,forceTimeline:e.forceTimeline,ready:!0,roomJustCreatedOpts:e.justCreatedOpts},(()=>{T.a.isLogin=!1,this.themeWatcher.recheck(),this.notifyNewScreen("room/"+a,s)}))}viewSomethingBehindModal(){this.state.view===ke.a.LOGGED_IN?this.state.currentRoomId||this.state.currentUserId||this.viewHome():this.viewWelcome()}viewWelcome(){if(Object(ee.b)(y.b.get()))return this.viewLogin();this.setStateForNewView({view:ke.a.WELCOME}),this.notifyNewScreen("welcome"),T.a.isLogin=!0,this.themeWatcher.recheck()}viewLogin(e){this.setStateForNewView(Ge({view:ke.a.LOGIN},e)),this.notifyNewScreen("login"),T.a.isLogin=!0,this.themeWatcher.recheck()}viewHome(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.setStateForNewView({view:ke.a.LOGGED_IN,justRegistered:e,currentRoomId:null}),this.setPage(j.a.HomePage),this.notifyNewScreen("home"),T.a.isLogin=!1,this.themeWatcher.recheck()}viewUser(e,t){(this.firstSyncPromise?this.firstSyncPromise.promise:Promise.resolve()).then((()=>{"chat"!==t?(this.notifyNewScreen("user/"+e),this.setState({currentUserId:e}),this.setPage(j.a.UserView)):this.chatCreateOrReuse(e)}))}async createRoom(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0,a=arguments.length>2?arguments[2]:void 0;const n=w.b.createDialog(re.a,{type:a,defaultPublic:e,defaultName:t}),[i,s]=await n.finished;i&&Object(k.b)(s)}chatCreateOrReuse(e){const t=new Re.a(this.props.config);if(f.a.get().isGuest())return e!==t.get("welcome_user_id")&&_.a.dispatch({action:z.a.DoAfterSyncPrepared,deferred_action:{action:z.a.ViewStartChatOrReuse,user_id:e}}),void _.a.dispatch({action:"require_registration",go_welcome_on_cancel:!0,screen_after:{screen:`user/${t.get("welcome_user_id")}`,params:{action:"chat"}}});const a=f.a.get(),n=Object(We.a)(a,e);n?_.a.dispatch({action:z.a.ViewRoom,room_id:n.roomId,metricsTrigger:"MessageUser"}):_.a.dispatch({action:"start_chat",user_id:e})}leaveRoomWarnings(e){const t=f.a.get().getRoom(e),a=null==t?void 0:t.isSpaceRoom(),n=[];if(1===(null==t?void 0:t.currentState.getJoinedMemberCount()))return n.push(l.a.createElement("span",{className:"warning",key:"only_member_warning"}," ",Object(R.b)("You are the only person here. If you leave, no one will be able to join in the future, including you."))),n;const i=null==t?void 0:t.currentState.getStateEvents("m.room.join_rules","");if(i){"public"!==i.getContent().join_rule&&n.push(l.a.createElement("span",{className:"warning",key:"non_public_warning"}," ",a?Object(R.b)("This space is not public. You will not be able to rejoin without an invite."):Object(R.b)("This room is not public. You will not be able to rejoin without an invite.")))}return n}leaveRoom(e){var t,a;const n=f.a.get().getRoom(e),i=this.leaveRoomWarnings(e),s=null==n?void 0:n.isSpaceRoom();w.b.createDialog(se.a,{title:s?Object(R.b)("Leave space"):Object(R.b)("Leave room"),description:l.a.createElement("span",null,s?Object(R.b)("Are you sure you want to leave the space '%(spaceName)s'?",{spaceName:null!==(t=null==n?void 0:n.name)&&void 0!==t?t:Object(R.b)("Unnamed Space")}):Object(R.b)("Are you sure you want to leave the room '%(roomName)s'?",{roomName:null!==(a=null==n?void 0:n.name)&&void 0!==a?a:Object(R.b)("Unnamed Room")}),i),button:Object(R.b)("Leave"),onFinished:t=>{t&&(Object(Ie.a)(e),_.a.dispatch({action:z.a.AfterLeaveRoom,room_id:e}))}})}forgetRoom(e){const t=f.a.get().getRoom(e);f.a.get().forget(e).then((()=>{this.state.currentRoomId===e&&_.a.dispatch({action:z.a.ViewHomePage}),te.c.instance.manualRoomUpdate(t,ae.c.RoomRemoved)})).catch((e=>{const t=e.errcode||Object(R.d)("unknown error code");w.b.createDialog(q.a,{title:Object(R.b)("Failed to forget room %(errCode)s",{errCode:t}),description:e&&e.message?e.message:Object(R.b)("Operation failed")})}))}async copyRoom(e){const t=Object(_e.h)(e);await Object(Se.b)(t)||w.b.createDialog(q.a,{title:Object(R.b)("Unable to copy room link"),description:Object(R.b)("Unable to copy a link to the room to the clipboard.")})}async startWelcomeUserChat(){const e=new Re.a(this.props.config),t=e.get("welcome_user_id");if(!t)return null;let a;a=this.firstSyncComplete?Promise.resolve():this.firstSyncPromise.promise,await a;if(0===A.a.shared().getDMRoomsForUserId(t).length){const a=await Object(k.b)({dmUserId:e.get("welcome_user_id"),andView:!this.state.currentRoomId,spinner:!1}),n=e=>{e.getType()===c.EventType.Direct&&e.getContent()[t]&&(f.a.get().store.save(!0),f.a.get().removeListener(c.ClientEvent.AccountData,n))};return f.a.get().on(c.ClientEvent.AccountData,n),a}return null}async onLoggedIn(){if(T.a.isLogin=!1,this.themeWatcher.recheck(),V.f(),!f.a.currentUserIsJustRegistered()||null!==I.b.getValue("FTUE.useCaseSelection"))return this.onShowPostLoginScreen();this.setStateForNewView({view:ke.a.USE_CASE_SELECTION}),I.b.watchSetting("FTUE.useCaseSelection",null,((e,t,a,n,i)=>{null!==i&&this.state.view===ke.a.USE_CASE_SELECTION&&this.onShowPostLoginScreen()}))}async onShowPostLoginScreen(e){var t;if(e&&(we.a.instance.setProperty("ftueUseCaseSelection",e),I.b.setValue("FTUE.useCaseSelection",null,Y.a.ACCOUNT,e)),this.setStateForNewView({view:ke.a.LOGGED_IN}),null!==(t=this.screenAfterLogin)&&void 0!==t&&t.screen)this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=void 0;else if(f.a.currentUserIsJustRegistered()){f.a.setJustRegisteredUserId(null);if(new Re.a(this.props.config).get("welcome_user_id")&&Object(R.f)().startsWith("en")){null===await this.startWelcomeUserChat()&&_.a.dispatch({action:z.a.ViewHomePage,justRegistered:!0})}else if(J.a.instance.pickBestInvite()){const e=J.a.instance.pickBestInvite(),t=J.a.instance.translateToWireFormat(e);this.showScreen(`room/${e.roomId}`,t)}else _.a.dispatch({action:z.a.ViewHomePage,justRegistered:!0})}else this.showScreenAfterLogin();y.b.get("mobile_guide_toast")&&Object(Z.a)(),I.b.getValue("scShowUpdateAnnouncementRoomToast")&&Object(K.a)();const a=y.b.get("user_notice");if(a){const e="user_notice_"+a.title;a.show_once&&localStorage.getItem(e)||B.a.sharedInstance().addOrReplaceToast({key:e,title:a.title,props:{description:l.a.createElement(ze.a,null,a.description),acceptLabel:Object(R.b)("OK"),onAccept:()=>{B.a.sharedInstance().dismissToast(e),localStorage.setItem(e,"1")}},component:Be.a,className:"mx_AnalyticsToast",priority:100})}}initPosthogAnalyticsToast(){null===I.b.getValue("pseudonymousAnalyticsOptIn")&&Object(H.c)(),I.b.watchSetting("pseudonymousAnalyticsOptIn",null,((e,t,a,n,i)=>{null===i?Object(H.c)():Object(H.b)()}))}showScreenAfterLogin(){this.screenAfterLogin&&this.screenAfterLogin.screen?(this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=void 0):!I.b.getValue("Spaces.returnToPreviouslyOpenedRoom")&&localStorage&&localStorage.getItem("mx_active_space")&&"!"===localStorage.getItem("mx_active_space")[0]?this.viewLastSpace():I.b.getValue("Spaces.returnToPreviouslyOpenedRoom")&&localStorage&&localStorage.getItem("mx_last_room_id")?this.viewLastRoom():f.a.get().isGuest()?_.a.dispatch({action:"view_welcome_page"}):_.a.dispatch({action:z.a.ViewHomePage})}viewLastSpace(){_.a.dispatch({action:z.a.ViewRoom,room_id:localStorage.getItem("mx_active_space")})}viewLastRoom(){var e;_.a.dispatch({action:z.a.ViewRoom,room_id:null!==(e=localStorage.getItem("mx_last_room_id"))&&void 0!==e?e:void 0,metricsTrigger:void 0})}onLoggedOut(){this.viewLogin({ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle(),this.stores.onLoggedOut()}onSoftLogout(){this.notifyNewScreen("soft_logout"),this.setStateForNewView({view:ke.a.SOFT_LOGOUT,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onWillStartClient(){this.firstSyncComplete=!1,this.firstSyncPromise=Object(h.m)();const e=f.a.get();e.setCanResetTimelineCallback((e=>(u.a.log("Request to reset timeline in room ",e," viewing:",this.state.currentRoomId),e!==this.state.currentRoomId||(!this.loggedInView.current||this.loggedInView.current.canResetTimelineInRoom(e))))),e.on(c.ClientEvent.Sync,((e,t,a)=>{var n;e===d.b.Error||e===d.b.Reconnecting?((null==a?void 0:a.error)instanceof m.c&&x.d(a.error),this.setState({syncError:null!==(n=null==a?void 0:a.error)&&void 0!==n?n:null})):this.state.syncError&&this.setState({syncError:null});e===d.b.Syncing&&t===d.b.Syncing||(u.a.info("MatrixClient sync state => %s",e),e===d.b.Prepared&&(this.firstSyncComplete=!0,this.firstSyncPromise.resolve(),S.default.shouldShowPrompt()&&!f.a.userRegisteredWithinLastHours(24)&&Object(G.b)(!1),_.a.fire(z.a.FocusSendMessageComposer),this.setState({ready:!0})))})),e.on(c.HttpApiEvent.SessionLoggedOut,(function(e){if(!x.f()){if(w.b.closeCurrentModal("Session.logged_out"),401===e.httpStatus&&e.data&&e.data.soft_logout)return u.a.warn("Soft logout issued by server - avoiding data deletion"),void x.l();w.b.createDialog(q.a,{title:Object(R.b)("Signed Out"),description:Object(R.b)("For security, this session has been signed out. Please sign in again.")}),_.a.dispatch({action:"logout"})}})),e.on(c.HttpApiEvent.NoConsent,(function(t,a){w.b.createDialog(se.a,{title:Object(R.b)("Terms and Conditions"),description:l.a.createElement("div",null,l.a.createElement("p",null," ",Object(R.b)("To continue using the %(homeserverDomain)s homeserver you must review and agree to our terms and conditions.",{homeserverDomain:e.getDomain()}))),button:Object(R.b)("Review terms and conditions"),cancelButton:Object(R.b)("Dismiss"),onFinished:e=>{if(e){window.open(a,"_blank").opener=null}}},void 0,!0)}));const t=v.a.instance;t.start(),e.on(c.HttpApiEvent.SessionLoggedOut,(()=>t.stop())),e.on(c.MatrixEventEvent.Decrypted,((e,a)=>t.eventDecrypted(e,a))),e.on(c.ClientEvent.Room,(e=>{if(f.a.get().isCryptoEnabled()){const t=I.b.getValueAt(Y.a.ROOM_DEVICE,"blacklistUnverifiedDevices",e.roomId,!0);e.setBlacklistUnverifiedDevices(t)}})),e.on(g.b.Warning,(e=>{if("CRYPTO_WARNING_OLD_VERSION_DETECTED"===e)w.b.createDialog(q.a,{title:Object(R.b)("Old cryptography data detected"),description:Object(R.b)("Data from an older version of %(brand)s has been detected. This will have caused end-to-end cryptography to malfunction in the older version. End-to-end encrypted messages exchanged recently whilst using the older version may not be decryptable in this version. This may also cause messages exchanged with this version to fail. If you experience problems, log out and back in again. To retain message history, export and re-import your keys.",{brand:y.b.get().brand})})})),e.on(g.b.KeyBackupFailed,(async e=>{let t,n;if(f.a.get().getKeyBackupEnabled())t=!0;else try{n=await f.a.get().getKeyBackupVersion(),null!==n&&(t=!0)}catch(e){return void u.a.error("Saw key backup error but failed to check backup version!",e)}t?w.b.createDialogAsync(a.e(40).then(a.bind(null,1731)),{newVersionInfo:n}):w.b.createDialogAsync(a.e(41).then(a.bind(null,1732)))})),e.on(g.b.KeySignatureUploadFailure,((e,t,a)=>{w.b.createDialog(le.a,{failures:e,source:t,continuation:a})})),e.on(g.b.VerificationRequest,(e=>{e.verifier?w.b.createDialog(ce.a,{verifier:e.verifier},void 0,!1,!0):e.pending&&B.a.sharedInstance().addOrReplaceToast({key:"verifreq_"+e.channel.transactionId,title:Object(R.b)("Verification requested"),icon:"verification",props:{request:e},component:ve.a,priority:90})})),this.voiceBroadcastResumer=new Fe.z(e)}onClientStarted(){const e=f.a.get();if(e.isCryptoEnabled()){const t=I.b.getValueAt(Y.a.DEVICE,"blacklistUnverifiedDevices");e.setGlobalBlacklistUnverifiedDevices(t),e.setGlobalErrorOnUnknownDevices(!1)}we.a.instance.isEnabled()&&I.b.isLevelSupported(Y.a.ACCOUNT)&&this.initPosthogAnalyticsToast()}showScreen(e,t){const a=f.a.get();if(!a||a.isGuest()||!qe.includes(e))if("register"===e)_.a.dispatch({action:"start_registration",params:t}),fe.b.instance.start(fe.a.REGISTER);else if("login"===e)_.a.dispatch({action:"start_login",params:t}),fe.b.instance.start(fe.a.LOGIN);else if("forgot_password"===e)_.a.dispatch({action:"start_password_recovery",params:t});else if("soft_logout"===e)a.getUserId()&&!x.g()?this.viewLastRoom():_.a.dispatch({action:"start_login",params:t});else if("new"===e)_.a.dispatch({action:"view_create_room"});else if("dm"===e)_.a.dispatch({action:"view_create_chat"});else if("settings"===e)_.a.fire(z.a.ViewUserSettings);else if("welcome"===e)_.a.dispatch({action:"view_welcome_page"});else if("home"===e)_.a.dispatch({action:z.a.ViewHomePage});else if("start"===e)this.showScreen("home"),_.a.dispatch({action:"require_registration"});else if("directory"===e)_.a.fire(z.a.ViewRoomDirectory);else if("start_sso"===e||"start_cas"===e){var n;let t=f.a.get();if(!t){const{hsUrl:e,isUrl:a}=this.props.serverConfig;t=Object(c.createClient)({baseUrl:e,idBaseUrl:a})}const a="start_sso"===e?"sso":"cas";null===(n=E.a.get())||void 0===n||n.startSingleSignOn(t,a,this.getFragmentAfterLogin())}else if(0===e.indexOf("room/")){var i,s,o;const a=e.substring(5),n=a.indexOf(":")+1;let r=a.length;a.substring(n).indexOf("/")>-1&&(r=n+a.substring(n).indexOf("/"));const l=a.substring(0,r);let c,d=a.substring(r+1);if(d||(d=void 0),null!=t&&t.signurl&&null!=t&&t.email&&(c=J.a.instance.storeInvite(l,t)),!c){c=J.a.instance.getInvites().find((e=>e.roomId===l))}let m=[];null!=t&&t.via&&(m="string"==typeof t.via?[t.via]:t.via);const h={action:z.a.ViewRoom,event_id:d,via_servers:m,highlighted:Boolean(d),threepid_invite:c,oob_data:{name:null===(i=c)||void 0===i?void 0:i.roomName,avatarUrl:null===(s=c)||void 0===s?void 0:s.roomAvatarUrl,inviterName:null===(o=c)||void 0===o?void 0:o.inviterName},room_alias:void 0,room_id:void 0,metricsTrigger:void 0};"#"===l[0]?h.room_alias=l:h.room_id=l,_.a.dispatch(h)}else if(0===e.indexOf("user/")){const a=e.substring(5);_.a.dispatch({action:"view_user_info",userId:a,subAction:null==t?void 0:t.action})}else u.a.info("Ignoring showScreen for '%s'",e);else _.a.dispatch({action:z.a.ViewHomePage})}notifyNewScreen(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.props.onNewScreen&&this.props.onNewScreen(e,t),this.setPageSubtitle()}onLogoutClick(e){_.a.dispatch({action:"logout"}),e.stopPropagation(),e.preventDefault()}dispatchTimelineResize(){_.a.dispatch({action:"timeline_resize"})}onRegistered(e){return x.k(e)}onSendEvent(e,t){const a=f.a.get();a&&a.sendEvent(e,t.getType(),t.getContent()).then((()=>{_.a.dispatch({action:"message_sent"})}))}setPageSubtitle(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(this.state.currentRoomId){const t=f.a.get(),a=t&&t.getRoom(this.state.currentRoomId);a&&(e=`${this.subTitleStatus} | ${a.name} ${e}`)}else e=`${this.subTitleStatus} ${e}`;const t=`${y.b.get().brand} ${e}`;document.title!==t&&(document.title=t)}getFragmentAfterLogin(){let e="";const t=this.props.initialScreenAfterLogin;return t&&!["welcome","login","register","start_sso","start_cas"].includes(t.screen)&&(e=`/${t.screen}`),e}render(){const e=this.getFragmentAfterLogin();let t;if(this.state.view===ke.a.LOADING)t=l.a.createElement("div",{className:"mx_MatrixChat_splash"},l.a.createElement(ie.a,null));else if(this.state.view===ke.a.COMPLETE_SECURITY)t=l.a.createElement(de.a,{onFinished:this.onCompleteSecurityE2eSetupFinished});else if(this.state.view===ke.a.E2E_SETUP)t=l.a.createElement(ue.a,{onFinished:this.onCompleteSecurityE2eSetupFinished,accountPassword:this.stores.accountPasswordStore.getPassword(),tokenLogin:!!this.tokenLogin});else if(this.state.view===ke.a.LOGGED_IN){const e=this.state.syncError&&this.state.syncError instanceof m.c;if(this.state.ready&&this.state.page_type&&!e)t=l.a.createElement(W.a,i()({},this.props,this.state,{ref:this.loggedInView,matrixClient:f.a.get(),onRegistered:this.onRegistered,currentRoomId:this.state.currentRoomId}));else{let a;this.state.syncError&&!e&&(a=l.a.createElement("div",{className:"mx_MatrixChat_syncError"},Object(P.b)(this.state.syncError))),t=l.a.createElement("div",{className:"mx_MatrixChat_splash"},a,l.a.createElement(ie.a,null),l.a.createElement("div",{className:"mx_MatrixChat_splashButtons"},l.a.createElement(je.a,{kind:"link_inline",onClick:this.onLogoutClick},Object(R.b)("Logout"))))}}else if(this.state.view===ke.a.WELCOME)t=l.a.createElement(me.a,null);else if(this.state.view===ke.a.REGISTER&&I.b.getValue(Q.b.Registration)){var a;const n=null===(a=J.a.instance.pickBestInvite())||void 0===a?void 0:a.toEmail;t=l.a.createElement(pe.a,i()({clientSecret:this.state.register_client_secret,sessionId:this.state.register_session_id,idSid:this.state.register_id_sid,email:n,brand:this.props.config.brand,makeRegistrationUrl:this.makeRegistrationUrl,onLoggedIn:this.onRegisterFlowComplete,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,fragmentAfterLogin:e},this.getServerProperties()))}else if(this.state.view===ke.a.FORGOT_PASSWORD&&I.b.getValue(Q.b.PasswordReset))t=l.a.createElement(he.a,i()({onComplete:this.onLoginClick,onLoginClick:this.onLoginClick},this.getServerProperties()));else if(this.state.view===ke.a.LOGIN){const a=I.b.getValue(Q.b.PasswordReset);t=l.a.createElement(ge.a,i()({isSyncing:this.state.pendingInitialSync,onLoggedIn:this.onUserCompletedLoginFlow,onRegisterClick:this.onRegisterClick,fallbackHsUrl:this.getFallbackHsUrl(),defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,onForgotPasswordClick:a?this.onForgotPasswordClick:void 0,onServerConfigChange:this.onServerConfigChange,fragmentAfterLogin:e,defaultUsername:this.props.startingFragmentQueryParams.defaultUsername},this.getServerProperties()))}else if(this.state.view===ke.a.SOFT_LOGOUT)t=l.a.createElement(ye.a,{realQueryParams:this.props.realQueryParams,onTokenLoginCompleted:this.props.onTokenLoginCompleted,fragmentAfterLogin:e});else{if(this.state.view!==ke.a.USE_CASE_SELECTION)return u.a.error(`Unknown view ${this.state.view}`),null;t=l.a.createElement(Me.a,{onFinished:e=>this.onShowPostLoginScreen(e)})}return l.a.createElement(be.a,null,l.a.createElement(Ue.a.Provider,{value:this.stores},t))}}o()(Ye,"displayName","MatrixChat"),o()(Ye,"defaultProps",{realQueryParams:{},startingFragmentQueryParams:{},config:{},onTokenLoginCompleted:()=>{}})}).call(this,a(14))},1648:function(e,t,a){"use strict";var n=a(128),i=a(125),s=a(156);const o={deferredAction:null};class r extends s.a{constructor(){super(i.a,o)}onDispatch(e){switch(e.action){case n.a.DoAfterSyncPrepared:this.updateState({deferredAction:e.deferred_action});break;case"cancel_after_sync_prepared":this.updateState({deferredAction:null});break;case"MatrixActions.sync":{if("PREPARED"!==e.state)break;if(!this.state.deferredAction)break;const t=Object.assign({},this.state.deferredAction);this.updateState({deferredAction:null}),i.a.dispatch(t);break}case"on_client_not_viable":case n.a.OnLoggedOut:this.reset()}}}let l=null;l||(l=new r)},1649:function(e,t,a){"use strict";var n=a(122),i=a.n(n),s=a(136),o=a(16),r=a(132),l=a(399),c=a(125),d=a(202),m=a(126),h=a(128);function u(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function p(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?u(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):u(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const g="im.vector.auto_rs_request";class b extends d.a{constructor(){super(c.a,{reportedSessionIds:new Set,lastRageshakeTime:0,initialSyncCompleted:!1}),this.onDecryptionAttempt=this.onDecryptionAttempt.bind(this),this.onDeviceMessage=this.onDeviceMessage.bind(this),this.onSyncStateChange=this.onSyncStateChange.bind(this)}static get instance(){return b.internalInstance}async onAction(e){if(e.action===h.a.ReportKeyBackupNotEnabled)this.onReportKeyBackupNotEnabled()}async onReady(){m.b.getValue("automaticDecryptionErrorReporting")&&this.matrixClient&&(this.matrixClient.on(s.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.on(s.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.on(s.ClientEvent.Sync,this.onSyncStateChange))}async onNotReady(){this.matrixClient&&(this.matrixClient.removeListener(s.ClientEvent.ToDeviceEvent,this.onDeviceMessage),this.matrixClient.removeListener(s.MatrixEventEvent.Decrypted,this.onDecryptionAttempt),this.matrixClient.removeListener(s.ClientEvent.Sync,this.onSyncStateChange))}async onDecryptionAttempt(e){if(!this.state.initialSyncCompleted)return;const t=e.getWireContent(),a=t.session_id;if(e.isDecryptionFailure()&&!this.state.reportedSessionIds.has(a)){var n;if(await Object(o.N)(5e3),!e.isDecryptionFailure())return;const i=new Set(this.state.reportedSessionIds);await this.updateState({reportedSessionIds:i.add(a)});const s=(new Date).getTime();if(s-this.state.lastRageshakeTime<6e4)return;await this.updateState({lastRageshakeTime:s});const c={event_id:e.getId(),room_id:e.getRoomId(),session_id:a,device_id:t.device_id,user_id:e.getSender(),sender_key:t.sender_key},d=await Object(l.a)(r.b.get().bug_report_endpoint_url,{userText:"Auto-reporting decryption error (recipient)",sendLogs:!0,labels:["Z-UISI","web","uisi-recipient"],customApp:r.b.get().uisi_autorageshake_app,customFields:{auto_uisi:JSON.stringify(c)}}),m=p(p({},c),{},{recipient_rageshake:d});null===(n=this.matrixClient)||void 0===n||n.sendToDevice(g,new Map([["messageContent.user_id",new Map([[m.device_id,m]])]]))}}async onSyncStateChange(e,t,a){this.state.initialSyncCompleted||await this.updateState({initialSyncCompleted:!!a.nextSyncToken})}async onDeviceMessage(e){if(e.getType()!==g)return;const t=e.getContent(),a=t.recipient_rageshake||"",n=(new Date).getTime();n-this.state.lastRageshakeTime>6e4&&(await this.updateState({lastRageshakeTime:n}),await Object(l.a)(r.b.get().bug_report_endpoint_url,{userText:`Auto-reporting decryption error (sender)\nRecipient rageshake: ${a}`,sendLogs:!0,labels:["Z-UISI","web","uisi-sender"],customApp:r.b.get().uisi_autorageshake_app,customFields:{recipient_rageshake:a,auto_uisi:JSON.stringify(t)}}))}async onReportKeyBackupNotEnabled(){m.b.getValue("automaticKeyBackNotEnabledReporting")&&await Object(l.a)(r.b.get().bug_report_endpoint_url,{userText:"Auto-reporting key backup not enabled",sendLogs:!0,labels:["web",h.a.ReportKeyBackupNotEnabled]})}}i()(b,"internalInstance",(()=>{const e=new b;return e.start(),e})()),window.mxAutoRageshakeStore=b.instance},1650:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n=a(122),i=a.n(n),s=a(17),o=a(150);class r extends s.EventEmitter{constructor(){super(...arguments),i()(this,"_isResizing",!1),i()(this,"throttledMiddlePanel",Object(o.throttle)((()=>this.emit("middlePanelResized")),200))}get isResizing(){return this._isResizing}startResizing(){this._isResizing=!0,this.emit("isResizing",!0)}stopResizing(){this._isResizing=!1,this.emit("isResizing",!1)}noisyMiddlePanel(){this.emit("middlePanelResizedNoisy")}updateMiddlePanel(){this.throttledMiddlePanel(),this.noisyMiddlePanel()}notifyLeftHandleResized(){this.updateMiddlePanel()}notifyRightHandleResized(){this.updateMiddlePanel()}notifyTimelineHeightChanged(){this.updateMiddlePanel()}notifyWindowResized(){this.updateMiddlePanel()}}},1651:function(e,t,a){"use strict";a.d(t,"a",(function(){return s}));var n=a(120);const i=100;function s(e,t,a){Object(n.useEffect)((()=>{let n=null;const s=()=>{n=null,t(...a)};if(!1!==e)return n=window.setTimeout(s,i),()=>{n&&clearTimeout(n)}}),[e,t,a])}},1652:function(e,t,a){"use strict";a.d(t,"a",(function(){return l}));var n=a(120),i=a(123),s=a(138),o=a(126),r=a(144);const l=()=>{const[e,t]=Object(n.useState)((()=>{const e=i.a.get(),t=o.b.getValue("SpotlightSearch.recentSearches",null);return Object(r.n)(t.map((t=>e.getRoom(t))))}));return[e,()=>{o.b.setValue("SpotlightSearch.recentSearches",null,s.a.ACCOUNT,[]),t([])}]}},1653:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n=a(120),i=a(123),s=a(670);const o=()=>{const[e,t]=Object(n.useState)(null),[a,o]=Object(n.useState)(!1),[r,l]=Object(s.a)(t);return{ready:!0,loading:a,profile:e,search:Object(n.useCallback)((async e=>{let{query:a}=e;if(r(a),null==a||!a.length||!a.startsWith("@")||!a.includes(":"))return t(null),!0;o(!0);try{const e=await i.a.get().getProfileInfo(a);return l(a,{user_id:a,avatar_url:e.avatar_url,display_name:e.displayname}),!0}catch(e){return console.error("Could not fetch profile info for params",{term:a},e),l(a,null),!1}finally{o(!1)}}),[r,l])}}},1654:function(e,t,a){"use strict";a.d(t,"a",(function(){return g}));var n=a(120),i=a(123),s=a(132),o=a(126),r=a(670),l=a(169);const c="ALL_ROOMS",d="mx_last_room_directory_server",m="mx_last_room_directory_instance";let h;const u="nsfw",p=e=>{var t,a;return!(null!==(t=e.name)&&void 0!==t&&t.toLocaleLowerCase().includes(u)||null!==(a=e.topic)&&void 0!==a&&a.toLocaleLowerCase().includes(u))},g=()=>{const[e,t]=Object(n.useState)([]),[a,u]=Object(n.useState)(void 0),[g,b]=Object(n.useState)(null),[v,f]=Object(n.useState)(!1),[E,y]=Object(n.useState)(!1),[_,S]=Object(r.a)(t),w=Object(l.b)("SpotlightSearch.showNsfwPublicRooms");const O=Object(n.useCallback)((async e=>{let{limit:t=20,query:n,roomTypes:s}=e;const o={limit:t};(null==a?void 0:a.roomServer)!=i.a.getHomeserverName()&&(o.server=null==a?void 0:a.roomServer),(null==a?void 0:a.instanceId)===c?o.include_all_networks=!0:null!=a&&a.instanceId&&(o.third_party_instance_id=a.instanceId),(n||s)&&(o.filter={generic_search_term:n,room_types:s&&await i.a.get().doesServerSupportUnstableFeature("org.matrix.msc3827.stable")?Array.from(s):void 0}),_(o);try{y(!0);const{chunk:e}=await i.a.get().publicRooms(o);return S(o,w?e:e.filter(p)),!0}catch(e){return console.error("Could not fetch public rooms for params",o,e),S(o,[]),!1}finally{y(!1)}}),[a,_,S,w]);return Object(n.useEffect)((()=>{!async function(){if(i.a.get())if(h)b(h);else{const e=await i.a.get().getThirdpartyProtocols();h=e,b(e)}else f(!0)}()}),[]),Object(n.useEffect)((()=>{var e,t,a,n;if(null===g)return;const r=i.a.getHomeserverName(),l=localStorage.getItem(d),h=null!==(e=localStorage.getItem(m))&&void 0!==e?e:void 0;let p,b=r;l&&(null!==(t=s.b.getObject("room_directory"))&&void 0!==t&&null!==(a=t.get("servers"))&&void 0!==a&&a.includes(l)||null!==(n=o.b.getValue("room_directory_servers"))&&void 0!==n&&n.includes(l))&&(b=l),b!==r||h!==c&&!Object.values(g).some((e=>{e.instances.some((e=>e.instance_id===h))}))||(p=h),f(!0),u({roomServer:b,instanceId:p})}),[g]),Object(n.useEffect)((()=>{a&&(localStorage.setItem(d,a.roomServer),a.instanceId?localStorage.setItem(m,a.instanceId):localStorage.removeItem(m))}),[a]),{ready:v,loading:E,publicRooms:e,protocols:g,config:a,search:O,setConfig:function(e){if(!v)throw new Error("public room configuration not initialised yet");u(e)}}}},1655:function(e,t,a){"use strict";a.d(t,"a",(function(){return l}));var n=a(120),i=a(136),s=a(967),o=a(16),r=a(123);const l=(e,t)=>{var a;const[l,c]=Object(n.useState)([]),[d,m]=Object(n.useState)(),h=Object(n.useCallback)((()=>{m(e?new s.a(e,50):void 0)}),[e]);Object(n.useEffect)(h,[h]),Object(n.useEffect)((()=>{if(!e||!d)return;let t=!1;return(async()=>{for(;null!=d&&d.canLoadMore&&!t&&e===d.root;)await d.load(),d.canLoadMore&&d.load(),c(d.rooms)})(),()=>{t=!0}}),[e,d]);return[Object(n.useMemo)((()=>{const e=t.trim(),a=e.toLowerCase(),n=Object(o.B)(e),s=r.a.get();return null==l?void 0:l.filter((e=>{var t;return e.room_type!==i.RoomType.Space&&"join"!==(null===(t=s.getRoom(e.room_id))||void 0===t?void 0:t.getMyMembership())&&(Object(o.B)(e.name||"").includes(n)||(e.canonical_alias||"").includes(a))}))}),[l,t]),null!==(a=null==d?void 0:d.loading)&&void 0!==a&&a]}},1656:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n=a(120),i=a(123),s=a(425),o=a(670);const r=()=>{const[e,t]=Object(n.useState)([]),[a,r]=Object(n.useState)(!1),[l,c]=Object(o.a)(t);return{ready:!0,loading:a,users:e,search:Object(n.useCallback)((async e=>{let{limit:a=20,query:n}=e;const o={limit:a,term:n};if(l(o),null==n||!n.length)return t([]),!0;try{r(!0);const{results:e}=await i.a.get().searchUserDirectory(o);return c(o,e.map((e=>new s.a(e)))),!0}catch(e){return console.error("Could not fetch user in user directory for params",{limit:a,term:n},e),c(o,[]),!1}finally{r(!1)}}),[l,c])}}},1657:function(e,t,a){"use strict";a.d(t,"a",(function(){return p}));var n=a(131),i=a.n(n),s=a(134),o=a.n(s),r=a(127),l=a.n(r),c=a(120),d=a.n(c),m=a(170),h=a(124);const u=["inputRef","children","endAdornment","className"],p=e=>{let{inputRef:t,children:a,endAdornment:n,className:s}=e,r=o()(e,u);const[c,p,g]=Object(m.i)(t);return d.a.createElement(h.a,i()({},r,{className:l()(s,"mx_SpotlightDialog_option"),onFocus:c,inputRef:g,tabIndex:-1,"aria-selected":p,role:"option"}),a,d.a.createElement("div",{className:"mx_SpotlightDialog_option--endAdornment"},d.a.createElement("kbd",{className:"mx_SpotlightDialog_enterPrompt","aria-hidden":!0},"↵"),n))}},1658:function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var n=a(120),i=a.n(n),s=a(201),o=a(121),r=a(234);const l=80,c=800;function d(e){var t,a,n;let{room:d,labelId:m,descriptionId:h,detailsId:u}=e,p=d.name||Object(r.b)(null!==(t=d.canonical_alias)&&void 0!==t?t:"",null!==(a=d.aliases)&&void 0!==a?a:[])||Object(o.b)("Unnamed room");p.length>l&&(p=`${p.substring(0,l)}...`);let g=d.topic||"";return g.length>c&&(g=`${g.substring(0,c)}...`),i.a.createElement("div",{className:"mx_SpotlightDialog_result_publicRoomDetails"},i.a.createElement("div",{className:"mx_SpotlightDialog_result_publicRoomHeader"},i.a.createElement("span",{id:m,className:"mx_SpotlightDialog_result_publicRoomName"},p),i.a.createElement("span",{id:h,className:"mx_SpotlightDialog_result_publicRoomAlias"},null!==(n=d.canonical_alias)&&void 0!==n?n:d.room_id)),i.a.createElement("div",{id:u,className:"mx_SpotlightDialog_result_publicRoomDescription"},i.a.createElement("span",{className:"mx_SpotlightDialog_result_publicRoomMemberCount"},Object(o.b)("%(count)s Members",{count:d.num_joined_members})),g&&i.a.createElement(i.a.Fragment,null," · ",i.a.createElement("span",{className:"mx_SpotlightDialog_result_publicRoomTopic",dangerouslySetInnerHTML:{__html:Object(s.f)(g)}}))))}},1659:function(e,t,a){"use strict";a.d(t,"a",(function(){return v}));var n=a(131),i=a.n(n),s=a(127),o=a.n(s),r=a(120),l=a.n(r),c=a(342),d=a(632),m=a(121),h=a(266),u=a(898),p=a(896),g=a(671),b=a(476);function v(e){let{room:t}=e;const[a]=Object(d.a)(t),[n,s]=Object(r.useState)(null),[v,f]=Object(r.useState)(null);let E,y;null!==n&&(E=t.isSpaceRoom()?l.a.createElement(g.a,i()({},Object(b.a)(n),{space:t,onFinished:()=>s(null)})):l.a.createElement(u.a,i()({},Object(b.a)(n),{room:t,onFinished:()=>s(null)}))),null!==v&&(y=l.a.createElement(p.a,i()({},Object(b.a)(v),{room:t,onFinished:()=>f(null)})));const _=o()("mx_SpotlightDialog_option--notifications",{mx_RoomNotificationContextMenu_iconBell:a===h.a.AllMessages,mx_RoomNotificationContextMenu_iconBellDot:a===h.a.AllMessagesLoud,mx_RoomNotificationContextMenu_iconBellMentions:a===h.a.MentionsOnly,mx_RoomNotificationContextMenu_iconBellCrossed:a===h.a.Mute});return l.a.createElement(r.Fragment,null,l.a.createElement(c.a,{className:"mx_SpotlightDialog_option--menu",onClick:e=>{e.preventDefault(),e.stopPropagation();const t=e.target;s(t.getBoundingClientRect())},title:t.isSpaceRoom()?Object(m.b)("Space options"):Object(m.b)("Room options"),isExpanded:null!==n}),!t.isSpaceRoom()&&l.a.createElement(c.a,{className:_,onClick:e=>{e.preventDefault(),e.stopPropagation();const t=e.target;f(t.getBoundingClientRect())},title:Object(m.b)("Notification options"),isExpanded:null!==v}),E,y)}},1660:function(e,t,a){"use strict";a.d(t,"a",(function(){return p}));var n=a(131),i=a.n(n),s=a(134),o=a.n(s),r=a(127),l=a.n(r),c=a(120),d=a.n(c),m=a(170),h=a(151);const u=["inputRef","className"],p=e=>{let{inputRef:t,className:a}=e,n=o()(e,u);const[s,r,c]=Object(m.i)(t);return d.a.createElement(h.a,i()({},n,{className:l()(a,"mx_SpotlightDialog_option"),onFocus:s,inputRef:c,tabIndex:-1,"aria-selected":r,role:"option"}))}},1661:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M15 9a6 6 0 01-6 6v-2a4 4 0 000-8V3a6 6 0 016 6zM9 5a4 4 0 100 8V5zm8 4A8 8 0 111 9a8 8 0 0116 0z",fill:"#000"})))}t.default="img/element-icons/roomlist/dark-light-mode.87d7411.svg"},1689:function(e,t){e.exports="img/user-onboarding/WorkMessaging.f3c8ccf.png"},1690:function(e,t){e.exports="img/user-onboarding/CommunityMessaging.85955ea.png"},1691:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return l}));var n,i,s,o=a(120);function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},r.apply(this,arguments)}function l(e){return o.createElement("svg",r({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),o.createElement("g",{clipPath:"url(#default_app_svg__clip0)"},n||(n=o.createElement("rect",{width:20,height:20,rx:4,fill:"url(#default_app_svg__paint0_linear)"})),o.createElement("path",{d:"M2.496 0v20M20 2.5H0M20 10H0M20 17.5H0M10 0v20M17.496 0v20",stroke:"#fff",strokeOpacity:.5,style:{mixBlendMode:"lighten"}}),i||(i=o.createElement("circle",{opacity:.8,cx:10,cy:10,r:7.5,stroke:"#fff"}))),s||(s=o.createElement("defs",null,o.createElement("linearGradient",{id:"default_app_svg__paint0_linear",x1:10,y1:0,x2:10,y2:20,gradientUnits:"userSpaceOnUse"},o.createElement("stop",{stopColor:"#60A6FF"}),o.createElement("stop",{offset:1,stopColor:"#418DED"})),o.createElement("clipPath",{id:"default_app_svg__clip0"},o.createElement("rect",{width:20,height:20,rx:4,fill:"#fff"})))))}t.default="img/element-icons/room/default_app.63bac9a.svg"},1692:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return r}));var n,i,s=a(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),n||(n=s.createElement("rect",{width:20,height:20,rx:4,fill:"#5ABFF2"})),i||(i=s.createElement("path",{d:"M3 7.875C3 6.839 3.84 6 4.875 6h6.313c1.035 0 1.874.84 1.874 1.875v5c0 1.036-.839 1.875-1.874 1.875H4.875A1.875 1.875 0 013 12.875v-5zM14.375 8.446l1.746-1.336a.547.547 0 01.879.435v5.495c0 .48-.575.727-.923.396l-1.702-1.615V8.446z",fill:"#fff"})))}t.default="img/element-icons/room/default_video.6afce87.svg"},1693:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return c}));var n,i,s,o,r=a(120);function l(){return l=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},l.apply(this,arguments)}function c(e){return r.createElement("svg",l({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),n||(n=r.createElement("rect",{width:20,height:20,rx:4,fill:"#E53935"})),i||(i=r.createElement("path",{d:"M2 7h16v9a2 2 0 01-2 2H4a2 2 0 01-2-2V7z",fill:"#fff"})),s||(s=r.createElement("rect",{x:3.968,y:9,width:2.997,height:3,rx:.25,fill:"#E53935"})),o||(o=r.createElement("rect",{x:10.961,y:13,width:2.997,height:3,rx:.25,fill:"#E53935"})))}t.default="img/element-icons/room/default_cal.51204da.svg"},1694:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return r}));var n,i,s=a(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),n||(n=s.createElement("rect",{width:20,height:20,rx:4,fill:"#FCC639"})),i||(i=s.createElement("path",{d:"M2 7h16v9a2 2 0 01-2 2H4a2 2 0 01-2-2V7z",fill:"#fff"})))}t.default="img/element-icons/room/default_doc.6a6092c.svg"},1695:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return l}));var n,i,s,o=a(120);function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},r.apply(this,arguments)}function l(e){return o.createElement("svg",r({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),n||(n=o.createElement("rect",{x:1,y:1,width:18,height:18,rx:3,fill:"#212121",stroke:"#212121",strokeWidth:2})),i||(i=o.createElement("path",{d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0z",fill:"#fff"})),s||(s=o.createElement("path",{d:"M10 6v3.813l2.5 1.687",stroke:"#000",strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})))}t.default="img/element-icons/room/default_clock.4714f0d.svg"},1696:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return R}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(187),l=a.n(r),c=a(146),d=a(1697),m=a(130),h=a(1),u=a(677),p=a(161),g=a(173),b=a(691),v=a(165),f=a(168),E=a(121),y=a(240),_=a(363),S=a(522),w=a(195),O=a(133),C=a(1703),x=a(303),j=a(243),k=a(1705);class R extends u.a{constructor(e,t,a,n){super(e,t,a,n),i()(this,"avatars",void 0),i()(this,"permalinkCreator",void 0),i()(this,"totalSize",void 0),i()(this,"mediaOmitText",void 0),this.avatars=new Map,this.permalinkCreator=new f.a(this.room),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?Object(E.b)("Media omitted - file size limit exceeded"):Object(E.b)("Media omitted")}async getRoomAvatar(){let e;const t=y.b(this.room,32,32,"crop"),a="room.png";if(t)try{const n=await fetch(t);e=await n.blob(),this.totalSize+=e.size,this.addFile(a,e)}catch(e){h.a.log("Failed to fetch room's avatar"+e)}const n=o.a.createElement(w.a,{width:32,height:32,name:this.room.name,title:this.room.name,url:e?a:"",resizeMethod:"crop"});return Object(d.renderToStaticMarkup)(n)}async wrapHTML(e,t,a){var n,i,s,r,l;const c=await this.getRoomAvatar(),h=Object(v.g)(new Date),u=null===(n=this.room.currentState.getStateEvents(m.b.RoomCreate,""))||void 0===n?void 0:n.getSender(),p=(u?null===(i=this.room.getMember(u))||void 0===i?void 0:i.rawDisplayName:u)||u,g=this.client.getUserId(),b=null===(s=this.room.getMember(g))||void 0===s?void 0:s.rawDisplayName,f=(null===(r=this.room.currentState.getStateEvents(m.b.RoomTopic,""))||void 0===r||null===(l=r.getContent())||void 0===l?void 0:l.topic)||"",y=Object(E.b)("%(creatorName)s created this room.",{creatorName:p}),_=Object(d.renderToStaticMarkup)(o.a.createElement("p",null,Object(E.b)("This is the start of export of <roomName/>. Exported by <exporterDetails/> at %(exportDate)s.",{exportDate:h},{roomName:()=>o.a.createElement("b",null,this.room.name),exporterDetails:()=>o.a.createElement("a",{href:`https://matrix.to/#/${g}`,target:"_blank",rel:"noopener noreferrer"},b?o.a.createElement(o.a.Fragment,null,o.a.createElement("b",null,b)," ("+g+")"):o.a.createElement("b",null,g))}))),S=f?Object(E.b)("Topic: %(topic)s",{topic:f}):"",w=Object(d.renderToStaticMarkup)(0!==t?o.a.createElement("div",{style:{textAlign:"center"}},o.a.createElement("a",{href:`./messages${1===t?"":t}.html`,style:{fontWeight:"bold"}},"Previous group of messages")):o.a.createElement(o.a.Fragment,null)),O=Object(d.renderToStaticMarkup)(t<a-1?o.a.createElement("div",{style:{textAlign:"center",margin:"10px"}},o.a.createElement("a",{href:"./messages"+(t+2)+".html",style:{fontWeight:"bold"}},"Next group of messages")):o.a.createElement(o.a.Fragment,null));return`\n          <!DOCTYPE html>\n            <html lang="en">\n            <head>\n                <meta charset="UTF-8" />\n                <meta http-equiv="X-UA-Compatible" content="IE=edge" />\n                <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n                <link href="css/style.css" rel="stylesheet" />\n                <script src="js/script.js"><\/script>\n                <title>Exported Data</title>\n            </head>\n            <body style="height: 100vh;">\n                <section\n                id="matrixchat"\n                style="height: 100%; overflow: auto"\n                class="notranslate"\n                >\n                <div class="mx_MatrixChat_wrapper" aria-hidden="false">\n                    <div class="mx_MatrixChat">\n                    <main class="mx_RoomView">\n                        <div class="mx_RoomHeader light-panel">\n                        <div class="mx_RoomHeader_wrapper" aria-owns="mx_RightPanel">\n                            <div class="mx_RoomHeader_avatar">\n                            <div class="mx_DecoratedRoomAvatar">\n                               ${c}\n                            </div>\n                            </div>\n                            <div class="mx_RoomHeader_name">\n                            <div\n                                dir="auto"\n                                class="mx_RoomHeader_nametext"\n                                title="${this.room.name}"\n                            >\n                                ${this.room.name}\n                            </div>\n                            </div>\n                            <div class="mx_RoomHeader_topic" dir="auto"> ${f} </div>\n                        </div>\n                        </div>\n                        ${w}\n                        <div class="mx_MainSplit">\n                        <div class="mx_RoomView_body">\n                            <div\n                            class="mx_RoomView_timeline mx_RoomView_timeline_rr_enabled"\n                            >\n                            <div\n                                class="\n                                mx_AutoHideScrollbar\n                                mx_ScrollPanel\n                                mx_RoomView_messagePanel\n                                "\n                            >\n                                <div class="mx_RoomView_messageListWrapper">\n                                <ol\n                                    class="mx_RoomView_MessageList"\n                                    aria-live="polite"\n                                    role="list"\n                                >\n                                ${0==t?`<div class="mx_NewRoomIntro">\n                                        ${c}\n                                        <h2> ${this.room.name} </h2>\n                                        <p> ${y} <br/><br/> ${_} </p>\n                                        <br/>\n                                        <p> ${S} </p>\n                                    </div>`:""}\n                                ${e}\n                                </ol>\n                                </div>\n                            </div>\n                            </div>\n                            <div class="mx_RoomView_statusArea">\n                            <div class="mx_RoomView_statusAreaBox">\n                                <div class="mx_RoomView_statusAreaBox_line"></div>\n                            </div>\n                            </div>\n                        </div>\n                        </div>\n                        ${O}\n                    </main>\n                    </div>\n                </div>\n                </section>\n                <div id="snackbar"/>\n            </body>\n        </html>`}getAvatarURL(e){const t=e.sender,a=null==t?void 0:t.getMxcAvatarUrl();return a?Object(p.b)(a).getThumbnailOfSourceHttp(30,30,"crop"):null}async saveAvatarIfNeeded(e){const t=e.sender;if(!this.avatars.has(t.userId))try{const a=this.getAvatarURL(e);this.avatars.set(t.userId,!0);const n=await fetch(a),i=await n.blob();this.addFile(`users/${t.userId.replace(/:/g,"-")}.png`,i)}catch(e){h.a.log("Failed to fetch user's avatar"+e)}}getDateSeparator(e){const t=e.getTs(),a=o.a.createElement("li",{key:t},o.a.createElement(S.a,{forExport:!0,key:t,roomId:e.getRoomId(),ts:t}));return Object(d.renderToStaticMarkup)(a)}needsDateSeparator(e,t){return!t||Object(v.p)(t.getDate()||void 0,e.getDate()||void 0)}getEventTile(e,t){return o.a.createElement("div",{className:"mx_Export_EventWrapper",id:e.getId()},o.a.createElement(O.a.Provider,{value:this.client},o.a.createElement(_.b,{mxEvent:e,continuation:t,isRedacted:e.isRedacted(),replacingEventId:e.replacingEventId(),forExport:!0,alwaysShowTimestamps:!0,showUrlPreview:!1,checkUnmounting:()=>!1,isTwelveHour:!1,last:!1,lastInSection:!1,permalinkCreator:this.permalinkCreator,lastSuccessful:!1,isSelectedEvent:!1,showReactions:!1,layout:g.a.Group,showReadReceipts:!1,youtubeEmbedPlayer:!1})))}async getEventTileMarkup(e,t,a){const n=this.getAvatarURL(e),i=!!n;i&&await this.saveAvatarIfNeeded(e);const s=this.getEventTile(e,t);let o;if(e.getContent().msgtype==m.e.Emote||e.getContent().msgtype==m.e.Notice||e.getContent().msgtype===m.e.Text){const e=document.createElement("div");l.a.render(s,e),o=e.innerHTML}else o=Object(d.renderToStaticMarkup)(s);if(a){var r,c;const t=null!==(r=e.getContent().url)&&void 0!==r?r:null===(c=e.getContent().file)||void 0===c?void 0:c.url;o=o.split(t).join(a)}return o=o.replace(/<span class="mx_MFileBody_info_icon".*?>.*?<\/span>/,""),i&&(o=o.replace(encodeURI(n).replace(/&/g,"&amp;"),`users/${e.sender.userId.replace(/:/g,"-")}.png`)),o}createModifiedEvent(e,t){let a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const n={msgtype:m.e.Text,body:`${e}`,format:"org.matrix.custom.html",formatted_body:`${e}`};a&&(n.formatted_body="<em>"+n.formatted_body+"</em>",n.body="*"+n.body+"*");const i=new c.b;return i.event=t.event,i.sender=t.sender,i.event.type="m.room.message",i.event.content=n,i}async createMessageBody(e){let t,a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const n=await this.getMediaBlob(e);if(this.totalSize+n.size>this.exportOptions.maxSize)t=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),a);else{this.totalSize+=n.size;const i=this.getFilePath(e);t=await this.getEventTileMarkup(e,a,i),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(i,n)}}catch(n){h.a.log("Error while fetching file"+n),t=await this.getEventTileMarkup(this.createModifiedEvent(Object(E.b)("Error fetching file"),e),a)}else t=await this.getEventTileMarkup(this.createModifiedEvent(this.mediaOmitText,e),a);else t=await this.getEventTileMarkup(e,a)}catch(n){h.a.error(n),t=await this.getEventTileMarkup(this.createModifiedEvent(Object(x.b)(e),e,!1),a)}return t}async createHTML(t,a,n,i){let s="",o=null;for(let n=a;n<Math.min(a+1e3,t.length);n++){const a=t[n];if(this.updateProgress(Object(E.b)("Processing event %(number)s out of %(total)s",{number:n+1,total:t.length}),!1,!0),this.cancelled)return this.cleanUp();if(!Object(j.c)(a,!1))continue;s+=this.needsDateSeparator(a,o)?this.getDateSeparator(a):"";const i=!this.needsDateSeparator(a,o)&&Object(b.b)(o,a,!1),r=await this.createMessageBody(a,i);this.totalSize+=e.byteLength(r),s+=r,o=a}return this.wrapHTML(s,n,i)}async export(){this.updateProgress(Object(E.b)("Starting export…"));const e=performance.now(),t=await this.getRequiredEvents(),a=performance.now();this.updateProgress(Object(E.b)("Fetched %(count)s events in %(seconds)ss",{count:t.length,seconds:(a-e)/1e3}),!0,!1),this.updateProgress(Object(E.b)("Creating HTML…"));const n=new Set;for(let e=0;e<t.length/1e3;e++){const a=await this.createHTML(t,1e3*e,e,t.length/1e3);(new DOMParser).parseFromString(a,"text/html").querySelectorAll("*").forEach((e=>{e.classList.forEach((e=>n.add(e)))})),this.addFile(`messages${e?e+1:""}.html`,new Blob([a]))}const i=await Object(C.a)(n);this.addFile("css/style.css",new Blob([i])),this.addFile("js/script.js",new Blob([k.a])),await this.downloadZIP();const s=performance.now();this.cancelled?h.a.info("Export cancelled successfully"):(this.updateProgress(Object(E.b)("Export successful!")),this.updateProgress(Object(E.b)("Exported %(count)s events in %(seconds)s seconds",{count:t.length,seconds:(s-e)/1e3}))),this.cleanUp()}}}).call(this,a(53).Buffer)},1703:function(e,t,a){"use strict";var n=a(1704);const i=/\.[\w-]+/g;function s(e){return e.replace(/font-family: ?(Inter|'Inter'|"Inter")/g,"font-family: -apple-system, BlinkMacSystemFont, avenir next,\n            avenir, segoe ui, helvetica neue, helvetica, Ubuntu, roboto, noto, arial, sans-serif").replace(/font-family: ?Inconsolata/g,"font-family: Menlo, Consolas, Monaco, Liberation Mono, Lucida Console, monospace")}function o(e){var t;return"light"===(null===(t=e.ownerNode.dataset.mxTheme)||void 0===t?void 0:t.toLowerCase())}t.a=async e=>{const t=Array.from(document.styleSheets).filter((e=>{var t;return(null===(t=e.href)||void 0===t?void 0:t.endsWith("bundle.css"))||o(e)}));if(!t.some(o)){var a;const e=null===(a=document.querySelector('link[rel="stylesheet"][href$="theme-light.css"]'))||void 0===a?void 0:a.href;e&&t.push(await async function(e){const t=document.implementation.createHTMLDocument(""),a=document.createElement("style"),n=await fetch(e);return a.textContent=await n.text(),t.body.appendChild(a),a.sheet}(e))}let r="";for(const a of t)for(const t of a.cssRules){if(t instanceof CSSFontFaceRule)continue;const a=t.selectorText;null!=a&&a.split(",").every((t=>{const a=t.match(i);if(a&&!a.every((t=>e.has(t.substring(1)))))return!0}))||(r+=s(t.cssText)+"\n")}return r+n.a}},1705:function(e,t,a){"use strict";t.a='/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the "License");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\nhttp://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n// This file is raw-imported (imported as plain text) for the export bundle, which is why this is in JS\nfunction showToastIfNeeded(replyId) {\n    const el = document.getElementById(replyId);\n    if (!el) {\n        showToast("The message you\'re looking for wasn\'t exported");\n        return;\n    }\n}\n\nfunction showToast(text) {\n    const el = document.getElementById("snackbar");\n    el.innerHTML = text;\n    el.className = "mx_show";\n    window.setTimeout(() => {\n        el.className = el.className.replace("mx_show", "");\n    }, 2000);\n}\n\nwindow.onload = () => {\n    document.querySelectorAll(".mx_reply_anchor").forEach((element) => {\n        element.addEventListener("click", (event) => {\n            showToastIfNeeded(event.target.dataset.scrollTo);\n        });\n    });\n};\n'},1706:function(e,t,a){"use strict";(function(e){var n=a(120),i=a.n(n),s=a(1),o=a(181),r=a(130),l=a(121),c=a(125),d=a(128),m=a(137),h=a(219),u=a(148),p=a(182);t.a=t=>{const{matrixClient:a,room:g,member:b,onFinished:v}=t,[f,E]=Object(n.useState)(!0);let y=g.getLiveTimeline(),_=[];for(;y;)_=[..._,...y.getEvents().filter((e=>e.getSender()===b.userId&&!e.isRedacted()&&!e.isRedaction()&&e.getType()!==r.b.RoomCreate&&e.getType()!==r.b.RoomServerAcl&&e.getType()!==r.b.RoomEncryption))],y=y.getNeighbouringTimeline(o.b.BACKWARDS);if(0===_.length)return i.a.createElement(h.a,{onFinished:v,title:Object(l.b)("No recent messages by %(user)s found",{user:b.name}),description:i.a.createElement("div",null,i.a.createElement("p",null,Object(l.b)("Try scrolling up in the timeline to see if there are any earlier ones.")))});{_=_.filter((e=>!(f&&e.isState())));const t=_.length,n=b.name,o=async()=>{s.a.info(`Started redacting recent ${t} messages for ${b.userId} in ${g.roomId}`),c.a.dispatch({action:d.a.BulkRedactStart,room_id:g.roomId}),await Promise.resolve(),await Promise.all(_.reverse().map((async e=>{try{await a.redactEvent(g.roomId,e.getId())}catch(t){s.a.error("Could not redact",e.getId()),s.a.error(t)}}))),s.a.info(`Finished redacting recent ${t} messages for ${b.userId} in ${g.roomId}`),c.a.dispatch({action:d.a.BulkRedactEnd,room_id:g.roomId})};return i.a.createElement(m.a,{className:"mx_BulkRedactDialog",onFinished:v,title:Object(l.b)("Remove recent messages by %(user)s",{user:n}),contentId:"mx_Dialog_content"},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.a.createElement("p",null,Object(l.b)("You are about to remove %(count)s messages by %(user)s. This will remove them permanently for everyone in the conversation. Do you wish to continue?",{count:t,user:n})),i.a.createElement("p",null,Object(l.b)("For a large amount of messages, this might take some time. Please don't refresh your client in the meantime.")),i.a.createElement(p.b,{checked:f,onChange:e=>E(e.target.checked)},Object(l.b)("Preserve system messages")),i.a.createElement("div",{className:"mx_BulkRedactDialog_checkboxMicrocopy"},Object(l.b)("Uncheck if you also want to remove system messages on this user (e.g. membership change, profile change…)"))),i.a.createElement(u.a,{primaryButton:Object(l.b)("Remove %(count)s messages",{count:t}),primaryButtonClass:"danger",primaryDisabled:0===t,onPrimaryButtonClick:()=>{e(o),v(!0)},onCancel:()=>v(!1)}))}}}).call(this,a(54).setImmediate)},1707:function(e,t){e.exports="img/stickerpack-placeholder.c50e1de.png"},1708:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return p}));var n,i,s,o,r,l,c,d,m,h=a(120);function u(){return u=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},u.apply(this,arguments)}function p(e){return h.createElement("svg",u({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 31 31",role:"presentation","aria-hidden":!0},e),n||(n=h.createElement("path",{fill:"none",d:"M0 0h31v31H0z"})),i||(i=h.createElement("circle",{cx:15.5,cy:15.5,r:15.5,fill:"#9e9e9e"})),s||(s=h.createElement("path",{d:"M22.855 15.5a7.355 7.355 0 11-14.71 0 7.355 7.355 0 0114.71 0zM15.5 24.25a8.75 8.75 0 100-17.5 8.75 8.75 0 000 17.5z",fill:"#fff",stroke:"#fff",strokeWidth:.5})),o||(o=h.createElement("path",{fill:"#9e9e9e",d:"M16.266 30.503h-1.5L14.76 1.1h1.5z"})),r||(r=h.createElement("path",{fill:"#9e9e9e",d:"M8.894 28.844l-1.294-.76L22.605 2.503l1.294.759z"})),l||(l=h.createElement("path",{fill:"#9e9e9e",d:"M2.88 24.495l-.786-1.278L27.71 7.46l.786 1.277z"})),c||(c=h.createElement("path",{fill:"#9e9e9e",d:"M2.163 23.341L1.49 22l26.51-13.264.671 1.341z"})),d||(d=h.createElement("path",{fill:"#9e9e9e",d:"M1.551 22.134L1 20.74 28.433 9.887l.552 1.394z"})),m||(m=h.createElement("path",{d:"M9.5 17l-2 3-2-3h4zM21.5 15l2-3 2 3h-4z",fill:"#fff",stroke:"#fff"})))}t.default="img/room_replaced.c5a1326.svg"},1709:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M16 0C7.163 0 0 7.163 0 16s7.163 16 16 16 16-7.163 16-16S24.837 0 16 0zm1.251 6.974a1.496 1.496 0 00-2.051-.129 1.495 1.495 0 00-.13.12l-6.274 6.589a1.5 1.5 0 102.173 2.069l3.688-3.873V23.06a1.5 1.5 0 103 0V11.75l3.688 3.873a1.5 1.5 0 102.173-2.07L17.25 6.975z",fill:"#8BC34A"})))}t.default="img/upload-big.68c4e4b.svg"},1711:function(e,t,a){var n={"./":[255,9],"./ICanvasEffect":[998,7,12],"./ICanvasEffect.ts":[998,7,12],"./confetti":[503,9,0],"./confetti/":[503,9,0],"./confetti/index":[503,9,0],"./confetti/index.ts":[503,9,0],"./effect":[999,9,13],"./effect.ts":[999,9,13],"./fireworks":[504,9,1],"./fireworks/":[504,9,1],"./fireworks/index":[504,9,1],"./fireworks/index.ts":[504,9,1],"./hearts":[505,9,2],"./hearts/":[505,9,2],"./hearts/index":[505,9,2],"./hearts/index.ts":[505,9,2],"./index":[255,9],"./index.ts":[255,9],"./rainfall":[506,9,3],"./rainfall/":[506,9,3],"./rainfall/index":[506,9,3],"./rainfall/index.ts":[506,9,3],"./snowfall":[507,9,4],"./snowfall/":[507,9,4],"./snowfall/index":[507,9,4],"./snowfall/index.ts":[507,9,4],"./spaceinvaders":[508,9,5],"./spaceinvaders/":[508,9,5],"./spaceinvaders/index":[508,9,5],"./spaceinvaders/index.ts":[508,9,5],"./utils":[318,9],"./utils.ts":[318,9]};function i(e){if(!a.o(n,e))return Promise.resolve().then((function(){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=n[e],i=t[0];return Promise.all(t.slice(2).map(a.e)).then((function(){return a.t(i,t[1])}))}i.keys=function(){return Object.keys(n)},i.id=1711,e.exports=i},1712:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return p}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(199),l=a(1713),c=a(411);const d=58,m=58,h=76,u=8;class p extends o.a.Component{constructor(){var t;super(...arguments),t=this,i()(this,"callViewWrapper",Object(s.createRef)()),i()(this,"initX",0),i()(this,"initY",0),i()(this,"desiredTranslationX",r.b.instance.windowWidth-u-336),i()(this,"desiredTranslationY",r.b.instance.windowHeight-m-232),i()(this,"translationX",this.desiredTranslationX),i()(this,"translationY",this.desiredTranslationY),i()(this,"mouseHeld",!1),i()(this,"scheduledUpdate",new c.a((()=>this.animationCallback()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),i()(this,"startingPositionX",0),i()(this,"startingPositionY",0),i()(this,"_moving",!1),i()(this,"animationCallback",(()=>{var e,t;if(!this.moving&&Math.abs(this.translationX-this.desiredTranslationX)<=1&&Math.abs(this.translationY-this.desiredTranslationY)<=1)this.translationX=this.desiredTranslationX,this.translationY=this.desiredTranslationY,this.setStyle();else{const e=this.moving?.2:.1;this.translationX=Object(l.a)(this.translationX,this.desiredTranslationX,e),this.translationY=Object(l.a)(this.translationY,this.desiredTranslationY,e),this.setStyle(),this.scheduledUpdate.mark()}null===(e=(t=this.props).onMove)||void 0===e||e.call(t)})),i()(this,"setStyle",(()=>{this.callViewWrapper.current&&(this.callViewWrapper.current.style.transform=`translateX(${this.translationX}px) translateY(${this.translationY}px)`)})),i()(this,"onResize",(()=>{this.snap(!1)})),i()(this,"snap",(function(){var e,a;let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const i=t.desiredTranslationX,s=t.desiredTranslationY,o=r.b.instance.windowWidth-((null===(e=t.callViewWrapper.current)||void 0===e?void 0:e.clientWidth)||336),l=r.b.instance.windowHeight-((null===(a=t.callViewWrapper.current)||void 0===a?void 0:a.clientHeight)||232);i>=o/2&&s>=l/2?(t.desiredTranslationX=o-u,t.desiredTranslationY=l-m):i>=o/2&&s<=l/2?(t.desiredTranslationX=o-u,t.desiredTranslationY=d):i<=o/2&&s>=l/2?(t.desiredTranslationX=h,t.desiredTranslationY=l-m):(t.desiredTranslationX=h,t.desiredTranslationY=d),n||(t.translationX=t.desiredTranslationX,t.translationY=t.desiredTranslationY),t.scheduledUpdate.mark()})),i()(this,"onStartMoving",(e=>{e.preventDefault(),e.stopPropagation(),this.mouseHeld=!0,this.startingPositionX=e.clientX,this.startingPositionY=e.clientY})),i()(this,"onMoving",(e=>{this.mouseHeld&&(Math.abs(this.startingPositionX-e.clientX)<5&&Math.abs(this.startingPositionY-e.clientY)<5||(e.preventDefault(),e.stopPropagation(),this.moving||(this.moving=!0,this.initX=e.pageX-this.desiredTranslationX,this.initY=e.pageY-this.desiredTranslationY,this.scheduledUpdate.mark()),this.setTranslation(e.pageX-this.initX,e.pageY-this.initY)))})),i()(this,"onEndMoving",(t=>{this.mouseHeld&&(t.preventDefault(),t.stopPropagation(),this.mouseHeld=!1,e((()=>this.moving=!1)),this.snap(!0))})),i()(this,"onClickCapture",(e=>{this.moving&&(e.preventDefault(),e.stopPropagation())}))}get moving(){return this._moving}set moving(e){this._moving=e}componentDidMount(){document.addEventListener("mousemove",this.onMoving),document.addEventListener("mouseup",this.onEndMoving),r.b.instance.on(r.a.Resize,this.onResize),this.snap()}componentWillUnmount(){document.removeEventListener("mousemove",this.onMoving),document.removeEventListener("mouseup",this.onEndMoving),r.b.instance.off(r.a.Resize,this.onResize)}componentDidUpdate(e){e.children!==this.props.children&&this.snap(!0)}setTranslation(e,t){var a,n;const i=(null===(a=this.callViewWrapper.current)||void 0===a?void 0:a.clientWidth)||336,s=(null===(n=this.callViewWrapper.current)||void 0===n?void 0:n.clientHeight)||232;e+i>=r.b.instance.windowWidth?this.desiredTranslationX=r.b.instance.windowWidth-i:this.desiredTranslationX=e<=0?0:e,t+s>=r.b.instance.windowHeight?this.desiredTranslationY=r.b.instance.windowHeight-s:this.desiredTranslationY=t<=0?0:t}render(){const e={transform:`translateX(${this.translationX}px) translateY(${this.translationY}px)`},t=this.props.children.map((e=>e({onStartMoving:this.onStartMoving,onResize:this.onResize})));return o.a.createElement("aside",{className:this.props.className,style:e,ref:this.callViewWrapper,onClickCapture:this.onClickCapture,onDoubleClick:this.props.onDoubleClick},t)}}}).call(this,a(54).setImmediate)},1713:function(e,t,a){"use strict";a.d(t,"a",(function(){return i}));var n=a(150);function i(e,t,a){return(1-(a=Object(n.clamp)(a,0,1)))*e+a*t}},1714:function(e,t,a){"use strict";a.d(t,"a",(function(){return u}));var n=a(121),i=a(125),s=a(231),o=a(196),r=a(158),l=a(126),c=a(138);const d=()=>{i.a.dispatch({action:"view_room",room_alias:"#web-announcements:schildi.chat"}),l.b.setValue("scShowUpdateAnnouncementRoomToast",null,c.a.DEVICE,!1),p()},m=()=>{l.b.setValue("scShowUpdateAnnouncementRoomToast",null,c.a.DEVICE,!1),p()},h="scupdateannouncementroom",u=()=>{r.a.get().canSelfUpdate().then((e=>{e||o.a.sharedInstance().addOrReplaceToast({key:h,title:Object(n.b)("Update notifications"),props:{description:Object(n.b)("Do you want to join a room notifying you about new releases? This is especially useful if your platform doesn't support automatic updates for SchildiChat (e.g. Windows and macOS)."),acceptLabel:Object(n.b)("Show preview"),onAccept:d,rejectLabel:Object(n.b)("No"),onReject:m},component:s.a,priority:20})})).catch((e=>{console.error("Error getting vector version: ",e)}))},p=()=>{o.a.sharedInstance().dismissToast(h)}},1715:function(e,t,a){"use strict";a.d(t,"a",(function(){return h}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(124),l=a(141),c=a(658),d=a(930),m=a(186);class h extends o.a.PureComponent{constructor(e){super(e),i()(this,"numberEntryFieldRef",Object(s.createRef)()),i()(this,"onCancelClick",(()=>{this.props.onFinished(!1)})),i()(this,"onChange",(e=>{this.setState({value:e.target.value})})),i()(this,"onFormSubmit",(e=>{e.preventDefault(),this.onDialPress()})),i()(this,"onDigitPress",((e,t)=>{var a;(this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(a=this.numberEntryFieldRef.current)||void 0===a||a.focus())})),i()(this,"onDeletePress",(e=>{var t;0!==this.state.value.length&&(this.setState({value:this.state.value.slice(0,-1)}),"click"===e.type&&(null===(t=this.numberEntryFieldRef.current)||void 0===t||t.focus()))})),i()(this,"onDialPress",(async()=>{m.b.instance.dialNumber(this.state.value),this.props.onFinished(!0)})),this.state={value:""}}render(){const e=o.a.createElement(d.a,{onBackspacePress:this.onDeletePress});let t;return t=0!==this.state.value.length?o.a.createElement(l.a,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange,postfixComponent:e}):o.a.createElement(l.a,{ref:this.numberEntryFieldRef,className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange}),o.a.createElement("div",{className:"mx_DialPadModal"},o.a.createElement("div",null,o.a.createElement(r.a,{className:"mx_DialPadModal_cancel",onClick:this.onCancelClick})),o.a.createElement("div",{className:"mx_DialPadModal_header"},o.a.createElement("form",{onSubmit:this.onFormSubmit},t)),o.a.createElement("div",{className:"mx_DialPadModal_dialPad"},o.a.createElement(c.a,{hasDial:!0,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress,onDialPress:this.onDialPress})))}}},1716:function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var n=a(121),i=a(231),s=a(196),o=a(132);const r=()=>{window.location.href="mobile_guide/"},l=()=>{document.cookie="element_mobile_redirect_to_guide=false;path=/;max-age=14400",m()},c="mobileguide",d=()=>{const e=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,t=/Android/.test(navigator.userAgent),a=o.b.get().brand;(e||t)&&(document.cookie.includes("element_mobile_redirect_to_guide=false")||s.a.sharedInstance().addOrReplaceToast({key:c,title:Object(n.b)("Use app for a better experience"),props:{description:Object(n.b)("%(brand)s is experimental on a mobile web browser. For a better experience and the latest features, use our free native app.",{brand:a}),acceptLabel:Object(n.b)("Use app"),onAccept:r,rejectLabel:Object(n.b)("Dismiss"),onReject:l},component:i.a,priority:99}))},m=()=>{s.a.sharedInstance().dismissToast(c)}},1717:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return v}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(510),l=a(121),c=a(124),d=a(472),m=a(135),h=a(983),u=a(1718),p=a(473),g=a(1719),b=a(694);class v extends o.a.Component{constructor(e){super(e),i()(this,"handleClick",(e=>async t=>{t.preventDefault(),await this.props.onClick(e)})),i()(this,"cancelButton",(()=>o.a.createElement(c.a,{"data-testid":"cancel-button",kind:"primary_outline",onClick:this.handleClick(b.a.Cancel)},Object(l.b)("Cancel")))),i()(this,"simpleSpinner",(e=>o.a.createElement("div",{className:"mx_LoginWithQR_spinner"},o.a.createElement("div",null,o.a.createElement(m.a,null),e&&o.a.createElement("p",null,e)))))}render(){let t,a,n,i,s="",m=!0,v=!1;switch(this.props.phase){case b.c.Error:switch(this.props.failureReason){case r.c.Expired:i=Object(l.b)("The linking wasn't completed in the required time.");break;case r.c.InvalidCode:i=Object(l.b)("The scanned code is invalid.");break;case r.c.UnsupportedAlgorithm:i=Object(l.b)("Linking with this device is not supported.");break;case r.c.UserDeclined:i=Object(l.b)("The request was declined on the other device.");break;case r.c.OtherDeviceAlreadySignedIn:i=Object(l.b)("The other device is already signed in.");break;case r.c.OtherDeviceNotSignedIn:i=Object(l.b)("The other device isn't signed in.");break;case r.c.UserCancelled:i=Object(l.b)("The request was cancelled.");break;case r.c.Unknown:i=Object(l.b)("An unexpected error occurred.");break;case r.c.HomeserverLacksSupport:i=Object(l.b)("The homeserver doesn't support signing in another device.");break;default:i=Object(l.b)("The request was cancelled.")}s=Object(l.b)("Connection failed"),v=!0,t=o.a.createElement(p.Icon,{className:"error"}),m=!1,a=o.a.createElement("p",{"data-testid":"cancellation-message"},i),n=o.a.createElement(o.a.Fragment,null,o.a.createElement(c.a,{"data-testid":"try-again-button",kind:"primary",onClick:this.handleClick(b.a.TryAgain)},Object(l.b)("Try again")),this.cancelButton());break;case b.c.Connected:s=Object(l.b)("Devices connected"),t=o.a.createElement(u.a,{className:"normal"}),m=!1,a=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.b)("Check that the code below matches with your other device:")),o.a.createElement("div",{className:"mx_LoginWithQR_confirmationDigits"},this.props.confirmationDigits),o.a.createElement("div",{className:"mx_LoginWithQR_confirmationAlert"},o.a.createElement("div",null,o.a.createElement(g.a,null)),o.a.createElement("div",null,Object(l.b)("By approving access for this device, it will have full access to your account.")))),n=o.a.createElement(o.a.Fragment,null,o.a.createElement(c.a,{"data-testid":"decline-login-button",kind:"primary_outline",onClick:this.handleClick(b.a.Decline)},Object(l.b)("Cancel")),o.a.createElement(c.a,{"data-testid":"approve-login-button",kind:"primary",onClick:this.handleClick(b.a.Approve)},Object(l.b)("Approve")));break;case b.c.ShowingQR:if(s=Object(l.b)("Sign in with QR code"),this.props.code){var f;const t=o.a.createElement("div",{className:"mx_LoginWithQR_qrWrapper"},o.a.createElement(d.a,{data:[{data:e.from(null!==(f=this.props.code)&&void 0!==f?f:""),mode:"byte"}],className:"mx_QRCode"}));a=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.b)("Scan the QR code below with your device that's signed out.")),o.a.createElement("ol",null,o.a.createElement("li",null,Object(l.b)("Start at the sign in screen")),o.a.createElement("li",null,Object(l.b)("Select '%(scanQRCode)s'",{scanQRCode:Object(l.b)("Scan QR code")})),o.a.createElement("li",null,Object(l.b)("Review and approve the sign in"))),t)}else a=this.simpleSpinner(),n=this.cancelButton();break;case b.c.Loading:a=this.simpleSpinner();break;case b.c.Connecting:a=this.simpleSpinner(Object(l.b)("Connecting…")),n=this.cancelButton();break;case b.c.WaitingForDevice:a=this.simpleSpinner(Object(l.b)("Waiting for device to sign in")),n=this.cancelButton();break;case b.c.Verifying:s=Object(l.b)("Success"),v=!0,a=this.simpleSpinner(Object(l.b)("Completing set up of your new device"))}return o.a.createElement("div",{"data-testid":"login-with-qr",className:"mx_LoginWithQR"},o.a.createElement("div",{className:v?"mx_LoginWithQR_centreTitle":""},m?o.a.createElement(c.a,{"data-testid":"back-button",className:"mx_LoginWithQR_BackButton",onClick:this.handleClick(b.a.Back),title:"Back"},o.a.createElement(h.a,null)):null,o.a.createElement("h1",null,t,s)),o.a.createElement("div",{className:"mx_LoginWithQR_main"},a),o.a.createElement("div",{className:"mx_LoginWithQR_buttons"},n))}}}).call(this,a(53).Buffer)},1718:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n,i,s=a(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",role:"presentation","aria-hidden":!0},e),n||(n=s.createElement("g",{clipPath:"url(#devices_svg__clip0_721_35674)"},s.createElement("path",{d:"M5.333 9.333C5.333 8.6 5.933 8 6.667 8H28c.733 0 1.333-.6 1.333-1.334 0-.733-.6-1.333-1.333-1.333H5.333A2.675 2.675 0 002.667 8v14.666H2c-1.107 0-2 .894-2 2 0 1.107.893 2 2 2h16.667v-4H5.333V9.333zm25.334 1.333h-8c-.734 0-1.334.6-1.334 1.334v13.333c0 .734.6 1.334 1.334 1.334h8c.733 0 1.333-.6 1.333-1.334V12c0-.733-.6-1.334-1.333-1.334zm-1.334 12H24v-9.333h5.333v9.333z",fill:"currentColor"}))),i||(i=s.createElement("defs",null,s.createElement("clipPath",{id:"devices_svg__clip0_721_35674"},s.createElement("path",{fill:"#fff",d:"M0 0h32v32H0z"})))))}},1719:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M12 10a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm-1 3a1 1 0 110-2h1a1 1 0 011 1v3.5h.5a1 1 0 110 2H12a1 1 0 01-1-1V13z",fill:"#000"})))}},1720:function(e,t,a){"use strict";var n=a(120),i=a.n(n),s=a(121),o=a(132),r=a(137),l=a(148),c=a(135);t.a=e=>{let{failures:t,source:a,continuation:d,onFinished:m}=e;const[h,u]=Object(n.useState)(2),[p,g]=Object(n.useState)(!1),[b,v]=Object(n.useState)(!1),[f,E]=Object(n.useState)(!1),y=Object(n.useRef)(m),_=new Map([["_afterCrossSigningLocalKeyChange",Object(s.b)("a new master key signature")],["checkOwnCrossSigningTrust",Object(s.b)("a new cross-signing key signature")],["setDeviceVerification",Object(s.b)("a device cross-signing signature")]]),S=Object(s.b)("a key signature"),w=Object(n.useCallback)((async()=>{try{v(!0);const e=new Promise(((e,t)=>{y.current=t})).finally((()=>{g(!0)}));await Promise.race([d({shouldEmit:!1}),e]),E(!0)}catch(e){u((e=>e-1))}finally{y.current=m,v(!1)}}),[d,m]);let O;if(!f&&!p&&h>0){const e=_.get(a)||S,n=o.b.get().brand;O=i.a.createElement("div",null,i.a.createElement("p",null,Object(s.b)("%(brand)s encountered an error during upload of:",{brand:n})),i.a.createElement("p",null,e),b&&i.a.createElement(c.a,null),i.a.createElement("pre",null,JSON.stringify(t,null,2)),i.a.createElement(l.a,{primaryButton:"Retry",hasCancel:!0,onPrimaryButtonClick:w,onCancel:y.current,primaryDisabled:b}))}else{let e=Object(s.b)("Upload completed");f||(e=p?Object(s.b)("Cancelled signature upload"):Object(s.b)("Unable to upload")),O=i.a.createElement("div",null,i.a.createElement("span",null,e),i.a.createElement(l.a,{primaryButton:Object(s.b)("OK"),hasCancel:!1,onPrimaryButtonClick:m}))}return i.a.createElement(r.a,{title:f?Object(s.b)("Signature upload success"):Object(s.b)("Signature upload failed"),fixedWidth:!1,onFinished:()=>{}},O)}},1721:function(e,t,a){"use strict";a.d(t,"a",(function(){return u}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(121),l=a(496),c=a(948),d=a(124),m=a(992),h=a(329);class u extends o.a.Component{constructor(e){super(e),i()(this,"onStoreUpdate",(()=>{const e=l.b.sharedInstance();this.setState({phase:e.phase,lostKeys:e.lostKeys()})})),i()(this,"onSkipClick",(()=>{l.b.sharedInstance().skip()}));const t=l.b.sharedInstance();t.on("update",this.onStoreUpdate),t.start(),this.state={phase:t.phase,lostKeys:t.lostKeys()}}componentWillUnmount(){const e=l.b.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const{phase:e,lostKeys:t}=this.state;let a,n,i;if(e===l.a.Loading)return null;if(e===l.a.Intro)t?(a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(r.b)("Unable to verify this device")):(a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(r.b)("Verify this device"));else if(e===l.a.Done)a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_verified"}),n=Object(r.b)("Device verified");else if(e===l.a.ConfirmSkip)a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(r.b)("Are you sure?");else if(e===l.a.Busy)a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(r.b)("Verify this device");else if(e===l.a.ConfirmReset)a=o.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),n=Object(r.b)("Really reset verification keys?");else if(e!==l.a.Finished)throw new Error(`Unknown phase ${e}`);return e!==l.a.Intro&&e!==l.a.ConfirmReset||(i=o.a.createElement(d.a,{onClick:this.onSkipClick,className:"mx_CompleteSecurity_skip","aria-label":Object(r.b)("Skip verification for now")})),o.a.createElement(h.a,null,o.a.createElement(m.a,null,o.a.createElement("h1",{className:"mx_CompleteSecurity_header"},a,n,i),o.a.createElement("div",{className:"mx_CompleteSecurity_body"},o.a.createElement(c.a,{onFinished:this.props.onFinished}))))}}},1722:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return g}));var n,i,s,o,r,l,c,d,m,h,u=a(120);function p(){return p=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},p.apply(this,arguments)}function g(e){return u.createElement("svg",p({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 793.322 340.809",role:"presentation","aria-hidden":!0},e),n||(n=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M34.004 340.809H2a2 2 0 01-2-2V2a2 2 0 012-2h32.004a2 2 0 012 2v7.71a2 2 0 01-2 2h-21.13v317.386h21.13a2 2 0 012 2.001v7.712a2 2 0 01-2 2z"})),i||(i=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M10.875 9.711v321.386h23.13v7.711H1.999V2.001h32.006v7.71h-23.13zM252.402 233.711h-32.993a2 2 0 01-2-2v-68.073c0-3.949-.154-7.722-.457-11.213-.289-3.282-1.074-6.153-2.332-8.53-1.204-2.276-3.017-4.119-5.384-5.476-2.393-1.362-5.775-2.056-10.042-2.056-4.238 0-7.674.798-10.213 2.371-2.565 1.596-4.604 3.701-6.053 6.258-1.498 2.643-2.51 5.694-3.013 9.067a72.757 72.757 0 00-.793 10.741v66.91a2 2 0 01-2 2h-32.991a2 2 0 01-2-2v-67.373c0-3.435-.078-6.964-.228-10.485-.148-3.251-.767-6.278-1.841-8.995-1.018-2.571-2.667-4.584-5.047-6.153-2.372-1.552-6.029-2.341-10.865-2.341-1.372 0-3.265.328-5.629.976-2.28.624-4.536 1.826-6.705 3.577-2.152 1.732-4.036 4.306-5.605 7.655-1.569 3.356-2.367 7.877-2.367 13.438v69.701a2 2 0 01-2 2H68.857a2 2 0 01-2-2V111.594a2 2 0 012-1.999h31.13a2 2 0 012 1.999v11.007c3.834-4.499 8.248-8.152 13.173-10.896 6.396-3.559 13.799-5.362 22.002-5.362 7.846 0 15.127 1.548 21.642 4.604 5.794 2.722 10.424 7.26 13.791 13.52 3.449-4.362 7.833-8.306 13.071-11.752 6.422-4.228 14.102-6.371 22.824-6.371 6.499 0 12.625.807 18.209 2.399 5.686 1.628 10.635 4.271 14.712 7.857 4.088 3.605 7.318 8.357 9.601 14.123 2.25 5.719 3.391 12.649 3.391 20.604v80.384a2.002 2.002 0 01-2.001 2z"})),s||(s=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M99.988 111.595v16.264h.463c4.338-6.191 9.563-10.998 15.684-14.406 6.117-3.402 13.129-5.11 21.027-5.11 7.588 0 14.521 1.475 20.793 4.415 6.274 2.945 11.038 8.131 14.291 15.567 3.56-5.265 8.4-9.913 14.521-13.94 6.117-4.025 13.358-6.042 21.724-6.042 6.351 0 12.234.776 17.66 2.325 5.418 1.549 10.065 4.027 13.938 7.434 3.869 3.41 6.889 7.863 9.062 13.357 2.167 5.504 3.253 12.122 3.253 19.869v80.385H219.41v-68.074c0-4.025-.154-7.82-.465-11.385-.313-3.56-1.161-6.656-2.555-9.293-1.395-2.631-3.45-4.724-6.157-6.274-2.711-1.543-6.391-2.322-11.037-2.322s-8.403.896-11.269 2.671c-2.868 1.784-5.112 4.109-6.737 6.971-1.626 2.869-2.711 6.12-3.252 9.762a74.395 74.395 0 00-.814 11.035v66.91h-32.991v-67.375c0-3.562-.081-7.087-.23-10.57-.158-3.487-.814-6.7-1.978-9.645-1.162-2.94-3.099-5.304-5.809-7.088-2.711-1.775-6.699-2.671-11.965-2.671-1.551 0-3.603.349-6.156 1.048-2.556.697-5.036 2.016-7.435 3.949-2.404 1.938-4.454 4.726-6.158 8.363-1.705 3.642-2.556 8.402-2.556 14.287v69.701h-32.99V111.595h31.132zM304.909 236.733c-5.883 0-11.46-.729-16.574-2.163-5.192-1.464-9.806-3.774-13.713-6.871-3.944-3.117-7.068-7.111-9.282-11.871-2.205-4.733-3.324-10.412-3.324-16.876 0-7.13 1.293-13.117 3.846-17.797 2.542-4.674 5.877-8.464 9.912-11.263 3.97-2.752 8.556-4.842 13.63-6.209a142.954 142.954 0 0114.961-3.184 261.677 261.677 0 0114.754-1.872c4.679-.452 8.88-1.139 12.489-2.039 3.412-.854 6.118-2.09 8.042-3.672 1.666-1.37 2.416-3.384 2.292-6.151-.002-3.289-.502-5.816-1.492-7.595-.998-1.798-2.283-3.15-3.927-4.138-1.703-1.02-3.725-1.713-6.012-2.062-2.47-.37-5.146-.557-7.947-.557-6.034 0-10.789 1.271-14.135 3.783-3.233 2.424-5.155 6.64-5.714 12.527a2.003 2.003 0 01-1.992 1.812h-32.992a2.006 2.006 0 01-1.457-.629 2.013 2.013 0 01-.54-1.491c.485-8.073 2.55-14.894 6.142-20.272a41.725 41.725 0 0113.661-12.931c5.424-3.191 11.612-5.498 18.392-6.857a103.675 103.675 0 0120.26-2.013c6.096 0 12.365.437 18.626 1.296 6.377.88 12.285 2.622 17.562 5.177 5.376 2.604 9.845 6.29 13.282 10.951 3.498 4.744 5.271 11.048 5.271 18.731v62.494c0 5.307.306 10.462.915 15.319.576 4.64 1.572 8.116 2.963 10.338.385.616.407 1.395.055 2.031a2.002 2.002 0 01-1.75 1.03h-33.457c-.861 0-1.624-.55-1.898-1.367a49.145 49.145 0 01-1.572-5.936 49.182 49.182 0 01-.38-2.12 44.922 44.922 0 01-16.474 9.105 77.066 77.066 0 01-22.423 3.342zm37.032-60.072c-.809.409-1.676.768-2.596 1.074-2.161.72-4.511 1.326-6.988 1.807-2.442.475-5.033.872-7.699 1.186-2.631.311-5.251.697-7.784 1.146a56.995 56.995 0 00-7.051 1.792c-2.194.711-4.114 1.667-5.699 2.842-1.531 1.128-2.785 2.587-3.731 4.335-.917 1.709-1.385 3.97-1.385 6.719 0 2.598.465 4.778 1.385 6.481.928 1.722 2.142 3.035 3.716 4.018 1.644 1.026 3.601 1.757 5.816 2.17 2.344.439 4.799.663 7.297.663 6.105 0 10.836-.996 14.063-2.961 3.244-1.973 5.666-4.349 7.199-7.062 1.568-2.78 2.542-5.62 2.892-8.436.376-3.019.565-5.436.565-7.187v-8.587z"})),o||(o=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M273.544 129.255c3.405-5.113 7.744-9.215 13.012-12.316 5.264-3.097 11.186-5.303 17.771-6.621a101.17 101.17 0 0119.865-1.976c6.042 0 12.158.428 18.354 1.277 6.195.855 11.85 2.522 16.962 4.997 5.111 2.477 9.292 5.926 12.546 10.338 3.253 4.414 4.879 10.262 4.879 17.543v62.494c0 5.428.31 10.611.931 15.567.615 4.959 1.701 8.676 3.251 11.153H347.66a46.656 46.656 0 01-1.511-5.693 48.292 48.292 0 01-.813-5.923c-5.267 5.422-11.465 9.217-18.585 11.386a74.81 74.81 0 01-21.842 3.251c-5.733 0-11.077-.698-16.033-2.09-4.958-1.395-9.293-3.562-13.01-6.51-3.718-2.938-6.622-6.656-8.713-11.147s-3.138-9.84-3.138-16.033c0-6.813 1.199-12.43 3.604-16.84 2.399-4.417 5.495-7.939 9.295-10.575 3.793-2.632 8.129-4.607 13.01-5.923a140.326 140.326 0 0114.752-3.137 253.631 253.631 0 0114.638-1.857c4.801-.466 9.062-1.164 12.779-2.093 3.718-.929 6.658-2.282 8.829-4.065 2.165-1.781 3.172-4.375 3.02-7.785 0-3.56-.58-6.389-1.742-8.479-1.161-2.09-2.711-3.719-4.646-4.88-1.937-1.161-4.183-1.936-6.737-2.325-2.557-.382-5.309-.58-8.248-.58-6.506 0-11.617 1.395-15.335 4.183-3.716 2.788-5.889 7.437-6.506 13.94h-32.991c.462-7.742 2.395-14.173 5.807-19.281zm65.169 46.583a53.802 53.802 0 01-6.736 1.741c-2.402.465-4.918.853-7.551 1.161-2.635.313-5.268.698-7.899 1.163a59.302 59.302 0 00-7.317 1.857c-2.404.779-4.495 1.822-6.274 3.138-1.784 1.317-3.216 2.985-4.3 4.994-1.085 2.014-1.626 4.571-1.626 7.668 0 2.94.541 5.422 1.626 7.431 1.084 2.017 2.558 3.604 4.416 4.765s4.025 1.976 6.507 2.438c2.475.466 5.031.698 7.665.698 6.505 0 11.537-1.082 15.103-3.253 3.561-2.166 6.192-4.762 7.899-7.785 1.702-3.019 2.749-6.072 3.137-9.174.384-3.097.58-5.576.58-7.434V172.93c-1.396 1.243-3.138 2.21-5.23 2.908zM444.542 234.874c-5.187 0-10.173-.361-14.823-1.069-4.802-.732-9.104-2.183-12.779-4.313-3.789-2.185-6.821-5.341-9.006-9.375-2.163-3.986-3.26-9.232-3.26-15.59v-68.859h-17.981a2 2 0 01-2-1.999v-22.073a2 2 0 012-1.999h17.981V75.582a2 2 0 012-2h32.992a2 2 0 012 2v34.014h22.162a2 2 0 012 1.999v22.073a2 2 0 01-2 1.999h-22.162v57.479c0 6.229 1.198 8.731 2.202 9.733 1.004 1.007 3.506 2.205 9.738 2.205 1.804 0 3.542-.076 5.161-.225a44.198 44.198 0 004.669-.665 1.994 1.994 0 011.661.415c.463.379.73.946.73 1.546v25.555a2 2 0 01-1.672 1.974c-2.834.472-6.041.794-9.527.957-3.613.157-6.91.233-10.086.233z"})),r||(r=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M463.825 111.595v22.072h-24.161v59.479c0 5.573.928 9.292 2.788 11.149 1.856 1.859 5.576 2.788 11.152 2.788 1.859 0 3.638-.076 5.343-.232a45.912 45.912 0 004.878-.696v25.557c-2.788.465-5.887.773-9.293.931-3.407.149-6.737.23-9.99.23-5.111 0-9.953-.35-14.521-1.048-4.571-.695-8.597-2.047-12.081-4.063-3.486-2.011-6.236-4.88-8.248-8.597-2.016-3.714-3.021-8.595-3.021-14.639v-70.859h-19.98v-22.072h19.98V75.583h32.992v36.012h24.162zM512.613 233.711h-32.991a2 2 0 01-2-2V111.594a2 2 0 012-1.999h31.366a2 2 0 012 1.999v15.069a43.465 43.465 0 013.199-4.382 43.541 43.541 0 019.496-8.522 46.77 46.77 0 0111.415-5.462c4.056-1.298 8.327-1.954 12.691-1.954 2.341 0 4.953.418 7.766 1.243a2 2 0 011.437 1.92v30.67a2 2 0 01-2.395 1.96c-1.484-.3-3.299-.565-5.392-.787a57.416 57.416 0 00-6.062-.339c-5.706 0-10.572.95-14.467 2.823-3.862 1.86-7.012 4.428-9.361 7.629-2.389 3.263-4.115 7.12-5.127 11.47-1.043 4.479-1.574 9.409-1.574 14.647v54.132a2.002 2.002 0 01-2.001 2z"})),l||(l=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M510.988 111.595V133.9h.465c1.546-3.72 3.636-7.163 6.272-10.341a41.182 41.182 0 019.06-8.131 44.466 44.466 0 0110.923-5.228c3.868-1.237 7.898-1.859 12.081-1.859 2.168 0 4.566.39 7.202 1.163v30.67c-1.551-.312-3.41-.584-5.576-.814a58.79 58.79 0 00-6.274-.35c-6.041 0-11.152 1.01-15.332 3.021-4.182 2.014-7.55 4.761-10.107 8.247-2.555 3.487-4.379 7.55-5.462 12.198-1.083 4.645-1.625 9.682-1.625 15.102v54.133h-32.991V111.595h31.364zM603.923 233.711H570.93a2 2 0 01-2-2V111.594a2 2 0 012-1.999h32.994a2 2 0 012 1.999v120.117a2.002 2.002 0 01-2.001 2zm0-138.705H570.93a2 2 0 01-2-1.999V65.825a2 2 0 012-2h32.994a2 2 0 012 2v27.182a2.002 2.002 0 01-2.001 1.999z"})),c||(c=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M570.93 93.007V65.824h32.994v27.183H570.93zm32.994 18.588v120.117H570.93V111.595h32.994zM742.163 233.711h-37.64a1.995 1.995 0 01-1.667-.896l-23.426-35.352-23.426 35.352a1.992 1.992 0 01-1.667.896h-36.938a2.003 2.003 0 01-1.77-1.067 2.002 2.002 0 01.118-2.061l42.435-62.055-38.71-55.793a2.001 2.001 0 011.643-3.14h37.636c.665 0 1.287.33 1.658.882l19.477 28.893 19.255-28.884a2.004 2.004 0 011.665-.891h36.475c.746 0 1.43.415 1.776 1.078.343.66.289 1.46-.139 2.071l-38.69 55.082 43.578 62.744c.424.61.474 1.408.128 2.066a1.992 1.992 0 01-1.771 1.075z"})),d||(d=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M621.115 111.595h37.637l21.144 31.365 20.911-31.365h36.476l-39.496 56.226 44.377 63.892h-37.64l-25.093-37.87-25.094 37.87h-36.938l43.213-63.193-39.497-56.925zM791.322 340.809h-32.008a2 2 0 01-2-2v-7.712a2 2 0 012-2.001h21.13V11.71h-21.13a2 2 0 01-2-2V2a2 2 0 012-2h32.008a2 2 0 012 2v336.809a2 2 0 01-2 2z"})),m||(m=u.createElement("path",{opacity:.5,fill:"#FFF",d:"M782.443 331.097V9.711h-23.13v-7.71h32.008v336.807h-32.008v-7.711h23.13z"})),h||(h=u.createElement("path",{d:"M10.875 9.711v321.386h23.13v7.711H1.999V2.001h32.006v7.71h-23.13zM99.988 111.595v16.264h.463c4.338-6.191 9.563-10.998 15.684-14.406 6.117-3.402 13.129-5.11 21.027-5.11 7.588 0 14.521 1.475 20.793 4.415 6.274 2.945 11.038 8.131 14.291 15.567 3.56-5.265 8.4-9.913 14.521-13.94 6.117-4.025 13.358-6.042 21.724-6.042 6.351 0 12.234.776 17.66 2.325 5.418 1.549 10.065 4.027 13.938 7.434 3.869 3.41 6.889 7.863 9.062 13.357 2.167 5.504 3.253 12.122 3.253 19.869v80.385H219.41v-68.074c0-4.025-.154-7.82-.465-11.385-.313-3.56-1.161-6.656-2.555-9.293-1.395-2.631-3.45-4.724-6.157-6.274-2.711-1.543-6.391-2.322-11.037-2.322s-8.403.896-11.269 2.671c-2.868 1.784-5.112 4.109-6.737 6.971-1.626 2.869-2.711 6.12-3.252 9.762a74.395 74.395 0 00-.814 11.035v66.91h-32.991v-67.375c0-3.562-.081-7.087-.23-10.57-.158-3.487-.814-6.7-1.978-9.645-1.162-2.94-3.099-5.304-5.809-7.088-2.711-1.775-6.699-2.671-11.965-2.671-1.551 0-3.603.349-6.156 1.048-2.556.697-5.036 2.016-7.435 3.949-2.404 1.938-4.454 4.726-6.158 8.363-1.705 3.642-2.556 8.402-2.556 14.287v69.701h-32.99V111.595h31.132zM273.544 129.255c3.405-5.113 7.744-9.215 13.012-12.316 5.264-3.097 11.186-5.303 17.771-6.621a101.17 101.17 0 0119.865-1.976c6.042 0 12.158.428 18.354 1.277 6.195.855 11.85 2.522 16.962 4.997 5.111 2.477 9.292 5.926 12.546 10.338 3.253 4.414 4.879 10.262 4.879 17.543v62.494c0 5.428.31 10.611.931 15.567.615 4.959 1.701 8.676 3.251 11.153H347.66a46.656 46.656 0 01-1.511-5.693 48.292 48.292 0 01-.813-5.923c-5.267 5.422-11.465 9.217-18.585 11.386a74.81 74.81 0 01-21.842 3.251c-5.733 0-11.077-.698-16.033-2.09-4.958-1.395-9.293-3.562-13.01-6.51-3.718-2.938-6.622-6.656-8.713-11.147s-3.138-9.84-3.138-16.033c0-6.813 1.199-12.43 3.604-16.84 2.399-4.417 5.495-7.939 9.295-10.575 3.793-2.632 8.129-4.607 13.01-5.923a140.326 140.326 0 0114.752-3.137 253.631 253.631 0 0114.638-1.857c4.801-.466 9.062-1.164 12.779-2.093 3.718-.929 6.658-2.282 8.829-4.065 2.165-1.781 3.172-4.375 3.02-7.785 0-3.56-.58-6.389-1.742-8.479-1.161-2.09-2.711-3.719-4.646-4.88-1.937-1.161-4.183-1.936-6.737-2.325-2.557-.382-5.309-.58-8.248-.58-6.506 0-11.617 1.395-15.335 4.183-3.716 2.788-5.889 7.437-6.506 13.94h-32.991c.462-7.742 2.395-14.173 5.807-19.281zm65.169 46.583a53.802 53.802 0 01-6.736 1.741c-2.402.465-4.918.853-7.551 1.161-2.635.313-5.268.698-7.899 1.163a59.302 59.302 0 00-7.317 1.857c-2.404.779-4.495 1.822-6.274 3.138-1.784 1.317-3.216 2.985-4.3 4.994-1.085 2.014-1.626 4.571-1.626 7.668 0 2.94.541 5.422 1.626 7.431 1.084 2.017 2.558 3.604 4.416 4.765s4.025 1.976 6.507 2.438c2.475.466 5.031.698 7.665.698 6.505 0 11.537-1.082 15.103-3.253 3.561-2.166 6.192-4.762 7.899-7.785 1.702-3.019 2.749-6.072 3.137-9.174.384-3.097.58-5.576.58-7.434V172.93c-1.396 1.243-3.138 2.21-5.23 2.908zM463.825 111.595v22.072h-24.161v59.479c0 5.573.928 9.292 2.788 11.149 1.856 1.859 5.576 2.788 11.152 2.788 1.859 0 3.638-.076 5.343-.232a45.912 45.912 0 004.878-.696v25.557c-2.788.465-5.887.773-9.293.931-3.407.149-6.737.23-9.99.23-5.111 0-9.953-.35-14.521-1.048-4.571-.695-8.597-2.047-12.081-4.063-3.486-2.011-6.236-4.88-8.248-8.597-2.016-3.714-3.021-8.595-3.021-14.639v-70.859h-19.98v-22.072h19.98V75.583h32.992v36.012h24.162zM510.988 111.595V133.9h.465c1.546-3.72 3.636-7.163 6.272-10.341a41.182 41.182 0 019.06-8.131 44.466 44.466 0 0110.923-5.228c3.868-1.237 7.898-1.859 12.081-1.859 2.168 0 4.566.39 7.202 1.163v30.67c-1.551-.312-3.41-.584-5.576-.814a58.79 58.79 0 00-6.274-.35c-6.041 0-11.152 1.01-15.332 3.021-4.182 2.014-7.55 4.761-10.107 8.247-2.555 3.487-4.379 7.55-5.462 12.198-1.083 4.645-1.625 9.682-1.625 15.102v54.133h-32.991V111.595h31.364zM570.93 93.007V65.824h32.994v27.183H570.93zm32.994 18.588v120.117H570.93V111.595h32.994zM621.115 111.595h37.637l21.144 31.365 20.911-31.365h36.476l-39.496 56.226 44.377 63.892h-37.64l-25.093-37.87-25.094 37.87h-36.938l43.213-63.193-39.497-56.925zM782.443 331.097V9.711h-23.13v-7.71h32.008v336.807h-32.008v-7.711h23.13z"})))}t.default="img/matrix.d1fcad6.svg"},1723:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 24",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M16.98 1.28a4.872 4.872 0 01-1.114 3.49 4.099 4.099 0 01-3.237 1.53 4.636 4.636 0 011.144-3.36 4.957 4.957 0 013.207-1.66zm3.974 7.428a4.949 4.949 0 00-2.357 4.152 4.782 4.782 0 002.92 4.4 10.963 10.963 0 01-1.519 3.092c-.894 1.338-1.832 2.645-3.32 2.669-.708.016-1.186-.187-1.684-.4-.52-.22-1.06-.451-1.907-.451-.899 0-1.464.238-2.01.467-.47.198-.927.39-1.57.417-1.417.053-2.5-1.428-3.427-2.753-1.853-2.707-3.296-7.628-1.362-10.976a5.315 5.315 0 014.473-2.728c.804-.017 1.576.293 2.252.565.517.208.979.393 1.357.393.332 0 .78-.178 1.304-.386.824-.326 1.832-.727 2.859-.619 1.596.05 3.075.85 3.99 2.158z",fill:"#212121"})))}t.default="img/element-icons/brands/apple.845f048.svg"},1724:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return l}));var n,i,s,o=a(120);function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},r.apply(this,arguments)}function l(e){return o.createElement("svg",r({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 24",role:"presentation","aria-hidden":!0},e),n||(n=o.createElement("mask",{id:"facebook_svg__a",maskUnits:"userSpaceOnUse",x:2,y:1,width:22,height:22},o.createElement("path",{d:"M2.102 1.5H23.1v20.872H2.102V1.5z",fill:"#fff"}))),i||(i=o.createElement("g",{mask:"url(#facebook_svg__a)"},o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M23.1 11.999c0-5.799-4.701-10.5-10.5-10.5S2.1 6.2 2.1 11.999c0 5.24 3.84 9.585 8.86 10.373v-7.338H8.292V12h2.666V9.686c0-2.632 1.568-4.085 3.966-4.085 1.15 0 2.35.205 2.35.205V8.39h-1.323c-1.305 0-1.711.809-1.711 1.64v1.969h2.912l-.466 3.035h-2.446v7.338c5.02-.788 8.859-5.132 8.859-10.373z",fill:"#1877F2"}))),s||(s=o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M16.687 15.034L17.153 12H14.24v-1.97c0-.83.406-1.64 1.71-1.64h1.325V5.807s-1.202-.205-2.35-.205c-2.4 0-3.967 1.453-3.967 4.085v2.313H8.293v3.035h2.666v7.338a10.588 10.588 0 003.282 0v-7.338h2.446z",fill:"#fff"})))}t.default="img/element-icons/brands/facebook.d149f4a.svg"},1725:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 24",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{d:"M20.842 7.106a9.707 9.707 0 00-3.548-3.548C15.8 2.686 14.169 2.25 12.4 2.25c-1.769 0-3.4.436-4.894 1.308a9.707 9.707 0 00-3.548 3.548C3.086 8.6 2.65 10.23 2.65 12c0 2.124.62 4.035 1.86 5.732 1.24 1.696 2.841 2.87 4.805 3.522.228.043.398.013.508-.088a.497.497 0 00.165-.381l-.007-.686c-.004-.431-.006-.808-.006-1.13l-.292.051a3.725 3.725 0 01-.705.045 5.354 5.354 0 01-.882-.09 1.97 1.97 0 01-.85-.38 1.611 1.611 0 01-.56-.78l-.126-.293a3.174 3.174 0 00-.4-.647c-.182-.237-.366-.398-.552-.482l-.089-.064a.928.928 0 01-.165-.152.696.696 0 01-.114-.178c-.026-.06-.005-.108.063-.146.068-.039.19-.057.368-.057l.254.038c.17.034.379.135.629.304.25.17.454.39.615.66.195.348.43.612.705.794.275.182.552.273.831.273.28 0 .52-.021.724-.063.203-.043.393-.107.571-.191.076-.567.284-1.003.622-1.308a8.696 8.696 0 01-1.301-.228 5.18 5.18 0 01-1.193-.496 3.419 3.419 0 01-1.022-.85c-.271-.339-.493-.783-.667-1.333-.173-.55-.26-1.185-.26-1.904 0-1.025.335-1.896 1.003-2.616-.313-.77-.284-1.633.089-2.59.245-.076.61-.018 1.092.172.482.19.835.354 1.06.489.224.135.404.25.54.343.787-.22 1.599-.33 2.437-.33.838 0 1.65.11 2.438.33l.482-.305c.33-.203.72-.39 1.168-.559.448-.169.791-.215 1.028-.14.381.957.415 1.82.102 2.59.668.72 1.003 1.592 1.003 2.616 0 .72-.087 1.356-.26 1.91-.174.555-.398.999-.673 1.333a3.55 3.55 0 01-1.028.845c-.411.228-.809.393-1.194.495a8.69 8.69 0 01-1.301.229c.44.38.66.981.66 1.802v2.678c0 .153.053.28.159.381.105.102.273.131.501.089 1.964-.652 3.566-1.826 4.805-3.523 1.24-1.697 1.86-3.607 1.86-5.732 0-1.768-.436-3.4-1.308-4.893z",fill:"#000"})))}t.default="img/element-icons/brands/github.de3b60e.svg"},1726:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return m}));var n,i,s,o,r,l,c=a(120);function d(){return d=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},d.apply(this,arguments)}function m(e){return c.createElement("svg",d({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),n||(n=c.createElement("path",{d:"M12 20.33l3.317-10.2H8.689l3.312 10.2z",fill:"#E24329"})),i||(i=c.createElement("path",{d:"M4.043 10.13l-1.01 3.098a.687.687 0 00.25.768L12 20.33l-7.957-10.2z",fill:"#FCA326"})),s||(s=c.createElement("path",{d:"M4.042 10.129h4.645L6.688 3.986c-.102-.315-.548-.315-.654 0l-1.992 6.143z",fill:"#E24329"})),o||(o=c.createElement("path",{d:"M19.96 10.13l1.006 3.098a.687.687 0 01-.248.768l-8.719 6.334 7.961-10.2z",fill:"#FCA326"})),r||(r=c.createElement("path",{d:"M19.962 10.129h-4.645l1.995-6.143c.102-.315.548-.315.654 0l1.996 6.143z",fill:"#E24329"})),l||(l=c.createElement("path",{d:"M12 20.33l3.315-10.2h4.645L12 20.33zM11.998 20.33l-7.956-10.2h4.645L12 20.33z",fill:"#FC6D26"})))}t.default="img/element-icons/brands/gitlab.e075acd.svg"},1727:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return c}));var n,i,s,o,r=a(120);function l(){return l=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},l.apply(this,arguments)}function c(e){return r.createElement("svg",l({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),n||(n=r.createElement("path",{d:"M22.501 12.233c0-.863-.071-1.493-.226-2.146h-10.06v3.896h5.905c-.119.969-.762 2.427-2.19 3.407l-.02.13 3.18 2.415.22.022c2.024-1.832 3.191-4.527 3.191-7.724z",fill:"#4285F4"})),i||(i=r.createElement("path",{d:"M12.215 22.5c2.893 0 5.321-.933 7.095-2.543l-3.381-2.567c-.905.618-2.12 1.05-3.714 1.05a6.438 6.438 0 01-6.096-4.363l-.125.01-3.307 2.509-.044.117c1.762 3.43 5.381 5.787 9.572 5.787z",fill:"#34A853"})),s||(s=r.createElement("path",{d:"M6.12 14.077A6.347 6.347 0 015.763 12c0-.723.131-1.423.345-2.077l-.006-.139-3.348-2.548-.11.05A10.339 10.339 0 001.501 12c0 1.692.417 3.29 1.143 4.713l3.476-2.636z",fill:"#FBBC05"})),o||(o=r.createElement("path",{d:"M12.215 5.56c2.012 0 3.369.852 4.143 1.563L19.38 4.23c-1.857-1.692-4.273-2.73-7.166-2.73-4.19 0-7.81 2.357-9.572 5.787l3.465 2.636a6.465 6.465 0 016.107-4.363z",fill:"#EB4335"})))}t.default="img/element-icons/brands/google.44aaf41.svg"},1728:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 24",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{d:"M9.042 21c-2.427 0-4.688-.706-6.592-1.923 1.616.104 4.469-.146 6.243-1.838-2.67-.123-3.873-2.17-4.03-3.045.227.088 1.308.193 1.919-.052-3.07-.77-3.541-3.464-3.436-4.286.575.402 1.552.542 1.936.507-2.86-2.047-1.832-5.126-1.326-5.79 2.053 2.843 5.13 4.44 8.936 4.53a4.398 4.398 0 01-.11-.98 4.367 4.367 0 014.361-4.373c1.259 0 2.393.535 3.189 1.39.84-.197 2.106-.659 2.725-1.058-.312 1.12-1.283 2.054-1.87 2.4.005.012-.005-.012 0 0 .516-.078 1.912-.346 2.463-.72-.273.629-1.302 1.675-2.147 2.26C21.46 14.953 16.157 21 9.042 21z",fill:"#1D9BF0"})))}t.default="img/element-icons/brands/twitter.43b393b.svg"},1729:function(e,t,a){"use strict";a.d(t,"a",(function(){return y}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(244),l=a(1),c=a(121),d=a(123),m=a(185),h=a(655),u=a(125),p=a(196),g=a(129),b=a(231),v=a(128),f=a(495),E=a(176);class y extends o.a.PureComponent{constructor(e){super(e),i()(this,"intervalHandle",void 0),i()(this,"checkRequestIsPending",(()=>{const{request:e}=this.props;e.canAccept||p.a.sharedInstance().dismissToast(this.props.toastKey)})),i()(this,"cancel",(()=>{p.a.sharedInstance().dismissToast(this.props.toastKey);try{this.props.request.cancel()}catch(e){l.a.error("Error while cancelling verification request",e)}})),i()(this,"accept",(async()=>{p.a.sharedInstance().dismissToast(this.props.toastKey);const{request:e}=this.props,t=d.a.get();try{if(e.channel.roomId){var a;u.a.dispatch({action:v.a.ViewRoom,room_id:e.channel.roomId,should_peek:!1,metricsTrigger:"VerificationRequest"});const n=null!==(a=t.getUser(e.otherUserId))&&void 0!==a?a:void 0;E.a.instance.setCards([{phase:m.a.RoomSummary},{phase:m.a.RoomMemberInfo,state:{member:n}},{phase:m.a.EncryptionPanel,state:{verificationRequest:e,member:n}}],void 0,e.channel.roomId)}else g.b.createDialog(f.a,{verificationRequest:e,onFinished:()=>{e.cancel()}},void 0,!1,!0);await e.accept()}catch(e){l.a.error(e.message)}})),this.state={counter:Math.ceil(e.request.timeout/1e3)}}async componentDidMount(){const{request:e}=this.props;if(e.timeout&&e.timeout>0&&(this.intervalHandle=window.setInterval((()=>{let{counter:e}=this.state;e=Math.max(0,e-1),this.setState({counter:e})}),1e3)),e.on(r.l.Change,this.checkRequestIsPending),this.checkRequestIsPending(),e.isSelfVerification){var t;const a=d.a.get(),n=(await a.getDevice(e.channel.deviceId)).last_seen_ip;this.setState({device:null!==(t=a.getStoredDevice(a.getUserId(),e.channel.deviceId))&&void 0!==t?t:void 0,ip:n})}}componentWillUnmount(){clearInterval(this.intervalHandle);const{request:e}=this.props;e.off(r.l.Change,this.checkRequestIsPending)}render(){const{request:e}=this.props;let t,a;if(e.isSelfVerification)this.state.device&&(t=this.state.device.getDisplayName(),a=Object(c.b)("%(deviceId)s from %(ip)s",{deviceId:this.state.device.deviceId,ip:this.state.ip}));else{const a=e.otherUserId,n=e.channel.roomId;if(t=n?Object(h.b)(a,n):a,t===a){const e=d.a.get().getUser(a);e&&e.displayName&&(t=Object(c.b)("%(name)s (%(userId)s)",{name:e.displayName,userId:a}))}}const n=0===this.state.counter?Object(c.b)("Ignore"):Object(c.b)("Ignore (%(counter)s)",{counter:this.state.counter});return o.a.createElement(b.a,{description:t,detail:a,acceptLabel:Object(c.b)("Verify Session"),onAccept:this.accept,rejectLabel:n,onReject:this.cancel})}}},1730:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n=a(220),i=a(128),s=a(125);const o=e=>{s.a.dispatch({action:i.a.ViewUserSettings,initialTabId:e?n.a.SessionManager:n.a.Security})}},1741:function(e,t,a){"use strict";var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(149),l=a(127),c=a.n(l),d=a(215),m=a(153),h=a(208),u=a(446),p=a(252),g=a(951),b=a(125),v=a(126),f=a(138);var E=e=>{let{vertical:t,reverse:a,id:n,passRef:i}=e;const s=["mx_ResizeHandle"];return t?s.push("mx_ResizeHandle_vertical"):s.push("mx_ResizeHandle_horizontal"),a&&s.push("mx_ResizeHandle_reverse"),o.a.createElement("div",{ref:i,className:s.join(" "),"data-id":n},o.a.createElement("div",null))};class y{constructor(e,t,a,n){this.resizer=t,this.sizer=a,this.container=n,i()(this,"domNode",void 0),i()(this,"id",void 0),i()(this,"reverse",void 0),this.reverse=t.isReverseResizeHandle(e),this.domNode=n||(this.reverse?e.nextElementSibling:e.previousElementSibling),this.id=e.getAttribute("data-id")}copyWith(e,t,a,n){return new(0,this.constructor)(e,t,a,n)}advance(e){let t=this.reverse?this.domNode.previousElementSibling:this.domNode.nextElementSibling;const a=e!==this.reverse;do{var n,i;if(a)t=null===(n=t)||void 0===n?void 0:n.nextElementSibling;else t=null===(i=t)||void 0===i?void 0:i.previousElementSibling}while(t&&!this.resizer.isResizeHandle(t));if(t){const e=this.copyWith(t,this.resizer,this.sizer);return e.reverse=this.reverse,e}}next(){return this.advance(!0)}previous(){return this.advance(!1)}size(){return this.sizer.getItemSize(this.domNode)}offset(){return this.sizer.getItemOffset(this.domNode)}start(){this.sizer.start(this.domNode)}finish(){this.sizer.finish(this.domNode)}getSize(){return this.sizer.getDesiredItemSize(this.domNode)}setRawSize(e){this.sizer.setItemSize(this.domNode,e)}setSize(e){var t,a;this.setRawSize(`${Math.round(e)}px`),null===(t=this.resizer.config)||void 0===t||null===(a=t.onResized)||void 0===a||a.call(t,e,this.id,this.domNode)}clearSize(){var e,t;this.sizer.clearItemSize(this.domNode),null===(e=this.resizer.config)||void 0===e||null===(t=e.onResized)||void 0===t||t.call(e,null,this.id,this.domNode)}first(){var e;if(null===(e=this.domNode.parentElement)||void 0===e||!e.children)return;const t=Array.from(this.domNode.parentElement.children).find((e=>this.resizer.isResizeHandle(e)));return t?this.copyWith(t,this.resizer,this.sizer):void 0}last(){var e;if(null===(e=this.domNode.parentElement)||void 0===e||!e.children)return;const t=Array.from(this.domNode.parentElement.children).reverse().find((e=>this.resizer.isResizeHandle(e)));return t?this.copyWith(t,this.resizer,this.sizer):void 0}}class _{constructor(e,t,a){this.container=e,this.vertical=t,this.reverse=a}getItemOffset(e){const t=(this.vertical?e.offsetTop:e.offsetLeft)-this.getOffset();return this.reverse?this.getTotalSize()-(t+this.getItemSize(e)):t}getItemSize(e){return this.vertical?e.offsetHeight:e.offsetWidth}getTotalSize(){return this.vertical?this.container.offsetHeight:this.container.offsetWidth}getOffset(){return this.vertical?this.container.offsetTop:this.container.offsetLeft}getPageOffset(){let e=this.container,t=0;for(;e;){t+=this.vertical?e.offsetTop:e.offsetLeft,e=e.offsetParent}return t}getDesiredItemSize(e){return this.vertical?e.style.height:e.style.width}setItemSize(e,t){this.vertical?e.style.height=t:e.style.width=t}clearItemSize(e){this.vertical?e.style.height=null:e.style.width=null}start(e){}finish(e){}offsetFromEvent(e){const t=this.vertical?e.pageY:e.pageX;return this.reverse?this.getPageOffset()+this.getTotalSize()-t:t-this.getPageOffset()}}class S{static createItem(e,t,a){return new y(e,t,a)}static createSizer(e,t,a){return new _(e,t,a)}constructor(e){this.item=e,i()(this,"beforeOffset",void 0),this.beforeOffset=e.offset()}get size(){return this.item.getSize()}set size(e){this.item.setRawSize(e)}resize(e){this.item.setSize(e)}resizeFromContainerOffset(e){this.resize(e-this.beforeOffset)}start(){this.item.start()}finish(){this.item.finish()}}class w extends _{start(e){this.vertical?e.style.minHeight="":e.style.minWidth=""}finish(e){const t=e.offsetParent;if(t)if(this.vertical){const a=(e.offsetHeight/t.offsetHeight*100).toFixed(2)+"%";e.style.minHeight=a,e.style.height=a}else{const a=(e.offsetWidth/t.offsetWidth*100).toFixed(2)+"%";e.style.minWidth=a,e.style.width=a}}}class O extends S{static createSizer(e,t,a){return new w(e,t,a)}}class C extends y{notifyCollapsed(e){var t,a;null===(t=this.resizer.config)||void 0===t||null===(a=t.onCollapsed)||void 0===a||a.call(t,e,this.id,this.domNode)}get isCollapsed(){var e,t,a;return null!==(e=null===(t=this.resizer.config)||void 0===t||null===(a=t.isItemCollapsed)||void 0===a?void 0:a.call(t,this.domNode))&&void 0!==e&&e}}class x extends S{static createItem(e,t,a,n){return new C(e,t,a,n)}constructor(e){var t,a;super(e),i()(this,"toggleSize",void 0),i()(this,"isCollapsed",void 0),this.toggleSize=null===(t=e.resizer)||void 0===t||null===(a=t.config)||void 0===a?void 0:a.toggleSize,this.isCollapsed=e.isCollapsed}resize(e){const t=!!this.toggleSize&&e<this.toggleSize;t!==this.isCollapsed&&(this.isCollapsed=t,this.item.notifyCollapsed(t)),t||super.resize(e)}}var j=a(150);class k{constructor(e,t,a){this.container=e,this.distributorCtor=t,this.config=a,i()(this,"classNames",void 0),i()(this,"onMouseDown",(e=>{var t,a,n;if(0!==e.button)return;const i=e.target&&e.target.closest(`.${this.classNames.handle}`),s=null==this||null===(t=this.config)||void 0===t?void 0:t.handler;if(!i||!s&&i.parentElement!==this.container||s&&i!==s)return;var o,r;(e.preventDefault(),this.classNames.resizing)&&(null===(o=this.container)||void 0===o||null===(r=o.classList)||void 0===r||r.add(this.classNames.resizing));null===(a=this.config)||void 0===a||null===(n=a.onResizeStart)||void 0===n||n.call(a);const{sizer:l,distributor:c}=this.createSizerAndDistributor(i);c.start();const d=e=>{const t=l.offsetFromEvent(e);c.resizeFromContainerOffset(t)},m=document.body,h=()=>{var e,t,a,n;this.classNames.resizing&&(null===(a=this.container)||void 0===a||null===(n=a.classList)||void 0===n||n.remove(this.classNames.resizing));c.finish(),null===(e=this.config)||void 0===e||null===(t=e.onResizeStop)||void 0===t||t.call(e),m.removeEventListener("mouseup",h,!1),document.removeEventListener("mouseleave",h,!1),m.removeEventListener("mousemove",d,!1)};m.addEventListener("mouseup",h,!1),document.addEventListener("mouseleave",h,!1),m.addEventListener("mousemove",d,!1)})),i()(this,"onResize",Object(j.throttle)((()=>{const e=this.getDistributors();e.forEach((e=>e.start())),e.forEach((e=>e.finish()))}),100,{trailing:!0,leading:!0})),i()(this,"getDistributors",(()=>this.getResizeHandles().map((e=>{const{distributor:t}=this.createSizerAndDistributor(e);return t})))),this.classNames={handle:"resizer-handle",reverse:"resizer-reverse",vertical:"resizer-vertical",resizing:"resizer-resizing"}}setClassNames(e){this.classNames=e}attach(){var e,t,a;const n=null!==(e=null==this||null===(t=this.config)||void 0===t||null===(a=t.handler)||void 0===a?void 0:a.parentElement)&&void 0!==e?e:this.container;null==n||n.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("resize",this.onResize)}detach(){var e,t,a;const n=null!==(e=null==this||null===(t=this.config)||void 0===t||null===(a=t.handler)||void 0===a?void 0:a.parentElement)&&void 0!==e?e:this.container;null==n||n.removeEventListener("mousedown",this.onMouseDown,!1),window.removeEventListener("resize",this.onResize)}forHandleAt(e){const t=this.getResizeHandles()[e];if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}forHandleWithId(e){const t=this.getResizeHandles().find((t=>t.getAttribute("data-id")===e));if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}isReverseResizeHandle(e){return e.classList.contains(this.classNames.reverse)}isResizeHandle(e){return e.classList.contains(this.classNames.handle)}createSizerAndDistributor(e){var t;const a=e.classList.contains(this.classNames.vertical),n=this.isReverseResizeHandle(e),i=this.distributorCtor,s=null!==(t=this.config)&&void 0!==t&&t.handler?this.container:void 0,o=i.createSizer(this.container,a,n),r=i.createItem(e,this,o,null!=s?s:void 0);return{sizer:o,distributor:new i(r)}}getResizeHandles(){var e,t;return null!=this&&null!==(e=this.config)&&void 0!==e&&e.handler?[this.config.handler]:null!==(t=this.container)&&void 0!==t&&t.children?Array.from(this.container.querySelectorAll(`.${this.classNames.handle}`)):[]}}var R=a(133),I=a(158),T=a(194),N=a(121),P=a(231),D=a(196),M=a(396);const A="serverlimit",U=()=>{D.a.sharedInstance().dismissToast(A)};var L=a(128),F=a(1019),B=a(186),V=a(836),W=a(145),z=a(129),H=a(966),K=a(124);class G extends s.PureComponent{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"onAction",(e=>{"focus_room_filter"===e.action&&this.openSpotlight()})),this.dispatcherRef=b.a.register(this.onAction)}componentWillUnmount(){b.a.unregister(this.dispatcherRef)}openSpotlight(){z.b.createDialog(H.b,{},"mx_SpotlightDialog_wrapper",!1,!0)}render(){const e=c()({mx_RoomSearch:!0,mx_RoomSearch_minimized:this.props.isMinimized},"mx_RoomSearch_spotlightTrigger"),t=s.createElement("div",{className:"mx_RoomSearch_icon"}),a=s.createElement("kbd",{className:"mx_RoomSearch_shortcutPrompt"},h.a?"⌘ K":Object(N.b)(W.a[h.b.CONTROL])+" K");return s.createElement(K.a,{onClick:this.openSpotlight,className:e},t,!this.props.isMinimized&&s.createElement("div",{className:"mx_RoomSearch_spotlightTriggerText"},Object(N.b)("Search")),a)}}var q=a(151),$=a(180),Y=a(212),J=a(155),Q=a(199),X=a(131),Z=a.n(X),ee=a(130),te=a(143),ae=a(214),ne=a(242),ie=a(142),se=a(169),oe=a(123),re=a(163),le=a(157),ce=a(257),de=a(152),me=a(293),he=a(178),ue=a(671),pe=a(211),ge=a(251),be=a(134),ve=a.n(be),fe=a(1662),Ee=a(818),ye=a(166);const _e=(e,t)=>{let a="";if(t)for(const e of t.entries())a+=e+"/";return`mx_space_collapsed_${a+e}`};class Se{static get instance(){return Se.internalInstance||(Se.internalInstance=new Se),Se.internalInstance}setSpaceCollapsedState(e,t,a){localStorage.setItem(_e(e,t),a.toString())}getSpaceCollapsedState(e,t,a){const n=localStorage.getItem(_e(e,t));return n?"true"===n:a}}i()(Se,"internalInstance",void 0);var we=a(249),Oe=a(342),Ce=a(345),xe=a(203),je=a(170);const ke=["space","spaceKey","className","selected","label","contextMenuTooltip","notificationState","avatarSize","isNarrow","children","ContextMenuComponent"],Re=["space","activeSpaces","isNested","isPanelCollapsed","onExpand","parents","innerRef","dragHandleProps"],Ie=["tabIndex"],Te=Object(s.forwardRef)(((e,t)=>{var a;let{space:n,spaceKey:i,className:s,selected:r,label:l,contextMenuTooltip:d,notificationState:m,avatarSize:h,isNarrow:u,children:p,ContextMenuComponent:g}=e,v=ve()(e,ke);const[f,E,y,_]=Object(de.q)(t),[S,w]=Object(je.i)(E),O=w?0:-1;let C,x,j=o.a.createElement("div",{className:"mx_SpaceButton_avatarPlaceholder"},o.a.createElement("div",{className:"mx_SpaceButton_icon"}));if(n&&(j=o.a.createElement(ye.a,{width:h,height:h,room:n})),m){let e=Object(N.b)("Jump to first unread room.");"invite"===(null==n?void 0:n.getMyMembership())&&(e=Object(N.b)("Jump to first invite."));const t=e=>{e.stopPropagation(),e.preventDefault(),$.a.instance.setActiveRoomInSpace(null!=i?i:n.roomId)};C=o.a.createElement("div",{className:"mx_SpacePanel_badgeContainer"},o.a.createElement(we.a,{onClick:t,forceCount:!1,notification:m,"aria-label":e,tabIndex:O,showUnsentTooltip:!0}))}f&&E.current&&g&&(x=o.a.createElement(g,Z()({},Object(de.p)(E.current.getBoundingClientRect(),0),{space:n,onFinished:_})));const k=null!==(a=v.onClick)&&void 0!==a?a:r&&n?()=>b.a.dispatch({action:L.a.ViewRoom,room_id:n.roomId}):()=>$.a.instance.setActiveSpace(null!=i?i:n.roomId);return o.a.createElement(q.a,Z()({},v,{className:c()("mx_SpaceButton",s,{mx_SpaceButton_active:r,mx_SpaceButton_hasMenuOpen:f,mx_SpaceButton_narrow:u}),title:l,onClick:k,onContextMenu:y,forceHide:!u||f,inputRef:E,tabIndex:O,onFocus:S}),p,o.a.createElement("div",{className:"mx_SpaceButton_selectionWrapper"},o.a.createElement("div",{className:"mx_SpaceButton_avatarWrapper"},j,C),!u&&o.a.createElement("span",{className:"mx_SpaceButton_name"},l),g&&o.a.createElement(Oe.a,{className:"mx_SpaceButton_menuButton",onClick:y,title:d,isExpanded:f}),x))}));class Ne extends o.a.PureComponent{constructor(e){super(e),i()(this,"buttonRef",Object(s.createRef)()),i()(this,"onSpaceUpdate",(()=>{this.setState({childSpaces:this.childSpaces})})),i()(this,"onRoomNameChange",(()=>{this.setState({name:this.props.space.name})})),i()(this,"toggleCollapse",(e=>{this.props.onExpand&&this.isCollapsed&&this.props.onExpand();const t=!this.isCollapsed;Se.instance.setSpaceCollapsedState(this.props.space.roomId,this.props.parents,t),this.setState({collapsed:t}),e.stopPropagation()})),i()(this,"onKeyDown",(e=>{var t;let a=!0;const n=Object(J.a)().getRoomListAction(e),i=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;switch(n){case W.h.CollapseRoomListSection:if(i&&!this.isCollapsed)this.toggleCollapse(e);else{var s,o,r;const e=null===(s=this.buttonRef)||void 0===s||null===(o=s.current)||void 0===o||null===(r=o.parentElement)||void 0===r?void 0:r.parentElement,t=null==e?void 0:e.previousElementSibling;null==t||t.focus()}break;case W.h.ExpandRoomListSection:if(i)if(this.isCollapsed)this.toggleCollapse(e);else{var l,c,d;const e=null===(l=this.buttonRef)||void 0===l||null===(c=l.current)||void 0===c?void 0:c.nextElementSibling,t=null==e?void 0:e.querySelector(".mx_SpaceItem");null==t||null===(d=t.querySelector(".mx_SpaceButton"))||void 0===d||d.focus()}break;default:a=!1}a&&(e.stopPropagation(),e.preventDefault())}));const t=Se.instance.getSpaceCollapsedState(e.space.roomId,this.props.parents,!e.isNested);this.state={name:this.props.space.name,collapsed:t,childSpaces:this.childSpaces},$.a.instance.on(this.props.space.roomId,this.onSpaceUpdate),this.props.space.on(te.d.Name,this.onRoomNameChange)}componentWillUnmount(){$.a.instance.off(this.props.space.roomId,this.onSpaceUpdate),this.props.space.off(te.d.Name,this.onRoomNameChange)}get childSpaces(){return $.a.instance.getChildSpaces(this.props.space.roomId).filter((e=>{var t;return!(null!==(t=this.props.parents)&&void 0!==t&&t.has(e.roomId))}))}get isCollapsed(){return this.state.collapsed||!!this.props.isPanelCollapsed}render(){var e,t;const a=this.props,{space:n,activeSpaces:i,isNested:s,isPanelCollapsed:r,onExpand:l,parents:d,innerRef:m,dragHandleProps:h}=a,u=ve()(a,Re),p=this.isCollapsed,g=c()(this.props.className,{mx_SpaceItem:!0,mx_SpaceItem_narrow:r,collapsed:p,hasSubSpaces:null===(e=this.state.childSpaces)||void 0===e?void 0:e.length}),b="invite"===n.getMyMembership(),v=b?Ce.a.forSymbol("!",xe.a.Red):$.a.instance.getNotificationState(n.roomId),f=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;let E;f&&!p&&(E=o.a.createElement(Pe,{spaces:this.state.childSpaces,activeSpaces:i,isNested:!0,parents:new Set(d).add(n.roomId)}));const y=f?o.a.createElement(K.a,{className:"mx_SpaceButton_toggleCollapse",onClick:this.toggleCollapse,tabIndex:-1,"aria-label":p?Object(N.b)("Expand"):Object(N.b)("Collapse")}):null,_=h||{},{tabIndex:S}=_,w=ve()(_,Ie),O=i.includes(n.roomId);return o.a.createElement("li",Z()({},u,{className:g,ref:m,"aria-expanded":f?!p:void 0,"aria-selected":O,role:"treeitem"}),o.a.createElement(Te,Z()({},w,{space:n,className:b?"mx_SpaceButton_invite":void 0,selected:O,label:this.state.name,contextMenuTooltip:Object(N.b)("Space options"),notificationState:v,isNarrow:r,avatarSize:s?24:32,onKeyDown:this.onKeyDown,ContextMenuComponent:"join"===this.props.space.getMyMembership()?ue.a:void 0}),y),E)}}i()(Ne,"contextType",R.a);const Pe=e=>{let{spaces:t,activeSpaces:a,isNested:n,parents:i}=e;return o.a.createElement("ul",{className:"mx_SpaceTreeLevel",role:"group"},t.map((e=>o.a.createElement(Ne,{key:e.roomId,activeSpaces:a,space:e,isNested:n,parents:i}))))};var De,Me,Ae=a(222),Ue=a(182),Le=a(968),Fe=a(220);function Be(){return Be=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Be.apply(this,arguments)}function Ve(e){return s.createElement("svg",Be({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),De||(De=s.createElement("path",{d:"M11 18.598V15h2v3.598C13 20.5 12.238 22 12 22s-1-1.5-1-3.402zM9.5 6c-.325-.167-1.714-.8-2.883-2s-.495-2 .513-2H12v4H9.5zM14.5 6c.325-.167 1.714-.8 2.883-2s.495-2-.513-2H12v4h2.5zM9.429 6h5.142L15 10H9l.429-4z",fill:"#000"})),Me||(Me=s.createElement("path",{d:"M12 9c-3.069 0-5.676 1.693-6.621 4.048C4.967 14.073 5.895 15 7 15h10c1.105 0 2.032-.927 1.621-1.952C17.677 10.693 15.07 9 12 9z",fill:"#000"})))}var We,ze,He;function Ke(){return Ke=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Ke.apply(this,arguments)}function Ge(e){return s.createElement("svg",Ke({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",role:"presentation","aria-hidden":!0},e),We||(We=s.createElement("circle",{cx:15.5,cy:10,r:1.5,transform:"rotate(180 15.5 10)",fill:"#212121"})),ze||(ze=s.createElement("circle",{cx:10,cy:10,r:1.5,transform:"rotate(180 10 10)",fill:"#212121"})),He||(He=s.createElement("circle",{cx:4.5,cy:10,r:1.5,transform:"rotate(180 4.5 10)",fill:"#212121"})))}var qe,$e,Ye;function Je(){return Je=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Je.apply(this,arguments)}function Qe(e){return s.createElement("svg",Je({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),qe||(qe=s.createElement("mask",{id:"members_svg__a",fill:"#fff"},s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M17.591 20.292A9.954 9.954 0 0112 22a9.956 9.956 0 01-6-2 9.985 9.985 0 01-4-8C2 6.477 6.477 2 12 2s10 4.477 10 10a9.99 9.99 0 01-4.409 8.292zM12 12.5c1.657 0 3-1.455 3-3.25S13.657 6 12 6 9 7.455 9 9.25s1.343 3.25 3 3.25zm0 7.5a7.974 7.974 0 005.563-2.251 6.002 6.002 0 00-11.126 0A7.973 7.973 0 0012 20z"}))),$e||($e=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M17.591 20.292A9.954 9.954 0 0112 22a9.956 9.956 0 01-6-2 9.985 9.985 0 01-4-8C2 6.477 6.477 2 12 2s10 4.477 10 10a9.99 9.99 0 01-4.409 8.292zM12 12.5c1.657 0 3-1.455 3-3.25S13.657 6 12 6 9 7.455 9 9.25s1.343 3.25 3 3.25zm0 7.5a7.974 7.974 0 005.563-2.251 6.002 6.002 0 00-11.126 0A7.973 7.973 0 0012 20z",fill:"#000"})),Ye||(Ye=s.createElement("path",{d:"M17.591 20.292l-1.12-1.657 1.12 1.657zM6 20.001L4.799 21.6 6 20zm11.563-2.252l1.391 1.437.97-.938-.507-1.25-1.854.75zm-11.126 0l-1.854-.751-.506 1.25.969.938 1.39-1.437zM12 24c2.482 0 4.794-.756 6.71-2.05l-2.239-3.315A7.954 7.954 0 0112 20v4zm-7.201-2.4A11.956 11.956 0 0012 24v-4a7.955 7.955 0 01-4.799-1.598L4.8 21.6zM0 12c0 3.927 1.889 7.414 4.799 9.6L7.2 18.402A7.985 7.985 0 014 12H0zM12 0C5.373 0 0 5.373 0 12h4a8 8 0 018-8V0zm12 12c0-6.627-5.373-12-12-12v4a8 8 0 018 8h4zm-5.29 9.95A11.99 11.99 0 0024 12h-4a7.99 7.99 0 01-3.529 6.635l2.24 3.314zM13 9.25c0 .844-.595 1.25-1 1.25v4c2.91 0 5-2.504 5-5.25h-4zM12 8c.405 0 1 .406 1 1.25h4C17 6.504 14.91 4 12 4v4zm-1 1.25c0-.844.595-1.25 1-1.25V4C9.09 4 7 6.504 7 9.25h4zm1 1.25c-.405 0-1-.406-1-1.25H7c0 2.746 2.09 5.25 5 5.25v-4zm4.172 5.812A5.974 5.974 0 0112 18v4a9.973 9.973 0 006.954-2.814l-2.782-2.874zM12 16a4.002 4.002 0 013.71 2.5l3.707-1.502A8.002 8.002 0 0012 12v4zm-3.71 2.5A4.002 4.002 0 0112 16v-4a8.002 8.002 0 00-7.417 4.998L8.29 18.5zM12 18a5.974 5.974 0 01-4.172-1.688l-2.782 2.874A9.973 9.973 0 0012 22v-4z",fill:"#000",mask:"url(#members_svg__a)"})))}var Xe;function Ze(){return Ze=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Ze.apply(this,arguments)}function et(e){return s.createElement("svg",Ze({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),Xe||(Xe=s.createElement("path",{d:"M8.414 1.432c.178-.576.994-.576 1.172 0l1.585 5.131h5.215c.586 0 .838.745.372 1.1l-4.244 3.243 1.604 5.194c.177.57-.483 1.03-.958.668L9 13.59l-4.16 3.178c-.475.363-1.135-.098-.959-.668l1.606-5.194-4.245-3.242c-.466-.356-.214-1.1.372-1.1H6.83l1.585-5.132z",fill:"#000"})))}var tt=a(690),at=a(154);var nt=e=>{let{isPanelCollapsed:t=!1}=e;const[a,n,i,s]=Object(de.q)(),{[Y.a.Favourites]:r,[Y.a.People]:l}=Object(se.b)("Spaces.enabledMetaSpaces");let d;return a&&n.current&&(d=o.a.createElement(de.n,Z()({},Object(de.k)(n.current.getBoundingClientRect(),de.a.None,16),{wrapperClassName:"mx_QuickSettingsButton_ContextMenuWrapper",onFinished:s,managed:!1,focusLock:!0}),o.a.createElement("h2",null,Object(N.b)("Quick settings")),o.a.createElement(K.a,{onClick:()=>{s(),b.a.dispatch({action:L.a.ViewUserSettings})},kind:"primary_outline"},Object(N.b)("All settings")),v.b.getValue("developerMode")&&o.a.createElement(K.a,{onClick:()=>{s(),z.b.createDialog(tt.a,{roomId:at.b.instance.roomViewStore.getRoomId()},"mx_DevtoolsDialog_wrapper")},kind:"danger_outline"},Object(N.b)("Developer tools")),o.a.createElement("h4",{className:"mx_QuickSettingsButton_pinToSidebarHeading"},o.a.createElement(Ve,{className:"mx_QuickSettingsButton_icon"}),Object(N.b)("Pin to sidebar")),o.a.createElement(Ue.b,{className:"mx_QuickSettingsButton_favouritesCheckbox",checked:!!r,onChange:Object(Le.b)(Y.a.Favourites,"WebQuickSettingsPinToSidebarCheckbox")},o.a.createElement(et,{className:"mx_QuickSettingsButton_icon"}),Object(N.b)("Favourites")),o.a.createElement(Ue.b,{className:"mx_QuickSettingsButton_peopleCheckbox",checked:!!l,onChange:Object(Le.b)(Y.a.People,"WebQuickSettingsPinToSidebarCheckbox")},o.a.createElement(Qe,{className:"mx_QuickSettingsButton_icon"}),Object(N.b)("People")),o.a.createElement(K.a,{className:"mx_QuickSettingsButton_moreOptionsButton",onClick:()=>{s(),b.a.dispatch({action:L.a.ViewUserSettings,initialTabId:Fe.a.Sidebar})}},o.a.createElement(Ge,{className:"mx_QuickSettingsButton_icon"}),Object(N.b)("More options")))),o.a.createElement(o.a.Fragment,null,o.a.createElement(q.a,{className:c()("mx_QuickSettingsButton",{expanded:!t}),onClick:i,title:Object(N.b)("Quick settings"),inputRef:n,forceHide:!t},t?null:Object(N.b)("Settings")),d)},it=a(159),st=a(141),ot=a(132),rt=a(270),lt=a(219),ct=a(399),dt=a(415);var mt,ht,ut,pt,gt=e=>{const t=Object(s.useRef)(null),[a,n]=Object(s.useState)(""),[i,r]=Object(dt.a)(!1);Object(s.useEffect)((()=>{var e;null===(e=t.current)||void 0===e||e.focus()}),[]);const l=()=>{e.onFinished(),z.b.createDialog(rt.a,{})},c=ot.b.get().bug_report_endpoint_url,d=!!c;let m;c&&(m=o.a.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_rateApp"},o.a.createElement("h3",null,Object(N.b)("Comment")),o.a.createElement("p",null,Object(N.b)("Your platform and username will be noted to help us use your feedback as much as we can.")),o.a.createElement(st.a,{id:"feedbackComment",label:Object(N.b)("Feedback"),type:"text",autoComplete:"off",value:a,element:"textarea",onChange:e=>{n(e.target.value)},ref:t}),o.a.createElement(Ue.b,{checked:i,onChange:r},Object(N.b)("You may contact me if you want to follow up or to let me test out upcoming ideas"))));let h=null;return c&&(h=o.a.createElement("p",{className:"mx_FeedbackDialog_section_microcopy"},Object(N.b)("PRO TIP: If you start a bug, please submit <debugLogsLink>debug logs</debugLogsLink> to help us track down the problem.",{},{debugLogsLink:e=>o.a.createElement(K.a,{kind:"link_inline",onClick:l},e)}))),o.a.createElement(it.a,{className:"mx_FeedbackDialog",hasCancelButton:!!d,title:Object(N.b)("Feedback"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_reportBug"},o.a.createElement("h3",null,Object(N.b)("Report a bug")),o.a.createElement("p",null,Object(N.b)("Please view <existingIssuesLink>existing bugs on Github</existingIssuesLink> first. No match? <newIssueLink>Start a new one</newIssueLink>.",{},{existingIssuesLink:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/SchildiChat/schildichat-desktop/issues?q=is%3Aopen+is%3Aissue+sort%3Areactions-%2B1-desc"},e),newIssueLink:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/SchildiChat/schildichat-desktop/issues/new/choose"},e)})),h),m),button:d?Object(N.b)("Send feedback"):Object(N.b)("Go back"),buttonDisabled:d&&!a,onFinished:t=>{if(d&&t){if(c){const t=e.feature?`${e.feature}-feedback`:"feedback";Object(ct.c)(c,t,a,i)}z.b.createDialog(lt.a,{title:Object(N.b)("Feedback sent"),description:Object(N.b)("Thank you!")})}e.onFinished()}})},bt=a(672),vt=a(498),ft=a(273),Et=a(156),yt=a(195),_t=a(336),St=a(267);function wt(){return wt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},wt.apply(this,arguments)}function Ot(e){return s.createElement("svg",wt({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 8 8",role:"presentation","aria-hidden":!0},e),mt||(mt=s.createElement("path",{d:"M6.73 1.395a.333.333 0 00-.527.41l.005.006.021.029a4.121 4.121 0 01.335.587c.187.4.37.95.37 1.573 0 .622-.183 1.173-.37 1.573a4.121 4.121 0 01-.356.616l-.004.006h-.001a.333.333 0 00.527.41L6.48 6.41l.249.194v-.001l.001-.002.003-.003.009-.012a2.258 2.258 0 00.13-.19c.081-.128.189-.312.296-.542A4.43 4.43 0 007.599 4a4.43 4.43 0 00-.43-1.855 4.787 4.787 0 00-.426-.732L6.734 1.4l-.003-.004-.001-.001-.263.204.263-.205z",fill:"currentColor"})),ht||(ht=s.createElement("path",{d:"M5.863 2.595a.333.333 0 00-.527.409l.001.001a.575.575 0 01.044.065c.032.049.074.122.117.214.087.186.169.437.169.716 0 .28-.082.53-.169.716a1.891 1.891 0 01-.16.279l-.002.002a.333.333 0 00.527.408L5.6 5.2l.263.205v-.001l.002-.001.002-.003.005-.007a1.28 1.28 0 00.072-.105c.044-.07.101-.168.158-.29.114-.243.232-.592.232-.998s-.118-.755-.232-.998a2.56 2.56 0 00-.23-.395L5.867 2.6l-.002-.003h-.001v-.001L5.6 2.8l.263-.205zM1.204 6.605a.333.333 0 00.526-.41l-.005-.006a4.121 4.121 0 01-.356-.616A3.764 3.764 0 011 4c0-.622.182-1.173.369-1.573a4.121 4.121 0 01.356-.616l.005-.006a.333.333 0 00-.526-.41l.248.194-.248-.194-.001.001-.001.002L1.2 1.4l-.009.012a2.258 2.258 0 00-.13.19 4.786 4.786 0 00-.295.542A4.43 4.43 0 00.333 4c0 .75.218 1.398.432 1.855a4.787 4.787 0 00.425.732l.01.012.002.004h.001v.001l.264-.204-.263.205z",fill:"currentColor"})),ut||(ut=s.createElement("path",{d:"M2.07 5.405a.333.333 0 00.527-.409l-.001-.001a.575.575 0 01-.044-.065 1.892 1.892 0 01-.117-.214A1.716 1.716 0 012.266 4c0-.28.082-.53.17-.716a1.891 1.891 0 01.16-.279l.001-.002a.333.333 0 00-.527-.408l.263.205-.263-.205v.001l-.001.001-.002.003-.006.007a1.28 1.28 0 00-.072.105 2.562 2.562 0 00-.158.29A2.381 2.381 0 001.6 4c0 .406.118.755.231.998a2.56 2.56 0 00.23.395l.006.007.002.003v.001l.264-.204-.263.205z",fill:"currentColor"})),pt||(pt=s.createElement("circle",{cx:4,cy:4,r:.667,fill:"currentColor"})))}var Ct=a(197),xt=a(817);class jt extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"dispatcherRef",void 0),i()(this,"themeInUseWatcherRef",void 0),i()(this,"dndWatcherRef",void 0),i()(this,"buttonRef",Object(s.createRef)()),i()(this,"onCurrentVoiceBroadcastRecordingChanged",(e=>{this.setState({showLiveAvatarAddon:null!==e})})),i()(this,"onProfileUpdate",(async()=>{this.forceUpdate()})),i()(this,"onSelectedSpaceUpdate",(async()=>{this.setState({selectedSpace:$.a.instance.activeSpaceRoom})})),i()(this,"onThemeInUseChanged",(()=>{this.setState({themeInUse:v.b.getValue("theme_in_use")})})),i()(this,"onAction",(e=>{if(e.action===L.a.ToggleUserMenu)this.state.contextMenuPosition?this.setState({contextMenuPosition:null}):this.buttonRef.current&&this.buttonRef.current.click()})),i()(this,"onOpenMenuClick",(e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:e.currentTarget.getBoundingClientRect()})})),i()(this,"onContextMenu",(e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,width:20,height:0}})})),i()(this,"onCloseMenu",(()=>{this.setState({contextMenuPosition:null})})),i()(this,"onSwitchThemeClick",(e=>{e.preventDefault(),e.stopPropagation();const t=this.state.themeInUse===_t.a.Dark?_t.a.Light:_t.a.Dark;v.b.setValue("theme_in_use",null,f.a.DEVICE,t),re.b.trackInteraction("WebUserMenuThemeToggleButton",e)})),i()(this,"onSettingsOpen",((e,t)=>{e.preventDefault(),e.stopPropagation();const a={action:L.a.ViewUserSettings,initialTabId:t};b.a.dispatch(a),this.setState({contextMenuPosition:null})})),i()(this,"onProvideFeedback",(e=>{e.preventDefault(),e.stopPropagation(),z.b.createDialog(gt),this.setState({contextMenuPosition:null})})),i()(this,"onSignOutClick",(async e=>{var t;e.preventDefault(),e.stopPropagation();const a=oe.a.get();a&&a.isCryptoEnabled()&&null!==(t=await a.exportRoomKeys())&&void 0!==t&&t.length?z.b.createDialog(bt.a):b.a.dispatch({action:"logout"}),this.setState({contextMenuPosition:null})})),i()(this,"onSignInClick",(()=>{b.a.dispatch({action:"start_login"}),this.setState({contextMenuPosition:null})})),i()(this,"onRegisterClick",(()=>{b.a.dispatch({action:"start_registration"}),this.setState({contextMenuPosition:null})})),i()(this,"onHomeClick",(e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:L.a.ViewHomePage}),this.setState({contextMenuPosition:null})})),i()(this,"renderContextMenu",(()=>{if(!this.state.contextMenuPosition)return null;let e,t,n;oe.a.get().isGuest()&&(e=o.a.createElement("div",{className:"mx_UserMenu_contextMenu_header mx_UserMenu_contextMenu_guestPrompts"},Object(N.b)("Got an account? <a>Sign in</a>",{},{a:e=>o.a.createElement(K.a,{kind:"link_inline",onClick:this.onSignInClick},e)}),v.b.getValue(le.b.Registration)?Object(N.b)("New here? <a>Create an account</a>",{},{a:e=>o.a.createElement(K.a,{kind:"link_inline",onClick:this.onRegisterClick},e)}):null)),this.hasHomePage&&(t=o.a.createElement(he.b,{iconClassName:"mx_UserMenu_iconHome",label:Object(N.b)("Home"),onClick:this.onHomeClick})),Object(xt.a)()&&(n=o.a.createElement(he.b,{iconClassName:"mx_UserMenu_iconMessage",label:Object(N.b)("Feedback"),onClick:this.onProvideFeedback}));let i=o.a.createElement(he.c,null,t,o.a.createElement(he.b,{iconClassName:"mx_UserMenu_iconBell",label:Object(N.b)("Notifications"),onClick:e=>this.onSettingsOpen(e,Fe.a.Notifications)}),o.a.createElement(he.b,{iconClassName:"mx_UserMenu_iconLock",label:Object(N.b)("Security & Privacy"),onClick:e=>this.onSettingsOpen(e,Fe.a.Security)}),o.a.createElement(he.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(N.b)("All settings"),onClick:e=>this.onSettingsOpen(e)}),n,o.a.createElement(he.b,{className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_UserMenu_iconSignOut",label:Object(N.b)("Sign out"),onClick:this.onSignOutClick}));oe.a.get().isGuest()&&(i=o.a.createElement(he.c,null,t,o.a.createElement(he.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(N.b)("Settings"),onClick:e=>this.onSettingsOpen(e)}),n));const s=this.props.isPanelCollapsed?{left:(r=this.state.contextMenuPosition).width+r.left+8,top:r.top,chevronFace:de.a.None}:(e=>({left:e.left,top:e.top+e.height,chevronFace:de.a.None}))(this.state.contextMenuPosition);var r;return o.a.createElement(he.e,Z()({},s,{onFinished:this.onCloseMenu,className:"mx_UserMenu_contextMenu"}),o.a.createElement("div",{className:"mx_UserMenu_contextMenu_header"},o.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},o.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},ft.a.instance.displayName),o.a.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},St.a.getDisplayUserIdentifier(oe.a.get().getSafeUserId(),{withDisplayName:!0}))),o.a.createElement(je.b,{className:"mx_UserMenu_contextMenu_themeButton",onClick:this.onSwitchThemeClick,title:this.state.themeInUse===_t.a.Dark?Object(N.b)("Switch to light mode"):Object(N.b)("Switch to dark mode")},o.a.createElement("img",{src:a(1661).default,alt:Object(N.b)("Switch theme"),width:16}))),e,i)})),this.context=t,this.state={contextMenuPosition:null,themeInUse:v.b.getValue("theme_in_use"),selectedSpace:$.a.instance.activeSpaceRoom,showLiveAvatarAddon:this.context.voiceBroadcastRecordingsStore.hasCurrent()},ft.a.instance.on(Et.b,this.onProfileUpdate),$.a.instance.on(Y.d,this.onSelectedSpaceUpdate)}get hasHomePage(){return!!Object(vt.a)(ot.b.get())}componentDidMount(){this.context.voiceBroadcastRecordingsStore.on(Ct.y.CurrentChanged,this.onCurrentVoiceBroadcastRecordingChanged),this.dispatcherRef=b.a.register(this.onAction),this.themeInUseWatcherRef=v.b.watchSetting("theme_in_use",null,this.onThemeInUseChanged)}componentWillUnmount(){this.themeInUseWatcherRef&&v.b.unwatchSetting(this.themeInUseWatcherRef),this.dndWatcherRef&&v.b.unwatchSetting(this.dndWatcherRef),this.dispatcherRef&&b.a.unregister(this.dispatcherRef),ft.a.instance.off(Et.b,this.onProfileUpdate),$.a.instance.off(Y.d,this.onSelectedSpaceUpdate),this.context.voiceBroadcastRecordingsStore.off(Ct.y.CurrentChanged,this.onCurrentVoiceBroadcastRecordingChanged)}render(){const e=oe.a.get().getSafeUserId(),t=ft.a.instance.displayName||e,a=ft.a.instance.getHttpAvatarUrl(32);let n;this.props.isPanelCollapsed||(n=o.a.createElement("div",{className:"mx_UserMenu_name"},t));const i=this.state.showLiveAvatarAddon?o.a.createElement("div",{className:"mx_UserMenu_userAvatarLive","data-testid":"user-menu-live-vb"},o.a.createElement(Ot,{className:"mx_Icon_8"})):null;return o.a.createElement("div",{className:"mx_UserMenu"},o.a.createElement(de.b,{onClick:this.onOpenMenuClick,inputRef:this.buttonRef,label:Object(N.b)("User menu"),isExpanded:!!this.state.contextMenuPosition,onContextMenu:this.onContextMenu},o.a.createElement("div",{className:"mx_UserMenu_userAvatar"},o.a.createElement(yt.a,{idName:e,name:t,url:a,width:32,height:32,resizeMethod:"crop",className:"mx_UserMenu_userAvatar_BaseAvatar"}),i),n,this.renderContextMenu()),this.props.children)}}i()(jt,"contextType",at.a);var kt=a(221);const Rt=["children","trackHorizontalOverflow","verticalScrollsHorizontally"];class It extends o.a.Component{constructor(e){super(e),i()(this,"autoHideScrollbar",Object(s.createRef)()),i()(this,"scrollElement",void 0),i()(this,"likelyTrackpadUser",null),i()(this,"checkAgainForTrackpad",0),i()(this,"collectScroller",(e=>{var t,a;null===(t=(a=this.props).wrappedRef)||void 0===t||t.call(a,e),e&&!this.scrollElement&&(this.scrollElement=e,this.scrollElement.addEventListener("scroll",this.checkOverflow,{passive:!0}),this.checkOverflow())})),i()(this,"checkOverflow",(()=>{const e=this.scrollElement.scrollTop>0,t=this.scrollElement.scrollHeight>this.scrollElement.scrollTop+this.scrollElement.clientHeight,a=this.scrollElement.scrollLeft>0,n=this.scrollElement.scrollWidth>this.scrollElement.scrollLeft+this.scrollElement.clientWidth;e?this.scrollElement.classList.add("mx_IndicatorScrollbar_topOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_topOverflow"),t?this.scrollElement.classList.add("mx_IndicatorScrollbar_bottomOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_bottomOverflow"),a?this.scrollElement.classList.add("mx_IndicatorScrollbar_leftOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_leftOverflow"),n?this.scrollElement.classList.add("mx_IndicatorScrollbar_rightOverflow"):this.scrollElement.classList.remove("mx_IndicatorScrollbar_rightOverflow"),this.props.trackHorizontalOverflow&&this.setState({leftIndicatorOffset:a?`${this.scrollElement.scrollLeft}px`:"0",rightIndicatorOffset:n?`-${this.scrollElement.scrollLeft}px`:"0"})})),i()(this,"onMouseWheel",(e=>{if(this.props.verticalScrollsHorizontally&&this.scrollElement){const t=0,a=1,n=(new Date).getTime();if(Math.abs(e.deltaX)>0?(this.likelyTrackpadUser=!0,this.checkAgainForTrackpad=n+6e4):this.likelyTrackpadUser&&n>=this.checkAgainForTrackpad&&(this.likelyTrackpadUser=!1),this.likelyTrackpadUser)return;if(Math.abs(e.deltaX)<=t){const t=e.deltaY<0?-50:50,n=Math.abs(e.deltaY)<25?e.deltaY+t:e.deltaY;this.scrollElement.scrollLeft+=n*a}}})),this.state={leftIndicatorOffset:"0",rightIndicatorOffset:"0"}}componentDidUpdate(e){o.a.Children.count(e.children)!==o.a.Children.count(this.props.children)&&this.checkOverflow()}componentDidMount(){this.checkOverflow(),Q.b.instance.on(Q.a.Resize,this.checkOverflow)}componentWillUnmount(){var e;null===(e=this.scrollElement)||void 0===e||e.removeEventListener("scroll",this.checkOverflow),Q.b.instance.off(Q.a.Resize,this.checkOverflow)}render(){const e=this.props,{children:t,trackHorizontalOverflow:a,verticalScrollsHorizontally:n}=e,i=ve()(e,Rt),s={left:this.state.leftIndicatorOffset},r={right:this.state.rightIndicatorOffset},l=a?o.a.createElement("div",{className:"mx_IndicatorScrollbar_leftOverflowIndicator",style:s}):null,c=a?o.a.createElement("div",{className:"mx_IndicatorScrollbar_rightOverflowIndicator",style:r}):null;return o.a.createElement(kt.a,Z()({},i,{ref:this.autoHideScrollbar,wrappedRef:this.collectScroller,onWheel:this.onMouseWheel}),l,t,c)}}const Tt=["onFinished","hideHeader"],Nt=["selected","isPanelCollapsed"],Pt=["children","isPanelCollapsed","setPanelCollapsed","isDraggingOver","innerRef"],Dt=e=>{let{onFinished:t,hideHeader:a}=e,n=ve()(e,Tt);const i=Object(se.b)("Spaces.allRoomsInHome");return o.a.createElement(he.e,Z()({},n,{onFinished:t,className:"mx_SpacePanel_contextMenu",compact:!0}),!a&&o.a.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},Object(N.b)("Home")),o.a.createElement(he.c,{first:!0},o.a.createElement(he.a,{iconClassName:"mx_SpacePanel_noIcon",label:Object(N.b)("Show all rooms"),active:i,onClick:()=>{v.b.setValue("Spaces.allRoomsInHome",null,f.a.ACCOUNT,!i)}})))},Mt=e=>{let{selected:t,isPanelCollapsed:a}=e,n=ve()(e,Nt);return o.a.createElement("li",{className:c()("mx_SpaceItem",{collapsed:a}),role:"treeitem","aria-selected":t},o.a.createElement(Te,Z()({},n,{selected:t,isNarrow:a})))},At=()=>$.a.instance.allRoomsInHome?Ae.a.instance.globalState:$.a.instance.getNotificationState(Y.a.Home),Ut=e=>{let{isPanelCollapsed:t,setPanelCollapsed:a}=e;const[n,i,r,l]=Object(de.q)();let d;Object(s.useEffect)((()=>{!t&&n&&l()}),[t]),n&&(d=o.a.createElement(Ee.c,{onFinished:l}));const m=n?l:()=>{t||a(!0),r()};return o.a.createElement("li",{className:c()("mx_SpaceItem mx_SpaceItem_new",{collapsed:t}),role:"treeitem","aria-selected":!1},o.a.createElement(Te,{"data-testid":"create-space-button",className:c()("mx_SpaceButton_new",{mx_SpaceButton_newCancel:n}),label:n?Object(N.b)("Cancel"):Object(N.b)("Create a space"),onClick:m,isNarrow:t,ref:i}),d)},Lt={[Y.a.Home]:e=>{let{selected:t,isPanelCollapsed:a}=e;const n=Object(ie.b)($.a.instance,Y.b,(()=>$.a.instance.allRoomsInHome)),[i,r]=Object(s.useState)(At()),l=Object(s.useCallback)((()=>{r(At())}),[]);return Object(s.useEffect)(l,[l,n]),Object(ie.a)(Ae.a.instance,Ae.b,l),o.a.createElement(Mt,{spaceKey:Y.a.Home,className:"mx_SpaceButton_home",selected:t,isPanelCollapsed:a,label:Object(Y.g)(Y.a.Home,n),notificationState:i,ContextMenuComponent:Dt,contextMenuTooltip:Object(N.b)("Options")})},[Y.a.Favourites]:e=>{let{selected:t,isPanelCollapsed:a}=e;return o.a.createElement(Mt,{spaceKey:Y.a.Favourites,className:"mx_SpaceButton_favourites",selected:t,isPanelCollapsed:a,label:Object(Y.g)(Y.a.Favourites),notificationState:$.a.instance.getNotificationState(Y.a.Favourites)})},[Y.a.People]:e=>{let{selected:t,isPanelCollapsed:a}=e;return o.a.createElement(Mt,{spaceKey:Y.a.People,className:"mx_SpaceButton_people",selected:t,isPanelCollapsed:a,label:Object(Y.g)(Y.a.People),notificationState:$.a.instance.getNotificationState(Y.a.People)})},[Y.a.Orphans]:e=>{let{selected:t,isPanelCollapsed:a}=e;return o.a.createElement(Mt,{spaceKey:Y.a.Orphans,className:"mx_SpaceButton_orphans",selected:t,isPanelCollapsed:a,label:Object(Y.g)(Y.a.Orphans),notificationState:$.a.instance.getNotificationState(Y.a.Orphans)})}},Ft=o.a.memo((e=>{let{children:t,isPanelCollapsed:a,setPanelCollapsed:n,isDraggingOver:i,innerRef:s}=e,r=ve()(e,Pt);const[l,c,d,m]=(()=>{const e=Object(ie.b)($.a.instance,Y.c,(()=>$.a.instance.invitedSpaces)),[t,a]=Object(ie.b)($.a.instance,Y.f,(()=>[$.a.instance.enabledMetaSpaces,$.a.instance.spacePanelSpaces]));return[e,t,a,Object(ie.b)($.a.instance,Y.d,(()=>$.a.instance.activeSpace))]})(),h=m?[m]:[],u=c.map((e=>{const t=Lt[e];return o.a.createElement(t,{key:e,selected:m===e,isPanelCollapsed:a})}));return o.a.createElement(It,Z()({},r,{wrappedRef:s,className:"mx_SpaceTreeLevel",style:i?{pointerEvents:"none"}:void 0,element:"ul",role:"tree","aria-label":Object(N.b)("Spaces")}),u,l.map((e=>o.a.createElement(Ne,{key:e.roomId,space:e,activeSpaces:h,isPanelCollapsed:a,onExpand:()=>n(!1)}))),d.map(((e,t)=>o.a.createElement(fe.Draggable,{key:e.roomId,draggableId:e.roomId,index:t},((t,i)=>o.a.createElement(Ne,Z()({},t.draggableProps,{dragHandleProps:t.dragHandleProps,key:e.roomId,innerRef:t.innerRef,className:i.isDragging?"mx_SpaceItem_dragging":void 0,space:e,activeSpaces:h,isPanelCollapsed:a,onExpand:()=>n(!1)})))))),t,Object(ae.a)(le.a.CreateSpaces)&&o.a.createElement(Ut,{isPanelCollapsed:a,setPanelCollapsed:n}))}));var Bt=()=>{const[e,t]=Object(s.useState)(!0),a=Object(s.useRef)(null);return Object(s.useLayoutEffect)((()=>(a.current&&Q.b.instance.trackElementDimensions("SpacePanel",a.current),()=>Q.b.instance.stopTrackingElementDimensions("SpacePanel"))),[]),Object(ne.a)(b.a,(a=>{a.action===L.a.ToggleSpacePanel&&t(!e)})),o.a.createElement(fe.DragDropContext,{onDragEnd:e=>{e.destination&&$.a.instance.moveRootSpace(e.source.index,e.destination.index)}},o.a.createElement(je.d,{handleHomeEnd:!0,handleUpDown:!0},(n=>{let{onKeyDownHandler:i}=n;return o.a.createElement("div",{className:c()("mx_SpacePanel",{collapsed:e}),onKeyDown:i,ref:a},o.a.createElement(jt,{isPanelCollapsed:e},o.a.createElement(q.a,{className:c()("mx_SpacePanel_toggleCollapse",{expanded:!e}),onClick:()=>t(!e),title:e?Object(N.b)("Expand"):Object(N.b)("Collapse"),tooltip:o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Tooltip_title"},e?Object(N.b)("Expand"):Object(N.b)("Collapse")),o.a.createElement("div",{className:"mx_Tooltip_sub"},h.a?"⌘ + ⇧ + D":Object(N.b)(W.a[h.b.CONTROL])+" + "+Object(N.b)(W.a[h.b.SHIFT])+" + D"))})),o.a.createElement(fe.Droppable,{droppableId:"top-level-spaces"},((a,n)=>o.a.createElement(Ft,Z()({},a.droppableProps,{isPanelCollapsed:e,setPanelCollapsed:t,isDraggingOver:n.isDraggingOver,innerRef:a.innerRef}),a.placeholder))),o.a.createElement(nt,{isPanelCollapsed:e}))})))};const Vt=e=>({left:e.left+window.scrollX,top:e.bottom+window.scrollY+12,chevronFace:de.a.None});var Wt=function(e){return e[e.JoinRoom=0]="JoinRoom",e[e.BulkRedact=1]="BulkRedact",e}(Wt||{});var zt=e=>{var t;let{onVisibilityChange:a}=e;const n=Object(s.useContext)(R.a),[i,l,c,d]=Object(de.q)(),[m,h,u,p]=Object(de.q)(),[g,v]=Object(ie.b)($.a.instance,Y.d,(()=>[$.a.instance.activeSpace,$.a.instance.activeSpaceRoom])),f=Object(ie.b)($.a.instance,Y.b,(()=>$.a.instance.allRoomsInHome)),E=Object(se.a)("feature_video_rooms"),y=Object(se.a)("feature_element_call_video_rooms"),_=(()=>{const e=Object(s.useContext)(R.a),[t,a]=Object(s.useState)(new Map),n=(e,n)=>{const i=new Set(t.get(e));i.add(n),a(new Map(t).set(e,i))},i=(e,n)=>{const i=new Set(t.get(e));i.delete(n)&&a(new Map(t).set(e,i))};return Object(ne.a)(b.a,(e=>{switch(e.action){case L.a.JoinRoom:n(Wt.JoinRoom,e.roomId);break;case L.a.JoinRoomReady:case L.a.JoinRoomError:i(Wt.JoinRoom,e.roomId);break;case L.a.BulkRedactStart:n(Wt.BulkRedact,e.roomId);break;case L.a.BulkRedactEnd:i(Wt.BulkRedact,e.roomId)}})),Object(ie.c)(e,r.b.Room,(e=>i(Wt.JoinRoom,e.roomId))),t})(),S=v||g===Y.a.Home;Object(s.useEffect)((()=>{i&&!S&&d()}),[d,S,i]);const w=Object(ie.d)(null!=v?v:void 0,te.d.Name,(()=>null==v?void 0:v.name));Object(s.useEffect)((()=>{null==a||a()}),[a]);const O=Object(ae.a)(le.a.ExploreRooms),C=Object(ae.a)(le.a.CreateRooms),x=Object(ae.a)(le.a.CreateSpaces),j=null==v||null===(t=v.currentState)||void 0===t?void 0:t.maySendStateEvent(ee.b.SpaceChild,n.getUserId()),k=j&&C,I=j&&x,T=C||O||x||v;let P,D;if(i&&l.current){let e;e=v?ue.a:Dt,P=o.a.createElement(e,Z()({},Vt(l.current.getBoundingClientRect()),{space:v,onFinished:d,hideHeader:!0}))}else if(m&&v){let e,t;Object(ce.c)(v)&&(e=o.a.createElement(he.b,{label:Object(N.b)("Invite"),iconClassName:"mx_RoomListHeader_iconInvite",onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(ce.i)(v),p()}})),null!=v&&v.currentState.maySendStateEvent(ee.b.RoomAvatar,n.getUserId())&&(t=o.a.createElement(o.a.Fragment,null,o.a.createElement(he.b,{iconClassName:"mx_RoomListHeader_iconNewRoom",label:Object(N.b)("New room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(ce.g)(v),re.b.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),p()}}),E&&o.a.createElement(he.b,{iconClassName:"mx_RoomListHeader_iconNewVideoRoom",label:Object(N.b)("New video room"),onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(ce.g)(v,y?ee.j.UnstableCall:ee.j.ElementVideo),p()}},o.a.createElement(me.a,null)))),P=o.a.createElement(he.e,Z()({},Vt(h.current.getBoundingClientRect()),{onFinished:p,compact:!0}),o.a.createElement(he.c,{first:!0},e,t,o.a.createElement(he.b,{label:Object(N.b)("Add existing room"),iconClassName:"mx_RoomListHeader_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(ce.e)(v),p()},disabled:!k,tooltip:k?void 0:Object(N.b)("You do not have permissions to add rooms to this space")}),x&&o.a.createElement(he.b,{label:Object(N.b)("Add space"),iconClassName:"mx_RoomListHeader_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(ce.h)(v),p()},disabled:!I,tooltip:I?void 0:Object(N.b)("You do not have permissions to add spaces to this space")},o.a.createElement(me.a,null))))}else if(m){let e,t;C&&(e=o.a.createElement(o.a.Fragment,null,o.a.createElement(he.b,{label:Object(N.b)("Start new chat"),iconClassName:"mx_RoomListHeader_iconStartChat",onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"view_create_chat"}),re.b.trackInteraction("WebRoomListHeaderPlusMenuCreateChatItem",e),p()}}),o.a.createElement(he.b,{label:Object(N.b)("New room"),iconClassName:"mx_RoomListHeader_iconNewRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"view_create_room"}),re.b.trackInteraction("WebRoomListHeaderPlusMenuCreateRoomItem",e),p()}}),E&&o.a.createElement(he.b,{label:Object(N.b)("New video room"),iconClassName:"mx_RoomListHeader_iconNewVideoRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"view_create_room",type:y?ee.j.UnstableCall:ee.j.ElementVideo}),p()}},o.a.createElement(me.a,null)))),O&&(t=o.a.createElement(he.b,{label:Object(N.b)("Join public room"),iconClassName:"mx_RoomListHeader_iconExplore",onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:L.a.ViewRoomDirectory}),re.b.trackInteraction("WebRoomListHeaderPlusMenuExploreRoomsItem",e),p()}})),P=o.a.createElement(he.e,Z()({},Vt(h.current.getBoundingClientRect()),{onFinished:p,compact:!0}),o.a.createElement(he.c,{first:!0},e,t))}D=v&&w?w:Object(Y.g)(g,f);const M=[..._.entries()].filter((e=>{let[t,a]=e;return a.size>0})).map((e=>{let[t,a]=e;switch(t){case Wt.JoinRoom:return Object(N.b)("Currently joining %(count)s rooms",{count:a.size});case Wt.BulkRedact:return Object(N.b)("Currently removing messages in %(count)s rooms",{count:a.size})}})).join("\n");let A,U=o.a.createElement("div",{className:"mx_RoomListHeader_contextLessTitle"},D);if(S&&(U=o.a.createElement(de.c,{inputRef:l,onClick:c,isExpanded:i,className:"mx_RoomListHeader_contextMenuButton",title:v?Object(N.b)("%(spaceName)s menu",{spaceName:null!=w?w:v.name}):Object(N.b)("Home options")},D)),v){const e=oe.a.get().getUserId(),t=v.currentState.maySendStateEvent(ee.b.SpaceChild,e);A=o.a.createElement(q.a,{onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"view_room",room_id:null==v?void 0:v.roomId})},className:"mx_RoomListHeader_plusButton sc_RoomListHeader_exploreButton",title:t?Object(N.b)("Manage & explore rooms"):Object(N.b)("Explore rooms")})}return o.a.createElement("div",{className:"mx_RoomListHeader"},U,M?o.a.createElement(ge.a,{label:M},o.a.createElement(pe.a,null)):null,A,T&&o.a.createElement(de.c,{inputRef:h,onClick:u,isExpanded:m,className:"mx_RoomListHeader_plusButton",title:Object(N.b)("Add")}),P)},Ht=a(418),Kt=a(699),Gt=a(187),qt=a.n(Gt);function $t(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Yt(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?$t(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):$t(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const Jt="mx_InteractiveTooltip_Container";function Qt(){let e=document.getElementById(Jt);return e||(e=document.createElement("div"),e.id=Jt,document.body.appendChild(e)),e}function Xt(e,t,a){const{top:n,right:i,bottom:s,left:o}=a;return e>=o&&e<=i&&t>=n&&t<=s}function Zt(e){const{top:t,right:a,bottom:n,left:i}=e;return(n-t)/(a-i)}function ea(e,t,a){const{bottom:n,left:i}=a,s=-1*Zt(a);return Xt(e,t,a)&&t<=n+s*(e-i)}function ta(e,t,a){const{bottom:n,left:i}=a,s=-1*Zt(a);return Xt(e,t,a)&&t>=n+s*(e-i)}function aa(e,t,a){const{top:n,left:i}=a,s=1*Zt(a);return Xt(e,t,a)&&t<=n+s*(e-i)}function na(e,t,a){const{top:n,left:i}=a,s=1*Zt(a);return Xt(e,t,a)&&t>=n+s*(e-i)}let ia=function(e){return e[e.Top=0]="Top",e[e.Left=1]="Left",e[e.Bottom=2]="Bottom",e[e.Right=3]="Right",e}({});class sa extends o.a.Component{constructor(e){super(e),i()(this,"target",void 0),i()(this,"collectContentRect",(e=>{e&&this.setState({contentRect:e.getBoundingClientRect()})})),i()(this,"collectTarget",(e=>{this.target=e})),i()(this,"onMouseMove",(e=>{const{clientX:t,clientY:a}=e,{contentRect:n}=this.state;if(!n)return;const i=this.target.getBoundingClientRect();let s;s=this.isOnTheSide?this.onLeftOfTarget()?ia.Left:ia.Right:this.aboveTarget()?ia.Top:ia.Bottom,function(e,t,a,n,i){const s=50;if(Xt(e,t,n))return!0;switch(a){case ia.Left:{const a={top:i.top-s,right:i.right,bottom:i.bottom+s,left:i.left-s},o={top:i.top-s,right:n.right,bottom:n.top,left:i.right},r={top:n.top,right:n.left,bottom:n.bottom,left:i.right},l={top:n.bottom,right:n.right,bottom:i.bottom+s,left:i.right};if(Xt(e,t,a)||na(e,t,o)||Xt(e,t,r)||ea(e,t,l))return!0;break}case ia.Right:{const a={top:i.top-s,right:i.right+s,bottom:i.bottom+s,left:i.left},o={top:i.top-s,right:i.left,bottom:n.top,left:n.left},r={top:n.top,right:i.left,bottom:n.bottom,left:n.right},l={top:n.bottom,right:i.left,bottom:i.bottom+s,left:n.left};if(Xt(e,t,a)||ta(e,t,o)||Xt(e,t,r)||aa(e,t,l))return!0;break}case ia.Top:{const a={top:i.top-s,right:i.right+s,bottom:i.bottom,left:i.left-s},o={top:i.bottom,right:n.left,bottom:n.bottom,left:i.left-s},r={top:i.bottom,right:n.right,bottom:n.top,left:n.left},l={top:i.bottom,right:i.right+s,bottom:n.bottom,left:n.right};if(Xt(e,t,a)||aa(e,t,o)||Xt(e,t,r)||ea(e,t,l))return!0;break}case ia.Bottom:{const a={top:i.top,right:i.right+s,bottom:i.bottom+s,left:i.left-s},o={top:n.top,right:n.left,bottom:i.top,left:i.left-s},r={top:n.bottom,right:n.right,bottom:i.top,left:n.left},l={top:n.top,right:i.right+s,bottom:i.top,left:n.right};if(Xt(e,t,a)||ta(e,t,o)||Xt(e,t,r)||na(e,t,l))return!0;break}}return!1}(t,a,s,i,n)||this.hideTooltip()})),i()(this,"onTargetMouseOver",(()=>{this.showTooltip()})),this.state={visible:!1}}componentDidUpdate(){this.renderTooltip()}componentWillUnmount(){document.removeEventListener("mousemove",this.onMouseMove)}onLeftOfTarget(){const{contentRect:e}=this.state,t=this.target.getBoundingClientRect();if(this.props.direction===ia.Left){const a=t.left+window.scrollX;return!e||a-e.width>20}{const a=t.right+window.scrollX,n=Q.b.instance.windowWidth-a;return!!e&&n-e.width<20}}aboveTarget(){const{contentRect:e}=this.state,t=this.target.getBoundingClientRect();if(this.props.direction===ia.Top){const a=t.top+window.scrollY;return!e||a-e.height>20}{const a=t.bottom+window.scrollY,n=Q.b.instance.windowHeight-a;return!!e&&n-e.height<20}}get isOnTheSide(){return this.props.direction===ia.Left||this.props.direction===ia.Right}showTooltip(){var e,t;this.target&&(this.setState({visible:!0}),null===(e=(t=this.props).onVisibilityChange)||void 0===e||e.call(t,!0),document.addEventListener("mousemove",this.onMouseMove))}hideTooltip(){var e,t;this.setState({visible:!1}),null===(e=(t=this.props).onVisibilityChange)||void 0===e||e.call(t,!1),document.removeEventListener("mousemove",this.onMouseMove)}renderTooltip(){const{contentRect:e,visible:t}=this.state;if(!t)return qt.a.unmountComponentAtNode(Qt()),null;const a=this.target.getBoundingClientRect(),n=a.left+window.scrollX,i=a.right+window.scrollX,s=a.bottom+window.scrollY,r=a.top+window.scrollY,l={};let d=null;this.isOnTheSide?(this.onLeftOfTarget()?(l.left=n,d=de.a.Right):(l.left=i,d=de.a.Left),l.top=r):(this.aboveTarget()?(l.bottom=Q.b.instance.windowHeight-r,d=de.a.Bottom):(l.top=s,d=de.a.Top),l.left=n+a.width/2);const m=o.a.createElement("div",{className:"mx_InteractiveTooltip_chevron_"+d}),h=c()("mx_InteractiveTooltip",{mx_InteractiveTooltip_withChevron_top:d===de.a.Top,mx_InteractiveTooltip_withChevron_left:d===de.a.Left,mx_InteractiveTooltip_withChevron_right:d===de.a.Right,mx_InteractiveTooltip_withChevron_bottom:d===de.a.Bottom}),u={};e&&!this.isOnTheSide&&(u.left=`-${e.width/2}px`);const p=o.a.createElement("div",{className:"mx_InteractiveTooltip_wrapper",style:Yt({},l)},o.a.createElement("div",{className:h,style:u,ref:this.collectContentRect},m,this.props.content));qt.a.render(p,Qt())}render(){return this.props.children({ref:this.collectTarget,onMouseOver:this.onTargetMouseOver})}}i()(sa,"defaultProps",{side:ia.Top});var oa=a(328);var ra=()=>{const e=Object(s.useRef)(null),t=Object(ie.b)(Ht.a.instance,Et.b,(()=>Ht.a.instance.rooms)),a=o.a.createElement("div",{className:"mx_RecentlyViewedButton_ContextMenu"},o.a.createElement("h4",null,Object(N.b)("Recently viewed")),o.a.createElement("div",null,t.map((t=>o.a.createElement(de.d,{key:t.roomId,onClick:a=>{var n;b.a.dispatch({action:L.a.ViewRoom,room_id:t.roomId,metricsTrigger:"WebVerticalBreadcrumbs",metricsViaKeyboard:"click"!==a.type}),null===(n=e.current)||void 0===n||n.hideTooltip()}},t.isSpaceRoom()?o.a.createElement(ye.a,{room:t,width:24,height:24}):o.a.createElement(oa.a,{room:t,avatarSize:24,tooltipProps:{tabIndex:-1}}),o.a.createElement("span",{className:"mx_RecentlyViewedButton_entry_label"},o.a.createElement("div",null,t.name),o.a.createElement(Kt.a,{className:"mx_RecentlyViewedButton_entry_spaces",room:t})))))));return o.a.createElement(sa,{content:a,direction:ia.Right,ref:e},(e=>{let{ref:t,onMouseOver:a}=e;return o.a.createElement("span",{className:"mx_LeftPanel_recentsButton",title:Object(N.b)("Recently viewed"),ref:t,onMouseOver:a})}))},la=a(229),ca=a(912),da=a(405);const ma=e=>{let{room:t,onClick:a}=e;const[n,i,s]=Object(je.i)();return o.a.createElement(q.a,{className:"mx_RoomBreadcrumbs_crumb",onClick:a,"aria-label":Object(N.b)("Room %(name)s",{name:t.name}),title:t.name,tooltipClassName:"mx_RoomBreadcrumbs_Tooltip",onFocus:n,inputRef:s,tabIndex:i?0:-1},o.a.createElement(oa.a,{room:t,avatarSize:32,displayBadge:!0,forceCount:!0,tooltipProps:{tabIndex:i?0:-1}}))};class ha extends o.a.PureComponent{constructor(e){super(e),i()(this,"isMounted",!0),i()(this,"onBreadcrumbsUpdate",(()=>{this.isMounted&&(this.setState({doAnimation:!1,skipFirst:!0}),window.setTimeout((()=>this.setState({doAnimation:!0,skipFirst:!1})),0))})),i()(this,"viewRoom",(function(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];b.a.dispatch({action:L.a.ViewRoom,room_id:e.roomId,metricsTrigger:"WebHorizontalBreadcrumbs",metricsViaKeyboard:a})})),this.state={doAnimation:!0,skipFirst:!1},Ht.a.instance.on(Et.b,this.onBreadcrumbsUpdate)}componentWillUnmount(){this.isMounted=!1,Ht.a.instance.off(Et.b,this.onBreadcrumbsUpdate)}render(){const e=Ht.a.instance.rooms.map(((e,t)=>o.a.createElement(ma,{key:e.roomId,room:e,onClick:a=>this.viewRoom(e,t,"click"!==a.type)})));return e.length>0?o.a.createElement(ca.CSSTransition,{appear:!0,in:this.state.doAnimation,timeout:640,classNames:"mx_RoomBreadcrumbs"},o.a.createElement(da.a,{className:"mx_RoomBreadcrumbs","aria-label":Object(N.b)("Recently visited rooms")},e.slice(this.state.skipFirst?1:0))):o.a.createElement("div",{className:"mx_RoomBreadcrumbs"},o.a.createElement("div",{className:"mx_RoomBreadcrumbs_placeholder"},Object(N.b)("No recently visited rooms")))}}var ua=a(177),pa=a(509);function ga(e){let{selected:t,minimized:a}=e;const n=Object(se.b)("FTUE.useCaseSelection");return Object(se.b)("FTUE.userOnboardingButton")&&!a&&Object(pa.b)(n)?o.a.createElement(ba,{selected:t,minimized:a}):o.a.createElement(o.a.Fragment,null)}function ba(e){let{selected:t,minimized:a}=e;const n=Object(s.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),re.b.trackInteraction("WebRoomListUserOnboardingIgnoreButton",e),v.b.setValue("FTUE.userOnboardingButton",null,f.a.ACCOUNT,!1)}),[]),i=Object(s.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),re.b.trackInteraction("WebRoomListUserOnboardingButton",e),b.a.fire(L.a.ViewHomePage)}),[]);return o.a.createElement(K.a,{className:c()("mx_UserOnboardingButton",{mx_UserOnboardingButton_selected:t,mx_UserOnboardingButton_minimized:a}),onClick:i},!a&&o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_UserOnboardingButton_content"},o.a.createElement(ua.a,{size:"h4",className:"mx_Heading_h4"},Object(N.b)("Welcome")),o.a.createElement(K.a,{className:"mx_UserOnboardingButton_close",onClick:n}))))}var va=function(e){return e[e.Disabled=0]="Disabled",e[e.Legacy=1]="Legacy",e[e.Labs=2]="Labs",e}(va||{});class fa extends s.Component{constructor(e){super(e),i()(this,"listContainerRef",Object(s.createRef)()),i()(this,"roomListRef",Object(s.createRef)()),i()(this,"focusedElement",null),i()(this,"isDoingStickyHeaders",!1),i()(this,"updateActiveSpace",(e=>{this.setState({activeSpace:e})})),i()(this,"onDialPad",(()=>{b.a.fire(L.a.OpenDialPad)})),i()(this,"onExplore",(e=>{b.a.fire(L.a.ViewRoomDirectory),re.b.trackInteraction("WebLeftPanelExploreRoomsButton",e)})),i()(this,"refreshStickyHeaders",(()=>{this.listContainerRef.current&&this.handleStickyHeaders(this.listContainerRef.current)})),i()(this,"onBreadcrumbsUpdate",(()=>{const e=fa.breadcrumbsMode;if(e!==this.state.showBreadcrumbs){if(this.setState({showBreadcrumbs:e}),!this.listContainerRef.current)return;this.handleStickyHeaders(this.listContainerRef.current)}})),i()(this,"onScroll",(e=>{const t=e.target;this.handleStickyHeaders(t)})),i()(this,"onFocus",(e=>{this.focusedElement=e.target})),i()(this,"onBlur",(()=>{this.focusedElement=null})),i()(this,"onKeyDown",((e,t)=>{if(!this.focusedElement)return;var a;Object(J.a)().getRoomListAction(e)===W.h.NextRoom&&(t||(e.stopPropagation(),e.preventDefault(),null===(a=this.roomListRef.current)||void 0===a||a.focus()))})),this.state={activeSpace:$.a.instance.activeSpace,showBreadcrumbs:fa.breadcrumbsMode},Ht.a.instance.on(Et.b,this.onBreadcrumbsUpdate),la.c.instance.on(la.b,this.onBreadcrumbsUpdate),$.a.instance.on(Y.d,this.updateActiveSpace)}static get breadcrumbsMode(){return Ht.a.instance.visible?v.b.getValue("feature_breadcrumbs_v2")?va.Labs:va.Legacy:va.Disabled}componentDidMount(){this.listContainerRef.current&&(Q.b.instance.trackElementDimensions("ListContainer",this.listContainerRef.current),this.listContainerRef.current.addEventListener("scroll",this.onScroll,{passive:!0})),Q.b.instance.on("ListContainer",this.refreshStickyHeaders)}componentWillUnmount(){var e;Ht.a.instance.off(Et.b,this.onBreadcrumbsUpdate),la.c.instance.off(la.b,this.onBreadcrumbsUpdate),$.a.instance.off(Y.d,this.updateActiveSpace),Q.b.instance.stopTrackingElementDimensions("ListContainer"),Q.b.instance.removeListener("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.removeEventListener("scroll",this.onScroll)}componentDidUpdate(e,t){t.activeSpace!==this.state.activeSpace&&this.refreshStickyHeaders()}handleStickyHeaders(e){this.isDoingStickyHeaders||(this.isDoingStickyHeaders=!0,window.requestAnimationFrame((()=>{this.doStickyHeaders(e),this.isDoingStickyHeaders=!1})))}doStickyHeaders(e){const t=e.scrollTop,a=e.offsetHeight+e.scrollTop,n=e.querySelectorAll(".mx_RoomSublist:not(.mx_RoomSublist_hidden)"),i=new Map;let s,o;for(const e of n){const r=e.querySelector(".mx_RoomSublist_stickable");if(!r)continue;r.style.removeProperty("display");const l=.4,c=e.offsetTop+l*V.a<=t,d=e.offsetTop+l*V.a>=a;c||e===n[0]?(i.set(r,{stickyTop:!0}),s&&(s.style.display="none",i.set(s,{makeInvisible:!0})),s=r):d&&!o?(i.set(r,{stickyBottom:!0}),o=r):i.set(r,{})}for(const t of i.keys()){const a=i.get(t);if(a.makeInvisible)t.style.display="none";else{if(a.stickyTop){t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")||t.classList.add("mx_RoomSublist_headerContainer_stickyTop");const a=`${e.parentElement.offsetTop}px`;t.style.top!==a&&(t.style.top=a)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyTop"),t.style.top&&t.style.removeProperty("top");if(a.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")||t.classList.add("mx_RoomSublist_headerContainer_stickyBottom");const a=`${Q.b.instance.windowHeight-(e.parentElement.offsetTop+e.parentElement.offsetHeight)}px`;t.style.bottom!==a&&(t.style.bottom=a)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyBottom"),t.style.bottom&&t.style.removeProperty("bottom");if(a.stickyTop||a.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_sticky")||t.classList.add("mx_RoomSublist_headerContainer_sticky");const e=Q.b.instance.getElementDimensions("ListContainer");if(e){const a=15,n=`${e.width-a}px`;t.style.width!==n&&(t.style.width=n)}}else a.stickyTop||a.stickyBottom||(t.classList.contains("mx_RoomSublist_headerContainer_sticky")&&t.classList.remove("mx_RoomSublist_headerContainer_sticky"),t.style.width&&t.style.removeProperty("width"))}}const r=e.parentElement;r&&(s?r.classList.add("mx_LeftPanel_roomListWrapper_stickyTop"):r.classList.remove("mx_LeftPanel_roomListWrapper_stickyTop"),o?r.classList.add("mx_LeftPanel_roomListWrapper_stickyBottom"):r.classList.remove("mx_LeftPanel_roomListWrapper_stickyBottom"))}renderBreadcrumbs(){if(this.state.showBreadcrumbs===va.Legacy&&!this.props.isMinimized)return s.createElement(It,{className:"mx_LeftPanel_breadcrumbsContainer mx_AutoHideScrollbar",verticalScrollsHorizontally:!0},s.createElement(ha,null))}renderSearchDialExplore(){let e,t;return B.b.instance.getSupportsPstnProtocol()&&(e=s.createElement(q.a,{className:c()("mx_LeftPanel_dialPadButton",{}),onClick:this.onDialPad,title:Object(N.b)("Open dial pad")})),t=this.state.showBreadcrumbs===va.Labs?s.createElement(ra,null):s.createElement(q.a,{className:"mx_LeftPanel_exploreButton",onClick:this.onExplore,title:Object(N.b)("Explore rooms")}),s.createElement("div",{className:"mx_LeftPanel_filterContainer",onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown},s.createElement(G,{isMinimized:this.props.isMinimized}),e,t)}render(){const e=s.createElement(F.b,{onKeyDown:this.onKeyDown,resizeNotifier:this.props.resizeNotifier,onFocus:this.onFocus,onBlur:this.onBlur,isMinimized:this.props.isMinimized,activeSpace:this.state.activeSpace,onResize:this.refreshStickyHeaders,onListCollapse:this.refreshStickyHeaders,ref:this.roomListRef}),t=c()({mx_LeftPanel:!0,mx_LeftPanel_minimized:this.props.isMinimized}),a=c()("mx_LeftPanel_actualRoomListContainer","mx_AutoHideScrollbar");return s.createElement("div",{className:t},s.createElement("div",{className:"mx_LeftPanel_roomListContainer"},Object(ae.a)(le.a.FilterContainer)&&this.renderSearchDialExplore(),this.renderBreadcrumbs(),!this.props.isMinimized&&s.createElement(zt,{onVisibilityChange:this.refreshStickyHeaders}),s.createElement(ga,{selected:this.props.pageType===u.a.HomePage,minimized:this.props.isMinimized}),s.createElement("div",{className:"mx_LeftPanel_roomListWrapper"},s.createElement("div",{className:a,ref:this.listContainerRef,tabIndex:-1},e))))}}var Ea=a(888);class ya extends s.PureComponent{constructor(e){super(e),i()(this,"onUpdateToasts",(()=>{this.setState({toasts:Ea.a.instance.components})})),this.state={toasts:Ea.a.instance.components},Ea.a.instance.on(Et.b,this.onUpdateToasts)}componentWillUnmount(){Ea.a.instance.off(Et.b,this.onUpdateToasts)}render(){const e=this.state.toasts.map(((e,t)=>s.createElement("div",{className:"mx_NonUrgentToastContainer_toast",key:`toast-${t}`},s.createElement(e,{}))));return s.createElement("div",{className:"mx_NonUrgentToastContainer",role:"alert"},e)}}class _a extends o.a.Component{constructor(e){var t;super(e),t=this,i()(this,"watcher",void 0),i()(this,"containerRef",void 0),this.containerRef=o.a.createRef(),this.state={soundPack:v.b.getValue("soundPack")},this.watcher=v.b.watchSetting("soundPack",null,(function(){for(var e=arguments.length,a=new Array(e),n=0;n<e;n++)a[n]=arguments[n];let[,,,,i]=a;return t.setState({soundPack:i})}))}componentWillUnmount(){v.b.unwatchSetting(this.watcher)}render(){return o.a.createElement("div",{className:"mx_SoundPackContainer",ref:this.containerRef},o.a.createElement("audio",{id:"messageAudio"},o.a.createElement("source",{src:`media/${this.state.soundPack}/message.ogg`,type:"audio/ogg"}),o.a.createElement("source",{src:`media/${this.state.soundPack}/message.mp3`,type:"audio/mpeg"})),o.a.createElement("audio",{id:"ringAudio",loop:!0},o.a.createElement("source",{src:`media/${this.state.soundPack}/ring.ogg`,type:"audio/ogg"}),o.a.createElement("source",{src:`media/${this.state.soundPack}/ring.mp3`,type:"audio/mpeg"})),o.a.createElement("audio",{id:"ringbackAudio",loop:!0},o.a.createElement("source",{src:`media/${this.state.soundPack}/ringback.ogg`,type:"audio/ogg"}),o.a.createElement("source",{src:`media/${this.state.soundPack}/ringback.mp3`,type:"audio/mpeg"})),o.a.createElement("audio",{id:"callendAudio"},o.a.createElement("source",{src:`media/${this.state.soundPack}/callend.ogg`,type:"audio/ogg"}),o.a.createElement("source",{src:`media/${this.state.soundPack}/callend.mp3`,type:"audio/mpeg"})),o.a.createElement("audio",{id:"busyAudio"},o.a.createElement("source",{src:`media/${this.state.soundPack}/busy.ogg`,type:"audio/ogg"}),o.a.createElement("source",{src:`media/${this.state.soundPack}/busy.mp3`,type:"audio/mpeg"})))}componentDidUpdate(){this.containerRef.current.querySelectorAll("audio").forEach((e=>e.load()))}}var Sa=a(191),wa=a(517),Oa=a(1);class Ca extends o.a.Component{constructor(e){super(e),i()(this,"element",Object(s.createRef)()),i()(this,"onAudioOutputChanged",(e=>{const t=this.element.current;if(e)try{t.setSinkId(e)}catch(e){Oa.a.error("Couldn't set requested audio output device: using default",e),Oa.a.warn("Couldn't set requested audio output device: using default",e)}})),i()(this,"onNewStream",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted()}),this.playMedia()})),this.state={audioMuted:this.props.feed.isAudioMuted()}}componentDidMount(){p.c.instance.addListener(p.a.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.addListener(wa.b.NewStream,this.onNewStream),this.playMedia()}componentWillUnmount(){p.c.instance.removeListener(p.a.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.removeListener(wa.b.NewStream,this.onNewStream),this.stopMedia()}async playMedia(){const e=this.element.current;if(e){this.onAudioOutputChanged(p.c.getAudioOutput()),e.muted=!1,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.load()}catch(e){Oa.a.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element.current;e&&(e.pause(),e.src=null)}render(){return this.state.audioMuted?null:o.a.createElement("audio",{ref:this.element})}}class xa extends o.a.Component{constructor(e){super(e),i()(this,"onFeedsChanged",(()=>{this.setState({feeds:this.props.call.getRemoteFeeds()})})),this.state={feeds:this.props.call.getRemoteFeeds()}}componentDidMount(){this.props.call.addListener(Sa.d.FeedsChanged,this.onFeedsChanged)}componentWillUnmount(){this.props.call.removeListener(Sa.d.FeedsChanged,this.onFeedsChanged)}render(){return this.state.feeds.map(((e,t)=>o.a.createElement(Ca,{feed:e,key:t})))}}var ja=a(146),ka=a(172),Ra=a(171),Ia=a(162),Ta=a(387),Na=a(168),Pa=a(294),Da=a(234),Ma=a(475);class Aa extends o.a.Component{constructor(){super(...arguments),i()(this,"onResizeStart",(()=>{this.props.resizeNotifier.startResizing()})),i()(this,"onResize",(()=>{this.props.resizeNotifier.notifyRightHandleResized()})),i()(this,"onResizeStop",((e,t,a,n)=>{this.props.resizeNotifier.stopResizing(),window.localStorage.setItem("mx_rhs_size",(this.loadSidePanelSize().width+n.width).toString())}))}loadSidePanelSize(){let e=parseInt(window.localStorage.getItem("mx_rhs_size"),10);return isNaN(e)&&(e=350),{height:"100%",width:e}}render(){const e=o.a.Children.only(this.props.children),t=this.props.panel;let a;return!this.props.collapsedRhs&&t&&(a=o.a.createElement(Ma.Resizable,{defaultSize:this.loadSidePanelSize(),minWidth:264,maxWidth:"50%",enable:{top:!1,right:!1,bottom:!1,left:!0,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_RightPanel_ResizeWrapper",handleClasses:{left:"mx_ResizeHandle_horizontal"}},t)),o.a.createElement("div",{className:"mx_MainSplit"},e,a)}}var Ua=a(188),La=a(185),Fa=a(176);function Ba(e,t){const[a,n]=Object(s.useState)(t?e.isRoomEncrypted(t.roomId):void 0),i=Object(s.useCallback)((a=>{t&&a.getType()===ee.b.RoomEncryption&&n(e.isRoomEncrypted(t.roomId))}),[e,t]);return Object(ie.c)(null==t?void 0:t.currentState,m.b.Events,i),a}var Va=a(401);const Wa=e=>{let{className:t,title:a,children:n}=e;return o.a.createElement("div",{className:c()("mx_BaseCard_Group",t)},o.a.createElement("h1",null,a),n)};var za=Object(s.forwardRef)(((e,t)=>{let a,{closeLabel:n,onClose:i,onBack:s,className:r,header:l,footer:d,withoutScrollContainer:m,children:h,onKeyDown:u}=e;const p=Fa.a.instance.roomPhaseHistory;if(p.length>1){var g;const e=p[p.length-2],t=e=>{null==s||s(e),Fa.a.instance.popCard()},n=null!==(g=Object(La.b)(e.phase))&&void 0!==g?g:Object(N.b)("Back");a=o.a.createElement(K.a,{className:"mx_BaseCard_back",onClick:t,title:n})}let b;return i&&(b=o.a.createElement(K.a,{"data-testid":"base-card-close-button",className:"mx_BaseCard_close",onClick:i,title:n||Object(N.b)("Close")})),m||(h=o.a.createElement(kt.a,null,h)),o.a.createElement(Va.a.Provider,{value:{isCard:!0}},o.a.createElement("div",{className:c()("mx_BaseCard",r),ref:t,onKeyDown:u},o.a.createElement("div",{className:"mx_BaseCard_header"},a,b,l),h,d&&o.a.createElement("div",{className:"mx_BaseCard_footer"},d)))})),Ha=a(601),Ka=a(183),Ga=a(292),qa=a(250),$a=a(161);const Ya=["app","className","width","height"];var Ja=e=>{let{app:t,className:n,width:i=20,height:s=20}=e,r=ve()(e,Ya),l=[a(1691).default];return t.type.includes("jitsi")?l=[a(1692).default]:t.type.includes("meeting")||t.type.includes("calendar")?l=[a(1693).default]:t.type.includes("pad")||t.type.includes("doc")||t.type.includes("calc")?l=[a(1694).default]:t.type.includes("clock")&&(l=[a(1695).default]),o.a.createElement(yt.a,Z()({},r,{name:t.id,className:c()("mx_WidgetAvatar",n),url:t.avatar_url?Object($a.b)(t.avatar_url).getSquareThumbnailHttp(20):null,urls:l,width:i,height:s}))},Qa=a(238),Xa=a(167);let Za=function(e){return e.Warning="warning",e.Verified="verified",e.Normal="normal",e}({});var en=a(139),tn=a(205),an=a(676),nn=a(264),sn=a(147),on=a(210),rn=a(213),ln=a(2);function cn(){return ot.b.get("audio_stream_url")}async function dn(e,t){const a=await async function(e){const t=await oe.a.get().getOpenIdToken(),a=cn()+"/createStream",n=await window.fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:e,openid_token:t})});return(await n.json()).stream_id}(t);await e.transport.send(ln.a.StartLiveStream,{rtmpStreamKey:"rtmp://audiostream.dummy/"+a})}var mn=a(364),hn=a(17),un=a(144);var pn=a(239),gn=a(644),bn=a(137),vn=a(148);class fn extends o.a.PureComponent{constructor(e){super(e),i()(this,"onAllow",(()=>{this.onPermissionSelection(!0)})),i()(this,"onDeny",(()=>{this.onPermissionSelection(!1)})),i()(this,"onRememberSelectionChange",(e=>{this.setState({rememberSelection:e})})),this.state={rememberSelection:!1}}onPermissionSelection(e){this.state.rememberSelection&&(Oa.a.log(`Remembering ${this.props.widget.id} as allowed=${e} for OpenID`),at.b.instance.widgetPermissionStore.setOIDCState(this.props.widget,this.props.widgetKind,this.props.inRoomId,e?gn.a.Allowed:gn.a.Denied)),this.props.onFinished(e)}render(){return o.a.createElement(bn.a,{className:"mx_WidgetOpenIDPermissionsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(N.b)("Allow this widget to verify your identity")},o.a.createElement("div",{className:"mx_WidgetOpenIDPermissionsDialog_content"},o.a.createElement("p",null,Object(N.b)("The widget will verify your user ID, but won't be able to perform actions for you:")),o.a.createElement("p",{className:"text-muted"},this.props.widget.templateUrl.split("?")[0].split("#")[0])),o.a.createElement(vn.a,{primaryButton:Object(N.b)("Continue"),onPrimaryButtonClick:this.onAllow,onCancel:this.onDeny,additive:o.a.createElement(pn.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:Object(N.b)("Remember this")})}))}}var En=a(16),yn=a(193),_n=a(31);const Sn="generic";class wn{static bylineFor(e){return e.kind===tn.EventKind.State?e.keyStr?Object(N.b)("with state key %(stateKey)s",{stateKey:e.keyStr}):Object(N.b)("with an empty state key"):null}static for(e,t){if(wn.simpleCaps[e]){const a=wn.simpleCaps[e];if(a[t])return{primary:Object(N.b)(a[t])};if(a[Sn])return{primary:Object(N.b)(a[Sn])}}if(Object(tn.isTimelineCapability)(e)){if(Object(tn.isTimelineCapabilityFor)(e,tn.Symbols.AnyRoom))return{primary:Object(N.b)("The above, but in any room you are joined or invited to as well")};{const t=Object(tn.getTimelineRoomIDFromCapability)(e),a=oe.a.get().getRoom(t);return{primary:Object(N.b)("The above, but in <Room /> as well",{},{Room:()=>{var e;return a?o.a.createElement(qa.a,{tooltip:null!==(e=a.getCanonicalAlias())&&void 0!==e?e:t},o.a.createElement("b",null,a.name)):o.a.createElement("b",null,o.a.createElement("code",null,t))}})}}}const[a]=tn.WidgetEventCapability.findEventCapabilities([e]);if(a){if(a.kind===tn.EventKind.Event&&a.eventType===ee.b.RoomMessage)return wn.forRoomMessageCap(a,t);const e=a.kind===tn.EventKind.State?wn.stateSendRecvCaps:wn.nonStateSendRecvCaps;if(e[a.eventType]){const n=e[a.eventType],i=(null==n?void 0:n[t])||(null==n?void 0:n[Sn]);if(null!=i&&i[a.direction])return{primary:Object(N.b)(i[a.direction])}}return t===tn.WidgetKind.Room?a.direction===tn.EventDirection.Send?{primary:Object(N.b)("Send <b>%(eventType)s</b> events as you in this room",{eventType:a.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:wn.bylineFor(a)}:{primary:Object(N.b)("See <b>%(eventType)s</b> events posted to this room",{eventType:a.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:wn.bylineFor(a)}:a.direction===tn.EventDirection.Send?{primary:Object(N.b)("Send <b>%(eventType)s</b> events as you in your active room",{eventType:a.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:wn.bylineFor(a)}:{primary:Object(N.b)("See <b>%(eventType)s</b> events posted to your active room",{eventType:a.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:wn.bylineFor(a)}}return{primary:Object(N.b)("The <b>%(capability)s</b> capability",{capability:e},{b:e=>o.a.createElement("b",null,e)})}}static forRoomMessageCap(e,t){if(!e.keyStr)return e.direction===tn.EventDirection.Send?{primary:t===tn.WidgetKind.Room?Object(N.b)("Send messages as you in this room"):Object(N.b)("Send messages as you in your active room")}:{primary:t===tn.WidgetKind.Room?Object(N.b)("See messages posted to this room"):Object(N.b)("See messages posted to your active room")};switch(e.keyStr){case ee.e.Text:return e.direction===tn.EventDirection.Send?{primary:t===tn.WidgetKind.Room?Object(N.b)("Send text messages as you in this room"):Object(N.b)("Send text messages as you in your active room")}:{primary:t===tn.WidgetKind.Room?Object(N.b)("See text messages posted to this room"):Object(N.b)("See text messages posted to your active room")};case ee.e.Emote:return e.direction===tn.EventDirection.Send?{primary:t===tn.WidgetKind.Room?Object(N.b)("Send emotes as you in this room"):Object(N.b)("Send emotes as you in your active room")}:{primary:t===tn.WidgetKind.Room?Object(N.b)("See emotes posted to this room"):Object(N.b)("See emotes posted to your active room")};case ee.e.Image:return e.direction===tn.EventDirection.Send?{primary:t===tn.WidgetKind.Room?Object(N.b)("Send images as you in this room"):Object(N.b)("Send images as you in your active room")}:{primary:t===tn.WidgetKind.Room?Object(N.b)("See images posted to this room"):Object(N.b)("See images posted to your active room")};case ee.e.Video:return e.direction===tn.EventDirection.Send?{primary:t===tn.WidgetKind.Room?Object(N.b)("Send videos as you in this room"):Object(N.b)("Send videos as you in your active room")}:{primary:t===tn.WidgetKind.Room?Object(N.b)("See videos posted to this room"):Object(N.b)("See videos posted to your active room")};case ee.e.File:return e.direction===tn.EventDirection.Send?{primary:t===tn.WidgetKind.Room?Object(N.b)("Send general files as you in this room"):Object(N.b)("Send general files as you in your active room")}:{primary:t===tn.WidgetKind.Room?Object(N.b)("See general files posted to this room"):Object(N.b)("See general files posted to your active room")};default:{let a;return a=e.direction===tn.EventDirection.Send?t===tn.WidgetKind.Room?Object(N.b)("Send <b>%(msgtype)s</b> messages as you in this room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):Object(N.b)("Send <b>%(msgtype)s</b> messages as you in your active room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):t===tn.WidgetKind.Room?Object(N.b)("See <b>%(msgtype)s</b> messages posted to this room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):Object(N.b)("See <b>%(msgtype)s</b> messages posted to your active room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}),{primary:a}}}}}i()(wn,"simpleCaps",{[tn.MatrixCapabilities.AlwaysOnScreen]:{[tn.WidgetKind.Room]:Object(N.d)("Remain on your screen when viewing another room, when running"),[Sn]:Object(N.d)("Remain on your screen while running")},[tn.MatrixCapabilities.StickerSending]:{[tn.WidgetKind.Room]:Object(N.d)("Send stickers into this room"),[Sn]:Object(N.d)("Send stickers into your active room")},[_n.a.CanChangeViewedRoom]:{[Sn]:Object(N.d)("Change which room you're viewing")},[tn.MatrixCapabilities.MSC2931Navigate]:{[Sn]:Object(N.d)("Change which room, message, or user you're viewing")}}),i()(wn,"stateSendRecvCaps",{[ee.b.RoomTopic]:{[tn.WidgetKind.Room]:{[tn.EventDirection.Send]:Object(N.d)("Change the topic of this room"),[tn.EventDirection.Receive]:Object(N.d)("See when the topic changes in this room")},[Sn]:{[tn.EventDirection.Send]:Object(N.d)("Change the topic of your active room"),[tn.EventDirection.Receive]:Object(N.d)("See when the topic changes in your active room")}},[ee.b.RoomName]:{[tn.WidgetKind.Room]:{[tn.EventDirection.Send]:Object(N.d)("Change the name of this room"),[tn.EventDirection.Receive]:Object(N.d)("See when the name changes in this room")},[Sn]:{[tn.EventDirection.Send]:Object(N.d)("Change the name of your active room"),[tn.EventDirection.Receive]:Object(N.d)("See when the name changes in your active room")}},[ee.b.RoomAvatar]:{[tn.WidgetKind.Room]:{[tn.EventDirection.Send]:Object(N.d)("Change the avatar of this room"),[tn.EventDirection.Receive]:Object(N.d)("See when the avatar changes in this room")},[Sn]:{[tn.EventDirection.Send]:Object(N.d)("Change the avatar of your active room"),[tn.EventDirection.Receive]:Object(N.d)("See when the avatar changes in your active room")}},[ee.b.RoomMember]:{[tn.WidgetKind.Room]:{[tn.EventDirection.Send]:Object(N.d)("Remove, ban, or invite people to this room, and make you leave"),[tn.EventDirection.Receive]:Object(N.d)("See when people join, leave, or are invited to this room")},[Sn]:{[tn.EventDirection.Send]:Object(N.d)("Remove, ban, or invite people to your active room, and make you leave"),[tn.EventDirection.Receive]:Object(N.d)("See when people join, leave, or are invited to your active room")}}}),i()(wn,"nonStateSendRecvCaps",{[ee.b.Sticker]:{[tn.WidgetKind.Room]:{[tn.EventDirection.Send]:Object(N.d)("Send stickers to this room as you"),[tn.EventDirection.Receive]:Object(N.d)("See when a sticker is posted in this room")},[Sn]:{[tn.EventDirection.Send]:Object(N.d)("Send stickers to your active room as you"),[tn.EventDirection.Receive]:Object(N.d)("See when anyone posts a sticker to your active room")}}});class On extends o.a.PureComponent{constructor(e){super(e),i()(this,"eventPermissionsMap",new Map),i()(this,"onToggle",(e=>{const t=Object(yn.e)(this.state.booleanStates);t[e]=!t[e],this.setState({booleanStates:t})})),i()(this,"onRememberSelectionChange",(e=>{this.setState({rememberSelection:e})})),i()(this,"onSubmit",(async()=>{this.closeAndTryRemember(Object.entries(this.state.booleanStates).filter((e=>{let[t,a]=e;return a})).map((e=>{let[t]=e;return t})))})),i()(this,"onReject",(async()=>{this.closeAndTryRemember([])}));tn.WidgetEventCapability.findEventCapabilities(this.props.requestedCapabilities).forEach((e=>this.eventPermissionsMap.set(e.raw,e)));const t={};this.props.requestedCapabilities.forEach((e=>t[e]=!0)),this.state={booleanStates:t,rememberSelection:!0}}closeAndTryRemember(e){this.props.onFinished({approved:e,remember:this.state.rememberSelection})}render(){const e=Object.entries(this.state.booleanStates).sort(((e,t)=>{let[a]=e,[n]=t;const i=Object(tn.isTimelineCapability)(a),s=Object(tn.isTimelineCapability)(n);return i||s?i&&!s?1:!i&&s?-1:i&&s?Object(En.x)(a,n):0:Object(En.x)(a,n)})).map(((e,t)=>{let[a,n]=e;const i=wn.for(a,this.props.widgetKind),s=i.byline?o.a.createElement("span",{className:"mx_WidgetCapabilitiesPromptDialog_byline"},i.byline):null;return o.a.createElement("div",{className:"mx_WidgetCapabilitiesPromptDialog_cap",key:a+t},o.a.createElement(Ue.b,{checked:n,onChange:()=>this.onToggle(a)},i.primary),s)}));return o.a.createElement(bn.a,{className:"mx_WidgetCapabilitiesPromptDialog",onFinished:this.props.onFinished,title:Object(N.b)("Approve widget permissions")},o.a.createElement("form",{onSubmit:this.onSubmit},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("div",{className:"text-muted"},Object(N.b)("This widget would like to:")),e,o.a.createElement(vn.a,{primaryButton:Object(N.b)("Approve"),cancelButton:Object(N.b)("Decline All"),onPrimaryButtonClick:this.onSubmit,onCancel:this.onReject,additive:o.a.createElement(pn.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:Object(N.b)("Remember my selection for this widget")})}))))}}const Cn={};var xn=a(255),jn=a(318),kn=a(940);const Rn=e=>{let{urls:t,username:a,credential:n}=e;return{uris:t,username:a,password:n}};class In extends tn.WidgetDriver{constructor(e,t,a,n,s){var o;if(super(),this.forWidget=t,this.forWidgetKind=a,this.inRoomId=s,i()(this,"allowedCapabilities",void 0),this.allowedCapabilities=new Set([...e,tn.MatrixCapabilities.Screenshots,_n.a.RequiresClient]),on.a.JITSI.matches(this.forWidget.type)&&a===tn.WidgetKind.Room)this.allowedCapabilities.add(tn.MatrixCapabilities.AlwaysOnScreen);else if(on.a.STICKERPICKER.matches(this.forWidget.type)&&a===tn.WidgetKind.Account){const e=tn.WidgetEventCapability.forRoomEvent(tn.EventDirection.Send,ee.b.Sticker).raw;this.allowedCapabilities.add(tn.MatrixCapabilities.StickerSending),this.allowedCapabilities.add(e),this.allowedCapabilities.add("visibility")}else if(n&&new URL(null!==(o=ot.b.get("element_call").url)&&void 0!==o?o:ot.a.element_call.url).origin===this.forWidget.origin){this.allowedCapabilities.add(tn.MatrixCapabilities.AlwaysOnScreen),this.allowedCapabilities.add(tn.MatrixCapabilities.MSC3846TurnServers),this.allowedCapabilities.add(`org.matrix.msc2762.timeline:${s}`),this.allowedCapabilities.add(tn.WidgetEventCapability.forRoomEvent(tn.EventDirection.Send,"org.matrix.rageshake_request").raw),this.allowedCapabilities.add(tn.WidgetEventCapability.forRoomEvent(tn.EventDirection.Receive,"org.matrix.rageshake_request").raw),this.allowedCapabilities.add(tn.WidgetEventCapability.forStateEvent(tn.EventDirection.Receive,ee.b.RoomMember).raw),this.allowedCapabilities.add(tn.WidgetEventCapability.forStateEvent(tn.EventDirection.Receive,"org.matrix.msc3401.call").raw),this.allowedCapabilities.add(tn.WidgetEventCapability.forStateEvent(tn.EventDirection.Send,"org.matrix.msc3401.call.member",oe.a.get().getUserId()).raw),this.allowedCapabilities.add(tn.WidgetEventCapability.forStateEvent(tn.EventDirection.Receive,"org.matrix.msc3401.call.member").raw);const e=[ee.b.CallInvite,ee.b.CallCandidates,ee.b.CallAnswer,ee.b.CallHangup,ee.b.CallReject,ee.b.CallSelectAnswer,ee.b.CallNegotiate,ee.b.CallSDPStreamMetadataChanged,ee.b.CallSDPStreamMetadataChangedPrefix,ee.b.CallReplaces];for(const t of e)this.allowedCapabilities.add(tn.WidgetEventCapability.forToDeviceEvent(tn.EventDirection.Send,t).raw),this.allowedCapabilities.add(tn.WidgetEventCapability.forToDeviceEvent(tn.EventDirection.Receive,t).raw)}}async validateCapabilities(e){const t=(a=e,n=this.allowedCapabilities,Object(un.a)(Array.from(a),Array.from(n)));var a,n;const i=new Set(t.removed),s=new Set(this.allowedCapabilities);var o;let r;if((o=this.forWidget,JSON.parse(localStorage.getItem(`widget_${o.id}_approved_caps`)||"[]")).forEach((e=>{s.add(e),i.delete(e)})),Cn.preapproveCapabilities)r=await Cn.preapproveCapabilities(this.forWidget,e);else{const t={approvedCapabilities:void 0};mn.a.instance.invoke(an.WidgetLifecycle.CapabilitiesRequest,t,this.forWidget,e),r=t.approvedCapabilities}r&&r.forEach((e=>{s.add(e),i.delete(e)}));let l=!1;if(i.size>0)try{var c;const[e]=await z.b.createDialog(On,{requestedCapabilities:i,widget:this.forWidget,widgetKind:this.forWidgetKind}).finished;null==e||null===(c=e.approved)||void 0===c||c.forEach((e=>s.add(e))),l=!(null==e||!e.remember)}catch(e){Oa.a.error("Non-fatal error getting capabilities: ",e)}const d=new Set(function(e,t){return Object(un.f)(Array.from(e),Array.from(t))}(s,e));return l&&function(e,t){localStorage.setItem(`widget_${e.id}_approved_caps`,JSON.stringify(t))}(this.forWidget,Array.from(d)),d}async sendEvent(e,t,a,n){const i=oe.a.get(),s=n||at.b.instance.roomViewStore.getRoomId();if(!i||!s)throw new Error("Not in a room or not attached to a client");let o=null;return null!==a?o=await i.sendStateEvent(s,e,t,a):e===ee.b.RoomRedaction?o=await i.redactEvent(s,t.redacts):(o=await i.sendEvent(s,e,t),e===ee.b.RoomMessage&&xn.CHAT_EFFECTS.forEach((e=>{if(Object(jn.containsEmoji)(t,e.emojis)){var a;(null===(a=t["m.relates_to"])||void 0===a?void 0:a.rel_type)!==Ra.d.name&&b.a.dispatch({action:`effects.${e.command}`})}}))),{roomId:s,eventId:o.event_id}}async sendToDevice(e,t,a){const n=oe.a.get();if(t){const e=await n.crypto.deviceList.downloadKeys(Object.keys(a),!1);await Promise.all(Object.entries(a).flatMap((t=>{let[a,i]=t;return Object.entries(i).map((async t=>{let[i,s]=t;"*"===i?await n.encryptAndSendToDevices(Array.from(e.get(a).values()).map((e=>({userId:a,deviceInfo:e}))),s):await n.encryptAndSendToDevices([{userId:a,deviceInfo:e.get(a).get(i)}],s)}))})))}else await n.queueToDevice({eventType:e,batch:Object.entries(a).flatMap((e=>{let[t,a]=e;return Object.entries(a).map((e=>{let[a,n]=e;return{userId:t,deviceId:a,payload:n}}))}))})}pickRooms(e){const t=oe.a.get();if(!t)throw new Error("Not attached to a client");return(e?e.includes(tn.Symbols.AnyRoom)?t.getVisibleRooms(v.b.getValue("feature_dynamic_room_predecessors")):e.map((e=>t.getRoom(e))):[t.getRoom(at.b.instance.roomViewStore.getRoomId())]).filter((e=>!!e))}async readRoomEvents(e,t,a,n){a=a>0?Math.min(a,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const i=this.pickRooms(n),s=[];for(const n of i){const i=[],o=n.getLiveTimeline().getEvents();for(let n=o.length-1;n>0&&!(i.length>=a);n--){const a=o[n];a.getType()!==e||a.isState()||e===ee.b.RoomMessage&&t&&t!==a.getContent().msgtype||i.push(a)}i.forEach((e=>s.push(e.getEffectiveEvent())))}return s}async readStateEvents(e,t,a,n){a=a>0?Math.min(a,Number.MAX_SAFE_INTEGER):Number.MAX_SAFE_INTEGER;const i=this.pickRooms(n),s=[];for(const n of i){const i=[],o=n.currentState.events.get(e);if(o)if(""===t||t){const e=o.get(t);e&&i.push(e)}else i.push(...Array.from(o.values()));i.slice(0,a).forEach((e=>s.push(e.getEffectiveEvent())))}return s}async askOpenID(e){const t={approved:void 0};if(mn.a.instance.invoke(an.WidgetLifecycle.IdentityRequest,t,this.forWidget),t.approved)return e.update({state:tn.OpenIDRequestState.Allowed,token:await oe.a.get().getOpenIdToken()});const a=at.b.instance.widgetPermissionStore.getOIDCState(this.forWidget,this.forWidgetKind,this.inRoomId),n=()=>oe.a.get().getOpenIdToken();return a===gn.a.Denied?e.update({state:tn.OpenIDRequestState.Blocked}):a===gn.a.Allowed?e.update({state:tn.OpenIDRequestState.Allowed,token:await n()}):(e.update({state:tn.OpenIDRequestState.PendingUserConfirmation}),void z.b.createDialog(fn,{widget:this.forWidget,widgetKind:this.forWidgetKind,inRoomId:this.inRoomId,onFinished:async t=>t?e.update({state:tn.OpenIDRequestState.Allowed,token:await n()}):e.update({state:tn.OpenIDRequestState.Blocked})}))}async navigate(e){Object(kn.a)(e)}async*getTurnServers(){const e=oe.a.get();if(!e.pollingTurnServers||!e.getTurnServers().length)return;let t,a;const n=e=>{let[a]=e;return t(Rn(a))},i=(e,t)=>{t&&a(e)};e.on(r.b.TurnServers,n),e.on(r.b.TurnServersError,i);try{const n=e.getTurnServers()[0];for(yield Rn(n);;)yield await new Promise(((e,n)=>{t=e,a=n}))}finally{e.off(r.b.TurnServers,n),e.off(r.b.TurnServersError,i)}}async readEventRelations(e,t,a,n,i,s,o,r){var l,c;const d=oe.a.get(),m=r;if("string"!=typeof(t=null!==(l=null!==(c=t)&&void 0!==c?c:at.b.instance.roomViewStore.getRoomId())&&void 0!==l?l:void 0))throw new Error("Error while reading the current room");const{events:h,nextBatch:u,prevBatch:p}=await d.relations(t,e,null!=a?a:null,null!=n?n:null,{from:i,to:s,limit:o,dir:m});return{chunk:h.map((e=>e.getEffectiveEvent())),nextBatch:null!=u?u:void 0,prevBatch:null!=p?p:void 0}}async searchUserDirectory(e,t){const a=oe.a.get(),{limited:n,results:i}=await a.searchUserDirectory({term:e,limit:t});return{limited:n,results:i.map((e=>({userId:e.user_id,displayName:e.display_name,avatarUrl:e.avatar_url})))}}}var Tn=a(344),Nn=a(202);const Pn="io.element.web";var Dn=a(343);function Mn(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function An(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Mn(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Mn(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Un extends s.PureComponent{constructor(e){super(e),i()(this,"widget",void 0),i()(this,"possibleButtons",void 0),i()(this,"appFrame",s.createRef()),i()(this,"state",{disabledButtonIds:(this.props.widgetDefinition.buttons||[]).filter((e=>e.disabled)).map((e=>e.id))}),i()(this,"onReady",(()=>{var e;null===(e=this.state.messaging)||void 0===e||e.sendWidgetConfig(this.props.widgetDefinition)})),i()(this,"onLoad",(()=>{this.state.messaging&&(this.state.messaging.once("ready",this.onReady),this.state.messaging.on(`action:${tn.WidgetApiFromWidgetAction.CloseModalWidget}`,this.onWidgetClose),this.state.messaging.on(`action:${tn.WidgetApiFromWidgetAction.SetModalButtonEnabled}`,this.onButtonEnableToggle))})),i()(this,"onWidgetClose",(e=>{this.props.onFinished(!0,e.detail.data)})),i()(this,"onButtonEnableToggle",(e=>{var t;e.preventDefault();var a;if(e.detail.data.button===tn.BuiltInModalButtonID.Close||!this.possibleButtons.includes(e.detail.data.button))return null===(a=this.state.messaging)||void 0===a?void 0:a.transport.reply(e.detail,{error:{message:"Invalid button"}});let n;if(e.detail.data.enabled)n=Object(un.b)(this.state.disabledButtonIds).filter((t=>t!==e.detail.data.button));else{const t=new Set(this.state.disabledButtonIds);t.add(e.detail.data.button),n=Array.from(t)}this.setState({disabledButtonIds:n}),null===(t=this.state.messaging)||void 0===t||t.transport.reply(e.detail,{})})),this.widget=new Hn(An(An({},this.props.widgetDefinition),{},{creatorUserId:oe.a.get().getSafeUserId(),id:`modal_${this.props.sourceWidgetId}`})),this.possibleButtons=(this.props.widgetDefinition.buttons||[]).map((e=>e.id))}componentDidMount(){const e=new In([],this.widget,tn.WidgetKind.Modal,!1),t=new tn.ClientWidgetApi(this.widget,this.appFrame.current,e);this.setState({messaging:t})}componentWillUnmount(){this.state.messaging&&(this.state.messaging.off("ready",this.onReady),this.state.messaging.off(`action:${tn.WidgetApiFromWidgetAction.CloseModalWidget}`,this.onWidgetClose),this.state.messaging.stop())}render(){var e,t,n;const i=this.widget.getCompleteUrl({widgetRoomId:this.props.widgetRoomId,currentUserId:oe.a.get().getSafeUserId(),userDisplayName:null!==(e=ft.a.instance.displayName)&&void 0!==e?e:void 0,userHttpAvatarUrl:null!==(t=ft.a.instance.getHttpAvatarUrl())&&void 0!==t?t:void 0,clientId:Pn,clientTheme:Dn.a.getCurrentTheme(),clientLanguage:Object(N.i)()}),o=new URL(i);o.searchParams.set("widgetId",this.widget.id),o.searchParams.set("parentUrl",window.location.href.split("#",2)[0]);const r=o.toString().replace(/%24/g,"$");let l;return this.props.widgetDefinition.buttons&&(l=this.props.widgetDefinition.buttons.slice(0,3).reverse().map((e=>{let t="secondary";switch(e.kind){case tn.ModalButtonKind.Primary:t="primary";break;case tn.ModalButtonKind.Secondary:t="primary_outline";break;case tn.ModalButtonKind.Danger:t="danger"}const a=this.state.disabledButtonIds.includes(e.id);return s.createElement(K.a,{key:e.id,kind:t,onClick:()=>{var t;null===(t=this.state.messaging)||void 0===t||t.notifyModalWidgetButtonClicked(e.id)},disabled:a},e.label)}))),s.createElement(bn.a,{title:this.props.widgetDefinition.name||Object(N.b)("Modal Widget"),className:"mx_ModalWidgetDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},s.createElement("div",{className:"mx_ModalWidgetDialog_warning"},s.createElement("img",{src:a(473).default,height:"16",width:"16",alt:""}),Object(N.b)("Data on this screen is shared with %(widgetDomain)s",{widgetDomain:o.hostname})),s.createElement("div",null,s.createElement("iframe",{title:null!==(n=this.widget.name)&&void 0!==n?n:void 0,ref:this.appFrame,sandbox:"allow-forms allow-scripts allow-same-origin",src:r,onLoad:this.onLoad})),s.createElement("div",{className:"mx_ModalWidgetDialog_buttons"},l))}}function Ln(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Fn(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Ln(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Ln(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Bn extends Nn.a{constructor(){super(b.a,{}),i()(this,"modalInstance",null),i()(this,"openSourceWidgetId",null),i()(this,"openSourceWidgetRoomId",null),i()(this,"canOpenModalWidget",(()=>!this.modalInstance)),i()(this,"openModalWidget",((e,t,a)=>{this.modalInstance||(this.openSourceWidgetId=t.id,this.openSourceWidgetRoomId=null!=a?a:null,this.modalInstance=z.b.createDialog(Un,{widgetDefinition:Fn({},e),widgetRoomId:a,sourceWidgetId:t.id,onFinished:(e,n)=>{e?this.closeModalWidget(t,a,n):this.closeModalWidget(t,a,{"m.exited":!0}),this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance=null}},void 0,!1,!0))})),i()(this,"closeModalWidget",((e,t,a)=>{if(this.modalInstance&&this.openSourceWidgetId===e.id&&this.openSourceWidgetRoomId===t){this.openSourceWidgetId=null,this.openSourceWidgetRoomId=null,this.modalInstance.close(),this.modalInstance=null;const n=nn.a.instance.getMessaging(e,t);if(!n)return void Oa.a.error("No source widget messaging for modal widget");n.notifyModalWidgetClose(a)}}))}static get instance(){return Bn.internalInstance}async onAction(e){}}i()(Bn,"internalInstance",(()=>{const e=new Bn;return e.start(),e})()),window.mxModalWidgetStore=Bn.instance;const Vn={};function Wn(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function zn(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Wn(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Wn(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Hn extends tn.Widget{constructor(e){super(e),this.rawDefinition=e}get templateUrl(){var e;return on.a.JITSI.matches(this.type)?Ka.a.getLocalJitsiWrapperUrl({forLocalRender:!0,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):super.templateUrl}get popoutTemplateUrl(){var e;return on.a.JITSI.matches(this.type)?Ka.a.getLocalJitsiWrapperUrl({forLocalRender:!1,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):this.templateUrl}get rawData(){let e=super.rawData.conferenceId;if(void 0===e){e=new URL(super.templateUrl).searchParams.get("confId")}let t=super.rawData.domain;void 0===t&&(t="meet.element.io");const a=Dn.a.getCurrentThemeSimplified();return zn(zn({},super.rawData),{},{theme:a,conferenceId:e,domain:t})}getCompleteUrl(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return Object(tn.runTemplate)(t?this.popoutTemplateUrl:this.templateUrl,zn(zn({},this.rawDefinition),{},{data:this.rawData}),e)}}class Kn extends hn.EventEmitter{constructor(e){var t;super(),this.appTileProps=e,i()(this,"client",void 0),i()(this,"messaging",void 0),i()(this,"mockWidget",void 0),i()(this,"scalarToken",void 0),i()(this,"roomId",void 0),i()(this,"kind",void 0),i()(this,"virtual",void 0),i()(this,"readUpToMap",{}),i()(this,"onOpenModal",(async e=>{var t,a;(e.preventDefault(),Bn.instance.canOpenModalWidget())?(Bn.instance.openModalWidget(e.detail.data,this.mockWidget,this.roomId),null===(t=this.messaging)||void 0===t||t.transport.reply(e.detail,{})):null===(a=this.messaging)||void 0===a||a.transport.reply(e.detail,{error:{message:"Unable to open modal at this time"}})})),i()(this,"onEvent",(e=>{this.client.decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure()||this.feedEvent(e)})),i()(this,"onEventDecrypted",(e=>{e.isDecryptionFailure()||this.feedEvent(e)})),i()(this,"onToDeviceEvent",(async e=>{var t;await this.client.decryptEventIfNeeded(e),e.isDecryptionFailure()||await(null===(t=this.messaging)||void 0===t?void 0:t.feedToDevice(e.getEffectiveEvent(),e.isEncrypted()))})),this.client=oe.a.get();let a=e.app;a.creatorUserId||(a=Object(yn.e)(a),a.creatorUserId=this.client.getUserId()),this.mockWidget=new Hn(a),this.roomId=null===(t=e.room)||void 0===t?void 0:t.roomId,this.kind=e.userWidget?tn.WidgetKind.Account:tn.WidgetKind.Room,this.virtual=void 0===a.eventId}get eventListenerRoomId(){return this.roomId?this.roomId:at.b.instance.roomViewStore.getRoomId()}get widgetApi(){return this.messaging}get embedUrl(){return this.runUrlTemplate({asPopout:!1})}get popoutUrl(){return this.runUrlTemplate({asPopout:!0})}runUrlTemplate(){var e,t,a,n;let i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{asPopout:!1};const s=null!==(e=null==Vn||null===(t=Vn.provideVariables)||void 0===t?void 0:t.call(Vn))&&void 0!==e?e:{},o={widgetRoomId:this.roomId,currentUserId:this.client.getUserId(),userDisplayName:null!==(a=ft.a.instance.displayName)&&void 0!==a?a:void 0,userHttpAvatarUrl:null!==(n=ft.a.instance.getHttpAvatarUrl())&&void 0!==n?n:void 0,clientId:Pn,clientTheme:Dn.a.getCurrentTheme(),clientLanguage:Object(N.i)()},r=this.mockWidget.getCompleteUrl(Object.assign(o,s),null==i?void 0:i.asPopout),l=new URL(r);return null!=i&&i.asPopout||(l.searchParams.set("widgetId",this.mockWidget.id),l.searchParams.set("parentUrl",window.location.href.split("#",2)[0]),this.scalarToken&&l.searchParams.set("scalar_token",this.scalarToken)),l.toString().replace(/%24/g,"$")}get isManagedByManager(){return!!this.scalarToken}get started(){return!!this.messaging}startMessaging(e){if(this.started)return;const t=this.appTileProps.whitelistCapabilities||[],a=new In(t,this.mockWidget,this.kind,this.virtual,this.roomId);this.messaging=new tn.ClientWidgetApi(this.mockWidget,e,a),this.messaging.on("preparing",(()=>this.emit("preparing"))),this.messaging.on("ready",(()=>{nn.a.instance.storeMessaging(this.mockWidget,this.roomId,this.messaging),this.emit("ready")})),this.messaging.on("capabilitiesNotified",(()=>this.emit("capabilitiesNotified"))),this.messaging.on(`action:${tn.WidgetApiFromWidgetAction.OpenModalWidget}`,this.onOpenModal),this.messaging.on(`action:${ln.a.JoinCall}`,(()=>{var e;null===(e=at.b.instance.voiceBroadcastRecordingsStore.getCurrent())||void 0===e||e.pause()})),this.messaging.on(`action:${ln.a.ViewRoom}`,(e=>{var t;e.preventDefault();const a=(e.detail.data||{}).room_id;var n,i;return a?null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(_n.a.CanChangeViewedRoom)?(b.a.dispatch({action:L.a.ViewRoom,room_id:a,metricsTrigger:"Widget"}),void this.messaging.transport.reply(e.detail,{})):null===(i=this.messaging)||void 0===i?void 0:i.transport.reply(e.detail,{error:{message:"This widget does not have permission for this action (denied)."}}):null===(n=this.messaging)||void 0===n?void 0:n.transport.reply(e.detail,{error:{message:"Room ID not supplied."}})}));for(const e of this.client.getRooms()){var n;const t=(null===(n=e.getLiveTimeline())||void 0===n?void 0:n.getEvents())||[],a=t[t.length-1];a&&(this.readUpToMap[e.roomId]=a.getId())}this.client.on(r.b.Event,this.onEvent),this.client.on(ja.c.Decrypted,this.onEventDecrypted),this.client.on(r.b.ToDeviceEvent,this.onToDeviceEvent),this.messaging.on(`action:${tn.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen}`,(e=>{var t,a;null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(tn.MatrixCapabilities.AlwaysOnScreen)&&(Tn.b.instance.setWidgetPersistence(this.mockWidget.id,null!==(a=this.roomId)&&void 0!==a?a:null,e.detail.data.value),e.preventDefault(),this.messaging.transport.reply(e.detail,{}))})),this.messaging.on(`action:${tn.WidgetApiFromWidgetAction.SendSticker}`,(e=>{var t;null!==(t=this.messaging)&&void 0!==t&&t.hasCapability(tn.MatrixCapabilities.StickerSending)&&(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),b.a.dispatch({action:"m.sticker",data:e.detail.data,widgetId:this.mockWidget.id}))})),on.a.STICKERPICKER.matches(this.mockWidget.type)&&this.messaging.on(`action:${ln.a.OpenIntegrationManager}`,(e=>{var t,a,n;e.preventDefault(),null===(t=this.messaging)||void 0===t||t.transport.reply(e.detail,{}),b.a.dispatch({action:"stickerpicker_close"});const i=e.detail.data,s=null==i?void 0:i.integType,o=null==i?void 0:i.integId,r=at.b.instance.roomViewStore.getRoomId(),l=r?this.client.getRoom(r):void 0;l&&(null===(a=Ga.a.sharedInstance())||void 0===a||null===(n=a.getPrimaryManager())||void 0===n||n.open(l,`type_${s}`,o))})),on.a.JITSI.matches(this.mockWidget.type)&&this.messaging.on(`action:${ln.a.HangupCall}`,(e=>{var t,a;e.preventDefault(),null!==(t=e.detail.data)&&void 0!==t&&t.errorMessage&&z.b.createDialog(sn.a,{title:Object(N.b)("Connection lost"),description:Object(N.b)("You were disconnected from the call. (Error: %(message)s)",{message:e.detail.data.errorMessage})}),null===(a=this.messaging)||void 0===a||a.transport.reply(e.detail,{})}))}async prepare(){var e,t;if(await(null!==(e=null==Vn||null===(t=Vn.isReady)||void 0===t?void 0:t.call(Vn))&&void 0!==e?e:Promise.resolve()),this.scalarToken)return;const a=nn.a.instance.getMessaging(this.mockWidget,this.roomId);a&&(this.messaging=a);try{if(Ka.a.isScalarUrl(this.mockWidget.templateUrl)){const e=Ga.a.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();if(t&&Ka.a.isScalarUrl(t.apiUrl)){const e=t.getScalarClient();this.scalarToken=await e.getScalarToken()}}}}catch(e){Oa.a.error("Error preparing widget communications: ",e)}}stopMessaging(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{forceDestroy:!1};null!=t&&t.forceDestroy||!Tn.b.instance.getWidgetPersistence(this.mockWidget.id,null!==(e=this.roomId)&&void 0!==e?e:null)?this.started&&(nn.a.instance.stopMessaging(this.mockWidget,this.roomId),this.messaging=null,this.client.off(r.b.Event,this.onEvent),this.client.off(ja.c.Decrypted,this.onEventDecrypted),this.client.off(r.b.ToDeviceEvent,this.onToDeviceEvent)):Oa.a.log("Skipping destroy - persistent widget")}feedEvent(e){if(!this.messaging)return;const t=this.readUpToMap[e.getRoomId()];if(t){if(t===e.getId())return;let a=!0;const n=this.client.getRoom(e.getRoomId());if(!n)return;const i=n.getLiveTimeline(),s=Object(un.b)(i.getEvents()).reverse().slice(0,100);for(const n of s){if(n.getId()===t)break;if(n.getId()===e.getId()){a=!1;break}}if(a)return}const a=e.getRoomId(),n=e.getId();if(a&&n){const e=this.client.getRoom(a);e&&"join"===e.getMyMembership()&&(this.readUpToMap[a]=n)}const i=e.getEffectiveEvent();this.messaging.feedEvent(i,this.eventListenerRoomId).catch((e=>{Oa.a.error("Error sending event to widget: ",e)}))}}const Gn=["onFinished","app","userWidget","onDeleteClick","onEditClick","showUnpin"],qn=e=>{var t;let{onFinished:a,app:n,userWidget:i,onDeleteClick:r,onEditClick:l,showUnpin:c}=e,d=ve()(e,Gn);const m=Object(s.useContext)(R.a),{room:h,roomId:u}=Object(s.useContext)(en.b),p=nn.a.instance.getMessagingForUid(Ka.a.getWidgetUid(n)),g=i||Ka.a.canUserModifyWidgets(u);let f;if(u&&cn()&&on.a.JITSI.matches(n.type)){const e=async()=>{try{await dn(p,u)}catch(e){Oa.a.error("Failed to start livestream",e);const t=e.message||Object(N.b)("Unable to start audio streaming.");z.b.createDialog(sn.a,{title:Object(N.b)("Failed to start livestream"),description:t})}a()};f=o.a.createElement(he.b,{onClick:e,label:Object(N.b)("Start audio stream")})}const E=h?rn.d.instance.getContainerWidgets(h,rn.a.Top):[],y=E.findIndex((e=>e.id===n.id));let _,S;if(g&&Ka.a.isManagedByManager(n)){const e=()=>{l?l():h&&Ka.a.editWidget(h,n),a()};_=o.a.createElement(he.b,{onClick:e,label:Object(N.b)("Edit")})}if(v.b.getValue("enableWidgetScreenshots")&&null!=p&&p.hasCapability(tn.MatrixCapabilities.Screenshots)){const e=()=>{null==p||p.takeScreenshot().then((e=>{b.a.dispatch({action:"picture_snapshot",file:e.screenshot})})).catch((e=>{Oa.a.error("Failed to take screenshot: ",e)})),a()};S=o.a.createElement(he.b,{onClick:e,label:Object(N.b)("Take a picture")})}let w;if(r||g){const e=()=>{r?r():u&&z.b.createDialog(it.a,{title:Object(N.b)("Delete Widget"),description:Object(N.b)("Deleting a widget removes it for all users in this room. Are you sure you want to delete this widget?"),button:Object(N.b)("Delete widget"),onFinished:e=>{e&&Ka.a.setRoomWidget(u,n.id)}}),a()};w=o.a.createElement(he.b,{onClick:e,label:i?Object(N.b)("Remove"):Object(N.b)("Remove for everyone")})}const O=void 0!==n.eventId&&null!==(t=v.b.getValue("allowedWidgets",u)[n.eventId])&&void 0!==t&&t||n.creatorUserId===m.getUserId(),C=on.a.JITSI.matches(n.type);let x,j,k;if(!i&&!C&&O){const e={approved:void 0};if(mn.a.instance.invoke(an.WidgetLifecycle.PreLoadRequest,e,new Hn(n)),!e.approved){const e=()=>{Oa.a.info("Revoking permission for widget to load: "+n.eventId);const e=v.b.getValue("allowedWidgets",u);void 0!==n.eventId&&(e[n.eventId]=!1);const t=v.b.firstSupportedLevel("allowedWidgets");if(!t)throw new Error("level must be defined");v.b.setValue("allowedWidgets",null!=u?u:null,t,e).catch((e=>{Oa.a.error(e)})),a()};x=o.a.createElement(he.b,{onClick:e,label:Object(N.b)("Revoke permissions")})}}if(c&&y>0){const e=()=>{if(!h)throw new Error("room must be defined");rn.d.instance.moveWithinContainer(h,rn.a.Top,n,-1),a()};j=o.a.createElement(he.b,{onClick:e,label:Object(N.b)("Move left")})}if(c&&y<E.length-1){const e=()=>{if(!h)throw new Error("room must be defined");rn.d.instance.moveWithinContainer(h,rn.a.Top,n,1),a()};k=o.a.createElement(he.b,{onClick:e,label:Object(N.b)("Move right")})}return o.a.createElement(he.e,Z()({},d,{chevronFace:de.a.None,onFinished:a}),o.a.createElement(he.c,null,f,_,x,w,S,j,k))},$n=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250;const[a,n]=Object(s.useState)(e.getJoinedMemberCount());return Object(ie.c)(e.currentState,m.b.Update,Object(j.throttle)((()=>{n(e.getJoinedMemberCount())}),t,{leading:!0,trailing:!0})),a},Yn=e=>{const[t,a]=Object(s.useState)(e.getMyMembership());return Object(ie.c)(e,te.d.MyMembership,(()=>{a(e.getMyMembership())})),t};var Jn=a(667),Qn=a(959),Xn=a(960),Zn=a(135),ei=a(189);class ti{static isPinnable(e){return!!e&&(!!this.pinnableEventTypes.includes(e.getType())&&!e.isRedacted())}}i()(ti,"pinnableEventTypes",[ee.b.RoomMessage,ei.e.name,ei.e.altName]);var ai=a(256),ni=a(1002),ii=a(175),si=a(165),oi=a(218);class ri extends o.a.Component{constructor(){super(...arguments),i()(this,"context",void 0),i()(this,"onTileClicked",(()=>{b.a.dispatch({action:L.a.ViewRoom,event_id:this.props.event.getId(),highlighted:!0,room_id:this.props.event.getRoomId(),metricsTrigger:void 0})})),i()(this,"relations",new Map),i()(this,"getRelationsForEvent",((e,t,a)=>{var n;if(e===this.props.event.getId())return null===(n=this.relations.get(t))||void 0===n?void 0:n.get(a)}))}render(){var e;const t=this.props.event.getSender(),a=this.props.event.getRoomId(),n=this.context.getRoom(a);let i;return this.props.onUnpinClicked&&(i=o.a.createElement(q.a,{onClick:this.props.onUnpinClicked,className:"mx_PinnedEventTile_unpinButton",title:Object(N.b)("Unpin")})),o.a.createElement("div",{className:"mx_PinnedEventTile"},o.a.createElement(ii.b,{className:"mx_PinnedEventTile_senderAvatar",member:this.props.event.sender,width:24,height:24,fallbackUserId:t}),o.a.createElement("span",{className:"mx_PinnedEventTile_sender "+Object(oi.f)(this.props.userNameColorMode,t,n)},(null===(e=this.props.event.sender)||void 0===e?void 0:e.name)||t),i,o.a.createElement("div",{className:"mx_PinnedEventTile_message"},o.a.createElement(ni.a,{mxEvent:this.props.event,getRelationsForEvent:this.getRelationsForEvent,className:"mx_PinnedEventTile_body",maxImageHeight:150,onHeightChanged:()=>{},permalinkCreator:this.props.permalinkCreator,replacingEventId:this.props.event.replacingEventId()})),o.a.createElement("div",{className:"mx_PinnedEventTile_footer"},o.a.createElement("span",{className:"mx_MessageTimestamp mx_PinnedEventTile_timestamp"},Object(si.a)(new Date(this.props.event.getTs()))),o.a.createElement(K.a,{onClick:this.onTileClicked,kind:"link"},Object(N.b)("View message"))))}}i()(ri,"contextType",R.a);var li=a(321),ci=a(825);function di(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function mi(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?di(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):di(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function hi(e){var t,a,n;return null!==(t=null==e||null===(a=e.currentState.getStateEvents(ee.b.RoomPinnedEvents,""))||void 0===a||null===(n=a.getContent())||void 0===n?void 0:n.pinned)&&void 0!==t?t:[]}const ui=e=>{const[t,a]=Object(s.useState)(hi(e)),n=Object(s.useCallback)((t=>{t&&t.getType()!==ee.b.RoomPinnedEvents||a(hi(e))}),[e]);return Object(ie.c)(null==e?void 0:e.currentState,m.b.Events,n),Object(s.useEffect)((()=>(a(hi(e)),()=>{a([])})),[e]),t};function pi(e){var t,a,n;return new Set(null!==(t=null==e||null===(a=e.getAccountData(ci.a))||void 0===a||null===(n=a.getContent())||void 0===n?void 0:n.event_ids)&&void 0!==t?t:[])}const gi=e=>{const[t,a]=Object(s.useState)(new Set),n=Object(s.useCallback)((t=>{t&&t.getType()!==ci.a||a(pi(e))}),[e]);return Object(ie.c)(e,te.d.AccountData,n),Object(s.useEffect)((()=>(a(pi(e)),()=>{a(new Set)})),[e]),t};var bi=e=>{let{room:t,onClose:a,userNameColorMode:n,permalinkCreator:i}=e;const r=Object(s.useContext)(R.a),l=Object(s.useContext)(en.b),c=Object(li.a)(t,(e=>e.mayClientSendStateEvent(ee.b.RoomPinnedEvents,r))),d=ui(t),m=gi(t);Object(s.useEffect)((()=>{d.filter((e=>!m.has(e))).length>0&&(null==r||r.setRoomAccountData(t.roomId,ci.a,{event_ids:d}))}),[r,t.roomId,d,m]);const h=Object(ai.a)((()=>{const e=d.map((async e=>{var a;const n=t.getUnfilteredTimelineSet(),i=null==n||null===(a=n.getTimelineForEvent(e))||void 0===a?void 0:a.getEvents().find((t=>t.getId()===e));if(i)return ti.isPinnable(i)?i:null;try{const[a,{events:[n]}]=await Promise.all([r.fetchRoomEvent(t.roomId,e),r.relations(t.roomId,e,ee.h.Replace,null,{limit:1})]),i=new ja.b(a);i.isEncrypted()&&await r.decryptEventIfNeeded(i),await t.processPollEvents([i]);const s=i.getSender();if(s&&ti.isPinnable(i))return i.sender=t.getMember(s),n&&i.makeReplaced(n),i}catch(a){Oa.a.error("Error looking up pinned event "+e+" in room "+t.roomId),Oa.a.error(a)}return null}));return Promise.all(e)}),[r,t,d],null);let u;if(d.length)if(null!=h&&h.length){const e=async e=>{var a;const n=t.currentState.getStateEvents(ee.b.RoomPinnedEvents,"");if(null!=n&&null!==(a=n.getContent())&&void 0!==a&&a.pinned){const a=n.getContent().pinned,i=a.indexOf(e.getId());-1!==i&&(a.splice(i,1),await r.sendStateEvent(t.roomId,ee.b.RoomPinnedEvents,{pinned:a},""))}};u=Object(un.n)(h).reverse().map((t=>o.a.createElement(ri,{key:t.getId(),event:t,onUnpinClicked:c?()=>e(t):void 0,userNameColorMode:n,permalinkCreator:i})))}else u=o.a.createElement(Zn.a,null);else u=o.a.createElement("div",{className:"mx_PinnedMessagesCard_empty_wrapper"},o.a.createElement("div",{className:"mx_PinnedMessagesCard_empty"},o.a.createElement("div",{className:"mx_MessageActionBar mx_PinnedMessagesCard_MessageActionBar"},o.a.createElement("div",{className:"mx_MessageActionBar_iconButton"},o.a.createElement(Qn.a,null)),o.a.createElement("div",{className:"mx_MessageActionBar_iconButton"},o.a.createElement(Xn.a,null)),o.a.createElement("div",{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_optionsButton"},o.a.createElement(Jn.a,null))),o.a.createElement(ua.a,{size:"h4",className:"mx_PinnedMessagesCard_empty_header"},Object(N.b)("Nothing pinned, yet")),Object(N.b)("If you have permissions, open the menu on any message and select <b>Pin</b> to stick them here.",{},{b:e=>o.a.createElement("b",null,e)})));return o.a.createElement(za,{header:o.a.createElement("div",{className:"mx_BaseCard_header_title"},o.a.createElement(ua.a,{size:"h4",className:"mx_BaseCard_header_title_heading"},Object(N.b)("Pinned messages"))),className:"mx_PinnedMessagesCard",onClose:a},o.a.createElement(en.b.Provider,{value:mi(mi({},l),{},{timelineRenderingType:en.a.Pinned})},u))},vi=a(290),fi=a(349),Ei=a(979),yi=a(204),_i=a(1696),Si=a(677),wi=a(243);class Oi extends Si.a{constructor(e,t,a,n){super(e,t,a,n),i()(this,"totalSize",0),i()(this,"messages",[])}get destinationFileName(){return this.makeFileNameNoExtension()+".json"}createJSONString(){var e,t,a,n,i,s,o;const r=Object(si.g)(new Date),l=null===(e=this.room.currentState.getStateEvents(ee.b.RoomCreate,""))||void 0===e?void 0:e.getSender(),c=l&&(null===(t=this.room)||void 0===t||null===(a=t.getMember(l))||void 0===a?void 0:a.rawDisplayName)||l,d=(null===(n=this.room.currentState.getStateEvents(ee.b.RoomTopic,""))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.topic)||"",m=this.client.getUserId(),h=(null===(s=this.room)||void 0===s||null===(o=s.getMember(m))||void 0===o?void 0:o.rawDisplayName)||m,u={room_name:this.room.name,room_creator:c,topic:d,export_date:r,exported_by:h,messages:this.messages};return JSON.stringify(u,null,2)}async getJSONString(e){if(this.exportOptions.attachmentsIncluded&&this.isAttachment(e))try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size<this.exportOptions.maxSize){this.totalSize+=t.size;const a=this.getFilePath(e);this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1),this.addFile(a,t)}}catch(e){Oa.a.log("Error fetching file: "+e)}const t=e.toJSON();return e.isEncrypted()?t.decrypted:t}async createOutput(e){for(let t=0;t<e.length;t++){const a=e[t];if(this.updateProgress(Object(N.b)("Processing event %(number)s out of %(total)s",{number:t+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();Object(wi.c)(a,!1)&&this.messages.push(await this.getJSONString(a))}return this.createJSONString()}async export(){Oa.a.info("Starting export process..."),Oa.a.info("Fetching events...");const e=performance.now(),t=await this.getRequiredEvents(),a=performance.now();Oa.a.log(`Fetched ${t.length} events in ${(a-e)/1e3}s`),Oa.a.info("Creating output...");const n=await this.createOutput(t);if(this.files.length)this.addFile("export.json",new Blob([n])),await this.downloadZIP();else{const e=this.destinationFileName;this.downloadPlainText(e,n)}const i=performance.now();this.cancelled?Oa.a.info("Export cancelled successfully"):(Oa.a.info("Export successful!"),Oa.a.log(`Exported ${t.length} events in ${(i-e)/1e3} seconds`)),this.cleanUp()}}var Ci=a(303);class xi extends Si.a{constructor(e,t,a,n){super(e,t,a,n),i()(this,"totalSize",void 0),i()(this,"mediaOmitText",void 0),i()(this,"textForReplyEvent",(e=>{const t=/> <(.*?)>(.*?)\n\n(.*)/s.exec(e.body);if(!t)return e.body;let a;const n=t[1],i=t[3];a=t[2].substring(1);const s=a.split("\n").filter((e=>!/^\s*$/.test(e)));return s.length>0?(a=s[0].substring(0,32),s[0].length>32&&(a+="..."),a=` "${a}"`):a="",`<${n}${a}> ${i}`})),i()(this,"plainTextForEvent",(async e=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let a="";if(this.isAttachment(e))if(this.exportOptions.attachmentsIncluded)try{const t=await this.getMediaBlob(e);if(this.totalSize+t.size>this.exportOptions.maxSize)a=` (${this.mediaOmitText})`;else{this.totalSize+=t.size;const n=this.getFilePath(e);a=" ("+Object(N.b)("File Attached")+")",this.addFile(n,t),this.totalSize==this.exportOptions.maxSize&&(this.exportOptions.attachmentsIncluded=!1)}}catch(e){a=" ("+Object(N.b)("Error fetching file")+")",Oa.a.log("Error fetching file "+e)}else a=` (${this.mediaOmitText})`;return this.isReply(e)?t+": "+this.textForReplyEvent(e.getContent())+a:Object(Ci.b)(e)+a})),this.totalSize=0,this.mediaOmitText=this.exportOptions.attachmentsIncluded?Object(N.b)("Media omitted - file size limit exceeded"):Object(N.b)("Media omitted")}get destinationFileName(){return this.makeFileNameNoExtension()+".txt"}async createOutput(e){let t="";for(let a=0;a<e.length;a++){const n=e[a];if(this.updateProgress(Object(N.b)("Processing event %(number)s out of %(total)s",{number:a+1,total:e.length}),!1,!0),this.cancelled)return this.cleanUp();if(!Object(wi.c)(n,!1))continue;const i=await this.plainTextForEvent(n);t+=i&&`${new Date(n.getTs()).toLocaleString()} - ${i}\n`}return t}async export(){this.updateProgress(Object(N.b)("Starting export process…")),this.updateProgress(Object(N.b)("Fetching events…"));const e=performance.now(),t=await this.getRequiredEvents(),a=performance.now();Oa.a.log(`Fetched ${t.length} events in ${(a-e)/1e3}s`),this.updateProgress(Object(N.b)("Creating output…"));const n=await this.createOutput(t);if(this.files.length)this.addFile("export.txt",new Blob([n])),await this.downloadZIP();else{const e=this.destinationFileName;this.downloadPlainText(e,n)}const i=performance.now();this.cancelled?Oa.a.info("Export cancelled successfully"):(Oa.a.info("Export successful!"),Oa.a.log(`Exported ${t.length} events in ${(i-e)/1e3} seconds`)),this.cleanUp()}}var ji=()=>({});const ki=(e,t)=>a=>"number"==typeof a&&!(isNaN(a)||e>a||a>t);var Ri=e=>{let{room:t,onFinished:a}=e;const{exportFormat:n,exportType:i,includeAttachments:r,numberOfMessages:l,sizeLimit:c,setExportFormat:d,setExportType:m,setNumberOfMessages:h,setSizeLimit:u,setAttachments:p}=(()=>{var e,t,a,n,i;const o=ji(),[r,l]=Object(s.useState)(null!==(e=o.format)&&void 0!==e?e:Ei.a.Html),[c,d]=Object(s.useState)(null!==(t=o.range)&&void 0!==t?t:Ei.b.Timeline),[m,h]=Object(s.useState)(null!==(a=o.includeAttachments)&&void 0!==a&&a),[u,p]=Object(s.useState)(null!==(n=o.numberOfMessages)&&void 0!==n?n:100),[g,b]=Object(s.useState)(null!==(i=o.sizeMb)&&void 0!==i?i:8);return{exportFormat:r,exportType:c,includeAttachments:m,numberOfMessages:u,sizeLimit:g,setExportFormat:o.format?void 0:l,setExportType:o.range?void 0:d,setNumberOfMessages:o.numberOfMessages?void 0:p,setSizeLimit:o.sizeMb?void 0:b,setAttachments:void 0===o.includeAttachments?h:void 0}})(),[g,b]=Object(s.useState)(!1),v=Object(s.useRef)(null),f=Object(s.useRef)(null),[E,y]=Object(s.useState)(Object(N.b)("Processing…")),[_,S]=Object(s.useState)(!1),[w,O]=Object(s.useState)(!1),[C,x]=Object(s.useState)(!1),[j,k]=((e,t)=>{const[a,n]=Object(s.useState)(e);return[a,e=>{n(e),t(e)}]})(null,(async e=>{await(null==e?void 0:e.export().then((()=>{w||x(!0)})))})),R=async()=>{var e;if(!u||await(null===(e=v.current)||void 0===e?void 0:e.validate({focused:!1}))){if(i===Ei.b.LastNMessages){var a;var s;if(!await(null===(a=f.current)||void 0===a?void 0:a.validate({focused:!1})))return void(null===(s=f.current)||void 0===s||s.validate({focused:!0}))}b(!0),await(async()=>{const e={numberOfMessages:l,attachmentsIncluded:r,maxSize:1024*c*1024};switch(n){case Ei.a.Html:k(new _i.a(t,Ei.b[i],e,y));break;case Ei.a.Json:k(new Oi(t,Ei.b[i],e,y));break;case Ei.a.PlainText:k(new xi(t,Ei.b[i],e,y));break;default:return void Oa.a.error("Unknown export format")}})()}else{var o;null===(o=v.current)||void 0===o||o.validate({focused:!0})}},I=Object(yi.a)({rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(N.b)("Enter a number between %(min)s and %(max)s",{min:1,max:2e3})},{key:"number",test:e=>{let{value:t}=e;const a=parseInt(t,10);return ki(1,2e3)(a)},invalid:()=>Object(N.b)("Size can only be a number between %(min)s MB and %(max)s MB",{min:1,max:2e3})}]}),T=async e=>await I(e),P=Object(yi.a)({rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(N.b)("Enter a number between %(min)s and %(max)s",{min:1,max:10**8})},{key:"number",test:e=>{let{value:t}=e;const a=parseInt(t,10);return ki(1,10**8)(a)},invalid:()=>Object(N.b)("Number of messages can only be a number between %(min)s and %(max)s",{min:1,max:10**8})}]}),D=async e=>await P(e),M=async()=>{g?S(!0):a(!1)},A=async()=>{await(null==j?void 0:j.cancelExport()),O(!0),b(!1),k(null)},U=Object.values(Ei.a).map((e=>({value:e,label:Object(Ei.c)(e)}))),L=Object.values(Ei.b).map((e=>o.a.createElement("option",{key:Ei.b[e],value:e},Object(Ei.d)(e))));let F;i===Ei.b.LastNMessages&&h&&(F=o.a.createElement(st.a,{id:"message-count",element:"input",type:"number",value:l.toString(),ref:f,onValidate:D,label:Object(N.b)("Number of messages"),onChange:e=>{h(parseInt(e.target.value))}}));const B=o.a.createElement("span",null,Object(N.b)("MB"));return w?o.a.createElement(lt.a,{title:Object(N.b)("Export Cancelled"),description:Object(N.b)("The export was cancelled successfully"),hasCloseButton:!0,onFinished:a}):C?o.a.createElement(lt.a,{title:Object(N.b)("Export Successful"),description:Object(N.b)("Your export was successful. Find it in your Downloads folder."),hasCloseButton:!0,onFinished:a}):_?o.a.createElement(bn.a,{title:Object(N.b)("Warning"),className:"mx_ExportDialog",contentId:"mx_Dialog_content",onFinished:a,fixedWidth:!0},o.a.createElement("p",null,Object(N.b)("Are you sure you want to stop exporting your data? If you do, you'll need to start over.")),o.a.createElement(vn.a,{primaryButton:Object(N.b)("Stop"),primaryButtonClass:"danger",hasCancel:!0,cancelButton:Object(N.b)("Continue"),onCancel:()=>S(!1),onPrimaryButtonClick:A})):o.a.createElement(bn.a,{title:g?Object(N.b)("Exporting your data"):Object(N.b)("Export Chat"),className:`mx_ExportDialog ${g&&"mx_ExportDialog_Exporting"}`,contentId:"mx_Dialog_content",hasCancel:!0,onFinished:a,fixedWidth:!0},g?null:o.a.createElement("p",null,Object(N.b)("Select from the options below to export chats from your timeline")),o.a.createElement("div",{className:"mx_ExportDialog_options"},!!d&&o.a.createElement(o.a.Fragment,null,o.a.createElement("span",{className:"mx_ExportDialog_subheading"},Object(N.b)("Format")),o.a.createElement(fi.a,{name:"exportFormat",value:n,onChange:e=>d(Ei.a[e]),definitions:U})),!!m&&o.a.createElement(o.a.Fragment,null,o.a.createElement("span",{className:"mx_ExportDialog_subheading"},Object(N.b)("Messages")),o.a.createElement(st.a,{id:"export-type",element:"select",value:i,onChange:e=>{m(Ei.b[e.target.value])}},L),F),u&&o.a.createElement(o.a.Fragment,null,o.a.createElement("span",{className:"mx_ExportDialog_subheading"},Object(N.b)("Size Limit")),o.a.createElement(st.a,{id:"size-limit",type:"number",autoComplete:"off",onValidate:T,element:"input",ref:v,value:c.toString(),postfixComponent:B,onChange:e=>u(parseInt(e.target.value))})),p&&o.a.createElement(o.a.Fragment,null,o.a.createElement(Ue.b,{className:"mx_ExportDialog_attachments-checkbox",id:"include-attachments",checked:r,onChange:e=>p(e.target.checked)},Object(N.b)("Include Attachments")))),g?o.a.createElement("div",{"data-testid":"export-progress",className:"mx_ExportDialog_progress"},o.a.createElement(Zn.a,{w:24,h:24}),o.a.createElement("p",null,E),o.a.createElement(vn.a,{primaryButton:Object(N.b)("Cancel"),primaryButtonClass:"danger",hasCancel:!1,onPrimaryButtonClick:M})):o.a.createElement(vn.a,{primaryButton:Object(N.b)("Export"),onPrimaryButtonClick:R,onCancel:()=>a(!1)}))},Ii=a(1004);const Ti=e=>{let{room:t,matrixClient:a,permalinkCreator:n,onFinished:i}=e;return o.a.createElement(bn.a,{onFinished:i},o.a.createElement(Ii.a,{room:t,matrixClient:a,permalinkCreator:n,onFinished:i}))},Ni=["children","className","onClick"],Pi=e=>{let{children:t,className:a,onClick:n}=e,i=ve()(e,Ni);return o.a.createElement(K.a,Z()({},i,{className:c()("mx_BaseCard_Button mx_RoomSummaryCard_Button",a),onClick:n}),t)},Di=e=>{const[t,a]=Object(s.useState)((()=>Qa.a.instance.getApps(e.roomId))),n=Object(s.useCallback)((()=>{a([...Qa.a.instance.getApps(e.roomId)])}),[e]);return Object(s.useEffect)(n,[e,n]),Object(ie.a)(Qa.a.instance,e.roomId,n),Object(ie.a)(rn.d.instance,rn.d.emissionForRoom(e),n),t},Mi=e=>{let{app:t,room:a}=e;const n=Ka.a.getWidgetName(t),i=Ka.a.getWidgetDataTitle(t),r=i&&" - "+i,[l,d]=Object(s.useState)();Object(s.useEffect)((()=>{d(Ka.a.canUserModifyWidgets(a.roomId))}),[a.roomId]);const m=rn.d.instance.isInContainer(a,t,rn.a.Top),h=m?()=>{rn.d.instance.moveToContainer(a,t,rn.a.Right)}:()=>{rn.d.instance.moveToContainer(a,t,rn.a.Top)},[u,p,g,b]=Object(de.q)();let v;if(u){var f,E,y;const e=null===(f=p.current)||void 0===f?void 0:f.getBoundingClientRect(),a=null!==(E=null==e?void 0:e.right)&&void 0!==E?E:0,n=null!==(y=null==e?void 0:e.top)&&void 0!==y?y:0;v=o.a.createElement(qn,{chevronFace:de.a.None,right:Q.b.instance.windowWidth-a,bottom:Q.b.instance.windowHeight-n,onFinished:b,app:t})}const _=!m&&!rn.d.instance.canAddToContainer(a,rn.a.Top);let S;S=_?Object(N.b)("You can only pin up to %(count)s widgets",{count:rn.b}):m?Object(N.b)("Unpin"):Object(N.b)("Pin");const w=rn.d.instance.isInContainer(a,t,rn.a.Center),O=w?()=>{rn.d.instance.moveToContainer(a,t,rn.a.Right)}:()=>{rn.d.instance.moveToContainer(a,t,rn.a.Center)},C=w?Object(N.b)("Close"):Object(N.b)("Maximise");let x="";m?x=Object(N.b)("Unpin this widget to view it in this panel"):w&&(x=Object(N.b)("Close this widget to view it in this panel"));const j=c()("mx_BaseCard_Button mx_RoomSummaryCard_Button",{mx_RoomSummaryCard_Button_pinned:m,mx_RoomSummaryCard_Button_maximised:w});return o.a.createElement("div",{className:j,ref:p},o.a.createElement(q.a,{className:"mx_RoomSummaryCard_icon_app",onClick:()=>{Fa.a.instance.pushCard({phase:La.a.Widget,state:{widgetId:t.id}})},title:x,forceHide:!(m||w),disabled:m||w},o.a.createElement(Ja,{app:t}),o.a.createElement("span",null,n),r),l&&o.a.createElement(de.c,{className:"mx_RoomSummaryCard_app_options",isExpanded:u,onClick:g,title:Object(N.b)("Options")}),o.a.createElement(q.a,{className:"mx_RoomSummaryCard_app_pinToggle",onClick:h,title:S,disabled:_}),o.a.createElement(q.a,{className:"mx_RoomSummaryCard_app_maximiseToggle",onClick:O,title:C}),v)},Ai=e=>{let{room:t}=e;const a=Di(t),n=Object(s.useMemo)((()=>a.filter((e=>void 0!==e.eventId))),[a]);let i=null;return n.length>0&&rn.d.instance.canCopyLayoutToRoom(t)&&(i=o.a.createElement(K.a,{kind:"link",onClick:()=>rn.d.instance.copyLayoutToRoom(t)},Object(N.b)("Set my room layout for everyone"))),o.a.createElement(Wa,{className:"mx_RoomSummaryCard_appsGroup",title:Object(N.b)("Widgets")},n.map((e=>o.a.createElement(Mi,{key:e.id,app:e,room:t}))),i,o.a.createElement(K.a,{kind:"link",onClick:()=>{const e=Ga.a.sharedInstance();var a;e.hasManager()?null===(a=e.getPrimaryManager())||void 0===a||a.open(t):e.openNoManagerDialog()}},n.length>0?Object(N.b)("Edit widgets, bridges & bots"):Object(N.b)("Add widgets, bridges & bots")))},Ui=e=>{Fa.a.instance.pushCard({phase:La.a.RoomMemberList},!0),re.b.trackInteraction("WebRightPanelRoomInfoPeopleButton",e)},Li=()=>{Fa.a.instance.pushCard({phase:La.a.FilePanel},!0)},Fi=()=>{Fa.a.instance.pushCard({phase:La.a.PinnedMessages},!0)},Bi=e=>{b.a.dispatch({action:"open_room_settings"}),re.b.trackInteraction("WebRightPanelRoomInfoSettingsButton",e)};var Vi=e=>{var t;let{room:a,permalinkCreator:n,onClose:i}=e;const r=Object(s.useContext)(R.a),l=Ba(r,a),d=Object(s.useContext)(en.b).e2eStatus,m=Object(se.a)("feature_video_rooms"),h=Object(se.a)("feature_element_call_video_rooms"),u=m&&(a.isElementVideoRoom()||h&&a.isCallRoom()),p=a.getCanonicalAlias()||a.getAltAliases()[0]||"",g=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_RoomSummaryCard_avatar",role:"presentation"},o.a.createElement(ye.a,{room:a,height:54,width:54,viewAvatarOnClick:!0}),o.a.createElement(qa.a,{tooltip:l?Object(N.b)("Encrypted"):Object(N.b)("Not encrypted"),class:c()("mx_RoomSummaryCard_e2ee",{mx_RoomSummaryCard_e2ee_normal:l,mx_RoomSummaryCard_e2ee_warning:l&&d===Za.Warning,mx_RoomSummaryCard_e2ee_verified:l&&d===Za.Verified})})),o.a.createElement(vi.a,{room:a},(e=>o.a.createElement("h2",{title:e},e))),o.a.createElement("div",{className:"mx_RoomSummaryCard_alias",title:p},p)),b=$n(a),f=Object(se.a)("feature_pinning"),E=null===(t=ui(f?a:void 0))||void 0===t?void 0:t.length;return o.a.createElement(za,{header:g,className:"mx_RoomSummaryCard",onClose:i},o.a.createElement(Wa,{title:Object(N.b)("About"),className:"mx_RoomSummaryCard_aboutGroup"},o.a.createElement(Pi,{className:"mx_RoomSummaryCard_icon_people",onClick:Ui},Object(N.b)("People"),o.a.createElement("span",{className:"mx_BaseCard_Button_sublabel"},b)),!u&&o.a.createElement(Pi,{className:"mx_RoomSummaryCard_icon_files",onClick:Li},Object(N.b)("Files")),!u&&o.a.createElement(Pi,{className:"mx_RoomSummaryCard_icon_poll",onClick:()=>{z.b.createDialog(Ti,{room:a,matrixClient:r,permalinkCreator:n})}},Object(N.b)("Poll history")),f&&!u&&o.a.createElement(Pi,{className:"mx_RoomSummaryCard_icon_pins",onClick:Fi},Object(N.b)("Pinned"),E>0&&o.a.createElement("span",{className:"mx_BaseCard_Button_sublabel"},E)),!u&&o.a.createElement(Pi,{className:"mx_RoomSummaryCard_icon_export",onClick:async()=>{z.b.createDialog(Ri,{room:a})}},Object(N.b)("Export chat")),o.a.createElement(Pi,{"data-testid":"shareRoomButton",className:"mx_RoomSummaryCard_icon_share",onClick:()=>{z.b.createDialog(Ha.a,{target:a})}},Object(N.b)("Share room")),o.a.createElement(Pi,{className:"mx_RoomSummaryCard_icon_settings",onClick:Bi},Object(N.b)("Room settings"))),v.b.getValue(le.b.Widgets)&&!u&&Object(ae.a)(le.a.AddIntegrations)&&o.a.createElement(Ai,{room:a}))},Wi=a(262),zi=a.n(Wi);function Hi(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}class Ki extends o.a.Component{constructor(e){super(e);const t=this.parseWidgetUrl(),a=oe.a.get().getRoom(this.props.roomId);let n;a&&(n=a.getMember(this.props.creatorUserId)),this.state=function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Hi(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Hi(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({roomMember:n},t)}parseWidgetUrl(){var e;const t=zi.a.parse(this.props.url),a=new URLSearchParams(null!==(e=t.search)&&void 0!==e?e:void 0);if(Ka.a.isScalarUrl(this.props.url)&&null!=a&&a.get("url")){const e=zi.a.parse(a.get("url"));return{widgetDomain:e.host||e.hostname,isWrapped:!0}}return{widgetDomain:t.host||t.hostname,isWrapped:!1}}render(){const e=ot.b.get().brand,t=this.state.roomMember?this.state.roomMember.name:this.props.creatorUserId,a=t===this.props.creatorUserId?null:this.props.creatorUserId,n=this.state.roomMember?o.a.createElement(ii.b,{member:this.state.roomMember,width:38,height:38}):o.a.createElement(yt.a,{name:this.props.creatorUserId,width:38,height:38}),i=o.a.createElement("div",null,Object(N.b)("Any of the following data may be shared:"),o.a.createElement("ul",null,o.a.createElement("li",null,Object(N.b)("Your display name")),o.a.createElement("li",null,Object(N.b)("Your avatar URL")),o.a.createElement("li",null,Object(N.b)("Your user ID")),o.a.createElement("li",null,Object(N.b)("Your theme")),o.a.createElement("li",null,Object(N.b)("%(brand)s URL",{brand:e})),o.a.createElement("li",null,Object(N.b)("Room ID")),o.a.createElement("li",null,Object(N.b)("Widget ID")))),s=o.a.createElement(qa.a,{tooltip:i,tooltipClass:"mx_AppPermissionWarning_tooltip mx_Tooltip_dark"},o.a.createElement("span",{className:"mx_AppPermissionWarning_helpIcon"})),r=this.state.isWrapped?Object(N.b)("Using this widget may share data <helpIcon /> with %(widgetDomain)s & your integration manager.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>s}):Object(N.b)("Using this widget may share data <helpIcon /> with %(widgetDomain)s.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>s}),l=this.props.isRoomEncrypted?Object(N.b)("Widgets do not use message encryption."):null;return o.a.createElement("div",{className:"mx_AppPermissionWarning"},o.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_bolder mx_AppPermissionWarning_smallText"},Object(N.b)("Widget added by")),o.a.createElement("div",{className:"mx_AppPermissionWarning_row"},n,o.a.createElement("h4",{className:"mx_AppPermissionWarning_bolder"},t),o.a.createElement("div",{className:"mx_AppPermissionWarning_smallText"},a)),o.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},r),o.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},Object(N.b)("This widget may use cookies.")," ",l),o.a.createElement("div",{className:"mx_AppPermissionWarning_row"},o.a.createElement(K.a,{kind:"primary_sm",onClick:this.props.onPermissionGranted},Object(N.b)("Continue"))))}}i()(Ki,"defaultProps",{onPermissionGranted:()=>{}});var Gi=e=>o.a.createElement("div",{className:"mx_AppPermissionWarning"},o.a.createElement("div",{className:"mx_AppPermissionWarningImage"},o.a.createElement("img",{src:a(646).default,alt:""})),o.a.createElement("div",{className:"mx_AppPermissionWarningText"},o.a.createElement("span",{className:"mx_AppPermissionWarningTextLabel"},e.errorMsg||"Error")));function qi(e){return document.getElementById(e)}class $i extends o.a.Component{constructor(e){super(e),i()(this,"resizeObserver",void 0),i()(this,"dispatcherRef",void 0),i()(this,"childContainer",void 0),i()(this,"child",void 0),i()(this,"collectChildContainer",(e=>{this.childContainer&&this.resizeObserver.unobserve(this.childContainer),this.childContainer=e,e&&this.resizeObserver.observe(e)})),i()(this,"collectChild",(e=>{this.child=e,this.updateChild()})),i()(this,"onAction",(e=>{"timeline_resize"===e.action?this.repositionChild():"logout"===e.action&&$i.destroyElement(this.props.persistKey)})),i()(this,"repositionChild",(()=>{this.updateChildPosition(this.child,this.childContainer)})),this.resizeObserver=new ResizeObserver(this.repositionChild),window.addEventListener("resize",this.repositionChild),this.dispatcherRef=b.a.register(this.onAction),this.props.moveRef&&(this.props.moveRef.current=this.repositionChild)}static destroyElement(e){const t=qi("mx_persistedElement_"+e);t&&t.remove()}static isMounted(e){return Boolean(qi("mx_persistedElement_"+e))}componentDidMount(){this.updateChild(),this.renderApp()}componentDidUpdate(){this.updateChild(),this.renderApp()}componentWillUnmount(){this.updateChildVisibility(this.child,!1),this.resizeObserver.disconnect(),window.removeEventListener("resize",this.repositionChild),b.a.unregister(this.dispatcherRef)}updateChild(){this.updateChildPosition(this.child,this.childContainer),this.updateChildVisibility(this.child,!0)}renderApp(){const e=o.a.createElement(R.a.Provider,{value:oe.a.get()},o.a.createElement("div",{ref:this.collectChild,style:this.props.style},this.props.children));qt.a.render(e,function(e){let t=qi(e);return t||(t=document.createElement("div"),t.id=e,document.body.appendChild(t)),t}("mx_persistedElement_"+this.props.persistKey))}updateChildVisibility(e,t){e&&(e.style.display=t?"block":"none")}updateChildPosition(e,t){if(!e||!t)return;const a=t.getBoundingClientRect();Object.assign(e.style,{zIndex:Object(En.u)(this.props.zIndex)?9:this.props.zIndex,position:"absolute",top:"0",left:"0",transform:`translateX(${a.left}px) translateY(${a.top}px)`,width:a.width+"px",height:a.height+"px"})}render(){return o.a.createElement("div",{ref:this.collectChildContainer})}}function Yi(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Ji(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Yi(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Yi(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Qi extends o.a.Component{constructor(e){super(e),i()(this,"context",void 0),i()(this,"contextMenuButton",Object(s.createRef)()),i()(this,"iframe",void 0),i()(this,"allowedWidgetsWatchRef",void 0),i()(this,"persistKey",void 0),i()(this,"sgWidget",void 0),i()(this,"dispatcherRef",void 0),i()(this,"unmounted",void 0),i()(this,"watchUserReady",(()=>{ft.a.instance.isProfileInfoFetched||ft.a.instance.once(Et.b,this.onUserReady)})),i()(this,"onUserReady",(()=>{this.setState({isUserProfileReady:!0})})),i()(this,"hasPermissionToLoad",(e=>{var t;if(this.usingLocalWidget())return!0;if(!e.room)return!0;const a={approved:void 0};if(mn.a.instance.invoke(an.WidgetLifecycle.PreLoadRequest,a,new Hn(this.props.app)),a.approved)return!0;const n=v.b.getValue("allowedWidgets",e.room.roomId);return void 0!==e.app.eventId&&null!==(t=n[e.app.eventId])&&void 0!==t&&t||e.userId===e.creatorUserId})),i()(this,"onMyMembership",((e,t)=>{var a;"leave"!==t&&"ban"!==t||e.roomId!==(null===(a=this.props.room)||void 0===a?void 0:a.roomId)||this.onUserLeftRoom()})),i()(this,"onAllowedWidgetsChange",(()=>{const e=this.hasPermissionToLoad(this.props);var t;this.state.hasPermissionToLoad&&!e&&(Tn.b.instance.destroyPersistentWidget(this.props.app.id,this.props.app.roomId),$i.destroyElement(this.persistKey),null===(t=this.sgWidget)||void 0===t||t.stopMessaging());this.setState({hasPermissionToLoad:e})})),i()(this,"iframeRefChange",(e=>{this.iframe=e,this.unmounted||(e?this.startMessaging():this.resetWidget(this.props))})),i()(this,"onWidgetPreparing",(()=>{this.setState({loading:!1})})),i()(this,"onWidgetCapabilitiesNotified",(()=>{var e,t;this.setState({requiresClient:!(null===(e=this.sgWidget)||void 0===e||null===(t=e.widgetApi)||void 0===t||!t.hasCapability(_n.a.RequiresClient))})})),i()(this,"onAction",(e=>{var t,a,n;switch(e.action){case"m.sticker":e.widgetId===this.props.app.id&&null!==(t=this.sgWidget)&&void 0!==t&&null!==(a=t.widgetApi)&&void 0!==a&&a.hasCapability(tn.MatrixCapabilities.StickerSending)?(b.a.dispatch({action:"post_sticker_message",data:Ji(Ji({},e.data),{},{threadId:this.props.threadId})}),b.a.dispatch({action:"stickerpicker_close"})):Oa.a.warn("Ignoring sticker message. Invalid capability");break;case L.a.AfterLeaveRoom:e.room_id===(null===(n=this.props.room)||void 0===n?void 0:n.roomId)&&this.onUserLeftRoom()}})),i()(this,"grantWidgetPermission",(()=>{var e;const t=null===(e=this.props.room)||void 0===e?void 0:e.roomId;Oa.a.info("Granting permission for widget to load: "+this.props.app.eventId);const a=v.b.getValue("allowedWidgets",t);void 0!==this.props.app.eventId&&(a[this.props.app.eventId]=!0);const n=v.b.firstSupportedLevel("allowedWidgets");v.b.setValue("allowedWidgets",null!=t?t:null,n,a).then((()=>{this.setState({hasPermissionToLoad:!0}),this.startWidget()})).catch((e=>{Oa.a.error(e)}))})),i()(this,"onPopoutWidgetClick",(()=>{var e;on.a.JITSI.matches(this.props.app.type)&&this.reload(),Object.assign(document.createElement("a"),{target:"_blank",href:null===(e=this.sgWidget)||void 0===e?void 0:e.popoutUrl,rel:"noreferrer noopener"}).click()})),i()(this,"onToggleMaximisedClick",(()=>{if(!this.props.room)return;const e=rn.d.instance.isInContainer(this.props.room,this.props.app,rn.a.Center)?rn.a.Top:rn.a.Center;rn.d.instance.moveToContainer(this.props.room,this.props.app,e)})),i()(this,"onMinimiseClicked",(()=>{this.props.room&&rn.d.instance.moveToContainer(this.props.room,this.props.app,rn.a.Right)})),i()(this,"onContextMenuClick",(()=>{this.setState({menuDisplayed:!0})})),i()(this,"closeContextMenu",(()=>{this.setState({menuDisplayed:!1})})),this.props.miniMode||Tn.b.instance.dockWidget(this.props.app.id,this.props.app.roomId),this.persistKey="widget_"+Ka.a.getWidgetUid(this.props.app);try{this.sgWidget=new Kn(this.props),this.setupSgListeners()}catch(e){Oa.a.log("Failed to construct widget",e),this.sgWidget=null}this.state=this.getNewState(e)}onUserLeftRoom(){Tn.b.instance.getWidgetPersistence(this.props.app.id,this.props.app.roomId)&&(this.props.room&&at.b.instance.roomViewStore.getRoomId()!==this.props.room.roomId?this.endWidgetActions():on.a.JITSI.matches(this.props.app.type)?this.reload():Tn.b.instance.destroyPersistentWidget(this.props.app.id,this.props.app.roomId))}determineInitialRequiresClientState(){try{var e;const t=new Hn(this.props.app),a=nn.a.instance.getMessaging(t,null===(e=this.props.room)||void 0===e?void 0:e.roomId);if(a)return a.hasCapability(_n.a.RequiresClient)}catch{}return!0}getNewState(e){return{initialising:!0,loading:this.props.waitForIframeLoad&&!$i.isMounted(this.persistKey),hasPermissionToLoad:this.hasPermissionToLoad(e),isUserProfileReady:ft.a.instance.isProfileInfoFetched,error:null,menuDisplayed:!1,requiresClient:this.determineInitialRequiresClientState()}}isMixedContent(){const e=window.location.protocol,t=zi.a.parse(this.props.app.url).protocol;return"https:"===e&&"https:"!==t&&(Oa.a.warn("Refusing to load mixed-content app:",e,t,window.location,this.props.app.url),!0)}componentDidMount(){this.sgWidget&&this.state.hasPermissionToLoad&&this.startWidget(),this.watchUserReady(),this.props.room&&this.context.on(te.d.MyMembership,this.onMyMembership),this.allowedWidgetsWatchRef=v.b.watchSetting("allowedWidgets",null,this.onAllowedWidgetsChange),this.dispatcherRef=b.a.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,this.props.miniMode||Tn.b.instance.undockWidget(this.props.app.id,this.props.app.roomId),Tn.b.instance.isLive(this.props.app.id,this.props.app.roomId)||this.endWidgetActions(),this.dispatcherRef&&b.a.unregister(this.dispatcherRef),this.props.room&&this.context.off(te.d.MyMembership,this.onMyMembership),v.b.unwatchSetting(this.allowedWidgetsWatchRef),ft.a.instance.removeListener(Et.b,this.onUserReady)}setupSgListeners(){var e,t;null===(e=this.sgWidget)||void 0===e||e.on("preparing",this.onWidgetPreparing),null===(t=this.sgWidget)||void 0===t||t.on("capabilitiesNotified",this.onWidgetCapabilitiesNotified)}stopSgListeners(){this.sgWidget&&(this.sgWidget.off("preparing",this.onWidgetPreparing),this.sgWidget.off("capabilitiesNotified",this.onWidgetCapabilitiesNotified))}resetWidget(e){var t;null===(t=this.sgWidget)||void 0===t||t.stopMessaging(),this.stopSgListeners();try{this.sgWidget=new Kn(e),this.setupSgListeners(),this.startWidget()}catch(e){Oa.a.error("Failed to construct widget",e),this.sgWidget=null}}startWidget(){var e;null===(e=this.sgWidget)||void 0===e||e.prepare().then((()=>{this.unmounted||this.setState({initialising:!1})}))}startMessaging(){try{var e;null===(e=this.sgWidget)||void 0===e||e.startMessaging(this.iframe)}catch(e){Oa.a.error("Failed to start widget",e)}}componentDidUpdate(e){e.app.url!==this.props.app.url&&(this.getNewState(this.props),this.state.hasPermissionToLoad&&this.resetWidget(this.props))}async endWidgetActions(){var e;this.iframe&&(this.iframe.src="about:blank"),on.a.JITSI.matches(this.props.app.type)&&this.props.room&&B.b.instance.hangupCallApp(this.props.room.roomId),$i.destroyElement(this.persistKey),Tn.b.instance.destroyPersistentWidget(this.props.app.id,this.props.app.roomId),null===(e=this.sgWidget)||void 0===e||e.stopMessaging({forceDestroy:!0})}formatAppTileName(){let e="No name";return this.props.app.name&&this.props.app.name.trim()&&(e=this.props.app.name.trim()),e}usingLocalWidget(){return on.a.JITSI.matches(this.props.app.type)}getTileTitle(){const e=this.formatAppTileName(),t=o.a.createElement("span",null," - ");let a="";return this.props.widgetPageTitle&&this.props.widgetPageTitle!==this.formatAppTileName()&&(a=this.props.widgetPageTitle),o.a.createElement("span",null,o.a.createElement(Ja,{app:this.props.app}),o.a.createElement("b",null,e),o.a.createElement("span",null,a?t:"",a))}reload(){this.endWidgetActions().then((()=>{this.resetWidget(this.props),this.startMessaging(),this.iframe&&this.sgWidget&&(this.iframe.src=this.sgWidget.embedUrl)}))}render(){let e;const t="mx_AppTileBody"+(this.props.miniMode?"_mini  ":" "),a={};this.props.pointerEvents&&(a.pointerEvents=this.props.pointerEvents);const n=o.a.createElement("div",{className:"mx_AppLoading_spinner_fadeIn"},o.a.createElement(Zn.a,{message:Object(N.b)("Loading…")})),i=Ka.a.getWidgetName(this.props.app);if(null===this.sgWidget)e=o.a.createElement("div",{className:t,style:a},o.a.createElement(Gi,{errorMsg:Object(N.b)("Error loading Widget")}));else if(!this.state.hasPermissionToLoad&&this.props.room){const n=this.context.isRoomEncrypted(this.props.room.roomId);e=o.a.createElement("div",{className:t,style:a},o.a.createElement(Ki,{roomId:this.props.room.roomId,creatorUserId:this.props.creatorUserId,url:this.sgWidget.embedUrl,isRoomEncrypted:n,onPermissionGranted:this.grantWidgetPermission}))}else if(this.state.initialising||!this.state.isUserProfileReady)e=o.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":""),style:a},n);else if(this.isMixedContent())e=o.a.createElement("div",{className:t,style:a},o.a.createElement(Gi,{errorMsg:Object(N.b)("Error - Mixed content")}));else if(e=o.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":""),style:a},this.state.loading&&n,o.a.createElement("iframe",{title:i,allow:"microphone; camera; encrypted-media; autoplay; display-capture; clipboard-write; clipboard-read;",ref:this.iframeRefChange,src:this.sgWidget.embedUrl,allowFullScreen:!0,sandbox:"allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-presentation allow-downloads"})),!this.props.userWidget){const t=101;e=o.a.createElement("div",{className:"mx_AppTile_persistedWrapper"},o.a.createElement($i,{zIndex:this.props.miniMode?t:9,persistKey:this.persistKey,moveRef:this.props.movePersistedElement},e))}let s,r;s=this.props.miniMode?{mx_AppTile_mini:!0}:this.props.fullWidth?{mx_AppTileFullWidth:!0}:{mx_AppTile:!0},s=c()(s),this.state.menuDisplayed&&(r=o.a.createElement(qn,Z()({},Object(de.i)(this.contextMenuButton.current.getBoundingClientRect()),{app:this.props.app,onFinished:this.closeContextMenu,showUnpin:!this.props.userWidget,userWidget:this.props.userWidget,onEditClick:this.props.onEditClick,onDeleteClick:this.props.onDeleteClick})));const l=[];if(this.props.showLayoutButtons){const e=this.props.room&&rn.d.instance.isInContainer(this.props.room,this.props.app,rn.a.Center),t=c()({mx_AppTileMenuBar_iconButton:!0,mx_AppTileMenuBar_iconButton_collapse:e,mx_AppTileMenuBar_iconButton_maximise:!e});l.push(o.a.createElement(K.a,{key:"toggleMaximised",className:t,title:e?Object(N.b)("Un-maximise"):Object(N.b)("Maximise"),onClick:this.onToggleMaximisedClick})),l.push(o.a.createElement(K.a,{key:"minimise",className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_minimise",title:Object(N.b)("Minimise"),onClick:this.onMinimiseClicked}))}return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:s,id:this.props.app.id},this.props.showMenubar&&o.a.createElement("div",{className:"mx_AppTileMenuBar"},o.a.createElement("span",{className:"mx_AppTileMenuBarTitle",style:{pointerEvents:this.props.handleMinimisePointerEvents?"all":"none"}},this.props.showTitle&&this.getTileTitle()),o.a.createElement("span",{className:"mx_AppTileMenuBarWidgets"},l,this.props.showPopout&&!this.state.requiresClient&&o.a.createElement(K.a,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_popout",title:Object(N.b)("Popout widget"),onClick:this.onPopoutWidgetClick}),o.a.createElement(de.b,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_menu",label:Object(N.b)("Options"),isExpanded:this.state.menuDisplayed,inputRef:this.contextMenuButton,onClick:this.onContextMenuClick}))),e),r)}}i()(Qi,"contextType",R.a),i()(Qi,"defaultProps",{waitForIframeLoad:!0,showMenubar:!0,showTitle:!0,showPopout:!0,handleMinimisePointerEvents:!1,userWidget:!1,miniMode:!1,threadId:null,showLayoutButtons:!0});var Xi=e=>{let{room:t,widgetId:a,onClose:n}=e;const i=Object(s.useContext)(R.a),r=Di(t).find((e=>e.id===a)),l=r&&rn.d.instance.isInContainer(t,r,rn.a.Right),[c,d,m,h]=Object(de.q)();if(Object(s.useEffect)((()=>{r&&l||Fa.a.instance.popCard()}),[r,l]),!r||!l)return null;let u;if(c){var p;const e=null===(p=d.current)||void 0===p?void 0:p.getBoundingClientRect(),t=e?e.right:0,a=e?e.bottom:0;u=o.a.createElement(qn,{chevronFace:de.a.None,right:Q.b.instance.windowWidth-t-12,top:a+12,onFinished:h,app:r})}const g=o.a.createElement("div",{className:"mx_BaseCard_header_title"},o.a.createElement(ua.a,{size:"h4",className:"mx_BaseCard_header_title_heading"},Ka.a.getWidgetName(r)),o.a.createElement(de.b,{className:"mx_BaseCard_header_title_button--option",inputRef:d,onClick:m,isExpanded:c,label:Object(N.b)("Options")}),u);return o.a.createElement(za,{header:g,className:"mx_WidgetCard",onClose:n,withoutScrollContainer:!0},o.a.createElement(Qi,{app:r,fullWidth:!0,showMenubar:!1,room:t,userId:i.getSafeUserId(),creatorUserId:r.creatorUserId,widgetPageTitle:Ka.a.getWidgetDataTitle(r),waitForIframeLoad:r.waitForIframeLoad}))},Zi=a(226),es=a(236),ts=a(598),as=a(346),ns=a(668),is=a(958),ss=a(272);class os extends o.a.Component{constructor(e){super(e),i()(this,"userLastModifiedTime",void 0),i()(this,"memberLastModifiedTime",void 0),i()(this,"onRoomStateEvents",(e=>{if(e.getType()!==ee.b.RoomEncryption)return;const{roomId:t}=this.props.member;if(e.getRoomId()!==t)return;oe.a.get().removeListener(m.b.Events,this.onRoomStateEvents),this.setState({isRoomEncrypted:!0}),this.updateE2EStatus()})),i()(this,"onUserTrustStatusChanged",((e,t)=>{e===this.props.member.userId&&this.updateE2EStatus()})),i()(this,"onDeviceVerificationChanged",((e,t,a)=>{e===this.props.member.userId&&this.updateE2EStatus()})),i()(this,"onClick",(()=>{b.a.dispatch({action:L.a.ViewUser,member:this.props.member,push:!0})})),this.state={isRoomEncrypted:!1}}componentDidMount(){const e=oe.a.get(),{roomId:t}=this.props.member;if(t){const a=e.isRoomEncrypted(t);this.setState({isRoomEncrypted:a}),a?(e.on(ka.b.UserTrustStatusChanged,this.onUserTrustStatusChanged),e.on(ka.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),this.updateE2EStatus()):e.on(m.b.Events,this.onRoomStateEvents)}}componentWillUnmount(){const e=oe.a.get();e&&(e.removeListener(m.b.Events,this.onRoomStateEvents),e.removeListener(ka.b.UserTrustStatusChanged,this.onUserTrustStatusChanged),e.removeListener(ka.b.DeviceVerificationChanged,this.onDeviceVerificationChanged))}async updateE2EStatus(){const e=oe.a.get(),{userId:t}=this.props.member,a=t===e.getUserId(),n=e.checkUserTrust(t);if(!n.isCrossSigningVerified())return void this.setState({e2eStatus:n.wasCrossSigningVerified()?ss.a.Warning:ss.a.Normal});const i=e.getStoredDevicesForUser(t).some((n=>{const{deviceId:i}=n,s=e.checkDeviceTrust(t,i);return a?!s.isCrossSigningVerified():!s.isVerified()}));this.setState({e2eStatus:i?ss.a.Warning:ss.a.Verified})}shouldComponentUpdate(e,t){return void 0===this.memberLastModifiedTime||this.memberLastModifiedTime<e.member.getLastModifiedTime()||(!(!e.member.user||!(void 0===this.userLastModifiedTime||this.userLastModifiedTime<e.member.user.getLastModifiedTime()))||(t.isRoomEncrypted!==this.state.isRoomEncrypted||t.e2eStatus!==this.state.e2eStatus))}getDisplayName(){return this.props.member.name}getPowerLabel(){return Object(N.b)("%(userName)s (power %(powerLevelNumber)s)",{userName:St.a.getDisplayUserIdentifier(this.props.member.userId,{roomId:this.props.member.roomId}),powerLevelNumber:this.props.member.powerLevel}).trim()}render(){var e;const t=this.props.member,a=this.getDisplayName(),n=null===(e=t.user)||void 0===e?void 0:e.presence,i=o.a.createElement(ii.b,{member:t,width:36,height:36,"aria-hidden":"true"});t.user&&(this.userLastModifiedTime=t.user.getLastModifiedTime()),this.memberLastModifiedTime=t.getLastModifiedTime();const s=new Map([[100,ns.a.Admin],[50,ns.a.Moderator]]);let r=this.props.member.powerLevel;for(const[e]of s)if(this.props.member.powerLevel>=e){r=e;break}const l=s.get(r);let c;this.state.isRoomEncrypted&&(c=this.state.e2eStatus);const d=o.a.createElement(is.a,{member:t,fallbackName:a||""});return o.a.createElement(ns.b,Z()({},this.props,{presenceState:n,presenceLastActiveAgo:t.user?t.user.lastActiveAgo:0,presenceLastTs:t.user?t.user.lastPresenceTs:0,presenceCurrentlyActive:!!t.user&&t.user.currentlyActive,avatarJsx:i,title:this.getPowerLabel(),name:a,nameJSX:d,powerStatus:l,showPresence:this.props.showPresence,e2eStatus:c,onClick:this.onClick}))}}i()(os,"defaultProps",{showPresence:!0});class rs extends o.a.Component{constructor(e,t){var n;super(e),i()(this,"showPresence",void 0),i()(this,"mounted",!1),i()(this,"context",void 0),i()(this,"onUserPresenceChange",((e,t)=>{this.refs[t.userId]&&this.updateList()})),i()(this,"onRoom",(e=>{e.roomId===this.props.roomId&&this.updateListNow(!0)})),i()(this,"onMyMembership",((e,t,a)=>{e.roomId===this.props.roomId&&"join"===t&&"join"!==a&&this.updateListNow(!0)})),i()(this,"onRoomStateUpdate",(e=>{e.roomId===this.props.roomId&&this.updateList()})),i()(this,"onRoomMemberName",((e,t)=>{t.roomId===this.props.roomId&&this.updateList()})),i()(this,"onRoomStateEvent",(e=>{e.getRoomId()===this.props.roomId&&e.getType()===ee.b.RoomThirdPartyInvite&&this.updateList(),this.canInvite!==this.state.canInvite&&this.setState({canInvite:this.canInvite})})),i()(this,"updateList",Object(j.throttle)((()=>{this.updateListNow(!1)}),500,{leading:!0,trailing:!0})),i()(this,"createOverflowTileJoined",((e,t)=>this.createOverflowTile(e,t,this.showMoreJoinedMemberList))),i()(this,"createOverflowTileInvited",((e,t)=>this.createOverflowTile(e,t,this.showMoreInvitedMemberList))),i()(this,"createOverflowTile",((e,t,n)=>{const i=Object(N.b)("and %(count)s others...",{count:e});return o.a.createElement(ns.b,{className:"mx_EntityTile_ellipsis",avatarJsx:o.a.createElement(yt.a,{url:a(963).default,name:"...",width:36,height:36}),name:i,presenceState:"online",suppressOnHover:!0,onClick:n})})),i()(this,"showMoreJoinedMemberList",(()=>{this.setState({truncateAtJoined:this.state.truncateAtJoined+100})})),i()(this,"showMoreInvitedMemberList",(()=>{this.setState({truncateAtInvited:this.state.truncateAtInvited+100})})),i()(this,"onSearchQueryChanged",(e=>{this.props.onSearchQueryChanged(e)})),i()(this,"onPending3pidInviteClick",(e=>{b.a.dispatch({action:"view_3pid_invite",event:e})})),i()(this,"getChildrenJoined",((e,t)=>this.makeMemberTiles(this.state.filteredJoinedMembers.slice(e,t)))),i()(this,"getChildCountJoined",(()=>this.state.filteredJoinedMembers.length)),i()(this,"getChildrenInvited",((e,t)=>{let a=this.state.filteredInvitedMembers;return t>this.state.filteredInvitedMembers.length&&(a=a.concat(this.getPending3PidInvites())),this.makeMemberTiles(a.slice(e,t))})),i()(this,"getChildCountInvited",(()=>this.state.filteredInvitedMembers.length+(this.getPending3PidInvites()||[]).length)),i()(this,"onInviteButtonClick",(e=>{re.b.trackInteraction("WebRightPanelMemberListInviteButton",e),oe.a.get().isGuest()?b.a.dispatch({action:"require_registration"}):b.a.dispatch({action:"view_invite",roomId:this.props.roomId})})),this.state=this.getMembersState([],[]),this.showPresence=null===(n=null==t?void 0:t.memberListStore.isPresenceEnabled())||void 0===n||n,this.mounted=!0,this.listenForMembersChanges()}listenForMembersChanges(){const e=oe.a.get();e.on(m.b.Update,this.onRoomStateUpdate),e.on(Ua.b.Name,this.onRoomMemberName),e.on(m.b.Events,this.onRoomStateEvent),e.on(Zi.b.LastPresenceTs,this.onUserPresenceChange),e.on(Zi.b.Presence,this.onUserPresenceChange),e.on(Zi.b.CurrentlyActive,this.onUserPresenceChange),e.on(r.b.Room,this.onRoom),e.on(te.d.MyMembership,this.onMyMembership)}componentDidMount(){this.updateListNow(!0)}componentWillUnmount(){this.mounted=!1;const e=oe.a.get();e&&(e.removeListener(m.b.Update,this.onRoomStateUpdate),e.removeListener(Ua.b.Name,this.onRoomMemberName),e.removeListener(te.d.MyMembership,this.onMyMembership),e.removeListener(m.b.Events,this.onRoomStateEvent),e.removeListener(r.b.Room,this.onRoom),e.removeListener(Zi.b.LastPresenceTs,this.onUserPresenceChange),e.removeListener(Zi.b.Presence,this.onUserPresenceChange),e.removeListener(Zi.b.CurrentlyActive,this.onUserPresenceChange)),this.updateList.cancel()}get canInvite(){const e=oe.a.get(),t=e.getRoom(this.props.roomId);return!(null==t||!t.canInvite(e.getSafeUserId()))||!(null==t||!t.isSpaceRoom()||t.getJoinRule()!==Ia.c.Public)}getMembersState(e,t){return{loading:!1,filteredJoinedMembers:t,filteredInvitedMembers:e,canInvite:this.canInvite,truncateAtJoined:30,truncateAtInvited:5}}async updateListNow(e){if(!this.mounted)return;e&&this.setState({loading:!0});const{joined:t,invited:a}=await this.context.memberListStore.loadMemberList(this.props.roomId,this.props.searchQuery);this.mounted&&this.setState({loading:!1,filteredJoinedMembers:t,filteredInvitedMembers:a})}componentDidUpdate(e,t,a){e.searchQuery!==this.props.searchQuery&&this.updateListNow(!1)}getPending3PidInvites(){const e=oe.a.get().getRoom(this.props.roomId);return e?e.currentState.getStateEvents("m.room.third_party_invite").filter((function(t){if(!Object(es.c)(t))return!1;return!e.currentState.getInviteForThreePidToken(t.getStateKey())})):[]}makeMemberTiles(e){return e.map((e=>e instanceof Ua.a?o.a.createElement(os,{key:e.userId,member:e,ref:e.userId,showPresence:this.showPresence}):o.a.createElement(ns.b,{key:e.getStateKey(),name:e.getContent().display_name,suppressOnHover:!0,onClick:()=>this.onPending3pidInviteClick(e)})))}render(){if(this.state.loading)return o.a.createElement(za,{className:"mx_MemberList",onClose:this.props.onClose},o.a.createElement(Zn.a,null));const e=oe.a.get().getRoom(this.props.roomId);let t,a,n;if("join"===(null==e?void 0:e.getMyMembership())&&Object(ae.a)(le.a.InviteUsers)){let a=Object(N.b)("Invite to this room");e.isSpaceRoom()&&(a=Object(N.b)("Invite to this space")),t=o.a.createElement(K.a,{className:"mx_MemberList_invite",onClick:this.onInviteButtonClick,disabled:!this.state.canInvite},o.a.createElement("span",null,a))}this.getChildCountInvited()>0&&(a=o.a.createElement("h2",null,Object(N.b)("Invited")),n=o.a.createElement(ts.a,{className:"mx_MemberList_section mx_MemberList_invited",truncateAt:this.state.truncateAtInvited,createOverflowElement:this.createOverflowTileInvited,getChildren:this.getChildrenInvited,getChildCount:this.getChildCountInvited}));const i=o.a.createElement(as.a,{className:"mx_MemberList_query mx_textinput_icon mx_textinput_search",placeholder:Object(N.b)("Filter room members"),onSearch:this.onSearchQueryChanged,initialValue:this.props.searchQuery});let s;return null!=e&&e.isSpaceRoom()&&(s=o.a.createElement("div",{className:"mx_RightPanel_scopeHeader"},o.a.createElement(ye.a,{room:e,height:32,width:32}),o.a.createElement(vi.a,{room:e}))),o.a.createElement(za,{className:"mx_MemberList",header:o.a.createElement(o.a.Fragment,null,s,t),footer:i,onClose:this.props.onClose},o.a.createElement("div",{className:"mx_MemberList_wrapper"},o.a.createElement(ts.a,{className:"mx_MemberList_section mx_MemberList_joined",truncateAt:this.state.truncateAtJoined,createOverflowElement:this.createOverflowTileJoined,getChildren:this.getChildrenJoined,getChildCount:this.getChildCountJoined}),a,n))}}i()(rs,"contextType",at.a);var ls=a(454),cs=a(553),ds=a(695),ms=a(1012),hs=a(426),us=a(659),ps=a(962),gs=a(1706);class bs extends o.a.Component{constructor(e){super(e),i()(this,"onOk",(e=>{e.preventDefault(),this.props.onFinished(!0,this.state.reason)})),i()(this,"onCancel",(()=>{this.props.onFinished(!1)})),i()(this,"onReasonChange",(e=>{this.setState({reason:e.target.value})})),this.state={reason:""}}render(){const e=this.props.danger?"danger":"";let t;this.props.askReason&&(t=o.a.createElement("form",{onSubmit:this.onOk},o.a.createElement(st.a,{type:"text",onChange:this.onReasonChange,value:this.state.reason,className:"mx_ConfirmUserActionDialog_reasonField",label:Object(N.b)("Reason"),autoFocus:!0})));const a=o.a.createElement(ii.b,{member:this.props.member,width:48,height:48}),n=this.props.member.name,i=this.props.member.userId,s=St.a.getDisplayUserIdentifier(i,{roomId:this.props.roomId,withDisplayName:!0});return o.a.createElement(bn.a,{className:c()("mx_ConfirmUserActionDialog",this.props.className),onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content"},o.a.createElement("div",{id:"mx_Dialog_content",className:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_user"},o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_avatar"},a),o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_name"},n),o.a.createElement("div",{className:"mx_ConfirmUserActionDialog_userId"},s)),t,this.props.children),o.a.createElement(vn.a,{primaryButton:this.props.action,onPrimaryButtonClick:this.onOk,primaryButtonClass:e,focus:!this.props.askReason,onCancel:this.onCancel}))}}i()(bs,"defaultProps",{danger:!1,askReason:!1});var vs=a(890);const fs=["space","spaceChildFilter","allLabel","specificLabel","noneLabel","warningMessage","onFinished"];var Es=e=>{let{space:t,spaceChildFilter:a,allLabel:n,specificLabel:i,noneLabel:r,warningMessage:l,onFinished:c}=e,d=ve()(e,fs);const m=Object(s.useMemo)((()=>{const e=$.a.instance.getChildren(t.roomId);return a?e.filter(a):e}),[t.roomId,a]),[h,u]=Object(s.useState)([]),p=Object(s.useMemo)((()=>new Set(h)),[h]);let g;return l&&(g=o.a.createElement("div",{className:"mx_ConfirmSpaceUserActionDialog_warning"},l)),o.a.createElement(bs,Z()({},d,{onFinished:(e,t)=>{c(e,t,h)},className:"mx_ConfirmSpaceUserActionDialog",roomId:t.roomId}),g,o.a.createElement(vs.a,{space:t,spaceChildren:m,selected:p,allLabel:n,specificLabel:i,noneLabel:r,onChange:u}))},ys=a(425);const _s=["user","room","onClose","phase"];function Ss(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function ws(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Ss(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Ss(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function Os(e){var t;let{userId:a,device:n}=e;const i=Object(s.useContext)(R.a),r=a===i.getUserId(),l=i.checkDeviceTrust(a,n.deviceId),d=i.checkUserTrust(a),m=r?l.isCrossSigningVerified():l.isVerified(),h=c()("mx_UserInfo_device",{mx_UserInfo_device_verified:m,mx_UserInfo_device_unverified:!m}),u=c()("mx_E2EIcon",{mx_E2EIcon_normal:!d.isVerified(),mx_E2EIcon_verified:m,mx_E2EIcon_warning:d.isVerified()&&!m}),p=()=>{const e=i.getUser(a);e&&Object(ms.c)(e,n)};let g,b;return g=null!==(t=n.getDisplayName())&&void 0!==t&&t.trim()?n.ambiguous?n.getDisplayName()+" ("+n.deviceId+")":n.getDisplayName():n.deviceId,d.isVerified()&&(b=m?Object(N.b)("Trusted"):Object(N.b)("Not trusted")),m?o.a.createElement("div",{className:h,title:n.deviceId},o.a.createElement("div",{className:u}),o.a.createElement("div",{className:"mx_UserInfo_device_name"},g),o.a.createElement("div",{className:"mx_UserInfo_device_trusted"},b)):o.a.createElement(K.a,{className:h,title:n.deviceId,onClick:p},o.a.createElement("div",{className:u}),o.a.createElement("div",{className:"mx_UserInfo_device_name"},g),o.a.createElement("div",{className:"mx_UserInfo_device_trusted"},b))}function Cs(e){let{devices:t,userId:a,loading:n}=e;const i=Object(s.useContext)(R.a),r=i.checkUserTrust(a),[l,c]=Object(s.useState)(!1);if(n)return o.a.createElement(Zn.a,null);if(null===t)return o.a.createElement("p",null,Object(N.b)("Unable to load session list"));const d=a===i.getUserId(),m=t.map((e=>i.checkDeviceTrust(a,e.deviceId)));let h=[];const u=[];let p,g,b,v="mx_E2EIcon";if(r.isVerified()){for(let e=0;e<t.length;++e){const a=t[e],n=m[e];(d?n.isCrossSigningVerified():n.isVerified())?h.push(a):u.push(a)}p=Object(N.b)("%(count)s verified sessions",{count:h.length}),g=Object(N.b)("Hide verified sessions"),v+=" mx_E2EIcon_verified"}else h=t,p=Object(N.b)("%(count)s sessions",{count:t.length}),g=Object(N.b)("Hide sessions"),v+=" mx_E2EIcon_normal";h.length&&(b=l?o.a.createElement(K.a,{kind:"link",className:"mx_UserInfo_expand",onClick:()=>c(!1)},o.a.createElement("div",null,g)):o.a.createElement(K.a,{kind:"link",className:"mx_UserInfo_expand",onClick:()=>c(!0)},o.a.createElement("div",{className:v}),o.a.createElement("div",null,p)));let f=u.map(((e,t)=>o.a.createElement(Os,{key:t,userId:a,device:e})));if(l){const e=u.length;f=f.concat(h.map(((t,n)=>o.a.createElement(Os,{key:n+e,userId:a,device:t}))))}return o.a.createElement("div",{className:"mx_UserInfo_devices"},o.a.createElement("div",null,f),o.a.createElement("div",null,b))}const xs=e=>{let{member:t}=e;const a=Object(s.useContext)(R.a),[n,i]=Object(s.useState)(!1);return o.a.createElement(K.a,{kind:"link",onClick:async()=>{n||(i(!0),await async function(e,t){const a=t instanceof Zi.a?t.avatarUrl:t.getMxcAvatarUrl(),n=new ys.a({user_id:t.userId,display_name:t.rawDisplayName,avatar_url:a});await Object(ys.e)(e,[n])}(a,t),i(!1))},className:"mx_UserInfo_field",disabled:n},Object(N.b)("Message"))},js=e=>{let{member:t,isIgnored:a,canInvite:n,isSpace:i}=e;const r=Object(s.useContext)(R.a);let l,d,m,h;const u=t.userId===r.getUserId(),p=Object(s.useCallback)((()=>{const e=r.getIgnoredUsers(),a=e.indexOf(t.userId);-1!==a&&e.splice(a,1),r.setIgnoredUsers(e)}),[r,t]),g=Object(s.useCallback)((async()=>{const e=(t instanceof Zi.a?t.displayName:t.name)||t.userId,{finished:a}=z.b.createDialog(it.a,{title:Object(N.b)("Ignore %(user)s",{user:e}),description:o.a.createElement("div",null,Object(N.b)("All messages and invites from this user will be hidden. Are you sure you want to ignore them?")),button:Object(N.b)("Ignore")}),[n]=await a;if(n){const e=r.getIgnoredUsers();e.push(t.userId),r.setIgnoredUsers(e)}}),[r,t]);if(!u){var v;if(l=o.a.createElement(K.a,{onClick:a?p:g,kind:"link",className:c()("mx_UserInfo_field",{mx_UserInfo_destructive:!a})},a?Object(N.b)("Unignore"):Object(N.b)("Ignore")),t instanceof Ua.a&&t.roomId&&!i){const e=function(){const e=r.getRoom(t.roomId);b.a.dispatch({action:L.a.ViewRoom,highlighted:!0,event_id:(null==e?void 0:e.getEventReadUpTo(t.userId))||void 0,room_id:t.roomId,metricsTrigger:void 0})},a=function(){b.a.dispatch({action:L.a.ComposerInsert,userId:t.userId,timelineRenderingType:en.a.Room})},n=t instanceof Ua.a?r.getRoom(t.roomId):void 0;null!=n&&n.getEventReadUpTo(t.userId)&&(h=o.a.createElement(K.a,{kind:"link",onClick:e,className:"mx_UserInfo_field"},Object(N.b)("Jump to read receipt"))),d=o.a.createElement(K.a,{kind:"link",onClick:a,className:"mx_UserInfo_field"},Object(N.b)("Mention"))}if(t instanceof Ua.a&&n&&"leave"===(null!==(v=null==t?void 0:t.membership)&&void 0!==v?v:"leave")&&Object(ae.a)(le.a.InviteUsers)){const e=t&&t.roomId?t.roomId:at.b.instance.roomViewStore.getRoomId(),a=async a=>{try{const a=new ls.b(e||"");await a.invite([t.userId]).then((()=>{if("invited"!==a.getCompletionState(t.userId)){const n=a.getErrorText(t.userId);throw n?new Error(n):new N.a("User (%(user)s) did not end up as invited to %(roomId)s but no error was given from the inviter utility",{user:t.userId,roomId:e,cause:void 0})}}))}catch(e){const t=e instanceof Error?e.message:Object(N.b)("Operation failed");z.b.createDialog(sn.a,{title:Object(N.b)("Failed to invite"),description:t})}re.b.trackInteraction("WebRightPanelRoomUserInfoInviteButton",a)};m=o.a.createElement(K.a,{kind:"link",onClick:a,className:"mx_UserInfo_field"},Object(N.b)("Invite"))}}const f=o.a.createElement(K.a,{kind:"link",onClick:()=>{z.b.createDialog(Ha.a,{target:t})},className:"mx_UserInfo_field"},Object(N.b)("Share Link to User")),E=u?null:o.a.createElement(xs,{member:t});return o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(N.b)("Options")),o.a.createElement("div",null,E,h,f,d,m,l))},ks=async e=>{const{finished:t}=z.b.createDialog(it.a,{title:Object(N.b)("Demote yourself?"),description:o.a.createElement("div",null,e?Object(N.b)("You will not be able to undo this change as you are demoting yourself, if you are the last privileged user in the space it will be impossible to regain privileges."):Object(N.b)("You will not be able to undo this change as you are demoting yourself, if you are the last privileged user in the room it will be impossible to regain privileges.")),button:Object(N.b)("Demote")}),[a]=await t;return!!a},Rs=e=>{let{children:t}=e;return o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(N.b)("Admin Tools")),o.a.createElement("div",{className:"mx_UserInfo_buttons"},t))},Is=e=>{var t,a;return(null==e||null===(t=e.currentState)||void 0===t||null===(a=t.getStateEvents(ee.b.RoomPowerLevels,""))||void 0===a?void 0:a.getContent())||{}},Ts=e=>{let{room:t,member:a,startUpdating:n,stopUpdating:i}=e;const r=Object(s.useContext)(R.a);if("invite"!==a.membership&&"join"!==a.membership)return o.a.createElement(o.a.Fragment,null);const l=t.isSpaceRoom()?"invite"===a.membership?Object(N.b)("Disinvite from space"):Object(N.b)("Remove from space"):"invite"===a.membership?Object(N.b)("Disinvite from room"):Object(N.b)("Remove from room");return o.a.createElement(K.a,{kind:"link",className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:async()=>{const e={member:a,action:t.isSpaceRoom()?"invite"===a.membership?Object(N.b)("Disinvite from space"):Object(N.b)("Remove from space"):"invite"===a.membership?Object(N.b)("Disinvite from room"):Object(N.b)("Remove from room"),title:"invite"===a.membership?Object(N.b)("Disinvite from %(roomName)s",{roomName:t.name}):Object(N.b)("Remove from %(roomName)s",{roomName:t.name}),askReason:"join"===a.membership,danger:!0};let s;t.isSpaceRoom()?({finished:s}=z.b.createDialog(Es,ws(ws({},e),{},{space:t,spaceChildFilter:e=>{const t=e.getMember(r.credentials.userId||""),n=e.getMember(a.userId);return!!t&&!!n&&n.membership===a.membership&&t.powerLevel>n.powerLevel&&e.currentState.hasSufficientPowerLevelFor("kick",t.powerLevel)},allLabel:Object(N.b)("Remove them from everything I'm able to"),specificLabel:Object(N.b)("Remove them from specific things I'm able to"),warningMessage:Object(N.b)("They'll still be able to access whatever you're not an admin of.")}),"mx_ConfirmSpaceUserActionDialog_wrapper")):({finished:s}=z.b.createDialog(bs,e));const[o,l,c=[]]=await s;o&&(n(),Object(ce.a)(t,c,(e=>r.kick(e.roomId,a.userId,l||void 0))).then((()=>{Oa.a.log("Kick success")}),(function(e){Oa.a.error("Kick error: "+e),z.b.createDialog(sn.a,{title:Object(N.b)("Failed to remove user"),description:e&&e.message?e.message:"Operation failed"})})).finally((()=>{i()})))}},l)},Ns=e=>{let{member:t}=e;const a=Object(s.useContext)(R.a);return o.a.createElement(K.a,{kind:"link",className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:()=>{const e=a.getRoom(t.roomId);e&&z.b.createDialog(gs.a,{matrixClient:a,room:e,member:t})}},Object(N.b)("Remove recent messages"))},Ps=e=>{let{room:t,member:a,startUpdating:n,stopUpdating:i}=e;const r=Object(s.useContext)(R.a),l="ban"===a.membership;let d=t.isSpaceRoom()?Object(N.b)("Ban from space"):Object(N.b)("Ban from room");l&&(d=t.isSpaceRoom()?Object(N.b)("Unban from space"):Object(N.b)("Unban from room"));const m=c()("mx_UserInfo_field",{mx_UserInfo_destructive:!l});return o.a.createElement(K.a,{kind:"link",className:m,onClick:async()=>{const e={member:a,action:t.isSpaceRoom()?l?Object(N.b)("Unban from space"):Object(N.b)("Ban from space"):l?Object(N.b)("Unban from room"):Object(N.b)("Ban from room"),title:l?Object(N.b)("Unban from %(roomName)s",{roomName:t.name}):Object(N.b)("Ban from %(roomName)s",{roomName:t.name}),askReason:!l,danger:!l};let s;t.isSpaceRoom()?({finished:s}=z.b.createDialog(Es,ws(ws({},e),{},{space:t,spaceChildFilter:l?e=>{const t=e.getMember(r.credentials.userId||""),n=e.getMember(a.userId);return!!t&&!!n&&"ban"===n.membership&&t.powerLevel>n.powerLevel&&e.currentState.hasSufficientPowerLevelFor("ban",t.powerLevel)}:e=>{const t=e.getMember(r.credentials.userId||""),n=e.getMember(a.userId);return!!t&&!!n&&"ban"!==n.membership&&t.powerLevel>n.powerLevel&&e.currentState.hasSufficientPowerLevelFor("ban",t.powerLevel)},allLabel:l?Object(N.b)("Unban them from everything I'm able to"):Object(N.b)("Ban them from everything I'm able to"),specificLabel:l?Object(N.b)("Unban them from specific things I'm able to"):Object(N.b)("Ban them from specific things I'm able to"),warningMessage:l?Object(N.b)("They won't be able to access whatever you're not an admin of."):Object(N.b)("They'll still be able to access whatever you're not an admin of.")}),"mx_ConfirmSpaceUserActionDialog_wrapper")):({finished:s}=z.b.createDialog(bs,e));const[o,c,d=[]]=await s;if(!o)return;n();Object(ce.a)(t,d,(e=>{return t=e.roomId,l?r.unban(t,a.userId):r.ban(t,a.userId,c||void 0);var t})).then((()=>{Oa.a.log("Ban success")}),(function(e){Oa.a.error("Ban error: "+e),z.b.createDialog(sn.a,{title:Object(N.b)("Error"),description:Object(N.b)("Failed to ban user")})})).finally((()=>{i()}))}},d)},Ds=e=>{let{member:t,room:a,powerLevels:n,startUpdating:i,stopUpdating:r}=e;const l=Object(s.useContext)(R.a);if("join"!==t.membership)return null;const d=((e,t)=>{if(!t||!e)return!1;const a=(t.events?t.events["m.room.message"]:null)||t.events_default;return void 0!==a&&e.powerLevel<a})(t,n),m=c()("mx_UserInfo_field",{mx_UserInfo_destructive:!d}),h=d?Object(N.b)("Unmute"):Object(N.b)("Mute");return o.a.createElement(K.a,{kind:"link",className:m,onClick:async()=>{const e=t.roomId,n=t.userId;if(n===l.getUserId())try{if(!await ks(null==a?void 0:a.isSpaceRoom()))return}catch(e){return void Oa.a.error("Failed to warn about self demotion: ",e)}const s=a.currentState.getStateEvents("m.room.power_levels","");if(!s)return;const o=s.getContent(),c=(o.events?o.events["m.room.message"]:null)||o.events_default;let m;m=d?c:c-1,m=parseInt(m),isNaN(m)||(i(),l.setPowerLevel(e,n,m,s).then((()=>{Oa.a.log("Mute toggle success")}),(function(e){Oa.a.error("Mute error: "+e),z.b.createDialog(sn.a,{title:Object(N.b)("Error"),description:Object(N.b)("Failed to mute user")})})).finally((()=>{r()})))}},h)},Ms=e=>{let{room:t,children:a,member:n,startUpdating:i,stopUpdating:r,powerLevels:l}=e;const c=Object(s.useContext)(R.a);let d,m,h,u;const p=(l.events?l.events["m.room.power_levels"]:null)||l.state_default,{ban:g=50,kick:b=50,redact:v=50}=l,f=t.getMember(c.getUserId()||"");if(!f)return o.a.createElement("div",null);const E=f.userId===n.userId,y=n.powerLevel<f.powerLevel||E;return!E&&y&&f.powerLevel>=b&&(d=o.a.createElement(Ts,{room:t,member:n,startUpdating:i,stopUpdating:r})),f.powerLevel>=v&&!t.isSpaceRoom()&&(u=o.a.createElement(Ns,{member:n,startUpdating:i,stopUpdating:r})),!E&&y&&f.powerLevel>=g&&(m=o.a.createElement(Ps,{room:t,member:n,startUpdating:i,stopUpdating:r})),!E&&y&&f.powerLevel>=Number(p)&&!t.isSpaceRoom()&&(h=o.a.createElement(Ds,{member:n,room:t,powerLevels:l,startUpdating:i,stopUpdating:r})),d||m||h||u||a?o.a.createElement(Rs,null,h,d,m,u,a):o.a.createElement("div",null)};const As=e=>{let{user:t,room:a,roomPermissions:n,powerLevels:i}=e;if(n.canEdit)return o.a.createElement(Us,{user:t,room:a,roomPermissions:n});{const e=i.users_default||0,a=t.powerLevel,n=Object(cs.b)(a,e);return o.a.createElement("div",{className:"mx_UserInfo_profileField"},o.a.createElement("div",{className:"mx_UserInfo_roleDescription"},n))}},Us=e=>{let{user:t,room:a,roomPermissions:n}=e;const i=Object(s.useContext)(R.a),[r,l]=Object(s.useState)(t.powerLevel);Object(s.useEffect)((()=>{l(t.powerLevel)}),[t]);const c=Object(s.useCallback)((async e=>{l(e);const n=t.roomId,s=t.userId,r=a.currentState.getStateEvents("m.room.power_levels","");if(!r)return;const c=i.getUserId(),d=r.getContent().users[c||""];if(d&&parseInt(d)<=e&&c!==s){const{finished:e}=z.b.createDialog(it.a,{title:Object(N.b)("Warning!"),description:o.a.createElement("div",null,Object(N.b)("You will not be able to undo this change as you are promoting the user to have the same power level as yourself."),o.a.createElement("br",null),Object(N.b)("Are you sure?")),button:Object(N.b)("Continue")}),[t]=await e;if(!t)return}else if(c===s&&d&&parseInt(d)>e)try{if(!await ks(null==a?void 0:a.isSpaceRoom()))return}catch(e){Oa.a.error("Failed to warn about self demotion: ",e)}await((e,t,a,n)=>i.setPowerLevel(e,t,a,n).then((function(){Oa.a.log("Power change success")}),(function(e){Oa.a.error("Failed to change power level "+e),z.b.createDialog(sn.a,{title:Object(N.b)("Error"),description:Object(N.b)("Failed to change power level")})})))(n,s,e,r)}),[t.roomId,t.userId,i,a]),d=a.currentState.getStateEvents("m.room.power_levels",""),m=d?d.getContent().users_default:0;return o.a.createElement("div",{className:"mx_UserInfo_profileField"},o.a.createElement(us.a,{label:void 0,value:r,maxValue:n.modifyLevelMax,usersDefault:m,onChange:c}))},Ls=e=>{const t=Object(s.useContext)(R.a),[a,n]=Object(s.useState)(void 0);return Object(s.useEffect)((()=>{n(void 0);let a=!1;return async function(){try{await t.downloadKeys([e],!0);const i=t.getStoredDevicesForUser(e);if(a)return;(e=>{const t=Object.create(null);for(let n=0;n<e.length;n++){var a;const i=null!==(a=e[n].getDisplayName())&&void 0!==a?a:"",s=t[i]||[];s.push(n),t[i]=s}for(const a in t)t[a].length>1&&t[a].forEach((t=>{e[t].ambiguous=!0}))})(i),n(i)}catch(e){n(null)}}(),()=>{a=!0}}),[t,e]),Object(s.useEffect)((()=>{let a=!1;const i=async()=>{const i=t.getStoredDevicesForUser(e);a||n(i)},s=t=>{t.includes(e)&&i()},o=(t,a)=>{t===e&&i()},r=(t,a)=>{t===e&&i()};return t.on(ka.b.DevicesUpdated,s),t.on(ka.b.DeviceVerificationChanged,o),t.on(ka.b.UserTrustStatusChanged,r),()=>{a=!0,t.removeListener(ka.b.DevicesUpdated,s),t.removeListener(ka.b.DeviceVerificationChanged,o),t.removeListener(ka.b.UserTrustStatusChanged,r)}}),[t,e]),a},Fs=e=>{let{room:t,member:a,devices:n,isRoomEncrypted:i}=e;const l=Object(s.useContext)(R.a),c=((e,t)=>{const[a,n]=Object(s.useState)(Is(t)),i=Object(s.useCallback)((e=>{t&&(e&&e.getType()!==ee.b.RoomPowerLevels||n(Is(t)))}),[t]);return Object(ie.c)(e,m.b.Events,i),Object(s.useEffect)((()=>(i(),()=>{n({})})),[i]),a})(l,t),d=(e=>Object(ai.a)((async()=>!!e&&e.isSynapseAdministrator().catch((()=>!1))),[e],!1))(l),[h,u]=Object(s.useState)(l.isUserIgnored(a.userId));Object(s.useEffect)((()=>{u(l.isUserIgnored(a.userId))}),[l,a.userId]);const p=Object(s.useCallback)((e=>{"m.ignored_user_list"===e.getType()&&u(l.isUserIgnored(a.userId))}),[l,a.userId]);Object(ie.c)(l,r.b.AccountData,p);const[g,v]=Object(s.useState)(0),f=Object(s.useCallback)((()=>{v(g+1)}),[g]),E=Object(s.useCallback)((()=>{v(g-1)}),[g]),y=function(e,t,a){const[n,i]=Object(s.useState)({modifyLevelMax:-1,canEdit:!1,canInvite:!1}),o=Object(s.useCallback)((()=>{var n,s;const o=null==t||null===(n=t.currentState.getStateEvents(ee.b.RoomPowerLevels,""))||void 0===n?void 0:n.getContent();if(!o)return;const r=t.getMember(e.getUserId()||"");if(!r)return;const l=a,c=r.userId===l.userId;let d=-1;if(l.powerLevel<r.powerLevel||c){var m,h,u;const e=null!==(m=null!==(h=null===(u=o.events)||void 0===u?void 0:u[ee.b.RoomPowerLevels])&&void 0!==h?h:o.state_default)&&void 0!==m?m:50;r.powerLevel>=e&&(d=r.powerLevel)}i({canInvite:r.powerLevel>=(null!==(s=o.invite)&&void 0!==s?s:0),canEdit:d>=0,modifyLevelMax:d})}),[e,a,t]);return Object(ie.c)(e,m.b.Update,o),Object(s.useEffect)((()=>(o(),()=>{i({modifyLevelMax:-1,canEdit:!1,canInvite:!1})})),[o]),n}(l,t,a),_=Object(s.useCallback)((async()=>{const{finished:e}=z.b.createDialog(it.a,{title:Object(N.b)("Deactivate user?"),description:o.a.createElement("div",null,Object(N.b)("Deactivating this user will log them out and prevent them from logging back in. Additionally, they will leave all the rooms they are in. This action cannot be reversed. Are you sure you want to deactivate this user?")),button:Object(N.b)("Deactivate user"),danger:!0}),[t]=await e;if(t)try{await l.deactivateSynapseUser(a.userId)}catch(e){Oa.a.error("Failed to deactivate user"),Oa.a.error(e);const t=e instanceof Error?e.message:Object(N.b)("Operation failed");z.b.createDialog(sn.a,{title:Object(N.b)("Failed to deactivate user"),description:t})}}),[l,a.userId]);let S,w,O,C;d&&a.userId.endsWith(`:${oe.a.getHomeserverName()}`)&&(S=o.a.createElement(K.a,{kind:"link",className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:_},Object(N.b)("Deactivate user"))),t&&a.roomId?(Xa.a.shared().getUserIdForRoomId(a.roomId)||(O=o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(N.b)("Role in <RoomName/>",{},{RoomName:()=>o.a.createElement("b",null,t.name)})),o.a.createElement(As,{powerLevels:c,user:a,room:t,roomPermissions:y}))),C=o.a.createElement(Ms,{powerLevels:c,member:a,room:t,startUpdating:f,stopUpdating:E},S)):S&&(C=o.a.createElement(Rs,null,S)),g>0&&(w=o.a.createElement(Zn.a,null));const x=l.isCryptoEnabled();let j,k;i?t.isSpaceRoom()||(j=Object(N.b)("Messages in this room are end-to-end encrypted.")):x?t&&!t.isSpaceRoom()&&(j=Object(N.b)("Messages in this room are not end-to-end encrypted.")):j=Object(N.b)("This client does not support end-to-end encryption.");const I=(e=>Object(ai.a)((async()=>e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")),[e],!1))(l),T=x&&l.checkUserTrust(a.userId),P=x&&T&&T.isCrossSigningVerified(),D=a.userId===l.getUserId(),M=x&&I&&!P&&!D&&n&&n.length>0,A=function(e,t,a,n){return Object(ai.a)((async()=>{if(a){n(!0);try{await e.downloadKeys([t.userId]);const a=e.getStoredCrossSigningForUser(t.userId);return!(!a||!a.getId())}finally{n(!1)}}}),[e,t,a])}(l,a,M,(e=>{v((t=>t+(e?1:-1)))})),U=void 0===n;let F;M&&(void 0!==A?k=o.a.createElement("div",{className:"mx_UserInfo_container_verifyButton"},o.a.createElement(K.a,{kind:"link",className:"mx_UserInfo_field mx_UserInfo_verifyButton",onClick:()=>{A?Object(ms.d)(a):Object(ms.a)(a)}},Object(N.b)("Verify"))):U||(k=o.a.createElement(Zn.a,null))),a.userId==l.getUserId()&&(F=o.a.createElement("div",null,o.a.createElement(K.a,{kind:"link",className:"mx_UserInfo_field",onClick:()=>{b.a.dispatch({action:L.a.ViewUserDeviceSettings})}},Object(N.b)("Edit devices"))));const B=o.a.createElement("div",{className:"mx_UserInfo_container"},o.a.createElement("h3",null,Object(N.b)("Security")),o.a.createElement("p",null,j),k,x&&o.a.createElement(Cs,{loading:U,devices:n,userId:a.userId}),F);return o.a.createElement(o.a.Fragment,null,O,B,o.a.createElement(js,{canInvite:y.canInvite,isIgnored:h,member:a,isSpace:null==t?void 0:t.isSpaceRoom()}),C,w)},Bs=e=>{var t;let{member:a,e2eStatus:n,roomId:i}=e;const r=Object(s.useContext)(R.a),l=Object(s.useCallback)((()=>{const e=a.getMxcAvatarUrl?a.getMxcAvatarUrl():a.avatarUrl,t=Object($a.b)(e).srcHttp;if(!t)return;const n={src:t,name:a.name||a.displayName};z.b.createDialog(hs.a,n,"mx_Dialog_lightbox",void 0,!0)}),[a]),c=a.avatarUrl,d=o.a.createElement("div",{className:"mx_UserInfo_avatar"},o.a.createElement("div",{className:"mx_UserInfo_avatar_transition"},o.a.createElement("div",{className:"mx_UserInfo_avatar_transition_child"},o.a.createElement(ii.b,{key:a.userId,member:a,width:.6*Q.b.instance.windowHeight,height:.6*Q.b.instance.windowHeight,resizeMethod:"scale",fallbackUserId:a.userId,onClick:l,urls:c?[c]:void 0}))));let m,h,u;a instanceof Ua.a&&a.user&&(m=a.user.presence,h=a.user.lastActiveAgo,u=a.user.currentlyActive);const p=ot.b.get("enable_presence_by_hs_url");let g,b=!0;p&&void 0!==p[r.baseUrl]&&(b=p[r.baseUrl]),b&&(g=o.a.createElement(ps.a,{activeAgo:h,currentlyActive:u,presenceState:m}));const v=n?o.a.createElement(ss.b,{size:18,status:n,isUser:!0}):null,f=a.rawDisplayName;return o.a.createElement(o.a.Fragment,null,d,o.a.createElement("div",{className:"mx_UserInfo_container mx_UserInfo_separator"},o.a.createElement("div",{className:"mx_UserInfo_profile"},o.a.createElement("div",null,o.a.createElement("h2",null,v,o.a.createElement("span",{title:f,"aria-label":f,dir:"auto"},f))),o.a.createElement("div",{className:"mx_UserInfo_profile_mxid"},null===(t=St.a.getDisplayUserIdentifier)||void 0===t?void 0:t.call(St.a,a.userId,{roomId:i,withDisplayName:!0})),o.a.createElement("div",{className:"mx_UserInfo_profileStatus"},g))))};var Vs=e=>{var t;let{user:a,room:n,onClose:i,phase:r=La.a.RoomMemberInfo}=e,l=ve()(e,_s);const c=Object(s.useContext)(R.a),d=Object(s.useMemo)((()=>n&&n.getMember(a.userId)||a),[n,a]),m=Ba(c,n),h=null!==(t=Ls(a.userId))&&void 0!==t?t:[];let u;m&&h&&(u=((e,t,a)=>{const n=t===e.getUserId(),i=e.checkUserTrust(t);return i.isCrossSigningVerified()?a.some((a=>{const{deviceId:i}=a,s=e.checkDeviceTrust(t,i);return n?!s.isCrossSigningVerified():!s.isVerified()}))?Za.Warning:Za.Verified:i.wasCrossSigningVerified()?Za.Warning:Za.Normal})(c,a.userId,h));const p=["mx_UserInfo"];let g={};n&&r===La.a.EncryptionPanel?g={member:d}:null!=n&&n.isSpaceRoom()&&(g={spaceId:n.roomId});const b=()=>{Fa.a.instance.popCard()};let v,f,E;switch(r){case La.a.RoomMemberInfo:case La.a.SpaceMemberInfo:v=o.a.createElement(Fs,{room:n,member:d,devices:h,isRoomEncrypted:Boolean(m)});break;case La.a.EncryptionPanel:p.push("mx_UserInfo_smallAvatar"),v=o.a.createElement(ds.a,Z()({},l,{member:d,onClose:b,isRoomEncrypted:Boolean(m)}))}if(r===La.a.EncryptionPanel){const e=l.verificationRequest;e&&e.pending&&(f=Object(N.b)("Cancel"))}null!=n&&n.isSpaceRoom()&&(E=o.a.createElement("div",{"data-testid":"space-header",className:"mx_RightPanel_scopeHeader"},o.a.createElement(ye.a,{room:n,height:32,width:32}),o.a.createElement(vi.a,{room:n})));const y=o.a.createElement(o.a.Fragment,null,E,o.a.createElement(Bs,{member:d,e2eStatus:u,roomId:null==n?void 0:n.roomId}));return o.a.createElement(za,{className:p.join(" "),header:y,onClose:i,closeLabel:f,cardState:g,onBack:e=>{Fa.a.instance.previousCard.phase===La.a.RoomMemberList&&re.b.trackInteraction("WebRightPanelRoomUserInfoBackButton",e)}},v)};class Ws extends o.a.Component{constructor(e){var t,a,n;super(e),i()(this,"room",void 0),i()(this,"onRoomStateEvents",(e=>{if(e.getType()===ee.b.RoomThirdPartyInvite&&e.getStateKey()===this.state.stateKey){const t=e.getContent().display_name,a={invited:Object(es.c)(e)};t&&(a.displayName=t),this.setState(a)}})),i()(this,"onCancel",(()=>{b.a.dispatch({action:"view_3pid_invite",event:null})})),i()(this,"onKickClick",(()=>{oe.a.get().sendStateEvent(this.state.roomId,"m.room.third_party_invite",{},this.state.stateKey).catch((e=>{Oa.a.error(e),this.setState({invited:!0}),z.b.createDialog(sn.a,{title:Object(N.b)("Failed to revoke invite"),description:Object(N.b)("Could not revoke the invite. The server may be experiencing a temporary problem or you do not have sufficient permissions to revoke the invite.")})})),this.setState({invited:!1})})),this.room=oe.a.get().getRoom(this.props.event.getRoomId());const s=null===(t=this.room)||void 0===t?void 0:t.getMember(oe.a.get().getUserId()),o=null===(a=this.room)||void 0===a?void 0:a.currentState.getStateEvents("m.room.power_levels","");let r=o?o.getContent().kick:50;"number"!=typeof r&&(r=50);const l=null===(n=this.room)||void 0===n?void 0:n.getMember(this.props.event.getSender());this.state={stateKey:this.props.event.getStateKey(),roomId:this.props.event.getRoomId(),displayName:this.props.event.getContent().display_name,invited:!0,canKick:!!s&&s.powerLevel>r,senderName:l?l.name:this.props.event.getSender()}}componentDidMount(){oe.a.get().on(m.b.Events,this.onRoomStateEvents)}componentWillUnmount(){const e=oe.a.get();e&&e.removeListener(m.b.Events,this.onRoomStateEvents)}render(){var e;let t,a;return this.state.canKick&&this.state.invited&&(t=o.a.createElement("div",{className:"mx_MemberInfo_container"},o.a.createElement("h3",null,Object(N.b)("Admin Tools")),o.a.createElement("div",{className:"mx_MemberInfo_buttons"},o.a.createElement(K.a,{className:"mx_MemberInfo_field",onClick:this.onKickClick},Object(N.b)("Revoke invite"))))),null!==(e=this.room)&&void 0!==e&&e.isSpaceRoom()&&(a=o.a.createElement("div",{className:"mx_RightPanel_scopeHeader"},o.a.createElement(ye.a,{room:this.room,height:32,width:32}),o.a.createElement(vi.a,{room:this.room}))),o.a.createElement("div",{className:"mx_MemberInfo",role:"tabpanel"},a,o.a.createElement("div",{className:"mx_MemberInfo_name"},o.a.createElement(K.a,{className:"mx_MemberInfo_cancel",onClick:this.onCancel,title:Object(N.b)("Close")}),o.a.createElement("h2",null,this.state.displayName)),o.a.createElement("div",{className:"mx_MemberInfo_container"},o.a.createElement("div",{className:"mx_MemberInfo_profile"},o.a.createElement("div",{className:"mx_MemberInfo_profileField"},Object(N.b)("Invited by %(sender)s",{sender:this.state.senderName})))),t)}}var zs=a(326),Hs=a(327);let Ks=function(e){return e[e.Files=0]="Files",e[e.Search=1]="Search",e}({});function Gs(e){let{isRoomEncrypted:t,kind:a}=e;if(!t)return o.a.createElement(o.a.Fragment,null);if(Hs.a.get())return o.a.createElement(o.a.Fragment,null);if(Hs.a.error)return o.a.createElement("div",{className:"mx_SearchWarning"},Object(N.b)("Message search initialisation failed, check <a>your settings</a> for more information",{},{a:e=>o.a.createElement(K.a,{kind:"link_inline",onClick:e=>{e.preventDefault(),b.a.dispatch({action:L.a.ViewUserSettings,initialTabId:Fe.a.Security})}},e)}));const n=ot.b.get("brand"),i=ot.b.getObject("desktop_builds");let s,r;if(null!=i&&i.get("available")){r=o.a.createElement("img",{alt:Object(N.b)("Desktop app logo"),src:i.get("logo")});const e=i.get("url");switch(a){case Ks.Files:s=Object(N.b)("Use the <a>Desktop app</a> to see all encrypted files",{},{a:t=>o.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)});break;case Ks.Search:s=Object(N.b)("Use the <a>Desktop app</a> to search encrypted messages",{},{a:t=>o.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)})}}else switch(a){case Ks.Files:s=Object(N.b)("This version of %(brand)s does not support viewing some encrypted files",{brand:n});break;case Ks.Search:s=Object(N.b)("This version of %(brand)s does not support searching encrypted messages",{brand:n})}return s?o.a.createElement("div",{className:"mx_SearchWarning"},r,o.a.createElement("span",null,s)):(Oa.a.warn("Unknown desktop builds warning kind: ",a),o.a.createElement(o.a.Fragment,null))}var qs=a(181),$s=a(544),Ys=a(18),Js=a(662),Qs=a(353),Xs=a(691),Zs=a(492);const eo=function(){if(v.b.getValue("debug_timeline_panel")){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];Oa.a.log.call(console,"TimelinePanel debuglog:",...t)}};class to extends o.a.Component{constructor(e,t){var a;super(e,t),i()(this,"context",void 0),i()(this,"lastRRSentEventId",void 0),i()(this,"lastRMSentEventId",void 0),i()(this,"messagePanel",Object(s.createRef)()),i()(this,"dispatcherRef",void 0),i()(this,"timelineWindow",void 0),i()(this,"overlayTimelineWindow",void 0),i()(this,"unmounted",!1),i()(this,"readReceiptActivityTimer",null),i()(this,"readMarkerActivityTimer",null),i()(this,"callEventGroupers",new Map),i()(this,"onDumpDebugLogs",(()=>{var e,t,a,n,i,s,o;const r=null===(e=this.props.timelineSet)||void 0===e?void 0:e.room,l=null===(t=this.state)||void 0===t||null===(a=t.events)||void 0===a?void 0:a.map((e=>e.getId()));let c,d,m;try{const e=this.messagePanel.current;if(e){const t=qt.a.findDOMNode(e);if(t){c=[...t.querySelectorAll("[data-event-id]")].map((e=>e.getAttribute("data-event-id")))}}}catch(e){Oa.a.error("onDumpDebugLogs: Failed to get the actual event ID's in the DOM",e)}const h={};if(r){const e=r.getTimelineSets(),t=r.threadsTimelineSets;try{d=ao(e),m=ao(t)}catch(e){Oa.a.error("onDumpDebugLogs: Failed to serialize event IDs from timelinesets",e)}try{r.getThreads().forEach((e=>{var t,a;h[e.id]={events:e.events.map((e=>e.getId())),numTimelines:e.timelineSet.getTimelines().length,liveTimeline:e.timelineSet.getLiveTimeline().getEvents().length,prevTimeline:null===(t=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(qs.a.Backward))||void 0===t?void 0:t.getEvents().length,nextTimeline:null===(a=e.timelineSet.getLiveTimeline().getNeighbouringTimeline(qs.a.Forward))||void 0===a?void 0:a.getEvents().length}}))}catch(e){Oa.a.error("onDumpDebugLogs: Failed to serialize event IDs from the threads",e)}}let u,p;try{var g;u=null===(g=this.timelineWindow)||void 0===g?void 0:g.getEvents().map((e=>e.getId()))}catch(e){Oa.a.error("onDumpDebugLogs: Failed to get event IDs from the timelineWindow",e)}try{p=this.props.timelineSet.getPendingEvents().map((e=>e.getId()))}catch(e){Oa.a.error("onDumpDebugLogs: Failed to get pending event IDs",e)}Oa.a.debug(`TimelinePanel(${this.context.timelineRenderingType}): Debugging info for ${null==r?void 0:r.roomId}\n\tevents(${l.length})=${JSON.stringify(l)}\n\trenderedEventIds(${null!==(n=null===(i=c)||void 0===i?void 0:i.length)&&void 0!==n?n:0})=${JSON.stringify(c)}\n\tserializedEventIdsFromTimelineSets=${JSON.stringify(d)}\n\tserializedEventIdsFromThreadsTimelineSets=${JSON.stringify(m)}\n\tserializedThreadsMap=${JSON.stringify(h)}\n\ttimelineWindowEventIds(${null===(s=u)||void 0===s?void 0:s.length})=${JSON.stringify(u)}\n\tpendingEventIds(${null===(o=p)||void 0===o?void 0:o.length})=${JSON.stringify(p)}`)})),i()(this,"onMessageListUnfillRequest",((e,t)=>{const a=e?qs.b.BACKWARDS:qs.b.FORWARDS;eo("unpaginating events in direction",a);const n=t,i=this.state.events.findIndex((e=>e.getId()===n)),s=e?i+1:this.state.events.length-i;if(s>0){var o;eo("Unpaginating",s,"in direction",a),null===(o=this.timelineWindow)||void 0===o||o.unpaginate(s,e);const{events:t,liveEvents:n,firstVisibleEventIndex:i}=this.getEvents();this.buildLegacyCallEventGroupers(t),this.setState({events:t,liveEvents:n,firstVisibleEventIndex:i}),e?this.setState({canBackPaginate:!0}):this.setState({canForwardPaginate:!0})}})),i()(this,"onPaginationRequest",((e,t,a)=>this.props.onPaginationRequest?this.props.onPaginationRequest(e,t,a):e.paginate(t,a))),i()(this,"onMessageListFillRequest",(e=>{var t;if(!this.shouldPaginate())return Promise.resolve(!1);const a=e?qs.b.BACKWARDS:qs.b.FORWARDS,n=e?"canBackPaginate":"canForwardPaginate",i=e?"backPaginating":"forwardPaginating";return this.state[n]?null!==(t=this.timelineWindow)&&void 0!==t&&t.canPaginate(a)?e&&0!==this.state.firstVisibleEventIndex?(eo("won't",a,"paginate past first visible event"),Promise.resolve(!1)):(eo("Initiating paginate; backwards:"+e),this.setState({[i]:!0}),this.onPaginationRequest(this.timelineWindow,a,20).then((t=>{var a;if(this.unmounted)return!1;eo("paginate complete backwards:"+e+"; success:"+t);const{events:s,liveEvents:o,firstVisibleEventIndex:r}=this.getEvents();this.buildLegacyCallEventGroupers(s);const l={[i]:!1,[n]:t,events:s,liveEvents:o,firstVisibleEventIndex:r},c=e?qs.b.FORWARDS:qs.b.BACKWARDS,d=e?"canForwardPaginate":"canBackPaginate";return!this.state[d]&&null!==(a=this.timelineWindow)&&void 0!==a&&a.canPaginate(c)&&(eo("can now",c,"paginate again"),l[d]=!0),new Promise((a=>{this.setState(l,(()=>{a(t&&(!e||0===r))}))}))}))):(eo("can't",a,"paginate any further"),this.setState({[n]:!1}),Promise.resolve(!1)):(eo("have given up",a,"paginating this timeline"),Promise.resolve(!1))})),i()(this,"onMessageListScroll",(e=>{var t,a;null===(t=(a=this.props).onScroll)||void 0===t||t.call(a,e),this.props.manageReadMarkers&&this.doManageReadMarkers()})),i()(this,"doManageReadMarkers",Object(j.debounce)((()=>{var e;const t=this.getReadMarkerPosition();if(null===t)return;t<0&&this.setState({readMarkerVisible:!0});const a=this.readMarkerTimeout(t);null===(e=this.readMarkerActivityTimer)||void 0===e||e.changeTimeout(a)}),100,{leading:!1,trailing:!0})),i()(this,"onAction",(e=>{switch(e.action){case"ignore_state_changed":this.forceUpdate();break;case L.a.DumpDebugLogs:this.onDumpDebugLogs()}})),i()(this,"onRoomTimeline",((e,t,a,n,i)=>{var s;i.timeline.getTimelineSet()!==this.props.timelineSet&&i.timeline.getTimelineSet()!==this.props.overlayTimelineSet||(Ra.e.hasServerSideSupport||this.context.timelineRenderingType!==en.a.Thread||(a&&!this.state.canBackPaginate&&this.setState({canBackPaginate:!0}),a||this.state.canForwardPaginate||this.setState({canForwardPaginate:!0})),!a&&i&&i.liveEvent&&null!==(s=this.messagePanel.current)&&void 0!==s&&s.getScrollState()&&(this.messagePanel.current.getScrollState().stuckAtBottom?this.timelineWindow.paginate(qs.b.FORWARDS,1,!1).then((()=>{if(this.overlayTimelineWindow)return this.overlayTimelineWindow.paginate(qs.b.FORWARDS,1,!1)})).then((()=>{if(this.unmounted)return;const{events:t,liveEvents:a,firstVisibleEventIndex:n}=this.getEvents();this.buildLegacyCallEventGroupers(t);const i=a[a.length-1],s={events:t,liveEvents:a,firstVisibleEventIndex:n};let o=!1;if(this.props.manageReadMarkers){const t=oe.a.get().credentials.userId;if(o=!1,e.getSender()===t||Js.a.sharedInstance().userActiveRecently()){if(i&&0===this.getReadMarkerPosition()){var r;this.setReadMarker(null!==(r=i.getId())&&void 0!==r?r:null,i.getTs(),!0),s.readMarkerVisible=!1,s.readMarkerEventId=i.getId(),o=!0}}else s.readMarkerVisible=!0}this.setState(s,(()=>{var e,t,a;(null===(e=this.messagePanel.current)||void 0===e||e.updateTimelineMinHeight(),o)&&(null===(t=(a=this.props).onReadMarkerUpdated)||void 0===t||t.call(a))}))})):this.setState({canForwardPaginate:!0})))})),i()(this,"onRoomTimelineReset",((e,t)=>{t===this.props.timelineSet&&this.canResetTimeline()&&this.loadTimeline()})),i()(this,"canResetTimeline",(()=>{var e,t;return null===(e=this.messagePanel)||void 0===e||null===(t=e.current)||void 0===t?void 0:t.isAtBottom()})),i()(this,"onRoomRedaction",((e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()})),i()(this,"onThreadUpdate",(e=>{var t,a;if(this.unmounted)return;if(e.roomId!==(null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId))return;const n=null===(a=this.messagePanel.current)||void 0===a?void 0:a.getTileForEventId(e.id);n&&n.forceUpdate()})),i()(this,"onEventVisibilityChange",(e=>{var t,a;if(this.unmounted)return;if(e.getRoomId()!==(null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId))return;const n=null===(a=this.messagePanel.current)||void 0===a?void 0:a.getTileForEventId(e.getId());n&&n.forceUpdate()})),i()(this,"onVisibilityPowerLevelChange",((e,t)=>{var a,n;if(!this.unmounted&&t.roomId===(null===(a=this.props.timelineSet.room)||void 0===a?void 0:a.roomId)&&t.userId==(null===(n=oe.a.get().credentials)||void 0===n?void 0:n.userId)){for(const e of this.state.events){var i;const t=null===(i=this.messagePanel.current)||void 0===i?void 0:i.getTileForEventId(e.getId());t&&t.forceUpdate()}this.forceUpdate()}})),i()(this,"onEventReplaced",(e=>{var t;this.unmounted||e.getRoomId()===(null===(t=this.props.timelineSet.room)||void 0===t?void 0:t.roomId)&&this.forceUpdate()})),i()(this,"onRoomReceipt",((e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()})),i()(this,"onLocalEchoUpdated",((e,t,a)=>{this.unmounted||t===this.props.timelineSet.room&&this.reloadEvents()})),i()(this,"onAccountData",((e,t)=>{this.unmounted||t===this.props.timelineSet.room&&e.getType()===ee.b.FullyRead&&this.setState({readMarkerEventId:e.getContent().event_id},this.props.onReadMarkerUpdated)})),i()(this,"onEventDecrypted",(e=>{this.props.timelineSet.room&&e.getRoomId()===this.props.timelineSet.room.roomId&&this.state.events.includes(e)&&(this.recheckFirstVisibleEventIndex(),this.buildLegacyCallEventGroupers(this.state.events),this.forceUpdate())})),i()(this,"onSync",((e,t,a)=>{this.unmounted||this.setState({clientSyncState:e})})),i()(this,"recheckFirstVisibleEventIndex",Object(j.throttle)((()=>{const e=this.checkForPreJoinUISI(this.state.events);e!==this.state.firstVisibleEventIndex&&this.setState({firstVisibleEventIndex:e})}),500,{leading:!0,trailing:!0})),i()(this,"sendReadReceipt",(()=>{var e,t;if(v.b.getValue("lowBandwidth"))return;if(!this.messagePanel.current)return;if(!this.props.manageReadReceipts)return;const a=oe.a.get();if(!a||a.isGuest())return;let n=!0;const i=this.getCurrentReadReceipt(!0),s=this.indexForEventId(i);i&&null===s&&null!==(e=this.timelineWindow)&&void 0!==e&&e.canPaginate(qs.b.FORWARDS)&&(n=!1);const o=this.getLastDisplayedEventIndex({ignoreOwn:!0});null===o&&(n=!1);let r=this.state.events[null!=o?o:0];n=n&&o>s&&this.lastRRSentEventId!==(null===(t=r)||void 0===t?void 0:t.getId());const l=this.lastRMSentEventId!=this.state.readMarkerEventId;if(n||l){var c,d,m;if(n)this.lastRRSentEventId=null===(m=r)||void 0===m?void 0:m.getId();else r=null;this.lastRMSentEventId=this.state.readMarkerEventId;const e=this.props.timelineSet.room.roomId,t=v.b.getValue("sendReadReceipts",e);var h,u,p;if(eo(`Sending Read Markers for ${this.props.timelineSet.room.roomId}: `,`rm=${this.state.readMarkerEventId} `,`rr=${t?null===(c=r)||void 0===c?void 0:c.getId():null} `,`prr=${null===(d=r)||void 0===d?void 0:d.getId()}`),this.props.timelineSet.thread&&t&&r)a.sendReadReceipt(r,t?Ys.b.Read:Ys.b.ReadPrivate);else a.setRoomReadMarkers(e,null!==(h=this.state.readMarkerEventId)&&void 0!==h?h:"",t&&null!==(u=r)&&void 0!==u?u:void 0,null!==(p=r)&&void 0!==p?p:void 0).catch((async e=>{if("M_UNRECOGNIZED"===e.errcode&&r){if(!t&&!await a.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")&&!await a.isVersionSupported("v1.4"))return;try{return void await a.sendReadReceipt(r,t?Ys.b.Read:Ys.b.ReadPrivate)}catch(t){Oa.a.error(e),this.lastRRSentEventId=void 0}}else Oa.a.error(e);this.lastRRSentEventId=void 0,this.lastRMSentEventId=void 0})),this.isAtEndOfLiveTimeline()&&(this.props.timelineSet.room.setUnreadNotificationCount(te.b.Total,0),this.props.timelineSet.room.setUnreadNotificationCount(te.b.Highlight,0),b.a.dispatch({action:"on_room_read",roomId:this.props.timelineSet.room.roomId}))}})),i()(this,"updateReadMarker",(()=>{if(!this.props.manageReadMarkers)return;if(1===this.getReadMarkerPosition())return;const e=this.getLastDisplayedEventIndex({allowPartial:!0});if(null===e)return;const t=this.state.events[e];this.setReadMarker(t.getId(),t.getTs()),this.state.readMarkerVisible&&this.setState({readMarkerVisible:!1}),this.sendReadReceipt()})),i()(this,"removeUnreadMarker",(()=>{const e=oe.a.get();if(!e||e.isGuest())return;v.b.getValue("feature_mark_unread")&&Object(Da.e)(this.props.timelineSet.room)&&Object(Da.g)(this.props.timelineSet.room,!1)})),i()(this,"jumpToLiveTimeline",(()=>{var e,t;null!==(e=this.timelineWindow)&&void 0!==e&&e.canPaginate(qs.b.FORWARDS)?this.loadTimeline():null===(t=this.messagePanel.current)||void 0===t||t.scrollToBottom()})),i()(this,"scrollToEventIfNeeded",(e=>{var t;null===(t=this.messagePanel.current)||void 0===t||t.scrollToEventIfNeeded(e)})),i()(this,"jumpToReadMarker",(()=>{if(!this.props.manageReadMarkers)return;if(!this.messagePanel.current)return;if(!this.state.readMarkerEventId)return;null===this.messagePanel.current.getReadMarkerPosition()?this.loadTimeline(this.state.readMarkerEventId,0,1/3):this.messagePanel.current.scrollToEvent(this.state.readMarkerEventId,0,1/3)})),i()(this,"forgetReadMarker",(()=>{if(!this.props.manageReadMarkers)return;const e=this.getCurrentReadReceipt(),t=this.props.timelineSet.getTimelineForEvent(null!=e?e:"");let a;if(t){const n=t.getEvents().find((t=>t.getId()==e));n&&(a=n.getTs())}this.setReadMarker(e,a),this.sendReadReceipt()})),i()(this,"isAtEndOfLiveTimeline",(()=>{var e;return(null===(e=this.messagePanel.current)||void 0===e?void 0:e.isAtBottom())&&this.timelineWindow&&!this.timelineWindow.canPaginate(qs.b.FORWARDS)})),i()(this,"getScrollState",(()=>this.messagePanel.current?this.messagePanel.current.getScrollState():null)),i()(this,"getReadMarkerPosition",(()=>{if(!this.props.manageReadMarkers)return null;if(!this.messagePanel.current)return null;if(!this.props.timelineSet.room)return null;const e=this.messagePanel.current.getReadMarkerPosition();if(null!==e)return e;const t=to.roomReadMarkerTsMap[this.props.timelineSet.room.roomId];return t&&this.state.events.length>0?t<this.state.events[0].getTs()?-1:1:null})),i()(this,"canJumpToReadMarker",(()=>{const e=this.getReadMarkerPosition();return null!==this.state.readMarkerEventId&&(e<0||null===e)})),i()(this,"handleScrollKey",(e=>{if(!this.messagePanel.current)return;Object(J.a)().getRoomAction(e)===W.h.JumpToLatestMessage?this.jumpToLiveTimeline():this.messagePanel.current.handleScrollKey(e)})),i()(this,"getRelationsForEvent",((e,t,a)=>{var n;return null===(n=this.props.timelineSet.relations)||void 0===n?void 0:n.getChildEventsForEvent(e,t,a)})),this.context=t,eo("mounting");let n=null;if(this.props.manageReadMarkers){var o;const e=null===(o=this.props.timelineSet.room)||void 0===o?void 0:o.getAccountData("m.fully_read");n=e?e.getContent().event_id:this.getCurrentReadReceipt()}this.state={events:[],liveEvents:[],timelineLoading:!0,firstVisibleEventIndex:0,canBackPaginate:!1,canForwardPaginate:!1,readMarkerVisible:!0,readMarkerEventId:n,backPaginating:!1,forwardPaginating:!1,clientSyncState:oe.a.get().getSyncState(),isTwelveHour:v.b.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:v.b.getValue("alwaysShowTimestamps"),readMarkerInViewThresholdMs:v.b.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:v.b.getValue("readMarkerOutOfViewThresholdMs")},this.dispatcherRef=b.a.register(this.onAction);const l=oe.a.get();l.on(te.d.Timeline,this.onRoomTimeline),l.on(te.d.TimelineReset,this.onRoomTimelineReset),l.on(te.d.Redaction,this.onRoomRedaction),v.b.getValue("feature_msc3531_hide_messages_pending_moderation")&&(l.on(ja.c.VisibilityChange,this.onEventVisibilityChange),l.on(Ua.b.PowerLevel,this.onVisibilityPowerLevelChange)),l.on(te.d.RedactionCancelled,this.onRoomRedaction),l.on(te.d.Receipt,this.onRoomReceipt),l.on(te.d.LocalEchoUpdated,this.onLocalEchoUpdated),l.on(te.d.AccountData,this.onAccountData),l.on(ja.c.Decrypted,this.onEventDecrypted),l.on(ja.c.Replaced,this.onEventReplaced),l.on(r.b.Sync,this.onSync),null===(a=this.props.timelineSet.room)||void 0===a||a.on(Ra.f.Update,this.onThreadUpdate)}componentDidMount(){this.props.manageReadReceipts&&this.updateReadReceiptOnUserActivity(),this.props.manageReadMarkers&&this.updateReadMarkerOnUserActivity(),this.initTimeline(this.props)}componentDidUpdate(e){var t,a;e.timelineSet!==this.props.timelineSet&&Oa.a.warn("Replacing timelineSet on a TimelinePanel - confusion may ensue"),null===(t=this.props.timelineSet.room)||void 0===t||t.off(Ra.f.Update,this.onThreadUpdate),null===(a=this.props.timelineSet.room)||void 0===a||a.on(Ra.f.Update,this.onThreadUpdate);const n=e.eventId!=this.props.eventId,i=e.highlightedEventId!=this.props.highlightedEventId,s=e.eventScrollIntoView&&!this.props.eventScrollIntoView,o=e.overlayTimelineSet!==this.props.overlayTimelineSet;n||i||s?(Oa.a.log(`TimelinePanel switching to eventId ${this.props.eventId} (was ${e.eventId}), scrollIntoView: ${this.props.eventScrollIntoView} (was ${e.eventScrollIntoView})`),this.initTimeline(this.props)):o&&(Oa.a.log("TimelinePanel updating overlay timeline."),this.initTimeline(this.props))}componentWillUnmount(){this.unmounted=!0,this.readReceiptActivityTimer&&(this.readReceiptActivityTimer.abort(),this.readReceiptActivityTimer=null),this.readMarkerActivityTimer&&(this.readMarkerActivityTimer.abort(),this.readMarkerActivityTimer=null),b.a.unregister(this.dispatcherRef);const e=oe.a.get();var t;e&&(e.removeListener(te.d.Timeline,this.onRoomTimeline),e.removeListener(te.d.TimelineReset,this.onRoomTimelineReset),e.removeListener(te.d.Redaction,this.onRoomRedaction),e.removeListener(te.d.RedactionCancelled,this.onRoomRedaction),e.removeListener(te.d.Receipt,this.onRoomReceipt),e.removeListener(te.d.LocalEchoUpdated,this.onLocalEchoUpdated),e.removeListener(te.d.AccountData,this.onAccountData),e.removeListener(Ua.b.PowerLevel,this.onVisibilityPowerLevelChange),e.removeListener(ja.c.Decrypted,this.onEventDecrypted),e.removeListener(ja.c.Replaced,this.onEventReplaced),e.removeListener(ja.c.VisibilityChange,this.onEventVisibilityChange),e.removeListener(r.b.Sync,this.onSync),null===(t=this.props.timelineSet.room)||void 0===t||t.removeListener(Ra.f.Update,this.onThreadUpdate))}readMarkerTimeout(e){var t,a,n,i;return 0===e?null!==(t=null===(a=this.context)||void 0===a?void 0:a.readMarkerInViewThresholdMs)&&void 0!==t?t:this.state.readMarkerInViewThresholdMs:null!==(n=null===(i=this.context)||void 0===i?void 0:i.readMarkerOutOfViewThresholdMs)&&void 0!==n?n:this.state.readMarkerOutOfViewThresholdMs}async updateReadMarkerOnUserActivity(){const e=this.readMarkerTimeout(this.getReadMarkerPosition());for(this.readMarkerActivityTimer=new Qs.a(e);this.readMarkerActivityTimer;){Js.a.sharedInstance().timeWhileActiveRecently(this.readMarkerActivityTimer);try{await this.readMarkerActivityTimer.finished()}catch(e){continue}this.updateReadMarker()}}async updateReadReceiptOnUserActivity(){for(this.readReceiptActivityTimer=new Qs.a(500);this.readReceiptActivityTimer;){Js.a.sharedInstance().timeWhileActiveNow(this.readReceiptActivityTimer);try{await this.readReceiptActivityTimer.finished()}catch(e){continue}this.sendReadReceipt()}}advanceReadMarkerPastMyEvents(){if(!this.props.manageReadMarkers||!this.timelineWindow)return;const e=this.timelineWindow.getEvents();let t;for(t=0;t<e.length&&e[t].getId()!=this.state.readMarkerEventId;t++);if(t>=e.length)return;const a=oe.a.get().credentials.userId;for(t++;t<e.length;t++){if(e[t].getSender()!==a)break}t--;const n=e[t];this.setReadMarker(n.getId(),n.getTs())}initTimeline(e){const t=e.eventId,a=e.eventPixelOffset;let n=1;return null==a&&(n=.5),this.loadTimeline(t,a,n,e.eventScrollIntoView)}scrollIntoView(e,t,a){var n,i;const s=()=>{this.messagePanel.current&&(e?(eo("TimelinePanel scrolling to eventId "+e+" at position "+100*a+"% + "+t),this.messagePanel.current.scrollToEvent(e,t,a)):(eo("TimelinePanel scrolling to bottom"),this.messagePanel.current.scrollToBottom()))};eo("TimelinePanel scheduling scroll to event"),null===(n=(i=this.props).onEventScrolledIntoView)||void 0===n||n.call(i,e),s(),window.requestAnimationFrame((()=>{s()}))}loadTimeline(e,t,a){let n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const i=oe.a.get();this.timelineWindow=new $s.b(i,this.props.timelineSet,{windowLimit:this.props.timelineCap}),this.overlayTimelineWindow=this.props.overlayTimelineSet?new $s.b(i,this.props.overlayTimelineSet,{windowLimit:this.props.timelineCap}):void 0;const s=()=>{var i,s,o;this.unmounted||(null===(i=this.messagePanel.current)||void 0===i||i.onTimelineReset(),this.reloadEvents(),this.advanceReadMarkerPastMyEvents(),this.setState({canBackPaginate:!(null===(s=this.timelineWindow)||void 0===s||!s.canPaginate(qs.b.BACKWARDS)),canForwardPaginate:!(null===(o=this.timelineWindow)||void 0===o||!o.canPaginate(qs.b.FORWARDS)),timelineLoading:!1},(()=>{this.messagePanel.current?(n&&this.scrollIntoView(e,t,a),this.props.sendReadReceiptOnLoad&&this.sendReadReceipt(),this.removeUnreadMarker()):Oa.a.log("can't initialise scroll state because messagePanel didn't load")})))};var o;if(this.props.timelineSet.getTimelineForEvent(e))return this.timelineWindow.load(e,20),null===(o=this.overlayTimelineWindow)||void 0===o||o.load(void 0,20),void s();const r=this.timelineWindow.load(e,20).then((async()=>{this.overlayTimelineWindow&&await this.overlayTimelineWindow.load(void 0,20)}));this.buildLegacyCallEventGroupers(),this.setState({events:[],liveEvents:[],canBackPaginate:!1,canForwardPaginate:!1,timelineLoading:!0}),r.then(s,(t=>{var a;if(this.unmounted)return;let n,i;this.setState({timelineLoading:!1}),Oa.a.error(`Error loading timeline panel at ${null===(a=this.props.timelineSet.room)||void 0===a?void 0:a.roomId}/${e}`,t),e&&(n=()=>{b.a.dispatch({action:L.a.ViewRoom,room_id:this.props.timelineSet.room.roomId,metricsTrigger:void 0})}),i="M_FORBIDDEN"==t.errcode?Object(N.b)("Tried to load a specific point in this room's timeline, but you do not have permission to view the message in question."):Object(N.b)("Tried to load a specific point in this room's timeline, but was unable to find it."),z.b.createDialog(sn.a,{title:Object(N.b)("Failed to load timeline position"),description:i,onFinished:n})}))}reloadEvents(){if(this.unmounted)return;const e=this.getEvents();this.buildLegacyCallEventGroupers(e.events),this.setState(e)}refreshTimeline(e){this.loadTimeline(e,void 0,void 0,!1),this.reloadEvents()}getEvents(){var e,t,a;const n=(null===(e=this.timelineWindow)||void 0===e?void 0:e.getEvents())||[],i=this.props.overlayTimelineSetFilter||Boolean,s=((null===(t=this.overlayTimelineWindow)||void 0===t?void 0:t.getEvents().filter(i))||[]).reduce(((e,t)=>{const a=e.findIndex((e=>e.localTimestamp>t.localTimestamp));return a>-1?e.splice(a,0,t):e.push(t),e}),[...n]);Object(un.b)(s).reverse().forEach((e=>{oe.a.get().decryptEventIfNeeded(e)}));const o=this.checkForPreJoinUISI(n),r=[...s];if(null===(a=this.timelineWindow)||void 0===a||!a.canPaginate(qs.b.FORWARDS)){const e=this.props.timelineSet.getPendingEvents();s.push(...e.filter((t=>{const{shouldLiveInRoom:a,threadId:n}=this.props.timelineSet.room.eventShouldLiveIn(t,e);return this.context.timelineRenderingType===en.a.Thread?n===this.context.threadId:a})))}return{events:s,liveEvents:r,firstVisibleEventIndex:o}}checkForPreJoinUISI(e){const t=oe.a.get(),a=this.props.timelineSet.room,n=[en.a.Thread,en.a.ThreadsList].includes(this.context.timelineRenderingType);if(0===e.length||!a||!t.isRoomEncrypted(a.roomId)||n)return Oa.a.info("checkForPreJoinUISI: showing all messages, skipping check"),0;const i=t.getSafeUserId();let s=e.length-1,o="leave";for(;s>=0;s--){var r,l,c;const t=this.props.timelineSet.getTimelineForEvent(e[s].getId());if(!t){Oa.a.warn(`Event ${e[s].getId()} in room ${a.roomId} is live, but it does not have a timeline`);continue}o=null!==(r=null===(l=t.getState(qs.b.FORWARDS))||void 0===l||null===(c=l.getMember(i))||void 0===c?void 0:c.membership)&&void 0!==r?r:"leave";const n=t.getEvents();for(let t=n.length-1;t>=0;t--){const a=n[t];if(a.getId()===e[s].getId())break;a.getStateKey()===i&&a.getType()===ee.b.RoomMember&&(o=a.getPrevContent().membership||"leave")}break}for(;s>=0;s--){const t=e[s];if(t.getStateKey()===i&&t.getType()===ee.b.RoomMember)o=t.getPrevContent().membership||"leave";else if("leave"===o&&(t.isDecryptionFailure()||t.isBeingDecrypted()))return Oa.a.info("checkForPreJoinUISI: reached a pre-join UISI at index ",s),s+1}return Oa.a.info("checkForPreJoinUISI: did not find pre-join UISI"),0}indexForEventId(e){if(null===e)return null;if(this.context.timelineRenderingType===en.a.Thread)return 0;const t=this.state.events.findIndex((t=>t.getId()===e));return t>-1?t:null}getVisibleDecryptionFailures(e){const t=this.messagePanel.current;if(!t)return null;const a=qt.a.findDOMNode(t);if(!a)return null;const n=a.getBoundingClientRect(),i=e?100:0,s=n.top-i,o=n.bottom+i,r=[];for(const e of this.state.liveEvents){const a=e.getId();if(!a)continue;const n=t.getNodeForEventId(a);if(!n)continue;const i=n.getBoundingClientRect();if(i.top>o)break;i.bottom>=s&&e.isDecryptionFailure()&&r.push(e)}return r}getLastDisplayedEventIndex(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=e.ignoreOwn||!1,a=e.allowPartial||!1,n=this.messagePanel.current;if(!n)return null;const i=qt.a.findDOMNode(n);if(!i)return null;const s=i.getBoundingClientRect(),o=oe.a.get().credentials.userId,r=e=>{if(e){const t=e.getBoundingClientRect();if(a&&t.top<=s.bottom||!a&&t.bottom<=s.bottom)return!0}return!1};let l=0;for(let e=this.state.liveEvents.length-1;e>=0;--e){var c;const a=this.state.liveEvents[e],i=n.getNodeForEventId(a.getId()),s=r(i);if(s&&0!==l)return e+l;i&&!s&&(l=0);const d=!!a.status||t&&a.getSender()===o;if(!(!Object(wi.c)(a,null===(c=this.context)||void 0===c?void 0:c.showHiddenEvents)||Object(Ta.a)(a,this.context))&&i){if(!d&&s)return e}else(!d||d&&0!==l)&&++l}return null}getCurrentReadReceipt(){var e,t;let a=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const n=oe.a.get();if(null==n)return null;const i=n.getSafeUserId(),s=null!==(e=this.props.timelineSet.thread)&&void 0!==e?e:this.props.timelineSet.room;return null!==(t=null==s?void 0:s.getEventReadUpTo(i,a))&&void 0!==t?t:null}setReadMarker(e,t){var a;let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=null===(a=this.props.timelineSet.room)||void 0===a?void 0:a.roomId;e!==this.state.readMarkerEventId&&null!==e&&(to.roomReadMarkerTsMap[null!=i?i:""]=t,n||this.setState({readMarkerEventId:e},this.props.onReadMarkerUpdated))}shouldPaginate(){return!this.state.events.some((e=>e.isBeingDecrypted()))}buildLegacyCallEventGroupers(e){this.callEventGroupers=Object(Zs.c)(this.callEventGroupers,e)}render(){var e,t,a,n,i;if(this.state.timelineLoading)return o.a.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},o.a.createElement(Zn.a,null));if(0==this.state.events.length&&!this.state.canBackPaginate&&this.props.empty)return o.a.createElement("div",{className:this.props.className+" mx_RoomView_messageListWrapper"},o.a.createElement("div",{className:"mx_RoomView_empty"},this.props.empty));const s=!this.timelineWindow.canPaginate(qs.b.FORWARDS),r=this.state.forwardPaginating||["PREPARED","CATCHUP"].includes(this.state.clientSyncState),l=this.state.firstVisibleEventIndex?this.state.events.slice(this.state.firstVisibleEventIndex):this.state.events;return o.a.createElement(Xs.a,{ref:this.messagePanel,room:this.props.timelineSet.room,permalinkCreator:this.props.permalinkCreator,hidden:this.props.hidden,backPaginating:this.state.backPaginating,forwardPaginating:r,events:l,highlightedEventId:this.props.highlightedEventId,readMarkerEventId:this.state.readMarkerEventId,readMarkerVisible:this.state.readMarkerVisible,canBackPaginate:this.state.canBackPaginate&&0===this.state.firstVisibleEventIndex,showUrlPreview:this.props.showUrlPreview,showReadReceipts:this.props.showReadReceipts,ourUserId:oe.a.get().getSafeUserId(),stickyBottom:s,onScroll:this.onMessageListScroll,onFillRequest:this.onMessageListFillRequest,onUnfillRequest:this.onMessageListUnfillRequest,isTwelveHour:null!==(e=null===(t=this.context)||void 0===t?void 0:t.showTwelveHourTimestamps)&&void 0!==e?e:this.state.isTwelveHour,alwaysShowTimestamps:null!==(a=null!==(n=this.props.alwaysShowTimestamps)&&void 0!==n?n:null===(i=this.context)||void 0===i?void 0:i.alwaysShowTimestamps)&&void 0!==a?a:this.state.alwaysShowTimestamps,className:this.props.className,resizeNotifier:this.props.resizeNotifier,getRelationsForEvent:this.getRelationsForEvent,editState:this.props.editState,showReactions:this.props.showReactions,layout:this.props.layout,singleSideBubbles:this.props.singleSideBubbles,userNameColorMode:this.props.userNameColorMode,youtubeEmbedPlayer:this.props.youtubeEmbedPlayer,hideThreadedMessages:this.props.hideThreadedMessages,disableGrouping:this.props.disableGrouping,callEventGroupers:this.callEventGroupers})}}function ao(e){return e.map((e=>{const t={},a=e.getTimelines(),n=e.getLiveTimeline();return a.forEach(((e,a)=>{t[e===n?"liveTimeline":`${a}`]=e.getEvents().map((e=>e.getId()))})),t}))}i()(to,"contextType",en.b),i()(to,"roomReadMarkerTsMap",{}),i()(to,"defaultProps",{timelineCap:Number.MAX_VALUE,className:"mx_RoomView_messagePanel",sendReadReceiptOnLoad:!0,hideThreadedMessages:!0,disableGrouping:!1});var no=to,io=a(173);class so extends o.a.PureComponent{constructor(e){super(e),i()(this,"instanceId",void 0),i()(this,"onResize",((e,t)=>{e===Q.a.Resize&&this.props.onMeasurement(t.contentRect.width<=this.props.breakpoint)})),this.instanceId=so.instanceCount++}componentDidMount(){Q.b.instance.on(`Measured${this.instanceId}`,this.onResize)}componentDidUpdate(e){const t=e.sensor,a=this.props.sensor;t!==a&&(t&&Q.b.instance.stopTrackingElementDimensions(`Measured${this.instanceId}`),a&&Q.b.instance.trackElementDimensions(`Measured${this.instanceId}`,this.props.sensor))}componentWillUnmount(){Q.b.instance.off(`Measured${this.instanceId}`,this.onResize),Q.b.instance.stopTrackingElementDimensions(`Measured${this.instanceId}`)}render(){return null}}function oo(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function ro(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?oo(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):oo(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}i()(so,"instanceCount",0),i()(so,"defaultProps",{breakpoint:500});class lo extends o.a.Component{constructor(){super(...arguments),i()(this,"decryptingEvents",new Set),i()(this,"noRoom",void 0),i()(this,"card",Object(s.createRef)()),i()(this,"state",{timelineSet:null,narrow:!1}),i()(this,"onRoomTimeline",((e,t,a,n,i)=>{var s;if((null==t?void 0:t.roomId)!==(null===(s=this.props)||void 0===s?void 0:s.roomId))return;if(a||!i||!i.liveEvent||e.isRedacted())return;oe.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()?this.decryptingEvents.add(e.getId()):this.addEncryptedLiveEvent(e)})),i()(this,"onEventDecrypted",((e,t)=>{if(e.getRoomId()!==this.props.roomId)return;const a=e.getId();this.decryptingEvents.delete(a)&&(t||this.addEncryptedLiveEvent(e))})),i()(this,"onPaginationRequest",((e,t,a)=>{const n=oe.a.get(),i=Hs.a.get(),s=this.props.roomId,o=n.getRoom(s);return o&&n.isRoomEncrypted(s)&&null!==i?i.paginateTimelineWindow(o,e,t,a):e.paginate(t,a)})),i()(this,"onMeasurement",(e=>{this.setState({narrow:e})}))}addEncryptedLiveEvent(e){if(!this.state.timelineSet)return;const t=this.state.timelineSet.getLiveTimeline();"m.room.message"===e.getType()&&["m.file","m.image","m.video","m.audio"].includes(e.getContent().msgtype)&&(this.state.timelineSet.eventIdToTimeline(e.getId())||this.state.timelineSet.addEventToTimeline(e,t,!1))}async componentDidMount(){const e=oe.a.get();await this.updateTimelineSet(this.props.roomId),oe.a.get().isRoomEncrypted(this.props.roomId)&&null!==Hs.a.get()&&(e.on(te.d.Timeline,this.onRoomTimeline),e.on(ja.c.Decrypted,this.onEventDecrypted))}componentWillUnmount(){const e=oe.a.get();null!==e&&oe.a.get().isRoomEncrypted(this.props.roomId)&&null!==Hs.a.get()&&(e.removeListener(te.d.Timeline,this.onRoomTimeline),e.removeListener(ja.c.Decrypted,this.onEventDecrypted))}async fetchFileEventsServer(e){const t=oe.a.get(),a=new zs.a(t.credentials.userId);return a.setDefinition({room:{timeline:{contains_url:!0,types:["m.room.message"]}}}),a.filterId=await t.getOrCreateFilter("FILTER_FILES_"+t.credentials.userId,a),e.getOrCreateFilteredTimelineSet(a)}async updateTimelineSet(e){const t=oe.a.get(),a=t.getRoom(e),n=Hs.a.get();if(this.noRoom=!a,a){let i;try{if(i=await this.fetchFileEventsServer(a),t.isRoomEncrypted(e)&&null!==n){const e=i.getLiveTimeline();await n.populateFileTimeline(i,e,a,10)}this.setState({timelineSet:i})}catch(e){Oa.a.error("Failed to get or create file panel filter",e)}}else Oa.a.error("Failed to add filtered timelineSet for FilePanel as no room!")}render(){if(oe.a.get().isGuest())return o.a.createElement(za,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose},o.a.createElement("div",{className:"mx_RoomView_empty"},Object(N.b)("You must <a>register</a> to use this functionality",{},{a:e=>o.a.createElement("a",{href:"#/register",key:"sub"},e)})));if(this.noRoom)return o.a.createElement(za,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose},o.a.createElement("div",{className:"mx_RoomView_empty"},Object(N.b)("You must join the room to see its files")));const e=o.a.createElement("div",{className:"mx_RightPanel_empty mx_FilePanel_empty"},o.a.createElement("h2",null,Object(N.b)("No files visible in this room")),o.a.createElement("p",null,Object(N.b)("Attach files from chat or just drag and drop them anywhere in a room."))),t=!this.noRoom&&oe.a.get().isRoomEncrypted(this.props.roomId);return this.state.timelineSet?o.a.createElement(en.b.Provider,{value:ro(ro({},this.context),{},{timelineRenderingType:en.a.File,narrow:this.state.narrow})},o.a.createElement(za,{className:"mx_FilePanel",onClose:this.props.onClose,withoutScrollContainer:!0,ref:this.card},o.a.createElement(so,{sensor:this.card.current,onMeasurement:this.onMeasurement}),o.a.createElement(Gs,{isRoomEncrypted:t,kind:Ks.Files}),o.a.createElement(no,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:this.state.timelineSet,showUrlPreview:!1,onPaginationRequest:this.onPaginationRequest,resizeNotifier:this.props.resizeNotifier,empty:e,layout:io.a.Group,userNameColorMode:this.props.userNameColorMode}))):o.a.createElement(en.b.Provider,{value:ro(ro({},this.context),{},{timelineRenderingType:en.a.File})},o.a.createElement(za,{className:"mx_FilePanel",onClose:this.props.onClose},o.a.createElement(Zn.a,null)))}}i()(lo,"contextType",en.b);var co=lo;class mo extends o.a.Component{constructor(e){super(e),i()(this,"resize",(()=>{this.props.onResize&&this.props.onResize()}))}componentDidMount(){window.addEventListener("resize",this.resize)}componentWillUnmount(){window.removeEventListener("resize",this.resize)}render(){return o.a.createElement("div",null,this.props.element)}}const ho="stickerPicker";class uo extends o.a.PureComponent{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"prevSentVisibility",void 0),i()(this,"popoverWidth",400),i()(this,"popoverHeight",450),i()(this,"scalarClient",null),i()(this,"removeStickerpickerWidgets",(async()=>{const e=await this.acquireScalarClient();Oa.a.log("Removing Stickerpicker widgets"),this.state.widgetId?e?e.disableWidgetAssets(on.a.STICKERPICKER,this.state.widgetId).then((()=>{Oa.a.log("Assets disabled")})).catch((()=>{Oa.a.error("Failed to disable assets")})):Oa.a.error("Cannot disable assets: no scalar client"):Oa.a.warn("No widget ID specified, not disabling assets"),this.props.setStickerPickerOpen(!1),Ka.a.removeStickerpickerWidgets().then((()=>{this.forceUpdate()})).catch((e=>{Oa.a.error("Failed to remove sticker picker widget",e)}))})),i()(this,"updateWidget",(()=>{var e,t,a,n;const i=Ka.a.getStickerpickerWidgets()[0];if(!i)return uo.currentWidget=void 0,void this.setState({stickerpickerWidget:null,widgetId:null});const s=uo.currentWidget,o=null!==(e=null==s||null===(t=s.content)||void 0===t?void 0:t.url)&&void 0!==e?e:null;(null!==(a=null==i||null===(n=i.content)||void 0===n?void 0:n.url)&&void 0!==a?a:null)!==o&&$i.destroyElement(ho),uo.currentWidget=i,this.setState({stickerpickerWidget:i,widgetId:i?i.id:null})})),i()(this,"onAction",(e=>{switch(e.action){case"user_widget_updated":this.forceUpdate();break;case"stickerpicker_close":case"show_left_panel":case"hide_left_panel":this.props.setStickerPickerOpen(!1)}})),i()(this,"onRightPanelStoreUpdate",(()=>{this.props.setStickerPickerOpen(!1)})),i()(this,"onResize",(()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)})),i()(this,"onFinished",(()=>{this.props.isStickerPickerOpen&&this.props.setStickerPickerOpen(!1)})),i()(this,"launchManageIntegrations",(()=>{var e,t,a;null===(e=Ga.a.sharedInstance())||void 0===e||null===(t=e.getPrimaryManager())||void 0===t||t.open(this.props.room,`type_${on.a.STICKERPICKER.preferred}`,null!==(a=this.state.widgetId)&&void 0!==a?a:void 0)})),this.state={imError:null,stickerpickerWidget:null,widgetId:null}}async acquireScalarClient(){return this.scalarClient?Promise.resolve(this.scalarClient):Ga.a.sharedInstance().hasManager()?(this.scalarClient=null!==(e=null===(t=Ga.a.sharedInstance().getPrimaryManager())||void 0===t?void 0:t.getScalarClient())&&void 0!==e?e:null,null===(a=this.scalarClient)||void 0===a?void 0:a.connect().then((()=>(this.forceUpdate(),this.scalarClient))).catch((e=>{this.imError(Object(N.d)("Failed to connect to integration manager"),e)}))):void Ga.a.sharedInstance().openNoManagerDialog();var e,t,a}componentDidMount(){window.addEventListener("resize",this.onResize),this.dispatcherRef=b.a.register(this.onAction),oe.a.get().on(te.d.AccountData,this.updateWidget),Fa.a.instance.on(Et.b,this.onRightPanelStoreUpdate),this.updateWidget()}componentWillUnmount(){const e=oe.a.get();e&&e.removeListener(te.d.AccountData,this.updateWidget),Fa.a.instance.off(Et.b,this.onRightPanelStoreUpdate),window.removeEventListener("resize",this.onResize),this.dispatcherRef&&b.a.unregister(this.dispatcherRef)}componentDidUpdate(){this.sendVisibilityToWidget(this.props.isStickerPickerOpen)}imError(e,t){Oa.a.error(e,t),this.setState({imError:Object(N.b)(e)}),this.props.setStickerPickerOpen(!1)}defaultStickerpickerContent(){return o.a.createElement(K.a,{onClick:this.launchManageIntegrations,className:"mx_Stickers_contentPlaceholder"},o.a.createElement("p",null,Object(N.b)("You don't currently have any stickerpacks enabled")),o.a.createElement("p",{className:"mx_Stickers_addLink"},Object(N.b)("Add some now")),o.a.createElement("img",{src:a(1707),alt:""}))}errorStickerpickerContent(){return o.a.createElement("div",{style:{textAlign:"center"},className:"error"},o.a.createElement("p",null," ",this.state.imError," "))}sendVisibilityToWidget(e){if(!this.state.stickerpickerWidget)return;const t=nn.a.instance.getMessagingForUid(Ka.a.calcWidgetUid(this.state.stickerpickerWidget.id));t&&e!==this.prevSentVisibility&&(t.updateVisibility(e).catch((e=>{Oa.a.error("Error updating widget visibility: ",e)})),this.prevSentVisibility=e)}getStickerpickerContent(){if(this.state.imError)return this.errorStickerpickerContent();const e=this.state.stickerpickerWidget;let t;if(e&&e.content&&e.content.url){e.content.name=e.content.name||Object(N.b)("Stickerpack");const a={id:e.id,url:e.content.url,name:e.content.name,type:e.content.type,data:e.content.data,roomId:e.content.roomId,eventId:e.content.eventId,avatar_url:e.content.avatar_url,creatorUserId:e.content.creatorUserId||e.sender};t=o.a.createElement("div",{className:"mx_Stickers_content_container"},o.a.createElement("div",{id:"stickersContent",className:"mx_Stickers_content",style:{border:"none",height:this.popoverHeight,width:this.popoverWidth}},o.a.createElement($i,{persistKey:ho,zIndex:3500},o.a.createElement(Qi,{app:a,room:this.props.room,threadId:this.props.threadId,fullWidth:!0,userId:oe.a.get().credentials.userId,creatorUserId:e.sender||oe.a.get().credentials.userId,waitForIframeLoad:!0,showMenubar:!0,onEditClick:this.launchManageIntegrations,onDeleteClick:this.removeStickerpickerWidgets,showTitle:!1,showPopout:!1,handleMinimisePointerEvents:!0,userWidget:!0,showLayoutButtons:!1}))))}else t=this.defaultStickerpickerContent();return t}render(){return this.props.isStickerPickerOpen?o.a.createElement(de.n,Z()({chevronFace:de.a.Bottom,menuWidth:this.popoverWidth,menuHeight:this.popoverHeight,onFinished:this.onFinished,menuPaddingTop:0,menuPaddingLeft:0,menuPaddingRight:0,zIndex:3500},this.props.menuPosition),o.a.createElement(mo,{element:this.getStickerpickerContent(),onResize:this.onFinished})):null}}i()(uo,"defaultProps",{threadId:null}),i()(uo,"currentWidget",void 0);var po=a(1028);class go extends o.a.Component{render(){return this.props.replyToEvent?o.a.createElement("div",{className:"mx_ReplyPreview"},o.a.createElement("div",{className:"mx_ReplyPreview_section"},o.a.createElement("div",{className:"mx_ReplyPreview_header"},o.a.createElement("span",null,Object(N.b)("Replying")),o.a.createElement(K.a,{className:"mx_ReplyPreview_header_cancel",onClick:()=>{return e=this.context.timelineRenderingType,void b.a.dispatch({action:"reply_to_event",event:null,context:e});var e}})),o.a.createElement(po.a,{mxEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator,userNameColorMode:this.props.userNameColorMode}))):null}}i()(go,"contextType",en.b);var bo=a(365),vo=a(921),fo=a(411);class Eo extends o.a.PureComponent{constructor(e){super(e),i()(this,"waveform",[]),i()(this,"scheduledUpdate",new fo.a((()=>this.updateWaveform()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),this.state={waveform:Object(un.h)(0,bo.a)}}componentDidMount(){this.props.recorder.liveData.onUpdate((e=>{this.waveform=Object(un.c)(Array.from(e.waveform),bo.a),this.scheduledUpdate.mark()}))}updateWaveform(){this.setState({waveform:this.waveform})}render(){return o.a.createElement(vo.a,{relHeights:this.state.waveform})}}i()(Eo,"defaultProps",{progress:1});var yo=a(351);class _o extends o.a.PureComponent{constructor(e){super(e),i()(this,"seconds",0),i()(this,"scheduledUpdate",new fo.a((()=>this.updateClock()),(()=>requestAnimationFrame((()=>this.scheduledUpdate.trigger()))))),this.state={seconds:0}}componentDidMount(){this.props.recorder.liveData.onUpdate((e=>{this.seconds=e.timeSeconds,this.scheduledUpdate.mark()}))}updateClock(){this.setState({seconds:this.seconds})}render(){return o.a.createElement(yo.a,{seconds:this.state.seconds,"aria-live":"off"})}}var So=a(611),wo=a(259);class Oo{constructor(e,t){this.matrixClient=e,this.voiceRecording=t,i()(this,"lastUpload",void 0),i()(this,"buffer",new Uint8Array(0)),i()(this,"playback",void 0),i()(this,"onDataAvailable",(e=>{const t=new Uint8Array(e);this.buffer=Object(un.m)(this.buffer,t)})),this.voiceRecording.onDataAvailable=this.onDataAvailable}async start(){if(this.lastUpload||this.hasRecording)throw new Error("Recording already prepared");return this.voiceRecording.start()}async stop(){return await this.voiceRecording.stop(),this.audioBuffer}on(e,t){return this.voiceRecording.on(e,t),this}off(e,t){return this.voiceRecording.off(e,t),this}emit(e){for(var t=arguments.length,a=new Array(t>1?t-1:0),n=1;n<t;n++)a[n-1]=arguments[n];return this.voiceRecording.emit(e,...a)}get hasRecording(){return this.buffer.length>0}get isRecording(){return this.voiceRecording.isRecording}getPlayback(){return this.playback=So.a.for(this,"playback").do((()=>new wo.c(this.audioBuffer.buffer,this.voiceRecording.amplitudes))),this.playback}async upload(e){if(!this.hasRecording)throw new Error("No recording available to upload");if(this.lastUpload)return this.lastUpload;try{this.emit(bo.b.Uploading);const{url:t,file:a}=await Object(Pa.b)(this.matrixClient,e,new Blob([this.audioBuffer],{type:this.contentType}));this.lastUpload={mxc:t,encrypted:a},this.emit(bo.b.Uploaded)}catch(e){throw this.emit(bo.b.Ended),e}return this.lastUpload}get durationSeconds(){return this.voiceRecording.durationSeconds}get contentType(){return this.voiceRecording.contentType}get contentLength(){return this.buffer.length}get liveData(){return this.voiceRecording.liveData}get isSupported(){return this.voiceRecording.isSupported}destroy(){var e;null===(e=this.playback)||void 0===e||e.destroy(),this.voiceRecording.destroy()}get audioBuffer(){return this.buffer.slice(0)}}function Co(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var n=a.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function xo(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function jo(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?xo(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):xo(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class ko extends Nn.a{constructor(){super(b.a,{})}static get instance(){return this.internalInstance||(this.internalInstance=new ko,this.internalInstance.start()),this.internalInstance}async onAction(e){}static getVoiceRecordingId(e,t){return"io.element.thread"===(null==t?void 0:t.rel_type)||(null==t?void 0:t.rel_type)===ee.h.Thread?e.roomId+"|"+t.event_id:e.roomId}getActiveRecording(e){return this.state[e]}startRecording(e){if(!this.matrixClient)throw new Error("Cannot start a recording without a MatrixClient");if(!e)throw new Error("Recording must be associated with a room");if(this.state[e])throw new Error("A recording is already in progress");const t=(a=this.matrixClient,new Oo(a,new bo.d));var a;return this.updateState(jo(jo({},this.state),{},{[e]:t})),t}disposeRecording(e){var t;null===(t=this.state[e])||void 0===t||t.destroy();const a=this.state,{[e]:n}=a,i=ve()(a,[e].map(Co));return this.reset(i)}}i()(ko,"internalInstance",void 0),window.mxVoiceRecordingStore=ko.instance;var Ro=a(1027),Io=a(521),To=a(276),No=a(348),Po=a(217),Do=a(894);class Mo extends o.a.PureComponent{constructor(e){super(e),i()(this,"context",void 0),i()(this,"voiceRecordingId",void 0),i()(this,"onCancel",(async()=>{await this.disposeRecording()})),i()(this,"onRecordStartEndClick",(async()=>{if(this.state.recorder)return void await this.state.recorder.stop();const e=()=>{z.b.createDialog(sn.a,{title:Object(N.b)("Unable to access your microphone"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(N.b)("We were unable to access your microphone. Please check your browser settings and try again.")))})};try{var t;const e=await p.c.getDevices();if(null==e||null===(t=e[p.b.AudioInput])||void 0===t||!t.length)return void z.b.createDialog(sn.a,{title:Object(N.b)("No microphone found"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(N.b)("We didn't find a microphone on your device. Please check your settings and try again.")))})}catch(t){return Oa.a.error("Error getting devices: ",t),void e()}try{Io.a.instance.pauseAllExcept();const e=ko.instance.startRecording(this.voiceRecordingId);await e.start(),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:bo.b.Started})}catch(t){Oa.a.error("Error starting recording: ",t),e(),ko.instance.disposeRecording(this.voiceRecordingId)}})),i()(this,"onRecordingUpdate",(e=>{e!==bo.b.EndingSoon&&this.setState({recordingPhase:e})})),this.state={},this.voiceRecordingId=ko.getVoiceRecordingId(this.props.room,this.props.relation)}componentDidMount(){const e=ko.instance.getActiveRecording(this.voiceRecordingId);e&&(!e.isRecording&&e.hasRecording||Oa.a.warn("Cached recording hasn't ended yet and might cause issues"),this.bindNewRecorder(e),this.setState({recorder:e,recordingPhase:bo.b.Ended}))}async componentWillUnmount(){const e=ko.instance.getActiveRecording(this.voiceRecordingId);await(null==e?void 0:e.stop()),this.bindNewRecorder(null)}async send(){if(!this.state.recorder)throw new Error("No recording started - cannot send anything");const{replyToEvent:e,relation:t,permalinkCreator:a}=this.props;let n;await this.state.recorder.stop();try{n=await this.state.recorder.upload(this.voiceRecordingId)}catch(e){return Oa.a.error("Error uploading voice message:",e),void this.setState({didUploadFail:!0})}try{const i=Object(Do.a)(n.mxc,this.state.recorder.contentType,Math.round(1e3*this.state.recorder.durationSeconds),this.state.recorder.contentLength,n.encrypted,this.state.recorder.getPlayback().thumbnailWaveform.map((e=>Math.round(1024*e))));Object(No.a)(oe.a.get().getSafeUserId(),i,null,e),Object(No.b)(i,t),e&&(Object(Po.a)(i,e,{permalinkCreator:a,includeLegacyFallback:!0}),b.a.dispatch({action:"reply_to_event",event:null,context:this.context.timelineRenderingType})),Object(To.a)(this.props.room.roomId,(e=>oe.a.get().sendMessage(e,i)))}catch(e){Oa.a.error("Error sending voice message:",e)}await this.disposeRecording()}async disposeRecording(){await ko.instance.disposeRecording(this.voiceRecordingId),this.setState({recorder:void 0,recordingPhase:void 0,didUploadFail:!1})}bindNewRecorder(e){this.state.recorder&&this.state.recorder.off(Et.b,this.onRecordingUpdate),e&&e.on(Et.b,this.onRecordingUpdate)}renderWaveformArea(){return this.state.recorder?this.state.recordingPhase!==bo.b.Started?o.a.createElement(Ro.b,{playback:this.state.recorder.getPlayback(),layout:Ro.a.Composer}):o.a.createElement("div",{className:"mx_MediaBody mx_VoiceMessagePrimaryContainer mx_VoiceRecordComposerTile_recording"},o.a.createElement(_o,{recorder:this.state.recorder}),o.a.createElement(Eo,{recorder:this.state.recorder})):null}render(){if(!this.state.recordingPhase)return null;let e,t,a;if(this.state.recordingPhase===bo.b.Started){var n;let t=Object(N.b)("Send voice message");this.state.recorder&&(t=Object(N.b)("Stop recording")),e=o.a.createElement(q.a,{className:"mx_VoiceRecordComposerTile_stop",onClick:this.onRecordStartEndClick,title:t}),!this.state.recorder||null!==(n=this.state.recorder)&&void 0!==n&&n.isRecording||(e=null)}return this.state.recorder&&this.state.recordingPhase!==bo.b.Uploading&&(t=o.a.createElement(q.a,{className:"mx_VoiceRecordComposerTile_delete",title:Object(N.b)("Delete"),onClick:this.onCancel})),this.state.recordingPhase===bo.b.Uploading?a=o.a.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadingState"},o.a.createElement(pe.a,{w:16,h:16})):this.state.didUploadFail&&this.state.recordingPhase===bo.b.Ended&&(a=o.a.createElement("span",{className:"mx_VoiceRecordComposerTile_failedState"},o.a.createElement("span",{className:"mx_VoiceRecordComposerTile_uploadState_badge"},o.a.createElement(we.a,{notification:Ce.a.forSymbol("!",xe.a.Red)})),o.a.createElement("span",{className:"text-warning"},Object(N.b)("Failed to send")))),o.a.createElement(o.a.Fragment,null,a,t,e,this.renderWaveformArea())}}i()(Mo,"contextType",en.b);var Ao=a(164),Uo=a(688),Lo=a(224),Fo=a(291),Bo=a(1023);let Vo=0;function Wo(e){var t;const a=c()("mx_MessageComposer_sendMessage",{mx_MessageComposer_sendMessage_enabled:e.enabled});return o.a.createElement(q.a,{className:a,onClick:e.onClick,title:null!==(t=e.title)&&void 0!==t?t:Object(N.b)("Send message"),"data-testid":"sendmessagebtn"})}class zo extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"messageComposerInput",Object(s.createRef)()),i()(this,"voiceRecordingButton",Object(s.createRef)()),i()(this,"ref",Object(s.createRef)()),i()(this,"instanceId",void 0),i()(this,"_voiceRecording",void 0),i()(this,"context",void 0),i()(this,"onResize",((e,t)=>{if(e===Q.a.Resize){const{narrow:e}=this.context;this.setState({isMenuOpen:!!e&&this.state.isMenuOpen,isStickerPickerOpen:!1})}})),i()(this,"onAction",(e=>{switch(e.action){case"reply_to_event":e.context===this.context.timelineRenderingType&&window.setTimeout((()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()}),100);break;case L.a.SettingUpdated:{const t=e;switch(t.settingName){case"MessageComposerInput.showStickersButton":{const e=v.b.getValue("MessageComposerInput.showStickersButton");this.state.showStickersButton!==e&&this.setState({showStickersButton:e});break}case"MessageComposerInput.collapseButtons":{const e=v.b.getValue("MessageComposerInput.collapseButtons");this.state.collapseButtons!==e&&this.setState({collapseButtons:e});break}case"MessageComposerInput.showPollsButton":{const e=v.b.getValue("MessageComposerInput.showPollsButton");this.state.showPollsButton!==e&&this.setState({showPollsButton:e});break}case Fo.a.VoiceBroadcast:this.state.showVoiceBroadcastButton!==t.newValue&&this.setState({showVoiceBroadcastButton:!!t.newValue});break;case"feature_wysiwyg_composer":this.state.isWysiwygLabEnabled!==t.newValue&&this.setState({isWysiwygLabEnabled:Boolean(t.newValue)})}}}})),i()(this,"onTombstoneClick",(e=>{var t,a;e.preventDefault();const n=null===(t=this.context.tombstone)||void 0===t?void 0:t.getContent().replacement_room,i=oe.a.get().getRoom(n);let s;if(i){const e=i.currentState.getStateEvents(ee.b.RoomCreate,"");null!=e&&e.getId()&&(s=e.getId())}const o=null===(a=this.context.tombstone)||void 0===a?void 0:a.getSender(),r=o?[o.split(":").slice(1).join(":")]:void 0;b.a.dispatch({action:L.a.ViewRoom,highlighted:!0,event_id:s,room_id:n,auto_join:!0,via_servers:r,metricsTrigger:"Tombstone",metricsViaKeyboard:"click"!==e.type})})),i()(this,"renderPlaceholderText",(()=>{if(this.props.replyToEvent){var e;const t=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===Ra.d.name;return t&&this.props.e2eStatus?Object(N.b)("Reply to encrypted thread…"):t?Object(N.b)("Reply to thread…"):this.props.e2eStatus?Object(N.b)("Send an encrypted reply…"):Object(N.b)("Send a reply…")}return this.props.e2eStatus?Object(N.b)("Send an encrypted message…"):Object(N.b)("Send a message…")})),i()(this,"addEmoji",(e=>(b.a.dispatch({action:L.a.ComposerInsert,emoji:e,timelineRenderingType:this.context.timelineRenderingType}),!0))),i()(this,"sendMessage",(async()=>{var e,t;if(this.state.haveRecording&&this.voiceRecordingButton.current)await(null===(t=this.voiceRecordingButton.current)||void 0===t?void 0:t.send());else if(null===(e=this.messageComposerInput.current)||void 0===e||e.sendMessage(),this.state.isWysiwygLabEnabled){const{permalinkCreator:e,relation:t,replyToEvent:a}=this.props,n=this.state.composerContent;this.setState({composerContent:"",initialComposerContent:""}),b.a.dispatch({action:L.a.ClearAndFocusSendMessageComposer,timelineRenderingType:this.context.timelineRenderingType}),await Object(Bo.d)(n,this.state.isRichTextEnabled,{mxClient:this.props.mxClient,roomContext:this.context,permalinkCreator:e,relation:t,replyToEvent:a})}})),i()(this,"onChange",(e=>{this.setState({isComposerEmpty:e.isEmpty})})),i()(this,"onWysiwygChange",(e=>{this.setState({composerContent:e,isComposerEmpty:0===(null==e?void 0:e.length)})})),i()(this,"onRichTextToggle",(async()=>{const{richToPlain:e,plainToRich:t}=await Object(Bo.c)(),{isRichTextEnabled:a,composerContent:n}=this.state,i=a?await e(n):await t(n);this.setState({isRichTextEnabled:!a,composerContent:i,initialComposerContent:i})})),i()(this,"onVoiceStoreUpdate",(()=>{this.updateRecordingState()})),i()(this,"onRecordingStarted",(()=>{const e=ko.getVoiceRecordingId(this.props.room,this.props.relation);this.voiceRecording=ko.instance.getActiveRecording(e),this.setState({haveRecording:!!this.voiceRecording})})),i()(this,"onRecordingEndingSoon",(e=>{let{secondsLeft:t}=e;this.setState({recordingTimeLeftSeconds:t}),window.setTimeout((()=>this.setState({recordingTimeLeftSeconds:void 0})),3e3)})),i()(this,"setStickerPickerOpen",(e=>{this.setState({isStickerPickerOpen:e,isMenuOpen:!1})})),i()(this,"toggleStickerPickerOpen",(()=>{this.setStickerPickerOpen(!this.state.isStickerPickerOpen)})),i()(this,"toggleButtonMenu",(()=>{this.setState({isMenuOpen:!this.state.isMenuOpen})})),i()(this,"onRecordStartEndClick",(()=>{const e=at.b.instance.voiceBroadcastRecordingsStore.getCurrent();var t;e&&e.getState()!==Ct.h.Stopped?z.b.createDialog(lt.a,{title:Object(N.b)("Can't start voice message"),description:o.a.createElement("p",null,Object(N.b)("You can't start a voice message as you are currently recording a live broadcast. Please end your live broadcast in order to start recording a voice message.")),hasCloseButton:!0}):null===(t=this.voiceRecordingButton.current)||void 0===t||t.onRecordStartEndClick();this.context.narrow&&this.toggleButtonMenu()})),ko.instance.on(Et.b,this.onVoiceStoreUpdate),this.state={isComposerEmpty:!0,composerContent:"",haveRecording:!1,recordingTimeLeftSeconds:void 0,isMenuOpen:!1,isStickerPickerOpen:!1,showStickersButton:v.b.getValue("MessageComposerInput.showStickersButton"),collapseButtons:v.b.getValue("MessageComposerInput.collapseButtons"),showPollsButton:v.b.getValue("MessageComposerInput.showPollsButton"),showVoiceBroadcastButton:v.b.getValue(Fo.a.VoiceBroadcast),isWysiwygLabEnabled:v.b.getValue("feature_wysiwyg_composer"),isRichTextEnabled:!0,initialComposerContent:""},this.instanceId=Vo++,v.b.monitorSetting("MessageComposerInput.showStickersButton",null),v.b.monitorSetting("MessageComposerInput.collapseButtons",null),v.b.monitorSetting("MessageComposerInput.showPollsButton",null),v.b.monitorSetting(Fo.a.VoiceBroadcast,null),v.b.monitorSetting("feature_wysiwyg_composer",null)}get voiceRecording(){return this._voiceRecording}set voiceRecording(e){this._voiceRecording&&(this._voiceRecording.off(bo.b.Started,this.onRecordingStarted),this._voiceRecording.off(bo.b.EndingSoon,this.onRecordingEndingSoon)),this._voiceRecording=e,e&&(e.on(bo.b.Started,this.onRecordingStarted),e.on(bo.b.EndingSoon,this.onRecordingEndingSoon))}componentDidMount(){this.dispatcherRef=b.a.register(this.onAction),this.waitForOwnMember(),Q.b.instance.trackElementDimensions(`MessageComposer${this.instanceId}`,this.ref.current),Q.b.instance.on(`MessageComposer${this.instanceId}`,this.onResize),this.updateRecordingState()}waitForOwnMember(){const e=this.props.room.getMember(oe.a.get().getUserId());e?this.setState({me:e}):this.props.room.loadMembersIfNeeded().then((()=>{var e;const t=null!==(e=this.props.room.getMember(oe.a.get().getSafeUserId()))&&void 0!==e?e:void 0;this.setState({me:t})}))}componentWillUnmount(){ko.instance.off(Et.b,this.onVoiceStoreUpdate),this.dispatcherRef&&b.a.unregister(this.dispatcherRef),Q.b.instance.stopTrackingElementDimensions(`MessageComposer${this.instanceId}`),Q.b.instance.removeListener(`MessageComposer${this.instanceId}`,this.onResize),this.voiceRecording=null}updateRecordingState(){const e=ko.getVoiceRecordingId(this.props.room,this.props.relation);this.voiceRecording=ko.instance.getActiveRecording(e),this.voiceRecording?this.voiceRecording.hasRecording&&!this.voiceRecording.isRecording&&this.setState({haveRecording:!0}):this.setState({haveRecording:!1})}get showStickersButton(){return this.state.showStickersButton&&!Object(Lo.a)(this.props.room)}getMenuPosition(){if(this.ref.current){const e=this.state.isWysiwygLabEnabled&&this.state.isRichTextEnabled,t=this.ref.current.getBoundingClientRect(),a=e?36:0,n=new DOMRect(t.x,t.y+a,t.width,t.height-a);return Object(de.i)(n)}}render(){var e;const t=Boolean(!this.state.isWysiwygLabEnabled&&this.props.e2eStatus),n=t&&o.a.createElement(ss.b,{key:"e2eIcon",status:this.props.e2eStatus,className:"mx_MessageComposer_e2eIcon"}),i=[],s=this.getMenuPosition(),r=this.context.canSendMessages&&!this.context.tombstone;let l,d;if(r)l=this.state.isWysiwygLabEnabled&&s?o.a.createElement(Bo.b,{key:"controls_input",disabled:this.state.haveRecording,onChange:this.onWysiwygChange,onSend:this.sendMessage,isRichTextEnabled:this.state.isRichTextEnabled,initialContent:this.state.initialComposerContent,e2eStatus:this.props.e2eStatus,menuPosition:s,placeholder:this.renderPlaceholderText(),eventRelation:this.props.relation}):o.a.createElement(No.c,{ref:this.messageComposerInput,key:"controls_input",room:this.props.room,placeholder:this.renderPlaceholderText(),permalinkCreator:this.props.permalinkCreator,relation:this.props.relation,replyToEvent:this.props.replyToEvent,onChange:this.onChange,disabled:this.state.haveRecording,toggleStickerPickerOpen:this.toggleStickerPickerOpen}),i.push(o.a.createElement(Mo,{key:"controls_voice_record",ref:this.voiceRecordingButton,room:this.props.room,permalinkCreator:this.props.permalinkCreator,relation:this.props.relation,replyToEvent:this.props.replyToEvent}));else if(this.context.tombstone){const e=this.context.tombstone.getContent().replacement_room,t=e?o.a.createElement("a",{href:Object(Na.h)(e),className:"mx_MessageComposer_roomReplaced_link",onClick:this.onTombstoneClick},Object(N.b)("The conversation continues here.")):"";i.push(o.a.createElement("div",{className:"mx_MessageComposer_replaced_wrapper",key:"room_replaced"},o.a.createElement("div",{className:"mx_MessageComposer_replaced_valign"},o.a.createElement("img",{"aria-hidden":!0,alt:"",className:"mx_MessageComposer_roomReplaced_icon",src:a(1708).default}),o.a.createElement("span",{className:"mx_MessageComposer_roomReplaced_header"},Object(N.b)("This room has been replaced and is no longer active.")),o.a.createElement("br",null),t)))}else i.push(o.a.createElement("div",{key:"controls_error",className:"mx_MessageComposer_noperm_error"},Object(N.b)("You do not have permission to post to this room")));if(this.state.recordingTimeLeftSeconds){const e=Math.round(this.state.recordingTimeLeftSeconds);d=o.a.createElement(Ao.b,{label:Object(N.b)("%(seconds)ss left",{seconds:e}),alignment:Ao.a.Top})}const m=(null===(e=this.props.relation)||void 0===e?void 0:e.rel_type)===Ra.d.name?this.props.relation.event_id:null;i.push(o.a.createElement(uo,{room:this.props.room,threadId:m,isStickerPickerOpen:this.state.isStickerPickerOpen,setStickerPickerOpen:this.setStickerPickerOpen,menuPosition:s,key:"stickers"}));const h=r||!this.state.isComposerEmpty||this.state.haveRecording,u=c()({mx_MessageComposer:!0,sc_BubbleLayout:this.props.layout===io.a.Bubble,"mx_MessageComposer--compact":this.props.compact,mx_MessageComposer_e2eStatus:t,mx_MessageComposer_wysiwyg:this.state.isWysiwygLabEnabled});return o.a.createElement("div",{className:u,ref:this.ref},d,o.a.createElement("div",{className:"mx_MessageComposer_wrapper"},o.a.createElement(go,{replyToEvent:this.props.replyToEvent,permalinkCreator:this.props.permalinkCreator,userNameColorMode:this.props.userNameColorMode}),o.a.createElement("div",{className:"mx_MessageComposer_row"},n,l,o.a.createElement("div",{className:"mx_MessageComposer_actions"},i,r&&o.a.createElement(Uo.b,{addEmoji:this.addEmoji,haveRecording:this.state.haveRecording,isMenuOpen:this.state.isMenuOpen,isStickerPickerOpen:this.state.isStickerPickerOpen,menuPosition:s,relation:this.props.relation,onRecordStartEndClick:this.onRecordStartEndClick,setStickerPickerOpen:this.setStickerPickerOpen,showLocationButton:!window.electron,showPollsButton:this.state.showPollsButton,showStickersButton:this.showStickersButton,collapseButtons:this.state.collapseButtons,isRichTextEnabled:this.state.isRichTextEnabled,onComposerModeClick:this.onRichTextToggle,toggleButtonMenu:this.toggleButtonMenu,showVoiceBroadcastButton:this.state.showVoiceBroadcastButton,onStartVoiceBroadcastClick:()=>{(async(e,t,a,n,i)=>{var s;if(!await Object(Ct.C)(e,t,n))return null;const o=t.getUserId();if(!o)return null;const r=e.getMember(o);if(!r)return null;null===(s=a.getCurrent())||void 0===s||s.pause(),a.clearCurrent();const l=new Ct.o(e,r,t,a,n);i.setCurrent(l)})(this.props.room,oe.a.get(),at.b.instance.voiceBroadcastPlaybacksStore,at.b.instance.voiceBroadcastRecordingsStore,at.b.instance.voiceBroadcastPreRecordingStore),this.toggleButtonMenu()}}),h&&o.a.createElement(Wo,{key:"controls_send",onClick:this.sendMessage,enabled:!this.state.isComposerEmpty||this.state.haveRecording,title:this.state.haveRecording?Object(N.b)("Send voice message"):void 0})))))}}i()(zo,"contextType",en.b),i()(zo,"defaultProps",{compact:!1,showVoiceBroadcastButton:!1,isRichTextEnabled:!0});var Ho=Object(R.c)(zo);class Ko{constructor(e){this.event=e,i()(this,"serializedParts",null),i()(this,"caret",null)}setEditorState(e,t){this.caret=e,this.serializedParts=t}hasEditorState(){return!!this.serializedParts}getSerializedParts(){return this.serializedParts}getCaret(){return this.caret}getEvent(){return this.event}}var Go=a(514),qo=a(347);class $o extends o.a.PureComponent{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"mounted",!1),i()(this,"onAction",(e=>{this.mounted&&function(e){return[L.a.UploadStarted,L.a.UploadProgress,L.a.UploadFailed,L.a.UploadFinished,L.a.UploadCanceled].includes(e.action)}(e)&&this.setState(this.calculateState())})),i()(this,"onCancelClick",(e=>{e.preventDefault(),Pa.a.sharedInstance().cancelUpload(this.state.currentUpload)})),this.state=this.calculateState()}componentDidMount(){this.dispatcherRef=b.a.register(this.onAction),this.mounted=!0}componentWillUnmount(){this.mounted=!1,b.a.unregister(this.dispatcherRef)}getUploadsInRoom(){return Pa.a.sharedInstance().getCurrentUploads(this.props.relation).filter((e=>e.roomId===this.props.room.roomId))}calculateState(){const[e,...t]=this.getUploadsInRoom();return{currentUpload:e,currentFile:null==e?void 0:e.fileName,currentLoaded:null==e?void 0:e.loaded,currentTotal:null==e?void 0:e.total,countFiles:t.length+1}}render(){if(!this.state.currentFile)return null;const e=Object(N.b)("Uploading %(filename)s and %(count)s others",{filename:this.state.currentFile,count:this.state.countFiles-1}),t=Object(qo.a)(this.state.currentTotal);return o.a.createElement("div",{className:"mx_UploadBar"},o.a.createElement("div",{className:"mx_UploadBar_filename"},e," (",t,")"),o.a.createElement(K.a,{onClick:this.onCancelClick,className:"mx_UploadBar_cancel"}),o.a.createElement(Go.a,{value:this.state.currentLoaded,max:this.state.currentTotal}))}}var Yo=a(230);const Jo=["mxEvent","permalinkCreator","onMenuToggle"];var Qo=e=>{let{mxEvent:t,permalinkCreator:a,onMenuToggle:n}=e,i=ve()(e,Jo);const[r,l,c,d]=Object(de.q)(),m=Object(s.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:L.a.ViewRoom,event_id:t.getId(),highlighted:!0,room_id:t.getRoomId(),metricsTrigger:void 0}),d()}),[t,d]),h=Object(s.useCallback)((async e=>{if(a){null==e||e.preventDefault(),null==e||e.stopPropagation();const n=a.forEvent(t.getId());await Object(Yo.b)(n),d()}}),[t,d,a]);Object(s.useEffect)((()=>{null==n||n(r)}),[r,n]);const u=oe.a.get().getRoom(t.getRoomId()),p=!!u&&!rn.d.instance.hasMaximisedWidget(u);return o.a.createElement(o.a.Fragment,null,o.a.createElement(de.c,Z()({},i,{className:"mx_BaseCard_header_title_button--option",onClick:c,title:Object(N.b)("Thread options"),isExpanded:r,inputRef:l,"data-testid":"threadlist-dropdown-button"})),r&&o.a.createElement(he.e,Z()({onFinished:d,className:"mx_RoomTile_contextMenu",compact:!0,rightAligned:!0},{left:(g=l.current.getBoundingClientRect()).left+window.scrollX+g.width,top:g.bottom+window.scrollY,chevronFace:de.a.None}),o.a.createElement(he.c,null,p&&o.a.createElement(he.b,{onClick:e=>m(e),label:Object(N.b)("View in room"),iconClassName:"mx_ThreadPanel_viewInRoom"}),a&&o.a.createElement(he.b,{"data-testid":"copy-thread-link",onClick:e=>h(e),label:Object(N.b)("Copy link to thread"),iconClassName:"mx_ThreadPanel_copyLinkToThread"}))));var g};var Xo=e=>{let{parent:t,onFileDrop:n}=e;const[i,r]=Object(s.useState)({dragging:!1,counter:0});return Object(s.useEffect)((()=>{if(!t||t.ondrop)return;const e=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&r((t=>({counter:t.counter+1,dragging:!(!e.dataTransfer.types.includes("Files")&&!e.dataTransfer.types.includes("application/x-moz-file"))||t.dragging})))},a=e=>{e.stopPropagation(),e.preventDefault(),r((e=>({counter:e.counter-1,dragging:!(e.counter<=1)&&e.dragging})))},i=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="none",(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&(e.dataTransfer.dropEffect="copy"))},s=e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer&&(n(e.dataTransfer),r((e=>({dragging:!1,counter:e.counter-1}))))};return null==t||t.addEventListener("drop",s),null==t||t.addEventListener("dragover",i),null==t||t.addEventListener("dragenter",e),null==t||t.addEventListener("dragleave",a),()=>{null==t||t.removeEventListener("drop",s),null==t||t.removeEventListener("dragover",i),null==t||t.removeEventListener("dragenter",e),null==t||t.removeEventListener("dragleave",a)}}),[t,n]),i.dragging?o.a.createElement("div",{className:"mx_FileDropTarget"},o.a.createElement("img",{src:a(1709).default,className:"mx_FileDropTarget_image",alt:""}),Object(N.b)("Drop file here to upload")):null},Zo=a(350);function er(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function tr(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?er(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):er(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class ar extends o.a.Component{constructor(e){var t,a;super(e),a=this,i()(this,"context",void 0),i()(this,"dispatcherRef",null),i()(this,"layoutWatcherRef",void 0),i()(this,"timelinePanel",Object(s.createRef)()),i()(this,"card",Object(s.createRef)()),i()(this,"eventId",void 0),i()(this,"onAction",(e=>{switch(e.phase==La.a.ThreadView&&e.event&&this.setupThread(e.event),e.action){case L.a.ComposerInsert:if(e.composerType)break;if(e.timelineRenderingType!==en.a.Thread)break;b.a.dispatch(tr(tr({},e),{},{composerType:this.state.editState?Zo.a.Edit:Zo.a.Send}));break;case L.a.EditEvent:if(e.timelineRenderingType!==en.a.Thread)return;if(e.event&&!e.event.getThread())return;this.setState({editState:e.event?new Ko(e.event):void 0},(()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}));break;case"reply_to_event":e.context===en.a.Thread&&this.setState({replyToEvent:e.event})}})),i()(this,"setupThread",(e=>{const t=e.getId();let a=this.props.room.getThread(t);a||(a=this.props.room.createThread(t,e,[e],!0)),this.updateThread(a)})),i()(this,"onNewThread",(e=>{e.id===this.props.mxEvent.getId()&&this.setupThread(this.props.mxEvent)})),i()(this,"updateThreadRelation",(()=>{this.setState({lastReply:this.threadLastReply})})),i()(this,"updateThread",(e=>{this.state.thread!==e&&(this.setupThreadListeners(e,this.state.thread),e&&this.setState({thread:e,lastReply:this.threadLastReply},(async()=>this.postThreadUpdate(e))))})),i()(this,"resetJumpToEvent",(e=>{var t,a;this.props.initialEvent&&this.props.initialEventScrollIntoView&&e===(null===(t=this.props.initialEvent)||void 0===t?void 0:t.getId())&&b.a.dispatch({action:L.a.ViewRoom,room_id:this.props.room.roomId,event_id:null===(a=this.props.initialEvent)||void 0===a?void 0:a.getId(),highlighted:this.props.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0})})),i()(this,"onMeasurement",(e=>{this.setState({narrow:e})})),i()(this,"onKeyDown",(e=>{let t=!1;if(Object(J.a)().getRoomAction(e)===W.h.UploadFile)b.a.dispatch({action:"upload_file",context:en.a.Thread},!0),t=!0;t&&(e.stopPropagation(),e.preventDefault())})),i()(this,"onFileDrop",(e=>{const t=this.props.mxEvent.getRoomId();t?Pa.a.sharedInstance().sendContentListToRoom(Array.from(e.files),t,this.threadRelation,oe.a.get(),en.a.Thread):console.warn("Unknwon roomId for event",this.props.mxEvent)})),i()(this,"renderThreadViewHeader",(()=>o.a.createElement("div",{className:"mx_BaseCard_header_title"},o.a.createElement(ua.a,{size:"h4",className:"mx_BaseCard_header_title_heading"},Object(N.b)("Thread")),o.a.createElement(Qo,{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator})))),this.setEventId(this.props.mxEvent);const n=null!==(t=this.props.room.getThread(this.eventId))&&void 0!==t?t:void 0;this.setupThreadListeners(n),this.state={layout:v.b.getValue("layout"),narrow:!1,thread:n,lastReply:null==n?void 0:n.lastReply((e=>e.isRelation(Ra.d.name)&&!e.status))},this.layoutWatcherRef=v.b.watchSetting("layout",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({layout:i})}))}componentDidMount(){this.state.thread&&this.postThreadUpdate(this.state.thread),this.setupThread(this.props.mxEvent),this.dispatcherRef=b.a.register(this.onAction);const e=oe.a.get().getRoom(this.props.mxEvent.getRoomId());if(!e)throw new Error(`Unable to find room ${this.props.mxEvent.getRoomId()} for thread ${this.props.mxEvent.getId()}`);e.on(Ra.f.New,this.onNewThread)}componentWillUnmount(){this.dispatcherRef&&b.a.unregister(this.dispatcherRef);const e=this.props.mxEvent.getRoomId(),t=oe.a.get().getRoom(e);null==t||t.removeListener(Ra.f.New,this.onNewThread),v.b.unwatchSetting(this.layoutWatcherRef);const a=at.b.instance.roomViewStore.getRoomId()!==e;this.props.initialEvent&&!a&&b.a.dispatch({action:L.a.ViewRoom,room_id:this.props.room.roomId,metricsTrigger:void 0}),b.a.dispatch({action:L.a.ViewThread,thread_id:null})}componentDidUpdate(e){e.mxEvent!==this.props.mxEvent&&(this.setEventId(this.props.mxEvent),this.setupThread(this.props.mxEvent)),e.room!==this.props.room&&Fa.a.instance.setCard({phase:La.a.RoomSummary})}setEventId(e){if(!e.getId())throw new Error("Got thread event without id");this.eventId=e.getId()}get threadLastReply(){var e,t;return null!==(e=null===(t=this.state.thread)||void 0===t?void 0:t.lastReply((e=>e.isRelation(Ra.d.name)&&!e.status)))&&void 0!==e?e:void 0}async postThreadUpdate(e){var t,a;b.a.dispatch({action:L.a.ViewThread,thread_id:e.id}),e.emit(Ra.f.ViewThread),this.updateThreadRelation(),null===(t=this.timelinePanel.current)||void 0===t||t.refreshTimeline(null===(a=this.props.initialEvent)||void 0===a?void 0:a.getId())}setupThreadListeners(e,t){var a;t&&(null===(a=this.state.thread)||void 0===a||a.off(Ra.f.NewReply,this.updateThreadRelation),this.props.room.off(te.d.LocalEchoUpdated,this.updateThreadRelation));e&&(e.on(Ra.f.NewReply,this.updateThreadRelation),this.props.room.on(te.d.LocalEchoUpdated,this.updateThreadRelation))}get threadRelation(){var e,t,a,n;const i={rel_type:Ra.d.name,event_id:null===(e=this.state.thread)||void 0===e?void 0:e.id,is_falling_back:!0},s=null!==(t=null===(a=this.state.lastReply)||void 0===a?void 0:a.getId())&&void 0!==t?t:null===(n=this.state.thread)||void 0===n?void 0:n.id;return s&&(i["m.in_reply_to"]={event_id:s}),i}render(){var e,t,a,n,i,s;const r=this.props.isInitialEventHighlighted?null===(e=this.props.initialEvent)||void 0===e?void 0:e.getId():void 0,l=this.threadRelation;let d;var m;this.state.thread?(this.props.initialEvent&&this.props.initialEvent.getRoomId()!==this.state.thread.roomId&&Oa.a.warn("ThreadView attempting to render TimelinePanel with mismatched initialEvent",this.state.thread.roomId,this.props.initialEvent.getRoomId(),this.props.initialEvent.getId()),d=o.a.createElement(o.a.Fragment,null,o.a.createElement(Xo,{parent:this.card.current,onFileDrop:this.onFileDrop}),o.a.createElement(no,{key:this.state.thread.id,ref:this.timelinePanel,showReadReceipts:this.context.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!0,sendReadReceiptOnLoad:!0,timelineSet:this.state.thread.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:io.a.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:null===(m=this.props.initialEvent)||void 0===m?void 0:m.getId(),highlightedEventId:r,eventScrollIntoView:this.props.initialEventScrollIntoView,onEventScrolledIntoView:this.resetJumpToEvent}))):d=o.a.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},o.a.createElement(Zn.a,null));return o.a.createElement(en.b.Provider,{value:tr(tr({},this.context),{},{timelineRenderingType:en.a.Thread,threadId:null===(t=this.state.thread)||void 0===t?void 0:t.id,liveTimeline:null===(a=this.state)||void 0===a||null===(n=a.thread)||void 0===n||null===(i=n.timelineSet)||void 0===i?void 0:i.getLiveTimeline(),narrow:this.state.narrow})},o.a.createElement(za,{className:c()("mx_ThreadView mx_ThreadPanel",{mx_ThreadView_narrow:this.state.narrow}),onClose:this.props.onClose,withoutScrollContainer:!0,header:this.renderThreadViewHeader(),ref:this.card,onKeyDown:this.onKeyDown,onBack:e=>{re.b.trackInteraction("WebThreadViewBackButton",e)}},this.card.current&&o.a.createElement(so,{sensor:this.card.current,onMeasurement:this.onMeasurement}),o.a.createElement("div",{className:"mx_ThreadView_timelinePanelWrapper"},d),Pa.a.sharedInstance().getCurrentUploads(l).length>0&&o.a.createElement($o,{room:this.props.room,relation:l}),(null===(s=this.state.thread)||void 0===s?void 0:s.timelineSet)&&o.a.createElement(Ho,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,relation:l,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,layout:this.state.layout,compact:!0})))}}i()(ar,"contextType",en.b);var nr=a(584);function ir(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function sr(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ir(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ir(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}let or=function(e){return e[e.My=0]="My",e[e.All=1]="All",e}({});const rr=e=>{let{label:t,description:a,onClick:n,isSelected:i}=e;return o.a.createElement(de.f,{active:i,className:"mx_ThreadPanel_Header_FilterOptionItem",onClick:n},o.a.createElement("span",null,t),o.a.createElement("span",null,a))},lr=e=>{let{filterOption:t,setFilterOption:a,empty:n}=e;const[i,s,r,l]=Object(de.q)(),c=[{label:Object(N.b)("All threads"),description:Object(N.b)("Shows all threads from current room"),key:or.All},{label:Object(N.b)("My threads"),description:Object(N.b)("Shows all threads you've participated in"),key:or.My}],d=c.find((e=>e.key===t)),m=c.map((e=>o.a.createElement(rr,{key:e.key,label:e.label,description:e.description,onClick:()=>{a(e.key),l()},isSelected:e===d}))),h=i?o.a.createElement(de.n,{top:108,right:33,onFinished:l,chevronFace:de.a.Top,wrapperClassName:"mx_BaseCard_header_title"},m):null;return o.a.createElement("div",{className:"mx_BaseCard_header_title"},o.a.createElement(ua.a,{size:"h4",className:"mx_BaseCard_header_title_heading"},Object(N.b)("Threads")),!n&&o.a.createElement(o.a.Fragment,null,o.a.createElement(nr.a,{className:"mx_ThreadPanel_dropdown",inputRef:s,isExpanded:i,onClick:e=>{r(),re.b.trackInteraction("WebRightPanelThreadPanelFilterDropdown",e)}},`${Object(N.b)("Show:")} ${null==d?void 0:d.label}`),h))},cr=e=>{let t,{hasThreads:a,filterOption:n,showAllThreadsCallback:i}=e;return t=a?o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(N.b)("Reply to an ongoing thread or use “%(replyInThread)s” when hovering over a message to start a new one.",{replyInThread:Object(N.b)("Reply in thread")})),o.a.createElement("p",null,n===or.My?o.a.createElement("button",{onClick:i},Object(N.b)("Show all threads")):o.a.createElement(o.a.Fragment,null," "))):o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(N.b)("Threads help keep your conversations on-topic and easy to track.")),o.a.createElement("p",{className:"mx_ThreadPanel_empty_tip"},Object(N.b)("<b>Tip:</b> Use “%(replyInThread)s” when hovering over a message.",{replyInThread:Object(N.b)("Reply in thread")},{b:e=>o.a.createElement("b",null,e)}))),o.a.createElement("aside",{className:"mx_ThreadPanel_empty"},o.a.createElement("div",{className:"mx_ThreadPanel_largeIcon"}),o.a.createElement("h2",null,Object(N.b)("Keep discussions organised with threads")),t)};var dr=e=>{var t,a,n,i,r,l;let{roomId:c,onClose:d,permalinkCreator:m}=e;const h=Object(s.useContext)(R.a),u=Object(s.useContext)(en.b),p=Object(s.useRef)(null),g=Object(s.useRef)(null),[b,v]=Object(s.useState)(or.All),[f,E]=Object(s.useState)(null),[y,_]=Object(s.useState)(!1),S=b===or.My?null==f?void 0:f.threadsTimelineSets[1]:null==f?void 0:f.threadsTimelineSets[0],w=Boolean(null==f||null===(t=f.threadsTimelineSets)||void 0===t||null===(a=t[0])||void 0===a||null===(n=a.getLiveTimeline())||void 0===n||null===(i=n.getEvents())||void 0===i?void 0:i.length);return Object(s.useEffect)((()=>{const e=h.getRoom(c);null==e||e.createThreadsTimelineSets().then((()=>e.fetchRoomThreads())).then((()=>{v(or.All),E(e)}))}),[h,c]),Object(s.useEffect)((()=>{var e;S&&!Ra.e.hasServerSideSupport&&(null===(e=p.current)||void 0===e||e.refreshTimeline())}),[S,p]),o.a.createElement(en.b.Provider,{value:sr(sr({},u),{},{timelineRenderingType:en.a.ThreadsList,showHiddenEvents:!0,narrow:y})},o.a.createElement(za,{header:o.a.createElement(lr,{filterOption:b,setFilterOption:v,empty:!w}),className:"mx_ThreadPanel",onClose:d,withoutScrollContainer:!0,ref:g},g.current&&o.a.createElement(so,{sensor:g.current,onMeasurement:_}),S?o.a.createElement(no,{key:b+":"+(null!==(r=null===(l=S.getFilter())||void 0===l?void 0:l.filterId)&&void 0!==r?r:c),ref:p,showReadReceipts:!1,manageReadReceipts:!1,manageReadMarkers:!1,sendReadReceiptOnLoad:!1,timelineSet:S,showUrlPreview:!1,empty:o.a.createElement(cr,{hasThreads:w,filterOption:b,showAllThreadsCallback:()=>v(or.All)}),alwaysShowTimestamps:!0,layout:io.a.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!1,className:"mx_RoomView_messagePanel",membersLoaded:!0,permalinkCreator:m,disableGrouping:!0}):o.a.createElement("div",{className:"mx_AutoHideScrollbar"},o.a.createElement(Zn.a,null))))};function mr(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function hr(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?mr(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):mr(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class ur extends o.a.PureComponent{constructor(e){super(e),i()(this,"card",o.a.createRef()),i()(this,"onMeasurement",(e=>{this.setState({narrow:e})})),this.state={narrow:!1}}render(){const e=o.a.createElement("div",{className:"mx_RightPanel_empty mx_NotificationPanel_empty"},o.a.createElement("h2",null,Object(N.b)("You're all caught up")),o.a.createElement("p",null,Object(N.b)("You have no visible notifications.")));let t;const a=oe.a.get().getNotifTimelineSet();return a?t=o.a.createElement(no,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:a,showUrlPreview:!1,empty:e,alwaysShowTimestamps:!0,userNameColorMode:this.props.userNameColorMode,layout:io.a.Group}):(Oa.a.error("No notifTimelineSet available!"),t=o.a.createElement(Zn.a,null)),o.a.createElement(en.b.Provider,{value:hr(hr({},this.context),{},{timelineRenderingType:en.a.Notification,narrow:this.state.narrow})},o.a.createElement(za,{header:o.a.createElement(ua.a,{size:"h4",className:"mx_BaseCard_header_title_heading"},Object(N.b)("Notifications")),className:"mx_ThreadPanel",onClose:this.props.onClose,withoutScrollContainer:!0},this.card.current&&o.a.createElement(so,{sensor:this.card.current,onMeasurement:this.onMeasurement}),t))}}i()(ur,"contextType",en.b);var pr=e=>{const t=c()({mx_JumpToBottomButton:!0,mx_JumpToBottomButton_highlight:e.highlight});let a;return e.numUnreadMessages&&(a=o.a.createElement("div",{className:"mx_JumpToBottomButton_badge"},e.numUnreadMessages)),o.a.createElement("div",{className:t},o.a.createElement(K.a,{className:"mx_JumpToBottomButton_scrollDown",title:Object(N.b)("Scroll to most recent messages"),onClick:e.onScrollToBottomClick}),a)};function gr(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function br(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?gr(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):gr(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class vr extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"layoutWatcherRef",void 0),i()(this,"timelinePanel",o.a.createRef()),i()(this,"card",o.a.createRef()),i()(this,"readReceiptsSettingWatcher",void 0),i()(this,"onRoomViewStoreUpdate",(async e=>{const t={initialEventId:at.b.instance.roomViewStore.getInitialEventId(),isInitialEventHighlighted:at.b.instance.roomViewStore.isInitialEventHighlighted(),replyToEvent:at.b.instance.roomViewStore.getQuotingEvent()};this.setState(t)})),i()(this,"onAction",(e=>{if(e.action===L.a.EditEvent)this.setState({editState:e.event?new Ko(e.event):void 0},(()=>{var t;e.event&&(null===(t=this.timelinePanel.current)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}))})),i()(this,"onScroll",(()=>{const e=this.timelinePanel.current;e&&(e.isAtEndOfLiveTimeline()?this.setState({atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.state.initialEventId&&this.state.isInitialEventHighlighted&&b.a.dispatch({action:L.a.ViewRoom,room_id:this.props.room.roomId,event_id:this.state.initialEventId,highlighted:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))})),i()(this,"onMeasurement",(e=>{this.setState({narrow:e})})),i()(this,"jumpToLiveTimeline",(()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?b.a.dispatch({action:L.a.ViewRoom,room_id:this.props.room.roomId}):(null===(e=this.timelinePanel.current)||void 0===e||e.jumpToLiveTimeline(),b.a.fire(L.a.FocusSendMessageComposer))})),i()(this,"renderTimelineCardHeader",(()=>o.a.createElement("div",{className:"mx_BaseCard_header_title"},o.a.createElement(ua.a,{size:"h4",className:"mx_BaseCard_header_title_heading"},Object(N.b)("Chat"))))),this.state={showReadReceipts:v.b.getValue("showReadReceipts",e.room.roomId),layout:v.b.getValue("layout"),atEndOfLiveTimeline:!0,narrow:!1}}componentDidMount(){var e=this;at.b.instance.roomViewStore.addListener(Et.b,this.onRoomViewStoreUpdate),this.dispatcherRef=b.a.register(this.onAction),this.readReceiptsSettingWatcher=v.b.watchSetting("showReadReceipts",null,(function(){for(var t=arguments.length,a=new Array(t),n=0;n<t;n++)a[n]=arguments[n];let[,,,i]=a;return e.setState({showReadReceipts:i})})),this.layoutWatcherRef=v.b.watchSetting("layout",null,(function(){for(var t=arguments.length,a=new Array(t),n=0;n<t;n++)a[n]=arguments[n];let[,,,i]=a;return e.setState({layout:i})}))}componentWillUnmount(){at.b.instance.roomViewStore.removeListener(Et.b,this.onRoomViewStoreUpdate),this.readReceiptsSettingWatcher&&v.b.unwatchSetting(this.readReceiptsSettingWatcher),this.layoutWatcherRef&&v.b.unwatchSetting(this.layoutWatcherRef),this.dispatcherRef&&b.a.unregister(this.dispatcherRef)}render(){var e,t;const a=this.state.isInitialEventHighlighted?this.state.initialEventId:void 0;let n;this.state.atEndOfLiveTimeline||(n=o.a.createElement(pr,{highlight:this.props.room.getUnreadNotificationCount(te.b.Highlight)>0,onScrollToBottomClick:this.jumpToLiveTimeline}));const i=Pa.a.sharedInstance().getCurrentUploads(this.props.composerRelation).length>0,s="join"===this.props.room.getMyMembership();return o.a.createElement(en.b.Provider,{value:br(br({},this.context),{},{timelineRenderingType:null!==(e=this.props.timelineRenderingType)&&void 0!==e?e:this.context.timelineRenderingType,liveTimeline:null===(t=this.props.timelineSet)||void 0===t?void 0:t.getLiveTimeline(),narrow:this.state.narrow})},o.a.createElement(za,{className:this.props.classNames,onClose:this.props.onClose,withoutScrollContainer:!0,header:this.renderTimelineCardHeader(),ref:this.card},this.card.current&&o.a.createElement(so,{sensor:this.card.current,onMeasurement:this.onMeasurement}),o.a.createElement("div",{className:"mx_TimelineCard_timeline"},n,o.a.createElement(no,{ref:this.timelinePanel,showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!0,manageReadMarkers:!1,sendReadReceiptOnLoad:!0,timelineSet:this.props.timelineSet,showUrlPreview:this.context.showUrlPreview,layout:this.state.layout===io.a.Bubble?io.a.Bubble:io.a.Group,hideThreadedMessages:!1,hidden:!1,showReactions:!0,className:"mx_RoomView_messagePanel",permalinkCreator:this.props.permalinkCreator,membersLoaded:!0,editState:this.state.editState,eventId:this.state.initialEventId,resizeNotifier:this.props.resizeNotifier,highlightedEventId:a,onScroll:this.onScroll,youtubeEmbedPlayer:!0})),i&&o.a.createElement($o,{room:this.props.room,relation:this.props.composerRelation}),s&&o.a.createElement(Ho,{room:this.props.room,relation:this.props.composerRelation,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus,compact:!0,layout:this.state.layout})))}}function fr(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}i()(vr,"contextType",en.b);class Er extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"delayedUpdate",Object(j.throttle)((()=>{this.forceUpdate()}),500,{leading:!0,trailing:!0})),i()(this,"onRoomStateMember",((e,t,a)=>{var n;this.props.room&&a.roomId===this.props.room.roomId&&(this.state.phase===La.a.RoomMemberList||this.state.phase===La.a.RoomMemberInfo&&a.userId===(null===(n=this.state.cardState.member)||void 0===n?void 0:n.userId))&&this.delayedUpdate()})),i()(this,"onRightPanelStoreUpdate",(()=>{this.setState(function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?fr(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):fr(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({},Er.getDerivedStateFromProps(this.props)))})),i()(this,"onClose",(()=>{var e,t,a,n;if(null!==(e=this.props.overwriteCard)&&void 0!==e&&null!==(t=e.state)&&void 0!==t&&t.member)b.a.dispatch({action:L.a.ViewHomePage});else if(this.state.phase===La.a.EncryptionPanel&&null!==(a=this.state.cardState)&&void 0!==a&&null!==(n=a.verificationRequest)&&void 0!==n&&n.pending)this.state.cardState.verificationRequest.cancel();else{var i,s;Fa.a.instance.togglePanel(null!==(i=null===(s=this.props.room)||void 0===s?void 0:s.roomId)&&void 0!==i?i:null)}})),i()(this,"onSearchQueryChanged",(e=>{this.setState({searchQuery:e})})),this.state={searchQuery:""}}componentDidMount(){this.context.on(m.b.Members,this.onRoomStateMember),Fa.a.instance.on(Et.b,this.onRightPanelStoreUpdate)}componentWillUnmount(){var e;null===(e=this.context)||void 0===e||e.removeListener(m.b.Members,this.onRoomStateMember),Fa.a.instance.off(Et.b,this.onRightPanelStoreUpdate)}static getDerivedStateFromProps(e){var t,a;let n;return e.room&&(n=Fa.a.instance.currentCardForRoom(e.room.roomId)),{cardState:null===(t=n)||void 0===t?void 0:t.state,phase:null===(a=n)||void 0===a?void 0:a.phase}}render(){var e,t,a,n,i,s,r;let l=o.a.createElement("div",null);const c=null===(e=this.props.room)||void 0===e?void 0:e.roomId,d=null!==(t=null===(a=this.props.overwriteCard)||void 0===a?void 0:a.phase)&&void 0!==t?t:this.state.phase,m=null!==(n=null===(i=this.props.overwriteCard)||void 0===i?void 0:i.state)&&void 0!==n?n:this.state.cardState;switch(d){case La.a.RoomMemberList:c&&(l=o.a.createElement(rs,{roomId:c,key:c,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged}));break;case La.a.SpaceMemberList:l=o.a.createElement(rs,{roomId:null!==(s=null==m?void 0:m.spaceId)&&void 0!==s?s:c,key:null!==(r=null==m?void 0:m.spaceId)&&void 0!==r?r:c,onClose:this.onClose,searchQuery:this.state.searchQuery,onSearchQueryChanged:this.onSearchQueryChanged});break;case La.a.RoomMemberInfo:case La.a.SpaceMemberInfo:case La.a.EncryptionPanel:{var h,u;const e=(null==m?void 0:m.member)instanceof Ua.a?m.member:void 0;l=o.a.createElement(Vs,{user:null==m?void 0:m.member,room:null!==(h=this.context.getRoom(null==e?void 0:e.roomId))&&void 0!==h?h:this.props.room,key:null!=c?c:null==m||null===(u=m.member)||void 0===u?void 0:u.userId,onClose:this.onClose,phase:d,verificationRequest:null==m?void 0:m.verificationRequest,verificationRequestPromise:null==m?void 0:m.verificationRequestPromise});break}case La.a.Room3pidMemberInfo:case La.a.Space3pidMemberInfo:l=o.a.createElement(Ws,{event:null==m?void 0:m.memberInfoEvent,key:c});break;case La.a.NotificationPanel:l=o.a.createElement(ur,{onClose:this.onClose,userNameColorMode:this.props.userNameColorMode});break;case La.a.PinnedMessages:v.b.getValue("feature_pinning")&&(l=o.a.createElement(bi,{room:this.props.room,onClose:this.onClose,userNameColorMode:this.props.userNameColorMode,permalinkCreator:this.props.permalinkCreator}));break;case La.a.Timeline:l=o.a.createElement(vr,{classNames:"mx_ThreadPanel mx_TimelineCard",room:this.props.room,timelineSet:this.props.room.getUnfilteredTimelineSet(),resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus});break;case La.a.FilePanel:l=o.a.createElement(co,{roomId:c,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,userNameColorMode:this.props.userNameColorMode});break;case La.a.ThreadView:l=o.a.createElement(ar,{room:this.props.room,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,mxEvent:null==m?void 0:m.threadHeadEvent,initialEvent:null==m?void 0:m.initialEvent,isInitialEventHighlighted:null==m?void 0:m.isInitialEventHighlighted,initialEventScrollIntoView:null==m?void 0:m.initialEventScrollIntoView,permalinkCreator:this.props.permalinkCreator,e2eStatus:this.props.e2eStatus});break;case La.a.ThreadPanel:l=o.a.createElement(dr,{roomId:c,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator});break;case La.a.RoomSummary:l=o.a.createElement(Vi,{room:this.props.room,onClose:this.onClose,permalinkCreator:this.props.permalinkCreator});break;case La.a.Widget:l=o.a.createElement(Xi,{room:this.props.room,widgetId:null==m?void 0:m.widgetId,onClose:this.onClose})}return o.a.createElement("aside",{className:"mx_RightPanel dark-panel",id:"mx_RightPanel"},l)}}i()(Er,"contextType",R.a);class yr{constructor(){i()(this,"scrollStateMap",new Map)}getScrollState(e){return this.scrollStateMap.get(e)}setScrollState(e,t){this.scrollStateMap.set(e,t)}}void 0===window.mxRoomScrollStateStore&&(window.mxRoomScrollStateStore=new yr);var _r=window.mxRoomScrollStateStore,Sr=a(394),wr=a(414),Or=a(421),Cr=a(1710),xr=a(299),jr=a(201);class kr extends o.a.PureComponent{constructor(e){super(e),i()(this,"onViewClick",(()=>{this.setState({hidden:!1})})),this.state={hidden:!0}}render(){const e=c()({mx_InviteReason:!0,mx_InviteReason_hidden:this.state.hidden});return o.a.createElement("div",{className:e},o.a.createElement("div",{className:"mx_InviteReason_reason"},this.props.htmlReason?Object(jr.h)(this.props.htmlReason):this.props.reason),o.a.createElement("div",{className:"mx_InviteReason_view",onClick:this.onViewClick},Object(N.b)("View message")))}}var Rr=function(e){return e.NotLoggedIn="NotLoggedIn",e.Joining="Joining",e.Loading="Loading",e.Rejecting="Rejecting",e.Kicked="Kicked",e.Banned="Banned",e.OtherThreePIDError="OtherThreePIDError",e.InvitedEmailNotFoundInAccount="InvitedEmailNotFoundInAccount",e.InvitedEmailNoIdentityServer="InvitedEmailNoIdentityServer",e.InvitedEmailMismatch="InvitedEmailMismatch",e.Invite="Invite",e.ViewingRoom="ViewingRoom",e.RoomNotFound="RoomNotFound",e.OtherError="OtherError",e}(Rr||{});class Ir extends o.a.Component{constructor(e){super(e),i()(this,"onLoginClick",(()=>{b.a.dispatch({action:"start_login",screenAfterLogin:this.makeScreenAfterLogin()})})),i()(this,"onRegisterClick",(()=>{b.a.dispatch({action:"start_registration",screenAfterLogin:this.makeScreenAfterLogin()})})),this.state={busy:!1}}componentDidMount(){this.checkInvitedEmail()}componentDidUpdate(e,t){this.props.invitedEmail===e.invitedEmail&&this.props.inviterName===e.inviterName||this.checkInvitedEmail()}async checkInvitedEmail(){if(this.props.inviterName&&this.props.invitedEmail){this.setState({busy:!0});try{const e=await oe.a.get().getThreePids();if(this.setState({accountEmails:e.threepids.filter((e=>"email"===e.medium)).map((e=>e.address))}),!oe.a.get().getIdentityServerUrl())return void this.setState({busy:!1});const t=new xr.a,a=await t.getAccessToken(),n=await oe.a.get().lookupThreePid("email",this.props.invitedEmail,a);this.setState({invitedEmailMxid:n.mxid})}catch(e){this.setState({threePidFetchError:e})}this.setState({busy:!1})}}getMessageCase(){if(oe.a.get().isGuest())return Rr.NotLoggedIn;const e=this.getMyMember();if(e){if(e.isKicked())return Rr.Kicked;if("ban"===e.membership)return Rr.Banned}if(this.props.joining)return Rr.Joining;if(this.props.rejecting)return Rr.Rejecting;if(this.props.loading||this.state.busy)return Rr.Loading;if(this.props.inviterName){if(this.props.invitedEmail){if(this.state.threePidFetchError)return Rr.OtherThreePIDError;if(this.state.accountEmails&&!this.state.accountEmails.includes(this.props.invitedEmail))return Rr.InvitedEmailNotFoundInAccount;if(!oe.a.get().getIdentityServerUrl())return Rr.InvitedEmailNoIdentityServer;if(this.state.invitedEmailMxid!=oe.a.get().getUserId())return Rr.InvitedEmailMismatch}return Rr.Invite}return this.props.error?"M_NOT_FOUND"==this.props.error.errcode?Rr.RoomNotFound:Rr.OtherError:Rr.ViewingRoom}getKickOrBanInfo(){var e,t;const a=this.getMyMember();if(!a)return{};const n=null===(e=this.props.room)||void 0===e?void 0:e.currentState.getMember(a.events.member.getSender());return{memberName:n?n.name:a.events.member.getSender(),reason:null===(t=a.events.member)||void 0===t?void 0:t.getContent().reason}}joinRule(){var e,t,a;return null!==(e=null===(t=this.props.room)||void 0===t||null===(a=t.currentState.getStateEvents(ee.b.RoomJoinRules,""))||void 0===a?void 0:a.getContent().join_rule)&&void 0!==e?e:null}getMyMember(){var e,t;return null!==(e=null===(t=this.props.room)||void 0===t?void 0:t.getMember(oe.a.get().getUserId()))&&void 0!==e?e:null}getInviteMember(){const{room:e}=this.props;if(!e)return null;const t=oe.a.get().getUserId(),a=e.currentState.getMember(t);if(!a)return null;const n=a.events.member.getSender();return e.currentState.getMember(n)}isDMInvite(){const e=this.getMyMember();if(!e)return!1;const t=e.events.member.getContent();return"invite"===t.membership&&t.is_direct}makeScreenAfterLogin(){var e,t,a,n,i,s;return{screen:"room",params:{email:this.props.invitedEmail,signurl:this.props.signUrl,room_name:null!==(e=null===(t=this.props.oobData)||void 0===t?void 0:t.name)&&void 0!==e?e:null,room_avatar_url:null!==(a=null===(n=this.props.oobData)||void 0===n?void 0:n.avatarUrl)&&void 0!==a?a:null,inviter_name:null!==(i=null===(s=this.props.oobData)||void 0===s?void 0:s.inviterName)&&void 0!==i?i:null}}}render(){var e,t,a,n,i,s;const r=ot.b.get().brand,l=null!==(e=null!==(t=null===(a=this.props.room)||void 0===a?void 0:a.name)&&void 0!==t?t:this.props.roomAlias)&&void 0!==e?e:"",d=null!==(n=null===(i=this.props.room)||void 0===i?void 0:i.isSpaceRoom())&&void 0!==n?n:(null===(s=this.props.oobData)||void 0===s?void 0:s.roomType)===ee.j.Space;let m,h,u,p,g,b,f,E,y=!1;const _=[],S=this.getMessageCase();switch(S){case Rr.Joining:var w;m=null!==(w=this.props.oobData)&&void 0!==w&&w.roomType||d?d?Object(N.b)("Joining space…"):Object(N.b)("Joining room…"):Object(N.b)("Joining…"),y=!0;break;case Rr.Loading:m=Object(N.b)("Loading…"),y=!0;break;case Rr.Rejecting:m=Object(N.b)("Rejecting invite…"),y=!0;break;case Rr.NotLoggedIn:{const e={canJoin:!1};this.props.roomId&&mn.a.instance.invoke(Cr.RoomViewLifecycle.PreviewRoomNotLoggedIn,e,this.props.roomId),e.canJoin?(m=Object(N.b)("Join the room to participate"),g=Object(N.b)("Join"),p=()=>{mn.a.instance.invoke(Cr.RoomViewLifecycle.JoinFromRoomPreview,this.props.roomId)}):(m=Object(N.b)("Join the conversation with an account"),v.b.getValue(le.b.Registration)&&(g=Object(N.b)("Sign Up"),p=this.onRegisterClick),f=Object(N.b)("Sign In"),b=this.onLoginClick),this.props.previewLoading&&(E=o.a.createElement("div",null,o.a.createElement(Zn.a,{w:20,h:20}),Object(N.b)("Loading preview")));break}case Rr.Kicked:{const{memberName:e,reason:t}=this.getKickOrBanInfo();m=l?Object(N.b)("You were removed from %(roomName)s by %(memberName)s",{memberName:e,roomName:l}):Object(N.b)("You were removed by %(memberName)s",{memberName:e}),h=t?Object(N.b)("Reason: %(reason)s",{reason:t}):void 0,g=d?Object(N.b)("Forget this space"):Object(N.b)("Forget this room"),p=this.props.onForgetClick,this.joinRule()!==Ia.c.Invite&&(f=g,b=p,g=Object(N.b)("Re-join"),p=this.props.onJoinClick);break}case Rr.Banned:{const{memberName:e,reason:t}=this.getKickOrBanInfo();m=l?Object(N.b)("You were banned from %(roomName)s by %(memberName)s",{memberName:e,roomName:l}):Object(N.b)("You were banned by %(memberName)s",{memberName:e}),h=t?Object(N.b)("Reason: %(reason)s",{reason:t}):void 0,g=d?Object(N.b)("Forget this space"):Object(N.b)("Forget this room"),p=this.props.onForgetClick;break}case Rr.OtherThreePIDError:{var O;m=l?Object(N.b)("Something went wrong with your invite to %(roomName)s",{roomName:l}):Object(N.b)("Something went wrong with your invite.");const e=this.joinRule(),t=Object(N.b)("An error (%(errcode)s) was returned while trying to validate your invite. You could try to pass this information on to the person who invited you.",{errcode:(null===(O=this.state.threePidFetchError)||void 0===O?void 0:O.errcode)||Object(N.b)("unknown error code")});switch(e){case"invite":h=[Object(N.b)("You can only join it with a working invite."),t],g=Object(N.b)("Try to join anyway"),p=this.props.onJoinClick;break;case"public":h=Object(N.b)("You can still join here."),g=Object(N.b)("Join the discussion"),p=this.props.onJoinClick;break;default:h=t,g=Object(N.b)("Try to join anyway"),p=this.props.onJoinClick}break}case Rr.InvitedEmailNotFoundInAccount:m=l?Object(N.b)("This invite to %(roomName)s was sent to %(email)s which is not associated with your account",{roomName:l,email:this.props.invitedEmail}):Object(N.b)("This invite was sent to %(email)s which is not associated with your account",{email:this.props.invitedEmail}),h=Object(N.b)("Link this email with your account in Settings to receive invites directly in %(brand)s.",{brand:r}),g=Object(N.b)("Join the discussion"),p=this.props.onJoinClick;break;case Rr.InvitedEmailNoIdentityServer:m=l?Object(N.b)("This invite to %(roomName)s was sent to %(email)s",{roomName:l,email:this.props.invitedEmail}):Object(N.b)("This invite was sent to %(email)s",{email:this.props.invitedEmail}),h=Object(N.b)("Use an identity server in Settings to receive invites directly in %(brand)s.",{brand:r}),g=Object(N.b)("Join the discussion"),p=this.props.onJoinClick;break;case Rr.InvitedEmailMismatch:m=l?Object(N.b)("This invite to %(roomName)s was sent to %(email)s",{roomName:l,email:this.props.invitedEmail}):Object(N.b)("This invite was sent to %(email)s",{email:this.props.invitedEmail}),h=Object(N.b)("Share this email in Settings to receive invites directly in %(brand)s.",{brand:r}),g=Object(N.b)("Join the discussion"),p=this.props.onJoinClick;break;case Rr.Invite:{var C,x;const e=o.a.createElement(ye.a,{room:this.props.room,oobData:this.props.oobData}),t=this.getInviteMember();let a;a=t?o.a.createElement("span",null,o.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},t.rawDisplayName)," (",t.userId,")"):o.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},this.props.inviterName);this.isDMInvite()?(m=Object(N.b)("Do you want to chat with %(user)s?",{user:t.name}),h=[e,Object(N.b)("<userName/> wants to chat",{},{userName:()=>a})],g=Object(N.b)("Start chatting")):(m=Object(N.b)("Do you want to join %(roomName)s?",{roomName:l}),h=[e,Object(N.b)("<userName/> invited you",{},{userName:()=>a})],g=Object(N.b)("Accept"));const n=oe.a.get().getUserId(),i=null===(C=this.props.room)||void 0===C?void 0:C.currentState.getMember(n),s=null==i||null===(x=i.events.member)||void 0===x?void 0:x.getContent();null!=s&&s.reason&&(u=o.a.createElement(kr,{reason:s.reason,htmlReason:s["io.element.html_reason"]})),p=this.props.onJoinClick,f=Object(N.b)("Reject"),b=this.props.onRejectClick,this.props.onRejectAndIgnoreClick&&_.push(o.a.createElement(K.a,{kind:"secondary",onClick:this.props.onRejectAndIgnoreClick,key:"ignore"},Object(N.b)("Reject & Ignore user")));break}case Rr.ViewingRoom:m=this.props.canPreview?Object(N.b)("You're previewing %(roomName)s. Want to join it?",{roomName:l}):l?Object(N.b)("%(roomName)s can't be previewed. Do you want to join it?",{roomName:l}):Object(N.b)("There's no preview, would you like to join?"),g=Object(N.b)("Join the discussion"),p=this.props.onJoinClick;break;case Rr.RoomNotFound:m=l?Object(N.b)("%(roomName)s does not exist.",{roomName:l}):Object(N.b)("This room or space does not exist."),h=Object(N.b)("Are you sure you're at the right place?");break;case Rr.OtherError:m=l?Object(N.b)("%(roomName)s is not accessible at this time.",{roomName:l}):Object(N.b)("This room or space is not accessible at this time."),h=[Object(N.b)("Try again later, or ask a room or space admin to check if you have access."),Object(N.b)("%(errcode)s was returned while trying to access the room or space. If you think you're seeing this message in error, please <issueLink>submit a bug report</issueLink>.",{errcode:this.props.error.errcode},{issueLink:e=>o.a.createElement("a",{href:"https://github.com/SchildiChat/schildichat-desktop/issues/new/choose",target:"_blank",rel:"noreferrer noopener"},e)})]}let j,k,R,I;h&&(Array.isArray(h)||(h=[h]),j=h.map(((e,t)=>o.a.createElement("p",{key:`subTitle${t}`},e)))),k=y?o.a.createElement("h3",{className:"mx_RoomPreviewBar_spinnerTitle"},o.a.createElement(Zn.a,null),m):o.a.createElement("h3",null,m),p&&(R=o.a.createElement(K.a,{kind:"primary",onClick:p},g)),b&&(I=o.a.createElement(K.a,{kind:"secondary",onClick:b},f));const T=this.props.canPreview,P=c()("mx_RoomPreviewBar","dark-panel",`mx_RoomPreviewBar_${S}`,{mx_RoomPreviewBar_panel:T,mx_RoomPreviewBar_dialog:!T}),D=T?o.a.createElement(o.a.Fragment,null,I,_,R):o.a.createElement(o.a.Fragment,null,R,_,I);return o.a.createElement("div",{className:P},o.a.createElement("div",{className:"mx_RoomPreviewBar_message"},k,j),u,o.a.createElement("div",{className:"mx_RoomPreviewBar_actions"},D),o.a.createElement("div",{className:"mx_RoomPreviewBar_footer"},E))}}i()(Ir,"defaultProps",{onJoinClick(){}});var Tr=a(247),Nr=a(669);const Pr=["room"];function Dr(e){let{room:t}=e,a=ve()(e,Pr);const n=Object(s.useContext)(R.a),i=Object(s.useRef)(null),r=Object(Nr.b)(t),l=Object(jr.i)(null==r?void 0:r.text,null==r?void 0:r.html,i),d=Object(s.useCallback)((e=>{var t;null===(t=a.onClick)||void 0===t||t.call(a,e);"A"!==e.target.tagName.toUpperCase()&&b.a.fire(L.a.ShowRoomTopic)}),[a]);Object(ne.a)(b.a,(e=>{if(e.action===L.a.ShowRoomTopic){const e=t.currentState.maySendStateEvent(ee.b.RoomTopic,n.getSafeUserId()),a=Object(jr.i)(null==r?void 0:r.text,null==r?void 0:r.html,i,!0),s=z.b.createDialog(lt.a,{title:t.name,description:o.a.createElement("div",null,o.a.createElement(jr.a,{options:{attributes:{onClick(){s.close()}}},as:"p"},a),e&&o.a.createElement(K.a,{kind:"primary_outline",onClick:()=>{s.close(),b.a.dispatch({action:"open_room_settings"})}},Object(N.b)("Edit topic"))),hasCloseButton:!0,button:!1})}}));const m=c()(a.className,"mx_RoomTopic");return o.a.createElement("div",Z()({},a,{ref:i,onClick:d,dir:"auto",className:m}),o.a.createElement(ge.a,{label:Object(N.b)("Click to read topic"),alignment:Ao.a.Bottom,ignoreHover:e=>"A"===e.target.tagName.toUpperCase()},o.a.createElement(jr.a,null,l)))}var Mr=a(656);const Ar=["room","onlyKnownUsers","numShown"],Ur=5,Lr=e=>{var t;return!(null===(t=Xa.a.shared().getDMRoomsForUserId(e.userId))||void 0===t||!t.length)};var Fr=e=>{let{room:t,onlyKnownUsers:a=!0,numShown:n=Ur}=e,i=ve()(e,Ar);const r=Object(s.useContext)(R.a),l="join"===t.getMyMembership();let c=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250;const[a,n]=Object(s.useState)(e.getJoinedMembers());return Object(ie.c)(e.currentState,m.b.Update,Object(j.throttle)((()=>{n(e.getJoinedMembers())}),t,{leading:!0,trailing:!0})),a}(t);const d=c.length,h=[e=>e.getMxcAvatarUrl()?0:1];a?c=c.filter(Lr):h.unshift((e=>Lr(e)?0:1));const u=Object(j.sortBy)(c.filter((e=>e.userId!==r.getUserId())),h).slice(0,n);if(u.length<1)return null;const p=u.map((e=>e.name)).reverse().join(", "),g=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Tooltip_title"},i.onClick?Object(N.b)("View all %(count)s members",{count:d}):Object(N.b)("%(count)s members",{count:d})),o.a.createElement("div",{className:"mx_Tooltip_sub"},l?Object(N.b)("Including you, %(commaSeparatedMembers)s",{commaSeparatedMembers:p}):Object(N.b)("Including %(commaSeparatedMembers)s",{commaSeparatedMembers:p})));return o.a.createElement(Mr.a,Z()({members:u,faceSize:28,overflow:c.length>n,tooltip:g},i),a&&o.a.createElement("span",{className:"mx_FacePile_summary"},Object(N.b)("%(count)s people you know have already joined",{count:c.length})))};var Br=e=>{let{room:t}=e;const a=Object(ai.a)((async()=>{if("invite"!==t.getMyMembership())return null;try{return await t.client.getRoomSummary(t.roomId)}catch(e){return null}}),[t]),n=Object(li.a)(t,(e=>e.getJoinRule())),i=Yn(t),s=$n(t),r=Object(se.a)("feature_element_call_video_rooms");let l,c,d;if(t.isElementVideoRoom()||r&&t.isCallRoom()?(l="mx_RoomInfoLine_video",c=Object(N.b)("Video room")):n===Ia.c.Public?(l="mx_RoomInfoLine_public",c=t.isSpaceRoom()?Object(N.b)("Public space"):Object(N.b)("Public room")):(l="mx_RoomInfoLine_private",c=t.isSpaceRoom()?Object(N.b)("Private space"):Object(N.b)("Private room")),"invite"===i&&a)d=o.a.createElement("span",{className:"mx_RoomInfoLine_members"},Object(N.b)("%(count)s members",{count:a.num_joined_members}));else if(s&&void 0!==a){const e=()=>Fa.a.instance.setCard({phase:t.isSpaceRoom()?La.a.SpaceMemberList:La.a.RoomMemberList});d=o.a.createElement(K.a,{kind:"link",className:"mx_RoomInfoLine_members",onClick:e},Object(N.b)("%(count)s members",{count:s}))}return o.a.createElement("div",{className:`mx_RoomInfoLine ${l}`},c,d)};var Vr=e=>{let{room:t,onJoinButtonClicked:a,onRejectButtonClicked:n}=e;const i=Object(s.useContext)(R.a),r=Object(se.a)("feature_video_rooms"),l=Object(se.a)("feature_element_call_video_rooms"),c=t.isElementVideoRoom()||l&&t.isCallRoom(),d=Yn(t);Object(ne.a)(b.a,(e=>{e.action===L.a.JoinRoomError&&e.roomId===t.roomId&&h(!1)}));const[m,h]=Object(s.useState)(!1),u=Object(li.a)(t,(e=>e.getJoinRule())),p=Object(Tr.b)(d)===Tr.a.Leave&&u!==Ia.c.Public,g=()=>b.a.dispatch({action:L.a.ViewUserSettings,initialTabId:Fe.a.Labs});let v,f,E=null;if("join"===d)v=o.a.createElement(K.a,{kind:"danger_outline",onClick:()=>{b.a.dispatch({action:"leave_room",room_id:t.roomId})}},Object(N.b)("Leave"));else if("invite"===d){var y,_;const e=null===(y=t.getMember(i.getUserId()))||void 0===y||null===(_=y.events.member)||void 0===_?void 0:_.getSender();if(e){const a=t.getMember(e);E=o.a.createElement("div",{className:"mx_RoomPreviewCard_inviter"},o.a.createElement(ii.b,{member:a,fallbackUserId:e,width:32,height:32}),o.a.createElement("div",null,o.a.createElement("div",{className:"mx_RoomPreviewCard_inviter_name"},Object(N.b)("<inviter/> invites you",{},{inviter:()=>o.a.createElement("b",null,(null==a?void 0:a.name)||e)})),a?o.a.createElement("div",{className:"mx_RoomPreviewCard_inviter_mxid"},e):null))}v=o.a.createElement(o.a.Fragment,null,o.a.createElement(K.a,{kind:"primary_outline",onClick:()=>{h(!0),n()}},Object(N.b)("Reject")),o.a.createElement(K.a,{kind:"primary",onClick:()=>{h(!0),a()}},Object(N.b)("Accept")))}else v=o.a.createElement(K.a,{kind:"primary",onClick:()=>{a(),i.isGuest()||h(!0)},disabled:p},Object(N.b)("Join"));m&&(v=o.a.createElement(pe.a,null)),f=c?o.a.createElement(o.a.Fragment,null,o.a.createElement(ye.a,{room:t,height:50,width:50,viewAvatarOnClick:!0}),o.a.createElement("div",{className:"mx_RoomPreviewCard_video"}),o.a.createElement(me.a,{onClick:g,tooltipTitle:Object(N.b)("Video rooms are a beta feature")})):t.isSpaceRoom()?o.a.createElement(ye.a,{room:t,height:80,width:80,viewAvatarOnClick:!0}):o.a.createElement(ye.a,{room:t,height:50,width:50,viewAvatarOnClick:!0});let S=null;return p?S=Object(N.b)("To view %(roomName)s, you need an invite",{roomName:t.name}):c&&!r&&(S="join"===d?Object(N.b)("To view, please enable video rooms in Labs first"):Object(N.b)("To join, please enable video rooms in Labs first"),v=o.a.createElement(K.a,{kind:"primary",onClick:g},Object(N.b)("Show Labs settings"))),o.a.createElement("div",{className:"mx_RoomPreviewCard"},E,o.a.createElement("div",{className:"mx_RoomPreviewCard_avatar"},f),o.a.createElement("h1",{className:"mx_RoomPreviewCard_name"},o.a.createElement(vi.a,{room:t})),o.a.createElement(Br,{room:t}),o.a.createElement(Dr,{room:t,className:"mx_RoomPreviewCard_topic"}),"public"===t.getJoinRule()&&o.a.createElement(Fr,{room:t}),S?o.a.createElement("div",{className:"mx_RoomPreviewCard_notice"},S):null,o.a.createElement("div",{className:"mx_RoomPreviewCard_joinButtons"},v))};let Wr=function(e){return e.Room="Room",e.All="All",e}({});class zr extends o.a.Component{constructor(e){super(e),i()(this,"searchTerm",Object(s.createRef)()),i()(this,"onThisRoomClick",(()=>{this.setState({scope:Wr.Room},(()=>this.searchIfQuery()))})),i()(this,"onAllRoomsClick",(()=>{this.setState({scope:Wr.All},(()=>this.searchIfQuery()))})),i()(this,"onSearchChange",(e=>{switch(Object(J.a)().getAccessibilityAction(e)){case W.h.Enter:this.onSearch();break;case W.h.Escape:this.props.onCancelClick()}})),i()(this,"onSearch",(()=>{var e;null!==(e=this.searchTerm.current)&&void 0!==e&&e.value.trim()&&this.props.onSearch(this.searchTerm.current.value,this.state.scope)})),this.state={scope:Wr.Room}}searchIfQuery(){var e;null!==(e=this.searchTerm.current)&&void 0!==e&&e.value&&this.onSearch()}render(){const e=c()("mx_SearchBar_searchButton",{mx_SearchBar_searching:this.props.searchInProgress}),t=c()("mx_SearchBar_button",{mx_SearchBar_unselected:this.state.scope!==Wr.Room}),a=c()("mx_SearchBar_button",{mx_SearchBar_unselected:this.state.scope!==Wr.All});return o.a.createElement(o.a.Fragment,null,o.a.createElement(re.a,{screenName:"RoomSearch"}),o.a.createElement("div",{className:"mx_SearchBar"},o.a.createElement("div",{className:"mx_SearchBar_buttons",role:"radiogroup"},o.a.createElement(K.a,{className:t,onClick:this.onThisRoomClick,"aria-checked":this.state.scope===Wr.Room,role:"radio"},Object(N.b)("This Room")),o.a.createElement(K.a,{className:a,onClick:this.onAllRoomsClick,"aria-checked":this.state.scope===Wr.All,role:"radio"},Object(N.b)("All Rooms"))),o.a.createElement("div",{className:"mx_SearchBar_input mx_textinput"},o.a.createElement("input",{ref:this.searchTerm,type:"text",autoFocus:!0,placeholder:Object(N.b)("Search…"),onKeyDown:this.onSearchChange}),o.a.createElement(K.a,{className:e,onClick:this.onSearch,"aria-label":Object(N.b)("Search")})),o.a.createElement(K.a,{className:"mx_SearchBar_cancel",onClick:this.props.onCancelClick,"aria-label":Object(N.b)("Cancel")})),o.a.createElement(Gs,{isRoomEncrypted:this.props.isRoomEncrypted,kind:Ks.Search}))}}var Hr=a(933);class Kr extends o.a.PureComponent{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"onStateEvents",(e=>{if(!this.props.room||e.getRoomId()!==this.props.room.roomId)return;if("m.room.tombstone"!==e.getType())return;const t=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:t&&t.getContent().replacement_room})})),i()(this,"onUpgradeClick",(()=>{z.b.createDialog(Hr.a,{room:this.props.room})}));const a=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.state={upgraded:null==a?void 0:a.getContent().replacement_room}}componentDidMount(){this.context.on(m.b.Events,this.onStateEvents)}componentWillUnmount(){this.context.removeListener(m.b.Events,this.onStateEvents)}render(){let e=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},o.a.createElement("p",null,Object(N.b)("Upgrading this room will shut down the current instance of the room and create an upgraded room with the same name.")),o.a.createElement("p",null,Object(N.b)("<b>Warning</b>: upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>o.a.createElement("b",null,e),i:e=>o.a.createElement("i",null,e)}))),o.a.createElement("p",{className:"mx_RoomUpgradeWarningBar_upgradelink"},o.a.createElement(K.a,{onClick:this.onUpgradeClick},Object(N.b)("Upgrade this room to the recommended room version"))));return this.state.upgraded&&(e=o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},o.a.createElement("p",null,Object(N.b)("This room has already been upgraded.")))),o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar"},o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_wrapped"},o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_header"},Object(N.b)("This room is running room version <roomVersion />, which this homeserver has marked as <i>unstable</i>.",{},{roomVersion:()=>o.a.createElement("code",null,this.props.room.getVersion()),i:e=>o.a.createElement("i",null,e)})),e,o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_small"},Object(N.b)("Only room administrators will see this warning"))))}}i()(Kr,"contextType",R.a);var Gr=a(419),qr=a(496);const $r=e=>{let{failures:t}=e;const a=Object(s.useContext)(R.a),[n,i]=Object(s.useState)(!0);Object(s.useEffect)((()=>{const e=setTimeout((()=>i(!1)),5e3);return()=>clearTimeout(e)}),[]);const[r,l]=Object(s.useState)(!1),[c,d]=Object(s.useState)(!1),[m,h]=Object(s.useState)(!1),[u,p]=Object(s.useState)(new Set),[g,v]=Object(s.useState)(!0);Object(s.useEffect)((()=>{v(t.some((e=>{const t=e.getWireContent().session_id;return t&&!u.has(t)})))}),[t,u,v]);const f=Object(s.useCallback)((()=>{const e=new Set(u);for(const n of t){const t=n.getWireContent().session_id;t&&!e.has(t)&&(e.add(t),a.cancelAndResendEventRoomKeyRequest(n))}p(e)}),[a,u,p,t]),E=Object(s.useCallback)((async()=>{const e=a.getDeviceId();let t=!0;try{t=a.checkIfOwnDeviceCrossSigned(e)}catch(e){console.error("Error getting device cross-signing info",e)}l(!t);let n=!1;try{n=a.getStoredDevicesForUser(a.getUserId()).some((t=>t.deviceId!==e&&a.checkIfOwnDeviceCrossSigned(t.deviceId)))}catch(e){console.error("Error getting info about other devices",e)}d(n);let i=!1;try{const e=await a.isSecretStored("m.cross_signing.master");i=null!==e&&Object.keys(e).length>0}catch(e){console.error("Error getting info about key backups",e)}h(i)}),[a]);Object(s.useEffect)((()=>(E().catch(console.error),a.on(ka.b.DevicesUpdated,E),()=>{a.off(ka.b.DevicesUpdated,E)})),[a,E]);const y=()=>{z.b.createDialog(Gr.a)},_=()=>{const e={action:L.a.ViewUserSettings,initialTabId:Fe.a.Security};b.a.dispatch(e)},S=()=>{qr.b.sharedInstance().resetConfirm()},w=n?o.a.createElement(Zn.a,{w:24,h:24}):o.a.createElement("div",{className:"mx_DecryptionFailureBar_start_status_icon","data-testid":"decryption-failure-bar-icon"});let O,C,x,j=o.a.createElement(o.a.Fragment,null);n?(O="mx_DecryptionFailureBar",C=o.a.createElement(o.a.Fragment,null,Object(N.b)("Decrypting messages…")),x=o.a.createElement(o.a.Fragment,null,Object(N.b)("Please wait as we try to decrypt your messages. This may take a few moments."))):r?c||m?(O="mx_DecryptionFailureBar mx_DecryptionFailureBar--withEnd",C=o.a.createElement(o.a.Fragment,null,Object(N.b)("Verify this device to access all messages")),x=o.a.createElement(o.a.Fragment,null,Object(N.b)("This device was unable to decrypt some messages because it has not been verified yet.")),j=o.a.createElement(K.a,{className:"mx_DecryptionFailureBar_end_button",kind:"primary",onClick:y,"data-testid":"decryption-failure-bar-button"},Object(N.b)("Verify"))):(O="mx_DecryptionFailureBar mx_DecryptionFailureBar--withEnd",C=o.a.createElement(o.a.Fragment,null,Object(N.b)("Reset your keys to prevent future decryption errors")),x=o.a.createElement(o.a.Fragment,null,Object(N.b)("You will not be able to access old undecryptable messages, but resetting your keys will allow you to receive new messages.")),j=o.a.createElement(K.a,{className:"mx_DecryptionFailureBar_end_button",kind:"primary",onClick:S,"data-testid":"decryption-failure-bar-button"},Object(N.b)("Reset"))):c?(O="mx_DecryptionFailureBar mx_DecryptionFailureBar--withEnd",C=o.a.createElement(o.a.Fragment,null,Object(N.b)("Open another device to load encrypted messages")),x=o.a.createElement(o.a.Fragment,null,Object(N.b)("This device is requesting decryption keys from your other devices. Opening one of your other devices may speed this up.")),j=o.a.createElement(K.a,{className:"mx_DecryptionFailureBar_end_button",kind:"primary_outline",onClick:_,"data-testid":"decryption-failure-bar-button"},Object(N.b)("View your device list"))):(O="mx_DecryptionFailureBar",C=o.a.createElement(o.a.Fragment,null,Object(N.b)("Some messages could not be decrypted")),x=o.a.createElement(o.a.Fragment,null,Object(N.b)("Unfortunately, there are no other verified devices to request decryption keys from. Signing in and verifying other devices may help avoid this situation in the future.")));let k=o.a.createElement(o.a.Fragment,null);return!r&&c&&g&&(O="mx_DecryptionFailureBar mx_DecryptionFailureBar--withEnd",k=o.a.createElement(K.a,{className:"mx_DecryptionFailureBar_end_button",kind:"primary",onClick:f,"data-testid":"decryption-failure-bar-button"},Object(N.b)("Resend key requests"))),o.a.createElement("div",{className:O},o.a.createElement("div",{className:"mx_DecryptionFailureBar_start"},o.a.createElement("div",{className:"mx_DecryptionFailureBar_start_status"},o.a.createElement("div",{"data-testid":"decryption-failure-bar-indicator"},w)),o.a.createElement("div",{className:"mx_DecryptionFailureBar_start_headline"},C),o.a.createElement("div",{className:"mx_DecryptionFailureBar_start_message"},x)),o.a.createElement("div",{className:"mx_DecryptionFailureBar_end"},j,k))};var Yr=function(e){return e.CloseScalar="close_scalar",e.GetWidgets="get_widgets",e.SetWidget="set_widget",e.JoinRulesState="join_rules_state",e.SetPlumbingState="set_plumbing_state",e.GetMembershipCount="get_membership_count",e.GetRoomEncryptionState="get_room_enc_state",e.CanSendEvent="can_send_event",e.MembershipState="membership_state",e.invite="invite",e.Kick="kick",e.BotOptions="bot_options",e.SetBotOptions="set_bot_options",e.SetBotPower="set_bot_power",e.GetOpenIdToken="get_open_id_token",e.SendEvent="send_event",e.ReadEvents="read_events",e}(Yr||{});function Jr(e,t){const a=Object(yn.a)(e.data);a.response=t,e.source.postMessage(a,e.origin)}function Qr(e,t,a){Oa.a.error("Action:"+e.data.action+" failed with message: "+t);const n=Object(yn.a)(e.data);n.response={error:{message:t}},a&&(n.response.error._error=a),e.source.postMessage(n,e.origin)}function Xr(e,t){const a=e.data.widget_id;let n=e.data.type;const i=e.data.url,s=e.data.name,o=e.data.data,r=e.data.avatar_url,l=e.data.userWidget;if(a&&void 0!==i){if(null!==i){if(void 0!==s&&"string"!=typeof s)return void Qr(e,Object(N.b)("Unable to create widget."),new Error("Optional field 'name' must be a string."));if(void 0!==o&&!(o instanceof Object))return void Qr(e,Object(N.b)("Unable to create widget."),new Error("Optional field 'data' must be an Object."));if(void 0!==r&&"string"!=typeof r)return void Qr(e,Object(N.b)("Unable to create widget."),new Error("Optional field 'avatar_url' must be a string."));if("string"!=typeof n)return void Qr(e,Object(N.b)("Unable to create widget."),new Error("Field 'type' must be a string."));if("string"!=typeof i)return void Qr(e,Object(N.b)("Unable to create widget."),new Error("Field 'url' must be a string or null."))}if(n=on.a.fromString(n),l)Ka.a.setUserWidget(a,n,i,s,o).then((()=>{Jr(e,{success:!0}),b.a.dispatch({action:"user_widget_updated"})})).catch((t=>{Qr(e,Object(N.b)("Unable to create widget."),t)}));else{if(!t)return void Qr(e,Object(N.b)("Missing roomId."));Ka.a.setRoomWidget(t,a,n,i,s,o,r).then((()=>{Jr(e,{success:!0})}),(t=>{Qr(e,Object(N.b)("Failed to send request."),t)}))}}else Qr(e,Object(N.b)("Unable to create widget."),new Error("Missing required widget fields."))}function Zr(e,t){const a=oe.a.get();if(!a)return void Qr(e,Object(N.b)("You need to be logged in."));let n=[];if(t){const i=a.getRoom(t);if(!i)return void Qr(e,Object(N.b)("This room is not recognised."));n=Ka.a.getRoomWidgets(i).map((e=>e.event))}const i=Ka.a.getUserWidgetsArray();n=n.concat(i),Jr(e,n)}function el(e,t,a,n){const i=oe.a.get();if(!i)return void Qr(e,Object(N.b)("You need to be logged in."));const s=i.getRoom(t);if(!s)return void Qr(e,Object(N.b)("This room is not recognised."));const o=s.currentState.getStateEvents(a,n);Jr(e,o?o.getContent():null)}const tl=function(e){let t,a;e.origin||(e.origin=e.originalEvent.origin);try{var n;al||(al=null===(n=Ga.a.sharedInstance().getPrimaryManager())||void 0===n?void 0:n.uiUrl),t=new URL(al)}catch(e){return}try{a=new URL(e.origin)}catch(e){return}if(t.origin!==a.origin||!e.data.action||e.data.api)return;if(e.data.action===Yr.CloseScalar)return b.a.dispatch({action:Yr.CloseScalar}),void Jr(e,null);const i=e.data.room_id,s=e.data.user_id;if(!i)return e.data.action===Yr.GetWidgets?void Zr(e,null):e.data.action===Yr.SetWidget?void Xr(e,null):e.data.action===Yr.GetOpenIdToken?void async function(e){try{Jr(e,await oe.a.get().getOpenIdToken())}catch(t){Oa.a.warn("Unable to fetch openId token.",t),Qr(e,"Unable to fetch openId token.")}}(e):void Qr(e,Object(N.b)("Missing room_id in request"));if(i===at.b.instance.roomViewStore.getRoomId())if(e.data.action!==Yr.GetWidgets)if(e.data.action!==Yr.SetWidget)if(e.data.action!==Yr.JoinRulesState)if(e.data.action!==Yr.SetPlumbingState)if(e.data.action!==Yr.GetMembershipCount)if(e.data.action!==Yr.GetRoomEncryptionState)if(e.data.action!==Yr.CanSendEvent)if(e.data.action!==Yr.SendEvent)if(e.data.action!==Yr.ReadEvents)if(s)switch(e.data.action){case Yr.MembershipState:!function(e,t,a){Oa.a.log(`membership_state of ${a} in room ${t} requested.`),el(e,t,"m.room.member",a)}(e,i,s);break;case Yr.invite:!function(e,t,a){Oa.a.log(`Received request to invite ${a} into room ${t}`);const n=oe.a.get();if(!n)return void Qr(e,Object(N.b)("You need to be logged in."));const i=n.getRoom(t);if(i){const t=i.getMember(a);if(t&&["join","invite"].includes(t.membership))return void Jr(e,{success:!0})}n.invite(t,a).then((function(){Jr(e,{success:!0})}),(function(t){Qr(e,Object(N.b)("You need to be able to invite users to do that."),t)}))}(e,i,s);break;case Yr.Kick:!function(e,t,a){Oa.a.log(`Received request to kick ${a} from room ${t}`);const n=oe.a.get();if(!n)return void Qr(e,Object(N.b)("You need to be logged in."));const i=n.getRoom(t);if(i){const t=i.getMember(a);if(!t||Object(Tr.b)(t.membership)===Tr.a.Leave)return void Jr(e,{success:!0})}const s=e.data.reason;n.kick(t,a,s).then((()=>{Jr(e,{success:!0})})).catch((t=>{Qr(e,Object(N.b)("You need to be able to kick users to do that."),t)}))}(e,i,s);break;case Yr.BotOptions:!function(e,t,a){Oa.a.log(`bot_options of ${a} in room ${t} requested.`),el(e,t,"m.room.bot.options","_"+a)}(e,i,s);break;case Yr.SetBotOptions:!function(e,t,a){Oa.a.log(`Received request to set options for bot ${a} in room ${t}`);const n=oe.a.get();n?n.sendStateEvent(t,"m.room.bot.options",e.data.content,"_"+a).then((()=>{Jr(e,{success:!0})}),(t=>{Qr(e,t.message?t.message:Object(N.b)("Failed to send request."),t)})):Qr(e,Object(N.b)("You need to be logged in."))}(e,i,s);break;case Yr.SetBotPower:!async function(e,t,a,n,i){if(!(Number.isInteger(n)&&n>=0))return void Qr(e,Object(N.b)("Power level must be positive integer."));Oa.a.log(`Received request to set power level to ${n} for bot ${a} in room ${t}.`);const s=oe.a.get();if(s)try{const c=await s.getStateEvent(t,"m.room.power_levels","");var o,r,l;if(!0===i)if((null!==(o=null!==(r=null===(l=c.users)||void 0===l?void 0:l[a])&&void 0!==r?r:c.users_default)&&void 0!==o?o:0)>=n)return Jr(e,{success:!0});return await s.setPowerLevel(t,a,n,new ja.b({type:"m.room.power_levels",content:c})),Jr(e,{success:!0})}catch(t){Qr(e,t.message?t.message:Object(N.b)("Failed to send request."),t)}else Qr(e,Object(N.b)("You need to be logged in."))}(e,i,s,e.data.level,e.data.ignoreIfGreater);break;default:Oa.a.warn("Unhandled postMessage event with action '"+e.data.action+"'")}else Qr(e,Object(N.b)("Missing user_id in request"));else!async function(e,t){const a=e.data.type,n=e.data.state_key,i=e.data.limit;if("string"!=typeof a)return void Qr(e,Object(N.b)("Failed to read events"),new Error("Invalid 'type' in request"));if(!["m.room.power_levels","m.room.encryption","m.room.member","m.room.name","m.widgets","im.vector.modular.widgets","io.element.integrations.installations"].includes(a))return void Qr(e,Object(N.b)("Failed to read events"),new Error("Disallowed 'type' in request"));let s;if(void 0!==i){if("number"!=typeof i||i<0)return void Qr(e,Object(N.b)("Failed to read events"),new Error("Invalid 'limit' in request"));s=Math.min(i,Number.MAX_SAFE_INTEGER)}else s=Number.MAX_SAFE_INTEGER;const o=oe.a.get();if(!o)return void Qr(e,Object(N.b)("You need to be logged in."));const r=o.getRoom(t);if(r){if(void 0!==n){if("string"!=typeof n&&!0!==n)return void Qr(e,Object(N.b)("Failed to read events"),new Error("Invalid 'state_key' in request"));const t=!0===n?void 0:n;let i=[];return i=i.concat(r.currentState.getStateEvents(a,t)||[]),i=i.slice(0,s),void Jr(e,{events:i.map((e=>e.getEffectiveEvent()))})}Qr(e,Object(N.b)("Failed to read events"),new Error("Reading message events is not implemented"))}else Qr(e,Object(N.b)("This room is not recognised."))}(e,i);else!async function(e,t){const a=e.data.type,n=e.data.state_key,i=e.data.content;if("string"!=typeof a)return void Qr(e,Object(N.b)("Failed to send event"),new Error("Invalid 'type' in request"));if(!["m.widgets","im.vector.modular.widgets","io.element.integrations.installations"].includes(a))return void Qr(e,Object(N.b)("Failed to send event"),new Error("Disallowed 'type' in request"));if(!i||"object"!=typeof i)return void Qr(e,Object(N.b)("Failed to send event"),new Error("Invalid 'content' in request"));const s=oe.a.get();if(!s)return void Qr(e,Object(N.b)("You need to be logged in."));if(s.getRoom(t))if(void 0!==n)try{Jr(e,{room_id:t,event_id:(await s.sendStateEvent(t,a,i,n)).event_id})}catch(t){return void Qr(e,Object(N.b)("Failed to send event"),t)}else Qr(e,Object(N.b)("Failed to send event"),new Error("Sending message events is not implemented"));else Qr(e,Object(N.b)("This room is not recognised."))}(e,i);else!function(e,t){const a=""+e.data.event_type,n=Boolean(e.data.is_state),i=oe.a.get();if(!i)return void Qr(e,Object(N.b)("You need to be logged in."));const s=i.getRoom(t);if(!s)return void Qr(e,Object(N.b)("This room is not recognised."));if("join"!==s.getMyMembership())return void Qr(e,Object(N.b)("You are not in this room."));const o=i.credentials.userId;let r=!1;r=n?s.currentState.maySendStateEvent(a,o):s.currentState.maySendEvent(a,o),r?Jr(e,!0):Qr(e,Object(N.b)("You do not have permission to do that in this room."))}(e,i);else!function(e,t){const a=oe.a.get();if(!a)return void Qr(e,Object(N.b)("You need to be logged in."));if(!a.getRoom(t))return void Qr(e,Object(N.b)("This room is not recognised."));Jr(e,oe.a.get().isRoomEncrypted(t))}(e,i);else!function(e,t){const a=oe.a.get();if(!a)return void Qr(e,Object(N.b)("You need to be logged in."));const n=a.getRoom(t);if(!n)return void Qr(e,Object(N.b)("This room is not recognised."));Jr(e,n.getJoinedMemberCount())}(e,i);else!function(e,t,a){if("string"!=typeof a)throw new Error("Plumbing state status should be a string");Oa.a.log(`Received request to set plumbing state to status "${a}" in room ${t}`);const n=oe.a.get();n?n.sendStateEvent(t,"m.room.plumbing",{status:a}).then((()=>{Jr(e,{success:!0})}),(t=>{Qr(e,t.message?t.message:Object(N.b)("Failed to send request."),t)})):Qr(e,Object(N.b)("You need to be logged in."))}(e,i,e.data.status);else!function(e,t){Oa.a.log(`join_rules of ${t} requested.`),el(e,t,"m.room.join_rules","")}(e,i);else Xr(e,i);else Zr(e,i);else Qr(e,Object(N.b)("Room %(roomId)s not visible",{roomId:i}))};let al,nl=0;var il=a(280);class sl extends o.a.Component{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"resizeContainer",void 0),i()(this,"resizer",void 0),i()(this,"dispatcherRef",void 0),i()(this,"onIsResizing",(e=>{this.setState({resizingVertical:e}),e||this.relaxResizer()})),i()(this,"collectResizer",(e=>{this.resizeContainer&&this.resizer.detach(),e&&(this.resizer.container=e,this.resizer.attach()),this.resizeContainer=e,this.loadResizerPreferences()})),i()(this,"getAppsHash",(e=>e.map((e=>e.id)).join("~"))),i()(this,"relaxResizer",(()=>{const e=this.resizer.getDistributors();e.forEach((e=>e.start())),e.forEach((e=>e.finish()))})),i()(this,"loadResizerPreferences",(()=>{const e=rn.d.instance.getResizerDistributions(this.props.room,rn.a.Top);if(this.state.apps&&this.topApps().length-1===e.length)e.forEach(((e,t)=>{const a=this.resizer.forHandleAt(t);a&&(a.size=e,a.finish())}));else if(this.state.apps){const e=this.resizer.getDistributors();e.forEach((e=>e.item.clearSize())),e.forEach((e=>e.start())),e.forEach((e=>e.finish()))}})),i()(this,"onAction",(e=>{const t=this.props.room.roomId+"_hide_widget_drawer";if("appsDrawer"===e.action)e.show?localStorage.setItem(t,"false"):localStorage.setItem(t,"true")})),i()(this,"getApps",(()=>({[rn.a.Top]:rn.d.instance.getContainerWidgets(this.props.room,rn.a.Top),[rn.a.Center]:rn.d.instance.getContainerWidgets(this.props.room,rn.a.Center)}))),i()(this,"topApps",(()=>this.state.apps[rn.a.Top])),i()(this,"centerApps",(()=>this.state.apps[rn.a.Center])),i()(this,"updateApps",(()=>{this.unmounted||this.setState({apps:this.getApps()})})),this.state={apps:this.getApps(),resizingVertical:!1,resizingHorizontal:!1,resizing:!1},this.resizer=this.createResizer(),this.props.resizeNotifier.on("isResizing",this.onIsResizing)}componentDidMount(){0===nl&&window.addEventListener("message",tl,!1),nl+=1,rn.d.instance.on(rn.d.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef=b.a.register(this.onAction)}componentWillUnmount(){this.unmounted=!0,function(){if(nl-=1,0===nl&&window.removeEventListener("message",tl),nl<0){const e=new Error("ScalarMessaging: mismatched startListening / stopListening detected. Negative count");Oa.a.error(e)}}(),rn.d.instance.off(rn.d.emissionForRoom(this.props.room),this.updateApps),this.dispatcherRef&&b.a.unregister(this.dispatcherRef),this.resizeContainer&&this.resizer.detach(),this.props.resizeNotifier.off("isResizing",this.onIsResizing)}createResizer(){const e=new k(null,O,{onResizeStart:()=>{this.resizeContainer.classList.add("mx_AppsDrawer_resizing"),this.setState({resizingHorizontal:!0})},onResizeStop:()=>{this.resizeContainer.classList.remove("mx_AppsDrawer_resizing"),rn.d.instance.setResizerDistributions(this.props.room,rn.a.Top,this.topApps().slice(1).map(((e,t)=>this.resizer.forHandleAt(t).size))),this.setState({resizingHorizontal:!1})}});return e.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),e}componentDidUpdate(e,t){e.userId!==this.props.userId||e.room!==this.props.room?this.updateApps():this.getAppsHash(this.topApps())!==this.getAppsHash(t.apps[rn.a.Top])&&this.loadResizerPreferences()}isResizing(){return this.state.resizingVertical||this.state.resizingHorizontal}render(){if(!this.props.showApps)return o.a.createElement("div",null);const e=this.centerApps().length>0,t=(e?this.centerApps():this.topApps()).map(((e,t,a)=>o.a.createElement(Qi,{key:e.id,app:e,fullWidth:a.length<2,room:this.props.room,userId:this.props.userId,creatorUserId:e.creatorUserId,widgetPageTitle:Ka.a.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,pointerEvents:this.isResizing()?"none":void 0})));if(0===t.length)return o.a.createElement("div",null);let a;0===t.length&&Sr.a.roomHasPendingWidgets(this.props.room.roomId,Ka.a.getRoomWidgets(this.props.room))&&(a=o.a.createElement(Zn.a,null));const n=c()({mx_AppsDrawer:!0,mx_AppsDrawer_maximise:e,mx_AppsDrawer_fullWidth:t.length<2,mx_AppsDrawer_resizing:this.state.resizing,mx_AppsDrawer_2apps:2===t.length,mx_AppsDrawer_3apps:3===t.length}),i=o.a.createElement("div",{className:"mx_AppsContainer",ref:this.collectResizer},t.map(((e,a)=>a<1?e:o.a.createElement(o.a.Fragment,{key:e.key},o.a.createElement(E,{reverse:a>t.length/2}),e))));let s;return s=e?i:o.a.createElement(ol,{room:this.props.room,minHeight:100,maxHeight:this.props.maxHeight-50,handleClass:"mx_AppsContainer_resizerHandle",handleWrapperClass:"mx_AppsContainer_resizerHandleContainer",className:"mx_AppsContainer_resizer",resizeNotifier:this.props.resizeNotifier},i),o.a.createElement("div",{className:n},s,a)}}i()(sl,"defaultProps",{showApps:!0});const ol=e=>{let{room:t,minHeight:a,maxHeight:n,className:i,handleWrapperClass:s,handleClass:r,resizeNotifier:l,children:c}=e,d=rn.d.instance.getContainerHeight(t,rn.a.Top);return a||(a=100),n||(n=Q.b.instance.windowHeight/4*3),d?(d=Object(il.a)(d,0,100),d=Object(il.d)(d/100,a,n)):d=280,o.a.createElement(Ma.Resizable,{size:{height:Math.min(d,n),width:void 0},minHeight:a,maxHeight:n,onResizeStart:()=>{l.startResizing()},onResize:()=>{l.notifyTimelineHeightChanged()},onResizeStop:(e,i,s,o)=>{let r=d+o.height;r=100*Object(il.c)(r,a,n),rn.d.instance.setContainerHeight(t,rn.a.Top,r),l.stopResizing()},handleWrapperClass:s,handleClasses:{bottom:r},className:i,enable:{bottom:!0}},c)};var rl=a(373);class ll extends o.a.PureComponent{constructor(e){super(e),i()(this,"element",void 0),i()(this,"setElementRef",(e=>{var t;e?(this.element=e,e.addEventListener("resize",this.onResize)):null===(t=this.element)||void 0===t||t.removeEventListener("resize",this.onResize)})),i()(this,"onNewStream",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}),this.playMedia()})),i()(this,"onMuteStateChanged",(()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()})})),i()(this,"onResize",(e=>{this.props.onResize&&!this.props.feed.isLocal()&&this.props.onResize(e)})),this.state={audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}}componentDidMount(){this.updateFeed(null,this.props.feed),this.playMedia()}componentWillUnmount(){this.updateFeed(this.props.feed,null)}componentDidUpdate(e,t){this.updateFeed(e.feed,this.props.feed),t.videoMuted===this.state.videoMuted&&e.feed.stream===this.props.feed.stream||this.playMedia()}static getDerivedStateFromProps(e){return{audioMuted:e.feed.isAudioMuted(),videoMuted:e.feed.isVideoMuted()}}updateFeed(e,t){e!==t&&(e&&(this.props.feed.removeListener(wa.b.NewStream,this.onNewStream),this.props.feed.removeListener(wa.b.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===rl.b.Usermedia&&this.props.feed.measureVolumeActivity(!1),this.stopMedia()),t&&(this.props.feed.addListener(wa.b.NewStream,this.onNewStream),this.props.feed.addListener(wa.b.MuteStateChanged,this.onMuteStateChanged),this.props.feed.purpose===rl.b.Usermedia&&this.props.feed.measureVolumeActivity(!0),this.playMedia()))}async playMedia(){const e=this.element;if(e){e.muted=!0,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{await e.play()}catch(e){Oa.a.info(`Failed to play media element with feed for userId ${this.props.feed.userId} with purpose ${this.props.feed.purpose}`,e)}}}stopMedia(){const e=this.element;e&&(e.pause(),e.src=null)}render(){const{pipMode:e,primary:t,secondary:a,feed:n}=this.props,i=c()("mx_VideoFeed",{mx_VideoFeed_primary:t,mx_VideoFeed_secondary:a,mx_VideoFeed_voice:this.state.videoMuted}),s=c()("mx_VideoFeed_mic",{mx_VideoFeed_mic_muted:this.state.audioMuted,mx_VideoFeed_mic_unmuted:!this.state.audioMuted});let r,l;if(n.purpose===rl.b.Screenshare||t||e||(r=o.a.createElement("div",{className:s})),this.state.videoMuted){var d;const a=B.b.instance.roomIdForCall(this.props.call),n=null!==(d=a?oe.a.get().getRoom(a):void 0)&&void 0!==d?d:void 0;let i;e&&t?i=76:e&&!t?i=16:!e&&t&&(i=160),l=o.a.createElement(ye.a,{room:n,height:i,width:i})}else{const e=c()("mx_VideoFeed_video",{mx_VideoFeed_video_mirror:this.props.feed.isLocal()&&this.props.feed.purpose===rl.b.Usermedia&&v.b.getValue("VideoView.flipVideoHorizontally")});l=o.a.createElement("video",{className:e,ref:this.setElementRef})}return o.a.createElement("div",{className:i},r,l)}}var cl=a(240),dl=a(897);class ml extends o.a.Component{render(){const e=this.props.feeds.map((e=>o.a.createElement(ll,{key:e.stream.id,feed:e,call:this.props.call,primary:!1,pipMode:this.props.pipMode}))),t=c()("mx_LegacyCallViewSidebar",{mx_LegacyCallViewSidebar_pipMode:this.props.pipMode});return o.a.createElement("div",{className:t},e)}}const hl=e=>{let{onExpand:t,onPin:a,onMaximize:n}=e;return o.a.createElement("div",{className:"mx_LegacyCallViewHeader_controls"},n&&o.a.createElement(q.a,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_fullscreen",onClick:n,title:Object(N.b)("Fill screen")}),a&&o.a.createElement(q.a,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_pin",onClick:a,title:Object(N.b)("Pin")}),t&&o.a.createElement(q.a,{className:"mx_LegacyCallViewHeader_button mx_LegacyCallViewHeader_button_expand",onClick:t,title:Object(N.b)("Return to call")}))},ul=e=>{let{callRoom:t}=e;return o.a.createElement("span",{className:"mx_LegacyCallViewHeader_secondaryCallInfo"},o.a.createElement(ye.a,{room:t,height:16,width:16}),o.a.createElement("span",{className:"mx_LegacyCallView_secondaryCall_roomName"},Object(N.b)("%(name)s on hold",{name:t.name})))};var pl=e=>{let{pipMode:t=!1,callRooms:a,onPipMouseDown:n,onExpand:i,onPin:s,onMaximize:r}=e;const[l,c]=a,d=l.name;return t?o.a.createElement("div",{className:"mx_LegacyCallViewHeader mx_LegacyCallViewHeader_pip",onMouseDown:n},o.a.createElement(ye.a,{room:l,height:32,width:32}),o.a.createElement("div",{className:"mx_LegacyCallViewHeader_callInfo"},o.a.createElement("div",{className:"mx_LegacyCallViewHeader_roomName"},d),c&&o.a.createElement(ul,{callRoom:c})),o.a.createElement(hl,{onExpand:i,onPin:s,onMaximize:r})):o.a.createElement("div",{className:"mx_LegacyCallViewHeader"},o.a.createElement("div",{className:"mx_LegacyCallViewHeader_icon"}),o.a.createElement("span",{className:"mx_LegacyCallViewHeader_text"},Object(N.b)("Call")),o.a.createElement(hl,{onMaximize:r}))};class gl extends o.a.Component{constructor(e){super(e),i()(this,"onHoldClick",(()=>{this.props.call.setRemoteOnHold(!0),this.props.onFinished()})),i()(this,"onUnholdClick",(()=>{B.b.instance.setActiveCallRoomId(this.props.call.roomId),this.props.onFinished()})),i()(this,"onTransferClick",(()=>{B.b.instance.showTransferDialog(this.props.call),this.props.onFinished()}))}render(){const e=this.props.call.isRemoteOnHold()?Object(N.b)("Resume"):Object(N.b)("Hold"),t=this.props.call.isRemoteOnHold()?this.onUnholdClick:this.onHoldClick;let a;return this.props.call.opponentCanBeTransferred()&&(a=o.a.createElement(de.d,{className:"mx_LegacyCallContextMenu_item",onClick:this.onTransferClick},Object(N.b)("Transfer"))),o.a.createElement(de.n,this.props,o.a.createElement(de.d,{className:"mx_LegacyCallContextMenu_item",onClick:t},e),a)}}var bl=a(658);class vl extends s.Component{constructor(e){super(e),i()(this,"numberEntryFieldRef",Object(s.createRef)()),i()(this,"onDigitPress",((e,t)=>{var a;(this.props.call.sendDtmfDigit(e),this.setState({value:this.state.value+e}),"click"===t.type)&&(null===(a=this.numberEntryFieldRef.current)||void 0===a||a.focus())})),i()(this,"onCancelClick",(()=>{this.props.onFinished()})),i()(this,"onKeyDown",(e=>{"Backspace"!==e.code&&"Delete"!==e.code||e.preventDefault()})),i()(this,"onChange",(e=>{this.setState({value:e.target.value})})),this.state={value:""}}render(){return s.createElement(de.n,this.props,s.createElement("div",{className:"mx_DialPadContextMenuWrapper"},s.createElement("div",null,s.createElement(K.a,{className:"mx_DialPadContextMenu_cancel",onClick:this.onCancelClick})),s.createElement("div",{className:"mx_DialPadContextMenu_header"},s.createElement(st.a,{ref:this.numberEntryFieldRef,className:"mx_DialPadContextMenu_dialled",value:this.state.value,autoFocus:!0,onKeyDown:this.onKeyDown,onChange:this.onChange})),s.createElement("div",{className:"mx_DialPadContextMenu_dialPad"},s.createElement(bl.a,{onDigitPress:this.onDigitPress,hasDial:!1}))))}}const fl=["deviceKinds"],El={[p.b.AudioInput]:Object(N.d)("Input devices"),[p.b.AudioOutput]:Object(N.d)("Output devices"),[p.b.VideoInput]:Object(N.d)("Cameras")},yl=e=>{let{label:t,selected:a,onClick:n}=e;return o.a.createElement(he.d,{iconClassName:"mx_DeviceContextMenu_device_icon",label:t,active:a,onClick:n})},_l=e=>{let{deviceKind:t}=e;const[a,n]=Object(s.useState)([]),[i,r]=Object(s.useState)(p.c.getDevice(t));Object(s.useEffect)((()=>{(async()=>{var e,a;n(null!==(e=null===(a=await p.c.getDevices())||void 0===a?void 0:a[t])&&void 0!==e?e:[])})()}),[t]);return o.a.createElement(he.c,{label:Object(N.b)(El[t])},a.map((e=>{let{label:a,deviceId:n}=e;return o.a.createElement(yl,{key:n,label:a,selected:i===n,onClick:()=>(e=>{p.c.instance.setDevice(e,t),r(e)})(n)})})))};var Sl=e=>{let{deviceKinds:t}=e,a=ve()(e,fl);return o.a.createElement(he.e,Z()({compact:!0,className:"mx_DeviceContextMenu"},a),t.map((e=>o.a.createElement(_l,{key:e,deviceKind:e}))))};const wl=["children","state","className","onLabel","offLabel"],Ol=["state","deviceKinds"],Cl=e=>{let{children:t,state:a,className:n,onLabel:i,offLabel:s}=e,r=ve()(e,wl);const l=c()("mx_LegacyCallViewButtons_button",n,{mx_LegacyCallViewButtons_button_on:a,mx_LegacyCallViewButtons_button_off:!a});return o.a.createElement(q.a,Z()({className:l,title:a?i:s,alignment:Ao.a.Top},r),t)},xl=e=>{let{state:t,deviceKinds:a}=e,n=ve()(e,Ol);const[i,r,l,d]=Object(de.q)(),[m,h]=Object(s.useState)(!1),u=c()("mx_LegacyCallViewButtons_button","mx_LegacyCallViewButtons_dropdownButton",{mx_LegacyCallViewButtons_dropdownButton_collapsed:!i});return o.a.createElement(Cl,Z()({inputRef:r,forceHide:i||m,state:t},n),o.a.createElement(Cl,{className:u,onClick:e=>{e.stopPropagation(),l()},onHover:e=>h(e),state:t}),i&&r.current&&o.a.createElement(Sl,Z()({},Object(de.k)(r.current.getBoundingClientRect()),{onFinished:d,deviceKinds:a})))};class jl extends o.a.Component{constructor(e){super(e),i()(this,"dialpadButton",Object(s.createRef)()),i()(this,"contextMenuButton",Object(s.createRef)()),i()(this,"controlsHideTimer",null),i()(this,"onControlsHideTimer",(()=>{this.state.hoveringControls||this.state.showDialpad||this.state.showMoreMenu||(this.controlsHideTimer=null,this.setState({visible:!1}))})),i()(this,"onMouseEnter",(()=>{this.setState({hoveringControls:!0})})),i()(this,"onMouseLeave",(()=>{this.setState({hoveringControls:!1})})),i()(this,"onDialpadClick",(()=>{this.state.showDialpad?this.setState({showDialpad:!1}):(this.setState({showDialpad:!0}),this.showControls())})),i()(this,"onMoreClick",(()=>{this.setState({showMoreMenu:!0}),this.showControls()})),i()(this,"closeDialpad",(()=>{this.setState({showDialpad:!1})})),i()(this,"closeContextMenu",(()=>{this.setState({showMoreMenu:!1})})),this.state={showDialpad:!1,hoveringControls:!1,showMoreMenu:!1,visible:!0}}componentDidMount(){this.showControls()}showControls(){this.state.showMoreMenu||this.state.showDialpad||(this.state.visible||this.setState({visible:!0}),null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,2e3))}render(){const e=c()("mx_LegacyCallViewButtons",{mx_LegacyCallViewButtons_hidden:!this.state.visible});let t,a;return this.state.showDialpad&&this.dialpadButton.current&&(t=o.a.createElement(vl,Z()({},Object(de.l)(this.dialpadButton.current.getBoundingClientRect(),de.a.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeDialpad,call:this.props.call}))),this.state.showMoreMenu&&this.contextMenuButton.current&&(a=o.a.createElement(gl,Z()({},Object(de.l)(this.contextMenuButton.current.getBoundingClientRect(),de.a.None,8),{mountAsChild:!this.props.pipMode,onFinished:this.closeContextMenu,call:this.props.call}))),o.a.createElement("div",{className:e,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave},t,a,this.props.buttonsVisibility.dialpad&&o.a.createElement(de.c,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_dialpad",inputRef:this.dialpadButton,onClick:this.onDialpadClick,isExpanded:this.state.showDialpad,title:Object(N.b)("Dialpad"),alignment:Ao.a.Top}),o.a.createElement(xl,{state:!this.props.buttonsState.micMuted,className:"mx_LegacyCallViewButtons_button_mic",onLabel:Object(N.b)("Mute the microphone"),offLabel:Object(N.b)("Unmute the microphone"),onClick:this.props.handlers.onMicMuteClick,deviceKinds:[p.b.AudioInput,p.b.AudioOutput]}),this.props.buttonsVisibility.vidMute&&o.a.createElement(xl,{state:!this.props.buttonsState.vidMuted,className:"mx_LegacyCallViewButtons_button_vid",onLabel:Object(N.b)("Stop the camera"),offLabel:Object(N.b)("Start the camera"),onClick:this.props.handlers.onVidMuteClick,deviceKinds:[p.b.VideoInput]}),this.props.buttonsVisibility.screensharing&&o.a.createElement(Cl,{state:this.props.buttonsState.screensharing,className:"mx_LegacyCallViewButtons_button_screensharing",onLabel:Object(N.b)("Stop sharing your screen"),offLabel:Object(N.b)("Start sharing your screen"),onClick:this.props.handlers.onScreenshareClick}),this.props.buttonsVisibility.sidebar&&o.a.createElement(Cl,{state:this.props.buttonsState.sidebarShown,className:"mx_LegacyCallViewButtons_button_sidebar",onLabel:Object(N.b)("Hide sidebar"),offLabel:Object(N.b)("Show sidebar"),onClick:this.props.handlers.onToggleSidebarClick}),this.props.buttonsVisibility.contextMenu&&o.a.createElement(de.c,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_button_more",onClick:this.onMoreClick,inputRef:this.contextMenuButton,isExpanded:this.state.showMoreMenu,title:Object(N.b)("More"),alignment:Ao.a.Top}),o.a.createElement(q.a,{className:"mx_LegacyCallViewButtons_button mx_LegacyCallViewButtons_button_hangup",onClick:this.props.handlers.onHangupClick,title:Object(N.b)("Hangup"),alignment:Ao.a.Top}))}}function kl(){return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function Rl(){const e=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document)}class Il extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"contentWrapperRef",Object(s.createRef)()),i()(this,"buttonsRef",Object(s.createRef)()),i()(this,"onAction",(e=>{if("video_fullscreen"===e.action){if(!this.contentWrapperRef.current)return;e.fullscreen?function(e){const t=e.requestFullscreen||e.webkitRequestFullScreen||e.msRequestFullscreen;t&&t.call(e)}(this.contentWrapperRef.current):kl()&&Rl()}})),i()(this,"onCallState",(e=>{this.setState({callState:e})})),i()(this,"onFeedsChanged",(e=>{const{primary:t,secondary:a,sidebar:n}=Il.getOrderedFeeds(e);this.setState({primaryFeed:t,secondaryFeed:a,sidebarFeeds:n,micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted()})})),i()(this,"onCallLocalHoldUnhold",(()=>{this.setState({isLocalOnHold:this.props.call.isLocalOnHold()})})),i()(this,"onCallRemoteHoldUnhold",(()=>{this.setState({isRemoteOnHold:this.props.call.isRemoteOnHold(),isLocalOnHold:this.props.call.isLocalOnHold()})})),i()(this,"onMouseMove",(()=>{var e;null===(e=this.buttonsRef.current)||void 0===e||e.showControls()})),i()(this,"onMaximizeClick",(()=>{b.a.dispatch({action:"video_fullscreen",fullscreen:!0})})),i()(this,"onMicMuteClick",(async()=>{const e=!this.state.micMuted;this.setState({micMuted:await this.props.call.setMicrophoneMuted(e)})})),i()(this,"onVidMuteClick",(async()=>{const e=!this.state.vidMuted;this.setState({vidMuted:await this.props.call.setLocalVideoMuted(e)})})),i()(this,"onScreenshareClick",(async()=>{let e;var t;if(this.state.screensharing)e=await this.props.call.setScreensharingEnabled(!1);else if(null!==(t=I.a.get())&&void 0!==t&&t.supportsDesktopCapturer()){const{finished:t}=z.b.createDialog(dl.a),[a]=await t;if(!a)return;e=await this.props.call.setScreensharingEnabled(!0,{desktopCapturerSourceId:a})}else e=await this.props.call.setScreensharingEnabled(!0);this.setState({sidebarShown:!0,screensharing:e})})),i()(this,"onNativeKeyDown",(e=>{var t,a;let n=!1;switch(Object(J.a)().getCallAction(e)){case W.h.ToggleMicInCall:this.onMicMuteClick(),null===(t=this.buttonsRef.current)||void 0===t||t.showControls(),n=!0;break;case W.h.ToggleWebcamInCall:this.onVidMuteClick(),null===(a=this.buttonsRef.current)||void 0===a||a.showControls(),n=!0}n&&(e.stopPropagation(),e.preventDefault())})),i()(this,"onCallResumeClick",(()=>{const e=B.b.instance.roomIdForCall(this.props.call);B.b.instance.setActiveCallRoomId(e)})),i()(this,"onTransferClick",(()=>{const e=B.b.instance.getTransfereeForCallId(this.props.call.callId);this.props.call.transferToCall(e)})),i()(this,"onHangupClick",(()=>{B.b.instance.hangupOrReject(B.b.instance.roomIdForCall(this.props.call))})),i()(this,"onToggleSidebar",(()=>{this.setState({sidebarShown:!this.state.sidebarShown})}));const{primary:t,secondary:a,sidebar:n}=Il.getOrderedFeeds(this.props.call.getFeeds());this.state={isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),screensharing:this.props.call.isScreensharing(),callState:this.props.call.state,primaryFeed:t,secondaryFeed:a,sidebarFeeds:n,sidebarShown:!0},this.updateCallListeners(null,this.props.call)}componentDidMount(){this.dispatcherRef=b.a.register(this.onAction),document.addEventListener("keydown",this.onNativeKeyDown)}componentWillUnmount(){kl()&&Rl(),document.removeEventListener("keydown",this.onNativeKeyDown),this.updateCallListeners(this.props.call,null),b.a.unregister(this.dispatcherRef)}static getDerivedStateFromProps(e){const{primary:t,secondary:a,sidebar:n}=Il.getOrderedFeeds(e.call.getFeeds());return{primaryFeed:t,secondaryFeed:a,sidebarFeeds:n}}componentDidUpdate(e){this.props.call!==e.call&&(this.setState({isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state}),this.updateCallListeners(null,this.props.call))}updateCallListeners(e,t){e!==t&&(e&&(e.removeListener(Sa.d.State,this.onCallState),e.removeListener(Sa.d.LocalHoldUnhold,this.onCallLocalHoldUnhold),e.removeListener(Sa.d.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),e.removeListener(Sa.d.FeedsChanged,this.onFeedsChanged)),t&&(t.on(Sa.d.State,this.onCallState),t.on(Sa.d.LocalHoldUnhold,this.onCallLocalHoldUnhold),t.on(Sa.d.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),t.on(Sa.d.FeedsChanged,this.onFeedsChanged)))}static getOrderedFeeds(e){if(e.length<=2)return{primary:e.find((e=>!e.isLocal())),secondary:e.find((e=>e.isLocal())),sidebar:[]};let t;const a=e.filter((e=>e.purpose===rl.b.Screenshare));t=a.find((e=>!e.isLocal()))||a[0],t||(t=e.find((e=>!e.isLocal())));const n=[...e];return t&&n.splice(n.indexOf(t),1),n.sort(((e,t)=>e.isLocal()&&!t.isLocal()?-1:!e.isLocal()&&t.isLocal()?1:0)),{primary:t,sidebar:n}}renderCallControls(){const{call:e,pipMode:t}=this.props,{callState:a,micMuted:n,vidMuted:i,screensharing:s,sidebarShown:r,secondaryFeed:l,sidebarFeeds:c}=this.state,d=e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack,m=(e.opponentSupportsSDPStreamMetadata()||e.hasLocalUserMediaVideoTrack)&&e.state===Sa.f.Connected,h=l&&!l.isVideoMuted()||c.length>0,u=a===Sa.f.Connected,p=a===Sa.f.Connected&&e.opponentSupportsDTMF();return o.a.createElement(jl,{ref:this.buttonsRef,call:e,pipMode:t,handlers:{onToggleSidebarClick:this.onToggleSidebar,onScreenshareClick:this.onScreenshareClick,onHangupClick:this.onHangupClick,onMicMuteClick:this.onMicMuteClick,onVidMuteClick:this.onVidMuteClick},buttonsState:{micMuted:n,vidMuted:i,sidebarShown:r,screensharing:s},buttonsVisibility:{vidMute:d,screensharing:m,sidebar:h,contextMenu:u,dialpad:p}})}renderToast(){var e;const{call:t}=this.props;if(!t.getFeeds().some((e=>e.purpose===rl.b.Screenshare)))return null;const a=t.isScreensharing(),{primaryFeed:n,sidebarShown:i}=this.state,s=null==n||null===(e=n.getMember())||void 0===e?void 0:e.name;if(!s)return null;let r=a?Object(N.b)("You are presenting"):Object(N.b)("%(sharerName)s is presenting",{sharerName:s});return i||(r+=" • "+(t.isLocalVideoMuted()?Object(N.b)("Your camera is turned off"):Object(N.b)("Your camera is still enabled"))),o.a.createElement("div",{className:"mx_LegacyCallView_toast"},r)}renderContent(){var e;const{pipMode:t,call:a,onResize:n}=this.props,{isLocalOnHold:i,isRemoteOnHold:s,sidebarShown:r,primaryFeed:l,secondaryFeed:d,sidebarFeeds:m}=this.state,h=B.b.instance.roomIdForCall(a),u=null!==(e=h?oe.a.get().getRoom(h):void 0)&&void 0!==e?e:void 0,p=t?76:160,g=B.b.instance.getTransfereeForCallId(a.callId),b=i||s;let v;if(r&&d&&!d.isVideoMuted()&&(v=o.a.createElement(ll,{feed:d,call:a,pipMode:t,onResize:n,secondary:!0})),g||b){const e=c()("mx_LegacyCallView_content",{mx_LegacyCallView_content_hold:b}),t=Object(cl.a)(a.getOpponentMember(),1024,1024,"crop");let n;if(g){const e=oe.a.get().getRoom(B.b.instance.roomIdForCall(a)),t=e?e.name:Object(N.b)("unknown person"),i=oe.a.get().getRoom(B.b.instance.roomIdForCall(g)),s=i?i.name:Object(N.b)("unknown person");n=o.a.createElement("div",{className:"mx_LegacyCallView_status"},Object(N.b)("Consulting with %(transferTarget)s. <a>Transfer to %(transferee)s</a>",{transferTarget:t,transferee:s},{a:e=>o.a.createElement(K.a,{kind:"link_inline",onClick:this.onTransferClick},e)}))}else{let e;if(s)e=Object(N.b)(B.b.instance.hasAnyUnheldCall()?Object(N.d)("You held the call <a>Switch</a>"):Object(N.d)("You held the call <a>Resume</a>"),{},{a:e=>o.a.createElement(K.a,{kind:"link_inline",onClick:this.onCallResumeClick},e)});else if(i){var f;e=Object(N.b)("%(peerName)s held the call",{peerName:null===(f=a.getOpponentMember())||void 0===f?void 0:f.name})}n=o.a.createElement("div",{className:"mx_LegacyCallView_status"},e)}return o.a.createElement("div",{className:e,onMouseMove:this.onMouseMove},o.a.createElement("div",{className:"mx_LegacyCallView_holdBackground",style:{backgroundImage:"url("+t+")"}}),n)}return a.noIncomingFeeds()?o.a.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.a.createElement("div",{className:"mx_LegacyCallView_avatarsContainer"},o.a.createElement("div",{className:"mx_LegacyCallView_avatarContainer",style:{width:p,height:p}},o.a.createElement(ye.a,{room:u,height:p,width:p}))),o.a.createElement("div",{className:"mx_LegacyCallView_status"},Object(N.b)("Connecting")),v):t?o.a.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.a.createElement(ll,{feed:l,call:a,pipMode:t,onResize:n,primary:!0})):d?o.a.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.a.createElement(ll,{feed:l,call:a,pipMode:t,onResize:n,primary:!0}),v):o.a.createElement("div",{className:"mx_LegacyCallView_content",onMouseMove:this.onMouseMove},o.a.createElement(ll,{feed:l,call:a,pipMode:t,onResize:n,primary:!0}),r&&o.a.createElement(ml,{feeds:m,call:a,pipMode:Boolean(t)}))}render(){const{call:e,secondaryCall:t,pipMode:a,showApps:n,onMouseDownOnHeader:i}=this.props,{sidebarShown:s,sidebarFeeds:r}=this.state,l=oe.a.get(),d=B.b.instance.roomIdForCall(e),m=B.b.instance.roomIdForCall(t),h=d?l.getRoom(d):null,u=m?l.getRoom(m):null,p=c()({mx_LegacyCallView:!0,mx_LegacyCallView_pip:a,mx_LegacyCallView_large:!a,mx_LegacyCallView_sidebar:s&&0!==r.length&&!a,mx_LegacyCallView_belowWidget:n});return o.a.createElement("div",{className:p},o.a.createElement(pl,{onPipMouseDown:i,pipMode:a,callRooms:[h,u],onMaximize:this.onMaximizeClick}),o.a.createElement("div",{className:"mx_LegacyCallView_content_wrapper",ref:this.contentWrapperRef},this.renderToast(),this.renderContent(),this.renderCallControls()))}}class Tl extends o.a.Component{constructor(e){super(e),i()(this,"updateCall",(()=>{const e=this.getCall();e!==this.state.call&&this.setState({call:e})})),i()(this,"onResizeStart",(()=>{this.props.resizeNotifier.startResizing()})),i()(this,"onResize",(()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()})),i()(this,"onResizeStop",(()=>{this.props.resizeNotifier.stopResizing()})),this.state={call:this.getCall()}}componentDidMount(){B.b.instance.addListener(B.a.CallState,this.updateCall),B.b.instance.addListener(B.a.CallChangeRoom,this.updateCall)}componentWillUnmount(){B.b.instance.removeListener(B.a.CallState,this.updateCall),B.b.instance.removeListener(B.a.CallChangeRoom,this.updateCall)}getCall(){const e=B.b.instance.getCallForRoom(this.props.roomId);return e&&[Sa.f.Ended,Sa.f.Ringing].includes(e.state)?null:e}render(){return this.state.call?o.a.createElement("div",{className:"mx_LegacyCallViewForRoom"},o.a.createElement(Ma.Resizable,{minHeight:380,maxHeight:"80vh",enable:{top:!1,right:!1,bottom:!0,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_LegacyCallViewForRoom_ResizeWrapper",handleClasses:{bottom:"mx_LegacyCallViewForRoom_ResizeHandle"}},o.a.createElement(Il,{call:this.state.call,pipMode:!1,showApps:this.props.showApps}))):null}}class Nl extends o.a.Component{constructor(e){super(e),i()(this,"onRoomStateEvents",(e=>{"re.jki.counter"===e.getType()&&this.updateCounters()})),i()(this,"updateCounters",Object(j.throttle)((()=>{this.setState({counters:this.computeCounters()})}),500,{leading:!0,trailing:!0})),this.state={counters:this.computeCounters()}}componentDidMount(){const e=oe.a.get();v.b.getValue("feature_state_counters")&&e.on(m.b.Events,this.onRoomStateEvents)}componentWillUnmount(){var e;v.b.getValue("feature_state_counters")&&(null===(e=oe.a.get())||void 0===e||e.removeListener(m.b.Events,this.onRoomStateEvents))}shouldComponentUpdate(e,t){return Object(yn.c)(this.props,e)||Object(yn.c)(this.state,t)}componentDidUpdate(e,t){this.props.onResize&&this.props.onResize()}computeCounters(){const e=[];if(this.props.room&&v.b.getValue("feature_state_counters")){const t=this.props.room.currentState.getStateEvents("re.jki.counter");t.sort(((e,t)=>Object(En.x)(e.getStateKey(),t.getStateKey())));for(const a of t){const t=a.getContent().title,n=a.getContent().value,i=a.getContent().link,s=a.getContent().severity||"normal",o=a.getStateKey();t&&void 0!==n&&e.push({title:t,value:n,link:i,severity:s,stateKey:o})}}return e}render(){const e=o.a.createElement(Tl,{roomId:this.props.room.roomId,resizeNotifier:this.props.resizeNotifier,showApps:this.props.showApps});let t;v.b.getValue(le.b.Widgets)&&(t=o.a.createElement(sl,{room:this.props.room,userId:this.props.userId,showApps:this.props.showApps,resizeNotifier:this.props.resizeNotifier}));let a=null;if(this.state.counters&&v.b.getValue("feature_state_counters")){const e=[];this.state.counters.forEach(((t,a)=>{const n=t.title,i=t.value,s=t.link,r=t.severity,l=t.stateKey;let c=o.a.createElement("span",null,n,": ",i);s&&(c=o.a.createElement("a",{href:s,target:"_blank",rel:"noreferrer noopener"},c)),c=o.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_span","data-severity":r,key:"x-"+l},c),e.push(c),e.push(o.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_delim",key:"delim"+a}," ","─"," "))})),e.length>0&&(e.pop(),a=o.a.createElement("div",{className:"m_RoomView_auxPanel_stateViews"},e))}return o.a.createElement(kt.a,{className:"mx_RoomView_auxPanel"},a,this.props.children,t,e)}}i()(Nl,"defaultProps",{showApps:!0});const Pl=["isHighlighted","isUnread","onClick","name","title"];class Dl extends o.a.Component{render(){const e=this.props,{isHighlighted:t,isUnread:a=!1,onClick:n,name:i,title:s}=e,r=ve()(e,Pl),l=c()({mx_RightPanel_headerButton:!0,mx_RightPanel_headerButton_highlight:t,mx_RightPanel_headerButton_unread:a,[`mx_RightPanel_${i}`]:!0});return o.a.createElement(q.a,Z()({},r,{"aria-selected":t,role:"tab",title:s,alignment:Ao.a.Bottom,className:l,onClick:n}))}}let Ml=function(e){return e.Room="room",e}({});class Al extends o.a.Component{constructor(e,t){super(e),i()(this,"unmounted",!1),i()(this,"dispatcherRef",void 0),i()(this,"onRightPanelStoreUpdate",(()=>{this.unmounted||this.setState({phase:Fa.a.instance.currentCard.phase})}));const a=Fa.a.instance;this.state={headerKind:t,phase:a.currentCard.phase,threadNotificationColor:xe.a.None,globalNotificationColor:xe.a.None}}componentDidMount(){Fa.a.instance.on(Et.b,this.onRightPanelStoreUpdate),this.dispatcherRef=b.a.register(this.onAction.bind(this))}componentWillUnmount(){this.unmounted=!0,Fa.a.instance.off(Et.b,this.onRightPanelStoreUpdate),this.dispatcherRef&&b.a.unregister(this.dispatcherRef)}setPhase(e,t){const a=Fa.a.instance;a.currentCard.phase==e&&!t&&a.isOpen?a.togglePanel(null):(Fa.a.instance.setCard({phase:e,state:t}),a.isOpen||a.togglePanel(null))}isPhase(e){return!!Fa.a.instance.isOpen&&(Array.isArray(e)?!!this.state.phase&&e.includes(this.state.phase):e===this.state.phase)}render(){return o.a.createElement("div",{className:"mx_HeaderButtons",role:"tablist"},this.renderButtons())}}var Ul=a(386);const Ll=[La.a.RoomSummary,La.a.Widget,La.a.FilePanel,La.a.RoomMemberList,La.a.RoomMemberInfo,La.a.EncryptionPanel,La.a.Room3pidMemberInfo],Fl=e=>{let{color:t}=e;if(t===xe.a.None)return null;const a=c()({mx_Indicator:!0,mx_RightPanel_headerButton_unreadIndicator:!0,mx_Indicator_bold:t===xe.a.Bold,mx_Indicator_gray:t===xe.a.Grey,mx_Indicator_red:t===xe.a.Red});return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_RightPanel_headerButton_unreadIndicator_bg"}),o.a.createElement("div",{className:a}))},Bl=e=>{let{room:t,isHighlighted:a,onClick:n}=e;const i=ui(t),s=gi(t);if(null==i||!i.length)return null;let r;return i.some((e=>!s.has(e)))&&(r=o.a.createElement(Fl,null)),o.a.createElement(Dl,{name:"pinnedMessagesButton",title:Object(N.b)("Pinned messages"),isHighlighted:a,isUnread:!!r,onClick:n},r)},Vl=e=>{let t,{room:a,isHighlighted:n,onClick:i}=e;const s=Ae.a.instance.getRoomState(a).color;switch(s){case xe.a.Bold:case xe.a.Grey:case xe.a.Red:t=o.a.createElement(Fl,{color:s})}return o.a.createElement(Dl,{name:"timelineCardButton",title:Object(N.b)("Chat"),isHighlighted:n,onClick:i},t)};class Wl extends Al{constructor(e){super(e,Ml.Room),i()(this,"globalNotificationState",void 0),i()(this,"onNotificationUpdate",(()=>{this.setState({threadNotificationColor:this.notificationColor})})),i()(this,"onUpdateStatus",(e=>{this.globalNotificationState=e,this.setState({globalNotificationColor:e.color})})),i()(this,"onRoomSummaryClicked",(()=>{const e=Fa.a.instance.currentCard.phase;e&&Ll.includes(e)?this.state.phase===e?this.setPhase(e):this.setPhase(e,Fa.a.instance.currentCard.state):this.setPhase(La.a.RoomSummary)})),i()(this,"onNotificationsClicked",(()=>{this.setPhase(La.a.NotificationPanel)})),i()(this,"onPinnedMessagesClicked",(()=>{this.setPhase(La.a.PinnedMessages)})),i()(this,"onTimelineCardClicked",(()=>{this.setPhase(La.a.Timeline)})),i()(this,"onThreadsPanelClicked",(e=>{var t,a;this.state.phase&&Wl.THREAD_PHASES.includes(this.state.phase)?Fa.a.instance.togglePanel(null!==(t=null===(a=this.props.room)||void 0===a?void 0:a.roomId)&&void 0!==t?t:null):(Fa.a.instance.setCard({phase:La.a.ThreadPanel}),re.b.trackInteraction("WebRoomHeaderButtonsThreadsButton",e))})),this.globalNotificationState=Ae.a.instance.globalState}componentDidMount(){var e,t,a,n,i,s,o,r;super.componentDidMount(),null===(e=this.props.room)||void 0===e||e.on(te.d.UnreadNotifications,this.onNotificationUpdate),null===(t=this.props.room)||void 0===t||t.on(te.d.Receipt,this.onNotificationUpdate),null===(a=this.props.room)||void 0===a||a.on(te.d.Timeline,this.onNotificationUpdate),null===(n=this.props.room)||void 0===n||n.on(te.d.Redaction,this.onNotificationUpdate),null===(i=this.props.room)||void 0===i||i.on(te.d.LocalEchoUpdated,this.onNotificationUpdate),null===(s=this.props.room)||void 0===s||s.on(te.d.MyMembership,this.onNotificationUpdate),null===(o=this.props.room)||void 0===o||o.on(Ra.f.New,this.onNotificationUpdate),null===(r=this.props.room)||void 0===r||r.on(Ra.f.Update,this.onNotificationUpdate),this.onNotificationUpdate(),Ae.a.instance.on(Ae.b,this.onUpdateStatus)}componentWillUnmount(){var e,t,a,n,i,s,o,r;super.componentWillUnmount(),null===(e=this.props.room)||void 0===e||e.off(te.d.UnreadNotifications,this.onNotificationUpdate),null===(t=this.props.room)||void 0===t||t.off(te.d.Receipt,this.onNotificationUpdate),null===(a=this.props.room)||void 0===a||a.off(te.d.Timeline,this.onNotificationUpdate),null===(n=this.props.room)||void 0===n||n.off(te.d.Redaction,this.onNotificationUpdate),null===(i=this.props.room)||void 0===i||i.off(te.d.LocalEchoUpdated,this.onNotificationUpdate),null===(s=this.props.room)||void 0===s||s.off(te.d.MyMembership,this.onNotificationUpdate),null===(o=this.props.room)||void 0===o||o.off(Ra.f.New,this.onNotificationUpdate),null===(r=this.props.room)||void 0===r||r.off(Ra.f.Update,this.onNotificationUpdate),Ae.a.instance.off(Ae.b,this.onUpdateStatus)}get notificationColor(){var e;switch(null===(e=this.props.room)||void 0===e?void 0:e.threadsAggregateNotificationType){case te.b.Highlight:return xe.a.Red;case te.b.Total:return xe.a.Grey}for(const e of this.props.room.getThreads())if(Object(Ul.b)(e))return xe.a.Bold;return xe.a.None}onAction(e){e.action===L.a.ViewUser?e.member?e.push?Fa.a.instance.pushCard({phase:La.a.RoomMemberInfo,state:{member:e.member}}):Fa.a.instance.setCards([{phase:La.a.RoomSummary},{phase:La.a.RoomMemberList},{phase:La.a.RoomMemberInfo,state:{member:e.member}}]):this.setPhase(La.a.RoomMemberList):"view_3pid_invite"===e.action&&(e.event?this.setPhase(La.a.Room3pidMemberInfo,{memberInfoEvent:e.event}):this.setPhase(La.a.RoomMemberList))}renderButtons(){if(!this.props.room)return o.a.createElement(o.a.Fragment,null);const e=new Map;return v.b.getValue("feature_pinning")&&e.set(La.a.PinnedMessages,o.a.createElement(Bl,{key:"pinnedMessagesButton",room:this.props.room,isHighlighted:this.isPhase(La.a.PinnedMessages),onClick:this.onPinnedMessagesClicked})),e.set(La.a.Timeline,o.a.createElement(Vl,{key:"timelineButton",room:this.props.room,isHighlighted:this.isPhase(La.a.Timeline),onClick:this.onTimelineCardClicked})),e.set(La.a.ThreadPanel,o.a.createElement(Dl,{key:La.a.ThreadPanel,name:"threadsButton","data-testid":"threadsButton",title:Object(N.b)("Threads"),onClick:this.onThreadsPanelClicked,isHighlighted:this.isPhase(Wl.THREAD_PHASES),isUnread:this.state.threadNotificationColor>0},o.a.createElement(Fl,{color:this.state.threadNotificationColor}))),e.set(La.a.NotificationPanel,o.a.createElement(Dl,{key:"notifsButton",name:"notifsButton",title:Object(N.b)("Notifications"),isHighlighted:this.isPhase(La.a.NotificationPanel),onClick:this.onNotificationsClicked,isUnread:this.globalNotificationState.color===xe.a.Red},this.globalNotificationState.color===xe.a.Red?o.a.createElement(Fl,{color:this.globalNotificationState.color}):null)),e.set(La.a.RoomSummary,o.a.createElement(Dl,{key:"roomSummaryButton",name:"roomSummaryButton",title:Object(N.b)("Room info"),isHighlighted:this.isPhase(Ll),onClick:this.onRoomSummaryClicked})),o.a.createElement(o.a.Fragment,null,Array.from(e.keys()).map((t=>{var a;return null!==(a=this.props.excludedRightPanelPhaseButtons)&&void 0!==a&&a.includes(t)?null:e.get(t)})))}}i()(Wl,"THREAD_PHASES",[La.a.ThreadPanel,La.a.ThreadView]);var zl=a(1022),Hl=a(511),Kl=a(266),Gl=a(424);const ql=["room","onFinished"];var $l=e=>{var t;let{room:a,onFinished:n}=e,i=ve()(e,ql);const r=Object(s.useContext)(R.a),l=Object(ie.b)(la.c.instance,la.b,(()=>la.c.instance.getTagsForRoom(a)));let c;if(l.includes(T.a.Archived)){const e=e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"forget_room",room_id:a.roomId}),n()};c=o.a.createElement(he.b,{iconClassName:"mx_RoomTile_iconSignOut",label:Object(N.b)("Forget"),className:"mx_IconizedContextMenu_option_red",onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"leave_room",room_id:a.roomId}),n(),re.b.trackInteraction("WebRoomHeaderContextMenuLeaveItem",e)};c=o.a.createElement(he.b,{onClick:e,label:Object(N.b)("Leave"),className:"mx_IconizedContextMenu_option_red",iconClassName:"mx_RoomTile_iconSignOut"})}const d=Xa.a.shared().getUserIdForRoomId(a.roomId),m=Object(se.a)("feature_video_rooms"),h=Object(se.a)("feature_element_call_video_rooms"),u=m&&(a.isElementVideoRoom()||h&&a.isCallRoom());let p,g,f,E,y,_,S;if(a.canInvite(r.getUserId())&&!d&&Object(ae.a)(le.a.InviteUsers)){const e=e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"view_invite",roomId:a.roomId}),n(),re.b.trackInteraction("WebRoomHeaderContextMenuInviteItem",e)};p=o.a.createElement(he.b,{onClick:e,label:Object(N.b)("Invite"),iconClassName:"mx_RoomTile_iconInvite"})}if("join"===a.getMyMembership()){const e=l.includes(T.a.Favourite);g=o.a.createElement(he.a,{onClick:e=>{k(e,T.a.Favourite),re.b.trackInteraction("WebRoomHeaderContextMenuFavouriteToggle",e)},active:e,label:e?Object(N.b)("Favourited"):Object(N.b)("Favourite"),iconClassName:"mx_RoomTile_iconStar"});const t=l.includes(T.a.LowPriority);f=o.a.createElement(he.a,{onClick:e=>k(e,T.a.LowPriority),active:t,label:Object(N.b)("Low priority"),iconClassName:"mx_RoomTile_iconArrowDown"});let i,s;switch(Hl.a.forRoom(a).notificationVolume){case Kl.a.AllMessages:i=Object(N.b)("Default"),s="mx_RoomTile_iconNotificationsDefault";break;case Kl.a.AllMessagesLoud:i=Object(N.b)("All messages"),s="mx_RoomTile_iconNotificationsAllMessages";break;case Kl.a.MentionsOnly:i=Object(N.b)("Mentions only"),s="mx_RoomTile_iconNotificationsMentionsKeywords";break;case Kl.a.Mute:i=Object(N.b)("Mute"),s="mx_RoomTile_iconNotificationsNone"}E=o.a.createElement(he.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"open_room_settings",room_id:a.roomId,initial_tab_id:Gl.a}),n(),re.b.trackInteraction("WebRoomHeaderContextMenuNotificationsItem",e)},label:Object(N.b)("Notifications"),iconClassName:s},o.a.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},i))}d||(y=o.a.createElement(he.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),I(e),Fa.a.instance.pushCard({phase:La.a.RoomMemberList},!1),n(),re.b.trackInteraction("WebRoomHeaderContextMenuPeopleItem",e)},label:Object(N.b)("People"),iconClassName:"mx_RoomTile_iconPeople"},o.a.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},a.getJoinedMemberCount())),_=o.a.createElement(he.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"copy_room",room_id:a.roomId}),n()},label:Object(N.b)("Copy room link"),iconClassName:"mx_RoomTile_iconCopyLink"})),u||(S=o.a.createElement(he.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),I(e),Fa.a.instance.pushCard({phase:La.a.FilePanel},!1),n()},label:Object(N.b)("Files"),iconClassName:"mx_RoomTile_iconFiles"}));const w=Object(se.a)("feature_pinning"),O=null===(t=ui(w?a:void 0))||void 0===t?void 0:t.length;let C,x,j;w&&!u&&(C=o.a.createElement(he.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),I(e),Fa.a.instance.pushCard({phase:La.a.PinnedMessages},!1),n()},label:Object(N.b)("Pinned"),iconClassName:"mx_RoomTile_iconPins"},O>0&&o.a.createElement("span",{className:"mx_IconizedContextMenu_sublabel"},O))),u||(x=o.a.createElement(he.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),I(e),Fa.a.instance.setCard({phase:La.a.RoomSummary},!1),n()},label:Object(N.b)("Widgets"),iconClassName:"mx_RoomTile_iconWidgets"})),u||(j=o.a.createElement(he.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),z.b.createDialog(Ri,{room:a}),n()},label:Object(N.b)("Export chat"),iconClassName:"mx_RoomTile_iconExport"}));const k=(e,t)=>{if(e.preventDefault(),e.stopPropagation(),t===T.a.Favourite||t===T.a.LowPriority){const e=t===T.a.Favourite?T.a.LowPriority:T.a.Favourite,n=la.c.instance.getTagsForRoom(a).includes(t),i=n?t:e,s=n?null:t;b.a.dispatch(zl.a.tagRoom(r,a,i,s,void 0,0))}else Oa.a.warn(`Unexpected tag ${t} applied to ${a.roomId}`);if(Object(J.a)().getAccessibilityAction(e)===W.h.Enter)n()},I=e=>{at.b.instance.roomViewStore.getRoomId()!==a.roomId&&b.a.dispatch({action:L.a.ViewRoom,room_id:a.roomId,metricsTrigger:"RoomList",metricsViaKeyboard:"click"!==e.type},!0)};return o.a.createElement(he.e,Z()({},i,{onFinished:n,className:"mx_RoomTile_contextMenu",compact:!0}),o.a.createElement(he.c,null,p,E,g,y,S,C,x,f,_,o.a.createElement(he.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),b.a.dispatch({action:"open_room_settings",room_id:a.roomId}),n(),re.b.trackInteraction("WebRoomHeaderContextMenuSettingsItem",e)},label:Object(N.b)("Settings"),iconClassName:"mx_RoomTile_iconSettings"}),j,v.b.getValue("developerMode")&&o.a.createElement(he.b,{onClick:e=>{e.preventDefault(),e.stopPropagation(),z.b.createDialog(tt.a,{roomId:a.roomId},"mx_DevtoolsDialog_wrapper"),n()},label:Object(N.b)("Developer tools"),iconClassName:"mx_RoomTile_iconDeveloperTools"}),c))},Yl=a(476),Jl=a(265),Ql=a(355),Xl=a(274),Zl=a(356),ec=a(924),tc=a(923);const ac=e=>{let{liveBeaconIds:t,roomId:a}=e;const{onStopSharing:n,onResetLocationPublishError:i,beacon:s,stoppingInProgress:r,hasStopSharingError:l,hasLocationPublishError:c}=Object(Xl.k)(t);if(!s)return null;const d=l||c,m=e=>t=>{null==t||t.stopPropagation(),e()};return o.a.createElement("div",{className:"mx_RoomLiveShareWarning",onClick:()=>{b.a.dispatch({action:L.a.ViewRoom,room_id:s.roomId,metricsTrigger:void 0,event_id:s.beaconInfoId,scroll_into_view:!0,highlighted:!0})}},o.a.createElement(Zl.a,{className:"mx_RoomLiveShareWarning_icon",withError:d}),o.a.createElement("span",{className:"mx_RoomLiveShareWarning_label"},((e,t)=>e?Object(N.b)("An error occurred whilst sharing your live location, please try again"):t?Object(N.b)("An error occurred while stopping your live location, please try again"):Object(N.b)("You are sharing your live location"))(c,l)),r&&o.a.createElement("span",{className:"mx_RoomLiveShareWarning_spinner"},o.a.createElement(Zn.a,{h:16,w:16})),!r&&!d&&o.a.createElement(tc.a,{beacon:s}),o.a.createElement(K.a,{className:"mx_RoomLiveShareWarning_stopButton","data-testid":"room-live-share-primary-button",onClick:m((()=>{c?i():n()})),kind:"danger",element:"button",disabled:r},d?Object(N.b)("Retry"):Object(N.b)("Stop")),c&&o.a.createElement(K.a,{"data-testid":"room-live-share-wire-error-close-button",title:Object(N.b)("Stop and close"),element:"button",className:"mx_RoomLiveShareWarning_closeButton",onClick:m(n)},o.a.createElement(ec.a,{className:"mx_RoomLiveShareWarning_closeButtonIcon"})))};var nc=e=>{let{roomId:t}=e;const a=Object(ie.b)(Ql.a.instance,Ql.b.MonitoringLivePosition,(()=>Ql.a.instance.isMonitoringLiveLocation)),n=Object(ie.b)(Ql.a.instance,Ql.b.LivenessChange,(()=>Ql.a.instance.getLiveBeaconIds(t)));return a&&n.length?o.a.createElement(ac,{liveBeaconIds:n,roomId:t}):null};const ic=e=>e.isElementVideoRoom()||v.b.getValue("feature_element_call_video_rooms")&&e.isCallRoom();var sc=a(288),oc=a(901),rc=a(206),lc=a(657);const cc=e=>{let{roomId:t,call:a}=e;const n=Object(s.useCallback)((e=>{e.preventDefault(),b.b.dispatch({action:L.a.ViewRoom,room_id:t,view_call:!0,metricsTrigger:void 0})}),[t]),i=Object(s.useCallback)((()=>{const e=a.groupCall.room.currentState.getStateEvents(ee.b.GroupCallPrefix,a.groupCall.groupCallId);null!==e?b.a.dispatch({action:L.a.ViewRoom,room_id:t,metricsTrigger:void 0,event_id:e.getId(),scroll_into_view:!0,highlighted:!0}):Oa.a.error("Couldn't find a group call event to jump to")}),[a,t]);return o.a.createElement("div",{className:"mx_RoomCallBanner",onClick:i},o.a.createElement("div",{className:"mx_RoomCallBanner_text"},o.a.createElement("span",{className:"mx_RoomCallBanner_label"},Object(N.b)("Video call")),o.a.createElement(lc.b,{groupCall:a.groupCall})),o.a.createElement(K.a,{onClick:n,kind:"primary",element:"button",disabled:!1},Object(N.b)("Join")))};var dc=e=>{let{roomId:t}=e;const a=Object(sc.a)(t),n=Object(ie.b)(Ql.a.instance,Ql.b.MonitoringLivePosition,(()=>Ql.a.instance.isMonitoringLiveLocation)),i=Object(ie.b)(Ql.a.instance,Ql.b.LivenessChange,(()=>Ql.a.instance.getLiveBeaconIds(t)));return n&&i.length||at.b.instance.roomViewStore.isViewingCall()?null:null!==a&&a.connectionState===rc.c.Disconnected?o.a.createElement(cc,{call:a,roomId:t}):null};class mc{constructor(e){this.reason=e}}const hc=e=>{let{room:t,busy:a,setBusy:n,behavior:i}=e;const{onClick:r,tooltip:l,disabled:c}=Object(s.useMemo)((()=>i instanceof mc?{onClick:()=>{},tooltip:i.reason,disabled:!0}:{onClick:async e=>{e.preventDefault(),n(!0),await B.b.instance.placeCall(t.roomId,Sa.g.Voice),n(!1)},disabled:!1}),[i,t,n]);return o.a.createElement(q.a,{className:"mx_RoomHeader_button mx_RoomHeader_voiceCallButton",onClick:r,title:Object(N.b)("Voice call"),tooltip:null!=l?l:Object(N.b)("Voice call"),alignment:Ao.a.Bottom,disabled:c||a})},uc=e=>{let{room:t,busy:a,setBusy:n,behavior:i}=e;const[r,l,c,d]=Object(de.q)(),m=Object(s.useCallback)((async()=>{n(!0),await B.b.instance.placeCall(t.roomId,Sa.g.Video),n(!1)}),[n,t]),h=Object(s.useCallback)((()=>{n(!0),b.a.dispatch({action:L.a.ViewRoom,room_id:t.roomId,view_call:!0,metricsTrigger:void 0}),n(!1)}),[n,t]),{onClick:u,tooltip:p,disabled:g}=Object(s.useMemo)((()=>i instanceof mc?{onClick:()=>{},tooltip:i.reason,disabled:!0}:"legacy_or_jitsi"===i?{onClick:async e=>{e.preventDefault(),await m()},disabled:!1}:"element"===i?{onClick:async e=>{e.preventDefault(),h()},disabled:!1}:{onClick:async e=>{e.preventDefault(),c()},disabled:!1}),[i,m,h,c]),v=Object(s.useCallback)((async e=>{e.preventDefault(),d(),await m()}),[d,m]),f=Object(s.useCallback)((e=>{e.preventDefault(),d(),h()}),[d,h]);let E=null;if(r){var y;const e=l.current.getBoundingClientRect(),t=null!==(y=ot.b.get("element_call").brand)&&void 0!==y?y:ot.a.element_call.brand;E=o.a.createElement(he.e,Z()({},Object(de.i)(e),{onFinished:d}),o.a.createElement(he.c,null,o.a.createElement(he.b,{label:Object(N.b)("Video call (Jitsi)"),onClick:v}),o.a.createElement(he.b,{label:Object(N.b)("Video call (%(brand)s)",{brand:t}),onClick:f})))}return o.a.createElement(o.a.Fragment,null,o.a.createElement(q.a,{inputRef:l,className:"mx_RoomHeader_button mx_RoomHeader_videoCallButton",onClick:u,title:Object(N.b)("Video call"),tooltip:null!=p?p:Object(N.b)("Video call"),alignment:Ao.a.Bottom,disabled:g||a}),E)},pc=e=>{let{room:t}=e;const[a,n]=Object(s.useState)(!1),i=Object(se.b)("showCallButtonsInComposer"),r=Object(se.a)("feature_group_calls"),l=Object(se.a)("feature_video_rooms"),c=Object(s.useMemo)((()=>l&&ic(t)),[l,t]),d=Object(s.useMemo)((()=>{var e;return null!==(e=ot.b.get("element_call").use_exclusively)&&void 0!==e?e:ot.a.element_call.use_exclusively}),[]),h=Object(ie.b)(B.b.instance,B.a.CallsChanged,Object(s.useCallback)((()=>null!==B.b.instance.getCallForRoom(t.roomId)),[t])),u=Di(t),p=Object(s.useMemo)((()=>u.some((e=>on.a.JITSI.matches(e.type)))),[u]),g=null!==Object(sc.a)(t.roomId),[b,v,f]=Object(ie.d)(t,m.b.Update,Object(s.useCallback)((()=>[Object(oc.a)(t),t.currentState.mayClientSendStateEvent("im.vector.modular.widgets",t.client),t.currentState.mayClientSendStateEvent(rc.d.CALL_EVENT_TYPE.name,t.client)]),[t])),E=e=>o.a.createElement(hc,{room:t,busy:a,setBusy:n,behavior:e}),y=e=>o.a.createElement(uc,{room:t,busy:a,setBusy:n,behavior:e});if(c||!i)return null;if(r){if(d)return y(g?new mc(Object(N.b)("Ongoing call")):f?"element":new mc(Object(N.b)("You do not have permission to start video calls")));if(h||p||g)return o.a.createElement(o.a.Fragment,null,E(new mc(Object(N.b)("Ongoing call"))),y(new mc(Object(N.b)("Ongoing call"))));if(b.length<=1)return o.a.createElement(o.a.Fragment,null,E(new mc(Object(N.b)("There's no one here to call"))),y(new mc(Object(N.b)("There's no one here to call"))));if(2===b.length)return o.a.createElement(o.a.Fragment,null,E("legacy_or_jitsi"),y("legacy_or_jitsi"));if(v)return o.a.createElement(o.a.Fragment,null,E("legacy_or_jitsi"),y(f?"jitsi_or_element":"legacy_or_jitsi"));{const e=f?"element":new mc(Object(N.b)("You do not have permission to start video calls"));return o.a.createElement(o.a.Fragment,null,E(new mc(Object(N.b)("You do not have permission to start voice calls"))),y(e))}}return h||p?o.a.createElement(o.a.Fragment,null,E(new mc(Object(N.b)("Ongoing call"))),y(new mc(Object(N.b)("Ongoing call")))):b.length<=1?o.a.createElement(o.a.Fragment,null,E(new mc(Object(N.b)("There's no one here to call"))),y(new mc(Object(N.b)("There's no one here to call")))):2===b.length||v?o.a.createElement(o.a.Fragment,null,E("legacy_or_jitsi"),y("legacy_or_jitsi")):o.a.createElement(o.a.Fragment,null,E(new mc(Object(N.b)("You do not have permission to start voice calls"))),y(new mc(Object(N.b)("You do not have permission to start video calls"))))},gc=e=>{let{call:t}=e;const a=Object(sc.e)(t),[n,i,r,l]=Object(de.q)(),d=Object(s.useCallback)((e=>{e.preventDefault(),r()}),[r]),m=Object(s.useCallback)((e=>{e.preventDefault(),l(),t.setLayout(rc.f.Tile)}),[l,t]),h=Object(s.useCallback)((e=>{e.preventDefault(),l(),t.setLayout(rc.f.Spotlight)}),[l,t]);let u=null;if(n){const e=i.current.getBoundingClientRect();u=o.a.createElement(he.e,Z()({className:"mx_RoomHeader_layoutMenu"},Object(de.i)(e),{onFinished:l}),o.a.createElement(he.c,null,o.a.createElement(he.d,{iconClassName:"mx_RoomHeader_freedomIcon",label:Object(N.b)("Freedom"),active:a===rc.f.Tile,onClick:m}),o.a.createElement(he.d,{iconClassName:"mx_RoomHeader_spotlightIcon",label:Object(N.b)("Spotlight"),active:a===rc.f.Spotlight,onClick:h})))}return o.a.createElement(o.a.Fragment,null,o.a.createElement(q.a,{inputRef:i,className:c()("mx_RoomHeader_button",{"mx_RoomHeader_layoutButton--freedom":a===rc.f.Tile,"mx_RoomHeader_layoutButton--spotlight":a===rc.f.Spotlight}),onClick:d,title:Object(N.b)("Change layout"),alignment:Ao.a.Bottom,key:"layout"}),u)};class bc extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"client",this.props.room.client),i()(this,"onRightPanelStoreUpdate",(()=>{this.setState({rightPanelOpen:Fa.a.instance.isOpen})})),i()(this,"onRoomStateEvents",(e=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&this.rateLimitedUpdate()})),i()(this,"onNotificationUpdate",(()=>{this.forceUpdate()})),i()(this,"rateLimitedUpdate",Object(j.throttle)((()=>{this.forceUpdate()}),500,{leading:!0,trailing:!0})),i()(this,"onContextMenuOpenClick",(e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})})),i()(this,"onContextMenuCloseClick",(()=>{this.setState({contextMenuPosition:void 0})})),i()(this,"onHideCallClick",(e=>{e.preventDefault(),b.a.dispatch({action:L.a.ViewRoom,room_id:this.props.room.roomId,view_call:!1,metricsTrigger:void 0})}));Ae.a.instance.getRoomState(e.room).on(Jl.b.Update,this.onNotificationUpdate),this.state={rightPanelOpen:Fa.a.instance.isOpen}}componentDidMount(){this.client.on(m.b.Events,this.onRoomStateEvents),Fa.a.instance.on(Et.b,this.onRightPanelStoreUpdate)}componentWillUnmount(){this.client.removeListener(m.b.Events,this.onRoomStateEvents);Ae.a.instance.getRoomState(this.props.room).removeListener(Jl.b.Update,this.onNotificationUpdate),Fa.a.instance.off(Et.b,this.onRightPanelStoreUpdate)}renderButtons(e){const t=[];this.props.viewingCall||!this.props.inRoom||this.context.tombstone||t.push(o.a.createElement(pc,{key:"calls",room:this.props.room})),this.props.viewingCall&&this.props.activeCall instanceof rc.d&&t.push(o.a.createElement(gc,{key:"layout",call:this.props.activeCall})),!this.props.viewingCall&&this.props.onForgetClick&&t.push(o.a.createElement(q.a,{className:"mx_RoomHeader_button mx_RoomHeader_forgetButton",onClick:this.props.onForgetClick,title:Object(N.b)("Forget room"),alignment:Ao.a.Bottom,key:"forget"})),!this.props.viewingCall&&this.props.onAppsClick&&t.push(o.a.createElement(q.a,{className:c()("mx_RoomHeader_button mx_RoomHeader_appsButton",{mx_RoomHeader_appsButton_highlight:this.props.appsShown}),onClick:this.props.onAppsClick,title:this.props.appsShown?Object(N.b)("Hide Widgets"):Object(N.b)("Show Widgets"),alignment:Ao.a.Bottom,key:"apps"})),!this.props.viewingCall&&this.props.onSearchClick&&this.props.inRoom&&t.push(o.a.createElement(q.a,{className:"mx_RoomHeader_button mx_RoomHeader_searchButton",onClick:this.props.onSearchClick,title:Object(N.b)("Search"),alignment:Ao.a.Bottom,key:"search"})),this.props.onInviteClick&&(!this.props.viewingCall||e)&&this.props.inRoom&&t.push(o.a.createElement(q.a,{className:"mx_RoomHeader_button mx_RoomHeader_inviteButton",onClick:this.props.onInviteClick,title:Object(N.b)("Invite"),alignment:Ao.a.Bottom,key:"invite"}));const a=[];return this.props.viewingCall&&!e&&(null===this.props.activeCall?a.push(o.a.createElement(K.a,{className:"mx_RoomHeader_button mx_RoomHeader_closeButton",onClick:this.onHideCallClick,title:Object(N.b)("Close call"),key:"close"})):a.push(o.a.createElement(q.a,{className:"mx_RoomHeader_button mx_RoomHeader_minimiseButton",onClick:this.onHideCallClick,title:Object(N.b)("View chat timeline"),alignment:Ao.a.Bottom,key:"minimise"}))),o.a.createElement(o.a.Fragment,null,t,o.a.createElement(Wl,{room:this.props.room,excludedRightPanelPhaseButtons:this.props.excludedRightPanelPhaseButtons}),a)}renderName(e){let t=null;this.state.contextMenuPosition&&this.props.room&&(t=o.a.createElement($l,Z()({},Object(Yl.a)(this.state.contextMenuPosition),{room:this.props.room,onFinished:this.onContextMenuCloseClick})));let a=!1;const n=this.props.room?this.props.room.getJoinedMembers():void 0;if(n&&1===n.length&&n[0].userId===this.client.credentials.userId){const e=this.props.room.currentState.getStateEvents("m.room.name","");e&&e.getContent().name||(a=!0)}const i=c()("mx_RoomHeader_nametext",{mx_RoomHeader_settingsHint:a}),s=o.a.createElement(vi.a,{room:this.props.room},(t=>{const a=t||e;return o.a.createElement("div",{dir:"auto",className:i,title:a,role:"heading","aria-level":1},a)}));return this.props.enableRoomOptionsMenu?o.a.createElement(de.c,{className:"mx_RoomHeader_name",onClick:this.onContextMenuOpenClick,isExpanded:!!this.state.contextMenuPosition,title:Object(N.b)("Room options"),alignment:Ao.a.Bottom},s,this.props.room&&o.a.createElement("div",{className:"mx_RoomHeader_chevron"}),t):o.a.createElement("div",{className:"mx_RoomHeader_name mx_RoomHeader_name--textonly"},s)}render(){var e;const t=v.b.getValue("feature_video_rooms")&&ic(this.props.room);let a=null;this.props.room&&(a=o.a.createElement(oa.a,{room:this.props.room,avatarSize:24,oobData:this.props.oobData,viewAvatarOnClick:!0}));const n=this.props.viewingCall?o.a.createElement("div",{className:"mx_RoomHeader_icon mx_RoomHeader_icon_video"}):this.props.e2eStatus?o.a.createElement(ss.b,{className:"mx_RoomHeader_icon",status:this.props.e2eStatus,tooltipAlignment:Ao.a.Bottom}):this.client.isRoomEncrypted(this.props.room.roomId)&&this.client.isCryptoEnabled()?o.a.createElement("div",{className:"mx_RoomHeader_icon"}):null,i=this.props.showButtons?this.renderButtons(t):null;let s=Object(N.b)("Join Room");this.props.oobData&&this.props.oobData.name&&(s=this.props.oobData.name);const r=this.renderName(s);if(this.props.viewingCall&&!t)return o.a.createElement("header",{className:"mx_RoomHeader light-panel"},o.a.createElement("div",{className:"mx_RoomHeader_wrapper","aria-owns":this.state.rightPanelOpen?"mx_RightPanel":void 0},o.a.createElement("div",{className:"mx_RoomHeader_avatar"},a),n,r,this.props.activeCall instanceof rc.d&&o.a.createElement(lc.b,{groupCall:this.props.activeCall.groupCall}),o.a.createElement("div",{className:"mx_RoomHeader_topic"}),i));let l=null;"number"==typeof(null===(e=this.props.searchInfo)||void 0===e?void 0:e.count)&&(l=o.a.createElement("div",{className:"mx_RoomHeader_searchStatus"}," ",Object(N.b)("(~%(count)s results)",{count:this.props.searchInfo.count})));const c=o.a.createElement(Dr,{room:this.props.room,className:"mx_RoomHeader_topic"}),d=t?o.a.createElement(me.a,{onClick:()=>b.a.dispatch({action:L.a.ViewUserSettings,initialTabId:Fe.a.Labs}),tooltipTitle:Object(N.b)("Video rooms are a beta feature")}):null;return o.a.createElement("header",{className:"mx_RoomHeader light-panel"},o.a.createElement("div",{className:"mx_RoomHeader_wrapper","aria-owns":this.state.rightPanelOpen?"mx_RightPanel":void 0},o.a.createElement("div",{className:"mx_RoomHeader_avatar"},a),n,r,l,c,d,i),!t&&o.a.createElement(dc,{roomId:this.props.room.roomId}),o.a.createElement(nc,{roomId:this.props.room.roomId}))}}i()(bc,"defaultProps",{inRoom:!1,excludedRightPanelPhaseButtons:[],showButtons:!0,enableRoomOptionsMenu:!0}),i()(bc,"contextType",en.b);var vc=e=>{let{roomWidth:t}=e;const n=Object(s.useRef)(null),i=Object(s.useRef)(new Map);return Object(s.useEffect)((()=>{const e=()=>{var e;n.current&&(null===(e=n.current)||void 0===e?void 0:e.height)!==Q.b.instance.windowHeight&&(n.current.height=Q.b.instance.windowHeight)},t=b.a.register((e=>{const t="effects.";if(n.current&&e.action.startsWith(t)){(async e=>{if(!e)return null;let t=i.current.get(e)||null;if(null===t){var n;const s=null===(n=xn.CHAT_EFFECTS.find((t=>t.command===e)))||void 0===n?void 0:n.options;try{const{default:n}=await a(1711)(`./${e}`);t=new n(s),i.current.set(e,t)}catch(t){Oa.a.warn(`Unable to load effect module at '../../../effects/${e}.`,t)}}return t})(e.action.slice(t.length)).then((e=>null==e?void 0:e.start(n.current)))}})),s=n.current;return s&&(s.height=Q.b.instance.windowHeight),Q.b.instance.on(Q.a.Resize,e),()=>{b.a.unregister(t),Q.b.instance.off(Q.a.Resize,e);const a=i.current;for(const e in a){const t=a.get(e);t&&t.isRunning&&t.stop()}}}),[]),o.a.createElement("canvas",{ref:n,width:t,style:{display:"block",zIndex:999999,pointerEvents:"none",position:"fixed",top:0,right:0},"aria-hidden":!0})},fc=a(319);const Ec=e=>{let{kind:t,devices:a,setDevice:n,deviceListLabel:i,muted:r,disabled:l,toggle:d,unmutedTitle:m,mutedTitle:h}=e;const[u,p,g,b]=Object(de.q)(),v=Object(s.useCallback)((e=>{n(e),b()}),[n,b]);let f=null;if(u){const e=p.current.getBoundingClientRect();f=o.a.createElement(he.e,Z()({},Object(de.j)(e,void 0,10),{onFinished:b}),o.a.createElement(he.c,null,a.map((e=>o.a.createElement(he.b,{key:e.deviceId,label:e.label,onClick:()=>v(e)})))))}return a.length?o.a.createElement("div",{className:c()("mx_CallView_deviceButtonWrapper",{mx_CallView_deviceButtonWrapper_muted:r})},o.a.createElement(q.a,{className:`mx_CallView_deviceButton mx_CallView_deviceButton_${t}`,inputRef:p,title:r?h:m,alignment:Ao.a.Top,onClick:d,disabled:l}),a.length>1?o.a.createElement(de.b,{className:"mx_CallView_deviceListButton",onClick:g,isExpanded:u,label:i,disabled:l}):null,f):null},yc=e=>{let{room:t,joinCallButtonDisabledTooltip:a,connect:n,children:i}=e;const[r,l]=Object(s.useState)(!1),c=Object(s.useMemo)((()=>t.getMember(t.myUserId)),[t]),d=Object(s.useRef)(null),[m,h]=Object(s.useState)((()=>p.c.getVideoInput())),[u,g]=Object(s.useState)((()=>p.c.startWithAudioMuted)),[b,v]=Object(s.useState)((()=>p.c.startWithVideoMuted)),f=Object(s.useCallback)((()=>{p.c.startWithAudioMuted=!u,g(!u)}),[u,g]),E=Object(s.useCallback)((()=>{p.c.startWithVideoMuted=!b,v(!b)}),[b,v]),[y,_,S]=Object(ai.a)((async()=>{var e,t,a,n;let i=await p.c.getDevices(),s=null;try{i.audioinput.length>0?s=await navigator.mediaDevices.getUserMedia({audio:!0,video:!b&&i.videoinput.length>0&&{deviceId:m}}):i.videoinput.length>0&&(s=await navigator.mediaDevices.getUserMedia({video:{deviceId:m}}))}catch(e){Oa.a.error(`Failed to get stream for device ${m}`,e)}var o;(null!==s&&(i=await p.c.getDevices()),b)&&(null===(o=s)||void 0===o||o.getTracks().forEach((e=>e.stop())),s=null);return[s,null!==(e=null===(t=i)||void 0===t?void 0:t.audioinput)&&void 0!==e?e:[],null!==(a=null===(n=i)||void 0===n?void 0:n.videoinput)&&void 0!==a?a:[]]}),[m,b],[null,[],[]]),w=Object(s.useCallback)((e=>{p.c.instance.setAudioInput(e.deviceId)}),[]),O=Object(s.useCallback)((e=>{p.c.instance.setVideoInput(e.deviceId),h(e.deviceId)}),[]);Object(s.useEffect)((()=>{if(y){const e=d.current;return e.srcObject=y,e.play(),()=>{y.getTracks().forEach((e=>e.stop())),e.srcObject=null}}}),[y]);const C=Object(s.useCallback)((async e=>{e.preventDefault(),l(!0);try{await n()}catch(e){Oa.a.error(e),l(!1)}}),[n,l]);return o.a.createElement("div",{className:"mx_CallView_lobby"},i,o.a.createElement("div",{className:"mx_CallView_preview"},o.a.createElement(ii.b,{key:c.userId,member:c,width:200,height:200,resizeMethod:"scale"}),o.a.createElement("video",{ref:d,style:{visibility:b?"hidden":void 0},muted:!0,playsInline:!0,disablePictureInPicture:!0}),o.a.createElement("div",{className:"mx_CallView_controls"},o.a.createElement(Ec,{kind:"audio",devices:_,setDevice:w,deviceListLabel:Object(N.b)("Audio devices"),muted:u,disabled:r,toggle:f,unmutedTitle:Object(N.b)("Mute microphone"),mutedTitle:Object(N.b)("Unmute microphone")}),o.a.createElement(Ec,{kind:"video",devices:S,setDevice:O,deviceListLabel:Object(N.b)("Video devices"),muted:b,disabled:r,toggle:E,unmutedTitle:Object(N.b)("Turn off camera"),mutedTitle:Object(N.b)("Turn on camera")}))),o.a.createElement(q.a,{className:"mx_CallView_connectButton",kind:"primary",disabled:r||void 0!==a,onClick:C,label:Object(N.b)("Join"),tooltip:r?Object(N.b)("Connecting"):a,alignment:Ao.a.Bottom}))},_c=e=>{let{room:t,resizing:a,call:n,setStartingCall:i}=e;const r=Object(s.useContext)(R.a),l=Object(s.useRef)();void 0===l.current&&(l.current=Object(En.m)());const c=l.current,[d,m]=Object(s.useState)((()=>null!==n&&Object(rc.g)(n.connectionState)));Object(s.useEffect)((()=>{if(null!==n){const e=e=>m(Object(rc.g)(e));return n.on(rc.b.ConnectionState,e),()=>{n.off(rc.b.ConnectionState,e)}}}),[n]);const h=Object(s.useCallback)((async()=>{i(!0),await rc.d.create(t),await c.promise}),[t,i,c]);return Object(s.useEffect)((()=>{(async()=>{if(null!==n)try{await Promise.all([...fc.a.instance.activeCalls].map((e=>e.disconnect()))),await n.connect(),c.resolve()}catch(e){c.reject(e)}})()}),[n,c]),o.a.createElement("div",{className:"mx_CallView"},d?null:o.a.createElement(yc,{room:t,connect:h}),null!==n&&o.a.createElement(Qi,{app:n.widget,room:t,userId:r.credentials.userId,creatorUserId:n.widget.creatorUserId,waitForIframeLoad:n.widget.waitForIframeLoad,showMenubar:!1,pointerEvents:a?"none":void 0}))},Sc=e=>{let{room:t,resizing:a,call:n}=e;const i=Object(s.useContext)(R.a),r=Object(rc.g)(Object(sc.c)(n)),l=Object(sc.g)(n),c=Object(sc.d)(n),d=Object(s.useCallback)((async()=>{await Promise.all([...fc.a.instance.activeCalls].map((e=>e.disconnect()))),await n.connect()}),[n]);Object(s.useEffect)((()=>{n.clean()}),[n]);let m=null;if(!r){let e=null;if(l.length){const t=l.slice(0,8),a=l.length>t.length;e=o.a.createElement("div",{className:"mx_CallView_participants"},Object(N.b)("%(count)s people joined",{count:l.length}),o.a.createElement(Mr.a,{members:t,faceSize:24,overflow:a}))}m=o.a.createElement(yc,{room:t,connect:d,joinCallButtonDisabledTooltip:null!=c?c:void 0},e)}return o.a.createElement("div",{className:"mx_CallView"},m,o.a.createElement(Qi,{app:n.widget,room:t,userId:i.credentials.userId,creatorUserId:n.widget.creatorUserId,waitForIframeLoad:n.widget.waitForIframeLoad,showMenubar:!1,pointerEvents:a?"none":void 0}))},wc=e=>{let{room:t,resizing:a,waitForCall:n}=e;const i=Object(sc.a)(t.roomId),[r,l]=Object(s.useState)(!1);return null===i||r?n?null:o.a.createElement(_c,{room:t,resizing:a,call:i,setStartingCall:l}):o.a.createElement(Sc,{room:t,resizing:a,call:i})};var Oc=a(281),Cc=a(661),xc=a(223),jc=a(337);const kc=(e,t)=>{const[a,n]=Object(s.useState)((()=>Array.isArray(t)?t:new Array(e).fill(t)));return[a,(e,t)=>n((a=>{const n=[...a];return n[e]=t,n}))]};var Rc=a(400),Ic=a(810),Tc=a(967),Nc=a(136),Pc=a(926),Dc=a(409);function Mc(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Ac(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Mc(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Mc(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const Uc=e=>{var t,a;let{room:n,suggested:i,selected:r,hasPermissions:l,onToggleClick:d,onViewRoomClick:m,onJoinRoomClick:h,numChildRooms:u,children:p}=e;const g=Object(s.useContext)(R.a),[b,v]=Object(s.useState)((()=>{const e=null==g?void 0:g.getRoom(n.room_id);return"join"===(null==e?void 0:e.getMyMembership())?e:void 0})),f=Object(ie.d)(b,te.d.Name,(e=>null==e?void 0:e.name)),E=f||n.name||n.canonical_alias||(null===(t=n.aliases)||void 0===t?void 0:t[0])||(n.room_type===ee.j.Space?Object(N.b)("Unnamed Space"):Object(N.b)("Unnamed Room")),[y,_]=Object(dt.a)(!0),[S,w,O]=Object(je.i)(),[C,x]=Object(s.useState)(!1),j=e=>{e.preventDefault(),e.stopPropagation(),m()},k=async e=>{x(!0),e.preventDefault(),e.stopPropagation(),h().then((()=>Object(Dc.a)(g,n.room_id))).then(v).finally((()=>{x(!1)}))};let I,T,P;I=C?o.a.createElement(q.a,{disabled:!0,onClick:k,kind:"primary_outline",onFocus:S,tabIndex:w?0:-1,title:Object(N.b)("Joining")},o.a.createElement(Zn.a,{w:24,h:24})):b?o.a.createElement(K.a,{onClick:j,kind:"primary_outline",onFocus:S,tabIndex:w?0:-1},Object(N.b)("View")):o.a.createElement(K.a,{onClick:k,kind:"primary",onFocus:S,tabIndex:w?0:-1},Object(N.b)("Join")),d&&(T=l?o.a.createElement(Ue.b,{checked:!!r,onChange:d,tabIndex:w?0:-1}):o.a.createElement(qa.a,{tooltip:Object(N.b)("You don't have permission"),onClick:e=>{e.stopPropagation()}},o.a.createElement(Ue.b,{disabled:!0,tabIndex:w?0:-1}))),P=b?o.a.createElement(ye.a,{room:b,width:20,height:20}):o.a.createElement(yt.a,{name:E,idName:n.room_id,url:n.avatar_url?Object($a.b)(n.avatar_url).getSquareThumbnailHttp(20):null,width:20,height:20});let D,M,A,U,L=Object(N.b)("%(count)s members",{count:null!==(a=n.num_joined_members)&&void 0!==a?a:0});if(void 0!==u&&(L+=" · "+Object(N.b)("%(count)s rooms",{count:u})),b){const e=Object(Nr.a)(b);D=Object(jr.i)(null==e?void 0:e.text,null==e?void 0:e.html)}else D=n.topic;D&&(M=o.a.createElement(jr.a,{options:{attributes:{onClick(e){e.stopPropagation()}}}}," · ",D)),b&&(A=o.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_joined"},Object(N.b)("Joined"))),!i||b&&!l||(U=o.a.createElement(Pc.b,{tooltip:Object(N.b)("This room is suggested as a good one to join")},Object(N.b)("Suggested")));const F=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_item"},o.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_avatar"},P),o.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_name"},E,A,U),o.a.createElement("div",{className:"mx_SpaceHierarchy_roomTile_info"},L,M)),o.a.createElement("div",{className:"mx_SpaceHierarchy_actions"},I,T));let B,V,z;if(p){if(B=o.a.createElement("div",{className:c()("mx_SpaceHierarchy_subspace_toggle",{mx_SpaceHierarchy_subspace_toggle_shown:y}),onClick:e=>{e.stopPropagation(),_()}}),y){const e=e=>{var t;if(Object(J.a)().getAccessibilityAction(e)===W.h.ArrowLeft)e.preventDefault(),e.stopPropagation(),null===(t=O.current)||void 0===t||t.focus()};V=o.a.createElement("div",{className:"mx_SpaceHierarchy_subspace_children",onKeyDown:e,role:"group"},p)}z=e=>{let t=!1;switch(Object(J.a)().getAccessibilityAction(e)){case W.h.ArrowLeft:y&&(t=!0,_());break;case W.h.ArrowRight:if(t=!0,y){var a,n;const e=null===(a=O.current)||void 0===a?void 0:a.nextElementSibling;null==e||null===(n=e.querySelector(".mx_SpaceHierarchy_roomTile"))||void 0===n||n.focus()}else _()}t&&(e.preventDefault(),e.stopPropagation())}}return o.a.createElement("li",{className:"mx_SpaceHierarchy_roomTileWrapper",role:"treeitem","aria-selected":r,"aria-expanded":p?y:void 0},o.a.createElement(K.a,{className:c()("mx_SpaceHierarchy_roomTile",{mx_SpaceHierarchy_subspace:n.room_type===ee.j.Space,mx_SpaceHierarchy_joining:C}),onClick:l&&d?d:j,onKeyDown:z,inputRef:O,onFocus:S,tabIndex:w?0:-1},F,B),V)},Lc=(e,t,a,n)=>{var i,s;const o=t.roomMap.get(a);if(e.isGuest()&&!(null!=o&&o.world_readable||null!=o&&o.guest_can_join))return void b.a.dispatch({action:"require_registration"});const r=Object(Da.b)(null!==(i=null==o?void 0:o.canonical_alias)&&void 0!==i?i:"",null!==(s=null==o?void 0:o.aliases)&&void 0!==s?s:[])||void 0;b.a.dispatch({action:L.a.ViewRoom,should_peek:!0,room_alias:r,room_id:a,via_servers:Array.from(t.viaMap.get(a)||[]),oob_data:{avatarUrl:null==o?void 0:o.avatar_url,name:(null==o?void 0:o.name)||r||Object(N.b)("Unnamed room"),roomType:n},metricsTrigger:"RoomDirectory"})},Fc=e=>{let{root:t,roomSet:a,hierarchy:n,parents:i,selectedMap:r,onViewRoomClick:l,onJoinRoomClick:c,onToggleClick:d}=e;const m=Object(s.useContext)(R.a),h=m.getRoom(t.room_id),u=null==h?void 0:h.currentState.maySendStateEvent(ee.b.SpaceChild,m.getSafeUserId()),p=Object(j.sortBy)(t.children_state,(e=>{var t;return Object($.b)(e.content.order,e.origin_server_ts,e.state_key,null===(t=m.getRoom(e.state_key))||void 0===t?void 0:t.name)})),[g,b]=p.reduce(((e,t)=>{const i=n.roomMap.get(t.state_key);return i&&a.has(i)&&e[i.room_type===ee.j.Space?0:1].push(((e,t,a)=>{const n=e.getRoomUpgradeHistory(t.room_id,!0,v.b.getValue("feature_dynamic_room_predecessors"));let i=null;for(let e=n.length-1;e>=0;--e)if(a.roomMap.get(n[e].roomId)){i=n[e];break}var s,o,r,l,c;return i?Ac(Ac({},t),{},{room_id:i.roomId,room_type:i.getType(),name:i.name,topic:null===(s=i.currentState.getStateEvents(ee.b.RoomTopic,""))||void 0===s?void 0:s.getContent().topic,avatar_url:null!==(o=i.getMxcAvatarUrl())&&void 0!==o?o:void 0,canonical_alias:null!==(r=i.getCanonicalAlias())&&void 0!==r?r:void 0,aliases:i.getAltAliases(),world_readable:(null===(l=i.currentState.getStateEvents(ee.b.RoomHistoryVisibility,""))||void 0===l?void 0:l.getContent().history_visibility)===Ia.b.WorldReadable,guest_can_join:(null===(c=i.currentState.getStateEvents(ee.b.RoomGuestAccess,""))||void 0===c?void 0:c.getContent().guest_access)===Ia.a.CanJoin,num_joined_members:i.getJoinedMemberCount()}):t})(m,i,n)),e}),[[],[]]),f=new Set(i).add(t.room_id);return o.a.createElement(o.a.Fragment,null,Object(j.uniqBy)(b,"room_id").map((e=>{var a;return o.a.createElement(Uc,{key:e.room_id,room:e,suggested:n.isSuggested(t.room_id,e.room_id),selected:null==r||null===(a=r.get(t.room_id))||void 0===a?void 0:a.has(e.room_id),onViewRoomClick:()=>l(e.room_id,e.room_type),onJoinRoomClick:()=>c(e.room_id),hasPermissions:u,onToggleClick:d?()=>d(t.room_id,e.room_id):void 0})})),g.filter((e=>!f.has(e.room_id))).map((e=>{var i;return o.a.createElement(Uc,{key:e.room_id,room:e,numChildRooms:e.children_state.filter((e=>{const t=n.roomMap.get(e.state_key);return t&&a.has(t)&&!t.room_type})).length,suggested:n.isSuggested(t.room_id,e.room_id),selected:null==r||null===(i=r.get(t.room_id))||void 0===i?void 0:i.has(e.room_id),onViewRoomClick:()=>l(e.room_id,ee.j.Space),onJoinRoomClick:()=>c(e.room_id),hasPermissions:u,onToggleClick:d?()=>d(t.room_id,e.room_id):void 0},o.a.createElement(Fc,{root:e,roomSet:a,hierarchy:n,parents:f,selectedMap:r,onViewRoomClick:l,onJoinRoomClick:c,onToggleClick:d}))})))},Bc=e=>{let{hierarchy:t,selected:a,setSelected:n,setError:i}=e;const r=Object(s.useContext)(R.a),[l,c]=Object(s.useState)(!1),[d,m]=Object(s.useState)(!1),h=Array.from(a.keys()).flatMap((e=>[...a.get(e).values()].map((t=>[e,t])))),u=h.every((e=>{let[a,n]=e;return t.isSuggested(a,n)})),p=!h.length||l||d;let g=K.a,b={};h.length||(g=q.a,b={tooltip:Object(N.b)("Select a room below first"),alignment:Ao.a.Top});let v=Object(N.b)("Saving…");return d||(v=u?Object(N.b)("Mark as not suggested"):Object(N.b)("Mark as suggested")),o.a.createElement(o.a.Fragment,null,o.a.createElement(g,Z()({},b,{onClick:async()=>{c(!0);try{const e=r.getSafeUserId();for(const[a,n]of h){await r.sendStateEvent(a,ee.b.SpaceChild,{},n);const i=r.getRoom(n),s=null==i?void 0:i.currentState.getStateEvents(ee.b.SpaceParent,a);null!=i&&i.currentState.maySendStateEvent(ee.b.SpaceParent,e)&&Array.isArray(null==s?void 0:s.getContent().via)&&await r.sendStateEvent(n,ee.b.SpaceParent,{},a),t.removeRelation(a,n)}}catch(e){i(Object(N.b)("Failed to remove some rooms. Try again later"))}c(!1),n(new Map)},kind:"danger_outline",disabled:p}),l?Object(N.b)("Removing…"):Object(N.b)("Remove")),o.a.createElement(g,Z()({},b,{onClick:async()=>{m(!0);try{for(const[a,n]of h){var e;const i=!u,s=null===(e=t.getRelation(a,n))||void 0===e?void 0:e.content;if(!s||s.suggested===i)continue;const o=Ac(Ac({},s),{},{suggested:!u});await r.sendStateEvent(a,ee.b.SpaceChild,o,n),s.suggested=o.suggested}}catch(e){i("Failed to update some suggestions. Try again later")}m(!1),n(new Map)},kind:"primary_outline",disabled:p}),v))};var Vc=e=>{let{space:t,initialText:a="",showRoom:n,additionalButtons:i}=e;const r=Object(s.useContext)(R.a),[l,c]=Object(s.useState)(a),[d,m]=Object(s.useState)(new Map),{loading:h,rooms:u,hierarchy:p,loadMore:g,error:v}=(e=>{const[t,a]=Object(s.useState)([]),[n,i]=Object(s.useState)(),[o,r]=Object(s.useState)(),l=Object(s.useCallback)((()=>{r(void 0);const t=new Tc.a(e,20);t.load().then((()=>{var n;e===t.root&&a(null!==(n=t.rooms)&&void 0!==n?n:[])}),r),i(t)}),[e]);Object(s.useEffect)(l,[l]),Object(ne.a)(b.a,(e=>{e.action===L.a.UpdateSpaceHierarchy&&(a([]),l())}));const c=Object(s.useCallback)((async e=>{var t;!n||n.loading||!n.canLoadMore||n.noSupport||o||(await n.load(e).catch(r),a(null!==(t=n.rooms)&&void 0!==t?t:[]))}),[o,n]);return(null==n?void 0:n.root)!==e?{loading:!0,loadMore:c}:{loading:n.loading,rooms:t,hierarchy:n,loadMore:c,error:o}})(t),f=Object(s.useMemo)((()=>{if(null==u||!u.length||!p)return new Set;const e=l.toLowerCase().trim();if(!e)return new Set(u);const t=u.filter((t=>{var a,n;return(null===(a=t.name)||void 0===a?void 0:a.toLowerCase().includes(e))||(null===(n=t.topic)||void 0===n?void 0:n.toLowerCase().includes(e))})),a=new Set,n=[...t.map((e=>e.room_id))];for(;n.length;){var i;const e=n.pop();a.add(e),null===(i=p.backRefs.get(e))||void 0===i||i.forEach((e=>{a.has(e)||n.push(e)}))}return new Set(u.filter((e=>a.has(e.room_id))))}),[u,p,l]),[E,y]=Object(s.useState)("");let _=E;!E&&v&&(_=Object(N.b)("Failed to load list of rooms."));const S=(e=>{const t=t=>{t[0].isIntersecting&&e()},a=Object(s.useRef)();return e=>{a.current?a.current.disconnect():e&&(a.current=new IntersectionObserver(t,{root:e.parentElement,rootMargin:"0px 0px 600px 0px"})),a.current&&e&&a.current.observe(e)}})(g);if(!h&&p.noSupport)return o.a.createElement("p",null,Object(N.b)("Your server does not support showing space hierarchies."));const w=(e,t)=>{if(y(""),!d.has(e))return void m(new Map(d.set(e,new Set([t]))));const a=d.get(e);a.has(t)?(a.delete(t),m(new Map(d.set(e,new Set(a))))):m(new Map(d.set(e,new Set([...a,t]))))};return o.a.createElement(je.d,{onKeyDown:(e,t)=>{var a,n;Object(J.a)().getAccessibilityAction(e)===W.h.ArrowDown&&e.currentTarget.classList.contains("mx_SpaceHierarchy_search")&&(null===(a=t.refs[0])||void 0===a||null===(n=a.current)||void 0===n||n.focus())},handleHomeEnd:!0,handleUpDown:!0},(e=>{let s,{onKeyDownHandler:g}=e;if(p&&(!h||null!=u&&u.length)){const e="join"===(null==t?void 0:t.getMyMembership())&&t.currentState.maySendStateEvent(ee.b.SpaceChild,r.getSafeUserId()),a=p.roomMap.get(t.roomId);let c,h;f.size&&a?c=o.a.createElement(o.a.Fragment,null,o.a.createElement(Fc,{root:a,roomSet:f,hierarchy:p,parents:new Set,selectedMap:d,onToggleClick:e?w:void 0,onViewRoomClick:(e,t)=>n(r,p,e,t),onJoinRoomClick:e=>(async(e,t,a)=>{if(e.isGuest())b.a.dispatch({action:"require_registration"});else{try{await e.joinRoom(a,{viaServers:Array.from(t.viaMap.get(a)||[])})}catch(e){return void(e instanceof Nc.MatrixError?at.b.instance.roomViewStore.showJoinRoomError(e,a):(Oa.a.warn("Got a non-MatrixError while joining room",e),at.b.instance.roomViewStore.showJoinRoomError(new Nc.MatrixError({error:Object(N.b)("Unknown error")}),a)))}b.a.dispatch({action:L.a.JoinRoomReady,roomId:a,metricsTrigger:"SpaceHierarchy"})}})(r,p,e)})):p.canLoadMore||(c=o.a.createElement("div",{className:"mx_SpaceHierarchy_noResults"},o.a.createElement("h3",null,Object(N.b)("No results found")),o.a.createElement("div",null,Object(N.b)("You may want to try a different search or check for typos.")))),p.canLoadMore&&(h=o.a.createElement("div",{ref:S},o.a.createElement(Zn.a,null))),s=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SpaceHierarchy_listHeader"},o.a.createElement("h4",{className:"mx_SpaceHierarchy_listHeader_header"},l.trim()?Object(N.b)("Results"):Object(N.b)("Rooms and spaces")),o.a.createElement("div",{className:"mx_SpaceHierarchy_listHeader_buttons"},i,e&&o.a.createElement(Bc,{hierarchy:p,selected:d,setSelected:m,setError:y}))),_&&o.a.createElement("div",{className:"mx_SpaceHierarchy_error"},_),o.a.createElement("ul",{className:"mx_SpaceHierarchy_list",onKeyDown:g,role:"tree","aria-label":Object(N.b)("Space")},c),h)}else s=o.a.createElement(Zn.a,null);return o.a.createElement(o.a.Fragment,null,o.a.createElement(as.a,{className:"mx_SpaceHierarchy_search mx_textinput_icon mx_textinput_search",placeholder:Object(N.b)("Search names and descriptions"),onSearch:c,autoFocus:!0,initialValue:a,onKeyDown:g}),s)}))},Wc=function(e){return e[e.Landing=0]="Landing",e[e.PublicCreateRooms=1]="PublicCreateRooms",e[e.PublicShare=2]="PublicShare",e[e.PrivateScope=3]="PrivateScope",e[e.PrivateInvite=4]="PrivateInvite",e[e.PrivateCreateRooms=5]="PrivateCreateRooms",e[e.PrivateExistingRooms=6]="PrivateExistingRooms",e}(Wc||{});const zc=e=>{let{space:t}=e;const[a,n,i,s]=Object(de.q)(),r=Object(ae.a)(le.a.CreateRooms),l=Object(ae.a)(le.a.CreateSpaces),c=Object(se.a)("feature_video_rooms"),d=Object(se.a)("feature_element_call_video_rooms");let m=null;if(a){const e=n.current.getBoundingClientRect();m=o.a.createElement(he.e,{left:e.left+window.scrollX+0,top:e.bottom+window.scrollY+8,chevronFace:de.a.None,onFinished:s,className:"mx_RoomTile_contextMenu",compact:!0},o.a.createElement(he.c,{first:!0},r&&o.a.createElement(o.a.Fragment,null,o.a.createElement(he.b,{label:Object(N.b)("New room"),iconClassName:"mx_RoomList_iconNewRoom",onClick:async e=>{e.preventDefault(),e.stopPropagation(),s(),re.b.trackInteraction("WebSpaceHomeCreateRoomButton",e),await Object(ce.g)(t)&&b.a.fire(L.a.UpdateSpaceHierarchy)}}),c&&o.a.createElement(he.b,{label:Object(N.b)("New video room"),iconClassName:"mx_RoomList_iconNewVideoRoom",onClick:async e=>{e.preventDefault(),e.stopPropagation(),s(),await Object(ce.g)(t,d?ee.j.UnstableCall:ee.j.ElementVideo)&&b.a.fire(L.a.UpdateSpaceHierarchy)}},o.a.createElement(me.a,null))),o.a.createElement(he.b,{label:Object(N.b)("Add existing room"),iconClassName:"mx_RoomList_iconAddExistingRoom",onClick:e=>{e.preventDefault(),e.stopPropagation(),s(),Object(ce.e)(t)}}),l&&o.a.createElement(he.b,{label:Object(N.b)("Add space"),iconClassName:"mx_RoomList_iconPlus",onClick:e=>{e.preventDefault(),e.stopPropagation(),s(),Object(ce.h)(t)}},o.a.createElement(me.a,null))))}return o.a.createElement(o.a.Fragment,null,o.a.createElement(de.b,{kind:"primary",inputRef:n,onClick:i,isExpanded:a,label:Object(N.b)("Add")},Object(N.b)("Add")),m)},Hc=e=>{let{space:t}=e;const a=Object(s.useContext)(R.a),n=Yn(t),i=a.getSafeUserId(),r=Object(s.useCallback)((()=>{var e;return Fa.a.instance.isOpenForRoom(t.roomId)&&(null===(e=Fa.a.instance.currentCardForRoom(t.roomId))||void 0===e?void 0:e.phase)===La.a.SpaceMemberList}),[t.roomId]),l=Object(ie.b)(Fa.a.instance,Et.b,r);let c;Object(ce.c)(t)&&Object(ae.a)(le.a.InviteUsers)&&(c=o.a.createElement(K.a,{kind:"primary",className:"mx_SpaceRoomView_landing_inviteButton",onClick:()=>{Object(ce.i)(t)}},Object(N.b)("Invite")));let d,m;"join"===n&&t.currentState.maySendStateEvent(ee.b.SpaceChild,i)&&(d=o.a.createElement(zc,{space:t})),Object(ce.d)(t)&&(m=o.a.createElement(q.a,{className:"mx_SpaceRoomView_landing_settingsButton",onClick:()=>{Object(ce.k)(t)},title:Object(N.b)("Settings")}));return o.a.createElement("div",{className:"mx_SpaceRoomView_landing"},o.a.createElement("div",{className:"mx_SpaceRoomView_landing_header"},o.a.createElement(ye.a,{room:t,height:80,width:80,viewAvatarOnClick:!0})),o.a.createElement("div",{className:"mx_SpaceRoomView_landing_name"},o.a.createElement(vi.a,{room:t},(e=>{const t={name:()=>o.a.createElement("h1",null,e)};return Object(N.b)("Welcome to <name/>",{},t)}))),o.a.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar"},o.a.createElement(Br,{room:t}),o.a.createElement("div",{className:"mx_SpaceRoomView_landing_infoBar_interactive"},o.a.createElement(Fr,{room:t,onlyKnownUsers:!1,numShown:7,onClick:l?void 0:()=>{Fa.a.instance.setCard({phase:La.a.SpaceMemberList})}}),c,m)),o.a.createElement(Dr,{room:t,className:"mx_SpaceRoomView_landing_topic"}),o.a.createElement(Vc,{space:t,showRoom:Lc,additionalButtons:d}))},Kc=e=>{let{space:t,title:a,description:n,onFinished:i}=e;const[r,l]=Object(s.useState)(!1),[c,d]=Object(s.useState)(""),m=[Object(N.b)("General"),Object(N.b)("Random"),Object(N.b)("Support")],[h,u]=kc(3,[Object(N.b)("General"),Object(N.b)("Random"),""]),p=new Array(3).fill(0).map(((e,t)=>{const a="roomName"+t;return o.a.createElement(st.a,{key:a,name:a,type:"text",label:Object(N.b)("Room name"),placeholder:m[t],value:h[t],onChange:e=>u(t,e.target.value),autoFocus:2===t,disabled:r,autoComplete:"off"})})),g=async e=>{if(e.preventDefault(),!r){d(""),l(!0);try{var a;const e=t.getJoinRule()===Ia.c.Public,n=h.map((e=>e.trim())).filter(Boolean),s=await Promise.all(n.map((a=>Object(xc.b)({createOpts:{preset:e?Ia.d.PublicChat:Ia.d.PrivateChat,name:a},spinner:!1,encryption:!1,andView:!1,inlineErrors:!0,parentSpace:t,joinRule:e?void 0:Ia.c.Restricted,suggested:!0}))));i(null!==(a=s[0])&&void 0!==a?a:void 0)}catch(e){Oa.a.error("Failed to create initial space rooms",e),d(Object(N.b)("Failed to create initial space rooms"))}l(!1)}};let b=e=>{e.preventDefault(),i()},v=Object(N.b)("Skip for now");return h.some((e=>e.trim()))&&(b=g,v=r?Object(N.b)("Creating rooms…"):Object(N.b)("Continue")),o.a.createElement("div",null,o.a.createElement("h1",null,a),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},n),c&&o.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},c),o.a.createElement("form",{onSubmit:b,id:"mx_SpaceSetupFirstRooms"},p),o.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.a.createElement(K.a,{kind:"primary",disabled:r,onClick:b,element:"input",type:"submit",form:"mx_SpaceSetupFirstRooms",value:v})))},Gc=e=>{let{space:t,onFinished:a}=e;return o.a.createElement("div",null,o.a.createElement("h1",null,Object(N.b)("What do you want to organise?")),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(N.b)("Pick rooms or conversations to add. This is just a space for you, no one will be informed. You can add more later.")),o.a.createElement(Rc.a,{space:t,emptySelectionButton:o.a.createElement(K.a,{kind:"primary",onClick:a},Object(N.b)("Skip for now")),filterPlaceholder:Object(N.b)("Search for rooms"),onFinished:a,roomsRenderer:Rc.f,dmsRenderer:Rc.e}))},qc=e=>{var t;let{justCreatedOpts:a,space:n,onFinished:i,firstRoomId:s}=e;return o.a.createElement("div",{className:"mx_SpaceRoomView_publicShare"},o.a.createElement("h1",null,Object(N.b)("Share %(name)s",{name:(null==a||null===(t=a.createOpts)||void 0===t?void 0:t.name)||n.name})),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(N.b)("It's just you at the moment, it will be even better with others.")),o.a.createElement(Ic.a,{space:n}),o.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.a.createElement(K.a,{kind:"primary",onClick:i},s?Object(N.b)("Go to my first room"):Object(N.b)("Go to my space"))))},$c=e=>{var t;let{space:a,justCreatedOpts:n,onFinished:i}=e;return o.a.createElement("div",{className:"mx_SpaceRoomView_privateScope"},o.a.createElement("h1",null,Object(N.b)("Who are you working with?")),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(N.b)("Make sure the right people have access to %(name)s",{name:(null==n||null===(t=n.createOpts)||void 0===t?void 0:t.name)||a.name})),o.a.createElement(K.a,{className:"mx_SpaceRoomView_privateScope_justMeButton",onClick:()=>{i(!1)}},o.a.createElement("h3",null,Object(N.b)("Just me")),o.a.createElement("div",null,Object(N.b)("A private space to organise your rooms"))),o.a.createElement(K.a,{className:"mx_SpaceRoomView_privateScope_meAndMyTeammatesButton",onClick:()=>{i(!0)}},o.a.createElement("h3",null,Object(N.b)("Me and my teammates")),o.a.createElement("div",null,Object(N.b)("A private space for you and your teammates"))))},Yc=Object(yi.a)({rules:[{key:"email",test:e=>{let{value:t}=e;return!t||jc.a(t)},invalid:()=>Object(N.b)("Doesn't look like a valid email address")}]}),Jc=e=>{let{space:t,onFinished:a}=e;const[n,i]=Object(s.useState)(!1),[r,l]=Object(s.useState)(""),c=[Object(s.useRef)(),Object(s.useRef)(),Object(s.useRef)()],[d,m]=kc(3,""),h=new Array(3).fill(0).map(((e,t)=>{const a="emailAddress"+t;return o.a.createElement(st.a,{key:a,name:a,type:"text",label:Object(N.b)("Email address"),placeholder:Object(N.b)("Email"),value:d[t],onChange:e=>m(t,e.target.value),ref:c[t],onValidate:Yc,autoFocus:0===t,disabled:n})})),u=async e=>{if(e.preventDefault(),n)return;l("");for(const e of c){var s;if(!1===await(null===(s=e.current)||void 0===s?void 0:s.validate({allowEmpty:!0})))return e.current.focus(),void e.current.validate({allowEmpty:!0,focused:!0})}i(!0);const o=d.map((e=>e.trim())).filter(Boolean);try{const e=await Object(es.a)(t.roomId,o),n=Object.keys(e.states).filter((t=>"error"===e.states[t]));n.length>0?(Oa.a.log("Failed to invite users to space: ",e),l(Object(N.b)("Failed to invite the following users to your space: %(csvUsers)s",{csvUsers:n.join(", ")}))):a()}catch(e){Oa.a.error("Failed to invite users to space: ",e),l(Object(N.b)("We couldn't invite those users. Please check the users you want to invite and try again."))}i(!1)};let p=e=>{e.preventDefault(),a()},g=Object(N.b)("Skip for now");return d.some((e=>e.trim()))&&(p=u,g=n?Object(N.b)("Inviting…"):Object(N.b)("Continue")),o.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates"},o.a.createElement("h1",null,Object(N.b)("Invite your teammates")),o.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(N.b)("Make sure the right people have access. You can invite more later.")),o.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_betaDisclaimer"},Object(N.b)("<b>This is an experimental feature.</b> For now, new users receiving an invite will have to open the invite on <link/> to actually join.",{},{b:e=>o.a.createElement("b",null,e),link:()=>o.a.createElement("a",{href:"https://app.element.io/",rel:"noreferrer noopener",target:"_blank"},"app.element.io")})),r&&o.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},r),o.a.createElement("form",{onSubmit:p,id:"mx_SpaceSetupPrivateInvite"},h),o.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_buttons"},o.a.createElement(K.a,{className:"mx_SpaceRoomView_inviteTeammates_inviteDialogButton",onClick:()=>Object(es.e)(t.roomId)},Object(N.b)("Invite by username"))),o.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},o.a.createElement(K.a,{kind:"primary",disabled:n,onClick:p,element:"input",type:"submit",form:"mx_SpaceSetupPrivateInvite",value:g})))};class Qc extends o.a.PureComponent{constructor(e,t){var a;super(e,t),i()(this,"context",void 0),i()(this,"dispatcherRef",void 0),i()(this,"onMyMembership",((e,t)=>{e.roomId===this.props.space.roomId&&this.setState({myMembership:t})})),i()(this,"onRightPanelStoreUpdate",(()=>{this.setState({showRightPanel:Fa.a.instance.isOpenForRoom(this.props.space.roomId)})})),i()(this,"onAction",(e=>{if(e.action!==L.a.ViewRoom||e.room_id!==this.props.space.roomId){if(e.action===L.a.ViewUser||"view_3pid_invite"===e.action)if(e.action===L.a.ViewUser&&e.member){const t={phase:La.a.SpaceMemberInfo,state:{spaceId:this.props.space.roomId,member:e.member}};e.push?Fa.a.instance.pushCard(t):Fa.a.instance.setCards([{phase:La.a.SpaceMemberList,state:{spaceId:this.props.space.roomId}},t])}else"view_3pid_invite"===e.action&&e.event?Fa.a.instance.setCard({phase:La.a.Space3pidMemberInfo,state:{spaceId:this.props.space.roomId,memberInfoEvent:e.event}}):Fa.a.instance.setCard({phase:La.a.SpaceMemberList,state:{spaceId:this.props.space.roomId}})}else this.setState({phase:Wc.Landing})})),i()(this,"goToFirstRoom",(async()=>{this.state.firstRoomId?b.a.dispatch({action:L.a.ViewRoom,room_id:this.state.firstRoomId,metricsTrigger:void 0}):this.setState({phase:Wc.Landing})}));let n=Wc.Landing;const s=null===(a=this.props.space.currentState.getStateEvents(ee.b.RoomCreate,""))||void 0===a?void 0:a.getSender();var o;this.props.justCreatedOpts&&t.getSafeUserId()===s&&(n=(null===(o=this.props.justCreatedOpts.createOpts)||void 0===o?void 0:o.preset)===Ia.d.PublicChat?Wc.PublicCreateRooms:Wc.PrivateScope);this.state={phase:n,showRightPanel:Fa.a.instance.isOpenForRoom(this.props.space.roomId),myMembership:this.props.space.getMyMembership()},this.dispatcherRef=b.a.register(this.onAction),Fa.a.instance.on(Et.b,this.onRightPanelStoreUpdate)}componentDidMount(){this.context.on(te.d.MyMembership,this.onMyMembership)}componentWillUnmount(){b.a.unregister(this.dispatcherRef),Fa.a.instance.off(Et.b,this.onRightPanelStoreUpdate),this.context.off(te.d.MyMembership,this.onMyMembership)}renderBody(){var e,t;switch(this.state.phase){case Wc.Landing:return"join"===this.state.myMembership?o.a.createElement(Hc,{space:this.props.space}):o.a.createElement(Vr,{room:this.props.space,onJoinButtonClicked:this.props.onJoinButtonClicked,onRejectButtonClicked:this.props.onRejectButtonClicked});case Wc.PublicCreateRooms:return o.a.createElement(Kc,{space:this.props.space,title:Object(N.b)("What are some things you want to discuss in %(spaceName)s?",{spaceName:(null===(e=this.props.justCreatedOpts)||void 0===e||null===(t=e.createOpts)||void 0===t?void 0:t.name)||this.props.space.name}),description:o.a.createElement(o.a.Fragment,null,Object(N.b)("Let's create a room for each of them."),o.a.createElement("br",null),Object(N.b)("You can add more later too, including already existing ones.")),onFinished:e=>this.setState({phase:Wc.PublicShare,firstRoomId:e})});case Wc.PublicShare:return o.a.createElement(qc,{justCreatedOpts:this.props.justCreatedOpts,space:this.props.space,onFinished:this.goToFirstRoom,firstRoomId:this.state.firstRoomId});case Wc.PrivateScope:return o.a.createElement($c,{space:this.props.space,justCreatedOpts:this.props.justCreatedOpts,onFinished:e=>{this.setState({phase:e?Wc.PrivateCreateRooms:Wc.PrivateExistingRooms})}});case Wc.PrivateInvite:return o.a.createElement(Jc,{space:this.props.space,onFinished:()=>this.setState({phase:Wc.Landing})});case Wc.PrivateCreateRooms:return o.a.createElement(Kc,{space:this.props.space,title:Object(N.b)("What projects are your team working on?"),description:o.a.createElement(o.a.Fragment,null,Object(N.b)("We'll create rooms for each of them."),o.a.createElement("br",null),Object(N.b)("You can add more later too, including already existing ones.")),onFinished:e=>this.setState({phase:Wc.PrivateInvite,firstRoomId:e})});case Wc.PrivateExistingRooms:return o.a.createElement(Gc,{space:this.props.space,onFinished:()=>this.setState({phase:Wc.Landing})})}}render(){const e=this.state.showRightPanel&&this.state.phase===Wc.Landing?o.a.createElement(Er,{room:this.props.space,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.props.permalinkCreator}):void 0;return o.a.createElement("main",{className:"mx_SpaceRoomView"},o.a.createElement(Or.a,null,o.a.createElement(Aa,{panel:e,resizeNotifier:this.props.resizeNotifier},this.renderBody())))}}i()(Qc,"contextType",R.a);var Xc=a(803);class Zc extends o.a.PureComponent{render(){return o.a.createElement("div",{className:"mx_TopUnreadMessagesBar"},o.a.createElement(K.a,{className:"mx_TopUnreadMessagesBar_scrollUp",title:Object(N.b)("Jump to first unread message."),onClick:this.props.onScrollUpClick}),o.a.createElement(K.a,{className:"mx_TopUnreadMessagesBar_markAsRead",title:Object(N.b)("Mark all as read"),onClick:this.props.onCloseClick}))}}var ed=a(184),td=a(307),ad=a(678),nd=a(927),id=a(338),sd=a(804);const od=e=>{let{text:t}=e;return o.a.createElement("div",{className:"mx_LargeLoader"},o.a.createElement(Zn.a,{w:45,h:45}),o.a.createElement("div",{className:"mx_LargeLoader_text"},t))};var rd=a(522),ld=a(363);class cd extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"callEventGroupers",new Map),this.buildLegacyCallEventGroupers(this.props.timeline)}buildLegacyCallEventGroupers(e){this.callEventGroupers=Object(Zs.c)(this.callEventGroupers,e)}render(){const e=this.props.timeline,t=e[this.props.ourEventsIndexes[0]],a=t.getId(),n=t.getTs(),i=[o.a.createElement(rd.a,{key:n+"-search",roomId:t.getRoomId(),ts:n})],s=v.b.getValue("showTwelveHourTimestamps"),r=v.b.getValue("alwaysShowTimestamps");for(let t=0;t<e.length;t++){var l;const n=e[t];let m;const h=!this.props.ourEventsIndexes.includes(t);if(h||(m=this.props.searchHighlights),Object(wi.c)(n,null===(l=this.context)||void 0===l?void 0:l.showHiddenEvents)){var c;const l=e[t-1],u=l&&!Object(si.p)(l.getDate()||void 0,n.getDate()||void 0)&&Object(Xs.b)(l,n,null===(c=this.context)||void 0===c?void 0:c.showHiddenEvents,en.a.Search);let p=!0;const g=e[t+1];if(g){var d;p=Object(si.p)(n.getDate()||void 0,g.getDate()||void 0)||n.getSender()!==g.getSender()||!Object(Xs.b)(n,g,null===(d=this.context)||void 0===d?void 0:d.showHiddenEvents,en.a.Search)}i.push(o.a.createElement(ld.b,{key:`${a}+${t}`,mxEvent:n,layout:this.props.layout,singleSideBubbles:this.props.singleSideBubbles,userNameColorMode:this.props.userNameColorMode,contextual:h,highlights:m,permalinkCreator:this.props.permalinkCreator,highlightLink:this.props.resultLink,onHeightChanged:this.props.onHeightChanged,isTwelveHour:s,alwaysShowTimestamps:r,lastInSection:p,continuation:u,callEventGrouper:this.callEventGroupers.get(n.getContent().call_id)}))}}return o.a.createElement("li",{"data-scroll-tokens":a},o.a.createElement("ol",null,i))}}i()(cd,"contextType",en.b);var dd=a(441);const md=10;async function hd(e,t,a){const n=oe.a.get(),i={limit:md};void 0!==t&&(i.rooms=[t]);const s={search_categories:{room_events:{search_term:e,filter:i,order_by:dd.a.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}};return{response:await n.search({body:s},a),query:s}}async function ud(e,t,a){const n=oe.a.get(),i=await hd(e,t,a),s={abortSignal:a,_query:i.query,results:[],highlights:[]};return n.processRoomEventsSearch(s,i.response)}function pd(e,t){const a=e.result,n=t.result;return a.origin_server_ts>n.origin_server_ts?-1:a.origin_server_ts<n.origin_server_ts?1:0}async function gd(e,t){const a=Hs.a.get(),n={search_term:e,before_limit:1,after_limit:1,limit:md,order_by_recency:!0,room_id:void 0};void 0!==t&&(n.room_id=t);const i=await a.search(n);n.next_batch=i.next_batch;return{response:i,query:n}}function bd(e,t){try{const a=e[e.length-1].result,n=t[t.length-1].result;return a.origin_server_ts<=n.origin_server_ts?-1:1}catch{return 0}}function vd(e,t,a,n){const i=a.concat(n).sort(pd);t.results=i.slice(0,md),e.cachedEvents=i.slice(md)}function fd(e,t,a){const n=function(e,t,a){const n={},i=e.cachedEvents;let s=e.oldestEventFrom;return n.highlights=e.highlights,t&&a&&a.results?(bd(t.results,a.results)<0&&(s="local"),vd(e,n,t.results,a.results),n.highlights=t.highlights.concat(a.highlights)):t?(bd(t.results,i)<0&&(s="local"),vd(e,n,t.results,i)):a&&a.results?(bd(a.results,i)<0&&(s="server"),vd(e,n,a.results,i)):(n.results=i,e.cachedEvents=[]),e.oldestEventFrom=s,n}(e,t,a);return e.count?n.count=e.count:n.count=t.count+a.count,t&&(e.seshatQuery.next_batch=t.next_batch),a&&(e.serverSideNextBatch=a.next_batch),e.seshatQuery.next_batch?n.next_batch=e.seshatQuery.next_batch:e.serverSideNextBatch&&(n.next_batch=e.serverSideNextBatch),!n.next_batch&&e.cachedEvents.length>0&&(n.next_batch="cached"),n}function Ed(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(const t of e){const e=t.context.getTimeline();for(const t of e){const e=t.event;e.curve25519Key&&(t.makeEncrypted(ee.b.RoomMessageEncrypted,{algorithm:e.algorithm},e.curve25519Key,e.ed25519Key),t.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain,delete e.curve25519Key,delete e.ed25519Key,delete e.algorithm,delete e.forwardingCurve25519KeyChain)}}}function yd(e,t,a){let n;return n=void 0!==t?oe.a.get().isRoomEncrypted(t)?async function(e,t){const a={results:[],highlights:[]};if(""===e)return a;const n=await gd(e,t);a.seshatQuery=n.query;const i={search_categories:{room_events:n.response}},s=oe.a.get().processRoomEventsSearch(a,i);return Ed(s.results),s}(e,t):ud(e,t,a):async function(e,t){const a=oe.a.get(),n=hd(e,void 0,t),i=gd(e);await Promise.all([n,i]);const s=await i,o=await n,r=o.query,l=o.response,c=s.query,d=s.response,m={seshatQuery:c,_query:r,serverSideNextBatch:l.search_categories.room_events.next_batch,cachedEvents:[],oldestEventFrom:"server",results:[],highlights:[]},h={search_categories:{room_events:fd(m,d,l.search_categories.room_events)}},u=a.processRoomEventsSearch(m,h);return Ed(u.results),u}(e,a),n}function _d(e){const t=oe.a.get(),a=e.seshatQuery,n=e._query;if(a){if(n){const t=async function(e){const t=Hs.a.get(),a=oe.a.get(),n=e.seshatQuery,i=e.oldestEventFrom;let s,o,r;if(!n.next_batch||e.serverSideNextBatch&&"server"!==i||(s=await t.search(n)),e.serverSideNextBatch&&("local"===i||!n.next_batch)){const t={body:e._query,next_batch:e.serverSideNextBatch};o=await a.search(t)}o&&(r=o.search_categories.room_events);const l={search_categories:{room_events:fd(e,s,r)}},c=e.results?e.results.length:0,d=a.processRoomEventsSearch(e,l),m=d.results.length-c;return Ed(d.results.slice(Math.max(d.results.length-m,0))),e.pendingRequest=void 0,d}(e);return e.pendingRequest=t,t}{const t=async function(e){const t=Hs.a.get(),a=e.seshatQuery,n=await t.search(a);e.seshatQuery.next_batch=n.next_batch;const i=n.results.length,s={search_categories:{room_events:n}},o=oe.a.get().processRoomEventsSearch(e,s);return Ed(o.results.slice(Math.max(o.results.length-i,0))),e.pendingRequest=void 0,o}(e);return e.pendingRequest=t,t}}return t.backPaginateRoomEventsSearch(e)}function Sd(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}let wd=function(e){};const Od=Object(s.forwardRef)(((e,t)=>{let{term:a,scope:n,promise:r,abortController:l,resizeNotifier:c,permalinkCreator:d,className:m,layout:h,singleSideBubbles:u,userNameColorMode:p,onUpdate:g}=e;const b=Object(s.useContext)(R.a),v=Object(s.useContext)(en.b),[f,E]=Object(s.useState)(!0),[y,_]=Object(s.useState)(null),[S,w]=Object(s.useState)(null),O=Object(s.useRef)(!1),C=Object(s.useCallback)((e=>(E(!0),e.then((async e=>{if(wd("search complete"),O.current)return Oa.a.error("Discarding stale search results"),!1;let t=e.highlights;t.includes(a)||(t=t.concat(a)),t=t.sort((function(e,t){return t.length-e.length}));for(const t of e.results)for(const e of t.context.getTimeline()){if(!e.getServerAggregatedRelation(Ra.d.name)||e.getThread())continue;const t=b.getRoom(e.getRoomId()),a=null==t?void 0:t.findThreadForEvent(e);a?e.setThread(a):null==t||t.createThread(e.getId(),e,[],!0)}_(t),w(function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Sd(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Sd(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({},e))}),(e=>{var t;return O.current?(Oa.a.error("Discarding stale search results"),!1):(Oa.a.error("Search failed",e),z.b.createDialog(sn.a,{title:Object(N.b)("Search failed"),description:null!==(t=null==e?void 0:e.message)&&void 0!==t?t:Object(N.b)("Server may be unavailable, overloaded, or search timed out :(")}),!1)})).finally((()=>{E(!1)})))),[b,a]);if(Object(s.useEffect)((()=>(O.current=!1,C(r),()=>{O.current=!0,null==l||l.abort()})),[]),void 0===(null==S?void 0:S.count))return o.a.createElement("div",{className:"mx_RoomView_messagePanel mx_RoomView_messagePanelSearchSpinner","data-testid":"messagePanelSearchSpinner"});const x=[];var j;(f&&x.push(o.a.createElement("li",{key:"search-spinner"},o.a.createElement(Zn.a,null))),S.next_batch)||(null!=S&&null!==(j=S.results)&&void 0!==j&&j.length?x.push(o.a.createElement("li",{key:"search-top-marker"},o.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(N.b)("No more results")))):x.push(o.a.createElement("li",{key:"search-top-marker"},o.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(N.b)("No results")))));const k=()=>{const e=t.current;null==e||e.checkScroll()};let I,T=[],P=[];for(let e=((null==S||null===(D=S.results)||void 0===D?void 0:D.length)||0)-1;e>=0;e--){var D;const t=S.results[e],a=t.context.getEvent(),i=a.getRoomId(),s=b.getRoom(i);if(!s){Oa.a.log("Hiding search result from an unknown room",i);continue}if(!Object(wi.c)(a,v.showHiddenEvents))continue;n===Wr.All&&i!==I&&(x.push(o.a.createElement("li",{key:a.getId()+"-room"},o.a.createElement("h2",null,Object(N.b)("Room"),": ",s.name))),I=i);const r="#/room/"+i+"/"+a.getId(),l=t.context.getTimeline(),c=e>0?S.results[e-1].context.getTimeline():[];if(e>0&&l[l.length-1].getId()==c[0].getId()){if(0==T.length){for(let e=0==T.length?0:1;e<t.context.getTimeline().length;e++)T.push(l[e]);P.push(t.context.getOurEventIndex())}for(let e=1;e<c.length;e++)T.push(c[e]);P.push(P[P.length-1]+S.results[e-1].context.getOurEventIndex()+1)}else 0==T.length&&(T=t.context.getTimeline(),P=[],P.push(t.context.getOurEventIndex())),x.push(o.a.createElement(cd,{key:a.getId(),timeline:T,ourEventsIndexes:P,searchHighlights:null!=y?y:[],resultLink:r,permalinkCreator:d,onHeightChanged:k,layout:h,singleSideBubbles:u,userNameColorMode:p})),P=[],T=[]}return o.a.createElement(wr.a,{ref:t,className:"mx_RoomView_searchResultsPanel "+m,onFillRequest:async e=>{if(!e)return!1;if(!S.next_batch)return wd("no more search results"),!1;wd("requesting more search results");const t=function(e){const t=Hs.a.get(),a=oe.a.get();return e.pendingRequest?e.pendingRequest:null===t?a.backPaginateRoomEventsSearch(e):_d(e)}(S);return C(t)},resizeNotifier:c},o.a.createElement("li",{className:"mx_RoomView_scrollheader"}),x)}));var Cd=a(395),xd=a(980),jd=a(289);const kd=e=>{let{roomView:t,resizeNotifier:a,inviteEvent:n}=e;const i=Object(en.c)();return o.a.createElement("div",{className:"mx_RoomView mx_RoomView--local"},o.a.createElement(Or.a,null,o.a.createElement(bc,{room:i.room,inRoom:!0,onSearchClick:null,onInviteClick:null,onForgetClick:null,e2eStatus:Za.Normal,onAppsClick:null,appsShown:!1,excludedRightPanelPhaseButtons:[],showButtons:!1,enableRoomOptionsMenu:!1,viewingCall:!1,activeCall:null}),o.a.createElement("main",{className:"mx_RoomView_body",ref:t},o.a.createElement("div",{className:"mx_RoomView_timeline"},o.a.createElement(wr.a,{className:"mx_RoomView_messagePanel",resizeNotifier:a},o.a.createElement(jd.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(N.b)("Waiting for users to join Element"),subtitle:Object(N.b)("Once invited users have joined Element, you will be able to chat and the room will be end-to-end encrypted")}),o.a.createElement(ad.a,null),o.a.createElement(ld.a,{mxEvent:n}))))))},Rd=["upgradeRecommendation"],Id=["upgradeRecommendation"];function Td(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Nd(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Td(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Td(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}let Pd=function(e){};const Dd="sandbox"in document.createElement("iframe");var Md=function(e){return e[e.Timeline=0]="Timeline",e[e.MaximisedWidget=1]="MaximisedWidget",e[e.Call=2]="Call",e}(Md||{});function Ad(e){const t=Object(s.useContext)(en.b),a=t.room,n=e.localRoom.currentState.getStateEvents(ee.b.RoomEncryption)[0];let i;n&&(i=o.a.createElement(nd.a,{mxEvent:n}));const r=()=>{a.state=td.c.NEW,b.b.dispatch({action:"local_room_event",roomId:a.roomId})};let l=null,c=null;if(a.isError){const e=o.a.createElement(K.a,{onClick:r,className:"mx_RoomStatusBar_unsentRetry"},Object(N.b)("Retry"));l=o.a.createElement(sd.a,{title:Object(N.b)("Some of your messages have not been sent"),notificationState:Ce.a.RED_EXCLAMATION,buttons:e})}else c=o.a.createElement(Ho,{room:e.localRoom,resizeNotifier:e.resizeNotifier,permalinkCreator:e.permalinkCreator});return o.a.createElement("div",{className:"mx_RoomView mx_RoomView--local"},o.a.createElement(Or.a,null,o.a.createElement(bc,{room:t.room,searchInfo:void 0,inRoom:!0,onSearchClick:null,onInviteClick:null,onForgetClick:null,e2eStatus:a.encrypted?Za.Normal:void 0,onAppsClick:null,appsShown:!1,excludedRightPanelPhaseButtons:[],showButtons:!1,enableRoomOptionsMenu:!1,viewingCall:!1,activeCall:null}),o.a.createElement("main",{className:"mx_RoomView_body",ref:e.roomView},o.a.createElement(Xo,{parent:e.roomView.current,onFileDrop:e.onFileDrop}),o.a.createElement("div",{className:"mx_RoomView_timeline"},o.a.createElement(wr.a,{className:"mx_RoomView_messagePanel",resizeNotifier:e.resizeNotifier},i,o.a.createElement(ad.a,null))),l,c)))}function Ud(e){const t=Object(s.useContext)(en.b),a=Object(N.b)("We're creating a room with %(names)s",{names:e.names});return o.a.createElement("div",{className:"mx_RoomView mx_RoomView--local"},o.a.createElement(Or.a,null,o.a.createElement(bc,{room:t.room,searchInfo:void 0,inRoom:!0,onSearchClick:null,onInviteClick:null,onForgetClick:null,e2eStatus:e.localRoom.encrypted?Za.Normal:void 0,onAppsClick:null,appsShown:!1,excludedRightPanelPhaseButtons:[],showButtons:!1,enableRoomOptionsMenu:!1,viewingCall:!1,activeCall:null}),o.a.createElement("div",{className:"mx_RoomView_body"},o.a.createElement(od,{text:a}))))}class Ld extends o.a.Component{constructor(e,t){var a,n;if(super(e,t),a=this,i()(this,"dispatcherRef",void 0),i()(this,"settingWatchers",void 0),i()(this,"unmounted",!1),i()(this,"permalinkCreators",{}),i()(this,"roomView",Object(s.createRef)()),i()(this,"searchResultsPanel",Object(s.createRef)()),i()(this,"messagePanel",null),i()(this,"roomViewBody",Object(s.createRef)()),i()(this,"context",void 0),i()(this,"onIsResizing",(e=>{this.setState({resizing:e})})),i()(this,"onWidgetStoreUpdate",(()=>{this.state.room&&(this.checkWidgets(this.state.room),this.doMaybeRemoveOwnJitsiWidget())})),i()(this,"onWidgetEchoStoreUpdate",(()=>{this.state.room&&this.checkWidgets(this.state.room)})),i()(this,"onWidgetLayoutChange",(()=>{this.state.room&&(b.a.dispatch({action:"appsDrawer",show:!0}),this.context.widgetLayoutStore.hasMaximisedWidget(this.state.room)&&this.context.rightPanelStore.setCard({phase:La.a.Timeline}),this.checkWidgets(this.state.room))})),i()(this,"checkWidgets",(e=>{this.setState({hasPinnedWidgets:this.context.widgetLayoutStore.hasPinnedWidgets(e),mainSplitContentType:this.getMainSplitContentType(e),showApps:this.shouldShowApps(e)})})),i()(this,"getMainSplitContentType",(e=>v.b.getValue("feature_group_calls")&&this.context.roomViewStore.isViewingCall()||ic(e)?Md.Call:this.context.widgetLayoutStore.hasMaximisedWidget(e)?Md.MaximisedWidget:Md.Timeline)),i()(this,"onRoomViewStoreUpdate",(async e=>{var t,n,i,s,o,r;if(this.unmounted)return;if(!e&&this.state.roomId!==this.context.roomViewStore.getRoomId())return;const l=null!==(t=this.context.roomViewStore.getRoomId())&&void 0!==t?t:null,c=null!==(n=null===(i=this.context.client)||void 0===i?void 0:i.getRoom(null!=l?l:void 0))&&void 0!==n?n:void 0,d={roomId:null!=l?l:void 0,roomAlias:null!==(s=this.context.roomViewStore.getRoomAlias())&&void 0!==s?s:void 0,roomLoading:this.context.roomViewStore.isRoomLoading(),roomLoadError:null!==(o=this.context.roomViewStore.getRoomLoadError())&&void 0!==o?o:void 0,joining:this.context.roomViewStore.isJoining(),replyToEvent:null!==(r=this.context.roomViewStore.getQuotingEvent())&&void 0!==r?r:void 0,shouldPeek:this.state.matrixClientIsReady&&this.context.roomViewStore.shouldPeek(),showReadReceipts:v.b.getValue("showReadReceipts",l),showRedactions:v.b.getValue("showRedactions",l),showJoinLeaves:v.b.getValue("showJoinLeaves",l),showAvatarChanges:v.b.getValue("showAvatarChanges",l),showDisplaynameChanges:v.b.getValue("showDisplaynameChanges",l),wasContextSwitch:this.context.roomViewStore.getWasContextSwitch(),mainSplitContentType:c?this.getMainSplitContentType(c):void 0,initialEventId:void 0,showRightPanel:this.context.rightPanelStore.isOpenForRoom(l),activeCall:fc.a.instance.getActiveCall(l)};var m;this.state.mainSplitContentType!==Md.Timeline&&d.mainSplitContentType===Md.Timeline&&this.context.rightPanelStore.isOpen&&this.context.rightPanelStore.currentCard.phase===La.a.Timeline&&this.context.rightPanelStore.roomPhaseHistory.some((e=>e.phase===La.a.Timeline))&&(this.context.rightPanelStore.setCard({phase:La.a.RoomSummary}),this.context.rightPanelStore.togglePanel(null!==(m=this.state.roomId)&&void 0!==m?m:null),d.showRightPanel=!1);const h=this.context.roomViewStore.getInitialEventId();if(h){var u,p;let e=null==c?void 0:c.findEventById(h);var g;if(!e&&this.context.client)e=null!==(g=await Object(ed.f)(this.context.client,l,h))&&void 0!==g?g:void 0;d.initialEventPixelOffset=void 0;const t=null===(u=e)||void 0===u?void 0:u.getThread();var f;if(!t||null!==(p=e)&&void 0!==p&&p.isThreadRoot)d.initialEventId=h,d.isInitialEventHighlighted=this.context.roomViewStore.isInitialEventHighlighted(),d.initialEventScrollIntoView=this.context.roomViewStore.initialEventScrollIntoView(),t&&null!==(f=e)&&void 0!==f&&f.isThreadRoot&&b.a.dispatch({action:L.a.ShowThread,rootEvent:t.rootEvent,initialEvent:e,highlighted:this.context.roomViewStore.isInitialEventHighlighted(),scroll_into_view:this.context.roomViewStore.initialEventScrollIntoView()});else b.a.dispatch({action:L.a.ShowThread,rootEvent:t.rootEvent,initialEvent:e,highlighted:this.context.roomViewStore.isInitialEventHighlighted(),scroll_into_view:this.context.roomViewStore.initialEventScrollIntoView()})}var E,y,_;(this.settingWatchers=this.settingWatchers.concat([v.b.watchSetting("showReadReceipts",l,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showReadReceipts:i})})),v.b.watchSetting("showRedactions",l,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showRedactions:i})})),v.b.watchSetting("showJoinLeaves",l,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showJoinLeaves:i})})),v.b.watchSetting("showAvatarChanges",l,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showAvatarChanges:i})})),v.b.watchSetting("showDisplaynameChanges",l,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showDisplaynameChanges:i})}))]),e||!this.state.shouldPeek||d.shouldPeek)||(null===(E=this.context.client)||void 0===E||E.stopPeeking());if(Oa.a.log("RVS update:",d.roomId,d.roomAlias,"loading?",d.roomLoading,"joining?",d.joining,"initial?",e,"shouldPeek?",d.shouldPeek),e&&(d.room=this.context.client.getRoom(d.roomId)||void 0,d.room&&(d.showApps=this.shouldShowApps(d.room),this.onRoomLoaded(d.room))),null===this.state.roomId&&null!==d.roomId&&!d.initialEventId){const e=_r.getScrollState(d.roomId);e&&(d.initialEventId=e.focussedEvent,d.initialEventPixelOffset=e.pixelOffset)}this.state.timelineRenderingType===en.a.Search&&this.state.initialEventId!==d.initialEventId&&(d.timelineRenderingType=en.a.Room,null===(y=this.state.search)||void 0===y||null===(_=y.abortController)||void 0===_||_.abort(),d.search=void 0);this.setState(d),e&&this.setupRoom(d.room,d.roomId,d.joining,d.shouldPeek)})),i()(this,"onActiveCalls",(()=>{if(void 0===this.state.roomId)return;const e=fc.a.instance.getActiveCall(this.state.roomId);null===e&&b.a.dispatch({action:L.a.ViewRoom,room_id:this.state.roomId,view_call:!1,metricsTrigger:void 0},!0),this.setState({activeCall:e})})),i()(this,"getRoomId",(()=>this.state.room?this.state.room.roomId:this.state.roomId)),i()(this,"onRightPanelStoreUpdate",(()=>{this.setState({showRightPanel:this.context.rightPanelStore.isOpenForRoom(this.state.roomId)})})),i()(this,"onPageUnload",(e=>Pa.a.sharedInstance().getCurrentUploads().length>0?e.returnValue=Object(N.b)("You seem to be uploading files, are you sure you want to quit?"):this.getCallForRoom()&&"ended"!==this.state.callState?e.returnValue=Object(N.b)("You seem to be in a call, are you sure you want to quit?"):void 0)),i()(this,"onReactKeyDown",(e=>{var t;let a=!1;switch(Object(J.a)().getRoomAction(e)){case W.h.DismissReadMarker:null===(t=this.messagePanel)||void 0===t||t.forgetReadMarker(),this.jumpToLiveTimeline(),a=!0;break;case W.h.JumpToOldestUnread:this.jumpToReadMarker(),a=!0;break;case W.h.UploadFile:b.a.dispatch({action:"upload_file",context:en.a.Room},!0),a=!0}a&&(e.stopPropagation(),e.preventDefault())})),i()(this,"onCallState",(e=>{if(!e)return;const t=this.getCallForRoom();this.setState({callState:null==t?void 0:t.state})})),i()(this,"onAction",(async e=>{var t;switch(e.action){case"message_sent":this.checkDesktopNotifications();break;case"post_sticker_message":this.injectSticker(e.data.content.url,e.data.content.info,e.data.description||e.data.name,e.data.threadId);break;case"picture_snapshot":Pa.a.sharedInstance().sendContentListToRoom([e.file],this.state.room.roomId,void 0,this.context.client);break;case"notifier_enabled":case L.a.UploadStarted:case L.a.UploadFinished:case L.a.UploadCanceled:this.forceUpdate();break;case"appsDrawer":this.setState({showApps:e.show});break;case"reply_to_event":!this.unmounted&&this.state.search&&(null===(t=e.event)||void 0===t?void 0:t.getRoomId())===this.state.roomId&&e.context===en.a.Search&&this.onCancelSearchClick();break;case"MatrixActions.sync":var a;if(!this.state.matrixClientIsReady)this.setState({matrixClientIsReady:!(null===(a=this.context.client)||void 0===a||!a.isInitialSyncComplete())},(()=>{this.onRoomViewStoreUpdate(!0)}));break;case"focus_search":this.onSearchClick();break;case"local_room_event":this.onLocalRoomEvent(e.roomId);break;case L.a.EditEvent:{if(e.timelineRenderingType!==this.state.timelineRenderingType)return;const t=e.event?new Ko(e.event):void 0;this.setState({editState:t},(()=>{var t;e.event&&(null===(t=this.messagePanel)||void 0===t||t.scrollToEventIfNeeded(e.event.getId()))}));break}case L.a.ComposerInsert:{if(e.composerType)break;let t=e.timelineRenderingType;if(t===en.a.Thread)break;this.state.timelineRenderingType===en.a.Search&&e.timelineRenderingType===en.a.Search&&(await this.onCancelSearchClick(),t=en.a.Room),b.a.dispatch(Nd(Nd({},e),{},{timelineRenderingType:t,composerType:this.state.editState?Zo.a.Edit:Zo.a.Send}));break}case L.a.FocusAComposer:b.a.dispatch(Nd(Nd({},e),{},{action:this.state.editState?L.a.FocusEditMessageComposer:L.a.FocusSendMessageComposer}));break;case"scroll_to_bottom":var n;if(e.timelineRenderingType===en.a.Room)null===(n=this.messagePanel)||void 0===n||n.jumpToLiveTimeline()}})),i()(this,"onRoomTimeline",((e,t,a,n,i)=>{var s;this.unmounted||t&&t.roomId===(null===(s=this.state.room)||void 0===s?void 0:s.roomId)&&i.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&("org.matrix.room.preview_urls"===e.getType()&&this.updatePreviewUrlVisibility(t),"m.room.encryption"===e.getType()&&(this.updateE2EStatus(t),this.updatePreviewUrlVisibility(t)),!a&&null!=i&&i.liveEvent&&(this.state.joining||(e.isBeingDecrypted()||e.isDecryptionFailure()||this.handleEffects(e),e.getSender()!==this.context.client.getSafeUserId()&&(!this.state.search&&this.state.atEndOfLiveTimeline||Object(Ta.a)(e,this.state)||this.setState((e=>({numUnreadMessages:e.numUnreadMessages+1})))),"m.room.join_rules"===e.getType()&&this.recalculateUserNameColorMode())))})),i()(this,"onEventDecrypted",(e=>{this.state.room&&this.state.matrixClientIsReady&&e.getRoomId()===this.state.room.roomId&&(this.updateVisibleDecryptionFailures(),e.isDecryptionFailure()||this.handleEffects(e))})),i()(this,"handleEffects",(e=>{this.context.roomNotificationStateStore.getRoomState(this.state.room).isUnread&&xn.CHAT_EFFECTS.forEach((t=>{(Object(jn.containsEmoji)(e.getContent(),t.emojis)||e.getContent().msgtype===t.msgType)&&(e.isRelation(Ra.d.name)||b.a.dispatch({action:`effects.${t.command}`}))}))})),i()(this,"recalculateUserNameColorMode",(()=>{const e=this.state.room;if(!e)return;const t=e.currentState.getStateEvents("m.room.join_rules",""),a="public"===(t&&t.getContent().join_rule),n=!!Xa.a.shared().getUserIdForRoomId(e.roomId);let i;i=a?v.b.getValue("userNameColorModePublic"):n?v.b.getValue("userNameColorModeDM"):v.b.getValue("userNameColorModeGroup"),i!==this.state.userNameColorMode&&this.setState({userNameColorMode:i})})),i()(this,"onRoomName",(e=>{this.state.room&&e.roomId==this.state.room.roomId&&this.forceUpdate()})),i()(this,"onKeyBackupStatus",(()=>{this.forceUpdate()})),i()(this,"canResetTimeline",(()=>!this.messagePanel||this.messagePanel.canResetTimeline())),i()(this,"loadVirtualRoom",(async e=>{const t=(null==e?void 0:e.roomId)&&await Cd.a.sharedInstance().getVirtualRoomForRoom(null==e?void 0:e.roomId);this.setState({virtualRoom:t||void 0})})),i()(this,"onRoomLoaded",(e=>{this.unmounted||(this.context.widgetLayoutStore.on(rn.d.emissionForRoom(e),this.onWidgetLayoutChange),this.calculatePeekRules(e),this.updatePreviewUrlVisibility(e),this.loadMembersIfJoined(e),this.calculateRecommendedVersion(e),this.updateE2EStatus(e),this.updatePermissions(e),this.checkWidgets(e),this.loadVirtualRoom(e),this.getMainSplitContentType(e)!==Md.Timeline&&this.context.roomNotificationStateStore.getRoomState(e).isUnread&&this.context.rightPanelStore.setCard({phase:La.a.Timeline},!0,e.roomId),this.setState({tombstone:this.getRoomTombstone(e),liveTimeline:e.getLiveTimeline()}))})),i()(this,"onRoomTimelineReset",(e=>{var t;e&&e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&e.getLiveTimeline()!==this.state.liveTimeline&&(Oa.a.log(`Live timeline of ${e.roomId} was reset`),this.setState({liveTimeline:e.getLiveTimeline()}))})),i()(this,"onRoom",(e=>{e&&e.roomId===this.state.roomId&&(this.state.room&&this.context.widgetLayoutStore.off(rn.d.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.setState({room:e},(()=>{this.onRoomLoaded(e)})))})),i()(this,"onDeviceVerificationChanged",(e=>{const t=this.state.room;null!=t&&t.currentState.getMember(e)&&this.updateE2EStatus(t)})),i()(this,"onUserVerificationChanged",(e=>{const t=this.state.room;t&&t.currentState.getMember(e)&&this.updateE2EStatus(t)})),i()(this,"onCrossSigningKeysChanged",(()=>{const e=this.state.room;e&&this.updateE2EStatus(e)})),i()(this,"onUrlPreviewsEnabledChange",(()=>{this.state.room&&this.updatePreviewUrlVisibility(this.state.room)})),i()(this,"onAccountData",(e=>{"m.direct"===e.getType()&&this.recalculateUserNameColorMode()})),i()(this,"onRoomStateEvents",((e,t)=>{if(this.state.room&&this.state.room.roomId===t.roomId)if(e.getType()===ee.b.RoomTombstone)this.setState({tombstone:this.getRoomTombstone()});else this.updatePermissions(this.state.room)})),i()(this,"onRoomStateUpdate",(e=>{var t;e.roomId===(null===(t=this.state.room)||void 0===t?void 0:t.roomId)&&this.updateRoomMembers()})),i()(this,"onMyMembership",((e,t,a)=>{e.roomId===this.state.roomId&&(this.forceUpdate(),this.loadMembersIfJoined(e),this.updatePermissions(e))})),i()(this,"updateRoomMembers",Object(j.throttle)((()=>{this.updateDMState(),this.updateE2EStatus(this.state.room)}),500,{leading:!0,trailing:!0})),i()(this,"onInviteClick",(()=>{b.a.dispatch({action:"view_invite",roomId:this.state.room.roomId})})),i()(this,"onJoinButtonClicked",(()=>{var e;null!==(e=this.context.client)&&void 0!==e&&e.isGuest()?(b.a.dispatch({action:L.a.DoAfterSyncPrepared,deferred_action:{action:L.a.ViewRoom,room_id:this.getRoomId(),metricsTrigger:void 0}}),b.a.dispatch({action:"require_registration"})):Promise.resolve().then((()=>{var e,t;const a=null===(e=this.props.threepidInvite)||void 0===e?void 0:e.signUrl;return b.a.dispatch({action:L.a.JoinRoom,roomId:this.getRoomId(),opts:{inviteSignUrl:a},metricsTrigger:"invite"===(null===(t=this.state.room)||void 0===t?void 0:t.getMyMembership())?"Invite":"RoomPreview"}),Promise.resolve()}))})),i()(this,"updateVisibleDecryptionFailures",Object(j.throttle)((()=>this.setState((e=>{var t,a,n,i;return{visibleDecryptionFailures:null!==(t=null===(a=this.messagePanel)||void 0===a?void 0:a.getVisibleDecryptionFailures((null!==(n=null===(i=e.visibleDecryptionFailures)||void 0===i?void 0:i.length)&&void 0!==n?n:0)>0))&&void 0!==t?t:[]}}))),500,{leading:!1,trailing:!0})),i()(this,"onMessageListScroll",(()=>{var e;null!==(e=this.messagePanel)&&void 0!==e&&e.isAtEndOfLiveTimeline()?this.setState({numUnreadMessages:0,atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.updateTopUnreadMessagesBar(),this.updateVisibleDecryptionFailures()})),i()(this,"resetJumpToEvent",(e=>{this.state.initialEventId&&this.state.initialEventScrollIntoView&&this.state.initialEventId===e&&(Pd("Removing scroll_into_view flag from initial event"),b.a.dispatch({action:L.a.ViewRoom,room_id:this.state.room.roomId,event_id:this.state.initialEventId,highlighted:this.state.isInitialEventHighlighted,scroll_into_view:!1,replyingToEvent:this.state.replyToEvent,metricsTrigger:void 0}))})),i()(this,"onSearch",((e,t)=>{const a=t===Wr.Room?this.state.room.roomId:void 0;Pd("sending search request");const n=new AbortController,i=function(e,t,a){return null===Hs.a.get()?ud(e,t,a):yd(e,t,a)}(e,a,n.signal);this.setState({search:{searchId:(new Date).getTime(),roomId:a,term:e,scope:t,promise:i,abortController:n}})})),i()(this,"onSearchUpdate",((e,t)=>{this.setState({search:Nd(Nd({},this.state.search),{},{count:null==t?void 0:t.count,inProgress:e})})})),i()(this,"onAppsClick",(()=>{b.a.dispatch({action:"appsDrawer",show:!this.state.showApps})})),i()(this,"onForgetClick",(()=>{b.a.dispatch({action:"forget_room",room_id:this.state.room.roomId})})),i()(this,"onRejectButtonClicked",(()=>{this.setState({rejecting:!0}),this.context.client.leave(this.state.roomId).then((()=>{b.a.dispatch({action:L.a.ViewHomePage}),this.setState({rejecting:!1})}),(e=>{Oa.a.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e);z.b.createDialog(sn.a,{title:Object(N.b)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})}))})),i()(this,"onRejectAndIgnoreClick",(async()=>{this.setState({rejecting:!0});try{const e=this.state.room.getMember(this.context.client.getUserId()).events.member,t=this.context.client.getIgnoredUsers();t.push(e.getSender()),await this.context.client.setIgnoredUsers(t),await this.context.client.leave(this.state.roomId),b.a.dispatch({action:L.a.ViewHomePage}),this.setState({rejecting:!1})}catch(e){Oa.a.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e);z.b.createDialog(sn.a,{title:Object(N.b)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})}})),i()(this,"onRejectThreepidInviteButtonClicked",(()=>{b.a.fire(L.a.ViewRoomDirectory)})),i()(this,"onSearchClick",(()=>{this.setState({timelineRenderingType:this.state.timelineRenderingType===en.a.Search?en.a.Room:en.a.Search})})),i()(this,"onCancelSearchClick",(()=>new Promise((e=>{this.setState({timelineRenderingType:en.a.Room,search:void 0},e)})))),i()(this,"jumpToLiveTimeline",(()=>{var e;this.state.initialEventId&&this.state.isInitialEventHighlighted?b.a.dispatch({action:L.a.ViewRoom,room_id:this.state.room.roomId,metricsTrigger:void 0}):(null===(e=this.messagePanel)||void 0===e||e.jumpToLiveTimeline(),b.a.fire(L.a.FocusSendMessageComposer))})),i()(this,"jumpToReadMarker",(()=>{var e;null===(e=this.messagePanel)||void 0===e||e.jumpToReadMarker()})),i()(this,"forgetReadMarker",(e=>{var t;e.stopPropagation(),null===(t=this.messagePanel)||void 0===t||t.forgetReadMarker()})),i()(this,"updateTopUnreadMessagesBar",(()=>{if(!this.messagePanel)return;const e=this.messagePanel.canJumpToReadMarker();this.state.showTopUnreadMessagesBar!=e&&this.setState({showTopUnreadMessagesBar:e})})),i()(this,"onResize",(()=>{if(this.state.layout==io.a.Bubble&&this.state.adaptiveSideBubbles&&this.roomView.current){const e=this.roomView.current.getElementsByClassName("mx_RoomView_MessageList");let t=0;for(let a=0;a<e.length;a++){const n=e[a].getBoundingClientRect();n.width>t&&(t=n.width)}t<1280?this.setState({singleSideBubbles:!1}):this.setState({singleSideBubbles:!0})}})),i()(this,"onStatusBarVisible",(()=>{this.unmounted||this.state.statusBarVisible||this.setState({statusBarVisible:!0})})),i()(this,"onStatusBarHidden",(()=>{!this.unmounted&&this.state.statusBarVisible&&this.setState({statusBarVisible:!1})})),i()(this,"handleScrollKey",(e=>{var t;let a;this.searchResultsPanel.current?a=this.searchResultsPanel.current:this.messagePanel&&(a=this.messagePanel),null===(t=a)||void 0===t||t.handleScrollKey(e)})),i()(this,"gatherTimelinePanelRef",(e=>{this.messagePanel=e})),i()(this,"onHiddenHighlightsClick",(()=>{const e=this.getOldRoom();e&&b.a.dispatch({action:L.a.ViewRoom,room_id:e.roomId,metricsTrigger:"Predecessor"})})),i()(this,"onFileDrop",(e=>{var t,a;return Pa.a.sharedInstance().sendContentListToRoom(Array.from(e.files),null!==(t=null===(a=this.state.room)||void 0===a?void 0:a.roomId)&&void 0!==t?t:this.state.roomId,null,this.context.client,en.a.Room)})),i()(this,"onMeasurement",(e=>{this.setState({narrow:e})})),!t.client)throw new Error("Unable to create RoomView without MatrixClient");const o=t.client.hasLazyLoadMembersEnabled();this.state={roomId:void 0,roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!o,numUnreadMessages:0,callState:void 0,activeCall:null,canPeek:!1,canSelfRedact:!1,showApps:!1,isPeeking:!1,showRightPanel:!1,joining:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canSendMessages:!1,resizing:!1,layout:v.b.getValue("layout"),singleSideBubbles:v.b.getValue("singleSideBubbles"),adaptiveSideBubbles:v.b.getValue("adaptiveSideBubbles"),userNameColorMode:id.a.Uniform,youtubeEmbedPlayer:v.b.getValue("youtubeEmbedPlayer"),lowBandwidth:v.b.getValue("lowBandwidth"),alwaysShowTimestamps:v.b.getValue("alwaysShowTimestamps"),showTwelveHourTimestamps:v.b.getValue("showTwelveHourTimestamps"),readMarkerInViewThresholdMs:v.b.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:v.b.getValue("readMarkerOutOfViewThresholdMs"),showHiddenEvents:v.b.getValue("showHiddenEventsInTimeline"),showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:null===(n=t.client)||void 0===n?void 0:n.isInitialSyncComplete(),mainSplitContentType:Md.Timeline,timelineRenderingType:en.a.Room,liveTimeline:void 0,narrow:!1,visibleDecryptionFailures:[],msc3946ProcessDynamicPredecessor:v.b.getValue("feature_dynamic_room_predecessors")},this.dispatcherRef=b.a.register(this.onAction),t.client.on(r.b.Room,this.onRoom),t.client.on(te.d.Timeline,this.onRoomTimeline),t.client.on(te.d.TimelineReset,this.onRoomTimelineReset),t.client.on(te.d.Name,this.onRoomName),t.client.on(m.b.Events,this.onRoomStateEvents),t.client.on(m.b.Update,this.onRoomStateUpdate),t.client.on(te.d.MyMembership,this.onMyMembership),t.client.on(r.b.AccountData,this.onAccountData),t.client.on(ka.b.KeyBackupStatus,this.onKeyBackupStatus),t.client.on(ka.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),t.client.on(ka.b.UserTrustStatusChanged,this.onUserVerificationChanged),t.client.on(ka.b.KeysChanged,this.onCrossSigningKeysChanged),t.client.on(ja.c.Decrypted,this.onEventDecrypted),t.roomViewStore.on(Et.b,this.onRoomViewStoreUpdate),t.rightPanelStore.on(Et.b,this.onRightPanelStoreUpdate),Sr.a.on(Et.b,this.onWidgetEchoStoreUpdate),t.widgetStore.on(Et.b,this.onWidgetStoreUpdate),fc.a.instance.on(fc.b.ActiveCalls,this.onActiveCalls),this.props.resizeNotifier.on("isResizing",this.onIsResizing),this.settingWatchers=[v.b.watchSetting("layout",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({layout:i})})),v.b.watchSetting("singleSideBubbles",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({singleSideBubbles:i})})),v.b.watchSetting("adaptiveSideBubbles",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({adaptiveSideBubbles:i,singleSideBubbles:v.b.getValue("singleSideBubbles")})})),v.b.watchSetting("userNameColorModeDM",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.recalculateUserNameColorMode()})),v.b.watchSetting("userNameColorModeGroup",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.recalculateUserNameColorMode()})),v.b.watchSetting("userNameColorModePublic",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.recalculateUserNameColorMode()})),v.b.watchSetting("youtubeEmbedPlayer",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({youtubeEmbedPlayer:i})})),v.b.watchSetting("lowBandwidth",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({lowBandwidth:i})})),v.b.watchSetting("alwaysShowTimestamps",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({alwaysShowTimestamps:i})})),v.b.watchSetting("showTwelveHourTimestamps",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showTwelveHourTimestamps:i})})),v.b.watchSetting("readMarkerInViewThresholdMs",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({readMarkerInViewThresholdMs:i})})),v.b.watchSetting("readMarkerOutOfViewThresholdMs",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({readMarkerOutOfViewThresholdMs:i})})),v.b.watchSetting("showHiddenEventsInTimeline",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({showHiddenEvents:i})})),v.b.watchSetting("urlPreviewsEnabled",null,this.onUrlPreviewsEnabledChange),v.b.watchSetting("urlPreviewsEnabled_e2ee",null,this.onUrlPreviewsEnabledChange),v.b.watchSetting("feature_dynamic_room_predecessors",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,i]=t;return a.setState({msc3946ProcessDynamicPredecessor:i})}))]}doMaybeRemoveOwnJitsiWidget(){if(!this.state.roomId||!this.state.room||!this.context.client)return;const e=this.context.widgetStore.getApps(this.state.roomId).filter((e=>e.eventId&&on.a.JITSI.matches(e.type)));if(e.length<2)return;const t=this.context.client.getSafeUserId(),a=e.find((e=>e.creatorUserId===t));if(!a)return;const n=this.state.room.findEventById(a.eventId);if(!n)return;const i=n.getTs();if(!i)return;const s=e.reduce(((e,t)=>{var n;if(t.eventId===a.eventId)return e;const i=(null===(n=this.state.room.findEventById(t.eventId))||void 0===n?void 0:n.getTs())||0;return Math.max(e,i)}),0);s&&i>s&&i-s<3e4&&Ka.a.setRoomWidget(this.state.roomId,a.id)}getPermalinkCreatorForRoom(e){return this.permalinkCreators[e.roomId]||(this.permalinkCreators[e.roomId]=new Na.a(e),this.state.room&&e.roomId===this.state.room.roomId?this.permalinkCreators[e.roomId].start():this.permalinkCreators[e.roomId].load()),this.permalinkCreators[e.roomId]}stopAllPermalinkCreators(){if(this.permalinkCreators)for(const e of Object.keys(this.permalinkCreators))this.permalinkCreators[e].stop()}setupRoom(e,t,a,n){var i;if(!a&&t)if(!e&&n)Oa.a.info("Attempting to peek into room %s",t),this.setState({peekLoading:!0,isPeeking:!0}),null===(i=this.context.client)||void 0===i||i.peekInRoom(t).then((e=>{this.unmounted||(this.setState({room:e,peekLoading:!1}),this.onRoomLoaded(e))})).catch((e=>{if(!this.unmounted){if(this.setState({isPeeking:!1}),"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode&&"M_FORBIDDEN"!==e.errcode)throw e;this.setState({peekLoading:!1})}}));else if(e){var s;null===(s=this.context.client)||void 0===s||s.stopPeeking(),this.setState({isPeeking:!1})}}shouldShowApps(e){if(!Dd||!e)return!1;const t=e.roomId+"_hide_widget_drawer",a=localStorage.getItem(t),n=!a||"false"===a,i=this.context.widgetLayoutStore.getContainerWidgets(e,rn.a.Top);return n&&i.length>0}componentDidMount(){this.onRoomViewStoreUpdate(!0);const e=this.getCallForRoom(),t=null==e?void 0:e.state;this.setState({callState:t}),this.context.legacyCallHandler.on(B.a.CallState,this.onCallState),window.addEventListener("beforeunload",this.onPageUnload),this.props.resizeNotifier&&this.props.resizeNotifier.on("middlePanelResized",this.onResize),this.onResize(),this.recalculateUserNameColorMode()}shouldComponentUpdate(e,t){const a=Object(yn.c)(this.props,e),n=this.state,{upgradeRecommendation:i}=n,s=ve()(n,Rd),{upgradeRecommendation:o}=t,r=ve()(t,Id),l=(null==o?void 0:o.needsUpgrade)!==(null==i?void 0:i.needsUpgrade)||Object(yn.c)(s,r);return a||l}componentDidUpdate(){this.messagePanel&&void 0===this.state.atEndOfLiveTimeline&&this.setState({atEndOfLiveTimeline:this.messagePanel.isAtEndOfLiveTimeline()}),this.onResize(),this.recalculateUserNameColorMode()}componentWillUnmount(){var e,t;(this.unmounted=!0,this.context.legacyCallHandler.removeListener(B.a.CallState,this.onCallState),this.state.roomId&&_r.setScrollState(this.state.roomId,this.getScrollState()),this.state.shouldPeek)&&(null===(e=this.context.client)||void 0===e||e.stopPeeking());this.stopAllPermalinkCreators(),b.a.unregister(this.dispatcherRef),this.context&&(this.context.client.removeListener(r.b.Room,this.onRoom),this.context.client.removeListener(te.d.Timeline,this.onRoomTimeline),this.context.client.removeListener(te.d.TimelineReset,this.onRoomTimelineReset),this.context.client.removeListener(te.d.Name,this.onRoomName),this.context.client.removeListener(m.b.Events,this.onRoomStateEvents),this.context.client.removeListener(te.d.MyMembership,this.onMyMembership),this.context.client.removeListener(m.b.Update,this.onRoomStateUpdate),this.context.client.removeListener(r.b.AccountData,this.onAccountData),this.context.client.removeListener(ka.b.KeyBackupStatus,this.onKeyBackupStatus),this.context.client.removeListener(ka.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),this.context.client.removeListener(ka.b.UserTrustStatusChanged,this.onUserVerificationChanged),this.context.client.removeListener(ka.b.KeysChanged,this.onCrossSigningKeysChanged),this.context.client.removeListener(ja.c.Decrypted,this.onEventDecrypted)),window.removeEventListener("beforeunload",this.onPageUnload),this.props.resizeNotifier&&this.props.resizeNotifier.removeListener("middlePanelResized",this.onResize),this.context.roomViewStore.off(Et.b,this.onRoomViewStoreUpdate),this.context.rightPanelStore.off(Et.b,this.onRightPanelStoreUpdate),Sr.a.removeListener(Et.b,this.onWidgetEchoStoreUpdate),this.context.widgetStore.removeListener(Et.b,this.onWidgetStoreUpdate),this.props.resizeNotifier.off("isResizing",this.onIsResizing),this.state.room&&this.context.widgetLayoutStore.off(rn.d.emissionForRoom(this.state.room),this.onWidgetLayoutChange),fc.a.instance.off(fc.b.ActiveCalls,this.onActiveCalls),this.context.legacyCallHandler.off(B.a.CallState,this.onCallState),this.updateRoomMembers.cancel();for(const e of this.settingWatchers)v.b.unwatchSetting(e);this.viewsLocalRoom&&(null===(t=this.context.client)||void 0===t||t.store.removeRoom(this.state.room.roomId))}onLocalRoomEvent(e){e===this.state.room.roomId&&Object(ys.c)(this.context.client,this.state.room)}getRoomTombstone(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.state.room;return null!==(e=null==t?void 0:t.currentState.getStateEvents(ee.b.RoomTombstone,""))&&void 0!==e?e:void 0}async calculateRecommendedVersion(e){const t=await e.getRecommendedVersion();this.unmounted||this.setState({upgradeRecommendation:t})}async loadMembersIfJoined(e){var t;if(null!==(t=this.context.client)&&void 0!==t&&t.hasLazyLoadMembersEnabled()&&e&&"join"===e.getMyMembership())try{await e.loadMembersIfNeeded(),this.unmounted||this.setState({membersLoaded:!0})}catch(t){const a=`Fetching room members for ${e.roomId} failed. Room members will appear incomplete.`;Oa.a.error(a),Oa.a.error(t)}}calculatePeekRules(e){const t=e.currentState.getStateEvents(ee.b.RoomHistoryVisibility,"");this.setState({canPeek:(null==t?void 0:t.getContent().history_visibility)===Ia.b.WorldReadable})}updatePreviewUrlVisibility(e){let{roomId:t}=e;const a=this.context.client.isRoomEncrypted(t)?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled";this.setState({showUrlPreview:v.b.getValue(a,t)})}async updateE2EStatus(e){var t;if(null===(t=this.context.client)||void 0===t||!t.isRoomEncrypted(e.roomId))return;let a=Za.Warning;this.context.client.isCryptoEnabled()&&(a=await async function(e,t){const a=(await t.getEncryptionTargetMembers()).map((e=>{let{userId:t}=e;return t})),n=!!Xa.a.shared().getUserIdForRoomId(t.roomId),i=[],s=[];a.filter((t=>t!==e.getUserId())).forEach((t=>{(e.checkUserTrust(t).isCrossSigningVerified()?i:s).push(t)}));for(const t of s)if(e.checkUserTrust(t).wasCrossSigningVerified())return Za.Warning;const o=i.length>0&&!n&&2!==a.length||1===a.length?[...i,e.getUserId()]:i;for(const t of o)if(e.getStoredDevicesForUser(t).some((a=>{let{deviceId:n}=a;return!e.checkDeviceTrust(t,n).isVerified()})))return Za.Warning;return 0===s.length?Za.Verified:Za.Normal}(this.context.client,e)),this.unmounted||this.setState({e2eStatus:a})}updatePermissions(e){if(e){const t=this.context.client.getSafeUserId(),a="join"===e.getMyMembership()&&e.currentState.maySendEvent(ee.b.Reaction,t),n=e.maySendMessage(),i=e.currentState.maySendEvent(ee.b.RoomRedaction,t);this.setState({canReact:a,canSendMessages:n,canSelfRedact:i})}}checkDesktopNotifications(){this.state.room.getJoinedMemberCount()+this.state.room.getInvitedMemberCount()>1&&Oc.default.shouldShowPrompt()&&Object(Cc.b)(!0)}updateDMState(){const e=this.state.room;if("join"!==(null==e?void 0:e.getMyMembership()))return;const t=e.getDMInviter();t&&Da.f(e.roomId,t)}injectSticker(e,t,a,n){this.context.client&&(this.context.client.isGuest()?b.a.dispatch({action:"require_registration"}):Pa.a.sharedInstance().sendStickerContentToRoom(e,this.state.room.roomId,n,t,a,this.context.client).then(void 0,(e=>{e.name})))}getScrollState(){const e=this.messagePanel;if(!e)return null;if(this.state.atEndOfLiveTimeline)return null;const t=e.getScrollState();return!t||t.stuckAtBottom?null:{focussedEvent:t.trackedScrollToken,pixelOffset:t.pixelOffset}}getCallForRoom(){return this.state.room?this.context.legacyCallHandler.getCallForRoom(this.state.room.roomId):null}getOldRoom(){var e,t;const{roomId:a}=(null===(e=this.state.room)||void 0===e?void 0:e.findPredecessor(this.state.msc3946ProcessDynamicPredecessor))||{};return(null===(t=this.context.client)||void 0===t?void 0:t.getRoom(a))||null}getHiddenHighlightCount(){const e=this.getOldRoom();return e?e.getUnreadNotificationCount(te.b.Highlight):0}get messagePanelClassNames(){return c()("mx_RoomView_messagePanel",{mx_IRCLayout:this.state.layout===io.a.IRC,sc_BubbleLayout:this.state.layout===io.a.Bubble,sc_BubbleLayout_singleSide:this.state.layout===io.a.Bubble&&this.state.singleSideBubbles})}get viewsLocalRoom(){return Object(Lo.a)(this.state.room)}get permalinkCreator(){return this.getPermalinkCreatorForRoom(this.state.room)}renderLocalRoomCreateLoader(e){const t=this.state.room.getDefaultRoomName(this.context.client.getSafeUserId());return o.a.createElement(en.b.Provider,{value:this.state},o.a.createElement(Ud,{localRoom:e,names:t,resizeNotifier:this.props.resizeNotifier}))}renderLocalRoomView(e){return o.a.createElement(en.b.Provider,{value:this.state},o.a.createElement(Ad,{localRoom:e,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,roomView:this.roomView,onFileDrop:this.onFileDrop}))}renderWaitingForThirdPartyRoomView(e){return o.a.createElement(en.b.Provider,{value:this.state},o.a.createElement(kd,{resizeNotifier:this.props.resizeNotifier,roomView:this.roomView,inviteEvent:e}))}render(){var e,t;if(this.state.room instanceof td.b)return this.state.room.state===td.c.CREATING?this.renderLocalRoomCreateLoader(this.state.room):this.renderLocalRoomView(this.state.room);if(this.state.room){const{shouldEncrypt:e,inviteEvent:t}=Object(xd.a)(this.state.room);if(e)return this.renderWaitingForThirdPartyRoomView(t)}if(!this.state.room){const e=!this.state.matrixClientIsReady||this.state.roomLoading||this.state.peekLoading;if(e){const t=!this.state.matrixClientIsReady||!this.state.roomId||this.state.peekLoading;return o.a.createElement("div",{className:"mx_RoomView"},o.a.createElement(Or.a,null,o.a.createElement(Ir,{canPreview:!1,previewLoading:t&&!this.state.roomLoadError,error:this.state.roomLoadError,loading:e,joining:this.state.joining,oobData:this.props.oobData,roomId:this.state.roomId})))}{var a,n;let e;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(a=this.props.threepidInvite)||void 0===a?void 0:a.toEmail,i=this.state.roomAlias;return o.a.createElement("div",{className:"mx_RoomView"},o.a.createElement(Or.a,null,o.a.createElement(Ir,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,canPreview:!1,error:this.state.roomLoadError,roomAlias:i,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,signUrl:null===(n=this.props.threepidInvite)||void 0===n?void 0:n.signUrl,roomId:this.state.roomId})))}}const i=this.state.room.getMyMembership();if(ic(this.state.room)&&(!v.b.getValue("feature_video_rooms")||"join"!==i))return o.a.createElement(Or.a,null,o.a.createElement("div",{className:"mx_MainSplit"},o.a.createElement(Vr,{room:this.state.room,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.onRejectButtonClicked})),";");if("invite"===i&&!this.state.room.isSpaceRoom()){if(this.state.joining||this.state.rejecting)return o.a.createElement(Or.a,null,o.a.createElement(Ir,{canPreview:!1,error:this.state.roomLoadError,joining:this.state.joining,rejecting:this.state.rejecting,roomId:this.state.roomId}));{const e=this.context.client.getSafeUserId(),t=this.state.room.getMember(e),a=t?t.events.member:null;let n=Object(N.b)("Unknown");var s,r;if(a)n=null!==(s=null===(r=a.sender)||void 0===r?void 0:r.name)&&void 0!==s?s:a.getSender();return o.a.createElement("div",{className:"mx_RoomView"},o.a.createElement(Or.a,null,o.a.createElement(Ir,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectButtonClicked,onRejectAndIgnoreClick:this.onRejectAndIgnoreClick,inviterName:n,canPreview:!1,joining:this.state.joining,room:this.state.room,roomId:this.state.roomId})))}}let l,d=null;{const e=this.getCallForRoom();e&&"ended"!==this.state.callState&&"ringing"!==this.state.callState&&(d=e)}let m=!0;Pa.a.sharedInstance().getCurrentUploads().length>0?l=o.a.createElement($o,{room:this.state.room}):this.state.search||(m=this.state.statusBarVisible,l=o.a.createElement(Xc.a,{room:this.state.room,isPeeking:"join"!==i,onInviteClick:this.onInviteClick,onVisible:this.onStatusBarVisible,onHidden:this.onStatusBarHidden}));const h=c()("mx_RoomView_statusArea",{mx_RoomView_statusArea_expanded:m}),u=l&&o.a.createElement("div",{className:h},o.a.createElement("div",{className:"mx_RoomView_statusAreaBox"},o.a.createElement("div",{className:"mx_RoomView_statusAreaBox_line"}),l)),p=this.state.upgradeRecommendation,g=p&&p.needsUpgrade&&this.state.room.userMayUpgradeRoom(this.context.client.getSafeUserId()),b=this.getHiddenHighlightCount();let f,E;var y;if(this.state.timelineRenderingType===en.a.Search)f=o.a.createElement(zr,{searchInProgress:null===(y=this.state.search)||void 0===y?void 0:y.inProgress,onCancelClick:this.onCancelSearchClick,onSearch:this.onSearch,isRoomEncrypted:this.context.client.isRoomEncrypted(this.state.room.roomId)});else if(g)f=o.a.createElement(Kr,{room:this.state.room});else if("join"!==i){var _,S;let e;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(_=this.props.threepidInvite)||void 0===_?void 0:_.toEmail;if(E=o.a.createElement(Ir,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,canPreview:this.state.canPeek,room:this.state.room,roomId:this.state.roomId}),!(this.state.canPeek||null!==(S=this.state.room)&&void 0!==S&&S.isSpaceRoom()))return o.a.createElement("div",{className:"mx_RoomView"},E)}else b>0&&(f=o.a.createElement(K.a,{element:"div",className:"mx_RoomView_auxPanel_hiddenHighlights",onClick:this.onHiddenHighlightsClick},Object(N.b)("You have %(count)s unread notifications in a prior version of this room.",{count:b})));let w;if(this.state.visibleDecryptionFailures&&this.state.visibleDecryptionFailures.length>0&&(w=o.a.createElement($r,{failures:this.state.visibleDecryptionFailures})),null!==(e=this.state.room)&&void 0!==e&&e.isSpaceRoom()&&!this.props.forceTimeline)return o.a.createElement(Qc,{space:this.state.room,justCreatedOpts:this.props.justCreatedOpts,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.props.threepidInvite?this.onRejectThreepidInviteButtonClicked:this.onRejectButtonClicked});const O=o.a.createElement(Nl,{room:this.state.room,userId:this.context.client.getSafeUserId(),showApps:this.state.showApps,onResize:this.onResize,resizeNotifier:this.props.resizeNotifier},f,w);let C;let x;"join"===i&&!this.state.search&&(C=o.a.createElement(Ho,{room:this.state.room,e2eStatus:this.state.e2eStatus,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.permalinkCreator,layout:this.state.layout,userNameColorMode:this.state.userNameColorMode}));let j,k=!1;this.state.search&&(x=o.a.createElement(Od,{key:this.state.search.searchId,ref:this.searchResultsPanel,term:this.state.search.term,scope:this.state.search.scope,promise:this.state.search.promise,abortController:this.state.search.abortController,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,className:this.messagePanelClassNames,onUpdate:this.onSearchUpdate,layout:this.state.layout,singleSideBubbles:this.state.singleSideBubbles,userNameColorMode:this.state.userNameColorMode}),k=!0),this.state.isInitialEventHighlighted&&(j=this.state.initialEventId);const R=o.a.createElement(no,{ref:this.gatherTimelinePanelRef,timelineSet:this.state.room.getUnfilteredTimelineSet(),overlayTimelineSet:null===(t=this.state.virtualRoom)||void 0===t?void 0:t.getUnfilteredTimelineSet(),overlayTimelineSetFilter:Zs.d,showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!this.state.isPeeking,sendReadReceiptOnLoad:!this.state.wasContextSwitch,manageReadMarkers:!this.state.isPeeking,hidden:k,highlightedEventId:j,eventId:this.state.initialEventId,eventScrollIntoView:this.state.initialEventScrollIntoView,eventPixelOffset:this.state.initialEventPixelOffset,onScroll:this.onMessageListScroll,onEventScrolledIntoView:this.resetJumpToEvent,onReadMarkerUpdated:this.updateTopUnreadMessagesBar,showUrlPreview:this.state.showUrlPreview,className:this.messagePanelClassNames,membersLoaded:this.state.membersLoaded,permalinkCreator:this.permalinkCreator,resizeNotifier:this.props.resizeNotifier,showReactions:!0,layout:this.state.layout,singleSideBubbles:this.state.singleSideBubbles,userNameColorMode:this.state.userNameColorMode,youtubeEmbedPlayer:this.state.youtubeEmbedPlayer,editState:this.state.editState});let I,T;this.state.showTopUnreadMessagesBar&&!this.state.search&&(I=o.a.createElement(Zc,{onScrollUpClick:this.jumpToReadMarker,onCloseClick:this.forgetReadMarker})),!1!==this.state.atEndOfLiveTimeline||this.state.search||(T=o.a.createElement(pr,{highlight:this.state.room.getUnreadNotificationCount(te.b.Highlight)>0,numUnreadMessages:this.state.numUnreadMessages,onScrollToBottomClick:this.jumpToLiveTimeline}));const P=this.state.room&&this.state.showRightPanel?o.a.createElement(Er,{room:this.state.room,resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.permalinkCreator,userNameColorMode:this.state.userNameColorMode,e2eStatus:this.state.e2eStatus}):void 0,D=c()("mx_RoomView_timeline",{mx_RoomView_timeline_rr_enabled:this.state.showReadReceipts}),M=c()("mx_RoomView",{mx_RoomView_inCall:Boolean(d),mx_RoomView_immersive:this.state.mainSplitContentType!==Md.Timeline}),A=v.b.getValue("showChatEffects");let U,L;switch(this.state.mainSplitContentType){case Md.Timeline:L="mx_MainSplit_timeline",U=o.a.createElement(o.a.Fragment,null,this.roomViewBody.current&&o.a.createElement(so,{sensor:this.roomViewBody.current,onMeasurement:this.onMeasurement}),O,o.a.createElement("div",{className:D},o.a.createElement(Xo,{parent:this.roomView.current,onFileDrop:this.onFileDrop}),I,T,R,x),u,E,C);break;case Md.MaximisedWidget:L="mx_MainSplit_maximisedWidget",U=o.a.createElement(o.a.Fragment,null,o.a.createElement(sl,{room:this.state.room,userId:this.context.client.getSafeUserId(),resizeNotifier:this.props.resizeNotifier,showApps:!0}),E);break;case Md.Call:L="mx_MainSplit_call",U=o.a.createElement(o.a.Fragment,null,o.a.createElement(wc,{room:this.state.room,resizing:this.state.resizing,waitForCall:ic(this.state.room)}),E)}const F=c()("mx_RoomView_body",L);let B=[La.a.Timeline],V=this.onAppsClick,W=this.onForgetClick,z=this.onSearchClick,H=null,G=!1;switch(this.state.mainSplitContentType){case Md.MaximisedWidget:B=[La.a.ThreadPanel,La.a.PinnedMessages],V=null,W=null,z=null;break;case Md.Call:B=[La.a.ThreadPanel,La.a.PinnedMessages,La.a.NotificationPanel],ic(this.state.room)||(B.push(La.a.RoomSummary),null===this.state.activeCall&&B.push(La.a.Timeline)),V=null,W=null,z=null,this.state.room.canInvite(this.context.client.getSafeUserId())&&(H=this.onInviteClick),G=!0}return o.a.createElement(en.b.Provider,{value:this.state},o.a.createElement("main",{className:M,ref:this.roomView,onKeyDown:this.onReactKeyDown},A&&this.roomView.current&&o.a.createElement(vc,{roomWidth:this.roomView.current.offsetWidth}),o.a.createElement(Or.a,null,o.a.createElement(bc,{room:this.state.room,searchInfo:this.state.search,oobData:this.props.oobData,inRoom:"join"===i,onSearchClick:z,onInviteClick:H,onForgetClick:"leave"===i?W:null,e2eStatus:this.state.e2eStatus,onAppsClick:this.state.hasPinnedWidgets?V:null,appsShown:this.state.showApps,excludedRightPanelPhaseButtons:B,showButtons:!this.viewsLocalRoom,enableRoomOptionsMenu:!this.viewsLocalRoom,viewingCall:G,activeCall:this.state.activeCall}),o.a.createElement(Aa,{panel:P,resizeNotifier:this.props.resizeNotifier},o.a.createElement("div",{className:F,ref:this.roomViewBody,"data-layout":this.state.layout},U)))))}}i()(Ld,"contextType",at.a);var Fd=Ld;class Bd extends s.Component{constructor(e){super(e),i()(this,"onToastStoreUpdate",(()=>{this.setState({toasts:D.a.sharedInstance().getToasts(),countSeen:D.a.sharedInstance().getCountSeen()})})),this.state={toasts:D.a.sharedInstance().getToasts(),countSeen:D.a.sharedInstance().getCountSeen()},D.a.sharedInstance().on("update",this.onToastStoreUpdate)}componentWillUnmount(){D.a.sharedInstance().removeListener("update",this.onToastStoreUpdate)}render(){const e=this.state.toasts.length,t=e>1;let a,n;if(0!==e){const i=this.state.toasts[0],{title:o,icon:r,key:l,component:d,className:m,bodyClassName:h,props:u}=i,p=c()("mx_Toast_body",h),g=c()("mx_Toast_toast",m,{mx_Toast_hasIcon:r,[`mx_Toast_icon_${r}`]:r}),b=Object.assign({},u,{key:l,toastKey:l}),v=s.createElement(d,b);let f,E;(o&&t||this.state.countSeen>0)&&(f=` (${this.state.countSeen+1}/${this.state.countSeen+e})`),o&&(E=s.createElement("div",{className:"mx_Toast_title"},s.createElement("h2",null,o),s.createElement("span",{className:"mx_Toast_title_countIndicator"},f))),a=s.createElement("div",{className:g},E,s.createElement("div",{className:p},v)),n=c()("mx_ToastContainer",{mx_ToastContainer_stacked:t})}return a?s.createElement("div",{className:n,role:"alert"},a):null}}class Vd extends o.a.Component{constructor(e){super(e),this.state={loading:!0}}componentDidMount(){this.props.userId&&this.loadProfileInfo()}componentDidUpdate(e){e.userId!==this.props.userId&&this.props.userId&&this.loadProfileInfo()}async loadProfileInfo(){const e=oe.a.get();let t;this.setState({loading:!0});try{t=await e.getProfileInfo(this.props.userId)}catch(e){return z.b.createDialog(sn.a,{title:Object(N.b)("Could not load user profile"),description:e&&e.message?e.message:Object(N.b)("Operation failed")}),void this.setState({loading:!1})}const a=new ja.b({type:"m.room.member",content:t}),n=new Ua.a(null,this.props.userId);n.setMembershipEvent(a),this.setState({member:n,loading:!1})}render(){if(this.state.loading)return o.a.createElement(Zn.a,null);if(this.state.member){const e=o.a.createElement(Er,{overwriteCard:{phase:La.a.RoomMemberInfo,state:{member:this.state.member}},resizeNotifier:this.props.resizeNotifier});return o.a.createElement(Aa,{panel:e,resizeNotifier:this.props.resizeNotifier},o.a.createElement(pa.a,null))}return o.a.createElement("div",null)}}var Wd=e=>{let{backgroundImage:t,blurMultiplier:a}=e;return null},zd=a(651);var Hd=e=>{let{isMinimized:t}=e;const a=Object(ie.b)(Ql.a.instance,Ql.b.MonitoringLivePosition,(()=>Ql.a.instance.isMonitoringLiveLocation)),n=Object(ie.b)(Ql.a.instance,Ql.b.LocationPublishError,(()=>Ql.a.instance.getLiveBeaconIdsWithLocationPublishError())),i=Object(ie.b)(Ql.a.instance,Ql.b.BeaconUpdateError,(()=>Ql.a.instance.getLiveBeaconIds().filter((e=>Ql.a.instance.beaconUpdateErrors.has(e))))),r=Object(ie.b)(Ql.a.instance,Ql.b.LivenessChange,(()=>Ql.a.instance.getLiveBeaconIds())),l=!!n.length,d=!!i.length;if(((e,t)=>{Object(s.useEffect)((()=>{const a=()=>{"visible"===document.visibilityState&&e.forEach((e=>{var a;return null===(a=t.get(e))||void 0===a?void 0:a.monitorLiveness()}))};return e.length&&document.addEventListener("visibilitychange",a),()=>{document.removeEventListener("visibilitychange",a)}}),[e,t])})(r,Ql.a.instance.beacons),!a)return null;const m=((e,t,a)=>{var n,i;const s=null!==(n=null!==(i=null==t?void 0:t[0])&&void 0!==i?i:null==a?void 0:a[0])&&void 0!==n?n:null==e?void 0:e[0];if(!s)return;return Ql.a.instance.getBeaconById(s)})(r,i,n),h=m?e=>{b.a.dispatch({action:L.a.ViewRoom,room_id:m.roomId,metricsTrigger:void 0,event_id:m.beaconInfoId,scroll_into_view:!0,highlighted:!0})}:null,u=((e,t)=>e?Object(N.b)("An error occurred while stopping your live location"):t?Object(N.b)("An error occurred whilst sharing your live location"):Object(N.b)("You are sharing your live location"))(d,l);return o.a.createElement(K.a,{className:c()("mx_LeftPanelLiveShareWarning",{mx_LeftPanelLiveShareWarning__minimized:t,mx_LeftPanelLiveShareWarning__error:l||d}),title:t?u:void 0,onClick:h},t?o.a.createElement(zd.a,{height:10}):u)},Kd=a(1712),Gd=a(639);class qd extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"room",void 0),this.room=t.getRoom(this.props.persistentRoomId)}render(){const e=Qa.a.instance.get(this.props.persistentWidgetId,this.props.persistentRoomId);return e?o.a.createElement(Qi,{key:e.id,app:e,fullWidth:!0,room:this.room,userId:this.context.getSafeUserId(),creatorUserId:e.creatorUserId,widgetPageTitle:Ka.a.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,miniMode:!0,showMenubar:!1,pointerEvents:this.props.pointerEvents,movePersistedElement:this.props.movePersistedElement}):null}}i()(qd,"contextType",R.a);var $d,Yd,Jd=a(983);function Qd(){return Qd=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Qd.apply(this,arguments)}function Xd(e){return s.createElement("svg",Qd({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),$d||($d=s.createElement("path",{d:"M8.027 15.961c1.141 1.232 3.888 3.365 4.637 3.803l.151.09c1.143.679 4.722 2.807 7.33.815 2.021-1.542 1.364-3.278.684-3.794-.466-.362-1.838-1.36-3.128-2.26-1.268-.883-1.974-.175-2.452.303l-.026.026-.96.961c-.246.245-.618.156-.974-.125a26.02 26.02 0 01-2.692-2.385l-.004-.004c-.47-.47-1.4-1.4-2.373-2.68-.28-.356-.37-.728-.125-.973l.96-.961.027-.026c.478-.478 1.186-1.184.303-2.452-.9-1.29-1.898-2.662-2.26-3.128-.516-.68-2.252-1.337-3.794.684-1.992 2.608.136 6.187.815 7.33l.09.151c.438.75 2.56 3.484 3.791 4.625z",fill:"currentColor"})),Yd||(Yd=s.createElement("path",{d:"M20.697 3.078a.638.638 0 000-.893.615.615 0 00-.88 0L17 5.045l-2.817-2.86a.615.615 0 00-.88 0 .638.638 0 000 .893l2.817 2.86-2.938 2.984a.638.638 0 000 .893.615.615 0 00.88 0L17 6.832l2.938 2.983a.615.615 0 00.88 0 .638.638 0 000-.893L17.88 5.939l2.817-2.86z",fill:"currentColor"})))}const Zd=e=>{let{widgetId:t,room:a,viewingRoom:n,onStartMoving:i,movePersistedElement:r}=e;const l=Object(s.useMemo)((()=>Qa.a.instance.getApps(a.roomId).find((e=>e.id===t))),[a,t]),c=Object(ie.d)(a,te.d.Name,Object(s.useCallback)((()=>a.name),[a])),d=Object(sc.b)(t,a.roomId),m=Object(s.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),null!==d?b.a.dispatch({action:L.a.ViewRoom,room_id:a.roomId,view_call:!0,metricsTrigger:"WebFloatingCallWindow"}):n?rn.d.instance.moveToContainer(a,l,rn.a.Center):b.a.dispatch({action:L.a.ViewRoom,room_id:a.roomId,metricsTrigger:"WebFloatingCallWindow"})}),[a,d,l,n]),h=Object(s.useCallback)((e=>{var t;(e.preventDefault(),e.stopPropagation(),null!==d)?d.disconnect().catch((e=>console.error("Failed to leave call",e))):null===(t=nn.a.instance.getMessagingForUid(Ka.a.getWidgetUid(l)))||void 0===t||t.transport.send(ln.a.HangupCall,{}).catch((e=>console.error("Failed to leave Jitsi",e)))}),[d,l]);return o.a.createElement("div",{className:"mx_WidgetPip",onMouseDown:i,onClick:m},o.a.createElement(da.a,{className:"mx_WidgetPip_header"},o.a.createElement(je.a,{onClick:m,className:"mx_WidgetPip_backButton","aria-label":Object(N.b)("Back")},o.a.createElement(Jd.a,{className:"mx_Icon mx_Icon_16"}),c)),o.a.createElement(qd,{persistentWidgetId:t,persistentRoomId:a.roomId,pointerEvents:"none",movePersistedElement:r}),(null!==d||on.a.JITSI.matches(l.type))&&o.a.createElement(da.a,{className:"mx_WidgetPip_footer"},o.a.createElement(je.b,{onClick:h,tooltip:Object(N.b)("Leave"),"aria-label":Object(N.b)("Leave"),alignment:Ao.a.Top},o.a.createElement(Xd,{className:"mx_Icon mx_Icon_24"}))))},em=[Sa.f.Connected,Sa.f.InviteSent,Sa.f.Connecting,Sa.f.CreateAnswer,Sa.f.CreateOffer,Sa.f.WaitLocalMedia];function tm(e){if(!e)return[null,[]];const t=B.b.instance.getAllActiveCallsForPip(e);let a=null,n=[];for(const e of t)em.includes(e.state)&&(e.isRemoteOnHold()||null!==a?n.push(e):a=e);return null===a&&n.length>0&&(a=n[0],n=n.slice(1)),n.length>1&&Oa.a.log("Found more than 1 secondary call! Other calls will not be shown."),[a,n]}class am extends o.a.Component{constructor(e){super(e),i()(this,"onMove",(()=>{var e,t;return null===(e=(t=this.props.movePersistedElement).current)||void 0===e?void 0:e.call(t)})),i()(this,"onRoomViewStoreUpdate",(()=>{var e,t;const a=at.b.instance.roomViewStore.getRoomId(),n=this.state.viewedRoomId;if(a===n)return;const i=null===(e=oe.a.get())||void 0===e?void 0:e.getRoom(n);i&&rn.d.instance.off(rn.d.emissionForRoom(i),this.updateCalls);const s=null===(t=oe.a.get())||void 0===t?void 0:t.getRoom(a||void 0);if(s&&rn.d.instance.on(rn.d.emissionForRoom(s),this.updateCalls),!a)return;const[o,r]=tm(a);this.setState({viewedRoomId:a,primaryCall:o,secondaryCall:r[0]}),this.updateShowWidgetInPip()})),i()(this,"onWidgetPersistence",(()=>{this.updateShowWidgetInPip()})),i()(this,"onWidgetDockChanges",(()=>{this.updateShowWidgetInPip()})),i()(this,"updateCalls",(()=>{if(!this.state.viewedRoomId)return;const[e,t]=tm(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]}),this.updateShowWidgetInPip()})),i()(this,"onCallRemoteHold",(()=>{if(!this.state.viewedRoomId)return;const[e,t]=tm(this.state.viewedRoomId);this.setState({primaryCall:e,secondaryCall:t[0]})})),i()(this,"onDoubleClick",(()=>{var e;const t=null===(e=this.state.primaryCall)||void 0===e?void 0:e.roomId;(null!=t?t:this.state.persistentRoomId)&&b.a.dispatch({action:L.a.ViewRoom,room_id:null!=t?t:this.state.persistentRoomId,metricsTrigger:"WebFloatingCallWindow"})}));const t=at.b.instance.roomViewStore.getRoomId(),[a,n]=tm(t);this.state={viewedRoomId:t||void 0,primaryCall:a||null,secondaryCall:n[0],persistentWidgetId:Tn.b.instance.getPersistentWidgetId(),persistentRoomId:Tn.b.instance.getPersistentRoomId(),showWidgetInPip:!1}}componentDidMount(){var e;B.b.instance.addListener(B.a.CallChangeRoom,this.updateCalls),B.b.instance.addListener(B.a.CallState,this.updateCalls),at.b.instance.roomViewStore.addListener(Et.b,this.onRoomViewStoreUpdate),oe.a.get().on(Sa.d.RemoteHoldUnhold,this.onCallRemoteHold);const t=null===(e=oe.a.get())||void 0===e?void 0:e.getRoom(this.state.viewedRoomId);t&&rn.d.instance.on(rn.d.emissionForRoom(t),this.updateCalls),Tn.b.instance.on(Tn.a.Persistence,this.onWidgetPersistence),Tn.b.instance.on(Tn.a.Dock,this.onWidgetDockChanges),Tn.b.instance.on(Tn.a.Undock,this.onWidgetDockChanges)}componentWillUnmount(){B.b.instance.removeListener(B.a.CallChangeRoom,this.updateCalls),B.b.instance.removeListener(B.a.CallState,this.updateCalls);const e=oe.a.get();null==e||e.removeListener(Sa.d.RemoteHoldUnhold,this.onCallRemoteHold),at.b.instance.roomViewStore.removeListener(Et.b,this.onRoomViewStoreUpdate);const t=null==e?void 0:e.getRoom(this.state.viewedRoomId);t&&rn.d.instance.off(rn.d.emissionForRoom(t),this.updateCalls),Tn.b.instance.off(Tn.a.Persistence,this.onWidgetPersistence),Tn.b.instance.off(Tn.a.Dock,this.onWidgetDockChanges),Tn.b.instance.off(Tn.a.Undock,this.onWidgetDockChanges)}updateShowWidgetInPip(){const e=Tn.b.instance.getPersistentWidgetId(),t=Tn.b.instance.getPersistentRoomId();let a=!1,n=!1;e&&oe.a.get().getRoom(t)&&(n=!Tn.b.instance.isDocked(e,t),a=this.state.viewedRoomId!==t);const i=a||n;this.setState({showWidgetInPip:i,persistentWidgetId:e,persistentRoomId:t})}createVoiceBroadcastPlaybackPipContent(e){const t=this.state.viewedRoomId===e.infoEvent.getRoomId()?o.a.createElement(Ct.j,{playback:e,pip:!0}):o.a.createElement(Ct.B,{playback:e});return a=>{let{onStartMoving:n}=a;return o.a.createElement("div",{key:`vb-playback-${e.infoEvent.getId()}`,onMouseDown:n},t)}}createVoiceBroadcastPreRecordingPipContent(e){return t=>{let{onStartMoving:a}=t;return o.a.createElement("div",{key:"vb-pre-recording",onMouseDown:a},o.a.createElement(Ct.p,{voiceBroadcastPreRecording:e}))}}createVoiceBroadcastRecordingPipContent(e){return t=>{let{onStartMoving:a}=t;return o.a.createElement("div",{key:`vb-recording-${e.infoEvent.getId()}`,onMouseDown:a},o.a.createElement(Ct.w,{recording:e}))}}render(){let e=[];if(this.props.voiceBroadcastRecording?e=[this.createVoiceBroadcastRecordingPipContent(this.props.voiceBroadcastRecording)]:this.props.voiceBroadcastPreRecording?e=[this.createVoiceBroadcastPreRecordingPipContent(this.props.voiceBroadcastPreRecording)]:this.props.voiceBroadcastPlayback&&(e=[this.createVoiceBroadcastPlaybackPipContent(this.props.voiceBroadcastPlayback)]),this.state.primaryCall){const t=this.state.primaryCall;e.push((e=>{let{onStartMoving:a,onResize:n}=e;return o.a.createElement(Il,{onMouseDownOnHeader:a,call:t,secondaryCall:this.state.secondaryCall,pipMode:true,onResize:n})}))}return this.state.showWidgetInPip&&e.push((e=>{let{onStartMoving:t}=e;return o.a.createElement(Zd,{widgetId:this.state.persistentWidgetId,room:oe.a.get().getRoom(this.state.persistentRoomId),viewingRoom:this.state.viewedRoomId===this.state.persistentRoomId,onStartMoving:t,movePersistedElement:this.props.movePersistedElement})})),e.length?o.a.createElement(Kd.a,{className:"mx_LegacyCallPreview",draggable:true,onDoubleClick:this.onDoubleClick,onMove:this.onMove},e):null}}const nm=()=>{const e=Object(s.useContext)(at.a),t=e.voiceBroadcastPreRecordingStore,{currentVoiceBroadcastPreRecording:a}=Object(Ct.Q)(t),n=e.voiceBroadcastRecordingsStore,{currentVoiceBroadcastRecording:i}=Object(Ct.R)(n),r=e.voiceBroadcastPlaybacksStore,{currentVoiceBroadcastPlayback:l}=(c=r,{currentVoiceBroadcastPlayback:Object(ie.d)(c,Gd.b.CurrentChanged,(e=>null!=e?e:c.getCurrent()))});var c;const d=Object(s.useRef)();return o.a.createElement(am,{voiceBroadcastPlayback:l,voiceBroadcastPreRecording:a,voiceBroadcastRecording:i,movePersistedElement:d})};var im=a(298),sm=a(1007),om=a(984);function rm(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function lm(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?rm(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):rm(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const cm=e=>e?lm(lm({},e.rule),{},{kind:e.kind}):void 0,dm=async(e,t)=>{if((null==e?void 0:e.getType())!==Nc.EventType.PushRules)return;const a=new im.a(t);Object.entries(sm.c).forEach((async e=>{let[n,i]=e;try{await(async(e,t,a,n)=>{var i;const s=cm(t.getPushRuleAndKindById(a));if(!s)return;const o=null===(i=n.syncedRuleIds)||void 0===i?void 0:i.map((e=>cm(t.getPushRuleAndKindById(e)))).filter((e=>Boolean(e)));if(null==o||!o.length)return;const r=n.ruleToVectorState(s),l=o.filter((e=>n.ruleToVectorState(e)!==r));l.length&&await Object(om.a)(e,l.map((e=>{let{rule_id:t}=e;return t})),s.actions)})(t,a,n,i)}catch(e){Oa.a.error(`Failed to fully synchronise push rules for ${n}`,e)}}))};function mm(e){return e.closest("input, textarea, select, [contenteditable=true]")}class hm extends o.a.Component{constructor(e){super(e),i()(this,"_matrixClient",void 0),i()(this,"_roomView",void 0),i()(this,"_resizeContainer",void 0),i()(this,"resizeHandler",void 0),i()(this,"layoutWatcherRef",void 0),i()(this,"compactLayoutWatcherRef",void 0),i()(this,"borderRadiusWatcherRef",void 0),i()(this,"backgroundImageWatcherRef",void 0),i()(this,"resizer",void 0),i()(this,"onCallState",(()=>{const e=B.b.instance.getAllActiveCalls();e!==this.state.activeCalls&&this.setState({activeCalls:e})})),i()(this,"refreshBackgroundImage",(async()=>{let e=v.b.getValue("RoomList.backgroundImage");e=e?Object($a.b)(e).srcHttp:ft.a.instance.getHttpAvatarUrl(),this.setState({backgroundImage:e})})),i()(this,"canResetTimelineInRoom",(e=>!this._roomView.current||this._roomView.current.canResetTimeline())),i()(this,"onAccountData",(e=>{"m.ignored_user_list"===e.getType()&&b.a.dispatch({action:"ignore_state_changed"}),dm(e,this._matrixClient)})),i()(this,"onLayoutChanged",(()=>{this.setState({layout:v.b.getValue("layout")})})),i()(this,"onCompactLayoutChanged",(()=>{this.setState({useCompactLayout:v.b.getValue("useCompactLayout")})})),i()(this,"onBorderRadiusChanged",(()=>{document.body.setAttribute("data-border-radius",v.b.getValue("borderRadius"))})),i()(this,"onSync",((e,t,a)=>{var n,i,s;const o=null===(n=this.state.syncErrorData)||void 0===n||null===(i=n.error)||void 0===i?void 0:i.errcode,r=null==a||null===(s=a.error)||void 0===s?void 0:s.errcode;e===t&&o===r||(this.setState({syncErrorData:e===d.b.Error?a:void 0}),t===d.b.Prepared&&e===d.b.Syncing?this.updateServerNoticeEvents():this.calculateServerLimitToast(this.state.syncErrorData,this.state.usageLimitEventContent))})),i()(this,"onRoomStateEvents",(e=>{const t=la.c.instance.orderedLists[T.a.ServerNotice];null!=t&&t.some((t=>t.roomId===e.getRoomId()))&&this.updateServerNoticeEvents()})),i()(this,"onUsageLimitDismissed",(()=>{this.setState({usageLimitDismissed:!0})})),i()(this,"updateServerNoticeEvents",(async()=>{const e=la.c.instance.orderedLists[T.a.ServerNotice];if(!e)return;const t=[];let a=0;for(const n of e){const e=n.currentState.getStateEvents("m.room.pinned_events","");if(!e||!e.getContent().pinned)continue;a=e.getTs();const i=e.getContent().pinned.slice(0,2);for(const e of i){const a=await this._matrixClient.getEventTimeline(n.getUnfilteredTimelineSet(),e),i=null==a?void 0:a.getEvents().find((t=>t.getId()===e));i&&t.push(i)}}if(a&&this.state.usageLimitEventTs>a)return;const n=t.find((e=>e&&"m.room.message"===e.getType()&&"m.server_notice.usage_limit_reached"===e.getContent().server_notice_type)),i=null==n?void 0:n.getContent();this.calculateServerLimitToast(this.state.syncErrorData,i),this.setState({usageLimitEventContent:i,usageLimitEventTs:a,usageLimitDismissed:!1})})),i()(this,"onPaste",(e=>{const t=mm(e.target);if(t!==document.activeElement)if(null!=t&&t.focus)t.focus();else{var a;const e=!(null===(a=document.activeElement)||void 0===a||!a.closest(".mx_ThreadView"));b.a.dispatch({action:L.a.FocusSendMessageComposer,context:e?en.a.Thread:en.a.Room},!0)}})),i()(this,"onReactKeyDown",(e=>{this.onKeyDown(e)})),i()(this,"onNativeKeyDown",(e=>{e.target===document.body&&this.onKeyDown(e)})),i()(this,"onKeyDown",(e=>{var t,a,n;let i=!1;switch(Object(J.a)().getRoomAction(e)){case W.h.ScrollUp:case W.h.ScrollDown:case W.h.JumpToFirstMessage:case W.h.JumpToLatestMessage:this.onScrollKeyPressed(e),i=!0;break;case W.h.SearchInRoom:b.a.dispatch({action:"focus_search"}),i=!0}if(i)return e.stopPropagation(),void e.preventDefault();switch(Object(J.a)().getNavigationAction(e)){case W.h.FilterRooms:b.a.dispatch({action:"focus_room_filter"}),i=!0;break;case W.h.ToggleUserMenu:b.a.fire(L.a.ToggleUserMenu),i=!0;break;case W.h.ShowKeyboardSettings:b.a.dispatch({action:L.a.ViewUserSettings,initialTabId:Fe.a.Keyboard}),i=!0;break;case W.h.GoToHome:b.a.dispatch({action:L.a.ViewHomePage}),z.b.closeCurrentModal("homeKeyboardShortcut"),i=!0;break;case W.h.ToggleSpacePanel:b.a.fire(L.a.ToggleSpacePanel),i=!0;break;case W.h.ToggleRoomSidePanel:"room_view"===this.props.page_type&&(Fa.a.instance.togglePanel(null),i=!0);break;case W.h.SelectPrevRoom:b.a.dispatch({action:L.a.ViewRoomDelta,delta:-1,unread:!1}),i=!0;break;case W.h.SelectNextRoom:b.a.dispatch({action:L.a.ViewRoomDelta,delta:1,unread:!1}),i=!0;break;case W.h.SelectPrevUnreadRoom:b.a.dispatch({action:L.a.ViewRoomDelta,delta:-1,unread:!0});break;case W.h.SelectNextUnreadRoom:b.a.dispatch({action:L.a.ViewRoomDelta,delta:1,unread:!0});break;case W.h.PreviousVisitedRoomOrSpace:null===(t=I.a.get())||void 0===t||t.navigateForwardBack(!0),i=!0;break;case W.h.NextVisitedRoomOrSpace:null===(a=I.a.get())||void 0===a||a.navigateForwardBack(!1),i=!0}if(!i){switch(Object(J.a)().getLabsAction(e)){case W.h.ToggleHiddenEventVisibility:{const e=v.b.getValueAt(f.a.DEVICE,"showHiddenEventsInTimeline",void 0,!1);v.b.setValue("showHiddenEventsInTimeline",null,f.a.DEVICE,!e),i=!0;break}}}if(!i&&null!==(n=I.a.get())&&void 0!==n&&n.overrideBrowserShortcuts()&&e.code.startsWith("Digit")&&"Digit0"!==e.code&&Object(h.c)(e)&&(b.a.dispatch({action:L.a.SwitchSpace,num:parseInt(e.code.slice(5),10)}),i=!0),i)return e.stopPropagation(),void e.preventDefault();if(!(e.key===h.b.ALT||e.key===h.b.CONTROL||e.key===h.b.META||e.key===h.b.SHIFT)&&!e.ctrlKey&&!e.metaKey){const t=e.target!==document.body&&(e.key===h.b.SPACE||e.key===h.b.ENTER),a=1===e.key.length||"Dead"===e.key;if(!t&&a&&!mm(e.target)){var s;const t=!(null===(s=document.activeElement)||void 0===s||!s.closest(".mx_ThreadView"));b.a.dispatch({action:L.a.FocusSendMessageComposer,context:t?en.a.Thread:en.a.Room},!0),e.stopPropagation()}}})),i()(this,"onScrollKeyPressed",(e=>{var t;null===(t=this._roomView.current)||void 0===t||t.handleScrollKey(e)})),this.state={syncErrorData:void 0,layout:v.b.getValue("layout"),useCompactLayout:v.b.getValue("useCompactLayout"),usageLimitDismissed:!1,activeCalls:B.b.instance.getAllActiveCalls()},b.a.dispatch({action:L.a.RecheckTheme}),this._matrixClient=this.props.matrixClient,p.c.loadDevices(),Object(g.a)(),this._roomView=o.a.createRef(),this._resizeContainer=o.a.createRef(),this.resizeHandler=o.a.createRef()}componentDidMount(){var e;document.addEventListener("keydown",this.onNativeKeyDown,!1),B.b.instance.addListener(B.a.CallState,this.onCallState),this.updateServerNoticeEvents(),this._matrixClient.on(r.b.AccountData,this.onAccountData),dm(this._matrixClient.getAccountData("m.push_rules"),this._matrixClient),this._matrixClient.on(r.b.Sync,this.onSync),this.onSync(this._matrixClient.getSyncState(),null,null!==(e=this._matrixClient.getSyncStateData())&&void 0!==e?e:void 0),this._matrixClient.on(m.b.Events,this.onRoomStateEvents),this.layoutWatcherRef=v.b.watchSetting("layout",null,this.onLayoutChanged),this.compactLayoutWatcherRef=v.b.watchSetting("useCompactLayout",null,this.onCompactLayoutChanged),this.borderRadiusWatcherRef=v.b.watchSetting("borderRadius",null,this.onBorderRadiusChanged),this.backgroundImageWatcherRef=v.b.watchSetting("RoomList.backgroundImage",null,this.refreshBackgroundImage),this.resizer=this.createResizer(),this.resizer.attach(),ft.a.instance.on(Et.b,this.refreshBackgroundImage),this.loadResizerPreferences(),this.refreshBackgroundImage(),this.onBorderRadiusChanged()}componentWillUnmount(){document.removeEventListener("keydown",this.onNativeKeyDown,!1),B.b.instance.removeListener(B.a.CallState,this.onCallState),this._matrixClient.removeListener(r.b.AccountData,this.onAccountData),this._matrixClient.removeListener(r.b.Sync,this.onSync),this._matrixClient.removeListener(m.b.Events,this.onRoomStateEvents),ft.a.instance.off(Et.b,this.refreshBackgroundImage),v.b.unwatchSetting(this.layoutWatcherRef),v.b.unwatchSetting(this.compactLayoutWatcherRef),v.b.unwatchSetting(this.backgroundImageWatcherRef),this.resizer.detach()}createResizer(){var e;let t,a;const n={toggleSize:156,onCollapsed:e=>{a=e,e?(b.a.dispatch({action:"hide_left_panel"}),window.localStorage.setItem("mx_lhs_size","0")):b.a.dispatch({action:"show_left_panel"})},onResized:e=>{t=e,this.props.resizeNotifier.notifyLeftHandleResized()},onResizeStart:()=>{this.props.resizeNotifier.startResizing()},onResizeStop:()=>{a||window.localStorage.setItem("mx_lhs_size",""+t),this.props.resizeNotifier.stopResizing()},isItemCollapsed:e=>e.classList.contains("mx_LeftPanel_minimized"),handler:null!==(e=this.resizeHandler.current)&&void 0!==e?e:void 0},i=new k(this._resizeContainer.current,x,n);return i.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),i}loadResizerPreferences(){var e;let t=parseInt(window.localStorage.getItem("mx_lhs_size"),10);isNaN(t)&&(t=350),null===(e=this.resizer.forHandleWithId("lp-resizer"))||void 0===e||e.resize(t)}calculateServerLimitToast(e,t){var a;const n="M_RESOURCE_LIMIT_EXCEEDED"===(null==e||null===(a=e.error)||void 0===a?void 0:a.errcode);n&&(t=(null==e?void 0:e.error).data),t&&this.state.usageLimitDismissed?((e,t,a,n)=>{const i=Object(M.a)(e,a,{monthly_active_user:Object(N.d)("Your homeserver has exceeded its user limit."),hs_blocked:Object(N.d)("This homeserver has been blocked by its administrator."),"":Object(N.d)("Your homeserver has exceeded one of its resource limits.")}),s=Object(M.a)(e,a,{"":Object(N.d)("Contact your <a>server admin</a>.")});D.a.sharedInstance().addOrReplaceToast({key:A,title:Object(N.b)("Warning"),props:{description:o.a.createElement(o.a.Fragment,null,i," ",s),acceptLabel:Object(N.b)("Ok"),onAccept:()=>{U(),t&&t()}},component:P.a,priority:70})})(t.limit_type,this.onUsageLimitDismissed,t.admin_contact):U()}render(){let e;switch(this.props.page_type){case u.a.RoomView:e=o.a.createElement(Fd,{ref:this._roomView,onRegistered:this.props.onRegistered,threepidInvite:this.props.threepidInvite,oobData:this.props.roomOobData,key:this.props.currentRoomId||"roomview",resizeNotifier:this.props.resizeNotifier,justCreatedOpts:this.props.roomJustCreatedOpts,forceTimeline:this.props.forceTimeline});break;case u.a.HomePage:e=o.a.createElement(pa.a,{justRegistered:this.props.justRegistered});break;case u.a.UserView:e=o.a.createElement(Vd,{userId:this.props.currentUserId,resizeNotifier:this.props.resizeNotifier})}const t=c()({mx_MatrixChat_wrapper:!0,mx_MatrixChat_useCompactLayout:this.state.layout===io.a.Group&&this.state.useCompactLayout}),a=c()({mx_MatrixChat:!0,"mx_MatrixChat--with-avatar":this.state.backgroundImage}),n=this.state.activeCalls.map((e=>o.a.createElement(xa,{call:e,key:e.callId})));return o.a.createElement(R.a.Provider,{value:this._matrixClient},o.a.createElement("div",{onPaste:this.onPaste,onKeyDown:this.onReactKeyDown,className:t,"aria-hidden":this.props.hideToSRUsers},o.a.createElement(Bd,null),o.a.createElement("div",{className:a},o.a.createElement("div",{className:"mx_LeftPanel_outerWrapper"},o.a.createElement(Hd,{isMinimized:this.props.collapseLhs||!1}),o.a.createElement("nav",{className:"mx_LeftPanel_wrapper"},o.a.createElement(Wd,{blurMultiplier:.5,backgroundImage:this.state.backgroundImage}),o.a.createElement(Bt,null),o.a.createElement(Wd,{backgroundImage:this.state.backgroundImage}),o.a.createElement("div",{className:"mx_LeftPanel_wrapper--user",ref:this._resizeContainer,"data-collapsed":!!this.props.collapseLhs||void 0},o.a.createElement(fa,{pageType:this.props.page_type,isMinimized:this.props.collapseLhs||!1,resizeNotifier:this.props.resizeNotifier})))),o.a.createElement(E,{passRef:this.resizeHandler,id:"lp-resizer"}),o.a.createElement("div",{className:"mx_RoomView_wrapper"},e))),o.a.createElement(nm,null),o.a.createElement(ya,null),o.a.createElement(_a,null),n)}}i()(hm,"displayName","LoggedInView");t.a=hm},1742:function(e,t,a){"use strict";a.d(t,"a",(function(){return ji}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(352),l=a(121),c=a(277),d=a(1),m=a(136),h=a(123),u=a(141),p=a(273),g=a(129),b=a(147),v=a(161),f=a(124),E=a(934),y=a(267),_=a(301),S=a(163);class w extends o.a.Component{constructor(e){var t,a,n;super(e),i()(this,"userId",void 0),i()(this,"avatarUpload",Object(s.createRef)()),i()(this,"uploadAvatar",(()=>{var e;null===(e=this.avatarUpload.current)||void 0===e||e.click()})),i()(this,"removeAvatar",(()=>{this.avatarUpload.current.value="",this.setState({avatarUrl:void 0,avatarFile:null,enableProfileSave:!0})})),i()(this,"cancelProfileChanges",(async e=>{var t;e.stopPropagation(),e.preventDefault(),this.state.enableProfileSave&&this.setState({enableProfileSave:!1,displayName:this.state.originalDisplayName,avatarUrl:null!==(t=this.state.originalAvatarUrl)&&void 0!==t?t:void 0,avatarFile:null})})),i()(this,"saveProfile",(async e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.enableProfileSave)return;this.setState({enableProfileSave:!1});const t=h.a.get(),a={},n=this.state.displayName.trim();try{if(this.state.originalDisplayName!==this.state.displayName&&(await t.setDisplayName(n),a.originalDisplayName=n,a.displayName=n),this.state.avatarFile){var i;d.a.log(`Uploading new avatar, ${this.state.avatarFile.name} of type ${this.state.avatarFile.type}, (${this.state.avatarFile.size}) bytes`);const{content_uri:e}=await t.uploadContent(this.state.avatarFile);await t.setAvatarUrl(e),a.avatarUrl=null!==(i=Object(v.b)(e).getSquareThumbnailHttp(96))&&void 0!==i?i:void 0,a.originalAvatarUrl=a.avatarUrl,a.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.setAvatarUrl("")}catch(e){d.a.log("Failed to save profile",e),g.b.createDialog(b.a,{title:Object(l.b)("Failed to save your profile"),description:e&&e.message?e.message:Object(l.b)("The operation could not be completed")})}this.setState(a)})),i()(this,"onDisplayNameChanged",(e=>{this.setState({displayName:e.target.value,enableProfileSave:!0})})),i()(this,"onAvatarChanged",(e=>{var t;if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:null!==(t=this.state.originalAvatarUrl)&&void 0!==t?t:void 0,avatarFile:null,enableProfileSave:!1});const a=e.target.files[0],n=new FileReader;n.onload=e=>{var t,n;this.setState({avatarUrl:null!==(t=null===(n=e.target)||void 0===n?void 0:n.result)&&void 0!==t?t:void 0,avatarFile:a,enableProfileSave:!0})},n.readAsDataURL(a)})),this.userId=h.a.get().getSafeUserId();let o=p.a.instance.avatarMxc;o&&(o=Object(v.b)(o).getSquareThumbnailHttp(96)),this.state={originalDisplayName:null!==(t=p.a.instance.displayName)&&void 0!==t?t:"",displayName:null!==(a=p.a.instance.displayName)&&void 0!==a?a:"",originalAvatarUrl:o,avatarUrl:null!==(n=o)&&void 0!==n?n:void 0,avatarFile:null,enableProfileSave:!1}}render(){var e;const t=y.a.getDisplayUserIdentifier(this.userId,{withDisplayName:!0}),a=null===(e=this.state.avatarUrl)||void 0===e?void 0:e.toString();return o.a.createElement("form",{onSubmit:this.saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings"},o.a.createElement("input",{type:"file",ref:this.avatarUpload,className:"mx_ProfileSettings_avatarUpload",onClick:e=>{Object(_.a)(e),S.b.trackInteraction("WebProfileSettingsAvatarUploadButton",e)},onChange:this.onAvatarChanged,accept:"image/*"}),o.a.createElement("div",{className:"mx_ProfileSettings_profile"},o.a.createElement("div",{className:"mx_ProfileSettings_profile_controls"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Profile")),o.a.createElement(u.a,{label:Object(l.b)("Display Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this.onDisplayNameChanged}),o.a.createElement("p",null,t&&o.a.createElement("span",{className:"mx_ProfileSettings_profile_controls_userId"},t))),o.a.createElement(E.a,{avatarUrl:a,avatarName:this.state.displayName||this.userId,avatarAltText:Object(l.b)("Profile picture"),uploadAvatar:this.uploadAvatar,removeAvatar:this.removeAvatar})),o.a.createElement("div",{className:"mx_ProfileSettings_buttons"},o.a.createElement(f.a,{onClick:this.cancelProfileChanges,kind:"link",disabled:!this.state.enableProfileSave},Object(l.b)("Cancel")),o.a.createElement(f.a,{onClick:this.saveProfile,kind:"primary",disabled:!this.state.enableProfileSave},Object(l.b)("Save"))))}}var O=a(126),C=a(987),x=a(308),j=a(158),k=a(135);class R extends o.a.Component{constructor(e){super(e),this.onSearchChange=this.onSearchChange.bind(this),this.state={searchQuery:""}}componentDidMount(){const e=j.a.get();var t;e&&(null===(t=e.getAvailableSpellCheckLanguages())||void 0===t||t.then((e=>{e.sort((function(e,t){return e<t?-1:e>t?1:0}));const t=[];e.forEach((e=>{t.push({label:e,value:e})})),this.setState({languages:t})})).catch((e=>{this.setState({languages:[{value:"en",label:"English"}]})})))}onSearchChange(e){this.setState({searchQuery:e})}render(){if(!this.state.languages)return o.a.createElement(k.a,null);let e;e=this.state.searchQuery?this.state.languages.filter((e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e))):this.state.languages;const t=e.map((e=>o.a.createElement("div",{key:e.value},e.label)));let a,n=O.b.getValue("language",null,!0);return n||(n=navigator.language||navigator.userLanguage),a=this.props.value||n,o.a.createElement(x.a,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:a,label:Object(l.b)("Language Dropdown"),placeholder:Object(l.b)("Choose a locale")},t)}}class I extends o.a.Component{constructor(){super(...arguments),i()(this,"onRemove",(e=>(e.stopPropagation(),e.preventDefault(),this.props.onRemoved(this.props.language))))}render(){return o.a.createElement("div",{className:"mx_ExistingSpellCheckLanguage"},o.a.createElement("span",{className:"mx_ExistingSpellCheckLanguage_language"},this.props.language),o.a.createElement(f.a,{onClick:this.onRemove,kind:"danger_sm"},Object(l.b)("Remove")))}}class T extends o.a.Component{constructor(e){super(e),i()(this,"onRemoved",(e=>{const t=this.props.languages.filter((t=>t!==e));this.props.onLanguagesChange(t)})),i()(this,"onAddClick",(e=>{e.stopPropagation(),e.preventDefault();const t=this.state.newLanguage;this.setState({newLanguage:""}),t&&(this.props.languages.includes(t)||(this.props.languages.push(t),this.props.onLanguagesChange(this.props.languages)))})),i()(this,"onNewLanguageChange",(e=>{this.state.newLanguage!==e&&this.setState({newLanguage:e})})),this.state={newLanguage:""}}render(){const e=this.props.languages.map((e=>o.a.createElement(I,{language:e,onRemoved:this.onRemoved,key:e}))),t=o.a.createElement(f.a,{onClick:this.onAddClick,kind:"primary"},Object(l.b)("Add"));return o.a.createElement("div",{className:"mx_SpellCheckLanguages"},e,o.a.createElement("form",{onSubmit:this.onAddClick,noValidate:!0},o.a.createElement(R,{className:"mx_GeneralUserSettingsTab_spellCheckLanguageInput",value:this.state.newLanguage,onOptionChange:this.onNewLanguageChange}),t))}}var N=a(548),P=a(330),D=a(182),M=a(137),A=a(125),U=a(128);class L extends o.a.Component{constructor(e){super(e),i()(this,"onStagePhaseChange",((e,t)=>{const a={[P.c.PHASE_PREAUTH]:{body:Object(l.b)("Confirm your account deactivation by using Single Sign On to prove your identity."),continueText:Object(l.b)("Single Sign On"),continueKind:"danger"},[P.c.PHASE_POSTAUTH]:{body:Object(l.b)("Are you sure you want to deactivate your account? This is irreversible."),continueText:Object(l.b)("Confirm account deactivation"),continueKind:"danger"}},n={[P.c.LOGIN_TYPE]:a,[P.c.UNSTABLE_LOGIN_TYPE]:a,[P.b.LOGIN_TYPE]:{[P.a]:{body:Object(l.b)("To continue, please enter your account password:")}}}[e];let i,s,o;if(n){const e=n[t];e&&(e.body&&(i=e.body),e.continueText&&(s=e.continueText),e.continueKind&&(o=e.continueKind))}this.setState({bodyText:i,continueText:s,continueKind:o})})),i()(this,"onUIAuthFinished",((e,t)=>{e||(t!==N.a?(d.a.error("Error during UI Auth:",{result:t}),this.setState({errStr:Object(l.b)("There was a problem communicating with the server. Please try again.")})):this.onCancel())})),i()(this,"onUIAuthComplete",(e=>{h.a.get().deactivateAccount(e,this.state.shouldErase).then((e=>{A.a.fire(U.a.TriggerLogout),this.props.onFinished(!0)})).catch((e=>{d.a.error(e),this.setState({errStr:Object(l.b)("There was a problem communicating with the server. Please try again.")})}))})),i()(this,"onEraseFieldChange",(e=>{this.setState({shouldErase:e.currentTarget.checked,authEnabled:!1}),this.initAuth(e.currentTarget.checked)})),this.state={shouldErase:!1,errStr:null,authData:null,authEnabled:!0},this.initAuth(!1)}onCancel(){this.props.onFinished(!1)}initAuth(e){h.a.get().deactivateAccount(null,e).then((e=>{d.a.warn("User's account got deactivated without confirmation: Server had no auth"),this.setState({errStr:Object(l.b)("Server did not require any authentication")})})).catch((e=>{e&&401===e.httpStatus&&e.data?this.setState({authData:e.data,authEnabled:!0}):this.setState({errStr:Object(l.b)("Server did not return valid authentication information.")})}))}render(){let e;this.state.errStr&&(e=o.a.createElement("div",{className:"error"},this.state.errStr));let t=o.a.createElement("div",null,Object(l.b)("Loading…"));return this.state.authData&&this.state.authEnabled&&(t=o.a.createElement("div",null,this.state.bodyText,o.a.createElement(N.b,{matrixClient:h.a.get(),authData:this.state.authData,makeRequest:this.onUIAuthComplete,onAuthFinished:this.onUIAuthFinished,onStagePhaseChange:this.onStagePhaseChange,continueText:this.state.continueText,continueKind:this.state.continueKind}))),o.a.createElement(M.a,{className:"mx_DeactivateAccountDialog",onFinished:this.props.onFinished,titleClass:"danger",title:Object(l.b)("Deactivate Account"),screenName:"DeactivateAccount"},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("p",null,Object(l.b)("Confirm that you would like to deactivate your account. If you proceed:")),o.a.createElement("ul",null,o.a.createElement("li",null,Object(l.b)("You will not be able to reactivate your account")),o.a.createElement("li",null,Object(l.b)("You will no longer be able to log in")),o.a.createElement("li",null,Object(l.b)("No one will be able to reuse your username (MXID), including you: this username will remain unavailable")),o.a.createElement("li",null,Object(l.b)("You will leave all rooms and DMs that you are in")),o.a.createElement("li",null,Object(l.b)("You will be removed from the identity server: your friends will no longer be able to find you with your email or phone number"))),o.a.createElement("p",null,Object(l.b)("Your old messages will still be visible to people who received them, just like emails you sent in the past. Would you like to hide your sent messages from people who join rooms in the future?")),o.a.createElement("div",{className:"mx_DeactivateAccountDialog_input_section"},o.a.createElement("p",null,o.a.createElement(D.b,{checked:this.state.shouldErase,onChange:this.onEraseFieldChange},Object(l.b)("Hide my messages from new joiners"))),e,t)))}}var F=a(518),B=a(299),V=a(382);async function W(e,t){const a=e.getUserId();let{threepids:n}=await e.getThreePids();if(t&&(n=n.filter((e=>e.medium===t))),n.length>0&&e.getIdentityServerUrl())try{const i=new B.a,s=await i.getAccessToken({check:!1});if(!s)throw new Error("No identity access token found");const o=n.map((e=>{let{medium:t,address:a}=e;return[t,a]})),r=await e.bulkLookupThreePids(o,s);for(const[e,i,s]of r.threepids){if(s!==a)continue;if(t&&e!==t)continue;const o=n.find((t=>t.medium===e&&t.address===i));o&&(o.bound=!0)}}catch(e){if("M_TERMS_NOT_SIGNED"!==e.errcode)throw e}return n}var z=a(138),H=a(157);let K=function(e){return e.Email="email",e.Phone="msisdn",e}({});var G=a(263);function q(){const e=h.a.get().getIdentityServerUrl(!0);if(!e)throw new l.a("Identity server not set");return e}class ${constructor(){i()(this,"sessionId",void 0),i()(this,"submitUrl",void 0),i()(this,"clientSecret",void 0),i()(this,"bind",void 0),i()(this,"makeAddThreepidOnlyRequest",(e=>h.a.get().addThreePidOnly({sid:this.sessionId,client_secret:this.clientSecret,auth:e}))),this.clientSecret=h.a.get().generateClientSecret()}async addEmailAddress(e){try{const t=await h.a.get().requestAdd3pidEmailToken(e,this.clientSecret,1);return this.sessionId=t.sid,t}catch(e){if(e instanceof m.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.a("This email address is already in use",{cause:e});throw e}}async bindEmailAddress(e){if(this.bind=!0,!await h.a.get().doesServerSupportSeparateAddAndBind())return this.addEmailAddress(e);{var t;const a=new B.a,n=null!==(t=await a.getAccessToken())&&void 0!==t?t:void 0;try{const t=await h.a.get().requestEmailToken(e,this.clientSecret,1,void 0,n);return this.sessionId=t.sid,t}catch(e){if(e instanceof m.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.a("This email address is already in use",{cause:e});throw e}}}async addMsisdn(e,t){try{const a=await h.a.get().requestAdd3pidMsisdnToken(e,t,this.clientSecret,1);return this.sessionId=a.sid,this.submitUrl=a.submit_url,a}catch(e){if(e instanceof m.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.a("This phone number is already in use",{cause:e});throw e}}async bindMsisdn(e,t){if(this.bind=!0,!await h.a.get().doesServerSupportSeparateAddAndBind())return this.addMsisdn(e,t);{var a;const n=new B.a,i=null!==(a=await n.getAccessToken())&&void 0!==a?a:void 0;try{const a=await h.a.get().requestMsisdnToken(e,t,this.clientSecret,1,void 0,i);return this.sessionId=a.sid,a}catch(e){if(e instanceof m.MatrixError&&"M_THREEPID_IN_USE"===e.errcode)throw new l.a("This phone number is already in use",{cause:e});throw e}}}async checkEmailLinkClicked(){try{if(await h.a.get().doesServerSupportSeparateAddAndBind())if(this.bind){const e=new B.a,t=await e.getAccessToken();if(!t)throw new l.a("No identity access token found");await h.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:q(),id_access_token:t})}else try{return await this.makeAddThreepidOnlyRequest(),[!0]}catch(e){if(!(e instanceof m.MatrixError&&401===e.httpStatus&&e.data&&e.data.flows))throw e;const t={[P.c.PHASE_PREAUTH]:{title:Object(l.b)("Use Single Sign On to continue"),body:Object(l.b)("Confirm adding this email address by using Single Sign On to prove your identity."),continueText:Object(l.b)("Single Sign On"),continueKind:"primary"},[P.c.PHASE_POSTAUTH]:{title:Object(l.b)("Confirm adding email"),body:Object(l.b)("Click the button below to confirm adding this email address."),continueText:Object(l.b)("Confirm"),continueKind:"primary"}},{finished:a}=g.b.createDialog(G.a,{title:Object(l.b)("Add Email Address"),matrixClient:h.a.get(),authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[P.c.LOGIN_TYPE]:t,[P.c.UNSTABLE_LOGIN_TYPE]:t}});return a}else await h.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:q()},this.bind)}catch(e){if(e instanceof m.HTTPError&&401===e.httpStatus)throw new l.a("Failed to verify email address: make sure you clicked the link in the email",{cause:e});throw e}return[]}async haveMsisdnToken(e){const t=new B.a,a=await h.a.get().doesServerSupportSeparateAddAndBind();let n;if(this.submitUrl)n=await h.a.get().submitMsisdnTokenOtherUrl(this.submitUrl,this.sessionId,this.clientSecret,e);else{if(!this.bind&&a)throw new l.a("The add / bind with MSISDN flow is misconfigured");n=await h.a.get().submitMsisdnToken(this.sessionId,this.clientSecret,e,await t.getAccessToken())}if(n.errcode)throw n;if(a)if(this.bind)await h.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:q(),id_access_token:await t.getAccessToken()});else try{return void await this.makeAddThreepidOnlyRequest()}catch(e){if(!(e instanceof m.MatrixError&&401===e.httpStatus&&e.data&&e.data.flows))throw e;const t={[P.c.PHASE_PREAUTH]:{title:Object(l.b)("Use Single Sign On to continue"),body:Object(l.b)("Confirm adding this phone number by using Single Sign On to prove your identity."),continueText:Object(l.b)("Single Sign On"),continueKind:"primary"},[P.c.PHASE_POSTAUTH]:{title:Object(l.b)("Confirm adding phone number"),body:Object(l.b)("Click the button below to confirm adding this phone number."),continueText:Object(l.b)("Confirm"),continueKind:"primary"}},{finished:a}=g.b.createDialog(G.a,{title:Object(l.b)("Add Phone Number"),matrixClient:h.a.get(),authData:e.data,makeRequest:this.makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[P.c.LOGIN_TYPE]:t,[P.c.UNSTABLE_LOGIN_TYPE]:t}});return a}else await h.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:q()},this.bind)}}var Y=a(680);class J extends o.a.Component{constructor(e){super(e),i()(this,"onRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})})),i()(this,"onDontRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})})),i()(this,"onActuallyRemove",(e=>{e.stopPropagation(),e.preventDefault(),h.a.get().deleteThreePid(this.props.msisdn.medium,this.props.msisdn.address).then((()=>this.props.onRemoved(this.props.msisdn))).catch((e=>{d.a.error("Unable to remove contact information: "+e),g.b.createDialog(b.a,{title:Object(l.b)("Unable to remove contact information"),description:Object(b.b)(e,Object(l.b)("Operation failed"))})}))})),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?o.a.createElement("div",{className:"mx_ExistingPhoneNumber"},o.a.createElement("span",{className:"mx_ExistingPhoneNumber_promptText"},Object(l.b)("Remove %(phone)s?",{phone:this.props.msisdn.address})),o.a.createElement(f.a,{onClick:this.onActuallyRemove,kind:"danger_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(l.b)("Remove")),o.a.createElement(f.a,{onClick:this.onDontRemove,kind:"link_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(l.b)("Cancel"))):o.a.createElement("div",{className:"mx_ExistingPhoneNumber"},o.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",this.props.msisdn.address),o.a.createElement(f.a,{onClick:this.onRemove,kind:"danger_sm"},Object(l.b)("Remove")))}}class Q extends o.a.Component{constructor(e){var t;super(e),t=this,i()(this,"onRemoved",(e=>{const t=this.props.msisdns.filter((t=>t!==e));this.props.onMsisdnsChange(t)})),i()(this,"onChangeNewPhoneNumber",(e=>{this.setState({newPhoneNumber:e.target.value})})),i()(this,"onChangeNewPhoneNumberCode",(e=>{this.setState({newPhoneNumberCode:e.target.value})})),i()(this,"onAddClick",(e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newPhoneNumber)return;const t=this.state.newPhoneNumber,a=this.state.phoneCountry,n=new $;this.setState({verifying:!0,continueDisabled:!0,addTask:n}),n.addMsisdn(a,t).then((e=>{this.setState({continueDisabled:!1,verifyMsisdn:e.msisdn})})).catch((e=>{d.a.error("Unable to add phone number "+t+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.b.createDialog(b.a,{title:Object(l.b)("Error"),description:Object(b.b)(e,Object(l.b)("Operation failed"))})}))})),i()(this,"onContinueClick",(e=>{var a;e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const n=this.state.newPhoneNumberCode,i=this.state.verifyMsisdn;null===(a=this.state.addTask)||void 0===a||a.haveMsisdnToken(n).then((function(){let[e]=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],a=t.state.newPhoneNumber;if(e){const e=[...t.props.msisdns,{address:i,medium:K.Phone}];t.props.onMsisdnsChange(e),a=""}t.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyMsisdn:"",verifyError:null,newPhoneNumber:a,newPhoneNumberCode:""})})).catch((e=>{d.a.error("Unable to verify phone number: "+e),this.setState({continueDisabled:!1});let t=e;e instanceof l.a&&(t=e.cause),"M_THREEPID_AUTH_FAILED"!==t.errcode?g.b.createDialog(b.a,{title:Object(l.b)("Unable to verify phone number."),description:Object(b.b)(e,Object(l.b)("Operation failed"))}):this.setState({verifyError:Object(l.b)("Incorrect verification code")})}))})),i()(this,"onCountryChanged",(e=>{this.setState({phoneCountry:e.iso2})})),this.state={verifying:!1,verifyError:null,verifyMsisdn:"",addTask:null,continueDisabled:!1,phoneCountry:"",newPhoneNumber:"",newPhoneNumberCode:""}}render(){const e=this.props.msisdns.map((e=>o.a.createElement(J,{msisdn:e,onRemoved:this.onRemoved,key:e.address})));let t=o.a.createElement(f.a,{onClick:this.onAddClick,kind:"primary"},Object(l.b)("Add"));if(this.state.verifying){const e=this.state.verifyMsisdn;t=o.a.createElement("div",null,o.a.createElement("div",null,Object(l.b)("A text message has been sent to +%(msisdn)s. Please enter the verification code it contains.",{msisdn:e}),o.a.createElement("br",null),this.state.verifyError),o.a.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},o.a.createElement(u.a,{type:"text",label:Object(l.b)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.newPhoneNumberCode,onChange:this.onChangeNewPhoneNumberCode}),o.a.createElement(f.a,{onClick:this.onContinueClick,kind:"primary",disabled:this.state.continueDisabled||0===this.state.newPhoneNumberCode.length},Object(l.b)("Continue"))))}const a=o.a.createElement(Y.a,{onOptionChange:this.onCountryChanged,className:"mx_PhoneNumbers_country",value:this.state.phoneCountry,disabled:this.state.verifying,isSmall:!0,showPrefix:!0});return o.a.createElement("div",{className:"mx_PhoneNumbers"},e,o.a.createElement("form",{onSubmit:this.onAddClick,autoComplete:"off",noValidate:!0,className:"mx_PhoneNumbers_new"},o.a.createElement("div",{className:"mx_PhoneNumbers_input"},o.a.createElement(u.a,{type:"text",label:Object(l.b)("Phone Number"),autoComplete:"off",disabled:this.state.verifying,prefixComponent:a,value:this.state.newPhoneNumber,onChange:this.onChangeNewPhoneNumber}))),t)}}var X=a(337);class Z extends o.a.Component{constructor(e){super(e),i()(this,"onRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})})),i()(this,"onDontRemove",(e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})})),i()(this,"onActuallyRemove",(e=>{e.stopPropagation(),e.preventDefault(),h.a.get().deleteThreePid(this.props.email.medium,this.props.email.address).then((()=>this.props.onRemoved(this.props.email))).catch((e=>{d.a.error("Unable to remove contact information: "+e),g.b.createDialog(b.a,{title:Object(l.b)("Unable to remove contact information"),description:e&&e.message?e.message:Object(l.b)("Operation failed")})}))})),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?o.a.createElement("div",{className:"mx_ExistingEmailAddress"},o.a.createElement("span",{className:"mx_ExistingEmailAddress_promptText"},Object(l.b)("Remove %(email)s?",{email:this.props.email.address})),o.a.createElement(f.a,{onClick:this.onActuallyRemove,kind:"danger_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(l.b)("Remove")),o.a.createElement(f.a,{onClick:this.onDontRemove,kind:"link_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(l.b)("Cancel"))):o.a.createElement("div",{className:"mx_ExistingEmailAddress"},o.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},this.props.email.address),o.a.createElement(f.a,{onClick:this.onRemove,kind:"danger_sm"},Object(l.b)("Remove")))}}class ee extends o.a.Component{constructor(e){super(e),i()(this,"onRemoved",(e=>{const t=this.props.emails.filter((t=>t!==e));this.props.onEmailsChange(t)})),i()(this,"onChangeNewEmailAddress",(e=>{this.setState({newEmailAddress:e.target.value})})),i()(this,"onAddClick",(e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newEmailAddress)return;const t=this.state.newEmailAddress;if(!X.a(t))return void g.b.createDialog(b.a,{title:Object(l.b)("Invalid Email Address"),description:Object(l.b)("This doesn't appear to be a valid email address")});const a=new $;this.setState({verifying:!0,continueDisabled:!0,addTask:a}),a.addEmailAddress(t).then((()=>{this.setState({continueDisabled:!1})})).catch((e=>{d.a.error("Unable to add email address "+t+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.b.createDialog(b.a,{title:Object(l.b)("Unable to add email address"),description:Object(b.b)(e,Object(l.b)("Operation failed"))})}))})),i()(this,"onContinueClick",(e=>{var t;e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0}),null===(t=this.state.addTask)||void 0===t||t.checkEmailLinkClicked().then((e=>{let[t]=e,a=this.state.newEmailAddress;if(t){const e=this.state.newEmailAddress,t=[...this.props.emails,{address:e,medium:K.Email}];this.props.onEmailsChange(t),a=""}this.setState({addTask:null,continueDisabled:!1,verifying:!1,newEmailAddress:a})})).catch((e=>{d.a.error("Unable to verify email address: ",e),this.setState({continueDisabled:!1});let t=e;e instanceof l.a&&(t=e.cause),t instanceof m.MatrixError&&"M_THREEPID_AUTH_FAILED"===t.errcode?g.b.createDialog(b.a,{title:Object(l.b)("Your email address hasn't been verified yet"),description:Object(l.b)("Click the link in the email you received to verify and then click continue again.")}):g.b.createDialog(b.a,{title:Object(l.b)("Unable to verify email address."),description:Object(b.b)(e,Object(l.b)("Operation failed"))})}))})),this.state={verifying:!1,addTask:null,continueDisabled:!1,newEmailAddress:""}}render(){const e=this.props.emails.map((e=>o.a.createElement(Z,{email:e,onRemoved:this.onRemoved,key:e.address})));let t=o.a.createElement(f.a,{onClick:this.onAddClick,kind:"primary"},Object(l.b)("Add"));return this.state.verifying&&(t=o.a.createElement("div",null,o.a.createElement("div",null,Object(l.b)("We've sent you an email to verify your address. Please follow the instructions there and then click the button below.")),o.a.createElement(f.a,{onClick:this.onContinueClick,kind:"primary",disabled:this.state.continueDisabled},Object(l.b)("Continue")))),o.a.createElement("div",{className:"mx_EmailAddresses"},e,o.a.createElement("form",{onSubmit:this.onAddClick,autoComplete:"off",noValidate:!0,className:"mx_EmailAddresses_new"},o.a.createElement(u.a,{type:"text",label:Object(l.b)("Email Address"),autoComplete:"off",disabled:this.state.verifying,value:this.state.newEmailAddress,onChange:this.onChangeNewEmailAddress}),t))}}class te extends o.a.Component{constructor(e){super(e),i()(this,"onRevokeClick",(e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(l.b)("Unable to revoke sharing for email address")})})),i()(this,"onShareClick",(e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(l.b)("Unable to share email address")})})),i()(this,"onContinueClick",(async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});try{var t;await(null===(t=this.state.addTask)||void 0===t?void 0:t.checkEmailLinkClicked()),this.setState({addTask:null,verifying:!1})}catch(e){d.a.error("Unable to verify email address:",e);let t=e;e instanceof l.a&&(t=e.cause),t instanceof m.MatrixError&&"M_THREEPID_AUTH_FAILED"===t.errcode?g.b.createDialog(b.a,{title:Object(l.b)("Your email address hasn't been verified yet"),description:Object(l.b)("Click the link in the email you received to verify and then click continue again.")}):(d.a.error("Unable to verify email address: "+e),g.b.createDialog(b.a,{title:Object(l.b)("Unable to verify email address."),description:Object(b.b)(e,Object(l.b)("Operation failed"))}))}finally{this.setState({continueDisabled:!1})}}));const{bound:t}=e.email;this.state={verifying:!1,addTask:null,continueDisabled:!1,bound:t}}componentDidUpdate(e){if(this.props.email!==e.email){const{bound:e}=this.props.email;this.setState({bound:e})}}async changeBinding(e){let{bind:t,label:a,errorTitle:n}=e;if(!await h.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:t,label:a,errorTitle:n});const{medium:i,address:s}=this.props.email;try{if(t){const e=new $;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindEmailAddress(s),this.setState({continueDisabled:!1})}else await h.a.get().unbindThreePid(i,s);this.setState({bound:t})}catch(e){d.a.error(`changeBinding: Unable to ${a} email address ${s}`,e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.b.createDialog(b.a,{title:n,description:Object(b.b)(e,Object(l.b)("Operation failed"))})}}async changeBindingTangledAddBind(e){let{bind:t,label:a,errorTitle:n}=e;const{medium:i,address:s}=this.props.email,o=new $;this.setState({verifying:!0,continueDisabled:!0,addTask:o});try{await h.a.get().deleteThreePid(i,s),t?await o.bindEmailAddress(s):await o.addEmailAddress(s),this.setState({continueDisabled:!1,bound:t})}catch(e){d.a.error(`changeBindingTangledAddBind: Unable to ${a} email address ${s}`,e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.b.createDialog(b.a,{title:n,description:Object(b.b)(e,Object(l.b)("Operation failed"))})}}render(){const{address:e}=this.props.email,{verifying:t,bound:a}=this.state;let n;return n=t?o.a.createElement("span",null,Object(l.b)("Verify the link in your inbox"),o.a.createElement(f.a,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onContinueClick,disabled:this.state.continueDisabled},Object(l.b)("Complete"))):a?o.a.createElement(f.a,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(l.b)("Revoke")):o.a.createElement(f.a,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(l.b)("Share")),o.a.createElement("div",{className:"mx_ExistingEmailAddress"},o.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},e),n)}}class ae extends o.a.Component{render(){let e;return e=this.props.emails.length>0?this.props.emails.map((e=>o.a.createElement(te,{email:e,key:e.address}))):o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Discovery options will appear once you have added an email above.")),o.a.createElement("div",{className:"mx_EmailAddresses"},e)}}class ne extends o.a.Component{constructor(e){super(e),i()(this,"onRevokeClick",(e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(l.b)("Unable to revoke sharing for phone number")})})),i()(this,"onShareClick",(e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(l.b)("Unable to share phone number")})})),i()(this,"onVerificationCodeChange",(e=>{this.setState({verificationCode:e.target.value})})),i()(this,"onContinueClick",(async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.verificationCode;try{var a;await(null===(a=this.state.addTask)||void 0===a?void 0:a.haveMsisdnToken(t)),this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyError:null,verificationCode:""})}catch(e){d.a.error("Unable to verify phone number:",e);let t=e;e instanceof l.a&&(t=e.cause),this.setState({continueDisabled:!1}),t instanceof m.MatrixError&&"M_THREEPID_AUTH_FAILED"!==t.errcode?g.b.createDialog(b.a,{title:Object(l.b)("Unable to verify phone number."),description:Object(b.b)(e,Object(l.b)("Operation failed"))}):this.setState({verifyError:Object(l.b)("Incorrect verification code")})}}));const{bound:t}=e.msisdn;this.state={verifying:!1,verificationCode:"",addTask:null,continueDisabled:!1,bound:t,verifyError:null}}componentDidUpdate(e){if(this.props.msisdn!==e.msisdn){const{bound:e}=this.props.msisdn;this.setState({bound:e})}}async changeBinding(e){let{bind:t,label:a,errorTitle:n}=e;if(!await h.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:t,label:a,errorTitle:n});const{medium:i,address:s}=this.props.msisdn;try{if(t){const e=new $;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindMsisdn(null,`+${s}`),this.setState({continueDisabled:!1})}else await h.a.get().unbindThreePid(i,s);this.setState({bound:t})}catch(e){d.a.error(`changeBinding: Unable to ${a} phone number ${s}`,e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.b.createDialog(b.a,{title:n,description:Object(b.b)(e,Object(l.b)("Operation failed"))})}}async changeBindingTangledAddBind(e){let{bind:t,label:a,errorTitle:n}=e;const{medium:i,address:s}=this.props.msisdn,o=new $;this.setState({verifying:!0,continueDisabled:!0,addTask:o});try{await h.a.get().deleteThreePid(i,s),t?await o.bindMsisdn(null,`+${s}`):await o.addMsisdn(null,`+${s}`),this.setState({continueDisabled:!1,bound:t})}catch(e){d.a.error(`changeBindingTangledAddBind: Unable to ${a} phone number ${s}`,e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),g.b.createDialog(b.a,{title:n,description:Object(b.b)(e,Object(l.b)("Operation failed"))})}}render(){const{address:e}=this.props.msisdn,{verifying:t,bound:a}=this.state;let n;return n=t?o.a.createElement("span",{className:"mx_ExistingPhoneNumber_verification"},o.a.createElement("span",null,Object(l.b)("Please enter verification code sent via text."),o.a.createElement("br",null),this.state.verifyError),o.a.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},o.a.createElement(u.a,{type:"text",label:Object(l.b)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.verificationCode,onChange:this.onVerificationCodeChange}))):a?o.a.createElement(f.a,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(l.b)("Revoke")):o.a.createElement(f.a,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(l.b)("Share")),o.a.createElement("div",{className:"mx_ExistingPhoneNumber"},o.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",e),n)}}class ie extends o.a.Component{render(){let e;return e=this.props.msisdns.length>0?this.props.msisdns.map((e=>o.a.createElement(ne,{msisdn:e,key:e.address}))):o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Discovery options will appear once you have added a phone number above.")),o.a.createElement("div",{className:"mx_PhoneNumbers"},e)}}var se=a(204),oe=a(362),re=a(700),le=a(159),ce=a(145),de=a(155),me=function(e){return e.Display="display",e.Edit="edit",e}(me||{});class he extends o.a.Component{constructor(e){var t;super(e),t=this,i()(this,"value",""),i()(this,"placeholder",!1),i()(this,"editableDiv",Object(s.createRef)()),i()(this,"showPlaceholder",(e=>{this.editableDiv.current&&(e?(this.editableDiv.current.textContent=this.props.placeholder,this.editableDiv.current.setAttribute("class",this.props.className+" "+this.props.placeholderClassName),this.placeholder=!0,this.value=""):(this.editableDiv.current.textContent=this.value,this.editableDiv.current.setAttribute("class",this.props.className),this.placeholder=!1))})),i()(this,"cancelEdit",(()=>{var e;this.setState({phase:me.Display}),this.value=this.props.initialValue,this.showPlaceholder(!this.value),this.onValueChanged(!1),null===(e=this.editableDiv.current)||void 0===e||e.blur()})),i()(this,"onValueChanged",(e=>{var t,a;null===(t=(a=this.props).onValueChanged)||void 0===t||t.call(a,this.value,e)})),i()(this,"onKeyDown",(e=>{this.placeholder&&this.showPlaceholder(!1);if(Object(de.a)().getAccessibilityAction(e)===ce.h.Enter)e.stopPropagation(),e.preventDefault()})),i()(this,"onKeyUp",(e=>{if(e.target.textContent){if(!this.placeholder){var t;this.value=null!==(t=e.target.textContent)&&void 0!==t?t:""}}else this.showPlaceholder(!0);switch(Object(de.a)().getAccessibilityAction(e)){case ce.h.Escape:this.cancelEdit();break;case ce.h.Enter:this.onFinish(e)}})),i()(this,"onClickDiv",(()=>{this.props.editable&&this.setState({phase:me.Edit})})),i()(this,"onFocus",(e=>{const t=e.target.childNodes[0];if(t){const a=document.createRange();a.setStart(t,0),a.setEnd(t,e.target.childNodes.length);const n=window.getSelection();n.removeAllRanges(),n.addRange(a)}})),i()(this,"onFinish",(function(e){let a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=t,i=Object(de.a)().getAccessibilityAction(e)===ce.h.Enter||a;t.setState({phase:me.Display},(()=>{t.value!==t.props.initialValue&&n.onValueChanged(i)}))})),i()(this,"onBlur",(e=>{window.getSelection().removeAllRanges(),this.props.blurToCancel?this.cancelEdit():this.onFinish(e,this.props.blurToSubmit),this.showPlaceholder(!this.value)})),this.state={phase:me.Display}}componentDidUpdate(e){e.initialValue!==this.props.initialValue&&(this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value))}componentDidMount(){this.value=this.props.initialValue,this.editableDiv.current&&this.showPlaceholder(!this.value)}render(){const{className:e,editable:t,initialValue:a,label:n,labelClassName:i}=this.props;let s;return s=!t||this.state.phase===me.Display&&(n||i)&&!this.value?o.a.createElement("div",{className:e+" "+i,onClick:this.onClickDiv},n||a):o.a.createElement("div",{ref:this.editableDiv,contentEditable:!0,className:e,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onFocus:this.onFocus,onBlur:this.onBlur}),s}}i()(he,"defaultProps",{onValueChanged(){},initialValue:"",label:"",placeholder:"",editable:!0,className:"mx_EditableText",placeholderClassName:"mx_EditableText_placeholder",blurToSubmit:!1});class ue extends o.a.Component{constructor(e){super(e),i()(this,"addThreepid",void 0),i()(this,"onEmailAddressChanged",(e=>{this.setState({emailAddress:e})})),i()(this,"onSubmit",(()=>{const e=this.state.emailAddress;X.a(e)?(this.addThreepid=new $,this.addThreepid.addEmailAddress(e).then((()=>{g.b.createDialog(le.a,{title:Object(l.b)("Verification Pending"),description:Object(l.b)("Please check your email and click on the link it contains. Once this is done, click continue."),button:Object(l.b)("Continue"),onFinished:this.onEmailDialogFinished})}),(t=>{this.setState({emailBusy:!1}),d.a.error("Unable to add email address "+e+" "+t),g.b.createDialog(b.a,{title:Object(l.b)("Unable to add email address"),description:Object(b.b)(t,Object(l.b)("Operation failed"))})})),this.setState({emailBusy:!0})):g.b.createDialog(b.a,{title:Object(l.b)("Invalid Email Address"),description:Object(l.b)("This doesn't appear to be a valid email address")})})),i()(this,"onCancelled",(()=>{this.props.onFinished(!1)})),i()(this,"onEmailDialogFinished",(e=>{e?this.verifyEmailAddress():this.setState({emailBusy:!1})})),this.state={emailAddress:"",emailBusy:!1}}verifyEmailAddress(){this.addThreepid.checkEmailLinkClicked().then((()=>{this.props.onFinished(!0)}),(e=>{this.setState({emailBusy:!1});let t=e;if(e instanceof l.a&&(t=e.cause),t instanceof m.MatrixError&&"M_THREEPID_AUTH_FAILED"===t.errcode){const e=Object(l.b)("Unable to verify email address.")+" "+Object(l.b)("Please check your email and click on the link it contains. Once this is done, click continue.");g.b.createDialog(le.a,{title:Object(l.b)("Verification Pending"),description:e,button:Object(l.b)("Continue"),onFinished:this.onEmailDialogFinished})}else d.a.error("Unable to verify email address: "+e),g.b.createDialog(b.a,{title:Object(l.b)("Unable to verify email address."),description:Object(b.b)(e,Object(l.b)("Operation failed"))})}))}render(){const e=this.state.emailBusy?o.a.createElement(k.a,null):o.a.createElement(he,{initialValue:this.state.emailAddress,className:"mx_SetEmailDialog_email_input",placeholder:Object(l.b)("Email address"),placeholderClassName:"mx_SetEmailDialog_email_input_placeholder",blurToCancel:!1,onValueChanged:this.onEmailAddressChanged});return o.a.createElement(M.a,{className:"mx_SetEmailDialog",onFinished:this.onCancelled,title:this.props.title,contentId:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("p",{id:"mx_Dialog_content"},Object(l.b)("This will allow you to reset your password and receive notifications.")),e),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:Object(l.b)("Continue"),onClick:this.onSubmit}),o.a.createElement("input",{type:"submit",value:Object(l.b)("Skip"),onClick:this.onCancelled})))}}const pe="field_old_password",ge="field_new_password",be="field_new_password_confirm";var ve=function(e){return e.Edit="edit",e.Uploading="uploading",e.Error="error",e}(ve||{});class fe extends o.a.Component{constructor(e){super(e),i()(this,pe,void 0),i()(this,ge,void 0),i()(this,be,void 0),i()(this,"onExportE2eKeysClicked",(()=>{g.b.createDialogAsync(a.e(7).then(a.bind(null,1733)),{matrixClient:h.a.get()})})),i()(this,"onChangeOldPassword",(e=>{this.setState({oldPassword:e.target.value})})),i()(this,"onOldPasswordValidate",(async e=>{const t=await this.validateOldPasswordRules(e);return this.markFieldValid(pe,t.valid),t})),i()(this,"validateOldPasswordRules",Object(se.a)({rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(l.b)("Passwords can't be empty")}]})),i()(this,"onChangeNewPassword",(e=>{this.setState({newPassword:e.target.value})})),i()(this,"onNewPasswordValidate",(e=>{this.markFieldValid(ge,e.valid)})),i()(this,"onChangeNewPasswordConfirm",(e=>{this.setState({newPasswordConfirm:e.target.value})})),i()(this,"onNewPasswordConfirmValidate",(async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid(be,t.valid),t})),i()(this,"validatePasswordConfirmRules",Object(se.a)({rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(l.b)("Confirm password")},{key:"match",test(e){let{value:t}=e;return!t||t===this.state.newPassword},invalid:()=>Object(l.b)("Passwords don't match")}]})),i()(this,"onClickChange",(async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return;const t=this.state.oldPassword,a=this.state.newPassword,n=this.state.newPasswordConfirm,i=this.checkPassword(t,a,n);if(!i)return this.onChangePassword(t,a);this.props.onError(i)})),this.state={fieldValid:{},phase:ve.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""}}async onChangePassword(e,t){const a=h.a.get(),n=await a.doesServerSupportLogoutDevices(),i=(await a.getDevices()).devices.length>1;if(i&&!n&&this.props.confirm){const{finished:e}=g.b.createDialog(le.a,{title:Object(l.b)("Warning!"),description:o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("Changing your password on this homeserver will cause all of your other devices to be signed out. This will delete the message encryption keys stored on them, and may make encrypted chat history unreadable.")),o.a.createElement("p",null,Object(l.b)("If you want to retain access to your chat history in encrypted rooms you should first export your room keys and re-import them afterwards.")),o.a.createElement("p",null,Object(l.b)("You can also ask your homeserver admin to upgrade the server to change this behaviour."))),button:Object(l.b)("Continue"),extraButtons:[o.a.createElement("button",{key:"exportRoomKeys",className:"mx_Dialog_primary",onClick:this.onExportE2eKeysClicked},Object(l.b)("Export E2E room keys"))]}),[t]=await e;if(!t)return}this.changePassword(a,e,t,n,i)}changePassword(e,t,a,n,i){var s;const o={type:"m.login.password",identifier:{type:"m.id.user",user:e.credentials.userId},user:null!==(s=e.credentials.userId)&&void 0!==s?s:void 0,password:t};this.setState({phase:ve.Uploading});const r=!n&&void 0,l=!n&&i;e.setPassword(o,a,r).then((()=>{if(this.props.shouldAskForEmail)return this.optionallySetEmail().then((e=>{this.props.onFinished({didSetEmail:e,didLogoutOutOtherDevices:l})}));this.props.onFinished({didLogoutOutOtherDevices:l})}),(e=>{this.props.onError(e)})).finally((()=>{this.setState({phase:ve.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""})}))}checkPassword(e,t,a){return t!==a?{error:Object(l.b)("New passwords don't match")}:t&&0!==t.length?void 0:{error:Object(l.b)("Passwords can't be empty")}}optionallySetEmail(){return g.b.createDialog(ue,{title:Object(l.b)("Do you want to set an email address?")}).finished.then((e=>{let[t]=e;return!!t}))}markFieldValid(e,t){const{fieldValid:a}=this.state;a[e]=t,this.setState({fieldValid:a})}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[pe,ge,be];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const a=this.findFirstInvalidField(t);return!a||(a.focus(),a.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}render(){const e=this.props.rowClassName,t=this.props.buttonClassName;switch(this.state.phase){case ve.Edit:return o.a.createElement("form",{className:this.props.className,onSubmit:this.onClickChange},o.a.createElement("div",{className:e},o.a.createElement(u.a,{ref:e=>this[pe]=e,type:"password",label:Object(l.b)("Current password"),value:this.state.oldPassword,onChange:this.onChangeOldPassword,onValidate:this.onOldPasswordValidate})),o.a.createElement("div",{className:e},o.a.createElement(oe.a,{fieldRef:e=>this[ge]=e,type:"password",label:Object(l.d)("New Password"),minScore:re.a,value:this.state.newPassword,autoFocus:this.props.autoFocusNewPasswordInput,onChange:this.onChangeNewPassword,onValidate:this.onNewPasswordValidate,autoComplete:"new-password"})),o.a.createElement("div",{className:e},o.a.createElement(u.a,{ref:e=>this[be]=e,type:"password",label:Object(l.b)("Confirm password"),value:this.state.newPasswordConfirm,onChange:this.onChangeNewPasswordConfirm,onValidate:this.onNewPasswordConfirmValidate,autoComplete:"new-password"})),o.a.createElement(f.a,{className:t,kind:this.props.buttonKind,onClick:this.onClickChange},this.props.buttonLabel||Object(l.b)("Change Password")));case ve.Uploading:return o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement(k.a,null))}}}i()(fe,"defaultProps",{onFinished(){},onError(){},confirm:!0});var Ee=a(193);class ye extends o.a.Component{constructor(e){super(e),i()(this,"togglePolicy",(e=>{const t=Object(Ee.a)(this.state.policies);t[e].checked=!t[e].checked,this.setState({policies:t})})),i()(this,"onContinue",(()=>{!!this.state.policies.some((e=>!e.checked))||(this.setState({busy:!0}),this.props.onFinished(this.state.policies.map((e=>e.url))))})),this.state={policies:[],busy:!1}}componentDidMount(){const e=[];for(const t of this.props.policiesAndServicePairs){const a=Object.values(t.policies);for(const t of a){const a=Object(l.j)(Object.keys(t).filter((e=>"version"!==e))),n={checked:!1,url:t[a].url,name:t[a].name};e.push(n)}}this.setState({policies:e})}renderCheckboxes(){const e=[];for(let t=0;t<this.state.policies.length;t++){const a=this.state.policies[t],n=Object(l.b)("Accept <policyLink /> to continue:",{},{policyLink:()=>o.a.createElement("a",{href:a.url,rel:"noreferrer noopener",target:"_blank"},a.name,o.a.createElement("span",{className:"mx_InlineTermsAgreement_link"}))});e.push(o.a.createElement("div",{key:t,className:"mx_InlineTermsAgreement_cbContainer"},o.a.createElement("div",null,n),o.a.createElement("div",{className:"mx_InlineTermsAgreement_checkbox"},o.a.createElement(D.b,{onChange:()=>this.togglePolicy(t),checked:a.checked},Object(l.b)("Accept")))))}return e}render(){const e=!!this.state.policies.some((e=>!e.checked));return o.a.createElement("div",null,this.props.introElement,this.renderCheckboxes(),o.a.createElement(f.a,{onClick:this.onContinue,disabled:e||this.state.busy,kind:"primary_sm"},Object(l.b)("Continue")))}}var _e=a(262),Se=a.n(_e),we=a(453),Oe=a(410),Ce=a(211);class xe extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"onAction",(e=>{"id_server_changed"===e.action&&this.setState({currentClientIdServer:h.a.get().getIdentityServerUrl()})})),i()(this,"onIdentityServerChanged",(e=>{const t=e.target.value;this.setState({idServer:t})})),i()(this,"getTooltip",(()=>this.state.checking?o.a.createElement("div",null,o.a.createElement(Ce.a,null),Object(l.b)("Checking server")):this.state.error?o.a.createElement("span",{className:"warning"},this.state.error):null)),i()(this,"idServerChangeEnabled",(()=>!!this.state.idServer&&!this.state.busy)),i()(this,"saveIdServer",(e=>{h.a.get().setAccountData("m.identity_server",{base_url:e}),this.setState({busy:!1,error:void 0,currentClientIdServer:e,idServer:""})})),i()(this,"checkIdServer",(async e=>{var t;e.preventDefault();const{idServer:a,currentClientIdServer:n}=this.state;this.setState({busy:!0,checking:!0,error:void 0});const i=Object(V.b)(a);let s=await async function(e){if("https:"!==Se.a.parse(e).protocol)return Object(l.b)("Identity server URL must be HTTPS");try{const t=await fetch(e+"/_matrix/identity/v2");return t.ok?null:t.status<200||t.status>=300?Object(l.b)("Not a valid identity server (status code %(code)s)",{code:t.status}):Object(l.b)("Could not connect to identity server")}catch(e){return Object(l.b)("Could not connect to identity server")}}(i);if(!s)try{this.setState({checking:!1});const e=new B.a(i);await e.getAccessToken();let t=!0;if(!await Object(we.b)(i)){const[e]=await this.showNoTermsWarning(i);t=!!e}if(t&&n&&i!==n){const[e]=await this.showServerChangeWarning({title:Object(l.b)("Change identity server"),unboundMessage:Object(l.b)("Disconnect from the identity server <current /> and connect to <new /> instead?",{},{current:e=>o.a.createElement("b",null,Object(V.a)(n)),new:e=>o.a.createElement("b",null,Object(V.a)(a))}),button:Object(l.b)("Continue")});t=!!e}t&&this.saveIdServer(i)}catch(e){d.a.error(e),s=Object(l.b)("Terms of service not accepted or the identity server is invalid.")}this.setState({busy:!1,checking:!1,error:null!==(t=s)&&void 0!==t?t:void 0,currentClientIdServer:h.a.get().getIdentityServerUrl()})})),i()(this,"onDisconnectClicked",(async()=>{this.setState({disconnectBusy:!0});try{const[e]=await this.showServerChangeWarning({title:Object(l.b)("Disconnect identity server"),unboundMessage:Object(l.b)("Disconnect from the identity server <idserver />?",{},{idserver:e=>o.a.createElement("b",null,Object(V.a)(this.state.currentClientIdServer))}),button:Object(l.b)("Disconnect")});e&&this.disconnectIdServer()}finally{this.setState({disconnectBusy:!1})}})),i()(this,"disconnectIdServer",(()=>{h.a.get().setAccountData("m.identity_server",{base_url:null});let e="";Object(we.c)()&&(e=Object(V.a)(Object(we.c)())),this.setState({busy:!1,error:void 0,currentClientIdServer:h.a.get().getIdentityServerUrl(),idServer:e})}));let t="";!h.a.get().getIdentityServerUrl()&&Object(we.c)()&&(t=Object(V.a)(Object(we.c)())),this.state={defaultIdServer:t,currentClientIdServer:h.a.get().getIdentityServerUrl(),idServer:"",busy:!1,disconnectBusy:!1,checking:!1}}componentDidMount(){this.dispatcherRef=A.a.register(this.onAction)}componentWillUnmount(){A.a.unregister(this.dispatcherRef)}showNoTermsWarning(e){const{finished:t}=g.b.createDialog(le.a,{title:Object(l.b)("Identity server has no terms of service"),description:o.a.createElement("div",null,o.a.createElement("span",{className:"warning"},Object(l.b)("The identity server you have chosen does not have any terms of service.")),o.a.createElement("span",null," ",Object(l.b)("Only continue if you trust the owner of the server."))),button:Object(l.b)("Continue")});return t}async showServerChangeWarning(e){let{title:t,unboundMessage:a,button:n}=e;const{currentClientIdServer:i}=this.state;let s=[],r=!0;try{s=await Object(Oe.b)(W(h.a.get()),Promise.reject(new Error("Timeout attempting to reach identity server")),1e4)}catch(e){r=!1,d.a.warn(`Unable to reach identity server at ${i} to check for 3PIDs during IS change flow`),d.a.warn(e)}const c=s.filter((e=>e.bound));let m,u=!1;const p={idserver:e=>o.a.createElement("b",null,Object(V.a)(i)),b:e=>o.a.createElement("b",null,e)};r?c.length?(m=o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("You are still <b>sharing your personal data</b> on the identity server <idserver />.",{},p)),o.a.createElement("p",null,Object(l.b)("We recommend that you remove your email addresses and phone numbers from the identity server before disconnecting."))),u=!0,n=Object(l.b)("Disconnect anyway")):m=a:(m=o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("You should <b>remove your personal data</b> from identity server <idserver /> before disconnecting. Unfortunately, identity server <idserver /> is currently offline or cannot be reached.",{},p)),o.a.createElement("p",null,Object(l.b)("You should:")),o.a.createElement("ul",null,o.a.createElement("li",null,Object(l.b)("check your browser plugins for anything that might block the identity server (such as Privacy Badger)")),o.a.createElement("li",null,Object(l.b)("contact the administrators of identity server <idserver />",{},{idserver:p.idserver})),o.a.createElement("li",null,Object(l.b)("wait and try again later")))),u=!0,n=Object(l.b)("Disconnect anyway"));const{finished:b}=g.b.createDialog(le.a,{title:t,description:m,button:n,cancelButton:Object(l.b)("Go back"),danger:u});return b}render(){const e=this.state.currentClientIdServer;let t,a,n;if(e?(t=Object(l.b)("Identity server (%(server)s)",{server:Object(V.a)(e)}),a=Object(l.b)("You are currently using <server></server> to discover and be discoverable by existing contacts you know. You can change your identity server below.",{},{server:t=>o.a.createElement("b",null,Object(V.a)(e))}),this.props.missingTerms&&(a=Object(l.b)("If you don't want to use <server /> to discover and be discoverable by existing contacts you know, enter another identity server below.",{},{server:t=>o.a.createElement("b",null,Object(V.a)(e))}))):(t=Object(l.b)("Identity server"),a=Object(l.b)("You are not currently using an identity server. To discover and be discoverable by existing contacts you know, add one below.")),e){let e=Object(l.b)("Disconnect"),t=Object(l.b)("Disconnecting from your identity server will mean you won't be discoverable by other users and you won't be able to invite others by email or phone.");this.props.missingTerms&&(t=Object(l.b)("Using an identity server is optional. If you choose not to use an identity server, you won't be discoverable by other users and you won't be able to invite others by email or phone."),e=Object(l.b)("Do not use an identity server")),this.state.disconnectBusy&&(e=o.a.createElement(Ce.a,null)),n=o.a.createElement("div",null,o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},t),o.a.createElement(f.a,{onClick:this.onDisconnectClicked,kind:"danger_sm"},e))}return o.a.createElement("form",{className:"mx_SetIdServer",onSubmit:this.checkIdServer},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},t),o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},a),o.a.createElement(u.a,{label:Object(l.b)("Enter a new identity server"),type:"text",autoComplete:"off",placeholder:this.state.defaultIdServer,value:this.state.idServer,onChange:this.onIdentityServerChanged,tooltipContent:this.getTooltip(),tooltipClassName:"mx_SetIdServer_tooltip",disabled:this.state.busy,forceValidity:!this.state.error&&void 0}),o.a.createElement(f.a,{type:"submit",kind:"primary_sm",onClick:this.checkIdServer,disabled:!this.idServerChangeEnabled()},Object(l.b)("Change")),n)}}var je=a(292),ke=a(397);class Re extends o.a.Component{constructor(e){super(e),i()(this,"onProvisioningToggled",(()=>{const e=this.state.provisioningEnabled;O.b.setValue("integrationProvisioning",null,z.a.ACCOUNT,!e).catch((t=>{d.a.error("Error changing integration manager provisioning"),d.a.error(t),this.setState({provisioningEnabled:e})})),this.setState({provisioningEnabled:!e})}));const t=je.a.sharedInstance().getPrimaryManager();this.state={currentManager:t,provisioningEnabled:O.b.getValue("integrationProvisioning")}}render(){const e=this.state.currentManager;let t,a;return e?(t=`(${e.name})`,a=Object(l.b)("Use an integration manager <b>(%(serverName)s)</b> to manage bots, widgets, and sticker packs.",{serverName:e.name},{b:e=>o.a.createElement("b",null,e)})):a=Object(l.b)("Use an integration manager to manage bots, widgets, and sticker packs."),o.a.createElement("label",{className:"mx_SetIntegrationManager",htmlFor:"toggle_integration"},o.a.createElement("div",{className:"mx_SettingsFlag"},o.a.createElement("div",{className:"mx_SetIntegrationManager_heading_manager"},o.a.createElement("span",{className:"mx_SettingsTab_heading"},Object(l.b)("Manage integrations")),o.a.createElement("span",{className:"mx_SettingsTab_subheading"},t)),o.a.createElement(ke.a,{id:"toggle_integration",checked:this.state.provisioningEnabled,disabled:!1,onChange:this.onProvisioningToggled})),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},a),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Integration managers receive configuration data, and can modify widgets, send room invites, and set power levels on your behalf.")))}}var Ie=a(208);function Te(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Ne(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Te(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Te(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Pe extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"onAction",(e=>{"id_server_changed"===e.action&&(this.setState({haveIdServer:Boolean(h.a.get().getIdentityServerUrl())}),this.getThreepidState())})),i()(this,"onEmailsChange",(e=>{this.setState({emails:e})})),i()(this,"onMsisdnsChange",(e=>{this.setState({msisdns:e})})),i()(this,"onLanguageChange",(e=>{if(this.state.language===e)return;O.b.setValue("language",null,z.a.DEVICE,e),this.setState({language:e});const t=j.a.get();t&&(t.setLanguage([e]),t.reload())})),i()(this,"onSpellCheckLanguagesChange",(e=>{var t;this.setState({spellCheckLanguages:e}),null===(t=j.a.get())||void 0===t||t.setSpellCheckLanguages(e)})),i()(this,"onSpellCheckEnabledChange",(e=>{var t;this.setState({spellCheckEnabled:e}),null===(t=j.a.get())||void 0===t||t.setSpellCheckEnabled(e)})),i()(this,"onPasswordChangeError",(e=>{let t=e.error||e.message||"";403===e.httpStatus?t=Object(l.b)("Failed to change password. Is your password correct?"):t||(t+=` (HTTP status ${e.httpStatus})`),d.a.error("Failed to change password: "+t),g.b.createDialog(b.a,{title:Object(l.b)("Error"),description:t})})),i()(this,"onPasswordChanged",(e=>{let{didLogoutOutOtherDevices:t}=e,a=Object(l.b)("Your password was successfully changed.");t&&(a+=" "+Object(l.b)("You will not receive push notifications on other devices until you sign back in to them.")),g.b.createDialog(b.a,{title:Object(l.b)("Success"),description:a})})),i()(this,"onDeactivateClicked",(()=>{g.b.createDialog(L,{onFinished:e=>{e&&this.props.closeSettingsFn()}})})),this.state={language:l.f(),spellCheckEnabled:!1,spellCheckLanguages:[],haveIdServer:Boolean(h.a.get().getIdentityServerUrl()),idServerHasUnsignedTerms:!1,requiredPolicyInfo:{hasTerms:!1,policiesAndServices:null,agreedUrls:null,resolve:null},emails:[],msisdns:[],loading3pids:!0,canChangePassword:!1},this.dispatcherRef=A.a.register(this.onAction),this.getCapabilities(),this.getThreepidState()}async componentDidMount(){const e=j.a.get(),[t,a]=await Promise.all([null==e?void 0:e.getSpellCheckEnabled(),null==e?void 0:e.getSpellCheckLanguages()]);a&&this.setState({spellCheckEnabled:t,spellCheckLanguages:a})}componentWillUnmount(){A.a.unregister(this.dispatcherRef)}async getCapabilities(){const e=h.a.get(),t=await e.doesServerSupportSeparateAddAndBind(),a=(await e.getCapabilities())["m.change_password"],n=!a||!1!==a.enabled,i=m.M_AUTHENTICATION.findIn(e.getClientWellKnown()),s=null==i?void 0:i.account;this.setState({serverSupportsSeparateAddAndBind:t,canChangePassword:n,externalAccountManagementUrl:s})}async getThreepidState(){const e=h.a.get();this.checkTerms();let t=[];try{t=await W(e)}catch(e){const t=h.a.get().getIdentityServerUrl();d.a.warn(`Unable to reach identity server at ${t} to check for 3PIDs bindings in Settings`),d.a.warn(e)}this.setState({emails:t.filter((e=>"email"===e.medium)),msisdns:t.filter((e=>"msisdn"===e.medium)),loading3pids:!1})}async checkTerms(){if(!this.state.haveIdServer)return void this.setState({idServerHasUnsignedTerms:!1});const e=h.a.get().getIdentityServerUrl(),t=new B.a;try{const a=await t.getAccessToken({check:!1});await Object(F.d)([new F.a(c.a.IS,e,a)],((t,a,n)=>new Promise(((n,i)=>{this.setState({idServerName:Object(V.a)(e),requiredPolicyInfo:{hasTerms:!0,policiesAndServices:t,agreedUrls:a,resolve:n}})})))),this.setState({requiredPolicyInfo:Ne(Ne({},this.state.requiredPolicyInfo),{},{hasTerms:!1})})}catch(t){d.a.warn(`Unable to reach identity server at ${e} to check for terms in Settings`),d.a.warn(t)}}renderProfileSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement(w,null))}renderAccountSection(){let e=o.a.createElement(fe,{className:"mx_GeneralUserSettingsTab_changePassword",rowClassName:"",buttonKind:"primary",onError:this.onPasswordChangeError,onFinished:this.onPasswordChanged}),t=null;if(O.b.getValue(H.b.ThirdPartyID)&&(this.state.haveIdServer||!0===this.state.serverSupportsSeparateAddAndBind)){const e=this.state.loading3pids?o.a.createElement(k.a,null):o.a.createElement(ee,{emails:this.state.emails,onEmailsChange:this.onEmailsChange}),a=this.state.loading3pids?o.a.createElement(k.a,null):o.a.createElement(Q,{msisdns:this.state.msisdns,onMsisdnsChange:this.onMsisdnsChange});t=o.a.createElement("div",null,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Email addresses")),e,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Phone numbers")),a)}else null===this.state.serverSupportsSeparateAddAndBind&&(t=o.a.createElement(k.a,null));let a,n=Object(l.b)("Set a new account password…");if(this.state.canChangePassword||(n=null,e=null),this.state.externalAccountManagementUrl){const{hostname:e}=new URL(this.state.externalAccountManagementUrl);a=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",{className:"mx_SettingsTab_subsectionText","data-testid":"external-account-management-outer"},Object(l.b)("Your account details are managed separately at <code>%(hostname)s</code>.",{hostname:e},{code:e=>o.a.createElement("code",null,e)})),o.a.createElement(f.a,{onClick:null,element:"a",kind:"primary",target:"_blank",rel:"noreferrer noopener",href:this.state.externalAccountManagementUrl,"data-testid":"external-account-management-link"},Object(l.b)("Manage account")))}return o.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralUserSettingsTab_accountSection"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Account")),a,o.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},n),e,t)}renderLanguageSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Language and region")),o.a.createElement(C.a,{className:"mx_GeneralUserSettingsTab_languageInput",onOptionChange:this.onLanguageChange,value:this.state.language}))}renderSpellCheckSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_section_spellcheck"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Spell check"),o.a.createElement(ke.a,{checked:!!this.state.spellCheckEnabled,onChange:this.onSpellCheckEnabledChange})),this.state.spellCheckEnabled&&!Ie.a&&o.a.createElement(T,{languages:this.state.spellCheckLanguages,onLanguagesChange:this.onSpellCheckLanguagesChange}))}renderDiscoverySection(){if(this.state.requiredPolicyInfo.hasTerms){const e=o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Agree to the identity server (%(serverName)s) Terms of Service to allow yourself to be discoverable by email address or phone number.",{serverName:this.state.idServerName}));return o.a.createElement("div",null,o.a.createElement(ye,{policiesAndServicePairs:this.state.requiredPolicyInfo.policiesAndServices,agreedUrls:this.state.requiredPolicyInfo.agreedUrls,onFinished:this.state.requiredPolicyInfo.resolve,introElement:e}),o.a.createElement(xe,{missingTerms:!0}))}const e=this.state.loading3pids?o.a.createElement(k.a,null):o.a.createElement(ae,{emails:this.state.emails}),t=this.state.loading3pids?o.a.createElement(k.a,null):o.a.createElement(ie,{msisdns:this.state.msisdns}),a=this.state.haveIdServer?o.a.createElement("div",{className:"mx_GeneralUserSettingsTab_discovery"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Email addresses")),e,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Phone numbers")),t):null;return o.a.createElement("div",{className:"mx_SettingsTab_section"},a,o.a.createElement(xe,{missingTerms:!1}))}renderManagementSection(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Account management")),o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Deactivating your account is a permanent action — be careful!")),o.a.createElement(f.a,{onClick:this.onDeactivateClicked,kind:"danger"},Object(l.b)("Deactivate Account")))}renderIntegrationManagerSection(){return O.b.getValue(H.b.Widgets)?o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement(Re,null)):null}render(){const e=j.a.get(),t=null==e?void 0:e.supportsSpellCheckSettings(),n=this.state.requiredPolicyInfo.hasTerms?o.a.createElement("img",{className:"mx_GeneralUserSettingsTab_warningIcon",src:a(807).default,width:"18",height:"18",alt:Object(l.b)("Warning")}):null;let i,s;return O.b.getValue(H.b.Deactivate)&&(i=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Deactivate account")),this.renderManagementSection())),O.b.getValue(H.b.IdentityServer)&&(s=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},n," ",Object(l.b)("Discovery")),this.renderDiscoverySection())),o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("General")),this.renderProfileSection(),this.renderAccountSection(),this.renderLanguageSection(),t?this.renderSpellCheckSection():null,s,this.renderIntegrationManagerSection(),i)}}var De=a(150),Me=a(132),Ae=a(293),Ue=a(225),Le=a(291),Fe=a(468);class Be extends o.a.Component{constructor(e){super(e),i()(this,"labs",void 0),i()(this,"betas",void 0);const t=O.b.getFeatureSettingNames(),[a,n]=t.reduce(((e,t)=>(e[O.b.getBetaInfo(t)?1:0].push(t),e)),[[],[]]);this.labs=a,this.betas=n,Me.b.get("show_labs_settings")||(this.labs=[])}render(){let e,t;if(this.betas.length&&(e=o.a.createElement("div",{"data-testid":"labs-beta-section",className:"mx_SettingsTab_section"},this.betas.map((e=>o.a.createElement(Ae.b,{key:e,featureId:e}))))),this.labs.length){const e=new Fe.a;this.labs.forEach((t=>{e.getOrCreate(O.b.getLabGroup(t),[]).push(o.a.createElement(Ue.a,{level:z.a.DEVICE,name:t,key:t}))})),e.getOrCreate(Le.b.Experimental,[]).push(o.a.createElement(Ue.a,{key:"lowBandwidth",name:"lowBandwidth",level:z.a.DEVICE})),e.getOrCreate(Le.b.Analytics,[]).push(o.a.createElement(Ue.a,{key:"automaticErrorReporting",name:"automaticErrorReporting",level:z.a.DEVICE}),o.a.createElement(Ue.a,{key:"automaticDecryptionErrorReporting",name:"automaticDecryptionErrorReporting",level:z.a.DEVICE})),t=o.a.createElement(o.a.Fragment,null,Object(De.sortBy)(Array.from(e.entries()),"0").map((e=>{let[t,a]=e;return o.a.createElement("div",{className:"mx_SettingsTab_section",key:t,"data-testid":`labs-group-${t}`},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)(Le.e[t])),a)})))}return o.a.createElement("div",{className:"mx_SettingsTab mx_LabsUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Upcoming features")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("What's next for %(brand)s? Labs are the best way to get things early, test out new features and help shape them before they actually launch.",{brand:Me.b.get("brand")})),e,t&&o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Early previews")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Feeling experimental? Try out our latest ideas in development. These features are not finalised; they may be unstable, may change, or may be dropped altogether. <a>Learn more</a>.",{},{a:e=>o.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/develop/docs/labs.md",rel:"noreferrer noopener",target:"_blank"},e)})),t))}}var Ve=a(127),We=a.n(Ve),ze=a(146),He=a(130),Ke=a(240),Ge=a(363),qe=a(173);class $e extends o.a.Component{constructor(e){super(e),this.state={message:e.message}}fakeEvent(e){var t=this;let{message:a}=e;const n={type:"m.room.message",sender:this.props.userId,content:{"m.new_content":{msgtype:He.e.Text,body:a,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},msgtype:He.e.Text,body:a,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:"!999999999999999999:example.org"},i=new ze.b(n);return i.sender={name:this.props.displayName||this.props.userId,rawDisplayName:this.props.displayName,userId:this.props.userId,getAvatarUrl:function(){return Ke.c({avatarUrl:t.props.avatarUrl},32,32,"crop")},getMxcAvatarUrl:()=>this.props.avatarUrl},i}render(){const e=We()(this.props.className,{mx_IRCLayout:this.props.layout===qe.a.IRC,sc_BubbleLayout:this.props.layout===qe.a.Bubble,mx_EventTilePreview_loader:!this.props.userId});if(!this.props.userId)return o.a.createElement("div",{className:e},o.a.createElement(k.a,null));const t=this.fakeEvent(this.state);return o.a.createElement("div",{className:e},o.a.createElement(Ge.b,{mxEvent:t,layout:this.props.layout,as:"div"}))}}var Ye=a(237);class Je extends o.a.Component{constructor(e){super(e),i()(this,"onLayoutChange",(e=>{const t=e.target.value;this.setState({layout:t}),O.b.setValue("layout",null,z.a.DEVICE,t),this.props.onLayoutChanged(t)})),this.state={layout:O.b.getValue("layout"),adaptiveSideBubbles:O.b.getValue("adaptiveSideBubbles")}}render(){const e=We()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout==qe.a.IRC}),t=We()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout==qe.a.Group}),a=We()("mx_LayoutSwitcher_RadioButton",{mx_LayoutSwitcher_RadioButton_selected:this.state.layout===qe.a.Bubble});return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Message layout")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_LayoutSwitcher"},o.a.createElement("div",{className:"mx_LayoutSwitcher_RadioButtons"},o.a.createElement("label",{className:e},o.a.createElement($e,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:qe.a.IRC,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.a.createElement(Ye.a,{name:"layout",value:qe.a.IRC,checked:this.state.layout===qe.a.IRC,onChange:this.onLayoutChange},Object(l.b)("IRC (Experimental)"))),o.a.createElement("label",{className:t},o.a.createElement($e,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:qe.a.Group,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.a.createElement(Ye.a,{name:"layout",value:qe.a.Group,checked:this.state.layout==qe.a.Group,onChange:this.onLayoutChange},Object(l.b)("Modern"))),o.a.createElement("label",{className:a},o.a.createElement($e,{className:"mx_LayoutSwitcher_RadioButton_preview",message:this.props.messagePreviewText,layout:qe.a.Bubble,userId:this.props.userId,displayName:this.props.displayName,avatarUrl:this.props.avatarUrl}),o.a.createElement(Ye.a,{name:"layout",value:qe.a.Bubble,checked:this.state.layout==qe.a.Bubble,onChange:this.onLayoutChange},Object(l.b)("Message bubbles")))),o.a.createElement("div",{className:"mx_LayoutSwitcher_Checkboxes"},this.state.layout===qe.a.Group?o.a.createElement(Ue.a,{name:"useCompactLayout",level:z.a.DEVICE,useCheckbox:!0}):null,this.state.layout===qe.a.Bubble?o.a.createElement(Ue.a,{name:"singleSideBubbles",level:z.a.DEVICE,useCheckbox:!0,disabled:this.state.adaptiveSideBubbles}):null,this.state.layout===qe.a.Bubble?o.a.createElement(Ue.a,{name:"adaptiveSideBubbles",level:z.a.DEVICE,useCheckbox:!0,onChange:e=>this.setState({adaptiveSideBubbles:e})}):null)))}}var Qe=a(474);class Xe extends s.Component{constructor(){super(...arguments),i()(this,"onChange",(e=>{this.props.onChange(parseInt(e.target.value,10))}))}get position(){const{min:e,max:t,value:a}=this.props;return Number(100*(a-e)/(t-e))}render(){let e;if(!this.props.disabled){const t=this.position;e=s.createElement("output",{className:"mx_Slider_selection",style:{left:`calc(2px + ${t}% + 1.2em - ${t/100*2.4}em)`}},s.createElement("span",{className:"mx_Slider_selection_label"},this.props.value))}return s.createElement("div",{className:"mx_Slider"},s.createElement("input",{type:"range",min:this.props.min,max:this.props.max,value:this.props.value,onChange:this.onChange,disabled:this.props.disabled,step:this.props.step,autoComplete:"off","aria-label":this.props.label}),e)}}var Ze=a(490),et=a(280);class tt extends o.a.Component{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"onFontSizeChanged",(e=>{this.setState({fontSize:e.toString()}),O.b.setValue("baseFontSize",null,z.a.DEVICE,e-Ze.a.SIZE_DIFF)})),i()(this,"onValidateFontSize",(async e=>{let{value:t}=e;const a=parseFloat(t),n=Ze.a.MIN_SIZE+Ze.a.SIZE_DIFF,i=Ze.a.MAX_SIZE+Ze.a.SIZE_DIFF;return isNaN(a)?{valid:!1,feedback:Object(l.b)("Size must be a number")}:n<=a&&a<=i?(O.b.setValue("baseFontSize",null,z.a.DEVICE,parseInt(t,10)-Ze.a.SIZE_DIFF),{valid:!0,feedback:Object(l.b)("Use between %(min)s pt and %(max)s pt",{min:n,max:i})}):{valid:!1,feedback:Object(l.b)("Custom font size can only be between %(min)s pt and %(max)s pt",{min:n,max:i})}})),this.state={fontSize:(O.b.getValue("baseFontSize",null)+Ze.a.SIZE_DIFF).toString(),useCustomFontSize:O.b.getValue("useCustomFontSize"),layout:O.b.getValue("layout"),useSystemFont:O.b.getValue("useSystemFont"),systemFont:O.b.getValue("systemFont")}}async componentDidMount(){const e=h.a.get(),t=e.getUserId(),a=await e.getProfileInfo(t);this.unmounted||this.setState({userId:t,displayName:a.displayname,avatarUrl:a.avatar_url})}componentWillUnmount(){this.unmounted=!0}render(){const e=Me.b.get().brand,t=Object(l.b)("Set the name of a font installed on your system & %(brand)s will attempt to use it.",{brand:e});return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Font size and typeface")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_FontScalingPanel_fontScaling"},o.a.createElement("div",{className:"mx_FontScalingPanel_fontSlider"},o.a.createElement("div",{className:"mx_FontScalingPanel_fontSlider_smallText"},"Aa"),o.a.createElement(Xe,{min:13,max:18,step:1,value:parseInt(this.state.fontSize,10),onChange:this.onFontSizeChanged,displayFunc:e=>"",disabled:this.state.useCustomFontSize,label:Object(l.b)("Font size")}),o.a.createElement("div",{className:"mx_FontScalingPanel_fontSlider_largeText"},"Aa")),o.a.createElement("div",{className:"mx_FontScalingPanel_inlineCustomValues"},o.a.createElement("div",null,o.a.createElement(Ue.a,{name:"useCustomFontSize",level:z.a.ACCOUNT,onChange:e=>{if(this.setState({useCustomFontSize:e}),!e){const e=parseInt(this.state.fontSize,10),t=Object(et.a)(e,13,18);t!==e&&this.onFontSizeChanged(t)}},useCheckbox:!0}),o.a.createElement(u.a,{type:"number",label:Object(l.b)("Font size"),autoComplete:"off",placeholder:this.state.fontSize.toString(),value:this.state.fontSize.toString(),id:"font_size_field",onValidate:this.onValidateFontSize,onChange:e=>this.setState({fontSize:e.target.value}),disabled:!this.state.useCustomFontSize,className:"mx_FontScalingPanel_customFontSizeField"})),o.a.createElement("div",null,o.a.createElement(Ue.a,{name:"useSystemFont",level:z.a.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useSystemFont:e})}),o.a.createElement(u.a,{className:"mx_FontScalingPanel_systemFont",label:O.b.getDisplayName("systemFont"),onChange:e=>{this.setState({systemFont:e.target.value}),O.b.setValue("systemFont",null,z.a.DEVICE,e.target.value)},tooltipContent:t,forceTooltipVisible:!0,disabled:!this.state.useSystemFont,value:this.state.systemFont})))))}}var at=a(467),nt=a(343),it=a(349),st=a(336),ot=a(338),rt=a(938);function lt(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function ct(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?lt(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):lt(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class dt extends o.a.Component{constructor(e){super(e),i()(this,"themeTimer",void 0),i()(this,"onLightThemeChange",(e=>{if(this.state.lightTheme===e)return;S.b.trackInteraction("WebSettingsAppearanceTabThemeSelector");const t=O.b.getValue("light_theme");O.b.setValue("light_theme",null,z.a.DEVICE,e).catch((()=>{A.a.dispatch({action:U.a.RecheckTheme}),this.setState({lightTheme:t})})),this.setState({lightTheme:e}),A.a.dispatch({action:U.a.RecheckTheme})})),i()(this,"onDarkThemeChange",(e=>{if(this.state.darkTheme===e)return;const t=O.b.getValue("dark_theme");O.b.setValue("dark_theme",null,z.a.DEVICE,e).catch((()=>{A.a.dispatch({action:U.a.RecheckTheme}),this.setState({darkTheme:t})})),this.setState({darkTheme:e}),A.a.dispatch({action:U.a.RecheckTheme})})),i()(this,"onThemeInUseChange",(e=>{const t=e.target.value;this.setState({themeInUse:t}),O.b.setValue("theme_in_use",null,z.a.DEVICE,t),A.a.dispatch({action:U.a.RecheckTheme})})),i()(this,"onBorderRadiusChange",(e=>{const t=e.target.value;this.setState({borderRadius:t}),O.b.setValue("borderRadius",null,z.a.DEVICE,t)})),i()(this,"onAddCustomTheme",(async()=>{let e=O.b.getValue("custom_themes");e||(e=[]),e=e.map((e=>e)),this.themeTimer&&clearTimeout(this.themeTimer);try{const t=await fetch(this.state.customThemeUrl),a=await t.json();if(!a||"string"!=typeof a.name||"object"!=typeof a.colors)return void this.setState({customThemeMessage:{text:Object(l.b)("Invalid theme schema."),isError:!0}});e.push(a)}catch(e){return d.a.error(e),void this.setState({customThemeMessage:{text:Object(l.b)("Error downloading theme information."),isError:!0}})}await O.b.setValue("custom_themes",null,z.a.ACCOUNT,e),this.setState({customThemeUrl:"",customThemeMessage:{text:Object(l.b)("Theme added!"),isError:!1}}),this.themeTimer=window.setTimeout((()=>{this.setState({customThemeMessage:{text:"",isError:!1}})}),3e3)})),i()(this,"onCustomThemeChange",(e=>{this.setState({customThemeUrl:e.target.value})})),i()(this,"onUserNameColorModeChange",((e,t)=>{const a=t.target.value;this.setState((t=>ct(ct({},t),{},{[e]:a}))),O.b.setValue(e,null,z.a.DEVICE,a)})),this.state={lightTheme:O.b.getValue("light_theme"),darkTheme:O.b.getValue("dark_theme"),themeInUse:O.b.getValue("theme_in_use"),borderRadius:O.b.getValue("borderRadius"),customThemeUrl:"",customThemeMessage:{isError:!1,text:""},showAdvancedThemeSettings:!1,userNameColorModeDM:O.b.getValue("userNameColorModeDM"),userNameColorModeGroup:O.b.getValue("userNameColorModeGroup"),userNameColorModePublic:O.b.getValue("userNameColorModePublic")}}renderUserNameColorModeSection(){const e=(e,t)=>o.a.createElement(Ye.a,{name:e,value:t,checked:this.state[e]===t,onChange:t=>this.onUserNameColorModeChange(e,t)}),t=(t,a)=>o.a.createElement("tr",null,o.a.createElement("td",null,t),o.a.createElement("td",null,e(a,ot.a.Uniform)),o.a.createElement("td",null,e(a,ot.a.PowerLevel)),o.a.createElement("td",null,e(a,ot.a.MXID)));return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel_userNameColorModeSection"},o.a.createElement("table",{className:"mx_SettingsTab_settingsTable"},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("User name color mode"))),o.a.createElement("th",null,Object(l.b)("Uniform")),o.a.createElement("th",null,Object(l.b)("PowerLevel")),o.a.createElement("th",null,Object(l.b)("MXID")))),o.a.createElement("tbody",null,t(Object(l.b)("For people"),"userNameColorModeDM"),t(Object(l.b)("In group chats"),"userNameColorModeGroup"),t(Object(l.b)("In public rooms"),"userNameColorModePublic")))))}render(){const e=new nt.a,t=o.a.createElement("div",{className:"mx_SettingsTab_inlineRadioSelectors"},o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"theme_in_use",value:st.a.Light,checked:this.state.themeInUse===st.a.Light,onChange:this.onThemeInUseChange},Object(l.b)("Light"))),o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"theme_in_use",value:st.a.Dark,checked:this.state.themeInUse===st.a.Dark,onChange:this.onThemeInUseChange},Object(l.b)("Dark"))),e.isSystemThemeSupported()?o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"theme_in_use",value:st.a.System,checked:this.state.themeInUse===st.a.System,onChange:this.onThemeInUseChange},Object(l.b)("System"))):null),a=o.a.createElement("div",{className:"mx_SettingsTab_inlineRadioSelectors"},o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"border_radius",value:rt.a.Default,checked:this.state.borderRadius===rt.a.Default,onChange:this.onBorderRadiusChange},Object(l.b)("Default"))),o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"border_radius",value:rt.a.Round,checked:this.state.borderRadius===rt.a.Round,onChange:this.onBorderRadiusChange},Object(l.b)("Round"))),o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"border_radius",value:rt.a.ExtraRound,checked:this.state.borderRadius===rt.a.ExtraRound,onChange:this.onBorderRadiusChange},Object(l.b)("Extra round"))),o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"border_radius",value:rt.a.Mixed,checked:this.state.borderRadius===rt.a.Mixed,onChange:this.onBorderRadiusChange},Object(l.b)("Mixed"))));let n;if(O.b.getValue("feature_custom_themes")){let e;this.state.customThemeMessage.text&&(e=this.state.customThemeMessage.isError?o.a.createElement("div",{className:"text-error"},this.state.customThemeMessage.text):o.a.createElement("div",{className:"text-success"},this.state.customThemeMessage.text)),n=o.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel_addCustomThemeSection"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Add custom theme")),o.a.createElement("form",{onSubmit:this.onAddCustomTheme},o.a.createElement(u.a,{label:Object(l.b)("Custom theme URL"),type:"text",id:"mx_GeneralUserSettingsTab_customThemeInput",autoComplete:"off",onChange:this.onCustomThemeChange,value:this.state.customThemeUrl}),o.a.createElement(f.a,{onClick:this.onAddCustomTheme,type:"submit",kind:"primary_sm",disabled:!this.state.customThemeUrl.trim()},Object(l.b)("Add theme")),e))}const i=o.a.createElement(f.a,{kind:"link",className:"mx_ThemeChoicePanel_AdvancedToggle",onClick:()=>this.setState({showAdvancedThemeSettings:!this.state.showAdvancedThemeSettings})},this.state.showAdvancedThemeSettings?Object(l.b)("Hide advanced theme settings"):Object(l.b)("Show advanced theme settings"));let s;if(this.state.showAdvancedThemeSettings){const e=Object(at.c)();s=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Light theme")),o.a.createElement("div",{className:"mx_ThemeSelectors"},o.a.createElement(it.a,{name:"light_theme",definitions:e.map((e=>({value:e.id,label:e.name,className:"mx_ThemeSelector_"+e.id}))),onChange:this.onLightThemeChange,value:this.state.lightTheme,outlined:!0}))),o.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Dark theme")),o.a.createElement("div",{className:"mx_ThemeSelectors"},o.a.createElement(it.a,{name:"dark_theme",definitions:e.map((e=>({value:e.id,label:e.name,className:"mx_ThemeSelector_"+e.id}))),onChange:this.onDarkThemeChange,value:this.state.darkTheme,outlined:!0}))),n,this.renderUserNameColorModeSection())}return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Theme")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel_themeInUseSection"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Theme in use")),t),o.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel_borderRadiusSection"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Corners")),a),o.a.createElement("div",{className:"mx_SettingsTab_section mx_ThemeChoicePanel_Advanced"},i,s))}}var mt=a(416);class ht extends o.a.Component{constructor(e){super(e),i()(this,"onSizeChange",(e=>{const t=e.target.value;this.setState({size:t}),O.b.setValue("Images.size",null,z.a.ACCOUNT,t)})),this.state={size:O.b.getValue("Images.size")}}render(){return o.a.createElement("div",{className:"mx_SettingsTab_section mx_ImageSizePanel"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Image size in the timeline")),o.a.createElement("div",{className:"mx_ImageSizePanel_radios"},o.a.createElement("label",null,o.a.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeDefault"}),o.a.createElement(Ye.a,{name:"image_size",value:mt.a.Normal,checked:this.state.size===mt.a.Normal,onChange:this.onSizeChange},Object(l.b)("Default"))),o.a.createElement("label",null,o.a.createElement("div",{className:"mx_ImageSizePanel_size mx_ImageSizePanel_sizeLarge"}),o.a.createElement(Ye.a,{name:"image_size",value:mt.a.Large,checked:this.state.size===mt.a.Large,onChange:this.onSizeChange},Object(l.b)("Large")))))}}class ut extends o.a.Component{constructor(e){super(e),i()(this,"MESSAGE_PREVIEW_TEXT",Object(l.b)("Hey you. You're the best!")),i()(this,"unmounted",!1),i()(this,"onRoomListStyleChange",(e=>{const t=e.target.value;this.setState({roomListStyle:t}),O.b.setValue("roomListStyle",null,z.a.DEVICE,t)})),i()(this,"onLayoutChanged",(e=>{this.setState({layout:e})})),this.state={lightTheme:O.b.getValue("light_theme"),darkTheme:O.b.getValue("dark_theme"),themeInUse:O.b.getValue("theme_in_use"),roomListStyle:O.b.getValue("roomListStyle"),layout:O.b.getValue("layout")}}async componentDidMount(){const e=h.a.get(),t=e.getUserId(),a=await e.getProfileInfo(t);this.unmounted||this.setState({userId:t,displayName:a.displayname,avatarUrl:a.avatar_url})}componentWillUnmount(){this.unmounted=!0}renderRoomListSection(){const e=o.a.createElement("div",{className:"mx_SettingsTab_multilineRadioSelectors"},o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"room_list_style",value:Qe.a.Compact,checked:this.state.roomListStyle===Qe.a.Compact,onChange:this.onRoomListStyleChange},Object(l.b)("Compact: tiny avatar together with name and preview in one line"))),o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"room_list_style",value:Qe.a.Intermediate,checked:this.state.roomListStyle===Qe.a.Intermediate,onChange:this.onRoomListStyleChange},Object(l.b)("Intermediate: medium sized avatar with single-line preview"))),o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"room_list_style",value:Qe.a.Roomy,checked:this.state.roomListStyle===Qe.a.Roomy,onChange:this.onRoomListStyleChange},Object(l.b)("Roomy: big avatar with two-line preview"))));return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Room list")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_fontScaling"},o.a.createElement(Ue.a,{name:"unifiedRoomList",level:z.a.DEVICE,useCheckbox:!0})),o.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_RoomListStyleSection"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Room list style")),e))}render(){const e=Me.b.get().brand;return o.a.createElement("div",{className:"mx_SettingsTab mx_AppearanceUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Customise your appearance")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Appearance Settings only affect this %(brand)s session.",{brand:e})),o.a.createElement(dt,null),this.renderRoomListSection(),o.a.createElement(Je,{userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl,messagePreviewText:this.MESSAGE_PREVIEW_TEXT,onLayoutChanged:this.onLayoutChanged}),o.a.createElement(tt,null),o.a.createElement(ht,null))}}var pt=a(16),gt=a(143),bt=a(172),vt=a(246),ft=a(383),Et=a(258);class yt extends o.a.PureComponent{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"onKeyBackupSessionsRemaining",(e=>{this.setState({sessionsRemaining:e})})),i()(this,"onKeyBackupStatus",(()=>{this.loadBackupStatus()})),i()(this,"startNewBackup",(()=>{g.b.createDialogAsync(a.e(8).then(a.bind(null,997)),{onFinished:()=>{this.loadBackupStatus()}},void 0,!1,!0)})),i()(this,"deleteBackup",(()=>{g.b.createDialog(le.a,{title:Object(l.b)("Delete Backup"),description:Object(l.b)("Are you sure? You will lose your encrypted messages if your keys are not backed up properly."),button:Object(l.b)("Delete Backup"),danger:!0,onFinished:e=>{e&&(this.setState({loading:!0}),h.a.get().deleteKeyBackupVersion(this.state.backupInfo.version).then((()=>{this.loadBackupStatus()})))}})})),i()(this,"restoreBackup",(async()=>{g.b.createDialog(ft.a,void 0,void 0,!1,!0)})),i()(this,"resetSecretStorage",(async()=>{this.setState({error:null});try{await Object(Et.b)((async()=>{}),!0)}catch(e){if(d.a.error("Error resetting secret storage",e),this.unmounted)return;this.setState({error:e})}this.unmounted||this.loadBackupStatus()})),this.state={loading:!0,error:null,backupKeyStored:null,backupKeyCached:null,backupKeyWellFormed:null,secretStorageKeyInAccount:null,secretStorageReady:null,backupInfo:null,backupSigStatus:null,sessionsRemaining:0}}componentDidMount(){this.checkKeyBackupStatus(),h.a.get().on(bt.b.KeyBackupStatus,this.onKeyBackupStatus),h.a.get().on(bt.b.KeyBackupSessionsRemaining,this.onKeyBackupSessionsRemaining)}componentWillUnmount(){this.unmounted=!0,h.a.get()&&(h.a.get().removeListener(bt.b.KeyBackupStatus,this.onKeyBackupStatus),h.a.get().removeListener(bt.b.KeyBackupSessionsRemaining,this.onKeyBackupSessionsRemaining))}async checkKeyBackupStatus(){this.getUpdatedDiagnostics();try{const{backupInfo:e,trustInfo:t}=await h.a.get().checkKeyBackup();this.setState({loading:!1,error:null,backupInfo:e,backupSigStatus:t})}catch(e){if(d.a.log("Unable to fetch check backup status",e),this.unmounted)return;this.setState({loading:!1,error:e,backupInfo:null,backupSigStatus:null})}}async loadBackupStatus(){this.setState({loading:!0}),this.getUpdatedDiagnostics();try{const e=await h.a.get().getKeyBackupVersion(),t=await h.a.get().isKeyBackupTrusted(e);if(this.unmounted)return;this.setState({loading:!1,error:null,backupInfo:e,backupSigStatus:t})}catch(e){if(d.a.log("Unable to fetch key backup status",e),this.unmounted)return;this.setState({loading:!1,error:e,backupInfo:null,backupSigStatus:null})}}async getUpdatedDiagnostics(){const e=h.a.get(),t=e.crypto.secretStorage,a=!!await e.isKeyBackupKeyStored(),n=await e.crypto.getSessionBackupPrivateKey(),i=!!n,s=n instanceof Uint8Array,o=await t.hasKey(),r=await e.isSecretStorageReady();this.unmounted||this.setState({backupKeyStored:a,backupKeyCached:i,backupKeyWellFormed:s,secretStorageKeyInAccount:o,secretStorageReady:r})}render(){const{loading:e,error:t,backupKeyStored:a,backupKeyCached:n,backupKeyWellFormed:i,secretStorageKeyInAccount:s,secretStorageReady:r,backupInfo:c,backupSigStatus:d,sessionsRemaining:m}=this.state;let u,p,g;const b=[];if(t)u=o.a.createElement("div",{className:"error"},Object(l.b)("Unable to load key backup status"));else if(e)u=o.a.createElement(k.a,null);else if(c){var v;let e,t=Object(l.b)("Restore from Backup");h.a.get().getKeyBackupEnabled()?u=o.a.createElement("p",null,"✅ ",Object(l.b)("This session is backing up your keys.")):(u=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.b)("This session is <b>not backing up your keys</b>, but you do have an existing backup you can restore from and add to going forward.",{},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("p",null,Object(l.b)("Connect this session to key backup before signing out to avoid losing any keys that may only be on this session."))),t=Object(l.b)("Connect this session to Key Backup")),e=h.a.get().getKeyBackupEnabled()?m>0?o.a.createElement("div",null,Object(l.b)("Backing up %(sessionsRemaining)s keys…",{sessionsRemaining:m})," ",o.a.createElement("br",null)):o.a.createElement("div",null,Object(l.b)("All keys backed up")," ",o.a.createElement("br",null)):"";let a,n=d.sigs.map(((e,t)=>{const a=e.device?e.device.getDisplayName()||e.device.deviceId:null,n=t=>o.a.createElement("span",{className:e.valid?"mx_SecureBackupPanel_sigValid":"mx_SecureBackupPanel_sigInvalid"},t),i=t=>o.a.createElement("span",{className:e.device&&e.deviceTrust.isVerified()?"mx_SecureBackupPanel_deviceVerified":"mx_SecureBackupPanel_deviceNotVerified"},t),s=e=>o.a.createElement("span",{className:"mx_SecureBackupPanel_deviceName"},a),r=e.device&&e.device.getFingerprint()===h.a.get().getDeviceEd25519Key(),c=e.crossSigningId&&e.deviceId===h.a.get().getCrossSigningId();let d;return e.valid&&c?d=Object(l.b)("Backup has a <validity>valid</validity> signature from this user",{},{validity:n}):!e.valid&&c?d=Object(l.b)("Backup has a <validity>invalid</validity> signature from this user",{},{validity:n}):e.crossSigningId?d=Object(l.b)("Backup has a signature from <verify>unknown</verify> user with ID %(deviceId)s",{deviceId:e.deviceId},{verify:i}):e.device?e.valid&&r?d=Object(l.b)("Backup has a <validity>valid</validity> signature from this session",{},{validity:n}):!e.valid&&r?d=Object(l.b)("Backup has an <validity>invalid</validity> signature from this session",{},{validity:n}):e.valid&&e.deviceTrust.isVerified()?d=Object(l.b)("Backup has a <validity>valid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:i,device:s}):e.valid&&!e.deviceTrust.isVerified()?d=Object(l.b)("Backup has a <validity>valid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:i,device:s}):!e.valid&&e.deviceTrust.isVerified()?d=Object(l.b)("Backup has an <validity>invalid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:i,device:s}):e.valid||e.deviceTrust.isVerified()||(d=Object(l.b)("Backup has an <validity>invalid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:i,device:s})):d=Object(l.b)("Backup has a signature from <verify>unknown</verify> session with ID %(deviceId)s",{deviceId:e.deviceId},{verify:i}),o.a.createElement("div",{key:t},d)}));null!=d&&null!==(v=d.sigs)&&void 0!==v&&v.length||(n=Object(l.b)("Backup is not signed by any of your sessions")),null!=d&&d.trusted_locally&&(a=Object(l.b)("This backup is trusted because it has been restored on this session")),p=o.a.createElement(o.a.Fragment,null,o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Backup version:")),o.a.createElement("td",null,c.version)),o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Algorithm:")),o.a.createElement("td",null,c.algorithm))),g=o.a.createElement(o.a.Fragment,null,e,o.a.createElement("div",null,n),o.a.createElement("div",null,a)),b.push(o.a.createElement(f.a,{key:"restore",kind:"primary",onClick:this.restoreBackup},t)),Object(vt.g)()||b.push(o.a.createElement(f.a,{key:"delete",kind:"danger",onClick:this.deleteBackup},Object(l.b)("Delete Backup")))}else u=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.b)("Your keys are <b>not being backed up from this session</b>.",{},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("p",null,Object(l.b)("Back up your keys before signing out to avoid losing them."))),b.push(o.a.createElement(f.a,{key:"setup",kind:"primary",onClick:this.startNewBackup},Object(l.b)("Set up")));s&&b.push(o.a.createElement(f.a,{key:"reset",kind:"danger",onClick:this.resetSecretStorage},Object(l.b)("Reset")));let E,y="";return n&&(y=", ",y+=i?Object(l.b)("well formed"):Object(l.b)("unexpected type")),b.length&&(E=o.a.createElement("div",{className:"mx_SecureBackupPanel_buttonRow"},b)),o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("Back up your encryption keys with your account data in case you lose access to your sessions. Your keys will be secured with a unique Security Key.")),u,o.a.createElement("details",null,o.a.createElement("summary",null,Object(l.b)("Advanced")),o.a.createElement("table",{className:"mx_SecureBackupPanel_statusList"},o.a.createElement("tbody",null,o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Backup key stored:")),o.a.createElement("td",null,!0===a?Object(l.b)("in secret storage"):Object(l.b)("not stored"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Backup key cached:")),o.a.createElement("td",null,n?Object(l.b)("cached locally"):Object(l.b)("not found locally"),y)),o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Secret storage public key:")),o.a.createElement("td",null,s?Object(l.b)("in account data"):Object(l.b)("not found"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Secret storage:")),o.a.createElement("td",null,r?Object(l.b)("ready"):Object(l.b)("not ready"))),p)),g),E)}}const _t="e2ee.manuallyVerifyAllSessions";var St=()=>o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Encryption")),o.a.createElement(Ue.a,{name:_t,level:z.a.DEVICE}),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Individually verify each session used by a user to mark it as trusted, not trusting cross-signed devices.")));var wt=a(218);class Ot extends o.a.Component{constructor(e){super(e),i()(this,"onExportE2eKeysClicked",(()=>{g.b.createDialogAsync(a.e(7).then(a.bind(null,1733)),{matrixClient:h.a.get()})})),i()(this,"onImportE2eKeysClicked",(()=>{g.b.createDialogAsync(a.e(33).then(a.bind(null,1764)),{matrixClient:h.a.get()})})),i()(this,"updateBlacklistDevicesFlag",(e=>{h.a.get().setGlobalBlacklistUnverifiedDevices(e)}))}render(){const e=h.a.get(),t=e.deviceId;let a,n,i=e.getDeviceEd25519Key();return i=i?wt.e(i):Object(l.b)("<not supported>"),e.isCryptoEnabled()&&(a=o.a.createElement("div",{className:"mx_CryptographyPanel_importExportButtons"},o.a.createElement(f.a,{kind:"primary",onClick:this.onExportE2eKeysClicked},Object(l.b)("Export E2E room keys")),o.a.createElement(f.a,{kind:"primary",onClick:this.onImportE2eKeysClicked},Object(l.b)("Import E2E room keys")))),O.b.isEnabled("blacklistUnverifiedDevices")&&(n=o.a.createElement(Ue.a,{name:"blacklistUnverifiedDevices",level:z.a.DEVICE,onChange:this.updateBlacklistDevicesFlag})),o.a.createElement("div",{className:"mx_SettingsTab_section mx_CryptographyPanel"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Cryptography")),o.a.createElement("table",{className:"mx_SettingsTab_subsectionText mx_CryptographyPanel_sessionInfo"},o.a.createElement("tbody",null,o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Session ID:")),o.a.createElement("td",null,o.a.createElement("code",null,t))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Session key:")),o.a.createElement("td",null,o.a.createElement("code",null,o.a.createElement("b",null,i)))))),a,n)}}var Ct,xt=a(419),jt=a(495),kt=a(672),Rt=a(177);function It(){return It=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},It.apply(this,arguments)}var Tt;function Nt(){return Nt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Nt.apply(this,arguments)}var Pt;function Dt(){return Dt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Dt.apply(this,arguments)}var Mt;function At(){return At=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},At.apply(this,arguments)}var Ut;function Lt(){return Lt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Lt.apply(this,arguments)}function Ft(e){return s.createElement("svg",Lt({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),Ut||(Ut=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M2 3.05v6.22C2 15.63 9 17 9 17s7-1.37 7-7.73V3.05L9 1 2 3.05zm9.94 2.47c.19-.18.49-.17.67.02.16.18.16.45.02.63l-4.22 5.11-.03.04c-.28.34-.79.39-1.13.11a.29.29 0 01-.077-.067.912.912 0 00-.023-.023L5.34 9.26c-.2-.24-.18-.6.06-.8.2-.18.49-.18.7-.04l1.57 1.1 4.27-4z",fill:"currentColor"})))}var Bt=a(663),Vt=a(497);const Wt={[Vt.a.Desktop]:function(e){return s.createElement("svg",Nt({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 22 19",role:"presentation","aria-hidden":!0},e),Tt||(Tt=s.createElement("path",{d:"M3 15.5c-.55 0-1.02-.196-1.412-.587A1.927 1.927 0 011 13.5v-11c0-.55.196-1.021.588-1.413A1.925 1.925 0 013 .5h16c.55 0 1.021.196 1.413.587.391.392.587.863.587 1.413v11c0 .55-.196 1.021-.587 1.413A1.928 1.928 0 0119 15.5H3zm0-2h16v-11H3v11zm-2 5a.965.965 0 01-.712-.288A.965.965 0 010 17.5c0-.283.096-.52.288-.712A.965.965 0 011 16.5h20c.283 0 .52.096.712.288A.965.965 0 0122 17.5c0 .283-.096.52-.288.712A.965.965 0 0121 18.5H1zm2-5v-11 11z",fill:"currentColor"})))},[Vt.a.Mobile]:function(e){return s.createElement("svg",At({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 14 23",role:"presentation","aria-hidden":!0},e),Mt||(Mt=s.createElement("path",{d:"M12 .51L2 .5c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-18c0-1.1-.9-1.99-2-1.99zm0 17.99H2v-14h10v14z",fill:"currentColor"})))},[Vt.a.Web]:function(e){return s.createElement("svg",Dt({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 17",role:"presentation","aria-hidden":!0},e),Pt||(Pt=s.createElement("path",{d:"M18 16.5H2c-.55 0-1.02-.196-1.412-.587A1.927 1.927 0 010 14.5v-12c0-.55.196-1.02.588-1.412A1.923 1.923 0 012 .5h16c.55 0 1.021.196 1.413.588.391.391.587.862.587 1.412v12c0 .55-.196 1.021-.587 1.413A1.928 1.928 0 0118 16.5zM2 4.5v10h16v-10H2z",fill:"currentColor"})))},[Vt.a.Unknown]:function(e){return s.createElement("svg",It({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 22 23",role:"presentation","aria-hidden":!0},e),Ct||(Ct=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M11 22.5c6.075 0 11-4.925 11-11S17.075.5 11 .5 0 5.425 0 11.5s4.925 11 11 11zm0-4.24a1.375 1.375 0 100-2.75 1.375 1.375 0 000 2.75zM9.09 9.428A1.91 1.91 0 0111 7.518c1.048 0 1.91.862 1.91 1.91 0 .485-.208.659-1.026 1.224-.363.25-.86.598-1.246 1.108-.415.546-.67 1.227-.67 2.093h2.063c0-.424.113-.666.25-.846.164-.217.402-.4.775-.659l.124-.084c.676-.46 1.792-1.219 1.792-2.836A3.98 3.98 0 0011 5.456a3.972 3.972 0 00-3.973 3.972H9.09z",fill:"currentColor"})))}},zt={[Vt.a.Desktop]:Object(l.b)("Desktop session"),[Vt.a.Mobile]:Object(l.b)("Mobile session"),[Vt.a.Web]:Object(l.b)("Web session"),[Vt.a.Unknown]:Object(l.b)("Unknown session type")},Ht=e=>{let{isVerified:t,isSelected:a,deviceType:n}=e;const i=Wt[n]||Wt[Vt.a.Unknown],s=zt[n]||zt[Vt.a.Unknown];return o.a.createElement("div",{className:We()("mx_DeviceTypeIcon",{mx_DeviceTypeIcon_selected:a})},o.a.createElement("div",{className:"mx_DeviceTypeIcon_deviceIconWrapper"},o.a.createElement(i,{className:"mx_DeviceTypeIcon_deviceIcon",role:"img","aria-label":s})),t?o.a.createElement(Ft,{className:We()("mx_DeviceTypeIcon_verificationIcon","verified"),role:"img","aria-label":Object(l.b)("Verified")}):o.a.createElement(Bt.Icon,{className:We()("mx_DeviceTypeIcon_verificationIcon","unverified"),role:"img","aria-label":Object(l.b)("Unverified")}))};var Kt=a(653),Gt=a(953);const qt=e=>{let{device:t}=e;return o.a.createElement(Rt.a,{size:"h4"},t.display_name||t.device_id)};var $t=e=>{let{device:t,children:a,isSelected:n,onClick:i}=e;return o.a.createElement("div",{className:We()("mx_DeviceTile",{mx_DeviceTile_interactive:!!i}),"data-testid":`device-tile-${t.device_id}`,onClick:i},o.a.createElement(Ht,{isVerified:t.isVerified,isSelected:n,deviceType:t.deviceType}),o.a.createElement("div",{className:"mx_DeviceTile_info"},o.a.createElement(qt,{device:t}),o.a.createElement("div",{className:"mx_DeviceTile_metadata"},o.a.createElement(Gt.a,{device:t}))),o.a.createElement("div",{className:"mx_DeviceTile_actions",onClick:Object(Kt.a)((()=>{}))},a))};var Yt=e=>{let{children:t,device:a,isSelected:n,onSelect:i,onClick:s}=e;return o.a.createElement("div",{className:"mx_SelectableDeviceTile"},o.a.createElement(D.b,{kind:D.a.Solid,checked:n,onChange:i,className:"mx_SelectableDeviceTile_checkbox",id:`device-tile-checkbox-${a.device_id}`,"data-testid":`device-tile-checkbox-${a.device_id}`},o.a.createElement($t,{device:a,onClick:s,isSelected:n},t)))};function Jt(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Qt(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Jt(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Jt(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Xt extends o.a.Component{constructor(e){var t;super(e),i()(this,"onDeviceToggled",(()=>{this.props.onDeviceToggled(this.props.device)})),i()(this,"onRename",(()=>{this.setState({renaming:!0})})),i()(this,"onChangeDisplayName",(e=>{this.setState({displayName:e.target.value})})),i()(this,"onRenameSubmit",(async()=>{this.setState({renaming:!1}),await h.a.get().setDeviceDetails(this.props.device.device_id,{display_name:this.state.displayName}).catch((e=>{throw d.a.error("Error setting session display name",e),new Error(Object(l.b)("Failed to set display name"))})),this.props.onDeviceChange()})),i()(this,"onRenameCancel",(()=>{this.setState({renaming:!1})})),i()(this,"onOwnDeviceSignOut",(()=>{g.b.createDialog(kt.a,{},void 0,!1,!0)})),i()(this,"verify",(async()=>{if(this.props.isOwnDevice)g.b.createDialog(xt.a,{onFinished:this.props.onDeviceChange});else{var e;const t=h.a.get(),a=t.getSafeUserId(),n=t.requestVerification(a,[this.props.device.device_id]);g.b.createDialog(jt.a,{verificationRequestPromise:n,member:null!==(e=t.getUser(a))&&void 0!==e?e:void 0,onFinished:async()=>{(await n).cancel(),this.props.onDeviceChange()}})}})),this.state={renaming:!1,displayName:null!==(t=e.device.display_name)&&void 0!==t?t:""}}render(){let e,t,a="";null!==this.props.verified&&(a=this.props.verified?"mx_E2EIcon_verified":"mx_E2EIcon_warning",!this.props.verified&&this.props.canBeVerified&&(e=o.a.createElement(f.a,{kind:"primary",onClick:this.verify},Object(l.b)("Verify")))),this.props.isOwnDevice&&(t=o.a.createElement(f.a,{kind:"danger_outline",onClick:this.onOwnDeviceSignOut},Object(l.b)("Sign Out")));const n=this.state.renaming?o.a.createElement("form",{className:"mx_DevicesPanel_renameForm",onSubmit:this.onRenameSubmit},o.a.createElement(u.a,{label:Object(l.b)("Display Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this.onChangeDisplayName,autoFocus:!0}),o.a.createElement(f.a,{onClick:this.onRenameSubmit,kind:"confirm_sm"}),o.a.createElement(f.a,{onClick:this.onRenameCancel,kind:"cancel_sm"})):o.a.createElement(o.a.Fragment,null,t,e,o.a.createElement(f.a,{kind:"primary_outline",onClick:this.onRename},Object(l.b)("Rename"))),i=Qt(Qt({},this.props.device),{},{isVerified:this.props.verified,deviceType:Vt.a.Unknown});return this.props.isOwnDevice?o.a.createElement("div",{className:We()("mx_DevicesPanel_device","mx_DevicesPanel_myDevice")},o.a.createElement("div",{className:"mx_DevicesPanel_deviceTrust"},o.a.createElement("span",{className:"mx_DevicesPanel_icon mx_E2EIcon "+a})),o.a.createElement($t,{device:i},n)):o.a.createElement("div",{className:"mx_DevicesPanel_device"},o.a.createElement(Yt,{device:i,onSelect:this.onDeviceToggled,isSelected:this.props.selected},n))}}const Zt=(e,t)=>async a=>e.deleteMultipleDevices(t,a),ea=async(e,t,a)=>{if(t.length)try{await Zt(e,t)(),a(!0,void 0)}catch(i){var n;if(401!==i.httpStatus||null===(n=i.data)||void 0===n||!n.flows)throw i;const s=t.length,o={[P.c.PHASE_PREAUTH]:{title:Object(l.b)("Use Single Sign On to continue"),body:Object(l.b)("Confirm logging out these devices by using Single Sign On to prove your identity.",{count:s}),continueText:Object(l.b)("Single Sign On"),continueKind:"primary"},[P.c.PHASE_POSTAUTH]:{title:Object(l.b)("Confirm signing out these devices",{count:s}),body:Object(l.b)("Click the button below to confirm signing out these devices.",{count:s}),continueText:Object(l.b)("Sign out devices",{count:s}),continueKind:"danger"}};g.b.createDialog(G.a,{title:Object(l.b)("Authentication"),matrixClient:e,authData:i.data,onFinished:a,makeRequest:Zt(e,t),aestheticsForStagePhases:{[P.c.LOGIN_TYPE]:o,[P.c.UNSTABLE_LOGIN_TYPE]:o}})}};var ta=a(133),aa=a(664);class na extends o.a.Component{constructor(e){super(e),i()(this,"context",void 0),i()(this,"unmounted",!1),i()(this,"onDevicesUpdated",(e=>{e.includes(this.context.getUserId())&&this.loadDevices()})),i()(this,"onDeviceSelectionToggled",(e=>{if(this.unmounted)return;const t=e.device_id;this.setState(((e,a)=>{const n=e.selectedDevices.slice(),i=n.indexOf(t);return-1===i?n.push(t):n.splice(i,1),{selectedDevices:n}}))})),i()(this,"selectAll",(e=>{this.setState(((t,a)=>{const n=t.selectedDevices.slice();for(const t of e){const e=t.device_id;n.includes(e)||n.push(e)}return{selectedDevices:n}}))})),i()(this,"deselectAll",(e=>{this.setState(((t,a)=>{const n=t.selectedDevices.slice();for(const t of e){const e=t.device_id,a=n.indexOf(e);-1!==a&&n.splice(a,1)}return{selectedDevices:n}}))})),i()(this,"onDeleteClick",(async()=>{if(0!==this.state.selectedDevices.length){this.setState({deleting:!0});try{await ea(this.context,this.state.selectedDevices,(e=>{e&&(this.setState({selectedDevices:[]}),this.loadDevices()),this.setState({deleting:!1})}))}catch(e){d.a.error("Error deleting sessions",e),this.setState({deleting:!1})}}})),i()(this,"renderDevice",(e=>{const t=this.context.getDeviceId(),a=this.state.devices.find((e=>e.device_id===t)),n=e.device_id===t,i=a&&this.isDeviceVerified(a)||n;return o.a.createElement(Xt,{key:e.device_id,device:e,selected:this.state.selectedDevices.includes(e.device_id),isOwnDevice:n,verified:this.isDeviceVerified(e),canBeVerified:i,onDeviceChange:this.loadDevices,onDeviceToggled:this.onDeviceSelectionToggled})})),this.state={devices:[],selectedDevices:[]},this.loadDevices=this.loadDevices.bind(this)}componentDidMount(){this.context.on(bt.b.DevicesUpdated,this.onDevicesUpdated),this.loadDevices()}componentWillUnmount(){this.context.off(bt.b.DevicesUpdated,this.onDevicesUpdated),this.unmounted=!0}loadDevices(){this.context.getDevices().then((e=>{this.unmounted||this.setState(((t,a)=>{const n=e.devices.map((e=>e.device_id)),i=t.selectedDevices.filter((e=>n.includes(e)));return{devices:e.devices||[],selectedDevices:i}}))}),(e=>{if(this.unmounted)return;let t;404==e.httpStatus?t=Object(l.b)("Your homeserver does not support device management."):(d.a.error("Error loading sessions:",e),t=Object(l.b)("Unable to load device list")),this.setState({deviceLoadError:t})}))}deviceCompare(e,t){const a=(t.last_seen_ts||0)-(e.last_seen_ts||0);if(0!==a)return a;const n=e.device_id,i=t.device_id;return n<i?-1:n>i?1:0}isDeviceVerified(e){return Object(aa.a)(this.context,e.device_id)}render(){const e=o.a.createElement("div",{className:We()(this.props.className,"error")},this.state.deviceLoadError);if(void 0!==this.state.deviceLoadError)return e;const t=this.state.devices;if(void 0===t)return o.a.createElement(k.a,null);const a=this.context.getDeviceId(),n=t.find((e=>e.device_id===a));if(!n)return e;const i=t.filter((e=>e.device_id!==a));i.sort(this.deviceCompare);const s=[],r=[],c=[];for(const e of i){const t=this.isDeviceVerified(e);!0===t?s.push(e):!1===t?r.push(e):c.push(e)}const d=(e,t,a)=>{if(0===a.length)return o.a.createElement(o.a.Fragment,null);let n;if(a.length>1){const e=a.some((e=>this.state.selectedDevices.includes(e.device_id))),t=e?()=>{this.deselectAll(a)}:()=>{this.selectAll(a)},i=e?Object(l.b)("Deselect all"):Object(l.b)("Select all");n=o.a.createElement("div",{className:"mx_DevicesPanel_header_button"},o.a.createElement(f.a,{className:"mx_DevicesPanel_selectButton",kind:"secondary",onClick:t},i))}return o.a.createElement(o.a.Fragment,null,o.a.createElement("hr",null),o.a.createElement("div",{className:"mx_DevicesPanel_header"},o.a.createElement("div",{className:"mx_DevicesPanel_header_trust"},e),o.a.createElement("div",{className:"mx_DevicesPanel_header_title"},t),n),a.map(this.renderDevice))},m=d(o.a.createElement("span",{className:"mx_DevicesPanel_header_icon mx_E2EIcon mx_E2EIcon_verified"}),Object(l.b)("Verified devices"),s),h=d(o.a.createElement("span",{className:"mx_DevicesPanel_header_icon mx_E2EIcon mx_E2EIcon_warning"}),Object(l.b)("Unverified devices"),r),u=d(o.a.createElement(o.a.Fragment,null),Object(l.b)("Devices without encryption support"),c),p=this.state.deleting?o.a.createElement(k.a,{w:22,h:22}):o.a.createElement(f.a,{className:"mx_DevicesPanel_deleteButton",onClick:this.onDeleteClick,kind:"danger_outline",disabled:0===this.state.selectedDevices.length,"data-testid":"sign-out-devices-btn"},Object(l.b)("Sign out %(count)s selected devices",{count:this.state.selectedDevices.length})),g=i.length>0?o.a.createElement(o.a.Fragment,null,m,h,u,p):o.a.createElement(o.a.Fragment,null,o.a.createElement("hr",null),o.a.createElement("div",{className:"mx_DevicesPanel_noOtherDevices"},Object(l.b)("You aren't signed into any other devices."))),b=We()(this.props.className,"mx_DevicesPanel");return o.a.createElement("div",{className:b},o.a.createElement("div",{className:"mx_DevicesPanel_header"},o.a.createElement("div",{className:"mx_DevicesPanel_header_title"},Object(l.b)("This device"))),this.renderDevice(n),g)}}i()(na,"contextType",ta.a);var ia=a(148);class sa extends o.a.Component{constructor(){super(...arguments),i()(this,"onConfirm",(()=>{this.props.onFinished(!0)})),i()(this,"onDecline",(()=>{this.props.onFinished(!1)}))}render(){return o.a.createElement(M.a,{className:"mx_ConfirmDestroyCrossSigningDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.b)("Destroy cross-signing keys?")},o.a.createElement("div",{className:"mx_ConfirmDestroyCrossSigningDialog_content"},o.a.createElement("p",null,Object(l.b)("Deleting cross-signing keys is permanent. Anyone you have verified with will see security alerts. You almost certainly don't want to do this, unless you've lost every device you can cross-sign from."))),o.a.createElement(ia.a,{primaryButton:Object(l.b)("Clear cross-signing keys"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:Object(l.b)("Cancel"),onCancel:this.onDecline}))}}class oa extends o.a.PureComponent{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"onAccountData",(e=>{const t=e.getType();(t.startsWith("m.cross_signing")||t.startsWith("m.secret_storage"))&&this.getUpdatedStatus()})),i()(this,"onBootstrapClick",(()=>{this.state.crossSigningPrivateKeysInStorage?g.b.createDialog(xt.a,{},void 0,!1,!0):Object(Et.b)()})),i()(this,"onStatusChanged",(()=>{this.getUpdatedStatus()})),i()(this,"bootstrapCrossSigning",(async e=>{let{forceReset:t=!1}=e;this.setState({error:void 0});try{const e=h.a.get();await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:a}=g.b.createDialog(G.a,{title:Object(l.b)("Setting up keys"),matrixClient:e,makeRequest:t}),[n]=await a;if(!n)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:t})}catch(e){this.setState({error:e}),d.a.error("Error bootstrapping cross-signing",e)}this.unmounted||this.getUpdatedStatus()})),i()(this,"resetCrossSigning",(()=>{g.b.createDialog(sa,{onFinished:e=>{e&&this.bootstrapCrossSigning({forceReset:!0})}})})),this.state={}}componentDidMount(){const e=h.a.get();e.on(m.ClientEvent.AccountData,this.onAccountData),e.on(bt.b.UserTrustStatusChanged,this.onStatusChanged),e.on(bt.b.KeysChanged,this.onStatusChanged),this.getUpdatedStatus()}componentWillUnmount(){this.unmounted=!0;const e=h.a.get();e&&(e.removeListener(m.ClientEvent.AccountData,this.onAccountData),e.removeListener(bt.b.UserTrustStatusChanged,this.onStatusChanged),e.removeListener(bt.b.KeysChanged,this.onStatusChanged))}async getUpdatedStatus(){var e,t,a;const n=h.a.get(),i=n.getCrossSigningCacheCallbacks(),s=n.crypto.crossSigningInfo,o=n.crypto.secretStorage,r=Boolean(s.getId()),l=Boolean(await s.isStoredInSecretStorage(o)),c=!!await(null==i||null===(e=i.getCrossSigningKeyCache)||void 0===e?void 0:e.call(i,"master")),d=!!await(null==i||null===(t=i.getCrossSigningKeyCache)||void 0===t?void 0:t.call(i,"self_signing")),m=!!await(null==i||null===(a=i.getCrossSigningKeyCache)||void 0===a?void 0:a.call(i,"user_signing")),u=await n.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),p=await n.isCrossSigningReady();this.setState({crossSigningPublicKeysOnDevice:r,crossSigningPrivateKeysInStorage:l,masterPrivateKeyCached:c,selfSigningPrivateKeyCached:d,userSigningPrivateKeyCached:m,homeserverSupportsCrossSigning:u,crossSigningReady:p})}render(){const{error:e,crossSigningPublicKeysOnDevice:t,crossSigningPrivateKeysInStorage:a,masterPrivateKeyCached:n,selfSigningPrivateKeyCached:i,userSigningPrivateKeyCached:s,homeserverSupportsCrossSigning:r,crossSigningReady:c}=this.state;let d,m;e&&(d=o.a.createElement("div",{className:"error"},e.toString())),m=void 0===r?o.a.createElement(k.a,null):r?c&&a?o.a.createElement("p",null,"✅ ",Object(l.b)("Cross-signing is ready for use.")):c&&!a?o.a.createElement("p",null,"⚠️ ",Object(l.b)("Cross-signing is ready but keys are not backed up.")):a?o.a.createElement("p",null,Object(l.b)("Your account has a cross-signing identity in secret storage, but it is not yet trusted by this session.")):o.a.createElement("p",null,Object(l.b)("Cross-signing is not set up.")):o.a.createElement("p",null,Object(l.b)("Your homeserver does not support cross-signing."));const h=t||a||n||i||s,u=[];if(!(t&&a&&n&&i&&s)&&r){let e=Object(l.b)("Set up Secure Backup");a&&(e=Object(l.b)("Verify this session")),u.push(o.a.createElement(f.a,{key:"setup",kind:"primary",onClick:this.onBootstrapClick},e))}let p;return h&&u.push(o.a.createElement(f.a,{key:"reset",kind:"danger",onClick:this.resetCrossSigning},Object(l.b)("Reset"))),u.length&&(p=o.a.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},u)),o.a.createElement("div",null,m,o.a.createElement("details",null,o.a.createElement("summary",null,Object(l.b)("Advanced")),o.a.createElement("table",{className:"mx_CrossSigningPanel_statusList"},o.a.createElement("tbody",null,o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Cross-signing public keys:")),o.a.createElement("td",null,t?Object(l.b)("in memory"):Object(l.b)("not found"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Cross-signing private keys:")),o.a.createElement("td",null,a?Object(l.b)("in secret storage"):Object(l.b)("not found in storage"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Master private key:")),o.a.createElement("td",null,n?Object(l.b)("cached locally"):Object(l.b)("not found locally"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Self signing private key:")),o.a.createElement("td",null,i?Object(l.b)("cached locally"):Object(l.b)("not found locally"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("User signing private key:")),o.a.createElement("td",null,s?Object(l.b)("cached locally"):Object(l.b)("not found locally"))),o.a.createElement("tr",null,o.a.createElement("td",null,Object(l.b)("Homeserver feature support:")),o.a.createElement("td",null,r?Object(l.b)("exists"):Object(l.b)("not found")))))),d,p)}}var ra=a(327);class la extends o.a.PureComponent{render(){return o.a.createElement(M.a,{hasCancel:!0,onFinished:this.props.onFinished.bind(null,!1),title:Object(l.b)("Reset event store?")},o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("You most likely do not want to reset your event index store"),o.a.createElement("br",null),Object(l.b)("If you do, please note that none of your messages will be deleted, but the search experience might be degraded for a few moments whilst the index is recreated"))),o.a.createElement(ia.a,{primaryButton:Object(l.b)("Reset event store"),onPrimaryButtonClick:this.props.onFinished.bind(null,!0),primaryButtonClass:"danger",cancelButton:Object(l.b)("Cancel"),onCancel:this.props.onFinished.bind(null,!1)}))}}class ca extends o.a.Component{constructor(e){super(e),i()(this,"updateCurrentRoom",(async()=>{const e=ra.a.get(),t=await(null==e?void 0:e.getStats().catch((()=>{})));t&&this.setState({eventIndexSize:t.size,roomCount:t.roomCount})})),i()(this,"onManage",(async()=>{g.b.createDialogAsync(a.e(39).then(a.bind(null,1765)),{onFinished:()=>{}},null,!1,!0)})),i()(this,"onEnable",(async()=>{var e,t;this.setState({enabling:!0}),await ra.a.initEventIndex(),await(null===(e=ra.a.get())||void 0===e?void 0:e.addInitialCheckpoints()),null===(t=ra.a.get())||void 0===t||t.startCrawler(),await O.b.setValue("enableEventIndexing",null,z.a.DEVICE,!0),await this.updateState()})),i()(this,"confirmEventStoreReset",(()=>{const{close:e}=g.b.createDialog(la,{onFinished:async t=>{t&&(await O.b.setValue("enableEventIndexing",null,z.a.DEVICE,!1),await ra.a.deleteEventIndex(),await this.onEnable(),e())}})})),this.state={enabling:!1,eventIndexSize:0,roomCount:0,eventIndexingEnabled:O.b.getValueAt(z.a.DEVICE,"enableEventIndexing")}}componentWillUnmount(){const e=ra.a.get();null!==e&&e.removeListener("changedCheckpoint",this.updateCurrentRoom)}componentDidMount(){this.updateState()}async updateState(){const e=ra.a.get(),t=O.b.getValueAt(z.a.DEVICE,"enableEventIndexing");let a=0,n=0;if(null!==e){e.on("changedCheckpoint",this.updateCurrentRoom);const t=await e.getStats().catch((()=>{}));t&&(a=t.size,n=t.roomCount)}this.setState({enabling:!1,eventIndexSize:a,roomCount:n,eventIndexingEnabled:t})}render(){let e;const t=Me.b.get().brand;if(null!==ra.a.get())e=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Securely cache encrypted messages locally for them to appear in search results, using %(size)s to store messages from %(rooms)s rooms.",{size:Object(wt.a)(this.state.eventIndexSize,0),count:this.state.roomCount,rooms:Object(wt.d)(this.state.roomCount)})),o.a.createElement("div",null,o.a.createElement(f.a,{kind:"primary",onClick:this.onManage},Object(l.b)("Manage"))));else if(!this.state.eventIndexingEnabled&&ra.a.supportIsInstalled())e=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Securely cache encrypted messages locally for them to appear in search results.")),o.a.createElement("div",null,o.a.createElement(f.a,{kind:"primary",disabled:this.state.enabling,onClick:this.onEnable},Object(l.b)("Enable")),this.state.enabling?o.a.createElement(Ce.a,null):o.a.createElement("div",null)));else if(ra.a.platformHasSupport()&&!ra.a.supportIsInstalled()){const a="https://github.com/vector-im/element-desktop/blob/develop/docs/native-node-modules.md#adding-seshat-for-search-in-e2e-encrypted-rooms";e=o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("%(brand)s is missing some components required for securely caching encrypted messages locally. If you'd like to experiment with this feature, build a custom %(brand)s Desktop with <nativeLink>search components added</nativeLink>.",{brand:t},{nativeLink:e=>o.a.createElement("a",{href:a,target:"_blank",rel:"noreferrer noopener"},e)}))}else e=ra.a.platformHasSupport()?o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("p",null,this.state.enabling?o.a.createElement(Ce.a,null):Object(l.b)("Message search initialisation failed")),ra.a.error&&o.a.createElement("details",null,o.a.createElement("summary",null,Object(l.b)("Advanced")),o.a.createElement("code",null,ra.a.error.message),o.a.createElement("p",null,o.a.createElement(f.a,{key:"delete",kind:"danger",onClick:this.confirmEventStoreReset},Object(l.b)("Reset"))))):o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("%(brand)s can't securely cache encrypted messages locally while running in a web browser. Use <desktopLink>%(brand)s Desktop</desktopLink> for encrypted messages to appear in search results.",{brand:t},{desktopLink:e=>o.a.createElement("a",{href:"https://element.io/get-started",target:"_blank",rel:"noreferrer noopener"},e)}));return e}}var da=a(192),ma=a(986),ha=a(309),ua=a(694),pa=a(417);class ga extends o.a.Component{constructor(e){super(e)}render(){var e,t,a,n;const i=m.UNSTABLE_MSC3882_CAPABILITY.findIn(this.props.capabilities),s=!(null===(e=this.props.versions)||void 0===e||null===(t=e.unstable_features)||void 0===t||!t["org.matrix.msc3882"])||!(null==i||!i.enabled),r=!(null===(a=this.props.versions)||void 0===a||null===(n=a.unstable_features)||void 0===n||!n["org.matrix.msc3886"]);return s&&r?o.a.createElement(pa.a,{heading:Object(l.b)("Sign in with QR code")},o.a.createElement("div",{className:"mx_LoginWithQRSection"},o.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("You can use this device to sign in a new device with a QR code. You will need to scan the QR code shown on this device with your device that's signed out.")),o.a.createElement(f.a,{onClick:this.props.onShowQr,kind:"primary"},Object(l.b)("Show QR code")))):null}}class ba extends o.a.Component{constructor(){super(...arguments),i()(this,"onUnignoreClicked",(()=>{this.props.onUnignored(this.props.userId)}))}render(){const e=`mx_SecurityUserSettingsTab_ignoredUser_${this.props.userId}`;return o.a.createElement("div",{className:"mx_SecurityUserSettingsTab_ignoredUser"},o.a.createElement(f.a,{onClick:this.onUnignoreClicked,kind:"primary_sm","aria-describedby":e,disabled:this.props.inProgress},Object(l.b)("Unignore")),o.a.createElement("span",{id:e},this.props.userId))}}class va extends o.a.Component{constructor(e){super(e),i()(this,"dispatcherRef",void 0),i()(this,"onAction",(e=>{let{action:t}=e;if("ignore_state_changed"===t){const e=h.a.get().getIgnoredUsers(),t=this.state.waitingUnignored.filter((t=>e.includes(t)));this.setState({ignoredUserIds:e,waitingUnignored:t})}})),i()(this,"onMyMembership",((e,t)=>{e.isSpaceRoom()||("invite"===t?this.addInvitedRoom(e):this.state.invitedRoomIds.has(e.roomId)&&this.removeInvitedRoom(e.roomId))})),i()(this,"addInvitedRoom",(e=>{this.setState((t=>{let{invitedRoomIds:a}=t;return{invitedRoomIds:new Set(a).add(e.roomId)}}))})),i()(this,"removeInvitedRoom",(e=>{this.setState((t=>{let{invitedRoomIds:a}=t;const n=new Set(a);return n.delete(e),{invitedRoomIds:n}}))})),i()(this,"onUserUnignored",(async e=>{const{ignoredUserIds:t,waitingUnignored:a}=this.state,n=t.filter((e=>!a.includes(e))),i=n.indexOf(e);-1!==i&&(n.splice(i,1),this.setState((t=>{let{waitingUnignored:a}=t;return{waitingUnignored:[...a,e]}})),h.a.get().setIgnoredUsers(n))})),i()(this,"getInvitedRooms",(()=>h.a.get().getRooms().filter((e=>e.hasMembershipState(h.a.get().getUserId(),"invite"))))),i()(this,"manageInvites",(async e=>{this.setState({managingInvites:!0});const t=Array.from(this.state.invitedRoomIds),a=h.a.get(),n=e?a.joinRoom.bind(a):a.leave.bind(a);for(let e=0;e<t.length;e++){const a=t[e];await n(a).then((()=>{this.removeInvitedRoom(a)}),(async t=>{"M_LIMIT_EXCEEDED"===t.errcode?(await Object(pt.N)(t.retry_after_ms||2500),e--):d.a.warn(t)}))}this.setState({managingInvites:!1})})),i()(this,"onAcceptAllInvitesClicked",(()=>{this.manageInvites(!0)})),i()(this,"onRejectAllInvitesClicked",(()=>{this.manageInvites(!1)})),i()(this,"onShowQRClicked",(()=>{this.setState({showLoginWithQR:ua.b.Show})})),i()(this,"onLoginWithQRFinished",(()=>{this.setState({showLoginWithQR:null})}));const t=new Set(this.getInvitedRooms().map((e=>e.roomId)));this.state={ignoredUserIds:h.a.get().getIgnoredUsers(),waitingUnignored:[],managingInvites:!1,invitedRoomIds:t,showLoginWithQR:null}}componentDidMount(){this.dispatcherRef=A.a.register(this.onAction),h.a.get().on(gt.d.MyMembership,this.onMyMembership),h.a.get().getVersions().then((e=>this.setState({versions:e}))),h.a.get().getCapabilities().then((e=>this.setState({capabilities:e})))}componentWillUnmount(){A.a.unregister(this.dispatcherRef),h.a.get().removeListener(gt.d.MyMembership,this.onMyMembership)}renderIgnoredUsers(){const{waitingUnignored:e,ignoredUserIds:t}=this.state,a=null!=t&&t.length?t.map((t=>o.a.createElement(ba,{userId:t,onUnignored:this.onUserUnignored,key:t,inProgress:e.includes(t)}))):Object(l.b)("You have no ignored users.");return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Ignored users")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},a))}renderManageInvites(){const{invitedRoomIds:e}=this.state;return 0===e.size?null:o.a.createElement("div",{className:"mx_SettingsTab_section mx_SecurityUserSettingsTab_bulkOptions"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Bulk options")),o.a.createElement(f.a,{onClick:this.onAcceptAllInvitesClicked,kind:"primary",disabled:this.state.managingInvites},Object(l.b)("Accept all %(invitedRooms)s invites",{invitedRooms:e.size})),o.a.createElement(f.a,{onClick:this.onRejectAllInvitesClicked,kind:"danger",disabled:this.state.managingInvites},Object(l.b)("Reject all %(invitedRooms)s invites",{invitedRooms:e.size})),this.state.managingInvites?o.a.createElement(Ce.a,null):o.a.createElement("div",null))}render(){const e=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Secure Backup")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement(yt,null))),t=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Message search")),o.a.createElement(ca,null)),a=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Cross-signing")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement(oa,null)));let n,i,s;if(Object(ha.a)()||(n=o.a.createElement("div",{className:"mx_SecurityUserSettingsTab_warning"},Object(l.b)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."))),da.a.instance.isEnabled()){const e=()=>{Object(ma.b)({primaryButton:Object(l.b)("Okay"),hasCancel:!1})};i=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Privacy")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Analytics")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("p",null,Object(l.b)("Share anonymous data to help us identify issues. Nothing personal. No third parties.")),o.a.createElement(f.a,{kind:"link",onClick:e},Object(l.b)("Learn more"))),da.a.instance.isEnabled()&&o.a.createElement(Ue.a,{name:"pseudonymousAnalyticsOptIn",level:z.a.ACCOUNT}),o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Sessions")),o.a.createElement(Ue.a,{name:"deviceClientInformationOptIn",level:z.a.ACCOUNT})))}if(O.b.getValue(H.b.AdvancedSettings)){const e=this.renderIgnoredUsers(),t=this.renderManageInvites(),a=O.b.isEnabled(_t)?o.a.createElement(St,null):null;(e||t||a)&&(s=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Advanced")),o.a.createElement("div",{className:"mx_SettingsTab_section"},e,t,a)))}const r=O.b.getValue("feature_new_device_manager")?null:o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Where you're signed in")),o.a.createElement("div",{className:"mx_SettingsTab_section","data-testid":"devices-section"},o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Manage your signed-in devices below. A device's name is visible to people you communicate with.")),o.a.createElement(na,null)),o.a.createElement(ga,{onShowQr:this.onShowQRClicked,versions:this.state.versions,capabilities:this.state.capabilities})),c=h.a.get();return this.state.showLoginWithQR?o.a.createElement("div",{className:"mx_SettingsTab mx_SecurityUserSettingsTab"},o.a.createElement(ua.d,{onFinished:this.onLoginWithQRFinished,mode:this.state.showLoginWithQR,client:c})):o.a.createElement("div",{className:"mx_SettingsTab mx_SecurityUserSettingsTab"},n,r,o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Encryption")),o.a.createElement("div",{className:"mx_SettingsTab_section"},e,t,a,o.a.createElement(Ot,null)),i,s)}}var fa=a(235),Ea=a(1007),ya=a(239),_a=a(981);const Sa=e=>{let{icon:t,label:a,onDeleteClick:n,disabled:i=!1}=e;return o.a.createElement("div",{className:"mx_Tag"},null==t?void 0:t(),a,n&&o.a.createElement(f.a,{className:"mx_Tag_delete",onClick:n,disabled:i},o.a.createElement(_a.a,null)))};class wa extends o.a.PureComponent{constructor(e){super(e),i()(this,"onInputChange",(e=>{this.setState({newTag:e.target.value})})),i()(this,"onAdd",(e=>{e.preventDefault(),this.state.newTag&&(this.props.onAdd(this.state.newTag),this.setState({newTag:""}))})),this.state={newTag:""}}onRemove(e){this.props.onRemove(e)}render(){return o.a.createElement("div",{className:"mx_TagComposer"},o.a.createElement("form",{className:"mx_TagComposer_input",onSubmit:this.onAdd},o.a.createElement(u.a,{value:this.state.newTag,onChange:this.onInputChange,label:this.props.label||Object(l.b)("Keyword"),placeholder:this.props.placeholder||Object(l.b)("New keyword"),disabled:this.props.disabled,autoComplete:"off"}),o.a.createElement(f.a,{onClick:this.onAdd,kind:"primary",disabled:this.props.disabled},Object(l.b)("Add"))),o.a.createElement("div",{className:"mx_TagComposer_tags"},this.props.tags.map(((e,t)=>o.a.createElement(Sa,{label:e,key:e,onDeleteClick:this.onRemove.bind(this,e),disabled:this.props.disabled})))))}}var Oa=a(144),Ca=a(939),xa=a(412),ja=a(984),ka=a(398);function Ra(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Ia(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Ra(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Ra(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var Ta=function(e){return e.Loading="loading",e.Ready="ready",e.Persisting="persisting",e.Error="error",e.SavingError="savingError",e}(Ta||{}),Na=function(e){return e.Master="master",e.VectorGlobal="vector_global",e.VectorMentions="vector_mentions",e.VectorOther="vector_other",e.Other="other",e}(Na||{});const Pa="_keywords",Da=Na.VectorMentions,Ma=[fa.f.DM,fa.f.EncryptedDM,fa.f.Message,fa.f.EncryptedMessage,fa.f.ContainsDisplayName,fa.f.ContainsUserName,fa.f.AtRoomNotification,fa.f.InviteToSelf,fa.f.IncomingCall,fa.f.SuppressNotices,fa.f.Tombstone],Aa=[Ea.d.Off,Ea.d.On,Ea.d.Loud],Ua=(e,t,a)=>{var n;if(null===(n=a.syncedRuleIds)||void 0===n||!n.length)return;const i=a.syncedRuleIds.reduce(((t,n)=>{if(t===Ea.d.Loud)return t;const i=((e,t)=>{for(const a in t){const n=t[a].find((t=>t.rule_id===e));if(n)return n}})(n,e);if(i){const e=a.ruleToVectorState(i);if(Aa.indexOf(e)>Aa.indexOf(t))return e}return t}),a.ruleToVectorState(t));return i};class La extends o.a.PureComponent{constructor(e){var t,a;super(e),a=this,i()(this,"settingWatchers",void 0),i()(this,"onMasterRuleChanged",(async e=>{this.setState({phase:Ta.Persisting});const t=this.state.masterPushRule;try{await h.a.get().setPushRuleEnabled("global",t.kind,t.rule_id,!e),await this.refreshFromServer()}catch(e){this.setState({phase:Ta.Error}),d.a.error("Error updating master push rule:",e),this.showSaveError()}})),i()(this,"setSavingError",(e=>{this.setState((t=>{let{ruleIdsWithError:a}=t;return{phase:Ta.SavingError,ruleIdsWithError:Ia(Ia({},a),{},{[e]:!0})}}))})),i()(this,"updateDeviceNotifications",(async e=>{await O.b.setValue("deviceNotificationsEnabled",null,z.a.DEVICE,e)})),i()(this,"onEmailNotificationsChanged",(async(e,t)=>{this.setState({phase:Ta.Persisting});try{if(t)await h.a.get().setPusher({kind:"email",app_id:"m.email",pushkey:e,app_display_name:"Email Notifications",device_display_name:e,lang:navigator.language,data:{brand:Me.b.get().brand},append:!0});else{var a;const t=null===(a=this.state.pushers)||void 0===a?void 0:a.find((t=>"email"===t.kind&&t.pushkey===e));t&&(t.kind=null,await h.a.get().setPusher(t))}await this.refreshFromServer()}catch(e){this.setState({phase:Ta.Error}),d.a.error("Error updating email pusher:",e),this.showSaveError()}})),i()(this,"onDesktopNotificationsChanged",(async e=>{await O.b.setValue("notificationsEnabled",null,z.a.DEVICE,e)})),i()(this,"onDesktopShowBodyChanged",(async e=>{await O.b.setValue("notificationBodyEnabled",null,z.a.DEVICE,e)})),i()(this,"onAudioNotificationsChanged",(async e=>{await O.b.setValue("audioNotificationsEnabled",null,z.a.DEVICE,e)})),i()(this,"onSoundPackChanged",(async e=>{const t=e.target.value;this.setState({soundPack:t}),await O.b.setValue("soundPack",null,z.a.DEVICE,t)})),i()(this,"onRadioChecked",(async(e,t)=>{this.setState((t=>{let{ruleIdsWithError:a}=t;return{phase:Ta.Persisting,ruleIdsWithError:Ia(Ia({},a),{},{[e.ruleId]:!1})}}));try{const a=h.a.get();if(e.ruleId===Pa){if(!this.state.vectorKeywordRuleInfo)throw new Error("Notification data is incomplete.");for(const e of this.state.vectorKeywordRuleInfo.rules){let n,i;t===Ea.d.On?(1!==e.actions.length&&(i=Ea.b.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===Ea.d.Off&&(n=!0)):t===Ea.d.Loud?(3!==e.actions.length&&(i=Ea.b.actionsFor(t)),this.state.vectorKeywordRuleInfo.vectorState===Ea.d.Off&&(n=!0)):n=!1,i&&await a.setPushRuleActions("global",e.kind,e.rule_id,i),void 0!==n&&await a.setPushRuleEnabled("global",e.kind,e.rule_id,n)}}else{const n=Ea.c[e.ruleId],i=n.vectorStateToActions[t];if(!e.rule)throw new Error("Cannot update rule: push rule data is incomplete.");await Object(ja.b)(a,e.rule.rule_id,e.rule.kind,i),await Object(ja.a)(a,n.syncedRuleIds,i)}await this.refreshFromServer()}catch(t){this.setSavingError(e.ruleId),d.a.error("Error updating push rule:",t)}})),i()(this,"onClearNotificationsClicked",(async()=>{try{this.setState({clearingNotifications:!0});const e=h.a.get();await Object(xa.a)(e)}finally{this.setState({clearingNotifications:!1})}})),i()(this,"onKeywordAdd",(e=>{const t=Object(Ee.a)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:Ta.Persisting,vectorKeywordRuleInfo:Ia(Ia({},this.state.vectorKeywordRuleInfo),{},{rules:[...this.state.vectorKeywordRuleInfo.rules,{pattern:e}]})},(async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map((e=>e.pattern)),t)}))})),i()(this,"onKeywordRemove",(e=>{const t=Object(Ee.a)(this.state.vectorKeywordRuleInfo.rules);this.setState({phase:Ta.Persisting,vectorKeywordRuleInfo:Ia(Ia({},this.state.vectorKeywordRuleInfo),{},{rules:this.state.vectorKeywordRuleInfo.rules.filter((t=>t.pattern!==e))})},(async()=>{await this.setKeywords(this.state.vectorKeywordRuleInfo.rules.map((e=>e.pattern)),t)}))})),this.state={phase:Ta.Loading,deviceNotificationsEnabled:null===(t=O.b.getValue("deviceNotificationsEnabled"))||void 0===t||t,desktopNotifications:O.b.getValue("notificationsEnabled"),desktopShowBody:O.b.getValue("notificationBodyEnabled"),audioNotifications:O.b.getValue("audioNotificationsEnabled"),soundPack:O.b.getValue("soundPack"),clearingNotifications:!1,ruleIdsWithError:{}},this.settingWatchers=[O.b.watchSetting("notificationsEnabled",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,,i]=t;return a.setState({desktopNotifications:i})})),O.b.watchSetting("deviceNotificationsEnabled",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,,i]=t;a.setState({deviceNotificationsEnabled:i})})),O.b.watchSetting("notificationBodyEnabled",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,,i]=t;return a.setState({desktopShowBody:i})})),O.b.watchSetting("audioNotificationsEnabled",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,,i]=t;return a.setState({audioNotifications:i})})),O.b.watchSetting("soundPack",null,(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];let[,,,,i]=t;return a.setState({soundPack:i})}))]}get isInhibited(){var e;return!(null===(e=this.state.masterPushRule)||void 0===e||!e.enabled)}componentDidMount(){this.refreshFromServer(),this.refreshFromAccountData()}componentWillUnmount(){this.settingWatchers.forEach((e=>O.b.unwatchSetting(e)))}componentDidUpdate(e,t){this.state.deviceNotificationsEnabled!==t.deviceNotificationsEnabled&&this.persistLocalNotificationSettings(this.state.deviceNotificationsEnabled)}async refreshFromServer(){try{const e=(await Promise.all([this.refreshRules(),this.refreshPushers(),this.refreshThreepids()])).reduce(((e,t)=>Object.assign(t,e)),{});this.setState(Ia(Ia({},e),{},{phase:Ta.Ready}))}catch(e){d.a.error("Error setting up notifications for settings: ",e),this.setState({phase:Ta.Error})}}async refreshFromAccountData(){const e=h.a.get(),t=e.getAccountData(Object(xa.d)(e.deviceId));if(t){const e=!t.getContent().is_silenced;await this.updateDeviceNotifications(e)}}persistLocalNotificationSettings(e){const t=h.a.get();return t.setAccountData(Object(xa.d)(t.deviceId),{is_silenced:!e})}async refreshRules(){const e=await h.a.get().getPushRules(),t={[fa.f.Master]:Na.Master,[fa.f.DM]:Na.VectorGlobal,[fa.f.EncryptedDM]:Na.VectorGlobal,[fa.f.Message]:Na.VectorGlobal,[fa.f.EncryptedMessage]:Na.VectorGlobal,[fa.f.ContainsDisplayName]:Na.VectorMentions,[fa.f.ContainsUserName]:Na.VectorMentions,[fa.f.AtRoomNotification]:Na.VectorMentions,[fa.f.InviteToSelf]:Na.VectorOther,[fa.f.IncomingCall]:Na.VectorOther,[fa.f.SuppressNotices]:Na.VectorOther,[fa.f.Tombstone]:Na.VectorOther},a={[Na.Master]:[],[Na.VectorGlobal]:[],[Na.VectorMentions]:[],[Na.VectorOther]:[],[Na.Other]:[]};for(const i in e.global){const s=i;for(const i of e.global[s]){var n;const e=Object.assign(i,{kind:s}),o=null!==(n=t[e.rule_id])&&void 0!==n?n:Na.Other;"."===e.rule_id[0]&&a[o].push(e)}}const i={};if(!(a.master.length>0))throw new Error("Failed to locate a master push rule");i.masterPushRule=a.master[0],i.vectorKeywordRuleInfo=Ea.a.parseContentRules(e),i.vectorPushRules={};const s=[Na.VectorGlobal,Na.VectorMentions,Na.VectorOther];for(const e of s){i.vectorPushRules[e]=[];for(const t of a[e]){const n=Ea.c[t.rule_id],s=n.ruleToVectorState(t);i.vectorPushRules[e].push({ruleId:t.rule_id,rule:t,vectorState:s,syncedVectorState:Ua(a,t,n),description:Object(l.b)(n.description)})}i.vectorPushRules[e].sort(((e,t)=>{let a=Ma.indexOf(e.ruleId),n=Ma.indexOf(t.ruleId);return a<0&&(a=Ma.length),n<0&&(n=Ma.length),a-n})),e===Da&&i.vectorPushRules[e].push({ruleId:Pa,description:Object(l.b)("Messages containing keywords"),vectorState:i.vectorKeywordRuleInfo.vectorState})}return i}refreshPushers(){return h.a.get().getPushers()}refreshThreepids(){return h.a.get().getThreePids()}showSaveError(){g.b.createDialog(b.a,{title:Object(l.b)("Error saving notification preferences"),description:Object(l.b)("An error occurred whilst saving your notification preferences.")})}async setKeywords(e,t){try{var a;e=Object(Oa.n)(Array.from(new Set(e)));const i=Object(Oa.n)(Array.from(new Set(t.map((e=>e.pattern))))),s=Object(Oa.a)(i,e);for(const e of s.removed)for(const a of t.filter((t=>t.pattern===e)))await h.a.get().deletePushRule("global",a.kind,a.rule_id);let o=null===(a=this.state.vectorKeywordRuleInfo)||void 0===a?void 0:a.vectorState;var n;if(o===Ea.d.Off)if(t.length)o=null!==(n=Ea.b.contentRuleVectorStateKind(t[0]))&&void 0!==n?n:void 0;else o=Ea.d.On;const r=fa.e.ContentSpecific;for(const e of s.added)await h.a.get().addPushRule("global",r,e,{actions:Ea.b.actionsFor(o),pattern:e}),o===Ea.d.Off&&await h.a.get().setPushRuleEnabled("global",r,e,!1);await this.refreshFromServer()}catch(e){this.setState({phase:Ta.Error}),d.a.error("Error updating keyword push rules:",e),this.showSaveError()}}renderTopSection(){const e=o.a.createElement(o.a.Fragment,null,o.a.createElement(ya.a,{"data-testid":"notif-master-switch",value:!this.isInhibited,label:Object(l.b)("Enable notifications for this account"),caption:Object(l.b)("Turn off to disable notifications on all your devices and sessions"),onChange:this.onMasterRuleChanged,disabled:this.state.phase===Ta.Persisting}));if(this.isInhibited)return e;const t=(this.state.threepids||[]).filter((e=>e.medium===K.Email)).map((e=>{var t;return o.a.createElement(ya.a,{"data-testid":"notif-email-switch",key:e.address,value:!(null===(t=this.state.pushers)||void 0===t||!t.some((t=>"email"===t.kind&&t.pushkey===e.address))),label:Object(l.b)("Enable email notifications for %(email)s",{email:e.address}),onChange:this.onEmailNotificationsChanged.bind(this,e.address),disabled:this.state.phase===Ta.Persisting})}));return o.a.createElement(o.a.Fragment,null,e,o.a.createElement(ya.a,{"data-testid":"notif-device-switch",value:this.state.deviceNotificationsEnabled,label:Object(l.b)("Enable notifications for this device"),onChange:e=>this.updateDeviceNotifications(e),disabled:this.state.phase===Ta.Persisting}),this.state.deviceNotificationsEnabled&&o.a.createElement(o.a.Fragment,null,o.a.createElement(ya.a,{"data-testid":"notif-setting-notificationsEnabled",value:this.state.desktopNotifications,onChange:this.onDesktopNotificationsChanged,label:Object(l.b)("Enable desktop notifications for this session"),disabled:this.state.phase===Ta.Persisting}),o.a.createElement(ya.a,{"data-testid":"notif-setting-notificationBodyEnabled",value:this.state.desktopShowBody,onChange:this.onDesktopShowBodyChanged,label:Object(l.b)("Show message in desktop notification"),disabled:this.state.phase===Ta.Persisting}),o.a.createElement(ya.a,{"data-testid":"notif-setting-audioNotificationsEnabled",value:this.state.audioNotifications,onChange:this.onAudioNotificationsChanged,label:Object(l.b)("Enable audible notifications for this session"),disabled:this.state.phase===Ta.Persisting})),t,o.a.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},o.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(l.b)("Sound pack")),o.a.createElement("div",{className:"mx_SettingsTab_multilineRadioSelectors"},o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"sound_pack",value:Ca.a.Schildi,checked:this.state.soundPack===Ca.a.Schildi,onChange:this.onSoundPackChanged},Object(l.b)("Schildi: Softer sounds for reduced anxiety"))),o.a.createElement("label",null,o.a.createElement(Ye.a,{name:"sound_pack",value:Ca.a.Classic,checked:this.state.soundPack===Ca.a.Classic,onChange:this.onSoundPackChanged},Object(l.b)("Classic: The same sharp sounds as Element"))))))}renderCategory(e){var t,a;if(e!==Na.VectorOther&&this.isInhibited)return null;let n,i;if(e===Na.VectorOther&&h.a.get().getRooms().some((e=>e.getUnreadNotificationCount()>0))&&(n=o.a.createElement(f.a,{onClick:this.onClearNotificationsClicked,disabled:this.state.clearingNotifications,kind:"danger",className:"mx_UserNotifSettings_clearNotifsButton","data-testid":"clear-notifications"},Object(l.b)("Mark all as read"))),e===Na.VectorOther&&this.isInhibited)return n?o.a.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},o.a.createElement("div",null,Object(l.b)("Other")),n):null;var s;e===Na.VectorMentions&&(i=o.a.createElement(wa,{tags:null===(s=this.state.vectorKeywordRuleInfo)||void 0===s?void 0:s.rules.map((e=>e.pattern)),onAdd:this.onKeywordAdd,onRemove:this.onKeywordRemove,disabled:this.state.phase===Ta.Persisting,label:Object(l.b)("Keyword"),placeholder:Object(l.b)("New keyword")}));const r={[Ea.d.On]:Object(l.b)("On"),[Ea.d.Off]:Object(l.b)("Off"),[Ea.d.Loud]:Object(l.b)("Noisy")},c=(e,t)=>{var a;return o.a.createElement(Ye.a,{key:e.ruleId+t,name:e.ruleId,checked:(null!==(a=e.syncedVectorState)&&void 0!==a?a:e.vectorState)===t,onChange:this.onRadioChecked.bind(this,e,t),disabled:this.state.phase===Ta.Persisting,"aria-label":r[t]})},d=null===(t=this.state.vectorPushRules)||void 0===t||null===(a=t[e])||void 0===a?void 0:a.map((t=>o.a.createElement("fieldset",{key:e+t.ruleId,"data-testid":e+t.ruleId,className:"mx_UserNotifSettings_gridRowContainer"},o.a.createElement("legend",{className:"mx_UserNotifSettings_gridRowLabel"},t.description),c(t,Ea.d.Off),c(t,Ea.d.On),c(t,Ea.d.Loud),this.state.ruleIdsWithError[t.ruleId]&&o.a.createElement("div",{className:"mx_UserNotifSettings_gridRowError"},o.a.createElement(ka.a,{isError:!0},Object(l.b)("An error occurred when updating your notification preferences. Please try to toggle your option again."))))));let m;switch(e){case Na.VectorGlobal:m=Object(l.b)("Global");break;case Na.VectorMentions:m=Object(l.b)("Mentions & keywords");break;case Na.VectorOther:m=Object(l.b)("Other");break;default:throw new Error("Developer error: Unnamed notifications section: "+e)}return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{"data-testid":`notif-section-${e}`,className:"mx_UserNotifSettings_grid"},o.a.createElement("span",{className:"mx_UserNotifSettings_gridRowLabel mx_UserNotifSettings_gridRowHeading"},m),o.a.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[Ea.d.Off]),o.a.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[Ea.d.On]),o.a.createElement("span",{className:"mx_UserNotifSettings_gridColumnLabel"},r[Ea.d.Loud]),d),n,i)}renderTargets(){var e;if(this.isInhibited)return null;const t=null===(e=this.state.pushers)||void 0===e?void 0:e.map((e=>o.a.createElement("tr",{key:e.kind+e.pushkey},o.a.createElement("td",null,e.app_display_name),o.a.createElement("td",null,e.device_display_name))));return null!=t&&t.length?o.a.createElement("div",{className:"mx_UserNotifSettings_floatingSection"},o.a.createElement("div",null,Object(l.b)("Notification targets")),o.a.createElement("table",null,o.a.createElement("tbody",null,t))):null}render(){return this.state.phase===Ta.Loading?o.a.createElement(k.a,null):this.state.phase===Ta.Error?o.a.createElement("p",{"data-testid":"error-message"},Object(l.b)("There was an error loading your notification settings.")):o.a.createElement("div",{className:"mx_UserNotifSettings"},this.renderTopSection(),this.renderCategory(Na.VectorGlobal),this.renderCategory(Na.VectorMentions),this.renderCategory(Na.VectorOther),this.renderTargets())}}class Fa extends o.a.Component{render(){return o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Notifications")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement(La,null)))}}var Ba=a(220),Va=a(509);class Wa extends o.a.Component{constructor(e){super(e),i()(this,"onAutocompleteDelayChange",(e=>{this.setState({autocompleteDelay:e.target.value}),O.b.setValue("autocompleteDelay",null,z.a.DEVICE,e.target.value)})),i()(this,"onReadMarkerInViewThresholdMs",(e=>{this.setState({readMarkerInViewThresholdMs:e.target.value}),O.b.setValue("readMarkerInViewThresholdMs",null,z.a.DEVICE,e.target.value)})),i()(this,"onReadMarkerOutOfViewThresholdMs",(e=>{this.setState({readMarkerOutOfViewThresholdMs:e.target.value}),O.b.setValue("readMarkerOutOfViewThresholdMs",null,z.a.DEVICE,e.target.value)})),i()(this,"onKeyboardShortcutsClicked",(()=>{A.a.dispatch({action:U.a.ViewUserSettings,initialTabId:Ba.a.Keyboard})})),this.state={autocompleteDelay:O.b.getValueAt(z.a.DEVICE,"autocompleteDelay").toString(10),readMarkerInViewThresholdMs:O.b.getValueAt(z.a.DEVICE,"readMarkerInViewThresholdMs").toString(10),readMarkerOutOfViewThresholdMs:O.b.getValueAt(z.a.DEVICE,"readMarkerOutOfViewThresholdMs").toString(10)}}renderGroup(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:z.a.ACCOUNT;return e.map((e=>o.a.createElement(Ue.a,{key:e,name:e,level:t})))}render(){const e=O.b.getValue("FTUE.useCaseSelection"),t=Wa.ROOM_LIST_SETTINGS.filter((e=>"breadcrumbs"!==e||!O.b.getValue("feature_breadcrumbs_v2"))).filter((t=>"FTUE.userOnboardingButton"!==t||Object(Va.b)(e)));return o.a.createElement("div",{className:"mx_SettingsTab mx_PreferencesUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Preferences")),t.length>0&&o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Room list")),this.renderGroup(t)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Spaces")),this.renderGroup(Wa.SPACES_SETTINGS,z.a.ACCOUNT)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Keyboard shortcuts")),o.a.createElement("div",{className:"mx_SettingsFlag"},Object(l.b)("To view all keyboard shortcuts, <a>click here</a>.",{},{a:e=>o.a.createElement(f.a,{kind:"link_inline",onClick:this.onKeyboardShortcutsClicked},e)})),this.renderGroup(Wa.KEYBINDINGS_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Displaying time")),this.renderGroup(Wa.TIME_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Presence")),o.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Share your activity and status with others.")),this.renderGroup(Wa.PRESENCE_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Composer")),this.renderGroup(Wa.COMPOSER_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Code blocks")),this.renderGroup(Wa.CODE_BLOCKS_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Images, GIFs and videos")),this.renderGroup(Wa.IMAGES_AND_VIDEOS_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Timeline")),this.renderGroup(Wa.TIMELINE_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Room directory")),this.renderGroup(Wa.ROOM_DIRECTORY_SETTINGS)),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("General")),this.renderGroup(Wa.GENERAL_SETTINGS),o.a.createElement(Ue.a,{name:"Electron.showTrayIcon",level:z.a.PLATFORM,hideIfCannotSet:!0}),o.a.createElement(Ue.a,{name:"Electron.enableHardwareAcceleration",level:z.a.PLATFORM,hideIfCannotSet:!0,label:Object(l.b)("Enable hardware acceleration (restart %(appName)s to take effect)",{appName:Me.b.get().brand})}),o.a.createElement(Ue.a,{name:"Electron.alwaysShowMenuBar",level:z.a.PLATFORM,hideIfCannotSet:!0}),o.a.createElement(Ue.a,{name:"Electron.autoLaunch",level:z.a.PLATFORM,hideIfCannotSet:!0}),o.a.createElement(Ue.a,{name:"Electron.warnBeforeExit",level:z.a.PLATFORM,hideIfCannotSet:!0}),o.a.createElement(u.a,{label:Object(l.b)("Autocomplete delay (ms)"),type:"number",value:this.state.autocompleteDelay,onChange:this.onAutocompleteDelayChange}),o.a.createElement(u.a,{label:Object(l.b)("Read Marker lifetime (ms)"),type:"number",value:this.state.readMarkerInViewThresholdMs,onChange:this.onReadMarkerInViewThresholdMs}),o.a.createElement(u.a,{label:Object(l.b)("Read Marker off-screen lifetime (ms)"),type:"number",value:this.state.readMarkerOutOfViewThresholdMs,onChange:this.onReadMarkerOutOfViewThresholdMs})))}}i()(Wa,"ROOM_LIST_SETTINGS",["breadcrumbs","FTUE.userOnboardingButton"]),i()(Wa,"SPACES_SETTINGS",["Spaces.allRoomsInHome","Spaces.showSpaceDMBadges","Spaces.returnToPreviouslyOpenedRoom"]),i()(Wa,"KEYBINDINGS_SETTINGS",["ctrlFForSearch"]),i()(Wa,"PRESENCE_SETTINGS",["sendReadReceipts","sendTypingNotifications"]),i()(Wa,"COMPOSER_SETTINGS",["MessageComposerInput.autoReplaceEmoji","MessageComposerInput.useMarkdown","MessageComposerInput.suggestEmoji","MessageComposerInput.ctrlEnterToSend","MessageComposerInput.surroundWith","MessageComposerInput.showStickersButton","MessageComposerInput.collapseButtons","MessageComposerInput.insertTrailingColon"]),i()(Wa,"TIME_SETTINGS",["showTwelveHourTimestamps","alwaysShowTimestamps"]),i()(Wa,"CODE_BLOCKS_SETTINGS",["enableSyntaxHighlightLanguageDetection","expandCodeByDefault","showCodeLineNumbers"]),i()(Wa,"IMAGES_AND_VIDEOS_SETTINGS",["urlPreviewsEnabled","youtubeEmbedPlayer","autoplayGifs","autoplayVideo","showImages"]),i()(Wa,"TIMELINE_SETTINGS",["showTypingNotifications","showRedactions","showReadReceipts","showJoinLeaves","showDisplaynameChanges","showChatEffects","showAvatarChanges","Pill.shouldShowPillAvatar","TextualBody.enableBigEmoji","scrollToBottomOnMessageSent","useOnlyCurrentProfiles"]),i()(Wa,"ROOM_DIRECTORY_SETTINGS",["SpotlightSearch.showNsfwPublicRooms"]),i()(Wa,"GENERAL_SETTINGS",["promptBeforeInviteUnknownUsers"]);var za=a(252),Ha=a(895);class Ka extends o.a.Component{constructor(e){super(e),i()(this,"refreshMediaDevices",(async e=>{var t;this.setState({mediaDevices:null!==(t=await za.c.getDevices())&&void 0!==t?t:null,[za.b.AudioOutput]:za.c.getAudioOutput(),[za.b.AudioInput]:za.c.getAudioInput(),[za.b.VideoInput]:za.c.getVideoInput()}),e&&e.getTracks().forEach((e=>e.stop()))})),i()(this,"requestMediaPermissions",(async()=>{const e=await Object(Ha.a)();e&&this.refreshMediaDevices(e)})),i()(this,"setDevice",((e,t)=>{za.c.instance.setDevice(e,t),this.setState({[t]:e})})),i()(this,"changeWebRtcMethod",(e=>{h.a.get().setForceTURN(!e)})),i()(this,"changeFallbackICEServerAllowed",(e=>{h.a.get().setFallbackICEServerAllowed(e)})),this.state={mediaDevices:null,[za.b.AudioOutput]:null,[za.b.AudioInput]:null,[za.b.VideoInput]:null,audioAutoGainControl:za.c.getAudioAutoGainControl(),audioEchoCancellation:za.c.getAudioEchoCancellation(),audioNoiseSuppression:za.c.getAudioNoiseSuppression()}}async componentDidMount(){await za.c.hasAnyLabeledDevices()&&this.refreshMediaDevices()}renderDeviceOptions(e,t){return e.map((e=>o.a.createElement("option",{key:`${t}-${e.deviceId}`,value:e.deviceId},e.label)))}renderDropdown(e,t){var a;const n=null===(a=this.state.mediaDevices)||void 0===a?void 0:a[e].slice(0);if(null==n||!n.length)return null;const i=za.c.getDefaultDevice(n);return o.a.createElement(u.a,{element:"select",label:t,value:this.state[e]||i,onChange:t=>this.setDevice(t.target.value,e)},this.renderDeviceOptions(n,e))}render(){let e,t,a,n;return this.state.mediaDevices?this.state.mediaDevices&&(t=this.renderDropdown(za.b.AudioOutput,Object(l.b)("Audio Output"))||o.a.createElement("p",null,Object(l.b)("No Audio Outputs detected")),a=this.renderDropdown(za.b.AudioInput,Object(l.b)("Microphone"))||o.a.createElement("p",null,Object(l.b)("No Microphones detected")),n=this.renderDropdown(za.b.VideoInput,Object(l.b)("Camera"))||o.a.createElement("p",null,Object(l.b)("No Webcams detected"))):e=o.a.createElement("div",{className:"mx_VoiceUserSettingsTab_missingMediaPermissions"},o.a.createElement("p",null,Object(l.b)("Missing media permissions, click the button below to request.")),o.a.createElement(f.a,{onClick:this.requestMediaPermissions,kind:"primary"},Object(l.b)("Request media permissions"))),o.a.createElement("div",{className:"mx_SettingsTab mx_VoiceUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Voice & Video")),e,o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Voice settings")),t,a,o.a.createElement(ya.a,{value:this.state.audioAutoGainControl,onChange:async e=>{await za.c.setAudioAutoGainControl(e),this.setState({audioAutoGainControl:za.c.getAudioAutoGainControl()})},label:Object(l.b)("Automatically adjust the microphone volume"),"data-testid":"voice-auto-gain"})),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Video settings")),n,o.a.createElement(Ue.a,{name:"VideoView.flipVideoHorizontally",level:z.a.ACCOUNT})),o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Advanced")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Voice processing")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement(ya.a,{value:this.state.audioNoiseSuppression,onChange:async e=>{await za.c.setAudioNoiseSuppression(e),this.setState({audioNoiseSuppression:za.c.getAudioNoiseSuppression()})},label:Object(l.b)("Noise suppression"),"data-testid":"voice-noise-suppression"}),o.a.createElement(ya.a,{value:this.state.audioEchoCancellation,onChange:async e=>{await za.c.setAudioEchoCancellation(e),this.setState({audioEchoCancellation:za.c.getAudioEchoCancellation()})},label:Object(l.b)("Echo cancellation"),"data-testid":"voice-echo-cancellation"})),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Connection")),o.a.createElement(Ue.a,{name:"webRtcAllowPeerToPeer",level:z.a.DEVICE,onChange:this.changeWebRtcMethod}),o.a.createElement(Ue.a,{name:"fallbackICEServerAllowed",level:z.a.DEVICE,onChange:this.changeFallbackICEServerAllowed}))))}}var Ga=a(223),qa=a(134),$a=a.n(qa),Ya=a(358),Ja=a(242);const Qa=["action"];function Xa(){var e;null===(e=j.a.get())||void 0===e||e.installUpdate()}const Za=[Ya.d.Ready,Ya.d.Error,Ya.d.NotAvailable];var en=()=>{const[e,t]=Object(s.useState)(null);Object(Ja.a)(A.a,(e=>{let{action:a}=e,n=$a()(e,Qa);a===U.a.CheckUpdates&&t(n)}));const a=!!e&&!Za.includes(e.status);let n;return e&&(n=o.a.createElement("span",{className:"mx_UpdateCheckButton_summary"},function(e,t){switch(e){case Ya.d.Error:return Object(l.b)("Error encountered (%(errorDetail)s).",{errorDetail:t});case Ya.d.Checking:return Object(l.b)("Checking for an update…");case Ya.d.NotAvailable:return Object(l.b)("No update available.");case Ya.d.Downloading:return Object(l.b)("Downloading update…");case Ya.d.Ready:return Object(l.b)("New version available. <a>Update now.</a>",{},{a:e=>o.a.createElement(f.a,{kind:"link_inline",onClick:Xa},e)})}}(e.status,e.detail),a&&o.a.createElement(Ce.a,null))),o.a.createElement(o.a.Fragment,null,o.a.createElement(f.a,{onClick:()=>{var e;t(null),null===(e=j.a.get())||void 0===e||e.startUpdateCheck()},kind:"primary",disabled:a},Object(l.b)("Check for update")),n)},tn=a(270),an=a(311);class nn extends o.a.Component{constructor(e){super(e),i()(this,"onClearCacheAndReload",(()=>{j.a.get()&&(d.a.log("Clear cache & reload clicked"),h.a.get().stopClient(),h.a.get().store.deleteAllData().then((()=>{var e;null===(e=j.a.get())||void 0===e||e.reload()})))})),i()(this,"onBugReport",(()=>{g.b.createDialog(tn.a,{})})),i()(this,"onStartBotChat",(()=>{this.props.closeSettingsFn(),Object(Ga.b)({dmUserId:Me.b.get("welcome_user_id"),andView:!0})})),i()(this,"getVersionTextToCopy",(()=>{const{appVersion:e,olmVersion:t}=this.getVersionInfo();return`${e}\n${t}`})),i()(this,"onKeyboardShortcutsClicked",(()=>{A.a.dispatch({action:U.a.ViewUserSettings,initialTabId:Ba.a.Keyboard})})),this.state={appVersion:null,canUpdate:!1}}componentDidMount(){var e,t;null===(e=j.a.get())||void 0===e||e.getAppVersion().then((e=>this.setState({appVersion:e}))).catch((e=>{d.a.error("Error getting vector version: ",e)})),null===(t=j.a.get())||void 0===t||t.canSelfUpdate().then((e=>this.setState({canUpdate:e}))).catch((e=>{d.a.error("Error getting self updatability: ",e)}))}getVersionInfo(){const e=Me.b.get().brand,t=this.state.appVersion||"unknown",a=h.a.get().olmVersion,n=a?`${a[0]}.${a[1]}.${a[2]}`:"<not-enabled>";return{appVersion:`${Object(l.b)("%(brand)s version:",{brand:e})} ${t}`,olmVersion:`${Object(l.b)("Olm version:")} ${n}`}}renderLegal(){const e=Me.b.get().terms_and_conditions_links;if(!e)return null;const t=[];for(const a of e)t.push(o.a.createElement("div",{key:a.url},o.a.createElement("a",{href:a.url,rel:"noreferrer noopener",target:"_blank"},a.text)));return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Legal")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},t))}renderCredits(){return o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Credits")),o.a.createElement("ul",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("li",null,"The"," ",o.a.createElement("a",{href:"themes/element/img/backgrounds/ocean.jpg",rel:"noreferrer noopener",target:"_blank"}," ","default cover photo")," ","is from ",o.a.createElement("a",{href:"https://pixabay.com/de/photos/unterwasser-blau-ozean-meer-802092/",rel:"noreferrer noopener",target:"_blank"},"here")," ","used under the terms of the ",o.a.createElement("a",{href:"https://pixabay.com/de/service/license/",rel:"noreferrer noopener",target:"_blank"},"Pixabay License"),"."),o.a.createElement("li",null,"The"," ",o.a.createElement("a",{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"},"CC-BY-SA 4.0"),"."),o.a.createElement("li",null,"The"," ",o.a.createElement("a",{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"},"twemoji-colr")," ","font is © ",o.a.createElement("a",{href:"https://mozilla.org",rel:"noreferrer noopener",target:"_blank"},"Mozilla Foundation")," ","used under the terms of ",o.a.createElement("a",{href:"https://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},"Apache 2.0"),"."),o.a.createElement("li",null,"The"," ",o.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twemoji")," ","emoji art is © ",o.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twitter, Inc and other contributors")," ","used under the terms of ",o.a.createElement("a",{href:"https://creativecommons.org/licenses/by/4.0/",rel:"noreferrer noopener",target:"_blank"},"CC-BY 4.0"),"."),o.a.createElement("li",null,'The "schildi" ring sound is © Ana Gelez used under the terms of ',o.a.createElement("a",{href:"https://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},"Apache 2.0"),"."),o.a.createElement("li",null,'The "schildi" message sound is created by Ash Logan and used under the terms of ',o.a.createElement("a",{href:"https://creativecommons.org/publicdomain/zero/1.0/",rel:"noreferrer noopener",target:"_blank"},"CC0"),".")))}render(){const e=Me.b.get().brand;let t,a,n=Object(l.b)("For help with using %(brand)s, click <a>here</a>.",{brand:e},{a:e=>o.a.createElement("a",{href:"https://element.io/help",rel:"noreferrer noopener",target:"_blank"},e)});Me.b.get("welcome_user_id")&&Object(l.f)().startsWith("en")&&(n=o.a.createElement("div",null,Object(l.b)("For help with using %(brand)s, click <a>here</a> or start a chat with our bot using the button below.",{brand:e},{a:e=>o.a.createElement("a",{href:"https://element.io/help",rel:"noreferrer noopener",target:"_blank"},e)}),o.a.createElement("div",null,o.a.createElement(f.a,{onClick:this.onStartBotChat,kind:"primary"},Object(l.b)("Chat with %(brand)s Bot",{brand:e}))))),this.state.canUpdate&&(t=o.a.createElement(en,null)),Me.b.get().bug_report_endpoint_url&&(a=o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Bug reporting")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. "),Object(l.b)("Debug logs contain application usage data including your username, the IDs or aliases of the rooms you have visited, which UI elements you last interacted with, and the usernames of other users. They do not contain messages.")),o.a.createElement(f.a,{onClick:this.onBugReport,kind:"primary"},Object(l.b)("Submit debug logs")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("To report a Matrix-related security issue, please read the Matrix.org <a>Security Disclosure Policy</a>.",{},{a:e=>o.a.createElement("a",{href:"https://matrix.org/security-disclosure-policy/",rel:"noreferrer noopener",target:"_blank"},e)}))));const{appVersion:i,olmVersion:s}=this.getVersionInfo();return o.a.createElement("div",{className:"mx_SettingsTab mx_HelpUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Help & About")),a,o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("FAQ")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},n),o.a.createElement(f.a,{kind:"primary",onClick:this.onKeyboardShortcutsClicked},Object(l.b)("Keyboard Shortcuts"))),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Versions")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement(an.a,{getTextToCopy:this.getVersionTextToCopy},i,o.a.createElement("br",null),s,o.a.createElement("br",null)),t)),this.renderLegal(),this.renderCredits(),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Advanced")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("div",null,Object(l.b)("Homeserver is <code>%(homeserverUrl)s</code>",{homeserverUrl:h.a.get().getHomeserverUrl()},{code:e=>o.a.createElement("code",null,e)})),o.a.createElement("div",null,h.a.get().getIdentityServerUrl()&&Object(l.b)("Identity server is <code>%(identityServerUrl)s</code>",{identityServerUrl:h.a.get().getIdentityServerUrl()},{code:e=>o.a.createElement("code",null,e)})),o.a.createElement("details",null,o.a.createElement("summary",null,Object(l.b)("Access Token")),o.a.createElement("b",null,Object(l.b)("Your access token gives full access to your account. Do not share it with anyone.")),o.a.createElement(an.a,{getTextToCopy:()=>h.a.get().getAccessToken()},h.a.get().getAccessToken())),o.a.createElement(f.a,{onClick:this.onClearCacheAndReload,kind:"danger"},Object(l.b)("Clear cache and reload")))))}}var sn=a(555),on=a(513);class rn extends o.a.Component{constructor(e){super(e),i()(this,"onPersonalRuleChanged",(e=>{this.setState({newPersonalRule:e.target.value})})),i()(this,"onNewListChanged",(e=>{this.setState({newList:e.target.value})})),i()(this,"onAddPersonalRule",(async e=>{e.preventDefault(),e.stopPropagation();let t=on.d;this.state.newPersonalRule.startsWith("@")&&(t=on.e),this.setState({busy:!0});try{const e=await sn.a.sharedInstance().getOrCreatePersonalList();await e.banEntity(t,this.state.newPersonalRule,Object(l.b)("Ignored/Blocked")),this.setState({newPersonalRule:""})}catch(e){d.a.error(e),g.b.createDialog(b.a,{title:Object(l.b)("Error adding ignored user/server"),description:Object(l.b)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}})),i()(this,"onSubscribeList",(async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=await h.a.get().joinRoom(this.state.newList);await sn.a.sharedInstance().subscribeToList(e.roomId),this.setState({newList:""})}catch(e){d.a.error(e),g.b.createDialog(b.a,{title:Object(l.b)("Error subscribing to list"),description:Object(l.b)("Please verify the room ID or address and try again.")})}finally{this.setState({busy:!1})}})),this.state={busy:!1,newPersonalRule:"",newList:""}}async removePersonalRule(e){this.setState({busy:!0});try{const t=sn.a.sharedInstance().getPersonalList();await t.unbanEntity(e.kind,e.entity)}catch(e){d.a.error(e),g.b.createDialog(b.a,{title:Object(l.b)("Error removing ignored user/server"),description:Object(l.b)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}async unsubscribeFromList(e){this.setState({busy:!0});try{await sn.a.sharedInstance().unsubscribeFromList(e.roomId),await h.a.get().leave(e.roomId)}catch(e){d.a.error(e),g.b.createDialog(b.a,{title:Object(l.b)("Error unsubscribing from list"),description:Object(l.b)("Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}viewListRules(e){const t=h.a.get().getRoom(e.roomId),a=t?t.name:e.roomId,n=e=>{if(0===e.length)return o.a.createElement("i",null,Object(l.b)("None"));const t=[];for(const a of e)t.push(o.a.createElement("li",{key:a.kind+a.entity},o.a.createElement("code",null,a.entity)));return o.a.createElement("ul",null,t)};g.b.createDialog(le.a,{title:Object(l.b)("Ban list rules - %(roomName)s",{roomName:a}),description:o.a.createElement("div",null,o.a.createElement("h3",null,Object(l.b)("Server rules")),n(e.serverRules),o.a.createElement("h3",null,Object(l.b)("User rules")),n(e.userRules)),button:Object(l.b)("Close"),hasCancelButton:!1})}renderPersonalBanListRules(){const e=sn.a.sharedInstance().getPersonalList(),t=e?[...e.userRules,...e.serverRules]:[];if(!e||t.length<=0)return o.a.createElement("i",null,Object(l.b)("You have not ignored anyone."));const a=[];for(const e of t)a.push(o.a.createElement("li",{key:e.entity,className:"mx_MjolnirUserSettingsTab_listItem"},o.a.createElement(f.a,{kind:"danger_sm",onClick:()=>this.removePersonalRule(e),disabled:this.state.busy},Object(l.b)("Remove"))," ",o.a.createElement("code",null,e.entity)));return o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("You are currently ignoring:")),o.a.createElement("ul",null,a))}renderSubscribedBanLists(){const e=sn.a.sharedInstance().getPersonalList(),t=sn.a.sharedInstance().lists.filter((t=>!e||e.roomId!==t.roomId));if(!t||t.length<=0)return o.a.createElement("i",null,Object(l.b)("You are not subscribed to any lists"));const a=[];for(const e of t){const t=h.a.get().getRoom(e.roomId),n=t?o.a.createElement("span",null,t.name," (",o.a.createElement("code",null,e.roomId),")"):o.a.createElement("code",null,"list.roomId");a.push(o.a.createElement("li",{key:e.roomId,className:"mx_MjolnirUserSettingsTab_listItem"},o.a.createElement(f.a,{kind:"danger_sm",onClick:()=>this.unsubscribeFromList(e),disabled:this.state.busy},Object(l.b)("Unsubscribe"))," ",o.a.createElement(f.a,{kind:"primary_sm",onClick:()=>this.viewListRules(e),disabled:this.state.busy},Object(l.b)("View rules"))," ",n))}return o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("You are currently subscribed to:")),o.a.createElement("ul",null,a))}render(){const e=Me.b.get().brand;return o.a.createElement("div",{className:"mx_SettingsTab mx_MjolnirUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Ignored users")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"warning"},Object(l.b)("⚠ These settings are meant for advanced users.")),o.a.createElement("br",null),o.a.createElement("br",null),Object(l.b)("Add users and servers you want to ignore here. Use asterisks to have %(brand)s match any characters. For example, <code>@bot:*</code> would ignore all users that have the name 'bot' on any server.",{brand:e},{code:e=>o.a.createElement("code",null,e)}),o.a.createElement("br",null),o.a.createElement("br",null),Object(l.b)("Ignoring people is done through ban lists which contain rules for who to ban. Subscribing to a ban list means the users/servers blocked by that list will be hidden from you."))),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Personal ban list")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.b)("Your personal ban list holds all the users/servers you personally don't want to see messages from. After ignoring your first user/server, a new room will show up in your room list named '%(myBanList)s' - stay in this room to keep the ban list in effect.",{myBanList:Object(l.b)("My Ban List")})),o.a.createElement("div",null,this.renderPersonalBanListRules()),o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onAddPersonalRule,autoComplete:"off"},o.a.createElement(u.a,{type:"text",label:Object(l.b)("Server or user ID to ignore"),placeholder:Object(l.b)("eg: @bot:* or example.org"),value:this.state.newPersonalRule,onChange:this.onPersonalRuleChanged}),o.a.createElement(f.a,{type:"submit",kind:"primary",onClick:this.onAddPersonalRule,disabled:this.state.busy},Object(l.b)("Ignore"))))),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.b)("Subscribed lists")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},o.a.createElement("span",{className:"warning"},Object(l.b)("Subscribing to a ban list will cause you to join it!"))," ",o.a.createElement("span",null,Object(l.b)("If this isn't what you want, please use a different tool to ignore users."))),o.a.createElement("div",null,this.renderSubscribedBanLists()),o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onSubscribeList,autoComplete:"off"},o.a.createElement(u.a,{type:"text",label:Object(l.b)("Room ID or address of ban list"),value:this.state.newList,onChange:this.onNewListChanged}),o.a.createElement(f.a,{type:"submit",kind:"primary",onClick:this.onSubscribeList,disabled:this.state.busy},Object(l.b)("Subscribe"))))))}}var ln=a(968),cn=a(728),dn=a(681);const mn=Object.entries(ce.b).filter((e=>{let[t]=e;return t!==ce.c.LABS||Me.b.get("show_labs_settings")})),hn=e=>{let{name:t}=e;const a=Object(cn.a)(t),n=Object(cn.b)(t);return a&&n?o.a.createElement("div",{className:"mx_KeyboardShortcut_shortcutRow"},a,o.a.createElement(dn.a,{value:n})):null},un=e=>{let{categoryName:t,category:a}=e;return a.categoryLabel?o.a.createElement("div",{className:"mx_SettingsTab_section",key:t},o.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(l.b)(a.categoryLabel)),o.a.createElement("div",null," ",a.settingNames.map((e=>o.a.createElement(hn,{key:e,name:e})))," ")):null};var pn=()=>o.a.createElement("div",{className:"mx_SettingsTab mx_KeyboardUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.b)("Keyboard")),mn.map((e=>{let[t,a]=e;return o.a.createElement(un,{key:t,categoryName:t,category:a})}))),gn=a(955),bn=a(142);function vn(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function fn(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?vn(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):vn(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const En=(e,t)=>{const{name:a,version:n,url:i}=Object(gn.a)(e,t.device_id);return{appName:a,appVersion:n,url:i}};let yn=function(e){return e.Unsupported="Unsupported",e.Default="Default",e}({});const _n=()=>{var e;const t=Object(s.useContext)(ta.a),a=t.getDeviceId(),n=t.getSafeUserId(),[i,o]=Object(s.useState)({}),[r,c]=Object(s.useState)([]),[h,u]=Object(s.useState)(new Map),[p,g]=Object(s.useState)(!0),[b,v]=Object(s.useState)(!0),[f,E]=Object(s.useState)();Object(s.useEffect)((()=>{t.doesServerSupportUnstableFeature("org.matrix.msc3881").then((e=>{v(e)}))}),[t]);const y=Object(s.useCallback)((async()=>{g(!0);try{const e=await(async e=>{const{devices:t}=await e.getDevices();return t.reduce(((t,a)=>fn(fn({},t),{},{[a.device_id]:fn(fn(fn({},a),{},{isVerified:Object(aa.a)(e,a.device_id)},En(e,a)),Object(Vt.b)(a[m.UNSTABLE_MSC3852_LAST_SEEN_UA.name]))})),{})})(t);o(e);const{pushers:a}=await t.getPushers();c(a);const n=new Map;Object.keys(e).forEach((e=>{const a=`${m.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name}.${e}`,i=t.getAccountData(a);i&&n.set(e,i.getContent())})),u(n),g(!1)}catch(e){404==e.httpStatus?E(yn.Unsupported):(d.a.error("Error loading sessions:",e),E(yn.Default)),g(!1)}}),[t]);Object(s.useEffect)((()=>{y()}),[y]),Object(s.useEffect)((()=>{const e=Object.keys(i);e.length&&Object(gn.b)(e,t)}),[i,t]),Object(bn.a)(t,bt.b.DevicesUpdated,(e=>{e.includes(n)&&y()})),Object(bn.a)(t,m.ClientEvent.AccountData,(e=>{const t=e.getType();if(t.startsWith(m.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name)){const a=new Map(h),n=t.slice(t.lastIndexOf(".")+1);a.set(n,e.getContent()),u(a)}}));const _=!(null===(e=i[a])||void 0===e||!e.isVerified)&&n?async e=>await t.requestVerification(n,[e]):void 0,S=Object(s.useCallback)((async(e,a)=>{const n=i[e];if(a!==(null==n?void 0:n.display_name))try{await t.setDeviceDetails(e,{display_name:a}),await y()}catch(e){throw d.a.error("Error setting session display name",e),new Error(Object(l.b)("Failed to set display name"))}}),[t,i,y]),w=Object(s.useCallback)((async(e,a)=>{try{const n=r.find((t=>t[m.PUSHER_DEVICE_ID.name]===e));n?await t.setPusher(fn(fn({},n),{},{[m.PUSHER_ENABLED.name]:a})):h.has(e)&&await t.setLocalNotificationSettings(e,{is_silenced:!a})}catch(e){throw d.a.error("Error setting pusher state",e),new Error(Object(l.b)("Failed to set pusher state"))}finally{await y()}}),[t,r,h,y]);return{devices:i,pushers:r,localNotificationSettings:h,currentDeviceId:a,isLoadingDeviceList:p,error:f,requestDeviceVerification:_,refreshDevices:y,saveDeviceName:S,setPushNotifications:w,supportsMSC3881:b}};var Sn,wn=a(131),On=a.n(wn);function Cn(){return Cn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Cn.apply(this,arguments)}function xn(e){return s.createElement("svg",Cn({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),Sn||(Sn=s.createElement("path",{d:"M4 8.818L7.125 12 14 5",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})))}const jn=["value","options","selectedLabel","className"],kn=(e,t)=>a=>{const n=e.find((e=>{let{id:t}=e;return t===a}));return n?t?`${t}: ${n.label}`:n.label:null},Rn=e=>{let{value:t,options:a,selectedLabel:n,className:i}=e,s=$a()(e,jn);return o.a.createElement(x.a,On()({},s,{value:t,className:We()("mx_FilterDropdown",i),getShortOption:kn(a,n)}),a.map((e=>{let{id:a,label:n,description:i}=e;return o.a.createElement("div",{className:"mx_FilterDropdown_option","data-testid":`filter-option-${a}`,key:a},a===t&&o.a.createElement(xn,{className:"mx_FilterDropdown_optionSelectedIcon"}),o.a.createElement("span",{className:"mx_FilterDropdown_optionLabel"},n),!!i&&o.a.createElement("span",{className:"mx_FilterDropdown_optionDescription"},i))})))};var In=a(165),Tn=a(219);const Nn=["title","description"];var Pn=e=>{let{title:t,description:a}=e,n=$a()(e,Nn);return o.a.createElement(f.a,On()({},n,{kind:"link_inline",onClick:()=>{g.b.createDialog(Tn.a,{title:t,description:a,button:Object(l.b)("Got it"),hasCloseButton:!0})},className:"mx_LearnMore_button"}),Object(l.b)("Learn more"))};const Dn=e=>{let{device:t,saveDeviceName:a,stopEditing:n}=e;const[i,r]=Object(s.useState)(t.display_name||""),[c,d]=Object(s.useState)(!1),[m,h]=Object(s.useState)(null);Object(s.useEffect)((()=>{r(t.display_name||"")}),[t.display_name]);const p=async e=>{d(!0),h(null),e.preventDefault();try{await a(i),n()}catch(e){h(Object(l.b)("Failed to set display name")),d(!1)}},g=`device-rename-${t.device_id}`,b=`device-rename-description-${t.device_id}`;return o.a.createElement("form",{"aria-disabled":c,className:"mx_DeviceDetailHeading_renameForm",onSubmit:p,method:"post"},o.a.createElement("p",{id:g,className:"mx_DeviceDetailHeading_renameFormHeading"},Object(l.b)("Rename session")),o.a.createElement("div",null,o.a.createElement(u.a,{"data-testid":"device-rename-input",type:"text",value:i,autoComplete:"off",onChange:e=>r(e.target.value),autoFocus:!0,disabled:c,"aria-labelledby":g,"aria-describedby":b,className:"mx_DeviceDetailHeading_renameFormInput",maxLength:100}),o.a.createElement(ka.a,{id:b},Object(l.b)("Please be aware that session names are also visible to people you communicate with."),o.a.createElement(Pn,{title:Object(l.b)("Renaming sessions"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.b)("Other users in direct messages and rooms that you join are able to view a full list of your sessions.")),o.a.createElement("p",null,Object(l.b)("This provides them with confidence that they are really speaking to you, but it also means they can see the session name you enter here.")))}),!!m&&o.a.createElement("span",{"data-testid":"device-rename-error",className:"mx_DeviceDetailHeading_renameFormError"},m))),o.a.createElement("div",{className:"mx_DeviceDetailHeading_renameFormButtons"},o.a.createElement(f.a,{onClick:p,kind:"primary","data-testid":"device-rename-submit-cta",disabled:c},Object(l.b)("Save")),o.a.createElement(f.a,{onClick:n,kind:"secondary","data-testid":"device-rename-cancel-cta",disabled:c},Object(l.b)("Cancel")),c&&o.a.createElement(k.a,{w:16,h:16})))},Mn=e=>{let{device:t,saveDeviceName:a}=e;const[n,i]=Object(s.useState)(!1);return n?o.a.createElement(Dn,{device:t,saveDeviceName:a,stopEditing:()=>i(!1)}):o.a.createElement("div",{className:"mx_DeviceDetailHeading","data-testid":"device-detail-heading"},o.a.createElement(Rt.a,{size:"h4"},t.display_name||t.device_id),o.a.createElement(f.a,{kind:"link_inline",onClick:()=>i(!0),className:"mx_DeviceDetailHeading_renameCta","data-testid":"device-heading-rename-cta"},Object(l.b)("Rename")))};var An=a(954),Un=a(361);const Ln={[Un.a.Inactive]:An.a,[Un.a.Verified]:Ft,[Un.a.Unverified]:Bt.Icon,[Un.a.Unverifiable]:Bt.Icon},Fn=e=>{let{variation:t}=e;const a=Ln[t];return o.a.createElement("div",{className:We()("mx_DeviceSecurityCard_icon",t)},o.a.createElement(a,{height:16,width:16}))};var Bn=e=>{let{variation:t,heading:a,description:n,children:i}=e;return o.a.createElement("div",{className:"mx_DeviceSecurityCard"},o.a.createElement(Fn,{variation:t}),o.a.createElement("div",{className:"mx_DeviceSecurityCard_content"},o.a.createElement("p",{className:"mx_DeviceSecurityCard_heading"},a),o.a.createElement("p",{className:"mx_DeviceSecurityCard_description"},n),!!i&&o.a.createElement("div",{className:"mx_DeviceSecurityCard_actions"},i)))};const Vn={[Un.a.Verified]:{title:Object(l.b)("Verified sessions"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.b)("Verified sessions are anywhere you are using this account after entering your passphrase or confirming your identity with another verified session.")),o.a.createElement("p",null,Object(l.b)("This means that you have all the keys needed to unlock your encrypted messages and confirm to other users that you trust this session.")))},[Un.a.Unverified]:{title:Object(l.b)("Unverified sessions"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.b)("Unverified sessions are sessions that have logged in with your credentials but have not been cross-verified.")),o.a.createElement("p",null,Object(l.b)("You should make especially certain that you recognise these sessions as they could represent an unauthorised use of your account.")))},[Un.a.Unverifiable]:{title:Object(l.b)("Unverified session"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.b)("This session doesn't support encryption and thus can't be verified.")),o.a.createElement("p",null,Object(l.b)("You won't be able to participate in rooms where encryption is enabled when using this session.")),o.a.createElement("p",null,Object(l.b)("For best security and privacy, it is recommended to use Matrix clients that support encryption.")))},[Un.a.Inactive]:{title:Object(l.b)("Inactive sessions"),description:o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.b)("Inactive sessions are sessions you have not used in some time, but they continue to receive encryption keys.")),o.a.createElement("p",null,Object(l.b)("Removing inactive sessions improves security and performance, and makes it easier for you to identify if a new session is suspicious.")))}},Wn=e=>{let{variation:t}=e;const{title:a,description:n}=Vn[t];return o.a.createElement(Pn,{title:a,description:n})},zn=e=>{let{device:t,isCurrentDevice:a,onVerifyDevice:n}=e;const i=((e,t)=>{if(e.isVerified){const e=t?Object(l.b)("Your current session is ready for secure messaging."):Object(l.b)("This session is ready for secure messaging.");return{variation:Un.a.Verified,heading:Object(l.b)("Verified session"),description:o.a.createElement(o.a.Fragment,null,e,o.a.createElement(Wn,{variation:Un.a.Verified}))}}if(null===e.isVerified)return{variation:Un.a.Unverified,heading:Object(l.b)("Unverified session"),description:o.a.createElement(o.a.Fragment,null,Object(l.b)("This session doesn't support encryption and thus can't be verified."),o.a.createElement(Wn,{variation:Un.a.Unverifiable}))};const a=t?Object(l.b)("Verify your current session for enhanced secure messaging."):Object(l.b)("Verify or sign out from this session for best security and reliability.");return{variation:Un.a.Unverified,heading:Object(l.b)("Unverified session"),description:o.a.createElement(o.a.Fragment,null,a,o.a.createElement(Wn,{variation:Un.a.Unverified}))}})(t,a);return o.a.createElement(Bn,i,!1===t.isVerified&&!!n&&o.a.createElement(f.a,{kind:"primary",onClick:n,"data-testid":`verification-status-button-${t.device_id}`},Object(l.b)("Verify session")))};function Hn(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Kn(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Hn(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Hn(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var Gn,qn=e=>{let{device:t,pusher:a,localNotificationSettings:n,isSigningOut:i,onVerifyDevice:s,onSignOutDevice:r,saveDeviceName:c,setPushNotifications:d,supportsMSC3881:m,className:h,isCurrentDevice:u}=e;const p=[{id:"session",values:[{label:Object(l.b)("Session ID"),value:t.device_id},{label:Object(l.b)("Last activity"),value:t.last_seen_ts&&Object(In.a)(new Date(t.last_seen_ts))}]},{id:"application",heading:Object(l.b)("Application"),values:[{label:Object(l.b)("Name"),value:t.appName},{label:Object(l.b)("Version"),value:t.appVersion},{label:Object(l.b)("URL"),value:t.url}]},{id:"device",heading:Object(l.b)("Device"),values:[{label:Object(l.b)("Model"),value:t.deviceModel},{label:Object(l.b)("Operating system"),value:t.deviceOperatingSystem},{label:Object(l.b)("Browser"),value:t.client},{label:Object(l.b)("IP address"),value:t.last_seen_ip}]}].map((e=>Kn(Kn({},e),{},{values:e.values.filter((e=>!!e.value))}))).filter((e=>e.values.length)),g=!!a||!!n;return o.a.createElement("div",{className:We()("mx_DeviceDetails",h),"data-testid":`device-detail-${t.device_id}`},o.a.createElement("section",{className:"mx_DeviceDetails_section"},o.a.createElement(Mn,{device:t,saveDeviceName:c}),o.a.createElement(zn,{device:t,onVerifyDevice:s,isCurrentDevice:!0})),o.a.createElement("section",{className:"mx_DeviceDetails_section"},o.a.createElement("p",{className:"mx_DeviceDetails_sectionHeading"},Object(l.b)("Session details")),p.map(((e,t)=>{let{heading:a,values:n,id:i}=e;return o.a.createElement("table",{className:"mx_DeviceDetails_metadataTable",key:t,"data-testid":`device-detail-metadata-${i}`},a&&o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,a))),o.a.createElement("tbody",null,n.map((e=>{let{label:t,value:a}=e;return o.a.createElement("tr",{key:t},o.a.createElement("td",{className:"mxDeviceDetails_metadataLabel"},t),o.a.createElement("td",{className:"mxDeviceDetails_metadataValue"},a))}))))}))),g&&o.a.createElement("section",{className:"mx_DeviceDetails_section mx_DeviceDetails_pushNotifications","data-testid":"device-detail-push-notification"},o.a.createElement(ke.a,{checked:function(e,t){return e?!!e[He.g.name]:!n||!n.is_silenced}(a),disabled:function(e,t){return!n&&!(!e||m)}(a),onChange:e=>null==d?void 0:d(t.device_id,e),title:Object(l.b)("Toggle push notifications on this session."),"data-testid":"device-detail-push-notification-checkbox"}),o.a.createElement("p",{className:"mx_DeviceDetails_sectionHeading"},Object(l.b)("Push notifications"),o.a.createElement("small",{className:"mx_DeviceDetails_sectionSubheading"},Object(l.b)("Receive push notifications on this session.")))),o.a.createElement("section",{className:"mx_DeviceDetails_section"},o.a.createElement(f.a,{onClick:r,kind:"danger_inline",disabled:i,"data-testid":"device-detail-sign-out-cta"},o.a.createElement("span",{className:"mx_DeviceDetails_signOutButtonContent"},Object(l.b)("Sign out of this session"),i&&o.a.createElement(k.a,{w:16,h:16})))))};function $n(){return $n=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},$n.apply(this,arguments)}function Yn(e){return s.createElement("svg",$n({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 10 6",role:"presentation","aria-hidden":!0},e),Gn||(Gn=s.createElement("g",{fill:"none",fillRule:"evenodd",stroke:"currentColor",strokeLinecap:"round",strokeWidth:1.3},s.createElement("path",{d:"M1.5 1.5l3.859 3.254M9.132 1.56L5.359 4.754"}))))}var Jn=a(151);const Qn=["isExpanded","onClick"],Xn=e=>{let{isExpanded:t,onClick:a}=e,n=$a()(e,Qn);const i=t?Object(l.b)("Hide details"):Object(l.b)("Show details");return o.a.createElement(Jn.a,On()({},n,{"aria-label":i,title:i,kind:"icon",className:We()("mx_DeviceExpandDetailsButton",{mx_DeviceExpandDetailsButton_expanded:t}),onClick:a}),o.a.createElement(Yn,{className:"mx_DeviceExpandDetailsButton_icon"}))};var Zn=a(665),ei=a(164),ti=a(251);const ai=["selectedDeviceCount","isAllSelected","toggleSelectAll","children"];var ni=e=>{let{selectedDeviceCount:t,isAllSelected:a,toggleSelectAll:n,children:i}=e,s=$a()(e,ai);const r=a?Object(l.b)("Deselect all"):Object(l.b)("Select all");return o.a.createElement("div",On()({className:"mx_FilteredDeviceListHeader"},s),o.a.createElement(ti.a,{label:r,alignment:ei.a.Top},o.a.createElement(D.b,{kind:D.a.Solid,checked:a,onChange:n,id:"device-select-all-checkbox","data-testid":"device-select-all-checkbox","aria-label":r})),o.a.createElement("span",{className:"mx_FilteredDeviceListHeader_label"},t>0?Object(l.b)("%(count)s sessions selected",{count:t}):Object(l.b)("Sessions")),i)};const ii=(e,t)=>t.includes(e),si=(e,t)=>(t.last_seen_ts||0)-(e.last_seen_ts||0)||(e.display_name||e.device_id).localeCompare(t.display_name||t.device_id),oi="ALL",ri={[Un.a.Verified]:{title:Object(l.b)("Verified sessions"),description:Object(l.b)("For best security, sign out from any session that you don't recognize or use anymore.")},[Un.a.Unverified]:{title:Object(l.b)("Unverified sessions"),description:Object(l.b)("Verify your sessions for enhanced secure messaging or sign out from those you don't recognize or use anymore.")},[Un.a.Unverifiable]:{title:Object(l.b)("Unverified session"),description:Object(l.b)("This session doesn't support encryption and thus can't be verified.")},[Un.a.Inactive]:{title:Object(l.b)("Inactive sessions"),description:Object(l.b)("Consider signing out from old sessions (%(inactiveAgeDays)s days or older) you don't use anymore.",{inactiveAgeDays:Zn.a})}},li=e=>{let{filter:t}=e;if((e=>!!e&&[Un.a.Inactive,Un.a.Unverified,Un.a.Verified].includes(e))(t)){const{title:e,description:a}=ri[t];return o.a.createElement("div",{className:"mx_FilteredDeviceList_securityCard"},o.a.createElement(Bn,{variation:t,heading:e,description:o.a.createElement("span",null,a,o.a.createElement(Wn,{variation:t}))}))}return null},ci=e=>{let{filter:t,clearFilter:a}=e;return o.a.createElement("div",{className:"mx_FilteredDeviceList_noResults"},(e=>{switch(e){case Un.a.Verified:return Object(l.b)("No verified sessions found.");case Un.a.Unverified:return Object(l.b)("No unverified sessions found.");case Un.a.Inactive:return Object(l.b)("No inactive sessions found.");default:return Object(l.b)("No sessions found.")}})(t),!!t&&o.a.createElement(o.a.Fragment,null," ",o.a.createElement(f.a,{kind:"link_inline",onClick:a,"data-testid":"devices-clear-filter-btn"},Object(l.b)("Show all"))))},di=e=>{let{device:t,pusher:a,localNotificationSettings:n,isExpanded:i,isSigningOut:s,isSelected:r,onDeviceExpandToggle:l,onSignOutDevice:c,saveDeviceName:d,onRequestDeviceVerification:m,setPushNotifications:h,toggleSelected:u,supportsMSC3881:p}=e;return o.a.createElement("li",{className:"mx_FilteredDeviceList_listItem"},o.a.createElement(Yt,{isSelected:r,onSelect:u,onClick:l,device:t},s&&o.a.createElement(k.a,{w:16,h:16}),o.a.createElement(Xn,{isExpanded:i,onClick:l})),i&&o.a.createElement(qn,{device:t,pusher:a,localNotificationSettings:n,isSigningOut:s,onVerifyDevice:m,onSignOutDevice:c,saveDeviceName:d,setPushNotifications:h,supportsMSC3881:p,className:"mx_FilteredDeviceList_deviceDetails"}))},mi=Object(s.forwardRef)(((e,t)=>{let{devices:a,pushers:n,localNotificationSettings:i,filter:s,expandedDeviceIds:r,signingOutDeviceIds:c,selectedDeviceIds:d,onFilterChange:m,onDeviceExpandToggle:h,saveDeviceName:u,onSignOutDevices:p,onRequestDeviceVerification:g,setPushNotifications:b,setSelectedDeviceIds:v,supportsMSC3881:E}=e;const y=((e,t)=>Object(Zn.b)(Object.values(e),t?[t]:[]).sort(si))(a,s);function _(e){return n.find((t=>t[He.f.name]===e.device_id))}const S=[{id:oi,label:Object(l.b)("All")},{id:Un.a.Verified,label:Object(l.b)("Verified"),description:Object(l.b)("Ready for secure messaging")},{id:Un.a.Unverified,label:Object(l.b)("Unverified"),description:Object(l.b)("Not ready for secure messaging")},{id:Un.a.Inactive,label:Object(l.b)("Inactive"),description:Object(l.b)("Inactive for %(inactiveAgeDays)s days or longer",{inactiveAgeDays:Zn.a})}],w=d.length>=y.length,O=!!c.length;return o.a.createElement("div",{className:"mx_FilteredDeviceList",ref:t},o.a.createElement(ni,{selectedDeviceCount:d.length,isAllSelected:w,toggleSelectAll:()=>{v(w?[]:y.map((e=>e.device_id)))}},d.length?o.a.createElement(o.a.Fragment,null,o.a.createElement(f.a,{"data-testid":"sign-out-selection-cta",kind:"danger_inline",disabled:O,onClick:()=>p(d),className:"mx_FilteredDeviceList_headerButton"},O&&o.a.createElement(k.a,{w:16,h:16}),Object(l.b)("Sign out")),o.a.createElement(f.a,{"data-testid":"cancel-selection-cta",kind:"content_inline",disabled:O,onClick:()=>v([]),className:"mx_FilteredDeviceList_headerButton"},Object(l.b)("Cancel"))):o.a.createElement(Rn,{id:"device-list-filter",label:Object(l.b)("Filter devices"),value:s||oi,onOptionChange:e=>{m(e===oi?void 0:e)},options:S,selectedLabel:Object(l.b)("Show")})),y.length?o.a.createElement(li,{filter:s}):o.a.createElement(ci,{filter:s,clearFilter:()=>m(void 0)}),o.a.createElement("ol",{className:"mx_FilteredDeviceList_list"},y.map((e=>o.a.createElement(di,{key:e.device_id,device:e,pusher:_(e),localNotificationSettings:i.get(e.device_id),isExpanded:r.includes(e.device_id),isSigningOut:c.includes(e.device_id),isSelected:ii(e.device_id,d),onDeviceExpandToggle:()=>h(e.device_id),onSignOutDevice:()=>p([e.device_id]),saveDeviceName:t=>u(e.device_id,t),onRequestDeviceVerification:g?()=>g(e.device_id):void 0,setPushNotifications:b,toggleSelected:()=>{return t=e.device_id,void(ii(t,d)?v(d.filter((e=>e!==t))):v([...d,t]));var t},supportsMSC3881:E})))))}));var hi=a(660),ui=a(667),pi=a(152),gi=a(178);const bi=["options","title"],vi=e=>{let{options:t,title:a}=e,n=$a()(e,bi);const[i,s,r,l]=Object(pi.q)();return o.a.createElement(o.a.Fragment,null,o.a.createElement(pi.b,On()({},n,{onClick:r,title:a,isExpanded:i,inputRef:s}),o.a.createElement(ui.a,{className:"mx_KebabContextMenu_icon"})),i&&o.a.createElement(gi.e,On()({onFinished:l,compact:!0,rightAligned:!0,closeOnInteraction:!0},{left:(c=s.current.getBoundingClientRect()).left+window.scrollX+c.width,top:c.bottom+window.scrollY,chevronFace:pi.a.None}),o.a.createElement(gi.c,null,t)));var c},fi=e=>{let{onSignOutCurrentDevice:t,signOutAllOtherSessions:a,otherSessionsCount:n,disabled:i}=e;const s=[o.a.createElement(gi.b,{key:"sign-out",label:Object(l.b)("Sign out"),onClick:t,isDestructive:!0}),...a?[o.a.createElement(gi.b,{key:"sign-out-all-others",label:Object(l.b)("Sign out of all other sessions (%(otherSessionsCount)s)",{otherSessionsCount:n}),onClick:a,isDestructive:!0})]:[]];return o.a.createElement(hi.a,{heading:Object(l.b)("Current session")},o.a.createElement(vi,{disabled:i,title:Object(l.b)("Options"),options:s,"data-testid":"current-session-menu"}))};var Ei=e=>{let{device:t,isLoading:a,isSigningOut:n,localNotificationSettings:i,otherSessionsCount:r,setPushNotifications:l,onVerifyCurrentDevice:c,onSignOutCurrentDevice:d,signOutAllOtherSessions:m,saveDeviceName:h}=e;const[u,p]=Object(s.useState)(!1);return o.a.createElement(pa.a,{"data-testid":"current-session-section",heading:o.a.createElement(fi,{onSignOutCurrentDevice:d,signOutAllOtherSessions:m,otherSessionsCount:r,disabled:a||!t||n})},a&&!t&&o.a.createElement(k.a,null),!!t&&o.a.createElement(o.a.Fragment,null,o.a.createElement($t,{device:t,onClick:()=>p(!u)},o.a.createElement(Xn,{"data-testid":"current-session-toggle-details",isExpanded:u,onClick:()=>p(!u)})),u?o.a.createElement(qn,{device:t,localNotificationSettings:i,setPushNotifications:l,isSigningOut:n,onVerifyDevice:c,onSignOutDevice:d,saveDeviceName:h,className:"mx_CurrentDeviceSection_deviceDetails"}):o.a.createElement(o.a.Fragment,null,o.a.createElement("br",null),o.a.createElement(zn,{device:t,onVerifyDevice:c,isCurrentDevice:!0}))))};var yi=e=>{let{devices:t,currentDeviceId:a,goToFilteredList:n}=e;const i=Object.values(t),s=Object(Zn.b)(i,[Un.a.Unverified]).filter((e=>e.device_id!==a)).length,r=Object(Zn.b)(i,[Un.a.Inactive]).length;if(!(s|r))return null;const c=Zn.a;return o.a.createElement(pa.a,{heading:Object(l.b)("Security recommendations"),description:Object(l.b)("Improve your account security by following these recommendations."),"data-testid":"security-recommendations-section"},!!s&&o.a.createElement(Bn,{variation:Un.a.Unverified,heading:Object(l.b)("Unverified sessions"),description:o.a.createElement(o.a.Fragment,null,Object(l.b)("Verify your sessions for enhanced secure messaging or sign out from those you don't recognize or use anymore."),o.a.createElement(Wn,{variation:Un.a.Unverified}))},o.a.createElement(f.a,{kind:"link_inline",onClick:()=>n(Un.a.Unverified),"data-testid":"unverified-devices-cta"},Object(l.b)("View all")+` (${s})`)),!!r&&o.a.createElement(o.a.Fragment,null,!!s&&o.a.createElement("div",{className:"mx_SecurityRecommendations_spacing"}),o.a.createElement(Bn,{variation:Un.a.Inactive,heading:Object(l.b)("Inactive sessions"),description:o.a.createElement(o.a.Fragment,null,Object(l.b)("Consider signing out from old sessions (%(inactiveAgeDays)s days or older) you don't use anymore.",{inactiveAgeDays:c}),o.a.createElement(Wn,{variation:Un.a.Inactive}))},o.a.createElement(f.a,{kind:"link_inline",onClick:()=>n(Un.a.Inactive),"data-testid":"inactive-devices-cta"},Object(l.b)("View all")+` (${r})`))))},_i=a(936),Si=a(256);const wi=e=>{let{otherSessionsCount:t,disabled:a,signOutAllOtherSessions:n}=e;const i=[o.a.createElement(gi.b,{key:"sign-out-all-others",label:Object(l.b)("Sign out of %(count)s sessions",{count:t}),onClick:n,isDestructive:!0})];return o.a.createElement(hi.a,{heading:Object(l.b)("Other sessions")},o.a.createElement(vi,{disabled:a,title:Object(l.b)("Options"),options:i,"data-testid":"other-sessions-menu"}))};function Oi(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var n=a.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}const Ci=(e,t)=>{const[a,n]=Object(s.useState)([]);return{onSignOutCurrentDevice:()=>{g.b.createDialog(kt.a,{},void 0,!1,!0)},onSignOutOtherDevices:async i=>{if(!i.length)return;if(await(async e=>{const{finished:t}=g.b.createDialog(le.a,{title:Object(l.b)("Sign out"),description:o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("Are you sure you want to sign out of %(count)s sessions?",{count:e}))),cancelButton:Object(l.b)("Cancel"),button:Object(l.b)("Sign out")}),[a]=await t;return!!a})(i.length))try{n([...a,...i]),await ea(e,i,(async e=>{e&&await t(),n(a.filter((e=>!i.includes(e))))}))}catch(e){d.a.error("Error deleting sessions",e),n(a.filter((e=>!i.includes(e))))}},signingOutDeviceIds:a}};var xi=()=>{const{devices:e,pushers:t,localNotificationSettings:a,currentDeviceId:n,isLoadingDeviceList:i,requestDeviceVerification:r,refreshDevices:c,saveDeviceName:d,setPushNotifications:m,supportsMSC3881:h}=_n(),[u,p]=Object(s.useState)(),[b,v]=Object(s.useState)([]),[f,E]=Object(s.useState)([]),y=Object(s.useRef)(null),_=Object(s.useRef)(),S=Object(s.useContext)(ta.a),w=null==S?void 0:S.getUserId(),O=w&&(null==S?void 0:S.getUser(w))||void 0,C=Object(Si.a)((()=>S.getVersions()),[S]),x=Object(Si.a)((async()=>null==S?void 0:S.getCapabilities()),[S]),{[n]:j}=e,k=$a()(e,[n].map(Oi)),R=Object.keys(k).length,I=R>0,T=Object(s.useCallback)((e=>{if(!r)return;const t=r(e);g.b.createDialog(jt.a,{verificationRequestPromise:t,member:O,onFinished:async()=>{(await t).cancel(),await c()}})}),[r,c,O]),{onSignOutCurrentDevice:N,onSignOutOtherDevices:P,signingOutDeviceIds:D}=Ci(S,(async()=>{await c(),E([])}));Object(s.useEffect)((()=>()=>{clearTimeout(_.current)}),[_]),Object(s.useEffect)((()=>{E([])}),[u,E]);const M=I?()=>{P(Object.keys(k))}:void 0,[A,U]=Object(s.useState)(),L=Object(s.useCallback)((()=>{U(null)}),[U]),F=Object(s.useCallback)((()=>{U(ua.b.Show)}),[U]);return A?o.a.createElement(ua.d,{mode:A,onFinished:L,client:S}):o.a.createElement(_i.a,{heading:Object(l.b)("Sessions")},o.a.createElement(yi,{devices:e,goToFilteredList:e=>{p(e),clearTimeout(_.current),_.current=window.setTimeout((()=>{var e;return null===(e=y.current)||void 0===e?void 0:e.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}))},currentDeviceId:n}),o.a.createElement(Ei,{device:j,localNotificationSettings:a.get(n),setPushNotifications:m,isSigningOut:D.includes(n),isLoading:i,saveDeviceName:e=>d(n,e),onVerifyCurrentDevice:()=>{g.b.createDialog(xt.a,{onFinished:c})},onSignOutCurrentDevice:N,signOutAllOtherSessions:M,otherSessionsCount:R}),I&&o.a.createElement(pa.a,{heading:o.a.createElement(wi,{otherSessionsCount:R,signOutAllOtherSessions:M,disabled:!!D.length}),description:Object(l.b)("For best security, verify your sessions and sign out from any session that you don't recognize or use anymore."),"data-testid":"other-sessions-section"},o.a.createElement(mi,{devices:k,pushers:t,localNotificationSettings:a,filter:u,expandedDeviceIds:b,signingOutDeviceIds:D,selectedDeviceIds:f,setSelectedDeviceIds:E,onFilterChange:p,onDeviceExpandToggle:e=>{b.includes(e)?v(b.filter((t=>t!==e))):v([...b,e])},onRequestDeviceVerification:r?T:void 0,onSignOutDevices:P,saveDeviceName:d,setPushNotifications:m,ref:y,supportsMSC3881:h})),o.a.createElement(ga,{onShowQr:F,versions:C,capabilities:x}))};class ji extends o.a.Component{constructor(e){super(e),i()(this,"settingsWatchers",[]),i()(this,"mjolnirChanged",((e,t,a,n)=>{this.setState({mjolnirEnabled:n})})),i()(this,"sessionManagerChanged",((e,t,a,n)=>{this.setState({newSessionManagerEnabled:n})})),this.state={mjolnirEnabled:O.b.getValue("feature_mjolnir"),newSessionManagerEnabled:O.b.getValue("feature_new_device_manager")}}componentDidMount(){this.settingsWatchers=[O.b.watchSetting("feature_mjolnir",null,this.mjolnirChanged),O.b.watchSetting("feature_new_device_manager",null,this.sessionManagerChanged)]}componentWillUnmount(){this.settingsWatchers.forEach((e=>O.b.unwatchSetting(e)))}getTabs(){const e=[];return e.push(new r.a(Ba.a.General,Object(l.d)("General"),"mx_UserSettingsDialog_settingsIcon",o.a.createElement(Pe,{closeSettingsFn:this.props.onFinished}),"UserSettingsGeneral")),e.push(new r.a(Ba.a.Appearance,Object(l.d)("Appearance"),"mx_UserSettingsDialog_appearanceIcon",o.a.createElement(ut,null),"UserSettingsAppearance")),e.push(new r.a(Ba.a.Notifications,Object(l.d)("Notifications"),"mx_UserSettingsDialog_bellIcon",o.a.createElement(Fa,null),"UserSettingsNotifications")),e.push(new r.a(Ba.a.Preferences,Object(l.d)("Preferences"),"mx_UserSettingsDialog_preferencesIcon",o.a.createElement(Wa,{closeSettingsFn:this.props.onFinished}),"UserSettingsPreferences")),e.push(new r.a(Ba.a.Keyboard,Object(l.d)("Keyboard"),"mx_UserSettingsDialog_keyboardIcon",o.a.createElement(pn,null),"UserSettingsKeyboard")),e.push(new r.a(Ba.a.Sidebar,Object(l.d)("Sidebar"),"mx_UserSettingsDialog_sidebarIcon",o.a.createElement(ln.a,null),"UserSettingsSidebar")),O.b.getValue(H.b.Voip)&&e.push(new r.a(Ba.a.Voice,Object(l.d)("Voice & Video"),"mx_UserSettingsDialog_voiceIcon",o.a.createElement(Ka,null),"UserSettingsVoiceVideo")),e.push(new r.a(Ba.a.Security,Object(l.d)("Security & Privacy"),"mx_UserSettingsDialog_securityIcon",o.a.createElement(va,{closeSettingsFn:this.props.onFinished}),"UserSettingsSecurityPrivacy")),this.state.newSessionManagerEnabled&&e.push(new r.a(Ba.a.SessionManager,Object(l.d)("Sessions"),"mx_UserSettingsDialog_sessionsIcon",o.a.createElement(xi,null),void 0)),(Me.b.get("show_labs_settings")||O.b.getFeatureSettingNames().some((e=>O.b.getBetaInfo(e))))&&e.push(new r.a(Ba.a.Labs,Object(l.d)("Labs"),"mx_UserSettingsDialog_labsIcon",o.a.createElement(Be,null),"UserSettingsLabs")),this.state.mjolnirEnabled&&e.push(new r.a(Ba.a.Mjolnir,Object(l.d)("Ignored users"),"mx_UserSettingsDialog_mjolnirIcon",o.a.createElement(rn,null),"UserSettingMjolnir")),e.push(new r.a(Ba.a.Help,Object(l.d)("Help & About"),"mx_UserSettingsDialog_helpIcon",o.a.createElement(nn,{closeSettingsFn:()=>this.props.onFinished()}),"UserSettingsHelpAbout")),e}render(){return o.a.createElement(M.a,{className:"mx_UserSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.b)("Settings")},o.a.createElement("div",{className:"mx_SettingsDialog_content"},o.a.createElement(r.c,{tabs:this.getTabs(),initialTabId:this.props.initialTabId,screenName:"UserSettings"})))}}},1743:function(e,t,a){"use strict";a.d(t,"a",(function(){return q}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(1),l=a(136),c=a(16),d=a(121),m=a(129);class h{constructor(e,t){i()(this,"client",void 0),i()(this,"clientSecret",void 0),i()(this,"password",""),i()(this,"sessionId",""),i()(this,"logoutDevices",!1),i()(this,"sendAttempt",0),this.client=Object(l.createClient)({baseUrl:e,idBaseUrl:t}),this.clientSecret=this.client.generateClientSecret()}async resetPassword(e,t){let a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.password=t,this.logoutDevices=a,this.sendAttempt++;try{const t=await this.client.requestPasswordEmailToken(e,this.clientSecret,this.sendAttempt);return this.sessionId=t.sid,t}catch(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=Object(d.b)("This email address was not found"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}}requestResetToken(e){return this.sendAttempt++,this.client.requestPasswordEmailToken(e,this.clientSecret,this.sendAttempt).then((e=>(this.sessionId=e.sid,e)),(function(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=Object(d.b)("This email address was not found"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}setLogoutDevices(e){this.logoutDevices=e}async setNewPassword(e){this.password=e,await this.checkEmailLinkClicked()}async checkEmailLinkClicked(){const e={sid:this.sessionId,client_secret:this.clientSecret};try{await this.client.setPassword({type:"m.login.email.identity",threepid_creds:e,threepidCreds:e},this.password,this.logoutDevices)}catch(e){throw 401===e.httpStatus?e.message=Object(d.b)("Failed to verify email address: make sure you clicked the link in the email"):404===e.httpStatus?e.message=Object(d.b)("Your email address does not appear to be associated with a Matrix ID on this homeserver."):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}}var u,p=a(329),g=a(362),b=a(700),v=a(519),f=a(501),E=a(989),y=a(182);function _(){return _=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},_.apply(this,arguments)}function S(e){return s.createElement("svg",_({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",role:"presentation","aria-hidden":!0},e),u||(u=s.createElement("path",{d:"M5.092 17.049l6.515 6.709L26.91 8",stroke:"currentColor",strokeWidth:2.5,strokeLinecap:"round",strokeLinejoin:"round"})))}var w;function O(){return O=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},O.apply(this,arguments)}function C(e){return s.createElement("svg",O({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",role:"presentation","aria-hidden":!0},e),w||(w=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M13.333 1.852a5.5 5.5 0 00-5.5 5.5v5.822H7a3 3 0 00-3 3v11.493a3 3 0 003 3h18a3 3 0 003-3V16.174a3 3 0 00-3-3h-.833V7.352a5.5 5.5 0 00-5.5-5.5h-5.334zm7.834 11.322V7.352a2.5 2.5 0 00-2.5-2.5h-5.334a2.5 2.5 0 00-2.5 2.5v5.822h10.334z",fill:"currentColor"})))}var x,j=a(159);function k(){return k=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},k.apply(this,arguments)}function R(e){return s.createElement("svg",k({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 40 29",role:"presentation","aria-hidden":!0},e),x||(x=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M.261 2.576L18.905 21.16a1.64 1.64 0 002.316 0L39.773 2.668C39.92 3.084 40 3.533 40 4v21a4 4 0 01-4 4H4a4 4 0 01-4-4V4c0-.502.092-.982.261-1.424zM2.582.259C3.022.09 3.501 0 4 0h32c.533 0 1.042.104 1.508.294l-17.445 17.39L2.583.26z",fill:"#757575"})))}var I=a(500),T=a(637);const N=e=>{let{message:t}=e;const a=t?o.a.createElement(T.a,{className:"mx_Icon mx_Icon_16"}):null;return o.a.createElement("div",{className:"mx_ErrorMessage"},a,t)};var P=a(135),D=a(124);const M=e=>{let{email:t,errorText:a,homeserver:n,loading:i,onInputChanged:r,onLoginClick:l,onSubmitForm:c}=e;const m=i?o.a.createElement(P.a,{w:16,h:16}):Object(d.b)("Send email"),h=Object(s.useRef)(null);return o.a.createElement(o.a.Fragment,null,o.a.createElement(R,{className:"mx_AuthBody_icon"}),o.a.createElement("h1",null,Object(d.b)("Enter your email to reset password")),o.a.createElement("p",{className:"mx_AuthBody_text"},Object(d.b)("<b>%(homeserver)s</b> will send you a verification link to let you reset your password.",{homeserver:n},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("form",{onSubmit:async e=>{var t,a,n;await(null===(t=h.current)||void 0===t?void 0:t.validate({allowEmpty:!1}))?c(e):(null===(a=h.current)||void 0===a||a.focus(),null===(n=h.current)||void 0===n||n.validate({allowEmpty:!1,focused:!0}))}},o.a.createElement("fieldset",{disabled:i},o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},o.a.createElement(I.a,{name:"reset_email",label:"Email address",labelRequired:Object(d.d)("The email address linked to your account must be entered."),labelInvalid:Object(d.d)("The email address doesn't appear to be valid."),value:t,autoFocus:!0,onChange:e=>r("email",e),fieldRef:h})),a&&o.a.createElement(N,{message:a}),o.a.createElement("button",{type:"submit",className:"mx_Login_submit"},m),o.a.createElement("div",{className:"mx_AuthBody_button-container"},o.a.createElement(D.a,{className:"mx_AuthBody_sign-in-instead-button",element:"button",kind:"link",onClick:e=>{e.preventDefault(),l()}},Object(d.b)("Sign in instead"))))))};var A,U=a(549);function L(){return L=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},L.apply(this,arguments)}function F(e){return s.createElement("svg",L({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0},e),A||(A=s.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M4.023 2.965a6.418 6.418 0 0110.36 4.369h1.29c.26 0 .416.291.271.509l-2.005 3.011a.327.327 0 01-.544 0l-2.006-3.011a.327.327 0 01.272-.51h1.21a4.918 4.918 0 00-7.918-3.192 3.673 3.673 0 01-.184.136l-.014.01-.004.003-.002.001h-.001v.001l-.415-.625.414.625a.75.75 0 01-.83-1.25l.003-.001.02-.014.083-.062zm-.895 5.702H4.34a.327.327 0 00.272-.51L2.606 5.147a.327.327 0 00-.545 0L.055 8.158c-.144.217.011.509.273.509h1.29a6.417 6.417 0 0010.503 4.251.75.75 0 00-.963-1.149 4.918 4.918 0 01-8.03-3.102z",fill:"currentColor"})))}var B=a(164);const V=(e,t)=>{const a=Object(s.useRef)(),[n,i]=Object(s.useState)(e);return Object(s.useEffect)((()=>()=>{clearTimeout(a.current)})),{toggle:()=>{i(!e),a.current=window.setTimeout((()=>i(e)),t)},value:n}},W=e=>{let{email:t,errorText:a,onReEnterEmailClick:n,onSubmitForm:i,onResendClick:s}=e;const{toggle:r,value:l}=V(!1,2500);return o.a.createElement(o.a.Fragment,null,o.a.createElement(U.a,{className:"mx_AuthBody_emailPromptIcon--shifted"}),o.a.createElement("h1",null,Object(d.b)("Check your email to continue")),o.a.createElement("div",{className:"mx_AuthBody_text"},o.a.createElement("p",null,Object(d.b)("Follow the instructions sent to <b>%(email)s</b>",{email:t},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.a.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},Object(d.b)("Wrong email address?")),o.a.createElement(D.a,{className:"mx_AuthBody_resend-button",kind:"link",onClick:n},Object(d.b)("Re-enter email address")))),a&&o.a.createElement(N,{message:a}),o.a.createElement("input",{onClick:i,type:"button",className:"mx_Login_submit",value:Object(d.b)("Next")}),o.a.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.a.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},Object(d.b)("Did not receive it?")),o.a.createElement(D.a,{className:"mx_AuthBody_resend-button",kind:"link",onClick:async()=>{await s(),r()}},o.a.createElement(F,{className:"mx_Icon mx_Icon_16"}),Object(d.b)("Resend"),o.a.createElement(B.b,{label:Object(d.b)("Verification link email resent!"),alignment:B.a.Top,visible:l}))))},z=e=>{let{email:t,errorText:a,onCloseClick:n,onReEnterEmailClick:i,onResendClick:s}=e;const{toggle:r,value:l}=V(!1,2500);return o.a.createElement(o.a.Fragment,null,o.a.createElement(U.a,{className:"mx_AuthBody_emailPromptIcon"}),o.a.createElement("h1",null,Object(d.b)("Verify your email to continue")),o.a.createElement("p",null,Object(d.b)("We need to know it’s you before resetting your password. Click the link in the email we just sent to <b>%(email)s</b>",{email:t},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.a.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},Object(d.b)("Did not receive it?")),o.a.createElement(D.a,{className:"mx_AuthBody_resend-button",kind:"link",onClick:async()=>{await s(),r()}},o.a.createElement(F,{className:"mx_Icon mx_Icon_16"}),Object(d.b)("Resend"),o.a.createElement(B.b,{label:Object(d.b)("Verification link email resent!"),alignment:B.a.Top,visible:l})),a&&o.a.createElement(N,{message:a})),o.a.createElement("div",{className:"mx_AuthBody_did-not-receive"},o.a.createElement("span",{className:"mx_VerifyEMailDialog_text-light"},Object(d.b)("Wrong email address?")),o.a.createElement(D.a,{className:"mx_AuthBody_resend-button",kind:"link",onClick:i},Object(d.b)("Re-enter email address"))),o.a.createElement(D.a,{onClick:n,className:"mx_Dialog_cancelButton","aria-label":Object(d.b)("Close dialog")}))};var H=a(165),K=a(359);var G=function(e){return e[e.EnterEmail=1]="EnterEmail",e[e.SendingEmail=2]="SendingEmail",e[e.EmailSent=3]="EmailSent",e[e.PasswordInput=4]="PasswordInput",e[e.ResettingPassword=5]="ResettingPassword",e[e.Done=6]="Done",e}(G||{});class q extends o.a.Component{constructor(e){super(e),i()(this,"reset",void 0),i()(this,"fieldPassword",null),i()(this,"fieldPasswordConfirm",null),i()(this,"sendVerificationMail",(async()=>{try{return await this.reset.requestResetToken(this.state.email),!0}catch(e){this.handleError(e)}return!1})),i()(this,"onSubmitForm",(async e=>{if(e.preventDefault(),![G.SendingEmail,G.ResettingPassword].includes(this.state.phase)&&(this.setState({errorText:""}),await this.checkServerLiveliness(this.props.serverConfig),this.state.serverIsAlive))switch(this.state.phase){case G.EnterEmail:this.onPhaseEmailInputSubmit();break;case G.EmailSent:this.onPhaseEmailSentSubmit();break;case G.PasswordInput:this.onPhasePasswordInputSubmit()}})),i()(this,"onInputChanged",((e,t)=>{let a=t.currentTarget.value;"email"===e&&(a=a.trim()),this.setState({[e]:a})})),this.state={phase:G.EnterEmail,email:"",password:"",password2:"",errorText:null,serverIsAlive:!0,serverDeadError:"",serverSupportsControlOfDevicesLogout:!1,logoutDevices:!1},this.reset=new h(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl)}componentDidMount(){this.checkServerCapabilities(this.props.serverConfig)}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||(this.checkServerLiveliness(this.props.serverConfig),this.checkServerCapabilities(this.props.serverConfig))}async checkServerLiveliness(e){try{await K.a.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.setState({serverIsAlive:!0})}catch(e){const{serverIsAlive:t,serverDeadError:a}=K.a.authComponentStateForError(e,"forgot_password");this.setState({serverIsAlive:t,errorText:a})}}async checkServerCapabilities(e){const t=Object(l.createClient)({baseUrl:e.hsUrl}),a=await t.doesServerSupportLogoutDevices();this.setState({logoutDevices:!a,serverSupportsControlOfDevicesLogout:a})}async onPhaseEmailInputSubmit(){this.phase=G.SendingEmail,await this.sendVerificationMail()?this.phase=G.EmailSent:this.phase=G.EnterEmail}handleError(e){if(429!==(null==e?void 0:e.httpStatus))"ConnectionError"!==(null==e?void 0:e.name)?this.setState({errorText:e.message}):this.setState({errorText:Object(d.b)("Cannot reach homeserver")+": "+Object(d.b)("Ensure you have a stable internet connection, or get in touch with the server admin")});else{var t;const a=parseInt(null==e||null===(t=e.data)||void 0===t?void 0:t.retry_after_ms,10),n=isNaN(a)?Object(d.b)("Too many attempts in a short time. Wait some time before trying again."):Object(d.b)("Too many attempts in a short time. Retry after %(timeout)s.",{timeout:Object(H.m)(a/1e3)});this.setState({errorText:n})}}async onPhaseEmailSentSubmit(){this.setState({phase:G.PasswordInput})}set phase(e){this.setState({phase:e})}async verifyFieldsBeforeSubmit(){const e=[this.fieldPassword,this.fieldPasswordConfirm],t=[];for(const a of e){if(!a)continue;await a.validate({allowEmpty:!1})||t.push(a)}return 0===t.length||(t[0].focus(),t[0].validate({allowEmpty:!1,focused:!0}),!1)}async onPhasePasswordInputSubmit(){if(!await this.verifyFieldsBeforeSubmit())return;if(this.state.logoutDevices){if(!await this.renderConfirmLogoutDevicesDialog())return}this.phase=G.ResettingPassword,this.reset.setLogoutDevices(this.state.logoutDevices);try{return await this.reset.setNewPassword(this.state.password),void this.setState({phase:G.Done})}catch(e){if(401!==e.httpStatus)return void this.handleError(e)}const e=m.b.createDialog(z,{email:this.state.email,errorText:this.state.errorText,onCloseClick:()=>{e.close(),this.setState({phase:G.PasswordInput})},onReEnterEmailClick:()=>{e.close(),this.setState({phase:G.EnterEmail})},onResendClick:this.sendVerificationMail},"mx_VerifyEMailDialog",!1,!1,{onBeforeClose:async e=>("backgroundClick"===e&&this.setState({phase:G.PasswordInput}),!0)});for(;this.state.phase===G.ResettingPassword;)try{await this.reset.setNewPassword(this.state.password),this.setState({phase:G.Done}),e.close()}catch(e){await Object(c.N)(2e3)}}renderEnterEmail(){return o.a.createElement(M,{email:this.state.email,errorText:this.state.errorText,homeserver:this.props.serverConfig.hsName,loading:this.state.phase===G.SendingEmail,onInputChanged:this.onInputChanged,onLoginClick:this.props.onLoginClick,onSubmitForm:this.onSubmitForm})}async renderConfirmLogoutDevicesDialog(){const{finished:e}=m.b.createDialog(j.a,{title:Object(d.b)("Warning!"),description:o.a.createElement("div",null,o.a.createElement("p",null,this.state.serverSupportsControlOfDevicesLogout?Object(d.b)("Signing out your devices will delete the message encryption keys stored on them, making encrypted chat history unreadable."):Object(d.b)("Resetting your password on this homeserver will cause all of your devices to be signed out. This will delete the message encryption keys stored on them, making encrypted chat history unreadable.")),o.a.createElement("p",null,Object(d.b)("If you want to retain access to your chat history in encrypted rooms, set up Key Backup or export your message keys from one of your other devices before proceeding."))),button:Object(d.b)("Continue")}),[t]=await e;return!!t}renderCheckEmail(){return o.a.createElement(W,{email:this.state.email,errorText:this.state.errorText,onReEnterEmailClick:()=>this.setState({phase:G.EnterEmail}),onResendClick:this.sendVerificationMail,onSubmitForm:this.onSubmitForm})}renderSetPassword(){const e=this.state.phase===G.ResettingPassword?o.a.createElement(P.a,{w:16,h:16}):Object(d.b)("Reset password");return o.a.createElement(o.a.Fragment,null,o.a.createElement(C,{className:"mx_AuthBody_lockIcon"}),o.a.createElement("h1",null,Object(d.b)("Reset your password")),o.a.createElement("form",{onSubmit:this.onSubmitForm},o.a.createElement("fieldset",{disabled:this.state.phase===G.ResettingPassword},o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},o.a.createElement(g.a,{name:"reset_password",type:"password",label:Object(d.d)("New Password"),value:this.state.password,minScore:b.a,fieldRef:e=>this.fieldPassword=e,onChange:this.onInputChanged.bind(this,"password"),autoComplete:"new-password"}),o.a.createElement(E.a,{name:"reset_password_confirm",label:Object(d.d)("Confirm new password"),labelRequired:Object(d.d)("A new password must be entered."),labelInvalid:Object(d.d)("New passwords must match each other."),value:this.state.password2,password:this.state.password,fieldRef:e=>this.fieldPasswordConfirm=e,onChange:this.onInputChanged.bind(this,"password2"),autoComplete:"new-password"})),this.state.serverSupportsControlOfDevicesLogout?o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},o.a.createElement(y.b,{onChange:()=>this.setState({logoutDevices:!this.state.logoutDevices}),checked:this.state.logoutDevices},Object(d.b)("Sign out of all devices"))):null,this.state.errorText&&o.a.createElement(N,{message:this.state.errorText}),o.a.createElement("button",{type:"submit",className:"mx_Login_submit"},e))))}renderDone(){return o.a.createElement(o.a.Fragment,null,o.a.createElement(S,{className:"mx_Icon mx_Icon_32 mx_Icon_accent"}),o.a.createElement("h1",null,Object(d.b)("Your password has been reset.")),this.state.logoutDevices?o.a.createElement("p",null,Object(d.b)("You have been logged out of all devices and will no longer receive push notifications. To re-enable notifications, sign in again on each device.")):null,o.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.props.onComplete,value:Object(d.b)("Return to login screen")}))}render(){let e;switch(this.state.phase){case G.EnterEmail:case G.SendingEmail:e=this.renderEnterEmail();break;case G.EmailSent:e=this.renderCheckEmail();break;case G.PasswordInput:case G.ResettingPassword:e=this.renderSetPassword();break;case G.Done:e=this.renderDone();break;default:return r.a.warn(`unknown forgot password phase ${this.state.phase}`),void this.setState({phase:G.EnterEmail})}return o.a.createElement(p.a,null,o.a.createElement(v.a,null),o.a.createElement(f.a,{className:"mx_AuthBody_forgot-password"},e))}}},1744:function(e,t,a){"use strict";a.d(t,"a",(function(){return ze}));var n=a(122),i=a.n(n),s=a(127),o=a.n(s),r=a(125),l=a(129),c=a(424),d=a(134),m=a.n(d),h=a(120),u=a.n(h),p=a(146),g=a(130),b=a(30),v=a(275),f=a(207),E=a(121),y=a(169),_=a(173),S=a(137),w=a(240),O=a(363),C=a(346),x=a(328),j=a(164),k=a(151),R=a(221),I=a(345),T=a(249),N=a(456),P=a(314),D=a(598),M=a(668),A=a(195),U=a(128),L=a(184),F=a(233),B=a(699),V=a(144);const W=["m.relates_to"];function z(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function H(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?z(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):z(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var K=function(e){return e[e.CanSend=0]="CanSend",e[e.Sending=1]="Sending",e[e.Sent=2]="Sent",e[e.Failed=3]="Failed",e}(K||{});const G=e=>{let{room:t,type:a,content:n,matrixClient:i,onFinished:s}=e;const[o,l]=Object(h.useState)(K.CanSend);let c,d,m,p=!1;return o===K.CanSend?(c="mx_ForwardList_canSend",t.maySendMessage()||(p=!0,d=Object(E.b)("You don't have permission to do this"))):o===K.Sending?(c="mx_ForwardList_sending",p=!0,d=Object(E.b)("Sending"),m=u.a.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":d})):o===K.Sent?(c="mx_ForwardList_sent",p=!0,d=Object(E.b)("Sent"),m=u.a.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":d})):(c="mx_ForwardList_sendFailed",p=!0,d=Object(E.b)("Failed to send"),m=u.a.createElement(T.a,{notification:I.a.RED_EXCLAMATION})),u.a.createElement("div",{className:"mx_ForwardList_entry"},u.a.createElement(k.a,{className:"mx_ForwardList_roomButton",onClick:e=>{r.a.dispatch({action:U.a.ViewRoom,room_id:t.roomId,metricsTrigger:"WebForwardShortcut",metricsViaKeyboard:"click"!==e.type}),s(!0)},title:Object(E.b)("Open room"),alignment:j.a.Top},u.a.createElement(x.a,{room:t,avatarSize:32}),u.a.createElement("span",{className:"mx_ForwardList_entry_name"},t.name),u.a.createElement(B.a,{component:"span",className:"mx_ForwardList_entry_detail",room:t})),u.a.createElement(k.a,{kind:o===K.Failed?"danger_outline":"primary_outline",className:`mx_ForwardList_sendButton ${c}`,onClick:async()=>{l(K.Sending);try{await i.sendEvent(t.roomId,a,n),l(K.Sent)}catch(e){l(K.Failed)}},disabled:p,title:d,alignment:j.a.Top},u.a.createElement("div",{className:"mx_ForwardList_sendLabel"},Object(E.b)("Send")),m))};var q=e=>{let{matrixClient:t,event:n,permalinkCreator:i,onFinished:s}=e;const r=t.getSafeUserId(),[l,c]=Object(h.useState)({});Object(h.useEffect)((()=>{t.getProfileInfo(r).then((e=>c(e)))}),[t,r]);const{type:d,content:x}=(e=>{const t=e.getContent(),{"m.relates_to":a}=t,n=m()(t,W),i=f.a.matches(e.getType())?g.b.RoomMessage:e.getType();if(Object(L.l)(e)&&Object(F.f)(n)||f.a.matches(e.getType())){const t=b.d.findIn(n),a=Object(F.g)(e);return{type:i,content:H(H({},n),Object(v.makeLocationContent)(void 0,a,t||Date.now(),void 0,b.a.Pin))}}return{type:i,content:n}})(n),j=new p.b({type:"m.room.message",sender:r,content:x,unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:n.getRoomId()});j.sender={name:l.displayname||r,rawDisplayName:l.displayname,userId:r,getAvatarUrl:function(){return Object(w.c)({avatarUrl:l.avatar_url},30,30,"crop")},getMxcAvatarUrl:()=>l.avatar_url};const[k,I]=Object(h.useState)(""),T=k.toLowerCase(),U=Object(y.b)("layout"),B=Object(y.b)("feature_dynamic_room_predecessors");let z=Object(h.useMemo)((()=>Object(N.b)(t.getVisibleRooms(B).filter((e=>"join"===e.getMyMembership()&&!e.isSpaceRoom())))),[t,B]);T&&(z=new P.a(z,{keys:["name"],funcs:[e=>Object(V.n)([e.getCanonicalAlias(),...e.getAltAliases()])],shouldMatchWordsOnly:!1}).match(T));const[K,q]=Object(h.useState)(20);return u.a.createElement(S.a,{title:Object(E.b)("Forward message"),className:"mx_ForwardDialog",contentId:"mx_ForwardList",onFinished:s,fixedWidth:!1},u.a.createElement("h3",null,Object(E.b)("Message preview")),u.a.createElement("div",{className:o()("mx_ForwardDialog_preview",{mx_IRCLayout:U==_.a.IRC,sc_BubbleLayout:U==_.a.Bubble})},u.a.createElement(O.b,{mxEvent:j,layout:U,permalinkCreator:i,as:"div"})),u.a.createElement("hr",null),u.a.createElement("div",{className:"mx_ForwardList",id:"mx_ForwardList"},u.a.createElement(C.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:Object(E.b)("Search for rooms or people"),onSearch:I,autoFocus:!0}),u.a.createElement(R.a,{className:"mx_ForwardList_content"},z.length>0?u.a.createElement("div",{className:"mx_ForwardList_results"},u.a.createElement(D.a,{className:"mx_ForwardList_resultsList",truncateAt:K,createOverflowElement:function(e,t){const n=Object(E.b)("and %(count)s others...",{count:e});return u.a.createElement(M.b,{className:"mx_EntityTile_ellipsis",avatarJsx:u.a.createElement(A.a,{url:a(963).default,name:"...",width:36,height:36}),name:n,presenceState:"online",suppressOnHover:!0,onClick:()=>q(t)})},getChildren:(e,a)=>z.slice(e,a).map((e=>u.a.createElement(G,{key:e.roomId,room:e,type:d,content:x,matrixClient:t,onFinished:s}))),getChildCount:()=>z.length})):u.a.createElement("span",{className:"mx_ForwardList_noResults"},Object(E.b)("No results")))))},$=a(123),Y=a(1),J=a(223),Q=a(132),X=a(1020),Z=a(126),ee=a(237),te=a(148),ae=a(141),ne=a(135),ie=a(964);const se=["org.matrix.msc3215.room.moderation.moderated_by"];var oe=function(e){return e.Disagreement="org.matrix.msc3215.abuse.nature.disagreement",e.Toxic="org.matrix.msc3215.abuse.nature.toxic",e.Illegal="org.matrix.msc3215.abuse.nature.illegal",e.Spam="org.matrix.msc3215.abuse.nature.spam",e.Other="org.matrix.msc3215.abuse.nature.other",e}(oe||{}),re=function(e){return e.Admin="non-standard.abuse.nature.admin",e}(re||{});class le extends u.a.Component{constructor(e){super(e),i()(this,"moderation",void 0),i()(this,"onIgnoreUserTooChanged",(e=>{this.setState({ignoreUserToo:e})})),i()(this,"onReasonChange",(e=>{let{target:{value:t}}=e;this.setState({reason:t})})),i()(this,"onNatureChosen",(e=>{this.setState({nature:e.currentTarget.value})})),i()(this,"onCancel",(()=>{this.props.onFinished(!1)})),i()(this,"onSubmit",(async()=>{let e=this.state.reason||"";if(e=e.trim(),this.moderation){if(!this.state.nature||(this.state.nature==oe.Other||this.state.nature==re.Admin)&&!e)return void this.setState({err:Object(E.b)("Please fill why you're reporting.")})}else if(!e)return void this.setState({err:Object(E.b)("Please fill why you're reporting.")});this.setState({busy:!0,err:void 0});try{const e=$.a.get(),t=this.props.mxEvent;if(this.moderation&&this.state.nature!==re.Admin){const a=this.state.nature,n=await Object(J.c)(e,this.moderation.moderationBotUserId);await e.sendEvent(n,"org.matrix.msc3215.abuse.report",{event_id:t.getId(),room_id:t.getRoomId(),moderated_by_id:this.moderation.moderationRoomId,nature:a,reporter:e.getUserId(),comment:this.state.reason.trim()})}else await e.reportEvent(t.getRoomId(),t.getId(),-100,this.state.reason.trim());this.state.ignoreUserToo&&await e.setIgnoredUsers([...e.getIgnoredUsers(),t.getSender()]),this.props.onFinished(!0)}catch(e){Y.a.error(e),this.setState({busy:!1,err:e.message})}}));let t=null,a=null;if(Z.b.getValue("feature_report_to_moderators")){const n=$.a.get().getRoom(e.mxEvent.getRoomId());for(const e of se){const i=null==n?void 0:n.currentState.getStateEvents(e,e);if(!i)continue;if(Array.isArray(i))throw new TypeError(`getStateEvents(${e}, ${e}) should return at most one state event`);const s=i.event;if(!("content"in s)||"object"!=typeof s.content){console.debug("Moderation error","state event",e,"should have an object field `content`, got",s);continue}const o=s.content;"room_id"in o&&"string"==typeof o.room_id?"user_id"in o&&"string"==typeof o.user_id?(t=o.room_id,a=o.user_id):console.debug("Moderation error","state event",e,"should have a string field `content.user_id`, got",s):console.debug("Moderation error","state event",e,"should have a string field `content.room_id`, got",s)}t&&a&&(this.moderation={moderationRoomId:t,moderationBotUserId:a})}this.state={reason:"",busy:!1,err:void 0,nature:void 0,ignoreUserToo:!1}}render(){var e;let t,a;this.state.err&&(t=u.a.createElement("div",{className:"error"},this.state.err)),this.state.busy&&(a=u.a.createElement("div",{className:"progress"},u.a.createElement(ne.a,null)));const n=u.a.createElement(ie.a,{value:this.state.ignoreUserToo,label:Object(E.b)("Ignore user"),byline:Object(E.b)("Check if you want to hide all current and future messages from this user."),onChange:this.onIgnoreUserTooChanged,disabled:this.state.busy}),i=null===(e=Q.b.getObject("report_event"))||void 0===e?void 0:e.get("admin_message_md","adminMessageMD");let s;if(i){const e=new X.a(i).toHTML({externalLinks:!0});s=u.a.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}if(this.moderation){const e=$.a.get(),i=Q.b.get("validated_server_config").hsName;let s;switch(this.state.nature){case oe.Disagreement:s=Object(E.b)("What this user is writing is wrong.\nThis will be reported to the room moderators.");break;case oe.Toxic:s=Object(E.b)("This user is displaying toxic behaviour, for instance by insulting other users or sharing adult-only content in a family-friendly room or otherwise violating the rules of this room.\nThis will be reported to the room moderators.");break;case oe.Illegal:s=Object(E.b)("This user is displaying illegal behaviour, for instance by doxing people or threatening violence.\nThis will be reported to the room moderators who may escalate this to legal authorities.");break;case oe.Spam:s=Object(E.b)("This user is spamming the room with ads, links to ads or to propaganda.\nThis will be reported to the room moderators.");break;case re.Admin:s=e.isRoomEncrypted(this.props.mxEvent.getRoomId())?Object(E.b)("This room is dedicated to illegal or toxic content or the moderators fail to moderate illegal or toxic content.\nThis will be reported to the administrators of %(homeserver)s. The administrators will NOT be able to read the encrypted content of this room.",{homeserver:i}):Object(E.b)("This room is dedicated to illegal or toxic content or the moderators fail to moderate illegal or toxic content.\nThis will be reported to the administrators of %(homeserver)s.",{homeserver:i});break;case oe.Other:s=Object(E.b)("Any other reason. Please describe the problem.\nThis will be reported to the room moderators.");break;default:s=Object(E.b)("Please pick a nature and describe what makes this message abusive.")}return u.a.createElement(S.a,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:Object(E.b)("Report Content"),contentId:"mx_ReportEventDialog"},u.a.createElement("div",null,u.a.createElement(ee.a,{name:"nature",value:oe.Disagreement,checked:this.state.nature==oe.Disagreement,onChange:this.onNatureChosen},Object(E.b)("Disagree")),u.a.createElement(ee.a,{name:"nature",value:oe.Toxic,checked:this.state.nature==oe.Toxic,onChange:this.onNatureChosen},Object(E.b)("Toxic Behaviour")),u.a.createElement(ee.a,{name:"nature",value:oe.Illegal,checked:this.state.nature==oe.Illegal,onChange:this.onNatureChosen},Object(E.b)("Illegal Content")),u.a.createElement(ee.a,{name:"nature",value:oe.Spam,checked:this.state.nature==oe.Spam,onChange:this.onNatureChosen},Object(E.b)("Spam or propaganda")),u.a.createElement(ee.a,{name:"nature",value:re.Admin,checked:this.state.nature==re.Admin,onChange:this.onNatureChosen},Object(E.b)("Report the entire room")),u.a.createElement(ee.a,{name:"nature",value:oe.Other,checked:this.state.nature==oe.Other,onChange:this.onNatureChosen},Object(E.b)("Other")),u.a.createElement("p",null,s),u.a.createElement(ae.a,{className:"mx_ReportEventDialog_reason",element:"textarea",label:Object(E.b)("Reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),a,t,n),u.a.createElement(te.a,{primaryButton:Object(E.b)("Send report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}return u.a.createElement(S.a,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:Object(E.b)("Report Content to Your Homeserver Administrator"),contentId:"mx_ReportEventDialog"},u.a.createElement("div",{className:"mx_ReportEventDialog",id:"mx_ReportEventDialog"},u.a.createElement("p",null,Object(E.b)("Reporting this message will send its unique 'event ID' to the administrator of your homeserver. If messages in this room are encrypted, your homeserver administrator will not be able to read the message text or view any files or images.")),s,u.a.createElement(ae.a,{className:"mx_ReportEventDialog_reason",element:"textarea",label:Object(E.b)("Reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),a,t,n),u.a.createElement(te.a,{primaryButton:Object(E.b)("Send report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}}var ce=a(352),de=a(182),me=a(138),he=a(290);let ue=function(e){return e.Appearance="SPACE_PREFERENCE_APPEARANCE_TAB",e}({});const pe=e=>{let{space:t}=e;const a=Object(y.b)("Spaces.showPeopleInSpace",t.roomId);return u.a.createElement("div",{className:"mx_SettingsTab"},u.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(E.b)("Sections to show")),u.a.createElement("div",{className:"mx_SettingsTab_section"},u.a.createElement(de.b,{checked:!!a,onChange:e=>{Z.b.setValue("Spaces.showPeopleInSpace",t.roomId,me.a.ROOM_ACCOUNT,!a)}},Object(E.b)("People")),u.a.createElement("p",null,Object(E.b)("This groups your chats with members of this space. Turning this off will hide those chats from your view of %(spaceName)s.",{spaceName:t.name}))))};var ge=e=>{let{space:t,initialTabId:a,onFinished:n}=e;const i=[new ce.a(ue.Appearance,Object(E.d)("Appearance"),"mx_SpacePreferencesDialog_appearanceIcon",u.a.createElement(pe,{space:t}))];return u.a.createElement(S.a,{className:"mx_SpacePreferencesDialog",hasCancel:!0,onFinished:n,title:Object(E.b)("Preferences"),fixedWidth:!1},u.a.createElement("h4",null,u.a.createElement(he.a,{room:t})),u.a.createElement("div",{className:"mx_SettingsDialog_content"},u.a.createElement(ce.c,{tabs:i,initialTabId:a})))},be=a(242),ve=a(124),fe=a(819),Ee=a(404),ye=a(516),_e=a(669);var Se=e=>{var t,a,n;let{matrixClient:i,space:s}=e;const[o,r]=Object(h.useState)(!1),[l,c]=Object(h.useState)(""),d=i.getUserId(),[m,p]=Object(h.useState)(null),b=s.currentState.maySendStateEvent(g.b.RoomAvatar,d),v=null!==m,[f,y]=Object(h.useState)(s.name),_=s.currentState.maySendStateEvent(g.b.RoomName,d),S=f!==s.name,O=null!==(t=null===(a=Object(_e.a)(s))||void 0===a?void 0:a.text)&&void 0!==t?t:"",[C,x]=Object(h.useState)(O),j=s.currentState.maySendStateEvent(g.b.RoomTopic,d),k=C!==O;return u.a.createElement("div",{className:"mx_SettingsTab"},u.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(E.b)("General")),u.a.createElement("div",null,Object(E.b)("Edit settings relating to your space.")),l&&u.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},l),u.a.createElement("div",{className:"mx_SettingsTab_section"},u.a.createElement(fe.b,{avatarUrl:null!==(n=Object(w.b)(s,80,80,"crop"))&&void 0!==n?n:void 0,avatarDisabled:o||!b,setAvatar:p,name:f,nameDisabled:o||!_,setName:y,topic:C,topicDisabled:o||!j,setTopic:x}),u.a.createElement(ve.a,{onClick:()=>{p(null),y(s.name),x(O)},disabled:o||!(v||S||k),kind:"link"},Object(E.b)("Cancel")),u.a.createElement(ve.a,{onClick:async()=>{r(!0);const e=[];if(v&&(m?e.push((async()=>{const{content_uri:e}=await i.uploadContent(m);await i.sendStateEvent(s.roomId,g.b.RoomAvatar,{url:e},"")})()):e.push(i.sendStateEvent(s.roomId,g.b.RoomAvatar,{},""))),S&&e.push(i.setRoomName(s.roomId,f)),k){const t=Object(Ee.b)(C,{forceHTML:!1});e.push(i.setRoomTopic(s.roomId,C,t))}const t=await Promise.allSettled(e);r(!1);const a=t.filter((e=>"rejected"===e.status));a.length>0&&(Y.a.error("Failed to save space settings: ",a),c(Object(E.b)("Failed to save space settings.")))},disabled:o,kind:"primary"},o?Object(E.b)("Saving…"):Object(E.b)("Save Changes"))),u.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(E.b)("Leave Space")),u.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},u.a.createElement(ve.a,{kind:"danger",onClick:()=>{Object(ye.b)(s)}},Object(E.b)("Leave Space"))))},we=a(162),Oe=a(1010),Ce=a(415),xe=a(239),je=a(935),ke=a(1024),Re=a(321),Ie=a(357),Te=a(256);var Ne=e=>{let{matrixClient:t,space:a,closeSettingsFn:n}=e;const[i,s]=Object(h.useState)(""),o=Object(Te.a)((async()=>t.doesServerSupportUnstableFeature("org.matrix.msc3827.stable")),[t],!1),r=t.getUserId(),l=Object(Re.a)(a,(e=>e.getJoinRule())),[c,d]=Object(je.a)((()=>{var e,t;return(null===(e=a.currentState.getStateEvents(g.b.RoomGuestAccess,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.guest_access)===we.a.CanJoin}),(e=>t.sendStateEvent(a.roomId,g.b.RoomGuestAccess,{guest_access:e?we.a.CanJoin:we.a.Forbidden},"")),(()=>s(Object(E.b)("Failed to update the guest access of this space")))),[m,p]=Object(je.a)((()=>{var e,t;return(null===(e=a.currentState.getStateEvents(g.b.RoomHistoryVisibility,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.history_visibility)||we.b.Shared}),(e=>t.sendStateEvent(a.roomId,g.b.RoomHistoryVisibility,{history_visibility:e},"")),(()=>s(Object(E.b)("Failed to update the history visibility of this space")))),[b,v]=Object(Ce.a)(),f=a.currentState.maySendStateEvent(g.b.RoomGuestAccess,r),y=a.currentState.maySendStateEvent(g.b.RoomHistoryVisibility,r),_=a.currentState.mayClientSendStateEvent(g.b.RoomCanonicalAlias,t),S=a.currentState.getStateEvents(g.b.RoomCanonicalAlias,"");let w,O;return l===we.c.Public&&(w=u.a.createElement("div",null,u.a.createElement(ve.a,{"data-testid":"toggle-guest-access-btn",onClick:v,kind:"link",className:"mx_SettingsTab_showAdvanced"},b?Object(E.b)("Hide advanced"):Object(E.b)("Show advanced")),b&&u.a.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},u.a.createElement(xe.a,{value:c,onChange:d,disabled:!f,label:Object(E.b)("Enable guest access")}),u.a.createElement("p",null,Object(E.b)("Guests can join a space without having an account."),u.a.createElement("br",null),Object(E.b)("This may be useful for public spaces."))))),a.getJoinRule()===we.c.Public&&(O=u.a.createElement(u.a.Fragment,null,u.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(E.b)("Address")),u.a.createElement(Oe.a,{roomId:a.roomId,canSetCanonicalAlias:_,canSetAliases:!0,canonicalAliasEvent:null!=S?S:void 0,hidePublishSetting:!o}))),u.a.createElement("div",{className:"mx_SettingsTab"},u.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(E.b)("Visibility")),i&&u.a.createElement("div",{"data-testid":"space-settings-error",className:"mx_SpaceRoomView_errorText"},i),u.a.createElement(Ie.a,{"data-testid":"access-fieldset",legend:Object(E.b)("Access"),description:Object(E.b)("Decide who can view and join %(spaceName)s.",{spaceName:a.name})},u.a.createElement(ke.a,{room:a,onError:()=>s(Object(E.b)("Failed to update the visibility of this space")),closeSettingsFn:n}),w,u.a.createElement("div",{className:"mx_SettingsTab_toggleWithDescription"},u.a.createElement(xe.a,{value:m===we.b.WorldReadable,onChange:e=>{p(e?we.b.WorldReadable:we.b.Shared)},disabled:!y,label:Object(E.b)("Preview Space")}),u.a.createElement("p",null,Object(E.b)("Allow people to preview your space before they join."),u.a.createElement("br",null),u.a.createElement("b",null,Object(E.b)("Recommended for public spaces."))))),O)},Pe=a(157),De=a(932),Me=a(1009);let Ae=function(e){return e.General="SPACE_GENERAL_TAB",e.Visibility="SPACE_VISIBILITY_TAB",e.Roles="SPACE_ROLES_TAB",e.Advanced="SPACE_ADVANCED_TAB",e}({});var Ue=e=>{let{matrixClient:t,space:a,onFinished:n}=e;Object(be.a)(r.a,(e=>{e.action===U.a.AfterLeaveRoom&&e.room_id===a.roomId&&n()}));const i=Object(h.useMemo)((()=>[new ce.a(Ae.General,Object(E.d)("General"),"mx_SpaceSettingsDialog_generalIcon",u.a.createElement(Se,{matrixClient:t,space:a})),new ce.a(Ae.Visibility,Object(E.d)("Visibility"),"mx_SpaceSettingsDialog_visibilityIcon",u.a.createElement(Ne,{matrixClient:t,space:a,closeSettingsFn:n})),new ce.a(Ae.Roles,Object(E.d)("Roles & Permissions"),"mx_RoomSettingsDialog_rolesIcon",u.a.createElement(Me.a,{roomId:a.roomId})),Z.b.getValue(Pe.b.AdvancedSettings)?new ce.a(Ae.Advanced,Object(E.d)("Advanced"),"mx_RoomSettingsDialog_warningIcon",u.a.createElement(De.a,{roomId:a.roomId,closeSettingsFn:n})):null].filter(Boolean)),[t,a,n]);return u.a.createElement(S.a,{title:Object(E.b)("Settings - %(spaceName)s",{spaceName:a.name||Object(E.b)("Unnamed Space")}),className:"mx_SpaceSettingsDialog",contentId:"mx_SpaceSettingsDialog",onFinished:n,fixedWidth:!1},u.a.createElement("div",{className:"mx_SpaceSettingsDialog_content",id:"mx_SpaceSettingsDialog"},u.a.createElement(ce.c,{tabs:i})))},Le=a(1016),Fe=a(400),Be=a(163),Ve=a(257),We=a(154);class ze{constructor(){i()(this,"isRegistered",!1),i()(this,"onDispatch",(e=>{switch(e.action){case"open_room_settings":l.b.createDialog(c.c,{roomId:e.room_id||We.b.instance.roomViewStore.getRoomId(),initialTabId:e.initial_tab_id},void 0,!1,!0);break;case U.a.OpenForwardDialog:l.b.createDialog(q,{matrixClient:$.a.get(),event:e.event,permalinkCreator:e.permalinkCreator});break;case U.a.OpenReportEventDialog:l.b.createDialog(le,{mxEvent:e.event},"mx_Dialog_reportEvent");break;case U.a.OpenSpacePreferences:l.b.createDialog(ge,{initialTabId:e.initalTabId,space:e.space},void 0,!1,!0);break;case U.a.OpenSpaceSettings:l.b.createDialog(Ue,{matrixClient:e.space.client,space:e.space},void 0,!1,!0);break;case U.a.OpenInviteDialog:l.b.createDialog(Le.a,{kind:e.kind,call:e.call,roomId:e.roomId},o()("mx_InviteDialog_flexWrapper",e.className),!1,!0).finished.then((t=>{var a;null===(a=e.onFinishedCallback)||void 0===a||a.call(e,t)}));break;case U.a.OpenAddToExistingSpaceDialog:{const t=e.space;l.b.createDialog(Fe.d,{onCreateRoomClick:e=>{Object(Ve.g)(t),Be.b.trackInteraction("WebAddExistingToSpaceDialogCreateRoomButton",e)},onAddSubspaceClick:()=>Object(Ve.f)(t),space:t,onFinished:e=>{e&&We.b.instance.roomViewStore.getRoomId()===t.roomId&&r.a.fire(U.a.UpdateSpaceHierarchy)}},"mx_AddExistingToSpaceDialog_wrapper");break}}}))}prepare(){this.isRegistered||(r.a.register(this.onDispatch),this.isRegistered=!0)}}i()(ze,"instance",new ze)},1746:function(e,t,a){"use strict";a.d(t,"a",(function(){return $}));var n=a(122),i=a.n(n),s=a(1),o=a(172),r=a(136),l=a(123),c=a(125),d=a(121),m=a(231),h=a(196),u=a(128);const p="mx_snooze_bulk_unverified_device_nag",g="reviewsessions",b=e=>{h.a.sharedInstance().addOrReplaceToast({key:g,title:Object(d.b)("You have unverified sessions"),icon:"verification_warning",props:{description:Object(d.b)("Review to ensure your account is safe"),acceptLabel:Object(d.b)("Review"),onAccept:()=>{$.sharedInstance().dismissUnverifiedSessions(e),c.a.dispatch({action:u.a.ViewUserDeviceSettings})},rejectLabel:Object(d.b)("Later"),onReject:()=>{$.sharedInstance().dismissUnverifiedSessions(e),(()=>{try{localStorage.setItem(p,String(Date.now()))}catch(e){s.a.error("Failed to persist bulk unverified device nag snooze",e)}})()}},component:m.a,priority:50})};var v=a(129),f=a(419),E=a(258),y=a(302),_=a(135);const S="setupencryption",w=e=>{switch(e){case j.SET_UP_ENCRYPTION:return Object(d.b)("Set up Secure Backup");case j.UPGRADE_ENCRYPTION:return Object(d.b)("Encryption upgrade available");case j.VERIFY_THIS_SESSION:return Object(d.b)("Verify this session")}},O=e=>{switch(e){case j.SET_UP_ENCRYPTION:case j.UPGRADE_ENCRYPTION:return"secure_backup";case j.VERIFY_THIS_SESSION:return"verification_warning"}},C=e=>{switch(e){case j.SET_UP_ENCRYPTION:return Object(d.b)("Continue");case j.UPGRADE_ENCRYPTION:return Object(d.b)("Upgrade");case j.VERIFY_THIS_SESSION:return Object(d.b)("Verify")}},x=e=>{switch(e){case j.SET_UP_ENCRYPTION:case j.UPGRADE_ENCRYPTION:return Object(d.b)("Safeguard against losing access to encrypted messages & data");case j.VERIFY_THIS_SESSION:return Object(d.b)("Other users may not trust it")}};let j=function(e){return e.SET_UP_ENCRYPTION="set_up_encryption",e.UPGRADE_ENCRYPTION="upgrade_encryption",e.VERIFY_THIS_SESSION="verify_this_session",e}({});const k=()=>{$.sharedInstance().dismissEncryptionSetup()},R=e=>{var t;if(null!==(t=y.a.setupEncryptionNeeded)&&void 0!==t&&t.call(y.a,e))return;h.a.sharedInstance().addOrReplaceToast({key:S,title:w(e),icon:O(e),props:{description:x(e),acceptLabel:C(e),onAccept:async()=>{if(e===j.VERIFY_THIS_SESSION)v.b.createDialog(f.a,{},void 0,!1,!0);else{const e=v.b.createDialog(_.a,void 0,"mx_Dialog_spinner",!1,!0);try{await Object(E.b)()}finally{e.close()}}},rejectLabel:Object(d.b)("Later"),onReject:k},component:m.a,priority:e===j.VERIFY_THIS_SESSION?95:40})},I=()=>{h.a.sharedInstance().dismissToast(S)};var T=a(120),N=a.n(T),P=a(664),D=a(497),M=a(953);function A(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function U(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?A(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):A(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function L(e){return"unverified_session_"+e}const F=async e=>{const t=l.a.get(),a=await t.getDevice(e),n=U(U({},a),{},{isVerified:Object(P.a)(t,e),deviceType:D.a.Unknown});h.a.sharedInstance().addOrReplaceToast({key:L(e),title:Object(d.b)("New login. Was this you?"),icon:"verification_warning",props:{description:a.display_name,detail:N.a.createElement(M.a,{device:n}),acceptLabel:Object(d.b)("Yes, it was me"),onAccept:()=>{$.sharedInstance().dismissUnverifiedSessions([e])},rejectLabel:Object(d.b)("No"),onReject:()=>{$.sharedInstance().dismissUnverifiedSessions([e]),c.a.dispatch({action:u.a.ViewUserDeviceSettings})}},component:m.a,priority:80})},B=e=>{h.a.sharedInstance().dismissToast(L(e))};var V=a(246),W=a(379);var z=a(132),H=a(158),K=a(955),G=a(126),q=a(157);class ${constructor(){i()(this,"dispatcherRef",void 0),i()(this,"dismissed",new Set),i()(this,"dismissedThisDeviceToast",!1),i()(this,"keyBackupInfo",null),i()(this,"keyBackupFetchedAt",null),i()(this,"keyBackupStatusChecked",!1),i()(this,"ourDeviceIdsAtStart",null),i()(this,"displayingToastsForDeviceIds",new Set),i()(this,"running",!1),i()(this,"shouldRecordClientInformation",!1),i()(this,"enableBulkUnverifiedSessionsReminder",!0),i()(this,"deviceClientInformationSettingWatcherRef",void 0),i()(this,"onWillUpdateDevices",(async(e,t)=>{if(t)return;const a=l.a.get().getUserId();e.includes(a)&&this.ensureDeviceIdsAtStartPopulated()})),i()(this,"onDevicesUpdated",(e=>{e.includes(l.a.get().getUserId())&&this.recheck()})),i()(this,"onDeviceVerificationChanged",(e=>{e===l.a.get().getUserId()&&this.recheck()})),i()(this,"onUserTrustStatusChanged",(e=>{e===l.a.get().getUserId()&&this.recheck()})),i()(this,"onCrossSingingKeysChanged",(()=>{this.recheck()})),i()(this,"onAccountData",(e=>{(e.getType().startsWith("m.secret_storage.")||e.getType().startsWith("m.cross_signing.")||"m.megolm_backup.v1"===e.getType())&&this.recheck()})),i()(this,"onSync",((e,t)=>{"PREPARED"===e&&null===t&&this.recheck()})),i()(this,"onRoomStateEvents",(e=>{e.getType()===r.EventType.RoomEncryption&&this.recheck()})),i()(this,"onAction",(e=>{let{action:t}=e;t===u.a.OnLoggedIn&&(this.recheck(),this.updateClientInformation())})),i()(this,"checkKeyBackupStatus",(async()=>{if(this.keyBackupStatusChecked)return;const e=l.a.get().getKeyBackupEnabled();this.keyBackupStatusChecked=null!==e,!1===e&&c.a.dispatch({action:u.a.ReportKeyBackupNotEnabled})})),i()(this,"onRecordClientInformationSettingChange",((e,t,a,n,i)=>{const s=this.shouldRecordClientInformation;this.shouldRecordClientInformation=!!i,this.shouldRecordClientInformation!==s&&this.updateClientInformation()})),i()(this,"updateClientInformation",(async()=>{try{var e;if(this.shouldRecordClientInformation)await Object(K.c)(l.a.get(),z.b.get(),null!==(e=H.a.get())&&void 0!==e?e:void 0);else await Object(K.d)(l.a.get())}catch(e){s.a.error("Failed to update client information",e)}}))}static sharedInstance(){return window.mxDeviceListener||(window.mxDeviceListener=new $),window.mxDeviceListener}start(){this.running=!0,l.a.get().on(o.b.WillUpdateDevices,this.onWillUpdateDevices),l.a.get().on(o.b.DevicesUpdated,this.onDevicesUpdated),l.a.get().on(o.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),l.a.get().on(o.b.UserTrustStatusChanged,this.onUserTrustStatusChanged),l.a.get().on(o.b.KeysChanged,this.onCrossSingingKeysChanged),l.a.get().on(r.ClientEvent.AccountData,this.onAccountData),l.a.get().on(r.ClientEvent.Sync,this.onSync),l.a.get().on(r.RoomStateEvent.Events,this.onRoomStateEvents),this.shouldRecordClientInformation=G.b.getValue("deviceClientInformationOptIn"),this.enableBulkUnverifiedSessionsReminder=G.b.getValue(q.b.BulkUnverifiedSessionsReminder),this.deviceClientInformationSettingWatcherRef=G.b.watchSetting("deviceClientInformationOptIn",null,this.onRecordClientInformationSettingChange),this.dispatcherRef=c.a.register(this.onAction),this.recheck(),this.updateClientInformation()}stop(){this.running=!1,l.a.get()&&(l.a.get().removeListener(o.b.WillUpdateDevices,this.onWillUpdateDevices),l.a.get().removeListener(o.b.DevicesUpdated,this.onDevicesUpdated),l.a.get().removeListener(o.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),l.a.get().removeListener(o.b.UserTrustStatusChanged,this.onUserTrustStatusChanged),l.a.get().removeListener(o.b.KeysChanged,this.onCrossSingingKeysChanged),l.a.get().removeListener(r.ClientEvent.AccountData,this.onAccountData),l.a.get().removeListener(r.ClientEvent.Sync,this.onSync),l.a.get().removeListener(r.RoomStateEvent.Events,this.onRoomStateEvents)),this.deviceClientInformationSettingWatcherRef&&G.b.unwatchSetting(this.deviceClientInformationSettingWatcherRef),this.dispatcherRef&&(c.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.dismissed.clear(),this.dismissedThisDeviceToast=!1,this.keyBackupInfo=null,this.keyBackupFetchedAt=null,this.keyBackupStatusChecked=!1,this.ourDeviceIdsAtStart=null,this.displayingToastsForDeviceIds=new Set}async dismissUnverifiedSessions(e){s.a.log("Dismissing unverified sessions: "+Array.from(e).join(","));for(const t of e)this.dismissed.add(t);this.recheck()}dismissEncryptionSetup(){this.dismissedThisDeviceToast=!0,this.recheck()}ensureDeviceIdsAtStartPopulated(){if(null===this.ourDeviceIdsAtStart){const e=l.a.get();this.ourDeviceIdsAtStart=new Set(e.getStoredDevicesForUser(e.getUserId()).map((e=>e.deviceId)))}}async getKeyBackupInfo(){const e=(new Date).getTime();return(!this.keyBackupInfo||!this.keyBackupFetchedAt||this.keyBackupFetchedAt<e-3e5)&&(this.keyBackupInfo=await l.a.get().getKeyBackupVersion(),this.keyBackupFetchedAt=e),this.keyBackupInfo}shouldShowSetupEncryptionToast(){if(Object(E.d)())return!1;const e=l.a.get();return e&&e.getRooms().some((t=>e.isRoomEncrypted(t.roomId)))}async recheck(){if(!this.running)return;const e=l.a.get();if(!await e.isVersionSupported("v1.1"))return;if(!e.isCryptoEnabled())return;if(!e.isInitialSyncComplete())return;const t=await e.isCrossSigningReady(),a=await e.isSecretStorageReady(),n=t&&a;if(this.dismissedThisDeviceToast||n)I(),this.checkKeyBackupStatus();else if(this.shouldShowSetupEncryptionToast())if(await e.downloadKeys([e.getUserId()]),!e.getCrossSigningId()&&e.getStoredCrossSigningForUser(e.getUserId()))R(j.VERIFY_THIS_SESSION),this.checkKeyBackupStatus();else{await this.getKeyBackupInfo()?R(j.UPGRADE_ENCRYPTION):(await e.waitForClientWellKnown(),Object(V.g)()&&function(){const e=window.matrixChat;return(null==e?void 0:e.state.view)===W.a.LOGGED_IN}()?(I(),Object(E.b)()):R(j.SET_UP_ENCRYPTION))}this.ensureDeviceIdsAtStartPopulated();const i=new Set,o=new Set,r=t&&await e.checkDeviceTrust(e.getUserId(),e.deviceId).isCrossSigningVerified();if(t){const t=e.getStoredDevicesForUser(e.getUserId());for(const a of t){if(a.deviceId===e.deviceId)continue;var c;if(!(await e.checkDeviceTrust(e.getUserId(),a.deviceId)).isCrossSigningVerified()&&!this.dismissed.has(a.deviceId))null!==(c=this.ourDeviceIdsAtStart)&&void 0!==c&&c.has(a.deviceId)?i.add(a.deviceId):o.add(a.deviceId)}}s.a.debug("Old unverified sessions: "+Array.from(i).join(",")),s.a.debug("New unverified sessions: "+Array.from(o).join(",")),s.a.debug("Currently showing toasts for: "+Array.from(this.displayingToastsForDeviceIds).join(","));const d=(()=>{try{const e=localStorage.getItem(p),t=Number.parseInt(e||"",10);return Number.isInteger(t)&&t+6048e5>Date.now()}catch(e){return!1}})();i.size>0&&r&&this.enableBulkUnverifiedSessionsReminder&&!d?b(i):h.a.sharedInstance().dismissToast(g);for(const e of o)F(e);for(const e of this.displayingToastsForDeviceIds)o.has(e)||(s.a.debug("Hiding unverified session toast for "+e),B(e));this.displayingToastsForDeviceIds=o}}},1749:function(e,t,a){"use strict";a.d(t,"a",(function(){return y}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(533),l=a(438),c=a(1),d=a(123),m=a(121),h=a(161),u=a(148);class p extends o.a.Component{render(){return o.a.createElement("div",null,o.a.createElement("h2",null,Object(m.b)("Verified!")),o.a.createElement("p",null,Object(m.b)("You've successfully verified this user.")),o.a.createElement("p",null,Object(m.b)("Secure messages with this user are end-to-end encrypted and not able to be read by third parties.")),o.a.createElement(u.a,{onPrimaryButtonClick:this.props.onDone,primaryButton:Object(m.b)("Got It"),hasCancel:!1}))}}class g extends o.a.Component{render(){return o.a.createElement("div",null,o.a.createElement("p",null,Object(m.b)("The other party cancelled the verification.")),o.a.createElement(u.a,{primaryButton:Object(m.b)("OK"),hasCancel:!1,onPrimaryButtonClick:this.props.onDone}))}}var b=a(195),v=a(135),f=a(950),E=a(137);class y extends o.a.Component{constructor(e){super(e),i()(this,"showSasEvent",void 0),i()(this,"onFinished",(()=>{this.props.onFinished(3===this.state.phase)})),i()(this,"onCancelClick",(()=>{this.props.onFinished(3===this.state.phase)})),i()(this,"onContinueClick",(()=>{this.setState({phase:2}),this.props.verifier.verify().then((()=>{this.setState({phase:3})})).catch((e=>{c.a.log("Verification failed",e)}))})),i()(this,"onVerifierShowSas",(e=>{this.showSasEvent=e,this.setState({phase:1,sas:e.sas})})),i()(this,"onVerifierCancel",(()=>{this.setState({phase:4})})),i()(this,"onSasMatchesClick",(()=>{var e;null===(e=this.showSasEvent)||void 0===e||e.confirm(),this.setState({phase:2})})),i()(this,"onVerifiedDoneClick",(()=>{this.props.onFinished(!0)}));let t=0;this.props.verifier.hasBeenCancelled&&(c.a.log("Verifier was cancelled in the background."),t=4),this.showSasEvent=null,this.state={phase:t,sasVerified:!1,opponentProfile:null,opponentProfileError:null,sas:null},this.props.verifier.on(r.b.ShowSas,this.onVerifierShowSas),this.props.verifier.on(l.c.Cancel,this.onVerifierCancel),this.fetchOpponentProfile()}componentWillUnmount(){4!==this.state.phase&&3!==this.state.phase&&this.props.verifier.cancel(new Error("User cancel")),this.props.verifier.removeListener(r.b.ShowSas,this.onVerifierShowSas)}async fetchOpponentProfile(){try{const e=await d.a.get().getProfileInfo(this.props.verifier.userId);this.setState({opponentProfile:e})}catch(e){this.setState({opponentProfileError:e})}}renderPhaseStart(){const e=this.props.verifier.userId===d.a.get().getUserId();let t;const a=this.state.opponentProfile;if(a){const e=a.avatar_url?Object(h.b)(a.avatar_url).getSquareThumbnailHttp(48):null;t=o.a.createElement("div",{className:"mx_IncomingSasDialog_opponentProfile"},o.a.createElement(b.a,{name:a.displayname,idName:this.props.verifier.userId,url:e,width:48,height:48,resizeMethod:"crop"}),o.a.createElement("h2",null,a.displayname))}else t=this.state.opponentProfileError?o.a.createElement("div",null,o.a.createElement(b.a,{name:this.props.verifier.userId.slice(1),idName:this.props.verifier.userId,width:48,height:48}),o.a.createElement("h2",null,this.props.verifier.userId)):o.a.createElement(v.a,null);const n=[o.a.createElement("p",{key:"p1"},Object(m.b)("Verify this user to mark them as trusted. Trusting users gives you extra peace of mind when using end-to-end encrypted messages.")),o.a.createElement("p",{key:"p2"},Object(m.b)("Verifying this user will mark their session as trusted, and also mark your session as trusted to them."))],i=[o.a.createElement("p",{key:"p1"},Object(m.b)("Verify this device to mark it as trusted. Trusting this device gives you and other users extra peace of mind when using end-to-end encrypted messages.")),o.a.createElement("p",{key:"p2"},Object(m.b)("Verifying this device will mark it as trusted, and users who have verified with you will trust this device."))];return o.a.createElement("div",null,t,e?i:n,o.a.createElement(u.a,{primaryButton:Object(m.b)("Continue"),hasCancel:!0,onPrimaryButtonClick:this.onContinueClick,onCancel:this.onCancelClick}))}renderPhaseShowSas(){return this.showSasEvent?o.a.createElement(f.a,{sas:this.showSasEvent.sas,onCancel:this.onCancelClick,onDone:this.onSasMatchesClick,isSelf:this.props.verifier.userId===d.a.get().getUserId(),inDialog:!0}):null}renderPhaseWaitForPartnerToConfirm(){return o.a.createElement("div",null,o.a.createElement(v.a,null),o.a.createElement("p",null,Object(m.b)("Waiting for partner to confirm…")))}renderPhaseVerified(){return o.a.createElement(p,{onDone:this.onVerifiedDoneClick})}renderPhaseCancelled(){return o.a.createElement(g,{onDone:this.onCancelClick})}render(){let e;switch(this.state.phase){case 0:e=this.renderPhaseStart();break;case 1:e=this.renderPhaseShowSas();break;case 2:e=this.renderPhaseWaitForPartnerToConfirm();break;case 3:e=this.renderPhaseVerified();break;case 4:e=this.renderPhaseCancelled()}return o.a.createElement(E.a,{title:Object(m.b)("Incoming Verification Request"),onFinished:this.onFinished,fixedWidth:!1},e)}}},1750:function(e,t,a){"use strict";a.d(t,"a",(function(){return f}));var n=a(127),i=a.n(n),s=a(120),o=a.n(s),r=a(121),l=a(499),c=a(131),d=a.n(c),m=a(134),h=a.n(m);const u=["children","className"];function p(e){let{children:t,className:a}=e,n=h()(e,u);const s=i()(a,"mx_SplashPage");return o.a.createElement("main",d()({},n,{className:s}),t)}var g=a(124);function b(e){let t,{useCase:a,onClick:n,selected:s}=e;switch(a){case l.a.PersonalMessaging:t=Object(r.b)("Friends and family");break;case l.a.WorkMessaging:t=Object(r.b)("Coworkers and teams");break;case l.a.CommunityMessaging:t=Object(r.b)("Online community members")}return o.a.createElement(g.a,{className:i()("mx_UseCaseSelectionButton",{mx_UseCaseSelectionButton_selected:s}),onClick:async()=>n(a)},o.a.createElement("div",{className:i()("mx_UseCaseSelectionButton_icon",{mx_UseCaseSelectionButton_messaging:a===l.a.PersonalMessaging,mx_UseCaseSelectionButton_work:a===l.a.WorkMessaging,mx_UseCaseSelectionButton_community:a===l.a.CommunityMessaging})}),o.a.createElement("span",null,t),o.a.createElement("div",{className:"mx_UseCaseSelectionButton_selectedIcon"}))}const v=1500;function f(e){let{onFinished:t}=e;const[a,n]=Object(s.useState)(null);return Object(s.useEffect)((()=>{if(a){let e=window.setTimeout((()=>{e=null,t(a)}),v);return()=>{null!==e&&clearTimeout(e),e=null}}}),[a,t]),o.a.createElement(p,{className:i()("mx_UseCaseSelection",{mx_UseCaseSelection_selected:null!==a})},o.a.createElement("div",{className:"mx_UseCaseSelection_title mx_UseCaseSelection_slideIn"},o.a.createElement("h1",null,Object(r.b)("You're in"))),o.a.createElement("div",{className:"mx_UseCaseSelection_info mx_UseCaseSelection_slideInDelayed"},o.a.createElement("h2",null,Object(r.b)("Who will you chat to the most?")),o.a.createElement("h3",null,Object(r.b)("We'll help you get connected."))),o.a.createElement("div",{className:"mx_UseCaseSelection_options mx_UseCaseSelection_slideInDelayed"},o.a.createElement(b,{useCase:l.a.PersonalMessaging,selected:a===l.a.PersonalMessaging,onClick:n}),o.a.createElement(b,{useCase:l.a.WorkMessaging,selected:a===l.a.WorkMessaging,onClick:n}),o.a.createElement(b,{useCase:l.a.CommunityMessaging,selected:a===l.a.CommunityMessaging,onClick:n})),o.a.createElement("div",{className:"mx_UseCaseSelection_skip mx_UseCaseSelection_slideInDelayed"},o.a.createElement(g.a,{kind:"link",onClick:async()=>n(l.a.Skip)},Object(r.b)("Skip"))))}},1752:function(e,t,a){"use strict";a.d(t,"a",(function(){return g}));var n=a(120),i=a.n(n),s=a(127),o=a.n(s),r=a(132),l=a(329),c=a(121),d=a(126),m=a(157),h=a(993),u=a(675);const p=`<a href="https://matrix.org" target="_blank" rel="noreferrer noopener">\n    <img width="79" height="34" alt="Matrix" style="padding-left: 1px;vertical-align: middle" src="${a(1722).default}"/>\n</a>`;Object(c.d)("Sign in with SSO");class g extends i.a.PureComponent{render(){const e=r.b.getObject("embedded_pages");let t;return e&&(t=e.get("welcome_url")),t||(t="welcome.html"),i.a.createElement(l.a,null,i.a.createElement("div",{className:o()("mx_Welcome",{mx_WelcomePage_registrationDisabled:!d.b.getValue(m.b.Registration)})},i.a.createElement(u.a,{className:"mx_WelcomePage",url:t,replaceMap:{"$riot:ssoUrl":"#/start_sso","$riot:casUrl":"#/start_cas",$matrixLogo:p,"[matrix]":p}}),i.a.createElement(h.a,null)))}}},1753:function(e,t,a){"use strict";a.d(t,"a",(function(){return E}));var n=a(120),i=a.n(n),s=a(329),o=a(992),r=a(122),l=a.n(r),c=a(1),d=a(123),m=a(121),h=a(129),u=a(330),p=a(148),g=a(137),b=a(135),v=a(263);class f extends i.a.PureComponent{constructor(e){super(e),l()(this,"doBootstrapUIAuth",(async e=>{if(this.state.canUploadKeysWithPasswordOnly&&this.state.accountPassword)await e({type:"m.login.password",identifier:{type:"m.id.user",user:d.a.get().getUserId()},user:d.a.get().getUserId(),password:this.state.accountPassword});else if(this.props.tokenLogin)await e({});else{const t={[u.c.PHASE_PREAUTH]:{title:Object(m.b)("Use Single Sign On to continue"),body:Object(m.b)("To continue, use Single Sign On to prove your identity."),continueText:Object(m.b)("Single Sign On"),continueKind:"primary"},[u.c.PHASE_POSTAUTH]:{title:Object(m.b)("Confirm encryption setup"),body:Object(m.b)("Click the button below to confirm setting up encryption."),continueText:Object(m.b)("Confirm"),continueKind:"primary"}},{finished:a}=h.b.createDialog(v.a,{title:Object(m.b)("Setting up keys"),matrixClient:d.a.get(),makeRequest:e,aestheticsForStagePhases:{[u.c.LOGIN_TYPE]:t,[u.c.UNSTABLE_LOGIN_TYPE]:t}}),[n]=await a;if(!n)throw new Error("Cross-signing key upload auth canceled")}})),l()(this,"bootstrapCrossSigning",(async()=>{this.setState({error:null});const e=d.a.get();try{await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:this.doBootstrapUIAuth}),this.props.onFinished(!0)}catch(e){if(this.props.tokenLogin)return void this.props.onFinished(!1);this.setState({error:e}),c.a.error("Error bootstrapping cross-signing",e)}})),l()(this,"onCancel",(()=>{this.props.onFinished(!1)})),this.state={error:null,canUploadKeysWithPasswordOnly:!!e.accountPassword||null,accountPassword:e.accountPassword||""},this.state.accountPassword||this.queryKeyUploadAuth()}componentDidMount(){this.bootstrapCrossSigning()}async queryKeyUploadAuth(){try{await d.a.get().uploadDeviceSigningKeys(void 0,{}),c.a.log("uploadDeviceSigningKeys unexpectedly succeeded without UI auth!")}catch(e){if(!e.data||!e.data.flows)return void c.a.log("uploadDeviceSigningKeys advertised no flows!");const t=e.data.flows.some((e=>1===e.stages.length&&"m.login.password"===e.stages[0]));this.setState({canUploadKeysWithPasswordOnly:t})}}render(){let e;return e=this.state.error?i.a.createElement("div",null,i.a.createElement("p",null,Object(m.b)("Unable to set up keys")),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement(p.a,{primaryButton:Object(m.b)("Retry"),onPrimaryButtonClick:this.bootstrapCrossSigning,onCancel:this.onCancel}))):i.a.createElement("div",null,i.a.createElement(b.a,null)),i.a.createElement(g.a,{className:"mx_CreateCrossSigningDialog",onFinished:this.props.onFinished,title:Object(m.b)("Setting up keys"),hasCancel:!1,fixedWidth:!1},i.a.createElement("div",null,e))}}class E extends i.a.Component{render(){return i.a.createElement(s.a,null,i.a.createElement(o.a,null,i.a.createElement(f,{onFinished:this.props.onFinished,accountPassword:this.props.accountPassword,tokenLogin:this.props.tokenLogin})))}}},1754:function(e,t,a){"use strict";a.d(t,"a",(function(){return D}));var n=a(122),i=a.n(n),s=a(136),o=a(120),r=a.n(o),l=a(127),c=a.n(l),d=a(1),m=a(360),h=a(121),u=a(396),p=a(359),g=a(493),b=a(123),v=a(329),f=a(494),E=a(125),y=a(682),_=a(1018),S=a(700),w=a(124),O=a(501),C=a(519),x=a(548),j=a(135),k=a(550);function R(e){var t,a,n;let{title:i,icon:s,serverPicker:l,children:c}=e;const d=Object(o.useContext)(k.a);if(!d)return r.a.createElement(r.a.Fragment,null);const m=null!==(t=d.state[0])&&void 0!==t?t:null;return r.a.createElement(o.Fragment,null,null!==(a=null==m?void 0:m.icon)&&void 0!==a?a:s,r.a.createElement("h1",null,null!==(n=null==m?void 0:m.title)&&void 0!==n?n:i),c,!0!==(null==m?void 0:m.hideServerPicker)&&l)}var I=a(742),T=a(126);function N(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}const P=function(){if(T.b.getValue("debug_registration")){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];d.a.log.call(console,"Registration debuglog:",...t)}};class D extends r.a.Component{constructor(e){super(e),i()(this,"loginLogic",void 0),i()(this,"latestServerConfig",void 0),i()(this,"unloadCallback",(e=>{if(this.state.doingUIAuth)return e.preventDefault(),e.returnValue="",""})),i()(this,"onFormSubmit",(async e=>{this.setState({errorText:"",busy:!0,formVals:e,doingUIAuth:!0})})),i()(this,"requestEmailToken",((e,t,a,n)=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");return this.state.matrixClient.requestRegisterEmailToken(e,t,a,this.props.makeRegistrationUrl({client_secret:t,hs_url:this.state.matrixClient.getHomeserverUrl(),is_url:this.state.matrixClient.getIdentityServerUrl(),session_id:n}))})),i()(this,"onUIAuthFinished",(async(e,t)=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");if(P("Registration: ui authentication finished: ",{success:e,response:t}),!e){var a;let e=t.message||t.toString();if(t instanceof s.MatrixError&&"M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const a=Object(u.a)(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(h.d)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(h.d)("This homeserver has been blocked by its administrator."),"":Object(h.d)("This homeserver has exceeded one of its resource limits.")}),n=Object(u.a)(t.data.limit_type,t.data.admin_contact,{"":Object(h.d)("Please <a>contact your service administrator</a> to continue using this service.")});e=r.a.createElement("div",null,r.a.createElement("p",null,a),r.a.createElement("p",null,n))}else if(null!==(a=t.required_stages)&&void 0!==a&&a.includes(s.AuthType.Msisdn)){var n;(null!==(n=t.available_flows)&&void 0!==n?n:[]).some((e=>e.stages.includes(s.AuthType.Msisdn)))||(e=Object(h.b)("This server does not support authentication with a phone number."))}else t instanceof s.MatrixError&&"M_USER_IN_USE"===t.errcode?e=Object(h.b)("Someone already has that username, please try another."):t instanceof s.MatrixError&&"M_THREEPID_IN_USE"===t.errcode&&(e=Object(h.b)("That e-mail address or phone number is already in use."));return void this.setState({busy:!1,doingUIAuth:!1,errorText:e})}const i=t.user_id,o=t.access_token;if(!i||!o)throw new Error("Registration failed");b.a.setJustRegisteredUserId(i);const l={doingUIAuth:!1,registeredUsername:t.user_id,differentLoggedInUserId:void 0,completedNoSignin:!1,busy:!0},[c,m]=await g.b();c&&!m&&c!==t.user_id&&(d.a.log(`Found a session for ${c} but ${t.user_id} has just registered.`),l.differentLoggedInUserId=c);const p=Boolean(this.state.formVals.email),v=Boolean(t.access_token);P("Registration: ui auth finished:",{hasEmail:p,hasAccessToken:v}),p||!v||l.differentLoggedInUserId?(l.busy=!1,l.completedNoSignin=!0):(await this.props.onLoggedIn({userId:i,deviceId:t.device_id,homeserverUrl:this.state.matrixClient.getHomeserverUrl(),identityServerUrl:this.state.matrixClient.getIdentityServerUrl(),accessToken:o},this.state.formVals.password),this.setupPushers()),this.setState(l)})),i()(this,"onLoginClick",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()})),i()(this,"onGoToFormClicked",(e=>{e.preventDefault(),e.stopPropagation(),this.replaceClient(this.props.serverConfig),this.setState({busy:!1,doingUIAuth:!1})})),i()(this,"makeRegisterRequest",(e=>{if(!this.state.matrixClient)throw new Error("Matrix client has not yet been loaded");const t={username:this.state.formVals.username,password:this.state.formVals.password,initial_device_display_name:this.props.defaultDeviceDisplayName,auth:void 0,inhibit_login:void 0};return e&&(t.auth=e),P("Registration: sending registration request:",e),this.state.matrixClient.registerRequest(t)})),i()(this,"onLoginClickWithCheck",(async e=>{e.preventDefault();const t=await g.h({ignoreGuest:!0});return t||this.props.onLoginClick(),t})),this.state={busy:!1,errorText:null,formVals:{email:this.props.email},doingUIAuth:Boolean(this.props.sessionId),flows:null,completedNoSignin:!1,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""};const{hsUrl:t,isUrl:a}=this.props.serverConfig;this.loginLogic=new f.a(t,a,null,{defaultDeviceDisplayName:"Element login check"})}componentDidMount(){this.replaceClient(this.props.serverConfig),window.addEventListener("beforeunload",this.unloadCallback)}componentWillUnmount(){window.removeEventListener("beforeunload",this.unloadCallback)}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.replaceClient(this.props.serverConfig)}async replaceClient(e){this.latestServerConfig=e;const{hsUrl:t,isUrl:a}=e;this.setState({errorText:null,serverDeadError:null,serverErrorIsFatal:!1,busy:!0});try{if(await p.a.validateServerConfigWithStaticUrls(t,a),e!==this.latestServerConfig)return;this.setState({serverIsAlive:!0,serverErrorIsFatal:!1})}catch(t){if(e!==this.latestServerConfig)return;if(this.setState(function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?N(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):N(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({busy:!1},p.a.authComponentStateForError(t,"register"))),this.state.serverErrorIsFatal)return}const n=Object(s.createClient)({baseUrl:t,idBaseUrl:a});let o;this.loginLogic.setHomeserverUrl(t),this.loginLogic.setIdentityServerUrl(a);try{const t=await this.loginLogic.getFlows();if(e!==this.latestServerConfig)return;o=t.find((e=>"m.login.sso"===e.type||"m.login.cas"===e.type))}catch(t){if(e!==this.latestServerConfig)return;d.a.error("Failed to get login flows to check for SSO support",t)}this.setState({matrixClient:n,ssoFlow:o,busy:!1});try{if(!this.state.doingUIAuth){if(await this.makeRegisterRequest(null),e!==this.latestServerConfig)return;d.a.log("Expecting 401 from register request but got success!")}}catch(t){if(e!==this.latestServerConfig)return;401===t.httpStatus?this.setState({flows:t.data.flows}):403===t.httpStatus||"M_FORBIDDEN"===t.errcode?o?E.a.dispatch({action:"start_login"}):this.setState({serverErrorIsFatal:!0,errorText:Object(h.b)("Registration has been disabled on this homeserver."),flows:[]}):(d.a.log("Unable to query for supported registration methods.",t),this.setState({errorText:Object(h.b)("Unable to query for supported registration methods."),flows:[]}))}}setupPushers(){if(!this.props.brand)return Promise.resolve();const e=b.a.get();return e.getPushers().then((t=>{const a=t.pushers;for(let t=0;t<a.length;++t)if("email"===a[t].kind){const n=a[t];n.data={brand:this.props.brand},e.setPusher(n).then((()=>{d.a.log("Set email branding to "+this.props.brand)}),(e=>{d.a.error("Couldn't set email branding: "+e)}))}}),(e=>{d.a.error("Couldn't get pushers: "+e)}))}getUIAuthInputs(){return{emailAddress:this.state.formVals.email,phoneCountry:this.state.formVals.phoneCountry,phoneNumber:this.state.formVals.phoneNumber}}renderRegisterComponent(){if(this.state.matrixClient&&this.state.doingUIAuth)return r.a.createElement(x.b,{matrixClient:this.state.matrixClient,makeRequest:this.makeRegisterRequest,onAuthFinished:this.onUIAuthFinished,inputs:this.getUIAuthInputs(),requestEmailToken:this.requestEmailToken,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.idSid,poll:!0});if(!this.state.matrixClient&&!this.state.busy)return null;if(this.state.busy||!this.state.flows)return r.a.createElement("div",{className:"mx_AuthBody_spinner"},r.a.createElement(j.a,null));if(this.state.matrixClient&&this.state.flows.length){let e;if(this.state.ssoFlow){let t;(this.state.ssoFlow.identity_providers||[]).length>1&&(t=r.a.createElement("h2",{className:"mx_AuthBody_centered"},Object(h.b)("Continue with %(ssoButtons)s",{ssoButtons:""}).trim())),e=r.a.createElement(r.a.Fragment,null,t,r.a.createElement(y.a,{matrixClient:this.loginLogic.createTemporaryClient(),flow:this.state.ssoFlow,loginType:"m.login.sso"===this.state.ssoFlow.type?"sso":"cas",fragmentAfterLogin:this.props.fragmentAfterLogin,action:m.c.REGISTER}),r.a.createElement("h2",{className:"mx_AuthBody_centered"},Object(h.b)("%(ssoButtons)s Or %(usernamePassword)s",{ssoButtons:"",usernamePassword:""}).trim()))}return r.a.createElement(r.a.Fragment,null,e,r.a.createElement(S.b,{defaultUsername:this.state.formVals.username,defaultEmail:this.state.formVals.email,defaultPhoneCountry:this.state.formVals.phoneCountry,defaultPhoneNumber:this.state.formVals.phoneNumber,defaultPassword:this.state.formVals.password,onRegisterClick:this.onFormSubmit,flows:this.state.flows,serverConfig:this.props.serverConfig,canSubmit:!this.state.serverErrorIsFatal,matrixClient:this.state.matrixClient}))}return null}render(){let e;const t=this.state.errorText;let a;if(t&&(e=r.a.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=c()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});a=r.a.createElement("div",{className:e},this.state.serverDeadError)}const n=r.a.createElement("span",{className:"mx_AuthBody_changeFlow"},Object(h.b)("Already have an account? <a>Sign in here</a>",{},{a:e=>r.a.createElement(w.a,{kind:"link_inline",onClick:this.onLoginClick},e)}));let i,s;if(this.state.doingUIAuth&&(i=r.a.createElement(w.a,{kind:"link",className:"mx_AuthBody_changeFlow",onClick:this.onGoToFormClicked},Object(h.b)("Go back"))),this.state.completedNoSignin){let e;e=this.state.differentLoggedInUserId?r.a.createElement("div",null,r.a.createElement("p",null,Object(h.b)("Your new account (%(newAccountId)s) is registered, but you're already logged into a different account (%(loggedInUserId)s).",{newAccountId:this.state.registeredUsername,loggedInUserId:this.state.differentLoggedInUserId})),r.a.createElement("p",null,r.a.createElement(w.a,{kind:"link_inline",onClick:async e=>{await this.onLoginClickWithCheck(e)&&E.a.dispatch({action:"view_welcome_page"})}},Object(h.b)("Continue with previous account")))):r.a.createElement("h2",null,Object(h.b)("<a>Log in</a> to your new account.",{},{a:e=>r.a.createElement(w.a,{kind:"link_inline",onClick:async e=>{await this.onLoginClickWithCheck(e)&&E.a.dispatch({action:"view_home_page"})}},e)})),s=r.a.createElement("div",null,r.a.createElement("h1",null,Object(h.b)("Registration Successful")),e)}else s=r.a.createElement(o.Fragment,null,r.a.createElement("div",{className:"mx_Register_mainContent"},r.a.createElement(R,{title:Object(h.b)("Create account"),serverPicker:r.a.createElement(_.a,{title:Object(h.b)("Host account on"),dialogTitle:Object(h.b)("Decide where your account is hosted"),serverConfig:this.props.serverConfig,onServerConfigChange:this.state.doingUIAuth?void 0:this.props.onServerConfigChange})},e,a),this.renderRegisterComponent()),r.a.createElement("div",{className:"mx_Register_footerActions"},i,n));return r.a.createElement(v.a,null,r.a.createElement(C.a,null),r.a.createElement(I.b,null,r.a.createElement(O.a,{flex:!0},s)))}}},1755:function(e,t,a){"use strict";a.d(t,"a",(function(){return V}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(190),l=a(127),c=a.n(l),d=a(1),m=a(360),h=a(121),u=a(494),p=a(132),g=a(396),b=a(359),v=a(329),f=a(158),E=a(126),y=a(157),_=a(124),S=a(204),w=a(141),O=a(680),C=a(500);let x,j,k;const R=/^[0-9()\-\s]*$/;var I=function(e){return e.Email="login_field_email",e.MatrixId="login_field_mxid",e.Phone="login_field_phone",e.Password="login_field_phone",e}(I||{});x=I.Email,j=I.Phone,k=I.MatrixId;class T extends o.a.PureComponent{constructor(e){super(e),i()(this,x,void 0),i()(this,j,void 0),i()(this,k,void 0),i()(this,"onForgotPasswordClick",(e=>{var t,a;e.preventDefault(),e.stopPropagation(),null===(t=(a=this.props).onForgotPasswordClick)||void 0===t||t.call(a)})),i()(this,"onSubmitForm",(async e=>{e.preventDefault();if(await this.verifyFieldsBeforeSubmit())switch(this.state.loginType){case I.Email:case I.MatrixId:this.props.onSubmit(this.props.username,void 0,void 0,this.state.password);break;case I.Phone:this.props.onSubmit(void 0,this.props.phoneCountry,this.props.phoneNumber,this.state.password)}})),i()(this,"onUsernameChanged",(e=>{var t,a;null===(t=(a=this.props).onUsernameChanged)||void 0===t||t.call(a,e.target.value)})),i()(this,"onUsernameBlur",(e=>{var t,a;null===(t=(a=this.props).onUsernameBlur)||void 0===t||t.call(a,e.target.value)})),i()(this,"onLoginTypeChange",(e=>{var t,a;const n=e.target.value;this.setState({loginType:n}),null===(t=(a=this.props).onUsernameChanged)||void 0===t||t.call(a,"")})),i()(this,"onPhoneCountryChanged",(e=>{var t,a;null===(t=(a=this.props).onPhoneCountryChanged)||void 0===t||t.call(a,e.iso2)})),i()(this,"onPhoneNumberChanged",(e=>{var t,a;null===(t=(a=this.props).onPhoneNumberChanged)||void 0===t||t.call(a,e.target.value)})),i()(this,"onPasswordChanged",(e=>{this.setState({password:e.target.value})})),i()(this,"validateUsernameRules",Object(S.a)({rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(h.b)("Enter username")}]})),i()(this,"onUsernameValidate",(async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(I.MatrixId,t.valid),t})),i()(this,"onEmailValidate",(e=>{this.markFieldValid(I.Email,e.valid)})),i()(this,"validatePhoneNumberRules",Object(S.a)({rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(h.b)("Enter phone number")},{key:"number",test:e=>{let{value:t}=e;return!t||R.test(t)},invalid:()=>Object(h.b)("That phone number doesn't look quite right, please check and try again")}]})),i()(this,"onPhoneNumberValidate",(async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(I.Password,t.valid),t})),i()(this,"validatePasswordRules",Object(S.a)({rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(h.b)("Enter password")}]})),i()(this,"onPasswordValidate",(async e=>{const t=await this.validatePasswordRules(e);return this.markFieldValid(I.Password,t.valid),t})),this.state={fieldValid:{},loginType:I.MatrixId,password:""}}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[this.state.loginType,I.Password];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const a=this.findFirstInvalidField(t);return!a||(a.focus(),a.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:a}=this.state;a[e]=t,this.setState({fieldValid:a})}renderLoginField(e,t){const a={error:!1};switch(e){case I.Email:return a.error=this.props.loginIncorrect&&!this.props.username,o.a.createElement(C.a,{id:"mx_LoginForm_email",className:c()(a),name:"username",autoComplete:"email",type:"email",key:"email_input",placeholder:"joe@example.com",value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onEmailValidate,fieldRef:e=>{this[I.Email]=e}});case I.MatrixId:return a.error=this.props.loginIncorrect&&!this.props.username,o.a.createElement(w.a,{id:"mx_LoginForm_username",className:c()(a),name:"username",autoComplete:"username",key:"username_input",type:"text",label:Object(h.b)("Username"),placeholder:Object(h.b)("Username").toLocaleLowerCase(),value:this.props.username,onChange:this.onUsernameChanged,onBlur:this.onUsernameBlur,disabled:this.props.busy,autoFocus:t,onValidate:this.onUsernameValidate,ref:e=>{this[I.MatrixId]=e}});case I.Phone:{a.error=this.props.loginIncorrect&&!this.props.phoneNumber;const e=o.a.createElement(O.a,{value:this.props.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChanged});return o.a.createElement(w.a,{id:"mx_LoginForm_phone",className:c()(a),name:"phoneNumber",autoComplete:"tel-national",key:"phone_input",type:"text",label:Object(h.b)("Phone"),value:this.props.phoneNumber,prefixComponent:e,onChange:this.onPhoneNumberChanged,disabled:this.props.busy,autoFocus:t,onValidate:this.onPhoneNumberValidate,ref:e=>{this[I.Password]=e}})}}}isLoginEmpty(){switch(this.state.loginType){case I.Email:case I.MatrixId:return!this.props.username;case I.Phone:return!this.props.phoneCountry||!this.props.phoneNumber}}render(){let e;this.props.onForgotPasswordClick&&(e=o.a.createElement(_.a,{className:"mx_Login_forgot",disabled:this.props.busy,kind:"link",onClick:this.onForgotPasswordClick},Object(h.b)("Forgot password?")));const t=c()({error:this.props.loginIncorrect&&!this.isLoginEmpty()}),a=!this.isLoginEmpty(),n=this.renderLoginField(this.state.loginType,!a);let i;return p.b.get().disable_3pid_login||(i=o.a.createElement("div",{className:"mx_Login_type_container"},o.a.createElement("label",{className:"mx_Login_type_label"},Object(h.b)("Sign in with")),o.a.createElement(w.a,{element:"select",value:this.state.loginType,onChange:this.onLoginTypeChange,disabled:this.props.busy},o.a.createElement("option",{key:I.MatrixId,value:I.MatrixId},Object(h.b)("Username")),o.a.createElement("option",{key:I.Email,value:I.Email},Object(h.b)("Email address")),o.a.createElement("option",{key:I.Password,value:I.Password},Object(h.b)("Phone"))))),o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onSubmitForm},i,n,o.a.createElement(w.a,{id:"mx_LoginForm_password",className:t,autoComplete:"current-password",type:"password",name:"password",label:Object(h.b)("Password"),value:this.state.password,onChange:this.onPasswordChanged,disabled:this.props.busy,autoFocus:a,onValidate:this.onPasswordValidate,ref:e=>this[I.Password]=e}),e,!this.props.busy&&o.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(h.b)("Sign in"),disabled:this.props.disableSubmit})))}}i()(T,"defaultProps",{onUsernameChanged:function(){},onUsernameBlur:function(){},onPhoneCountryChanged:function(){},onPhoneNumberChanged:function(){},loginIncorrect:!1,disableSubmit:!1});var N=a(211),P=a(135),D=a(682),M=a(1018),A=a(501),U=a(519),L=a(144);function F(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function B(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?F(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):F(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}Object(h.d)("Invalid homeserver discovery response"),Object(h.d)("Failed to get autodiscovery configuration from server"),Object(h.d)("Invalid base_url for m.homeserver"),Object(h.d)("Homeserver URL does not appear to be a valid Matrix homeserver"),Object(h.d)("Invalid identity server discovery response"),Object(h.d)("Invalid base_url for m.identity_server"),Object(h.d)("Identity server URL does not appear to be a valid identity server"),Object(h.d)("General failure");class V extends o.a.PureComponent{constructor(e){super(e),i()(this,"unmounted",!1),i()(this,"loginLogic",void 0),i()(this,"stepRendererMap",void 0),i()(this,"isBusy",(()=>!!this.state.busy||!!this.props.busy)),i()(this,"onPasswordLogin",(async(e,t,a,n)=>{if(!this.state.serverIsAlive){this.setState({busy:!0});let e=!0;try{await b.a.validateServerConfigWithStaticUrls(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.setState({serverIsAlive:!0,errorText:""})}catch(t){const a=b.a.authComponentStateForError(t);this.setState(B({busy:!1,busyLoggingIn:!1},a)),e=!a.serverErrorIsFatal}if(!e)return}this.setState({busy:!0,busyLoggingIn:!0,errorText:null,loginIncorrect:!1}),this.loginLogic.loginViaPassword(e,t,a,n).then((e=>{this.setState({serverIsAlive:!0}),this.props.onLoggedIn(e,n)}),(t=>{if(this.unmounted)return;let a;const n=e&&e.indexOf("@")>0;if(400===t.httpStatus&&n)a=Object(h.b)("This homeserver does not support login using email address.");else if("M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const e=Object(g.a)(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(h.d)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(h.d)("This homeserver has been blocked by its administrator."),"":Object(h.d)("This homeserver has exceeded one of its resource limits.")}),n=Object(g.a)(t.data.limit_type,t.data.admin_contact,{"":Object(h.d)("Please <a>contact your service administrator</a> to continue using this service.")});a=o.a.createElement("div",null,o.a.createElement("div",null,e),o.a.createElement("div",{className:"mx_Login_smallError"},n))}else a=401===t.httpStatus||403===t.httpStatus?"M_USER_DEACTIVATED"===t.errcode?Object(h.b)("This account has been deactivated."):p.b.get("disable_custom_urls")?o.a.createElement("div",null,o.a.createElement("div",null,Object(h.b)("Incorrect username and/or password.")),o.a.createElement("div",{className:"mx_Login_smallError"},Object(h.b)("Please note you are logging into the %(hs)s server, not matrix.org.",{hs:this.props.serverConfig.hsName}))):Object(h.b)("Incorrect username and/or password."):this.errorTextFromError(t);this.setState({busy:!1,busyLoggingIn:!1,errorText:a,loginIncorrect:401===t.httpStatus||403===t.httpStatus})}))})),i()(this,"onUsernameChanged",(e=>{this.setState({username:e})})),i()(this,"onUsernameBlur",(async e=>{const t="@"===e[0];if(this.setState({username:e,busy:t,errorText:null,canTryLogin:!0}),t){const t=e.split(":").slice(1).join(":");try{const e=await b.a.validateServerName(t);this.props.onServerConfigChange(e),this.setState({busy:!1})}catch(e){d.a.error("Problem parsing URL or unhandled error doing .well-known discovery:",e);let t=Object(h.b)("Failed to perform homeserver discovery");e.translatedMessage&&(t=e.translatedMessage);let a=t,n={};b.a.isLivelinessError(e)&&(a=this.state.errorText,n=b.a.authComponentStateForError(e)),this.setState(B({busy:!1,errorText:a},n))}}})),i()(this,"onPhoneCountryChanged",(e=>{this.setState({phoneCountry:e})})),i()(this,"onPhoneNumberChanged",(e=>{this.setState({phoneNumber:e})})),i()(this,"onRegisterClick",(e=>{e.preventDefault(),e.stopPropagation(),this.props.onRegisterClick()})),i()(this,"onTryRegisterClick",(e=>{var t,a;const n=null===(t=this.state.flows)||void 0===t?void 0:t.find((e=>"m.login.password"===e.type)),i=null===(a=this.state.flows)||void 0===a?void 0:a.find((e=>"m.login.sso"===e.type||"m.login.cas"===e.type));if(i&&!n){var s;e.preventDefault(),e.stopPropagation();const t="m.login.sso"===i.type?"sso":"cas";null===(s=f.a.get())||void 0===s||s.startSingleSignOn(this.loginLogic.createTemporaryClient(),t,this.props.fragmentAfterLogin,m.c.REGISTER)}else this.onRegisterClick(e)})),i()(this,"isSupportedFlow",(e=>!!this.stepRendererMap[e.type]||(d.a.log("Skipping flow",e,"due to unsupported login type",e.type),!1))),i()(this,"renderPasswordStep",(()=>o.a.createElement(T,{onSubmit:this.onPasswordLogin,username:this.state.username,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber,onUsernameChanged:this.onUsernameChanged,onUsernameBlur:this.onUsernameBlur,onPhoneCountryChanged:this.onPhoneCountryChanged,onPhoneNumberChanged:this.onPhoneNumberChanged,onForgotPasswordClick:this.props.onForgotPasswordClick,loginIncorrect:this.state.loginIncorrect,serverConfig:this.props.serverConfig,disableSubmit:this.isBusy(),busy:this.props.isSyncing||this.state.busyLoggingIn}))),i()(this,"renderSsoStep",(e=>{var t,a;const n=null===(t=this.state.flows)||void 0===t?void 0:t.find((t=>t.type==="m.login."+e));return o.a.createElement(D.a,{matrixClient:this.loginLogic.createTemporaryClient(),flow:n,loginType:e,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!(null!==(a=this.state.flows)&&void 0!==a&&a.find((e=>"m.login.password"===e.type))),action:m.c.LOGIN})})),this.state={busy:!1,errorText:null,loginIncorrect:!1,canTryLogin:!0,username:e.defaultUsername?e.defaultUsername:"",phoneCountry:"",phoneNumber:"",serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.stepRendererMap={"m.login.password":this.renderPasswordStep,"m.login.cas":()=>this.renderSsoStep("cas"),"m.login.sso":()=>this.renderSsoStep("sso")}}componentDidMount(){this.initLoginLogic(this.props.serverConfig)}componentWillUnmount(){this.unmounted=!0}componentDidUpdate(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.initLoginLogic(this.props.serverConfig)}async initLoginLogic(e){let{hsUrl:t,isUrl:a}=e,n=!1;this.props.serverConfig.isDefault&&t===this.props.serverConfig.hsUrl&&a===this.props.serverConfig.isUrl&&(n=!0);const i=n?this.props.fallbackHsUrl:null,s=new u.a(t,a,i,{defaultDeviceDisplayName:this.props.defaultDeviceDisplayName});this.loginLogic=s,this.setState({busy:!0,loginIncorrect:!1});try{const{warning:e}=await b.a.validateServerConfigWithStaticUrls(t,a);e?this.setState(B(B({},b.a.authComponentStateForError(e)),{},{errorText:""})):this.setState({serverIsAlive:!0,errorText:""})}catch(e){this.setState(B({busy:!1},b.a.authComponentStateForError(e)))}s.getFlows().then((e=>{const t=e.filter(this.isSupportedFlow);t.length>0?this.setState({flows:t}):this.setState({errorText:Object(h.b)("This homeserver doesn't offer any login flows which are supported by this client.")})}),(e=>{this.setState({errorText:this.errorTextFromError(e),loginIncorrect:!1,canTryLogin:!1})})).finally((()=>{this.setState({busy:!1})}))}errorTextFromError(e){let t=e.errcode;!t&&e.httpStatus&&(t="HTTP "+e.httpStatus);let a=Object(h.b)("There was a problem communicating with the homeserver, please try again later.")+(t?" ("+t+")":"");return e instanceof r.b&&(a="https:"!==window.location.protocol||!this.props.serverConfig.hsUrl.startsWith("http:")&&this.props.serverConfig.hsUrl.startsWith("http")?o.a.createElement("span",null,Object(h.b)("Can't connect to homeserver - please check your connectivity, ensure your <a>homeserver's SSL certificate</a> is trusted, and that a browser extension is not blocking requests.",{},{a:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:this.props.serverConfig.hsUrl},e)})):o.a.createElement("span",null,Object(h.b)("Can't connect to homeserver via HTTP when an HTTPS URL is in your browser bar. Either use HTTPS or <a>enable unsafe scripts</a>.",{},{a:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://www.google.com/search?&q=enable%20unsafe%20scripts"},e)}))),a}renderLoginComponentForFlows(){if(!this.state.flows)return null;const e=Object(L.n)(["m.login.password","m.login.sso"].map((e=>{var t;return null===(t=this.state.flows)||void 0===t?void 0:t.find((t=>t.type===e))})));return o.a.createElement(o.a.Fragment,null,e.map((e=>{const t=this.stepRendererMap[e.type];return o.a.createElement(o.a.Fragment,{key:e.type},t())})))}render(){const e=this.isBusy()&&!this.state.busyLoggingIn?o.a.createElement("div",{className:"mx_Login_loader"},o.a.createElement(P.a,null)):null,t=this.state.errorText;let a,n,i;if(t&&(a=o.a.createElement("div",{className:"mx_Login_error"},t)),!this.state.serverIsAlive){const e=c()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});n=o.a.createElement("div",{className:e},this.state.serverDeadError)}return this.props.isSyncing||this.state.busyLoggingIn?i=o.a.createElement("div",{className:"mx_AuthBody_paddedFooter"},o.a.createElement("div",{className:"mx_AuthBody_paddedFooter_title"},o.a.createElement(N.a,{w:20,h:20}),this.props.isSyncing?Object(h.b)("Syncing…"):Object(h.b)("Signing In…")),this.props.isSyncing&&o.a.createElement("div",{className:"mx_AuthBody_paddedFooter_subtitle"},Object(h.b)("If you've joined lots of rooms, this might take a while"))):E.b.getValue(y.b.Registration)&&(i=o.a.createElement("span",{className:"mx_AuthBody_changeFlow"},Object(h.b)("New? <a>Create account</a>",{},{a:e=>o.a.createElement(_.a,{kind:"link_inline",onClick:this.onTryRegisterClick},e)}))),o.a.createElement(v.a,null,o.a.createElement(U.a,{disableLanguageSelector:this.props.isSyncing||this.state.busyLoggingIn}),o.a.createElement(A.a,null,o.a.createElement("h1",null,Object(h.b)("Sign in"),e),a,n,o.a.createElement(M.a,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange}),this.renderLoginComponentForFlows(),i))}}},1756:function(e,t,a){"use strict";a.d(t,"b",(function(){return r})),a.d(t,"a",(function(){return o}));var n=a(122),i=a.n(n),s=a(1);let o=function(e){return e.APP_STARTUP="mx_AppStartup",e.PAGE_CHANGE="mx_PageChange",e.RESEND_EVENT="mx_ResendEvent",e.SEND_E2EE_EVENT="mx_SendE2EEEvent",e.SEND_ATTACHMENT="mx_SendAttachment",e.SWITCH_ROOM="mx_SwithRoom",e.JUMP_TO_ROOM="mx_JumpToRoom",e.JOIN_ROOM="mx_JoinRoom",e.CREATE_DM="mx_CreateDM",e.PEEK_ROOM="mx_PeekRoom",e.VERIFY_E2EE_USER="mx_VerifyE2EEUser",e.LOGIN="mx_Login",e.REGISTER="mx_Register",e.SETUP_VOIP_CALL="mx_SetupVoIPCall",e}({});class r{constructor(){i()(this,"START_PREFIX","start:"),i()(this,"STOP_PREFIX","stop:"),i()(this,"listeners",[]),i()(this,"entries",[])}static get instance(){return r._instance||(r._instance=new r),r._instance}start(e,t){if(!this.supportsPerformanceApi())return;const a=this.buildKey(e,t);performance.getEntriesByName(this.START_PREFIX+a).length>0?s.a.warn(`Recording already started for: ${e}`):performance.mark(this.START_PREFIX+a)}stop(e,t){if(!this.supportsPerformanceApi())return;const a=this.buildKey(e,t);if(0===performance.getEntriesByName(this.START_PREFIX+a).length)return void s.a.warn(`No recording started for: ${e}`);performance.mark(this.STOP_PREFIX+a),performance.measure(a,this.START_PREFIX+a,this.STOP_PREFIX+a),this.clear(e,t);const n=performance.getEntriesByName(a).pop();return this.entries.push(n),this.listeners.forEach((e=>{this.shouldEmit(e,n)&&e.callback([n])})),n}clear(e,t){if(!this.supportsPerformanceApi())return;const a=this.buildKey(e,t);performance.clearMarks(this.START_PREFIX+a),performance.clearMarks(this.STOP_PREFIX+a)}getEntries(){let{name:e,type:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.entries.filter((a=>{const n=!e||a.name===e,i=!t||a.entryType===t;return n&&i}))}addPerformanceDataCallback(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.listeners.push(e),t){const t=this.entries.filter((t=>this.shouldEmit(e,t)));t.length>0&&e.callback(t)}}removePerformanceDataCallback(e){e?this.listeners.splice(this.listeners.findIndex((t=>t.callback===e)),1):this.listeners=[]}supportsPerformanceApi(){return void 0!==performance&&void 0!==performance.mark}shouldEmit(e,t){return!e.entryNames||e.entryNames.includes(t.name)}buildKey(e,t){return`${e}${t?`:${t}`:""}`}}i()(r,"_instance",void 0),window.mxPerformanceMonitor=r.instance,window.mxPerformanceEntryNames=o},1757:function(e,t,a){"use strict";a.d(t,"a",(function(){return k}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(1),l=a(360),c=a(121),d=a(125),m=a(493),h=a(129),u=a(123),p=a(494),g=a(329),b=a(358),v=a(682),f=a(137),E=a(148);class y extends o.a.Component{constructor(){super(...arguments),i()(this,"onConfirm",(()=>{this.props.onFinished(!0)})),i()(this,"onDecline",(()=>{this.props.onFinished(!1)}))}render(){return o.a.createElement(f.a,{className:"mx_ConfirmWipeDeviceDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.b)("Clear all data in this session?")},o.a.createElement("div",{className:"mx_ConfirmWipeDeviceDialog_content"},o.a.createElement("p",null,Object(c.b)("Clearing all data from this session is permanent. Encrypted messages will be lost unless their keys have been backed up."))),o.a.createElement(E.a,{primaryButton:Object(c.b)("Clear all data"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:Object(c.b)("Cancel"),onCancel:this.onDecline}))}}var _=a(141),S=a(124),w=a(135),O=a(519),C=a(501),x=function(e){return e[e.Loading=0]="Loading",e[e.Password=1]="Password",e[e.CAS=2]="CAS",e[e.SSO=3]="SSO",e[e.PasswordWithSocialSignOn=4]="PasswordWithSocialSignOn",e[e.Unsupported=5]="Unsupported",e}(x||{});const j={"m.login.password":x.Password,"m.login.cas":x.CAS,"m.login.sso":x.SSO};class k extends o.a.Component{constructor(e){super(e),i()(this,"onClearAll",(()=>{h.b.createDialog(y,{onFinished:e=>{e&&(r.a.log("Clearing data from soft-logged-out session"),m.i())}})})),i()(this,"onPasswordChange",(e=>{this.setState({password:e.target.value})})),i()(this,"onForgotPassword",(()=>{d.a.dispatch({action:"start_password_recovery"})})),i()(this,"onPasswordLogin",(async e=>{var t;e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});const a=u.a.get().getHomeserverUrl(),n=u.a.get().getIdentityServerUrl(),i={identifier:{type:"m.id.user",user:u.a.get().getUserId()},password:this.state.password,device_id:null!==(t=u.a.get().getDeviceId())&&void 0!==t?t:void 0};let s;try{s=await Object(p.b)(a,n,"m.login.password",i)}catch(e){let t=Object(c.b)("Failed to re-authenticate due to a homeserver problem");return"M_FORBIDDEN"!==e.errcode||401!==e.httpStatus&&403!==e.httpStatus||(t=Object(c.b)("Incorrect password")),void this.setState({busy:!1,errorText:t})}m.e(s).catch((e=>{r.a.error(e),this.setState({busy:!1,errorText:Object(c.b)("Failed to re-authenticate")})}))})),this.state={loginView:x.Loading,keyBackupNeeded:!0,busy:!1,password:"",errorText:"",flows:[]}}componentDidMount(){if(!m.g())return void d.a.dispatch({action:"start_login"});this.initLogin();const e=u.a.get();e.isCryptoEnabled()&&e.countSessionsNeedingBackup().then((e=>{this.setState({keyBackupNeeded:e>0})}))}async initLogin(){const e=this.props.realQueryParams;if(null==e?void 0:e.loginToken)return this.setState({loginView:x.Loading}),void this.trySsoLogin();const t=u.a.get(),a=(await t.loginFlows()).flows,n=a.map((e=>j[e.type])),i=n.includes(x.Password)&&n.includes(x.SSO),s=n.filter((e=>!!e))[0]||x.Unsupported,o=i?x.PasswordWithSocialSignOn:s;this.setState({flows:a,loginView:o})}async trySsoLogin(){var e;this.setState({busy:!0});const t=localStorage.getItem(b.a);if(!t)return r.a.error("Homeserver URL unknown for SSO login callback"),void this.setState({busy:!1,loginView:x.Unsupported});const a=localStorage.getItem(b.c)||u.a.get().getIdentityServerUrl(),n={token:this.props.realQueryParams.loginToken,device_id:null!==(e=u.a.get().getDeviceId())&&void 0!==e?e:void 0};let i;try{i=await Object(p.b)(t,a,"m.login.token",n)}catch(e){return r.a.error(e),void this.setState({busy:!1,loginView:x.Unsupported})}m.e(i).then((()=>{this.props.onTokenLoginCompleted&&this.props.onTokenLoginCompleted()})).catch((e=>{r.a.error(e),this.setState({busy:!1,loginView:x.Unsupported})}))}renderPasswordForm(e){let t;return this.state.errorText&&(t=o.a.createElement("span",{className:"mx_Login_error"},this.state.errorText)),o.a.createElement("form",{onSubmit:this.onPasswordLogin},e?o.a.createElement("p",null,e):null,t,o.a.createElement(_.a,{type:"password",label:Object(c.b)("Password"),onChange:this.onPasswordChange,value:this.state.password,disabled:this.state.busy}),o.a.createElement(S.a,{onClick:this.onPasswordLogin,kind:"primary",type:"submit",disabled:this.state.busy},Object(c.b)("Sign In")),o.a.createElement(S.a,{onClick:this.onForgotPassword,kind:"link"},Object(c.b)("Forgotten your password?")))}renderSsoForm(e){const t=this.state.loginView===x.CAS?"cas":"sso",a=this.state.flows.find((e=>e.type==="m.login."+t));return o.a.createElement("div",null,e?o.a.createElement("p",null,e):null,o.a.createElement(v.a,{matrixClient:u.a.get(),flow:a,loginType:t,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find((e=>"m.login.password"===e.type)),action:l.c.LOGIN}))}renderSignInSection(){if(this.state.loginView===x.Loading)return o.a.createElement(w.a,null);let e=null;return this.state.keyBackupNeeded&&(e=Object(c.b)("Regain access to your account and recover encryption keys stored in this session. Without them, you won't be able to read all of your secure messages in any session.")),this.state.loginView===x.Password?(e||(e=Object(c.b)("Enter your password to sign in and regain access to your account.")),this.renderPasswordForm(e)):this.state.loginView===x.SSO||this.state.loginView===x.CAS?(e||(e=Object(c.b)("Sign in and regain access to your account.")),this.renderSsoForm(e)):this.state.loginView===x.PasswordWithSocialSignOn?(e||(e=Object(c.b)("Sign in and regain access to your account.")),o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,e),this.renderSsoForm(null),o.a.createElement("h2",{className:"mx_AuthBody_centered"},Object(c.b)("%(ssoButtons)s Or %(usernamePassword)s",{ssoButtons:"",usernamePassword:""}).trim()),this.renderPasswordForm(null))):o.a.createElement("p",null,Object(c.b)("You cannot sign in to your account. Please contact your homeserver admin for more information."))}render(){return o.a.createElement(g.a,null,o.a.createElement(O.a,null),o.a.createElement(C.a,null,o.a.createElement("h1",null,Object(c.b)("You're signed out")),o.a.createElement("h2",null,Object(c.b)("Sign in")),o.a.createElement("div",null,this.renderSignInSection()),o.a.createElement("h2",null,Object(c.b)("Clear personal data")),o.a.createElement("p",null,Object(c.b)("Warning: your personal data (including encryption keys) is still stored in this session. Clear it if you're finished using this session, or want to sign in to another account.")),o.a.createElement("div",null,o.a.createElement(S.a,{onClick:this.onClearAll,kind:"danger"},Object(c.b)("Clear all data")))))}}},1761:function(e,t,a){"use strict";a.d(t,"a",(function(){return T}));var n=a(122),i=a.n(n),s=a(150),o=a(120),r=a.n(o),l=a(466),c=a(121),d=a(123),m=a(129),h=a(132),u=a(138),p=a(126),g=a(131),b=a.n(g),v=a(127),f=a.n(v),E=a(152);function y(e){let{label:t,description:a,onClick:n,isSelected:i,adornment:s}=e;return r.a.createElement(l.a,{active:i,className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--item",onClick:n},r.a.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},r.a.createElement("span",null,t),r.a.createElement("span",null,a)),s)}function _(e){let{label:t,description:a,adornment:n,children:i}=e;return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--header"},r.a.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},r.a.createElement("span",null,t),r.a.createElement("span",null,a)),n),i)}function S(e){return"options"in e}function w(e){let{value:t,onChange:a,options:n,selectedLabel:i,onOpen:s,onClose:o,toKey:l,className:c,AdditionalOptions:d}=e;const[m,h,u,p]=Object(E.q)(),g=n.flatMap((e=>S(e)?[e,...e.options]:[e])).find((e=>l?l(e.key)===l(t):e.key===t));let v;v=n&&S(n[0])?r.a.createElement(r.a.Fragment,null,n.map((e=>{var t;return r.a.createElement(_,{key:null!==(t=null==l?void 0:l(e.key))&&void 0!==t?t:e.key,label:e.label,description:e.description,adornment:e.adornment},e.options.map((e=>{var t;return r.a.createElement(y,{key:null!==(t=null==l?void 0:l(e.key))&&void 0!==t?t:e.key,label:e.label,description:e.description,onClick:t=>{a(e.key),p(),null==o||o(t)},adornment:e.adornment,isSelected:e===g})})))}))):r.a.createElement(r.a.Fragment,null,n.map((e=>{var t;return r.a.createElement(y,{key:null!==(t=null==l?void 0:l(e.key))&&void 0!==t?t:e.key,label:e.label,description:e.description,onClick:t=>{a(e.key),p(),null==o||o(t)},adornment:e.adornment,isSelected:e===g})})));const w=m&&h.current?r.a.createElement(E.n,b()({onFinished:p,chevronFace:E.a.Top,wrapperClassName:f()("mx_GenericDropdownMenu_wrapper",c)},Object(E.i)(h.current.getBoundingClientRect())),v,d&&r.a.createElement(d,{menuDisplayed:m,openMenu:u,closeMenu:p})):null;return r.a.createElement(r.a.Fragment,null,r.a.createElement(E.b,{className:"mx_GenericDropdownMenu_button",inputRef:h,isExpanded:m,onClick:e=>{u(),null==s||s(e)}},i(g)),w)}var O=a(600),C=a(124),x=a(204);function j(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}const k=Object(x.a)({deriveData:async e=>{let{value:t}=e;try{return await d.a.get().publicRooms({limit:1,server:null!=t?t:void 0}),{}}catch(e){return{error:e}}},rules:[{key:"required",test:async e=>{let{value:t}=e;return!!t},invalid:()=>Object(c.b)("Enter a server name")},{key:"available",final:!0,test:async(e,t)=>{let{error:a}=t;return!a},valid:()=>Object(c.b)("Looks good"),invalid:e=>{let{error:t}=e;return"M_FORBIDDEN"===(null==t?void 0:t.errcode)?Object(c.b)("You are not allowed to view this server's rooms list"):Object(c.b)("Can't find this server or its room list")}}]});function R(e){for(var t=arguments.length,a=new Array(t>1?t-1:0),n=1;n<t;n++)a[n-1]=arguments[n];for(const t of a)e.delete(t)}function I(){var e,t;const[a,n]=function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const[i,s]=Object(o.useState)(p.b.getValue(e,null!=a?a:void 0,n)),r=Object(o.useCallback)((async n=>{s(n),p.b.setValue(e,a,t,n)}),[t,a,e]);return Object(o.useEffect)((()=>{const t=p.b.watchSetting(e,a,(()=>{s(p.b.getValue(e,a,n))}));return()=>{p.b.unwatchSetting(t)}}),[e,a,n]),[i,r]}("room_directory_servers",u.a.ACCOUNT),i=d.a.getHomeserverName(),s=new Set(null!==(e=null===(t=h.b.getObject("room_directory"))||void 0===t?void 0:t.get("servers"))&&void 0!==e?e:[]);R(s,i);const r=new Set(a);return R(r,i),R(r,...s),{allServers:[i,...Array.from(s).sort(),...Array.from(r).sort()],homeServer:i,userDefinedServers:Array.from(r).sort(),setUserDefinedServers:n}}const T=e=>{let{protocols:t,config:a,setConfig:n}=e;const{allServers:d,homeServer:h,userDefinedServers:u,setUserDefinedServers:p}=I(),g=d.map((e=>function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?j(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):j(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({key:{roomServer:e,instanceId:void 0},label:e,description:e===h?Object(c.b)("Your server"):null,options:[{key:{roomServer:e,instanceId:void 0},label:Object(c.b)("Matrix")},...e===h&&t?Object.values(t).flatMap((e=>e.instances)).map((t=>({key:{roomServer:e,instanceId:t.instance_id},label:t.desc}))):[]]},u.includes(e)?{adornment:r.a.createElement(C.a,{className:"mx_NetworkDropdown_removeServer",alt:Object(c.b)("Remove server “%(roomServer)s”",{roomServer:e}),onClick:()=>p(Object(s.without)(u,e))})}:{}))),b=Object(o.useCallback)((e=>{let{closeMenu:t}=e;return r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"mx_GenericDropdownMenu_divider"}),r.a.createElement(l.a,{active:!1,className:"mx_GenericDropdownMenu_Option mx_GenericDropdownMenu_Option--item",onClick:async()=>{t();const{finished:e}=m.b.createDialog(O.a,{title:Object(c.b)("Add a new server"),description:Object(c.b)("Enter the name of a new server you want to explore."),button:Object(c.b)("Add"),hasCancel:!1,placeholder:Object(c.b)("Server name"),validator:k,fixedWidth:!1},"mx_NetworkDropdown_dialog"),[a,i]=await e;a&&(d.includes(i)||(p([...u,i]),n({roomServer:i})))}},r.a.createElement("div",{className:"mx_GenericDropdownMenu_Option--label"},r.a.createElement("span",{className:"mx_NetworkDropdown_addServer"},Object(c.b)("Add new server…")))))}),[d,n,p,u]);return r.a.createElement(w,{className:"mx_NetworkDropdown_wrapper",value:a,toKey:e=>e?`${e.roomServer}-${e.instanceId}`:"null",options:g,onChange:e=>n(e),selectedLabel:e=>null!=e&&e.key?Object(c.b)("Show: %(instance)s rooms (%(server)s)",{server:e.key.roomServer,instance:e.key.instanceId?e.label:"Matrix"}):Object(c.b)("Show: Matrix rooms"),AdditionalOptions:b})}},1768:function(e,t,a){"use strict";a.r(t),a.d(t,"loadApp",(function(){return S}));a(1633);var n=a(120),i=a.n(n),s=a(158),o=a(121),r=a(359),l=a(332),c=a(493),d=a(132),m=a(1),h=a(136),u=a(19),p=a(1645),g=a(32);let b=null;function v(e){const t=Object(g.b)(e);return{screen:t.location.substring(1),params:t.params}}function f(){decodeURIComponent(window.location.hash)!==b&&function(e){if(!window.matrixChat)return;m.a.log("Routing URL ",e.href);const t=v(e);window.matrixChat.showScreen(t.screen,t.params)}(window.location)}function E(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];m.a.log("newscreen "+e);const a="#/"+e;b=a,e.startsWith("room/")&&window.location.hash.includes("/$")===a.includes("/$")&&window.location.hash.startsWith(a)&&(t=!0),t?window.location.replace(a):window.location.assign(a)}function y(e){let t;t="vector:"===window.location.protocol?"https://app.element.io/#/register":window.location.protocol+"//"+window.location.host+window.location.pathname+"#/register";const a=Object.keys(e);for(let n=0;n<a.length;++n){t+=0===n?"?":"&";const i=a[n];t+=i+"="+encodeURIComponent(e[i])}return t}function _(){const e=new URL(window.location.href);e.searchParams.delete("loginToken"),m.a.log(`Redirecting to ${e.href} to drop loginToken from queryparams`),window.history.replaceState(null,"",e.href)}async function S(e){var t;window.addEventListener("hashchange",f);const a=s.a.get(),n=Object(g.a)(window.location),b=window.location.protocol+"//"+window.location.host+window.location.pathname;m.a.log("Vector starting at "+b),a.startUpdater();const S=await async function(){let e;try{m.a.log("Verifying homeserver configuration");const t=d.b.get();let a=t.default_server_config;const n=t.default_server_name,i=t.default_hs_url,s=t.default_is_url,c=[a,n,i].filter((e=>!!e));if(c.length>1)throw new o.a("Invalid configuration: can only specify one of default_server_config, default_server_name, or default_hs_url.");if(c.length<1)throw new o.a("Invalid configuration: no default server specified.");i&&(m.a.log("Config uses a default_hs_url - constructing a default_server_config using this information"),m.a.warn("DEPRECATED CONFIG OPTION: In the future, default_hs_url will not be accepted. Please use default_server_config instead."),a={"m.homeserver":{base_url:i}},s&&(a["m.identity_server"]={base_url:s}));let h=null;a&&(m.a.log("Config uses a default_server_config - validating object"),h=await l.a.fromDiscoveryConfig(a)),n&&(m.a.log("Config uses a default_server_name - doing .well-known lookup"),m.a.warn("DEPRECATED CONFIG OPTION: In the future, default_server_name will not be accepted. Please use default_server_config instead."),h=await l.a.findClientConfig(n)),e=r.a.buildValidatedConfigFromDiscovery(n,h,!0)}catch(t){const{hsUrl:a,isUrl:n,userId:i}=await c.c();if(!a||!i)throw t;m.a.error(t),m.a.warn("A session was found - suppressing config error and using the session's homeserver"),m.a.log("Using pre-existing hsUrl and isUrl: ",{hsUrl:a,isUrl:n}),e=await r.a.validateServerConfigWithStaticUrls(a,n,!0)}return e.isDefault=!0,m.a.log("Using homeserver config:",e),m.a.log("Updating SdkConfig with validated discovery information"),d.b.add({validated_server_config:e}),d.b.get()}(),w=new u.a(S),[O]=await c.b(),C=!!O,x=!!n.loginToken,j=Object(d.c)(S);let k=!0===j.immediate;const R="#/welcome"===window.location.hash||"#"===window.location.hash;if(!k&&j.on_welcome_page&&R&&(k=!0),!C&&!x&&k){m.a.log("Bypassing app load to redirect to SSO");const e=Object(h.createClient)({baseUrl:S.validated_server_config.hsUrl,idBaseUrl:S.validated_server_config.isUrl});return void s.a.get().startSingleSignOn(e,"sso",`/${v(window.location).screen}`)}const I=null!==(t=w.get("default_device_display_name"))&&void 0!==t?t:a.getDefaultDeviceDisplayName();return i.a.createElement(p.a,{onNewScreen:E,makeRegistrationUrl:y,config:S,realQueryParams:n,startingFragmentQueryParams:e,enableGuest:!S.disable_guests,onTokenLoginCompleted:_,initialScreenAfterLogin:v(window.location),defaultDeviceDisplayName:I})}window.React=i.a,m.a.log("Application is running in production mode"),window.matrixLogger=m.a},290:function(e,t,a){"use strict";var n=a(120),i=a.n(n),s=a(143),o=a(142);t.a=e=>{let{room:t,children:a}=e;const[r,l]=Object(n.useState)(null==t?void 0:t.name);return Object(o.c)(t,s.d.Name,(()=>{l(null==t?void 0:t.name)})),Object(n.useEffect)((()=>{l(null==t?void 0:t.name)}),[t]),a?a(r):i.a.createElement(i.a.Fragment,null,r||"")}},31:function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));let n=function(e){return e.CanChangeViewedRoom="io.element.view_room",e.RequiresClient="io.element.requires_client",e}({})},327:function(e,t,a){"use strict";var n=a(122),i=a.n(n),s=a(1),o=a(158),r=a(17),l=a(188),c=a(181),d=a(143),m=a(153),h=a(16),u=a(130),p=a(149),g=a(123),b=a(126),v=a(138);class f extends r.EventEmitter{constructor(){super(...arguments),i()(this,"crawlerCheckpoints",[]),i()(this,"crawler",null),i()(this,"currentCheckpoint",null),i()(this,"onSync",(async(e,t,a)=>{var n;const i=null===(n=o.a.get())||void 0===n?void 0:n.getEventIndexingManager();if(i){if("PREPARED"===t&&"SYNCING"===e){return await i.isEventIndexEmpty()&&await this.addInitialCheckpoints(),void this.startCrawler()}"SYNCING"===t&&"SYNCING"===e&&await i.commitLiveEvents()}})),i()(this,"onRoomTimeline",(async(e,t,a,n,i)=>{if(!t)return;const s=g.a.get();return s.isRoomEncrypted(e.getRoomId())?e.isRedaction()?this.redactEvent(e):void(!a&&i&&i.liveEvent&&!e.isRedacted()&&(await s.decryptEventIfNeeded(e),await this.addLiveEventToIndex(e))):void 0})),i()(this,"onRoomStateEvent",(async(e,t)=>{g.a.get().isRoomEncrypted(t.roomId)&&(e.getType()!==u.b.RoomEncryption||await this.isRoomIndexed(t.roomId)||(s.a.log("EventIndex: Adding a checkpoint for a newly encrypted room",t.roomId),this.addRoomCheckpoint(t.roomId,!0)))})),i()(this,"redactEvent",(async e=>{var t;const a=null===(t=o.a.get())||void 0===t?void 0:t.getEventIndexingManager();if(a)try{await a.deleteEvent(e.getAssociatedId())}catch(e){s.a.log("EventIndex: Error deleting event from index",e)}})),i()(this,"onTimelineReset",(async e=>{e&&g.a.get().isRoomEncrypted(e.roomId)&&(s.a.log("EventIndex: Adding a checkpoint because of a limited timeline",e.roomId),this.addRoomCheckpoint(e.roomId,!1))}))}async init(){var e;const t=null===(e=o.a.get())||void 0===e?void 0:e.getEventIndexingManager();t&&(this.crawlerCheckpoints=await t.loadCheckpoints(),s.a.log("EventIndex: Loaded checkpoints",this.crawlerCheckpoints),this.registerListeners())}registerListeners(){const e=g.a.get();e.on(p.b.Sync,this.onSync),e.on(d.d.Timeline,this.onRoomTimeline),e.on(d.d.TimelineReset,this.onTimelineReset),e.on(m.b.Events,this.onRoomStateEvent)}removeListeners(){const e=g.a.get();null!==e&&(e.removeListener(p.b.Sync,this.onSync),e.removeListener(d.d.Timeline,this.onRoomTimeline),e.removeListener(d.d.TimelineReset,this.onTimelineReset),e.removeListener(m.b.Events,this.onRoomStateEvent))}async addInitialCheckpoints(){var e;const t=null===(e=o.a.get())||void 0===e?void 0:e.getEventIndexingManager();if(!t)return;const a=g.a.get(),n=a.getRooms().filter((e=>a.isRoomEncrypted(e.roomId)));s.a.log("EventIndex: Adding initial crawler checkpoints"),await Promise.all(n.map((async e=>{const a=e.getLiveTimeline().getPaginationToken(c.a.Backward),n={roomId:e.roomId,token:a,direction:c.a.Backward,fullCrawl:!0},i={roomId:e.roomId,token:a,direction:c.a.Forward};try{n.token&&(await t.addCrawlerCheckpoint(n),this.crawlerCheckpoints.push(n)),i.token&&(await t.addCrawlerCheckpoint(i),this.crawlerCheckpoints.push(i))}catch(t){s.a.log("EventIndex: Error adding initial checkpoints for room",e.roomId,n,i,t)}})))}isValidEvent(e){const t=[u.b.RoomMessage,u.b.RoomName,u.b.RoomTopic].includes(e.getType())&&!e.isRedacted()&&!e.isDecryptionFailure();let a=!0,n=!0;if(e.getType()!==u.b.RoomMessage||e.isRedacted())e.getType()!==u.b.RoomTopic||e.isRedacted()?e.getType()!==u.b.RoomName||e.isRedacted()||e.getContent().name||(n=!1):e.getContent().topic||(n=!1);else{const t=e.getContent().msgtype;a=!!t&&!t.startsWith("m.key.verification"),e.getContent().body||(n=!1)}return t&&a&&n}eventToJson(e){const t=e.toJSON(),a=e.isEncrypted()?t.decrypted:t;return e.isEncrypted()?(a.curve25519Key=e.getSenderKey(),a.ed25519Key=e.getClaimedEd25519Key(),a.algorithm=e.getWireContent().algorithm,a.forwardingCurve25519KeyChain=e.getForwardingCurve25519KeyChain()):(delete a.curve25519Key,delete a.ed25519Key,delete a.algorithm,delete a.forwardingCurve25519KeyChain),a}async addLiveEventToIndex(e){var t,a,n;const i=null===(t=o.a.get())||void 0===t?void 0:t.getEventIndexingManager();if(!i||!this.isValidEvent(e))return;const s=this.eventToJson(e),r={displayname:null===(a=e.sender)||void 0===a?void 0:a.rawDisplayName,avatar_url:null===(n=e.sender)||void 0===n?void 0:n.getMxcAvatarUrl()};await i.addEventToIndex(s,r)}emitNewCheckpoint(){this.emit("changedCheckpoint",this.currentRoom())}async addEventsFromLiveTimeline(e){const t=e.getEvents();for(let e=0;e<t.length;e++){const a=t[e];await this.addLiveEventToIndex(a)}}async addRoomCheckpoint(e){var t;let a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=null===(t=o.a.get())||void 0===t?void 0:t.getEventIndexingManager();if(!n)return;const i=g.a.get().getRoom(e);if(!i)return;const r=i.getLiveTimeline(),l=r.getPaginationToken(c.a.Backward);if(!l)return void await this.addEventsFromLiveTimeline(r);const d={roomId:i.roomId,token:l,fullCrawl:a,direction:c.a.Backward};s.a.log("EventIndex: Adding checkpoint",d);try{await n.addCrawlerCheckpoint(d)}catch(e){s.a.log("EventIndex: Error adding new checkpoint for room",i.roomId,d,e)}this.crawlerCheckpoints.push(d)}async crawlerFunc(){var e;let t=!1;const a=g.a.get(),n=null===(e=o.a.get())||void 0===e?void 0:e.getEventIndexingManager();if(!n)return;this.crawler={cancel:()=>{t=!0}};let i=!1;for(;!t;){let e=b.b.getValueAt(v.a.DEVICE,"crawlerSleepTime");if(e=Math.max(e,100),i&&(e=5e3),null!==this.currentCheckpoint&&(this.currentCheckpoint=null,this.emitNewCheckpoint()),await Object(h.N)(e),t)break;const o=this.crawlerCheckpoints.shift();if(void 0===o){i=!0;continue}this.currentCheckpoint=o,this.emitNewCheckpoint(),i=!1;const r=a.getEventMapper({preventReEmit:!0});let l;try{l=await a.createMessagesRequest(o.roomId,o.token,100,o.direction)}catch(e){if(403===e.httpStatus){s.a.log("EventIndex: Removing checkpoint as we don't have ","permissions to fetch messages from this room.",o);try{await n.removeCrawlerCheckpoint(o)}catch(e){s.a.log("EventIndex: Error removing checkpoint",o,e)}continue}s.a.log("EventIndex: Error crawling using checkpoint:",o,",",e),this.crawlerCheckpoints.push(o);continue}if(t){this.crawlerCheckpoints.push(o);break}if(0===l.chunk.length){s.a.log("EventIndex: Done with the checkpoint",o);try{await n.removeCrawlerCheckpoint(o)}catch(e){s.a.log("EventIndex: Error removing checkpoint",o,e)}continue}const c=l.chunk.map(r);let d=[];void 0!==l.state&&(d=l.state.map(r));const m={};d.forEach((e=>{e.event.content&&"join"===e.event.content.membership&&(m[e.event.sender]={displayname:e.event.content.displayname,avatar_url:e.event.content.avatar_url})}));const u=c.filter((e=>e.isEncrypted())).map((e=>a.decryptEventIfNeeded(e,{isRetry:!0,emit:!1})));await Promise.all(u);const p=c.filter(this.isValidEvent),g=c.filter((e=>e.isRedaction())),f=p.map((e=>{const t=this.eventToJson(e);let a={};t.sender in m&&(a=m[t.sender]);return{event:t,profile:a}}));let E;l.end&&(E={roomId:o.roomId,token:l.end,fullCrawl:o.fullCrawl,direction:o.direction});try{for(let e=0;e<g.length;e++){const t=g[e],a=t.getAssociatedId();a?await n.deleteEvent(a):s.a.warn("EventIndex: Redaction event doesn't contain a valid associated event id",t)}const e=await n.addHistoricEvents(f,E,o);if(!E){s.a.log("EventIndex: The server didn't return a valid ","new checkpoint, not continuing the crawl.",o);continue}!0===e&&!0!==E.fullCrawl?(s.a.log("EventIndex: Checkpoint had already all events","added, stopping the crawl",o),await n.removeCrawlerCheckpoint(E)):(!0===e&&s.a.log("EventIndex: Checkpoint had already all events","added, but continuing due to a full crawl",o),this.crawlerCheckpoints.push(E))}catch(e){s.a.log("EventIndex: Error during a crawl",e),this.crawlerCheckpoints.push(o)}}this.crawler=null}startCrawler(){null===this.crawler&&this.crawlerFunc()}stopCrawler(){null!==this.crawler&&this.crawler.cancel()}async close(){var e;const t=null===(e=o.a.get())||void 0===e?void 0:e.getEventIndexingManager();this.removeListeners(),this.stopCrawler(),await(null==t?void 0:t.closeEventIndex())}async search(e){var t;const a=null===(t=o.a.get())||void 0===t?void 0:t.getEventIndexingManager();return null==a?void 0:a.searchEventIndex(e)}async loadFileEvents(e){var t;let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:c.b.BACKWARDS;const r=g.a.get(),d=null===(t=o.a.get())||void 0===t?void 0:t.getEventIndexingManager();if(!d)return[];const m={roomId:e.roomId,limit:a};let h;n&&(m.fromEvent=n,m.direction=i);try{h=await d.loadFileEvents(m)}catch(e){return s.a.log("EventIndex: Error getting file events",e),[]}const p=r.getEventMapper();return h.map((t=>{const a=p(t.event),n=new l.a(e.roomId,a.getSender());n.name=t.profile.displayname+" ("+a.getSender()+")";const i=p({content:{membership:"join",avatar_url:t.profile.avatar_url,displayname:t.profile.displayname},type:u.b.RoomMember,event_id:a.getId()+":eventIndex",room_id:a.getRoomId(),sender:a.getSender(),origin_server_ts:a.getTs(),state_key:a.getSender()});return n.events.member=i,a.sender=n,a}))}async populateFileTimeline(e,t,a){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,i=arguments.length>4?arguments[4]:void 0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:c.b.BACKWARDS;const r=await this.loadFileEvents(a,n,i,o);null===i&&(r.reverse(),o=o==c.b.BACKWARDS?c.b.FORWARDS:c.b.BACKWARDS),r.forEach((a=>{e.eventIdToTimeline(a.getId())||e.addEventToTimeline(a,t,o==c.b.BACKWARDS)}));let l=!1,d="";return r.length>0&&(d=r[r.length-1].getId(),l=!0),s.a.log("EventIndex: Populating file panel with",r.length,"events and setting the pagination token to",d),t.setPaginationToken(d,c.b.BACKWARDS),l}paginateTimelineWindow(e,t,a,n){const i=t.getTimelineIndex(a);if(!i)return Promise.resolve(!1);if(i.pendingPaginate)return i.pendingPaginate;if(t.extend(a,n))return Promise.resolve(!0);const s=(async(e,t,a,n,i)=>{var s;const o=t.timeline,r=o.getTimelineSet(),l=null!==(s=o.getPaginationToken(n))&&void 0!==s?s:void 0,c=await this.populateFileTimeline(r,o,a,i,l,n);return t.pendingPaginate=void 0,e.extend(n,i),c})(t,i,e,a,n);return i.pendingPaginate=s,s}async getStats(){var e;const t=null===(e=o.a.get())||void 0===e?void 0:e.getEventIndexingManager();return null==t?void 0:t.getStats()}async isRoomIndexed(e){var t;const a=null===(t=o.a.get())||void 0===t?void 0:t.getEventIndexingManager();return null==a?void 0:a.isRoomIndexed(e)}currentRoom(){if(null===this.currentCheckpoint&&0===this.crawlerCheckpoints.length)return null;const e=g.a.get();return null!==this.currentCheckpoint?e.getRoom(this.currentCheckpoint.roomId):e.getRoom(this.crawlerCheckpoints[0].roomId)}crawlingRooms(){const e=new Set,t=new Set;this.crawlerCheckpoints.forEach(((e,a)=>{t.add(e.roomId)})),null!==this.currentCheckpoint&&t.add(this.currentCheckpoint.roomId);const a=g.a.get();return a.getRooms().filter((e=>a.isRoomEncrypted(e.roomId))).forEach(((t,a)=>{e.add(t.roomId)})),{crawlingRooms:t,totalRooms:e}}}class E{constructor(){i()(this,"index",null),i()(this,"error",null),i()(this,"_supportIsInstalled",!1)}async init(){var e;const t=null===(e=o.a.get())||void 0===e?void 0:e.getEventIndexingManager();return t?(this._supportIsInstalled=await t.supportsEventIndexing(),this.supportIsInstalled()?b.b.getValueAt(v.a.DEVICE,"enableEventIndexing")?this.initEventIndex():(s.a.log("EventIndex: Event indexing is disabled, not initializing"),!1):(s.a.log("EventIndex: Event indexing isn't installed for the platform, not initializing."),!1)):(s.a.log("EventIndex: Platform doesn't support event indexing, not initializing."),!1)}async initEventIndex(){var e;const t=new f,a=null===(e=o.a.get())||void 0===e?void 0:e.getEventIndexingManager(),n=g.a.get();if(!a||!n)throw new Error("Unable to init event index");const i=n.getUserId(),r=n.getDeviceId();try{await a.initEventIndex(i,r);const e=await a.getUserVersion(),n=await a.isEventIndexEmpty();n?await a.setUserVersion(1):0!==e||n||(await a.closeEventIndex(),await this.deleteEventIndex(),await a.initEventIndex(i,r),await a.setUserVersion(1)),s.a.log("EventIndex: Successfully initialized the event index"),await t.init()}catch(e){return s.a.log("EventIndex: Error initializing the event index",e),this.error=e,!1}return this.index=t,!0}platformHasSupport(){var e;return null!=(null===(e=o.a.get())||void 0===e?void 0:e.getEventIndexingManager())}supportIsInstalled(){return this._supportIsInstalled}get(){return this.index}start(){null!==this.index&&this.index.startCrawler()}stop(){null!==this.index&&this.index.stopCrawler()}async unset(){null!==this.index&&(await this.index.close(),this.index=null)}async deleteEventIndex(){var e;const t=null===(e=o.a.get())||void 0===e?void 0:e.getEventIndexingManager();t&&(await this.unset(),s.a.log("EventIndex: Deleting event index."),await t.deleteEventIndex())}}window.mxEventIndexPeg||(window.mxEventIndexPeg=new E);t.a=window.mxEventIndexPeg},329:function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var n=a(322),i=a.n(n),s=a(120),o=a.n(s),r=a(132),l=a(121);var c=()=>{var e;const t=r.b.getObject("branding"),a=null!==(e=null==t?void 0:t.get("auth_footer_links"))&&void 0!==e?e:[{text:"About",url:"https://schildi.chat"},{text:"GitHub",url:"https://github.com/SchildiChat/schildichat-desktop"}],n=[];for(const e of a)n.push(o.a.createElement("a",{href:e.url,key:e.text,target:"_blank",rel:"noreferrer noopener"},e.text));return o.a.createElement("footer",{className:"mx_AuthFooter",role:"contentinfo"},n,o.a.createElement("a",{href:"https://matrix.org",target:"_blank",rel:"noreferrer noopener"},Object(l.b)("Powered by Matrix")))};class d extends s.PureComponent{static getWelcomeBackgroundUrl(){if(d.welcomeBackgroundUrl)return d.welcomeBackgroundUrl;const e=r.b.getObject("branding");d.welcomeBackgroundUrl="themes/element/img/backgrounds/ocean.jpg";const t=null==e?void 0:e.get("welcome_background_url");if(t)if(Array.isArray(t)){const e=Math.floor(Math.random()*t.length);d.welcomeBackgroundUrl=t[e]}else d.welcomeBackgroundUrl=t;return d.welcomeBackgroundUrl}render(){const e={background:`center/cover fixed url(${d.getWelcomeBackgroundUrl()})`},t={position:"absolute",top:0,right:0,bottom:0,left:0,filter:"blur(40px)",background:e.background};return s.createElement("div",{className:"mx_AuthPage",style:e},s.createElement("div",{className:"mx_AuthPage_modal",style:{position:"relative",background:"initial"}},s.createElement("div",{className:"mx_AuthPage_modalBlur",style:t}),s.createElement("div",{className:"mx_AuthPage_modalContent",style:{display:"flex",zIndex:1,background:"rgba(255, 255, 255, 0.59)",borderRadius:"3px"}},this.props.children)),s.createElement(c,null))}}i()(d,"welcomeBackgroundUrl",void 0)},359:function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var n=a(120),i=a.n(n),s=a(332),o=a(1),r=a(121),l=a(132);const c=[s.a.ERROR_INVALID_HOMESERVER,s.a.ERROR_INVALID_IDENTITY_SERVER];class d{static isLivelinessError(e){return!!e&&!!c.find((t=>"string"==typeof e?t===e:t===e.message))}static authComponentStateForError(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"login";if(!e)return{serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:null};let a=Object(r.b)("Cannot reach homeserver"),n=Object(r.b)("Ensure you have a stable internet connection, or get in touch with the server admin");if(!d.isLivelinessError(e)){const e=l.b.get().brand;a=Object(r.b)("Your %(brand)s is misconfigured",{brand:e}),n=Object(r.b)("Ask your %(brand)s admin to check <a>your config</a> for incorrect or duplicate entries.",{brand:e},{a:e=>i.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/master/docs/config.md",target:"_blank",rel:"noreferrer noopener"},e)})}let o=!0;return("string"==typeof e?e:e.message)===s.a.ERROR_INVALID_IDENTITY_SERVER&&(o=!1,a=Object(r.b)("Cannot reach identity server"),n="register"===t?Object(r.b)("You can register, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):"reset_password"===t?Object(r.b)("You can reset your password, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):Object(r.b)("You can log in, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin.")),{serverIsAlive:!1,serverErrorIsFatal:o,serverDeadError:i.a.createElement("div",null,i.a.createElement("strong",null,a),i.a.createElement("div",null,n))}}static async validateServerConfigWithStaticUrls(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e)throw new r.a("No homeserver URL provided");const n={"m.homeserver":{base_url:e}};t&&(n["m.identity_server"]={base_url:t});const i=await s.a.fromDiscoveryConfig(n),o=new URL(e).hostname;return d.buildValidatedConfigFromDiscovery(o,i,a,!0)}static async validateServerName(e){const t=await s.a.findClientConfig(e);return d.buildValidatedConfigFromDiscovery(e,t)}static buildValidatedConfigFromDiscovery(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!t||!t["m.homeserver"])throw o.a.error("Ended up in a state of not knowing which homeserver to connect to."),new r.a("Unexpected error resolving homeserver configuration");const i=t["m.homeserver"],c=t["m.identity_server"],m=l.b.get("validated_server_config");let h=m&&m.isUrl;var u;if(c&&c.state===s.a.SUCCESS)h=null!==(u=c.base_url)&&void 0!==u?u:void 0;else if(c&&c.state!==s.a.PROMPT){if(o.a.error("Error determining preferred identity server URL:",c),c.state===s.a.FAIL_ERROR){if(-1!==s.a.ALL_ERRORS.indexOf(c.error))throw new r.a(String(c.error));throw new r.a("Unexpected error resolving identity server configuration")}i.error=s.a.ERROR_INVALID_IDENTITY_SERVER,c.base_url&&(h=c.base_url)}if(i.state!==s.a.SUCCESS&&(o.a.error("Error processing homeserver config:",i),!a||!d.isLivelinessError(i.error))){if(-1!==s.a.ALL_ERRORS.indexOf(i.error))throw new r.a(String(i.error));throw new r.a("Unexpected error resolving homeserver configuration")}const p=i.base_url;if(!p)throw o.a.error("No homeserver URL configured"),new r.a("Unexpected error resolving homeserver configuration");let g=e||i.server_name;const b=new URL(p);if(g||(g=b.hostname),!g)throw o.a.error("Failed to parse homeserver name from homeserver URL"),new r.a("Unexpected error resolving homeserver configuration");return{hsUrl:p,hsName:g,hsNameIsDifferent:b.hostname!==g,isUrl:h,isDefault:!1,warning:i.error,isNameResolvable:!n}}}},360:function(e,t,a){"use strict";a.d(t,"a",(function(){return n})),a.d(t,"b",(function(){return i})),a.d(t,"c",(function(){return s}));const n=new(a(15).c)("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility");let i=function(e){return e.Gitlab="gitlab",e.Github="github",e.Apple="apple",e.Google="google",e.Facebook="facebook",e.Twitter="twitter",e}({}),s=function(e){return e.LOGIN="login",e.REGISTER="register",e}({})},361:function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));let n=function(e){return e.Verified="Verified",e.Unverified="Unverified",e.Inactive="Inactive",e.Unverifiable="Unverifiable",e}({})},362:function(e,t,a){"use strict";var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(127),l=a.n(r),c=a(132),d=a(204),m=a(121),h=a(141);class u extends s.PureComponent{constructor(){super(...arguments),i()(this,"validate",Object(d.a)({description:function(e){const t=e?e.score:0;return o.a.createElement("progress",{className:"mx_PassphraseField_progress",max:4,value:t})},deriveData:async e=>{let{value:t}=e;if(!t)return null;const{scorePassword:n}=await Promise.all([a.e(31),a.e(43)]).then(a.bind(null,1e3));return n(t)},rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(m.b)(this.props.labelEnterPassword)},{key:"complexity",test:async function(e,t){let{value:a}=e;if(!a||!t)return!1;const n=t.score>=this.props.minScore;return c.b.get("dangerously_allow_unsafe_and_insecure_passwords")||n},valid:function(e){return e&&e.score>=this.props.minScore?Object(m.b)(this.props.labelStrongPassword):Object(m.b)(this.props.labelAllowedButUnsafe)},invalid:function(e){if(!e)return null;const{feedback:t}=e;return t.warning||t.suggestions[0]||Object(m.b)("Keep going…")}}]})),i()(this,"onValidate",(async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t}))}render(){return o.a.createElement(h.a,{id:this.props.id,autoFocus:this.props.autoFocus,className:l()("mx_PassphraseField",this.props.className),ref:this.props.fieldRef,type:"password",autoComplete:"new-password",label:Object(m.b)(this.props.label),value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate})}}i()(u,"defaultProps",{label:Object(m.d)("Password"),labelEnterPassword:Object(m.d)("Enter password"),labelStrongPassword:Object(m.d)("Nice, strong password!"),labelAllowedButUnsafe:Object(m.d)("Password is allowed, but unsafe")}),t.a=u},363:function(e,t,a){"use strict";a.d(t,"a",(function(){return Ft}));var n=a(131),i=a.n(n),s=a(122),o=a.n(s),r=a(120),l=a.n(r),c=a(127),d=a.n(c),m=a(130),h=a(146),u=a(171),p=a(1),g=a(143),b=a(191),v=a(172),f=a(121),E=a(125),y=a(168),_=a(126),S=a(218),w=a(128),O=a(135),C=a(1028),x=a(693),j=a(124),k=a(217),R=a(139),I=a(123);class T extends l.a.Component{constructor(e,t){super(e,t),o()(this,"context",void 0),o()(this,"unmounted",!1),o()(this,"room",void 0),o()(this,"blockquoteRef",l.a.createRef()),o()(this,"canCollapse",(()=>this.state.events.length>1)),o()(this,"collapse",(()=>{this.initialize()})),o()(this,"onQuoteClick",(async()=>{if(!this.state.loadedEv)return;const e=[this.state.loadedEv,...this.state.events];let t=null;e.length>0&&(t=await this.getNextEvent(e[0])),this.setState({loadedEv:t,events:e}),E.a.fire(w.a.FocusSendMessageComposer)})),this.state={events:[],loadedEv:null,loading:!0,err:!1},this.room=this.matrixClient.getRoom(this.props.parentEv.getRoomId())}get matrixClient(){return I.a.get()}componentDidMount(){this.initialize(),this.trySetExpandableQuotes()}componentDidUpdate(){this.props.onHeightChanged(),this.trySetExpandableQuotes()}componentWillUnmount(){this.unmounted=!0}trySetExpandableQuotes(){if(void 0===this.props.isQuoteExpanded&&this.blockquoteRef.current){const e=this.blockquoteRef.current.querySelector(".mx_EventTile_body");if(e){const t=e.querySelector("code"),a=!!t&&t.offsetHeight>=60;(e.offsetHeight>=60||a)&&this.props.setQuoteExpanded(!1)}}}async initialize(){const{parentEv:e}=this.props,t=await this.getEvent(Object(k.b)(e));if(!this.unmounted)if(t){const e=await this.getNextEvent(t);this.setState({events:[t],loadedEv:e,loading:!1})}else this.setState({err:!0})}async getNextEvent(e){try{const t=Object(k.b)(e);return t?await this.getEvent(t):null}catch(e){return null}}async getEvent(e){var t;if(!e)return null;const a=this.room.findEventById(e);if(a)return a;try{await this.matrixClient.getEventTimeline(this.room.getUnfilteredTimelineSet(),e)}catch(e){return null}return null!==(t=this.room.findEventById(e))&&void 0!==t?t:null}getReplyChainColorClass(e){return Object(S.f)(this.props.userNameColorMode,e.getSender(),this.matrixClient.getRoom(e.getRoomId())).replace("Username","ReplyChain")}render(){let e;if(this.state.err)e=l.a.createElement("blockquote",{className:"mx_ReplyChain mx_ReplyChain_error"},Object(f.b)("Unable to load event that was replied to, it either does not exist or you do not have permission to view it."));else if(this.state.loadedEv&&Object(k.c)(this.state.events[0])){const t=this.state.loadedEv,a=this.matrixClient.getRoom(t.getRoomId());e=l.a.createElement("blockquote",{className:`mx_ReplyChain ${this.getReplyChainColorClass(t)}`},Object(f.b)("<a>In reply to</a> <pill>",{},{a:e=>l.a.createElement(j.a,{kind:"link_inline",className:"mx_ReplyChain_show",onClick:this.onQuoteClick},e),pill:l.a.createElement(x.a,{type:x.b.UserMention,room:null!=a?a:void 0,url:Object(y.i)(t.getSender()),shouldShowPillAvatar:_.b.getValue("Pill.shouldShowPillAvatar")})}))}else if(this.props.forExport){const t=Object(k.b)(this.props.parentEv);e=l.a.createElement("p",{className:"mx_ReplyChain_Export"},Object(f.b)("In reply to <a>this message</a>",{},{a:e=>l.a.createElement("a",{className:"mx_reply_anchor",href:`#${t}`,"data-scroll-to":t}," ",e," ")}))}else this.state.loading&&(e=l.a.createElement(O.a,{w:16,h:16}));const{isQuoteExpanded:t}=this.props,a=this.state.events.map((e=>{const a=d()({mx_ReplyChain:!0,[this.getReplyChainColorClass(e)]:!0,"mx_ReplyChain--expanded":!0===t,"mx_ReplyChain--collapsed":!1===t});return l.a.createElement("blockquote",{ref:this.blockquoteRef,className:a,key:e.getId()},l.a.createElement(C.a,{mxEvent:e,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator,userNameColorMode:this.props.userNameColorMode,toggleExpandedQuote:()=>this.props.setQuoteExpanded(!this.props.isQuoteExpanded),getRelationsForEvent:this.props.getRelationsForEvent}))}));return l.a.createElement("div",{className:"mx_ReplyChain_wrapper"},l.a.createElement("div",null,e),l.a.createElement("div",null,a))}}o()(T,"contextType",R.b);var N,P=a(173),D=a(165),M=a(925),A=a(272),U=a(166),L=a(692),F=a(152),B=a(193),V=a(164),W=a(345),z=a(249),H=a(158),K=a(175),G=a(957),q=a(834),$=a(207),Y=a(667);function J(){return J=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},J.apply(this,arguments)}function Q(e){return r.createElement("svg",J({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),N||(N=r.createElement("path",{d:"M3 14h12M5 10.5l7-7",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})))}var X,Z=a(959);function ee(){return ee=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},ee.apply(this,arguments)}function te(e){return r.createElement("svg",ee({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",role:"presentation","aria-hidden":!0},e),X||(X=r.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.523 2.964a6.418 6.418 0 0110.36 4.369h1.29c.26 0 .416.292.272.51l-2.006 3.011a.327.327 0 01-.544 0l-2.006-3.012a.327.327 0 01.272-.509h1.21a4.918 4.918 0 00-7.918-3.192 3.684 3.684 0 01-.184.136l-.014.01-.004.003-.002.001h-.001v.001l-.415-.625.414.625a.75.75 0 01-.83-1.25l.003-.001.02-.014a1.7 1.7 0 00.083-.063zm-.895 5.703H4.84a.327.327 0 00.272-.51L3.106 5.146a.327.327 0 00-.545 0L.555 8.157a.328.328 0 00.273.51h1.29a6.418 6.418 0 0010.503 4.251.75.75 0 00-.963-1.15 4.918 4.918 0 01-8.03-3.102z",clipRule:"evenodd"})))}var ae,ne;function ie(){return ie=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},ie.apply(this,arguments)}function se(e){return r.createElement("svg",ie({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),ae||(ae=r.createElement("path",{fill:"currentColor",d:"M5 5.25a.75.75 0 000 1.5h8a.75.75 0 000-1.5H5zm0 3a.75.75 0 000 1.5h4a.75.75 0 100-1.5H5z"})),ne||(ne=r.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M3 .25A2.75 2.75 0 00.25 3v14a.75.75 0 001.2.6L4.916 15c.217-.162.48-.25.75-.25H15A2.75 2.75 0 0017.75 12V3A2.75 2.75 0 0015 .25H3zM1.75 3c0-.69.56-1.25 1.25-1.25h12c.69 0 1.25.56 1.25 1.25v9c0 .69-.56 1.25-1.25 1.25H5.666a2.75 2.75 0 00-1.65.55L1.75 15.5V3z",clipRule:"evenodd"})))}var oe;function re(){return re=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},re.apply(this,arguments)}function le(e){return r.createElement("svg",re({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),oe||(oe=r.createElement("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v10zM18 4h-2.5l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6c-.55 0-1 .45-1 1s.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1z",fill:"currentColor"})))}var ce;function de(){return de=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},de.apply(this,arguments)}function me(e){return r.createElement("svg",de({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 21.87 20.801",role:"presentation","aria-hidden":!0},e),ce||(ce=r.createElement("path",{fill:"currentColor",d:"M4.178 20.801l6.758-4.91 6.756 4.91-2.58-7.946 6.758-4.91h-8.352L10.936 0 8.354 7.945H0l6.758 4.91-2.58 7.946z"})))}var he,ue=a(960);function pe(){return pe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},pe.apply(this,arguments)}function ge(e){return r.createElement("svg",pe({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 11 14",role:"presentation","aria-hidden":!0},e),he||(he=r.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M.22 8.494a.753.753 0 011.062-.002l3.724 3.7L8.718 8.48a.753.753 0 011.062-.002.747.747 0 01.002 1.06L5.54 13.78a.753.753 0 01-1.063.002L.221 9.552a.747.747 0 01-.002-1.058zm9.562-2.988a.753.753 0 01-1.062.002l-3.724-3.7L1.283 5.52a.753.753 0 01-1.062.002.747.747 0 01-.002-1.06L4.462.22A.753.753 0 015.524.218l4.257 4.23a.747.747 0 01.001 1.058z",clipRule:"evenodd"})))}var be;function ve(){return ve=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},ve.apply(this,arguments)}function fe(e){return r.createElement("svg",ve({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 11 14",role:"presentation","aria-hidden":!0},e),be||(be=r.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M.22.234A.753.753 0 011.281.232l3.724 3.7L8.718.22A.753.753 0 019.781.218a.747.747 0 01.001 1.06L5.54 5.52a.753.753 0 01-1.063.002L.221 1.292A.747.747 0 01.219.235zm9.562 13.532a.753.753 0 01-1.062.002l-3.724-3.7-3.713 3.712a.753.753 0 01-1.062.002.747.747 0 01-.002-1.06L4.462 8.48a.753.753 0 011.062-.002l4.257 4.23a.747.747 0 01.001 1.058z",clipRule:"evenodd"})))}var Ee=a(184),ye=a(405),_e=a(170),Se=a(469),we=a(520),Oe=a(911),Ce=a(910);class xe extends l.a.PureComponent{constructor(e){super(e),o()(this,"downloader",new Ce.a),o()(this,"onDownloadClick",(async()=>{if(this.state.loading)return;if(this.props.mediaEventHelperGet().media.isEncrypted&&this.setState({tooltip:Object(f.d)("Decrypting")}),this.setState({loading:!0}),this.state.blob)return this.doDownload(this.state.blob);const e=await this.props.mediaEventHelperGet().sourceBlob.value;this.setState({blob:e}),await this.doDownload(e)})),this.state={loading:!1,tooltip:Object(f.d)("Downloading")}}async doDownload(e){await this.downloader.download({blob:e,name:this.props.mediaEventHelperGet().fileName}),this.setState({loading:!1})}render(){let e;this.state.loading&&(e=l.a.createElement(O.a,{w:18,h:18}));const t=d()({mx_MessageActionBar_iconButton:!0,mx_MessageActionBar_downloadButton:!0,mx_MessageActionBar_downloadSpinnerButton:!!e});return l.a.createElement(_e.b,{className:t,title:e?Object(f.b)(this.state.tooltip):Object(f.b)("Download"),onClick:this.onDownloadClick,disabled:!!e},l.a.createElement(Oe.Icon,null),e)}}var je,ke,Re=a(593),Ie=a(401),Te=a(208),Ne=a(145);const Pe=JSON.parse(null!==(je=null===(ke=localStorage)||void 0===ke?void 0:ke.getItem("io_element_favouriteMessages"))&&void 0!==je?je:"[]");var De=a(268);const Me=e=>{let{mxEvent:t,getTile:a,getReplyChain:n,permalinkCreator:s,onFocusChange:o,getRelationsForEvent:c}=e;const[d,m,h,u]=Object(F.q)(),[p,g]=Object(_e.i)(m);Object(r.useEffect)((()=>{o(d)}),[o,d]);const b=Object(r.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),h(),p()}),[h,p]);let v;if(d&&m.current){const e=a&&a(),o=n(),r=m.current.getBoundingClientRect();v=l.a.createElement(L.a,i()({},Object(F.i)(r),{mxEvent:t,permalinkCreator:s,eventTileOps:e&&e.getEventTileOps?e.getEventTileOps():void 0,collapseReplyChain:null!=o&&o.canCollapse()?o.collapse:void 0,onFinished:u,getRelationsForEvent:c}))}return l.a.createElement(l.a.Fragment,null,l.a.createElement(F.c,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_optionsButton",title:Object(f.b)("Options"),onClick:b,onContextMenu:b,isExpanded:d,inputRef:m,onFocus:p,tabIndex:g?0:-1},l.a.createElement(Y.a,null)),v)},Ae=e=>{let{mxEvent:t,reactions:a,onFocusChange:n}=e;const[s,o,c,d]=Object(F.q)(),[m,h]=Object(_e.i)(o);let u;if(Object(r.useEffect)((()=>{n(s)}),[n,s]),s&&o.current){const e=o.current.getBoundingClientRect();u=l.a.createElement(F.n,i()({},Object(F.i)(e),{onFinished:d,managed:!1}),l.a.createElement(Re.a,{mxEvent:t,reactions:a,onFinished:d}))}const p=Object(r.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),c(),m()}),[c,m]);return l.a.createElement(l.a.Fragment,null,l.a.createElement(F.c,{className:"mx_MessageActionBar_iconButton",title:Object(f.b)("React"),onClick:p,onContextMenu:p,isExpanded:s,inputRef:o,onFocus:m,tabIndex:h?0:-1},l.a.createElement(Z.a,null)),u)},Ue=e=>{var t;let{mxEvent:a}=e;const n=Object(r.useContext)(Ie.a),i=null==a||null===(t=a.getRelation())||void 0===t?void 0:t.rel_type,s=!!i&&i!==m.h.Thread,o=e=>{e.preventDefault(),e.stopPropagation(),a.getThread()&&!a.isThreadRoot?E.b.dispatch({action:w.a.ShowThread,rootEvent:a.getThread().rootEvent,initialEvent:a,scroll_into_view:!0,highlighted:!0,push:n.isCard}):E.b.dispatch({action:w.a.ShowThread,rootEvent:a,push:n.isCard})};return l.a.createElement(_e.b,{className:"mx_MessageActionBar_iconButton mx_MessageActionBar_threadButton",disabled:s,tooltip:l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_Tooltip_title"},s?Object(f.b)("Can't create a thread from an event with an existing relation"):Object(f.b)("Reply in thread"))),title:s?Object(f.b)("Can't create a thread from an event with an existing relation"):Object(f.b)("Reply in thread"),onClick:o,onContextMenu:o},l.a.createElement(se,null))},Le=e=>{let{mxEvent:t}=e;const{isFavourite:a,toggleFavourite:n}=function(){const[,e]=Object(r.useState)(),t=e=>Pe.includes(e);return{isFavourite:t,toggleFavourite:a=>{t(a)?Pe.splice(Pe.indexOf(a),1):Pe.push(a),localStorage.setItem("io_element_favouriteMessages",JSON.stringify(Pe)),e([])}}}(),i=t.getId(),s=d()("mx_MessageActionBar_iconButton mx_MessageActionBar_favouriteButton",{mx_MessageActionBar_favouriteButton_fillstar:a(i)}),o=Object(r.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),n(i)}),[n,i]);return l.a.createElement(_e.b,{className:s,title:Object(f.b)("Favourite"),onClick:o,onContextMenu:o,"data-testid":i},l.a.createElement(me,null))};class Fe extends l.a.PureComponent{constructor(){super(...arguments),o()(this,"onDecrypted",(()=>{this.forceUpdate()})),o()(this,"onBeforeRedaction",(()=>{this.forceUpdate()})),o()(this,"onSent",(()=>{this.forceUpdate()})),o()(this,"onFocusChange",(e=>{var t,a;null===(t=(a=this.props).onFocusChange)||void 0===t||t.call(a,e)})),o()(this,"onReplyClick",(e=>{e.preventDefault(),e.stopPropagation(),E.a.dispatch({action:"reply_to_event",event:this.props.mxEvent,context:this.context.timelineRenderingType})})),o()(this,"onEditClick",(e=>{e.preventDefault(),e.stopPropagation(),Object(Ee.e)(this.props.mxEvent,this.context.timelineRenderingType,this.props.getRelationsForEvent)})),o()(this,"forbiddenThreadHeadMsgType",[m.e.KeyVerificationRequest]),o()(this,"onResendClick",(e=>{e.preventDefault(),e.stopPropagation(),this.runActionOnFailedEv((e=>Se.a.resend(e)))})),o()(this,"onCancelClick",(e=>{this.runActionOnFailedEv((e=>Se.a.removeFromQueue(e)),(e=>Object(Ee.b)(e.status)))}))}componentDidMount(){this.props.mxEvent.status&&this.props.mxEvent.status!==h.a.SENT&&this.props.mxEvent.on(h.c.Status,this.onSent);I.a.get().decryptEventIfNeeded(this.props.mxEvent),this.props.mxEvent.isBeingDecrypted()&&this.props.mxEvent.once(h.c.Decrypted,this.onDecrypted),this.props.mxEvent.on(h.c.BeforeRedaction,this.onBeforeRedaction)}componentWillUnmount(){this.props.mxEvent.off(h.c.Status,this.onSent),this.props.mxEvent.off(h.c.Decrypted,this.onDecrypted),this.props.mxEvent.off(h.c.BeforeRedaction,this.onBeforeRedaction)}get showReplyInThreadAction(){const e=this.context.timelineRenderingType!==R.a.Thread,t=!(this.forbiddenThreadHeadMsgType.includes(this.props.mxEvent.getContent().msgtype)||$.b.matches(this.props.mxEvent.getType())||this.props.mxEvent.getType()===De.b);return e&&t}runActionOnFailedEv(e,t){t||(t=()=>!0);const a=this.props.mxEvent,n=a.replacingEvent(),i=[a.localRedactionEvent(),n,a];for(const a of i)if(a&&t(a)){e(a);break}}render(){var e,t;const a=[];Object(Ee.c)(this.props.mxEvent)&&a.push(l.a.createElement(_e.b,{className:"mx_MessageActionBar_iconButton",title:Object(f.b)("Edit"),onClick:this.onEditClick,onContextMenu:this.onEditClick,key:"edit"},l.a.createElement(Q,null)));const n=l.a.createElement(_e.b,{className:"mx_MessageActionBar_iconButton",title:Object(f.b)("Delete"),onClick:this.onCancelClick,onContextMenu:this.onCancelClick,key:"cancel"},l.a.createElement(le,null)),i=l.a.createElement(Ue,{mxEvent:this.props.mxEvent,key:"reply_thread"}),s=this.props.mxEvent,o=null===(e=s.replacingEvent())||void 0===e?void 0:e.status,r=null===(t=s.localRedactionEvent())||void 0===t?void 0:t.status,c=Object(Ee.b)(s.status)||Object(Ee.b)(o)||Object(Ee.b)(r),m=[s.status,o,r].includes(h.a.NOT_SENT);if(c&&m)a.splice(0,0,l.a.createElement(_e.b,{className:"mx_MessageActionBar_iconButton",title:Object(f.b)("Retry"),onClick:this.onResendClick,onContextMenu:this.onResendClick,key:"resend"},l.a.createElement(te,null))),a.push(n);else{if(Object(Ee.k)(this.props.mxEvent)?(this.context.canSendMessages&&(this.showReplyInThreadAction&&a.splice(0,0,i),a.splice(0,0,l.a.createElement(_e.b,{className:"mx_MessageActionBar_iconButton",title:Object(f.b)("Reply"),onClick:this.onReplyClick,onContextMenu:this.onReplyClick,key:"reply"},l.a.createElement(ue.a,null)))),this.context.canReact&&a.splice(0,0,l.a.createElement(Ae,{mxEvent:this.props.mxEvent,reactions:this.props.reactions,onFocusChange:this.onFocusChange,key:"react"})),_.b.getValue("feature_favourite_messages")&&a.splice(-1,0,l.a.createElement(Le,{key:"favourite",mxEvent:this.props.mxEvent})),we.a.isEligible(this.props.mxEvent)&&a.splice(0,0,l.a.createElement(xe,{mxEvent:this.props.mxEvent,mediaEventHelperGet:()=>{var e,t,a,n;return null===(e=(t=this.props).getTile)||void 0===e||null===(a=(n=e.call(t)).getMediaHelper)||void 0===a?void 0:a.call(n)},key:"download"}))):this.context.timelineRenderingType===R.a.Room&&this.props.mxEvent.getThread()&&a.unshift(i),c&&a.push(n),void 0!==this.props.isQuoteExpanded&&Object(k.c)(this.props.mxEvent)){const e=d()({mx_MessageActionBar_iconButton:!0,mx_MessageActionBar_expandCollapseMessageButton:!0}),t=l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_Tooltip_title"},this.props.isQuoteExpanded?Object(f.b)("Collapse quotes"):Object(f.b)("Expand quotes")),l.a.createElement("div",{className:"mx_Tooltip_sub"},Object(f.b)(Ne.a[Te.b.SHIFT])+" + "+Object(f.b)("Click")));a.push(l.a.createElement(_e.b,{className:e,title:this.props.isQuoteExpanded?Object(f.b)("Collapse quotes"):Object(f.b)("Expand quotes"),tooltip:t,onClick:this.props.toggleThreadExpanded,key:"expand"},this.props.isQuoteExpanded?l.a.createElement(fe,null):l.a.createElement(ge,null)))}a.push(l.a.createElement(Me,{mxEvent:this.props.mxEvent,getReplyChain:this.props.getReplyChain,getTile:this.props.getTile,permalinkCreator:this.props.permalinkCreator,onFocusChange:this.onFocusChange,key:"menu",getRelationsForEvent:this.props.getRelationsForEvent}))}return l.a.createElement(ye.a,{className:"mx_MessageActionBar","aria-label":Object(f.b)("Message Actions"),"aria-live":"off"},a)}}o()(Fe,"contextType",R.b);var Be=a(370),Ve=a(342),We=a(201),ze=a(133);class He extends l.a.PureComponent{constructor(){super(...arguments),o()(this,"context",void 0)}render(){const{content:e,reactionEvents:t,mxEvent:a,visible:n}=this.props,i=this.context.getRoom(a.getRoomId());let s,o;if(i){const a=[];for(const e of t){var r;const t=i.getMember(e.getSender()),n=null!==(r=null==t?void 0:t.name)&&void 0!==r?r:e.getSender();a.push(n)}const n=Object(We.j)(e);s=l.a.createElement("div",null,Object(f.b)("<reactors/><reactedWith>reacted with %(shortName)s</reactedWith>",{shortName:n},{reactors:()=>l.a.createElement("div",{className:"mx_Tooltip_title"},Object(S.b)(a,6)),reactedWith:e=>n?l.a.createElement("div",{className:"mx_Tooltip_sub"},e):null}))}return s&&(o=l.a.createElement(V.b,{visible:n,label:s})),o}}o()(He,"contextType",ze.a);class Ke extends l.a.PureComponent{constructor(){super(...arguments),o()(this,"context",void 0),o()(this,"state",{tooltipRendered:!1,tooltipVisible:!1}),o()(this,"onClick",(()=>{const{mxEvent:e,myReactionEvent:t,content:a}=this.props;t?this.context.redactEvent(e.getRoomId(),t.getId()):(this.context.sendEvent(e.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:e.getId(),key:a}}),E.a.dispatch({action:"message_sent"}))})),o()(this,"onMouseOver",(()=>{this.setState({tooltipRendered:!0,tooltipVisible:!0})})),o()(this,"onMouseLeave",(()=>{this.setState({tooltipVisible:!1})}))}render(){const{mxEvent:e,content:t,count:a,reactionEvents:n,myReactionEvent:i}=this.props,s=d()({mx_ReactionsRowButton:!0,mx_ReactionsRowButton_selected:!!i});let o;this.state.tooltipRendered&&(o=l.a.createElement(He,{mxEvent:this.props.mxEvent,content:t,reactionEvents:n,visible:this.state.tooltipVisible}));const r=this.context.getRoom(e.getRoomId());let c;if(r){const e=[];for(const t of n){const a=r.getMember(t.getSender());e.push((null==a?void 0:a.name)||t.getSender())}const a=Object(S.b)(e,6);c=t?Object(f.b)("%(reactors)s reacted with %(content)s",{reactors:a,content:t}):a}return l.a.createElement(j.a,{className:s,"aria-label":c,onClick:this.onClick,disabled:this.props.disabled,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},l.a.createElement("span",{className:"mx_ReactionsRowButton_content","aria-hidden":"true"},t),l.a.createElement("span",{className:"mx_ReactionsRowButton_count","aria-hidden":"true"},a),o)}}o()(Ke,"contextType",ze.a);const Ge=e=>{let{mxEvent:t,reactions:a}=e;const[n,s,o,r]=Object(F.q)();let c;if(n&&s.current){const e=s.current.getBoundingClientRect();c=l.a.createElement(F.n,i()({},Object(F.i)(e),{onFinished:r,managed:!1}),l.a.createElement(Re.a,{mxEvent:t,reactions:a,onFinished:r}))}return l.a.createElement(l.a.Fragment,null,l.a.createElement(Ve.a,{className:d()("mx_ReactionsRow_addReactionButton",{mx_ReactionsRow_addReactionButton_active:n}),title:Object(f.b)("Add reaction"),onClick:o,onContextMenu:e=>{e.preventDefault(),o()},isExpanded:n,inputRef:s}),c)};class qe extends l.a.PureComponent{constructor(e,t){super(e,t),o()(this,"context",void 0),o()(this,"onDecrypted",(()=>{this.forceUpdate()})),o()(this,"onReactionsChange",(()=>{this.setState({myReactions:this.getMyReactions()}),this.forceUpdate()})),o()(this,"onShowAllClick",(()=>{this.setState({showAll:!0})})),this.context=t,this.state={myReactions:this.getMyReactions(),showAll:!1}}componentDidMount(){const{mxEvent:e,reactions:t}=this.props;(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&e.once(h.c.Decrypted,this.onDecrypted),t&&(t.on(Be.b.Add,this.onReactionsChange),t.on(Be.b.Remove,this.onReactionsChange),t.on(Be.b.Redaction,this.onReactionsChange))}componentWillUnmount(){const{mxEvent:e,reactions:t}=this.props;e.off(h.c.Decrypted,this.onDecrypted),t&&(t.off(Be.b.Add,this.onReactionsChange),t.off(Be.b.Remove,this.onReactionsChange),t.off(Be.b.Redaction,this.onReactionsChange))}componentDidUpdate(e){this.props.reactions&&e.reactions!==this.props.reactions&&(this.props.reactions.on(Be.b.Add,this.onReactionsChange),this.props.reactions.on(Be.b.Remove,this.onReactionsChange),this.props.reactions.on(Be.b.Redaction,this.onReactionsChange),this.onReactionsChange())}getMyReactions(){var e,t;const a=this.props.reactions;if(!a)return null;const n=null===(e=this.context.room)||void 0===e?void 0:e.client.getUserId();if(!n)return null;const i=null===(t=a.getAnnotationsBySender())||void 0===t?void 0:t[n];return i?[...i.values()]:null}render(){var e,t;const{mxEvent:a,reactions:n}=this.props,{myReactions:i,showAll:s}=this.state;if(!n||!Object(Ee.k)(a))return null;let o,r,c=null===(e=n.getSortedAnnotationsByKey())||void 0===e?void 0:e.map((e=>{let[t,n]=e;const s=n.size;if(!s)return null;const o=null==i?void 0:i.find((e=>{var a;return!e.isRedacted()&&(null===(a=e.getRelation())||void 0===a?void 0:a.key)===t}));return l.a.createElement(Ke,{key:t,content:t,count:s,mxEvent:a,reactionEvents:n,myReactionEvent:o,disabled:!this.context.canReact||o&&!o.isRedacted()&&!this.context.canSelfRedact})})).filter((e=>!!e));return null!==(t=c)&&void 0!==t&&t.length?(c.length>9&&!s&&(c=c.slice(0,8),o=l.a.createElement(j.a,{kind:"link_inline",className:"mx_ReactionsRow_showAll",onClick:this.onShowAllClick},Object(f.b)("Show all"))),this.context.canReact&&(r=l.a.createElement(Ge,{mxEvent:a,reactions:n})),l.a.createElement("div",{className:"mx_ReactionsRow",role:"toolbar","aria-label":Object(f.b)("Reactions")},c,o,r)):null}}o()(qe,"contextType",R.b);var $e=a(666),Ye=a(689),Je=a(230),Qe=a(961),Xe=a(556),Ze=a(163),et=a(129),tt=a(132),at=a(270),nt=a(594);class it extends l.a.Component{constructor(e){super(e),o()(this,"onBugReport",(()=>{et.b.createDialog(at.a,{label:"react-soft-crash-tile",error:this.state.error})})),o()(this,"onViewSource",(()=>{et.b.createDialog(nt.a,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource")})),this.state={}}static getDerivedStateFromError(e){return{error:e}}render(){if(this.state.error){const{mxEvent:e}=this.props,t={mx_EventTile:!0,mx_EventTile_info:!0,mx_EventTile_content:!0,mx_EventTile_tileError:!0};let a,n;tt.b.get().bug_report_endpoint_url&&(a=l.a.createElement(l.a.Fragment,null," ",l.a.createElement(j.a,{kind:"link",onClick:this.onBugReport},Object(f.b)("Submit logs")))),e&&_.b.getValue("developerMode")&&(n=l.a.createElement(l.a.Fragment,null," ",l.a.createElement(j.a,{onClick:this.onViewSource,kind:"link"},Object(f.b)("View Source"))));const i=l.a.createElement("span",null,Object(f.b)("Can't load this message"),e&&` (${e.getType()})`,a,n);return this.props.layout===P.a.Bubble?l.a.createElement("li",{className:d()(t),"data-layout":this.props.layout},l.a.createElement("div",{className:"mx_EventTile_line sc_EventTile_bubbleLine sc_EventTile_bubbleLine_info"},l.a.createElement("div",{className:"sc_EventTile_bubbleArea sc_EventTile_bubbleArea_center sc_EventTile_bubbleArea_info"},l.a.createElement("div",{className:"sc_EventTile_bubble sc_EventTile_bubble_info sc_EventTile_bubble_center"},i)))):l.a.createElement("li",{className:d()(t),"data-layout":this.props.layout},l.a.createElement("div",{className:"mx_EventTile_line"},i))}return this.props.children}}var st=a(243),ot=a(134),rt=a.n(ot),lt=a(142),ct=a(256);const dt=["mxEvent","thread"],mt=e=>{var t,a,n;let{thread:i,showDisplayname:s=!1}=e;const o=Object(r.useContext)(ze.a),c=null!==(t=Object(lt.d)(i,u.f.Update,(()=>i.replyToEvent)))&&void 0!==t?t:void 0,[d,m]=Object(r.useState)(null==c?void 0:c.getContent());Object(lt.c)(c,h.c.Replaced,(()=>{m(c.getContent())}));const p=(null==c?void 0:c.shouldAttemptDecryption())||(null==c?void 0:c.isBeingDecrypted());Object(lt.c)(p?c:void 0,h.c.Decrypted,(()=>{m(c.getContent())}));const g=Object(ct.a)((async()=>{if(c)return await o.decryptEventIfNeeded(c),Ye.a.instance.generatePreviewForEvent(c)}),[c,d]);return g&&c?l.a.createElement(l.a.Fragment,null,l.a.createElement(K.b,{member:c.sender,fallbackUserId:c.getSender(),width:24,height:24,className:"mx_ThreadSummary_avatar"}),s&&l.a.createElement("div",{className:"mx_ThreadSummary_sender"},null!==(a=null===(n=c.sender)||void 0===n?void 0:n.name)&&void 0!==a?a:c.getSender()),c.isDecryptionFailure()?l.a.createElement("div",{className:"mx_ThreadSummary_content mx_DecryptionFailureBody",title:Object(f.b)("Unable to decrypt message")},l.a.createElement("span",{className:"mx_ThreadSummary_message-preview"},Object(f.b)("Unable to decrypt message"))):l.a.createElement("div",{className:"mx_ThreadSummary_content",title:g},l.a.createElement("span",{className:"mx_ThreadSummary_message-preview"},g))):null};var ht=e=>{let{mxEvent:t,thread:a}=e,n=rt()(e,dt);const s=Object(r.useContext)(R.b),o=Object(r.useContext)(Ie.a),c=Object(lt.d)(a,u.f.Update,(()=>a.length));if(!c)return null;let d=c;return s.narrow||(d=Object(f.b)("%(count)s reply",{count:c})),l.a.createElement(j.a,i()({},n,{className:"mx_ThreadSummary",onClick:e=>{E.a.dispatch({action:w.a.ShowThread,rootEvent:t,push:o.isCard}),Ze.b.trackInteraction("WebRoomTimelineThreadSummaryButton",e)},"aria-label":Object(f.b)("Open thread")}),l.a.createElement("span",{className:"mx_ThreadSummary_replies_amount"},d),l.a.createElement(mt,{thread:a,showDisplayname:!s.narrow}),l.a.createElement("div",{className:"mx_ThreadSummary_chevron"}))},ut=a(187),pt=a.n(ut);class gt extends l.a.Component{constructor(e){super(e),o()(this,"nodes",{}),o()(this,"children",void 0),this.updateChildren(this.props.children)}componentDidUpdate(){this.updateChildren(this.props.children)}applyStyles(e,t){Object.entries(t).forEach((t=>{let[a,n]=t;e.style[a]=n}))}updateChildren(e){const t=this.children||{};this.children={},l.a.Children.toArray(e).forEach((e=>{if(t[e.key]){const a=t[e.key],n=pt.a.findDOMNode(this.nodes[a.key]);n&&n.style.left!==e.props.style.left&&this.applyStyles(n,{left:e.props.style.left}),this.children[e.key]=l.a.cloneElement(a,e.props,e.props.children)}else{const t={},a=e.props.style,n=this.props.startStyles;if(n.length>0){const e=n[0];t.style=e}t.ref=t=>this.collectNode(e.key,t,a),this.children[e.key]=l.a.cloneElement(e,t)}}))}collectNode(e,t,a){if(t&&void 0===this.nodes[e]&&this.props.startStyles.length>0){const e=this.props.startStyles,n=pt.a.findDOMNode(t);for(let t=1;t<e.length;++t)this.applyStyles(n,e[t]);window.setTimeout((()=>{this.applyStyles(n,a)}),0)}this.nodes[e]=t}render(){return l.a.createElement(l.a.Fragment,null,Object.values(this.children))}}o()(gt,"defaultProps",{startStyles:[]});var bt=a(592);class vt extends l.a.PureComponent{constructor(e){super(e),o()(this,"avatar",Object(r.createRef)()),this.state={suppressDisplay:!this.props.suppressAnimation}}componentWillUnmount(){const e=this.props.readReceiptInfo;e&&(this.props.checkUnmounting&&this.props.checkUnmounting()||this.buildReadReceiptInfo(e))}componentDidMount(){this.state.suppressDisplay&&this.animateMarker()}componentDidUpdate(e){const t=e.offset!==this.props.offset,a=e.hidden!==this.props.hidden;(t||a)&&this.animateMarker()}buildReadReceiptInfo(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this.avatar.current,a=null==t?void 0:t.offsetParent;if(!(a&&a instanceof HTMLElement))return p.a.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no valid horizontalContainer`),e.top=0,e.right=0,e.parent=void 0,e;const n=a.offsetParent;return n&&n instanceof HTMLElement?(e.top=t.offsetTop,e.right=t.getBoundingClientRect().right-a.getBoundingClientRect().right,e.parent=n,e):(p.a.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no valid verticalContainer`),e.top=0,e.right=0,e.parent=void 0,e)}readReceiptPosition(e){return e.parent?e.top+e.parent.getBoundingClientRect().top:(p.a.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} has no offsetParent`),0)}animateMarker(){const e=this.props.readReceiptInfo,t=this.buildReadReceiptInfo(),a=this.readReceiptPosition(t),n=e?this.readReceiptPosition(e):-yt,i=[];null!=e&&e.right&&i.push({top:n-a,right:e.right}),i.push({top:n-a,right:0}),this.setState({suppressDisplay:!1,startStyles:i})}render(){var e;if(this.state.suppressDisplay)return l.a.createElement("div",{ref:this.avatar});const t={right:Object(bt.a)(this.props.offset),top:"0px"};return l.a.createElement(gt,{startStyles:this.state.startStyles},l.a.createElement(K.a,{member:null!==(e=this.props.member)&&void 0!==e?e:null,fallbackUserId:this.props.fallbackUserId,"aria-hidden":"true","aria-live":"off",width:14,height:14,resizeMethod:"crop",style:t,inputRef:this.avatar,hideTitle:!0,tabIndex:-1}))}}var ft=a(221);function Et(e){const[t,a]=Object(r.useState)(!1);return[{showTooltip:()=>a(!0),hideTooltip:()=>a(!1)},l.a.createElement(V.b,i()({},e,{visible:t}))]}const yt=16;function _t(e){let{readReceipts:t,readReceiptMap:a,checkUnmounting:n,suppressAnimation:s,isTwelveHour:o,maxReadAvatarsPlusN:r,maxReadAvatars:c,layout:d}=e;const[m,h,u,p]=Object(F.q)(),g=r,b=c,v=t.length>b,E=v?g:b,y=d==P.a.Bubble?yt:10,_=function(e,t){return t?Object(f.b)("%(members)s and more",{members:e.join(", ")}):e.length>1?Object(f.b)("%(members)s and %(last)s",{last:e.pop(),members:e.join(", ")}):e.length?e[0]:void 0}(t.slice(0,E).map((e=>{var t,a;return null!==(t=null===(a=e.roomMember)||void 0===a?void 0:a.name)&&void 0!==t?t:e.userId})),v),[{showTooltip:S,hideTooltip:w},O]=Et({label:l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_Tooltip_title"},Object(f.b)("Seen by %(count)s people",{count:t.length})),l.a.createElement("div",{className:"mx_Tooltip_sub"},_)),alignment:V.a.TopRight});if(0===t.length)return l.a.createElement("div",{className:"mx_EventTile_msgOption sc_readReceipts_empty"},l.a.createElement("div",{className:"mx_ReadReceiptGroup"},l.a.createElement("div",{className:"mx_ReadReceiptGroup_button"},l.a.createElement("span",{className:"mx_ReadReceiptGroup_container"}))));const C=t.map(((e,t)=>{const{hidden:i,position:r}=function(e,t){return e<t?{hidden:!1,position:e}:{hidden:!0,position:0}}(t,E),c=e.userId;let d;return a&&(d=a[c],d||(d={},a[c]=d)),l.a.createElement(vt,{key:c,member:e.roomMember,fallbackUserId:c,offset:r*y,hidden:i,readReceiptInfo:d,checkUnmounting:n,suppressAnimation:s,timestamp:e.ts,showTwelveHour:o})})).reverse();let x;const k=t.length-E;let R;if(k>0&&(x=l.a.createElement("span",{className:"mx_ReadReceiptGroup_remainder","aria-live":"off"},"+",k)),m&&h.current){const e=h.current.getBoundingClientRect();R=l.a.createElement(F.n,i()({menuClassName:"mx_ReadReceiptGroup_popup",onFinished:p},Object(F.i)(e)),l.a.createElement(ft.a,null,l.a.createElement(wt,{className:"mx_ReadReceiptGroup_title"},Object(f.b)("Seen by %(count)s people",{count:t.length})),t.map((e=>l.a.createElement(St,i()({key:e.userId},e,{isTwelveHour:o,onAfterClick:p}))))))}return l.a.createElement("div",{className:"mx_EventTile_msgOption"},l.a.createElement("div",{className:"mx_ReadReceiptGroup",role:"group","aria-label":Object(f.b)("Read receipts")},l.a.createElement(j.a,{className:"mx_ReadReceiptGroup_button",inputRef:h,"aria-label":_,"aria-haspopup":"true",onClick:u,onMouseOver:S,onMouseLeave:w,onFocus:S,onBlur:w},x,l.a.createElement("span",{className:"mx_ReadReceiptGroup_container",style:{width:Math.min(E,t.length)*y+yt-y}},C)),O,R))}function St(e){var t,a;let{userId:n,roomMember:i,ts:s,isTwelveHour:o,onAfterClick:r}=e;const[{showTooltip:c,hideTooltip:d},m]=Et({alignment:V.a.Top,tooltipClassName:"mx_ReadReceiptGroup_person--tooltip",label:l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_Tooltip_title"},null!==(t=null==i?void 0:i.rawDisplayName)&&void 0!==t?t:n),l.a.createElement("div",{className:"mx_Tooltip_sub"},n))});return l.a.createElement(F.d,{className:"mx_ReadReceiptGroup_person",onClick:()=>{E.a.dispatch({action:w.a.ViewUser,member:null!=i?i:{userId:n},push:!1}),null==r||r()},onMouseOver:c,onMouseLeave:d,onFocus:c,onBlur:d,onWheel:d},l.a.createElement(K.b,{member:i,fallbackUserId:n,width:24,height:24,"aria-hidden":"true","aria-live":"off",resizeMethod:"crop",hideTitle:!0}),l.a.createElement("div",{className:"mx_ReadReceiptGroup_name"},l.a.createElement("p",null,null!==(a=null==i?void 0:i.name)&&void 0!==a?a:n),l.a.createElement("p",{className:"mx_ReadReceiptGroup_secondary"},Object(D.a)(new Date(s),o))),m)}function wt(e){let{className:t,children:a}=e;const n=Object(r.useRef)(null),[i]=Object(_e.i)(n);return l.a.createElement("h3",{className:t,role:"menuitem",onFocus:i,tabIndex:-1,ref:n},a)}var Ot=a(224),Ct=a(206),xt=a(266),jt=a(203);var kt,Rt=a(805);function It(e){let{room:t,threadId:a}=e;const{symbol:n,count:i,color:s}=((e,t)=>{const[a,n]=Object(r.useState)(null),[i,s]=Object(r.useState)(0),[o,l]=Object(r.useState)(jt.a.None);Object(lt.a)(e,g.d.UnreadNotifications,((e,a)=>{t&&t!==a||c()})),Object(lt.a)(e,g.d.Receipt,(()=>c())),Object(lt.a)(e,g.d.Timeline,(()=>c())),Object(lt.a)(e,g.d.Redaction,(()=>c())),Object(lt.a)(e,g.d.LocalEchoUpdated,(()=>c())),Object(lt.a)(e,g.d.MyMembership,(()=>c()));const c=Object(r.useCallback)((()=>{const{symbol:a,count:i,color:o}=Object(xt.b)(e,t);n(a),s(i),l(o)}),[e,t]);return Object(r.useEffect)((()=>{c()}),[c]),{symbol:a,count:i,color:o}})(t,a);return l.a.createElement(Rt.a,{symbol:n,count:i,color:s})}function Tt(){return Tt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Tt.apply(this,arguments)}function Nt(e){return r.createElement("svg",Tt({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),kt||(kt=r.createElement("path",{d:"M12.528 6.54l.5-.498c1.377-1.378 3.598-1.391 4.96-.03 1.361 1.362 1.348 3.583-.03 4.96l-2.37 2.37c-1.378 1.378-3.599 1.391-4.96.03m.844 4.087l-.5.499c-1.377 1.378-3.598 1.391-4.96.03-1.361-1.362-1.348-3.583.03-4.96l2.37-2.37c1.378-1.378 3.599-1.391 4.96-.03",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round"})))}var Pt;function Dt(){return Dt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Dt.apply(this,arguments)}function Mt(e){return r.createElement("svg",Dt({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",role:"presentation","aria-hidden":!0},e),Pt||(Pt=r.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M1 2.75A.75.75 0 011.75 2h.005a.75.75 0 010 1.5H1.75A.75.75 0 011 2.75zm2.495 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.005a.75.75 0 010 1.5h-.005a.75.75 0 01-.75-.75zM1 6.75A.75.75 0 011.75 6h8.5a.75.75 0 010 1.5h-8.5A.75.75 0 011 6.75zm0 3A.75.75 0 011.75 9h4.5a.75.75 0 010 1.5h-4.5A.75.75 0 011 9.75zm0 4a.75.75 0 01.75-.75h.005a.75.75 0 010 1.5H1.75a.75.75 0 01-.75-.75zm2.495 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5h-.01a.75.75 0 01-.75-.75zm2.5 0a.75.75 0 01.75-.75h.005a.75.75 0 010 1.5h-.005a.75.75 0 01-.75-.75z",clipRule:"evenodd"})))}function At(e){let{viewInRoom:t,copyLinkToThread:a}=e;return l.a.createElement(ye.a,{className:"mx_MessageActionBar","aria-label":Object(f.b)("Message Actions"),"aria-live":"off"},l.a.createElement(_e.b,{className:"mx_MessageActionBar_iconButton",onClick:t,title:Object(f.b)("View in room"),key:"view_in_room"},l.a.createElement(Mt,null)),l.a.createElement(_e.b,{className:"mx_MessageActionBar_iconButton",onClick:a,title:Object(f.b)("Copy link to thread"),key:"copy_link_to_thread"},l.a.createElement(Nt,null)))}function Ut(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Lt(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Ut(Object(a),!0).forEach((function(t){o()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Ut(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}class Ft extends l.a.Component{constructor(e,t){super(e,t),o()(this,"suppressReadReceiptAnimation",void 0),o()(this,"isListeningForReceipts",void 0),o()(this,"tile",l.a.createRef()),o()(this,"replyChain",l.a.createRef()),o()(this,"ref",Object(r.createRef)()),o()(this,"context",void 0),o()(this,"updateThread",(e=>{this.setState({thread:e})})),o()(this,"onNewThread",(e=>{if(e.id===this.props.mxEvent.getId()){this.updateThread(e);const t=I.a.get().getRoom(this.props.mxEvent.getRoomId());null==t||t.off(u.f.New,this.onNewThread)}})),o()(this,"viewInRoom",(e=>{e.preventDefault(),e.stopPropagation(),E.a.dispatch({action:w.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:void 0})})),o()(this,"copyLinkToThread",(async e=>{e.preventDefault(),e.stopPropagation();const{permalinkCreator:t,mxEvent:a}=this.props,n=t.forEvent(a.getId());await Object(Je.b)(n)})),o()(this,"onRoomReceipt",((e,t)=>{t===I.a.get().getRoom(this.props.mxEvent.getRoomId())&&(this.shouldShowSentReceipt||this.shouldShowSendingReceipt||this.isListeningForReceipts)&&this.forceUpdate((()=>{this.shouldShowSentReceipt||this.shouldShowSendingReceipt||(I.a.get().removeListener(g.d.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!1)}))})),o()(this,"onDecrypted",(()=>{this.verifyEvent(),this.forceUpdate(this.props.onHeightChanged)})),o()(this,"onDeviceVerificationChanged",((e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent()})),o()(this,"onUserVerificationChanged",((e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent()})),o()(this,"onReplaced",(()=>{this.verifyEvent()})),o()(this,"onSenderProfileClick",(()=>{E.a.dispatch({action:w.a.ComposerInsert,userId:this.props.mxEvent.getSender(),timelineRenderingType:this.context.timelineRenderingType})})),o()(this,"onPermalinkClicked",(e=>{e.preventDefault(),E.a.dispatch({action:w.a.ViewRoom,event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId(),metricsTrigger:this.context.timelineRenderingType===R.a.Search?"MessageSearch":void 0})})),o()(this,"onActionBarFocusChange",(e=>{this.setState({actionBarFocused:e})})),o()(this,"getTile",(()=>this.tile.current)),o()(this,"getReplyChain",(()=>this.replyChain.current)),o()(this,"getReactions",(()=>{var e;if(!this.props.showReactions||!this.props.getRelationsForEvent)return null;const t=this.props.mxEvent.getId();return null!==(e=this.props.getRelationsForEvent(t,"m.annotation","m.reaction"))&&void 0!==e?e:null})),o()(this,"onReactionsCreated",((e,t)=>{"m.annotation"===e&&"m.reaction"===t&&this.setState({reactions:this.getReactions()})})),o()(this,"onContextMenu",(e=>{this.showContextMenu(e)})),o()(this,"onTimestampContextMenu",(e=>{var t;this.showContextMenu(e,null===(t=this.props.permalinkCreator)||void 0===t?void 0:t.forEvent(this.props.mxEvent.getId()))})),o()(this,"onCloseMenu",(()=>{this.setState({contextMenu:void 0,actionBarFocused:!1})})),o()(this,"setQuoteExpanded",(e=>{this.setState({isQuoteExpanded:e})}));const a=this.thread;this.state={actionBarFocused:!1,verified:null,reactions:this.getReactions(),hover:!1,thread:a},this.suppressReadReceiptAnimation=!0,this.isListeningForReceipts=!1}get isEligibleForSpecialReceipt(){if(this.props.readReceipts&&this.props.readReceipts.length>0)return!1;if(!this.props.mxEvent)return!1;if(!I.a.get().getRoom(this.props.mxEvent.getRoomId()))return!1;const e=I.a.get().getUserId();if(this.props.mxEvent.getSender()!==e)return!1;return!![m.b.Sticker,m.b.RoomMessage,m.b.RoomMessageEncrypted,m.b.PollStart].includes(this.props.mxEvent.getType())}get shouldShowSentReceipt(){if(!this.isEligibleForSpecialReceipt)return!1;if(!this.props.lastSuccessful)return!1;if(this.props.eventSendStatus&&this.props.eventSendStatus!==h.a.SENT)return!1;const e=this.props.readReceipts||[],t=I.a.get().getUserId();return!e.some((e=>e.userId!==t))}get shouldShowSendingReceipt(){return!!this.isEligibleForSpecialReceipt&&!(!this.props.eventSendStatus||this.props.eventSendStatus===h.a.SENT)}componentDidMount(){this.suppressReadReceiptAnimation=!1;const e=I.a.get();this.props.forExport||(e.on(v.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),e.on(v.b.UserTrustStatusChanged,this.onUserVerificationChanged),this.props.mxEvent.on(h.c.Decrypted,this.onDecrypted),this.props.mxEvent.on(h.c.Replaced,this.onReplaced),Qe.a.instance.addVisibleEvent(this.props.mxEvent),this.props.showReactions&&this.props.mxEvent.on(h.c.RelationsCreated,this.onReactionsCreated),(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)&&(e.on(g.d.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0)),this.props.mxEvent.on(u.f.Update,this.updateThread),e.decryptEventIfNeeded(this.props.mxEvent);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.on(u.f.New,this.onNewThread),this.verifyEvent()}shouldComponentUpdate(e,t){return!!Object(B.c)(this.state,t)||!this.propsEqual(this.props,e)}componentWillUnmount(){const e=I.a.get();if(e){e.removeListener(v.b.DeviceVerificationChanged,this.onDeviceVerificationChanged),e.removeListener(v.b.UserTrustStatusChanged,this.onUserVerificationChanged),e.removeListener(g.d.Receipt,this.onRoomReceipt);const t=e.getRoom(this.props.mxEvent.getRoomId());null==t||t.off(u.f.New,this.onNewThread)}this.isListeningForReceipts=!1,this.props.mxEvent.removeListener(h.c.Decrypted,this.onDecrypted),this.props.mxEvent.removeListener(h.c.Replaced,this.onReplaced),this.props.showReactions&&this.props.mxEvent.removeListener(h.c.RelationsCreated,this.onReactionsCreated),this.props.mxEvent.off(u.f.Update,this.updateThread)}componentDidUpdate(e,t){t.verified!==this.state.verified&&this.props.onHeightChanged&&this.props.onHeightChanged(),this.isListeningForReceipts||!this.shouldShowSentReceipt&&!this.shouldShowSendingReceipt||(I.a.get().on(g.d.Receipt,this.onRoomReceipt),this.isListeningForReceipts=!0),e.eventSendStatus!==this.props.eventSendStatus&&this.verifyEvent()}get thread(){var e;let t=this.props.mxEvent.getThread();if(!t){var a;const e=I.a.get().getRoom(this.props.mxEvent.getRoomId());t=null!==(a=null==e?void 0:e.findThreadForEvent(this.props.mxEvent))&&void 0!==a?a:void 0}return null!==(e=t)&&void 0!==e?e:null}renderThreadPanelSummary(){return this.state.thread?l.a.createElement("div",{className:"mx_ThreadPanel_replies"},l.a.createElement("span",{className:"mx_ThreadPanel_replies_amount"},this.state.thread.length),l.a.createElement(mt,{thread:this.state.thread})):null}renderThreadInfo(){return this.state.thread&&this.state.thread.id===this.props.mxEvent.getId()?l.a.createElement(ht,{mxEvent:this.props.mxEvent,thread:this.state.thread,"data-testid":"thread-summary"}):this.context.timelineRenderingType===R.a.Search&&this.props.mxEvent.threadRootId?this.props.highlightLink?l.a.createElement("a",{className:"mx_ThreadSummary_icon",href:this.props.highlightLink},Object(f.b)("From a thread")):l.a.createElement("p",{className:"mx_ThreadSummary_icon"},Object(f.b)("From a thread")):void 0}verifyEvent(){var e;const t=null!==(e=this.props.mxEvent.replacingEvent())&&void 0!==e?e:this.props.mxEvent;if(!t.isEncrypted()||t.isRedacted())return void this.setState({verified:null});const a=I.a.get().getEventEncryptionInfo(t),n=t.getSender(),i=I.a.get().checkUserTrust(n);if(a.mismatchedSender)return void this.setState({verified:A.a.Warning});if(!i.isCrossSigningVerified())return void this.setState({verified:a.authenticated?A.a.Normal:A.a.Unauthenticated});const s=a.sender&&I.a.get().checkDeviceTrust(n,a.sender.deviceId);s?s.isVerified()?a.authenticated?this.setState({verified:A.a.Verified}):this.setState({verified:A.a.Unauthenticated}):this.setState({verified:A.a.Warning}):this.setState({verified:A.a.Unknown})}propsEqual(e,t){const a=Object.keys(e),n=Object.keys(t);if(a.length!==n.length)return!1;for(let n=0;n<a.length;n++){const i=a[n];if(!t.hasOwnProperty(i))return!1;if("readReceipts"===i){const a=e[i],n=t[i];if(a===n)continue;if(!a||!n)return!1;if(a.length!==n.length)return!1;for(let e=0;e<a.length;e++){if(a[e].userId!==n[e].userId)return!1;if(a[e].roomMember!==n[e].roomMember)return!1}}else if(e[i]!==t[i])return!1}return!0}shouldHighlight(){if(this.props.forExport)return!1;if(this.context.timelineRenderingType===R.a.Notification)return!1;if(this.context.timelineRenderingType===R.a.ThreadsList)return!1;const e=I.a.get(),t=e.getPushActionsForEvent(this.props.mxEvent.replacingEvent()||this.props.mxEvent),a=this.props.mxEvent.replacingEvent()?e.getPushActionsForEvent(this.props.mxEvent):void 0;if(!(null!=t&&t.tweaks||null!=a&&a.tweaks))return!1;if(this.props.mxEvent.getSender()===I.a.get().credentials.userId)return!1;const n=I.a.get().getRoom(this.props.mxEvent.getRoomId());return(!n||2!==n.currentState.getJoinedMemberCount())&&!!(null!=t&&t.tweaks.highlight||null!=a&&a.tweaks.highlight)}renderE2EPadlock(){var e;const t=null!==(e=this.props.mxEvent.replacingEvent())&&void 0!==e?e:this.props.mxEvent;return Object(Ot.a)(t.getRoomId())?null:t.isDecryptionFailure()?l.a.createElement(Kt,null):t.isEncrypted()&&!t.isRedacted()?this.state.verified===A.a.Normal||this.state.verified===A.a.Verified?null:this.state.verified===A.a.Unauthenticated?l.a.createElement(Ht,null):this.state.verified===A.a.Unknown?l.a.createElement(zt,null):l.a.createElement(Vt,null):I.a.get().isRoomEncrypted(t.getRoomId())?t.status===h.a.ENCRYPTING||t.status===h.a.NOT_SENT||t.isState()||t.isRedacted()?null:l.a.createElement(Wt,null):null}showContextMenu(e,t){var a;const n=e.target,i=n instanceof HTMLAnchorElement?n:n.closest("a");n instanceof HTMLImageElement||(null!==(a=H.a.get())&&void 0!==a&&a.allowOverridingNativeContextMenus()||!Object(Je.c)()&&!i)&&(this.props.editState||(e.preventDefault(),e.stopPropagation(),this.setState({contextMenu:{position:{left:e.clientX,top:e.clientY,bottom:e.clientY},link:(null==i?void 0:i.href)||t},actionBarFocused:!0})))}shouldHideEvent(){var e;return(null===(e=this.props.callEventGrouper)||void 0===e?void 0:e.hangupReason)===b.c.Replaced}renderContextMenu(){if(!this.state.contextMenu)return null;const e=this.getTile(),t=this.getReplyChain(),a=null!=e&&e.getEventTileOps?e.getEventTileOps():void 0,n=null!=t&&t.canCollapse()?t.collapse:void 0;return l.a.createElement(L.a,i()({},Object(F.j)(this.state.contextMenu.position),{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,eventTileOps:a,collapseReplyChain:n,onFinished:this.onCloseMenu,rightClick:!0,reactions:this.state.reactions,link:this.state.contextMenu.link,getRelationsForEvent:this.props.getRelationsForEvent}))}render(){var e,t,a;const n=this.props.mxEvent.getContent().msgtype,i=this.props.mxEvent.getType(),{hasRenderer:s,isBubbleMessage:o,isInfoMessage:r,isLeftAlignedBubbleMessage:c,noBubbleEvent:h,isSeeingThroughMessageHiddenForModeration:u}=Object($e.a)(this.props.mxEvent,this.context.showHiddenEvents,this.shouldHideEvent()),{isQuoteExpanded:g}=this.state;if(!s){const{mxEvent:e}=this.props;return p.a.warn(`Event type not supported: type:${i} isState:${e.isState()}`),l.a.createElement("div",{className:"mx_EventTile mx_EventTile_info mx_MNoticeBody"},l.a.createElement("div",{className:"mx_EventTile_line"},Object(f.b)("This event could not be displayed")))}const b=we.a.isEligible(this.props.mxEvent),v=d()("mx_EventTile_line",{mx_EventTile_mediaLine:b,mx_EventTile_image:this.props.mxEvent.getType()===m.b.RoomMessage&&this.props.mxEvent.getContent().msgtype===m.e.Image,mx_EventTile_sticker:this.props.mxEvent.getType()===m.b.Sticker,mx_EventTile_emote:this.props.mxEvent.getType()===m.b.RoomMessage&&this.props.mxEvent.getContent().msgtype===m.e.Emote}),y=["sending","queued","encrypting"].includes(this.props.eventSendStatus),_=Object(st.d)(this.props.mxEvent)&&this.props.isRedacted,S=this.props.mxEvent.isDecryptionFailure(),O=(null===(e=this.props.mxEvent)||void 0===e?void 0:e.getSender())===I.a.get().getUserId(),C=this.props.layout===P.a.Bubble&&this.context.timelineRenderingType!==R.a.Notification&&this.context.timelineRenderingType!==R.a.File,x=O&&!this.props.singleSideBubbles,j=!O||this.props.singleSideBubbles;let N=this.props.continuation;this.context.timelineRenderingType===R.a.Room||this.context.timelineRenderingType===R.a.Search||r||o||(N=!1);const L=this.context.timelineRenderingType===R.a.Notification,F=!!this.props.editState,B=d()({mx_EventTile_bubbleContainer:o&&this.props.layout!==P.a.Bubble,mx_EventTile_leftAlignedBubble:c,mx_EventTile:!0,mx_EventTile_isEditing:F,mx_EventTile_info:r&&this.props.layout!==P.a.Bubble,mx_EventTile_12hr:this.props.isTwelveHour,mx_EventTile_sending:!F&&y,mx_EventTile_highlight:this.shouldHighlight(),mx_EventTile_selected:this.props.isSelectedEvent||this.state.contextMenu,mx_EventTile_continuation:N||this.props.layout!==P.a.Bubble&&(i===m.b.CallInvite||Ct.d.CALL_EVENT_TYPE.matches(i)),mx_EventTile_last:this.props.last,mx_EventTile_lastInSection:this.props.lastInSection,mx_EventTile_contextual:this.props.contextual,mx_EventTile_actionBarFocused:this.state.actionBarFocused,mx_EventTile_verified:!o&&this.state.verified===A.a.Verified,mx_EventTile_unverified:!o&&this.state.verified===A.a.Warning,mx_EventTile_unknown:!o&&this.state.verified===A.a.Unknown,mx_EventTile_bad:S,mx_EventTile_emote:n===m.e.Emote,sc_EventTile_bubbleContainer:C,mx_EventTile_noSender:this.props.hideSender,mx_EventTile_clamp:this.context.timelineRenderingType===R.a.ThreadsList||L,mx_EventTile_noBubble:h}),V=null!==this.props.eventSendStatus?"off":void 0;let W="#";this.props.permalinkCreator&&(W=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const z=this.props.mxEvent.status?void 0:this.props.mxEvent.getId();let H,$,Y=null,J=null;if(!r&&C&&x?(H=0,$=!1):L?(H=24,$=!0):r?(H=14,$=!1):this.context.timelineRenderingType===R.a.ThreadsList||this.context.timelineRenderingType===R.a.Thread&&!this.props.continuation?(H=32,$=!0):i===m.b.RoomCreate||o?(H=0,$=!1):this.props.layout==P.a.IRC?(H=14,$=!0):this.props.continuation&&this.context.timelineRenderingType!==R.a.File||i===m.b.CallInvite||Ct.d.CALL_EVENT_TYPE.matches(i)?(H=0,$=!1):(H=30,$=!0),this.props.mxEvent.sender&&H){let e;e=this.props.mxEvent.getContent().third_party_invite?this.props.mxEvent.target:this.props.mxEvent.sender;const t=![R.a.ThreadsList,R.a.Notification].includes(this.context.timelineRenderingType);Y=l.a.createElement("div",{className:"mx_EventTile_avatar"},l.a.createElement(K.b,{member:e,width:H,height:H,viewUserOnClick:t,forceHistorical:this.props.mxEvent.getType()===m.b.RoomMember}))}$&&!0!==this.props.hideSender&&(J=this.context.timelineRenderingType===R.a.Room||this.context.timelineRenderingType===R.a.Search||this.context.timelineRenderingType===R.a.Pinned||this.context.timelineRenderingType===R.a.Thread?l.a.createElement(G.a,{onClick:this.onSenderProfileClick,mxEvent:this.props.mxEvent,userNameColorMode:this.props.userNameColorMode}):this.context.timelineRenderingType===R.a.ThreadsList?l.a.createElement(G.a,{mxEvent:this.props.mxEvent,userNameColorMode:this.props.userNameColorMode,withTooltip:!0}):l.a.createElement(G.a,{mxEvent:this.props.mxEvent,userNameColorMode:this.props.userNameColorMode}));const Q=!F&&!this.props.forExport?l.a.createElement(Fe,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,permalinkCreator:this.props.permalinkCreator,getTile:this.getTile,getReplyChain:this.getReplyChain,onFocusChange:this.onActionBarFocusChange,isQuoteExpanded:g,toggleThreadExpanded:()=>this.setQuoteExpanded(!g),getRelationsForEvent:this.props.getRelationsForEvent}):void 0,X=this.props.mxEvent.getTs()&&(C||this.props.alwaysShowTimestamps||this.props.last||this.state.hover||this.state.actionBarFocused||Boolean(this.state.contextMenu));let Z=this.context.timelineRenderingType!==R.a.ThreadsList?this.props.mxEvent.getTs():null===(t=this.state.thread)||void 0===t||null===(a=t.replyToEvent)||void 0===a?void 0:a.getTs();"number"!=typeof Z&&(Z=this.props.mxEvent.getTs());const ee=l.a.createElement(q.a,{showRelative:this.context.timelineRenderingType===R.a.ThreadsList,showTwelveHour:this.props.isTwelveHour,ts:Z}),te=X&&Z?ee:null;let ae;_||(ae=l.a.createElement(qe,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,key:"mx_EventTile_reactionsRow"}));const ne=l.a.createElement("a",{className:"sc_LinkedTimestamp",href:W,onClick:this.onPermalinkClicked,"aria-label":Object(D.n)(new Date(this.props.mxEvent.getTs()),this.props.isTwelveHour),onContextMenu:this.onTimestampContextMenu},te),ie=l.a.createElement("span",{className:"sc_PlaceholderTimestamp"},te),se=this.props.layout===P.a.IRC,oe=se?null:ne,re=se?ne:null,le=this.props.layout===P.a.Bubble?ee:void 0,ce=!se&&!o&&this.renderE2EPadlock(),de=se&&!o&&this.renderE2EPadlock();let me;var he,ue;this.props.showReadReceipts&&(me=this.shouldShowSentReceipt||this.shouldShowSendingReceipt?l.a.createElement($t,{messageState:this.props.mxEvent.getAssociatedStatus()}):l.a.createElement(_t,{readReceipts:null!==(he=this.props.readReceipts)&&void 0!==he?he:[],readReceiptMap:null!==(ue=this.props.readReceiptMap)&&void 0!==ue?ue:{},checkUnmounting:this.props.checkUnmounting,suppressAnimation:this.suppressReadReceiptAnimation,isTwelveHour:this.props.isTwelveHour,maxReadAvatarsPlusN:this.props.layout==P.a.Bubble?12:3,maxReadAvatars:this.props.layout==P.a.Bubble?13:4,layout:this.props.layout}));let pe;switch(Object(st.c)(this.props.mxEvent,this.context.showHiddenEvents)&&Object(k.c)(this.props.mxEvent)&&(pe=l.a.createElement(T,{parentEv:this.props.mxEvent,onHeightChanged:this.props.onHeightChanged,ref:this.replyChain,forExport:this.props.forExport,permalinkCreator:this.props.permalinkCreator,layout:this.props.layout,userNameColorMode:this.props.userNameColorMode,alwaysShowTimestamps:this.props.alwaysShowTimestamps||this.state.hover,isQuoteExpanded:g,setQuoteExpanded:this.setQuoteExpanded,getRelationsForEvent:this.props.getRelationsForEvent})),this.context.timelineRenderingType){case R.a.Thread:return l.a.createElement(this.props.as||"li",{ref:this.ref,className:B,"aria-live":V,"aria-atomic":!0,"data-scroll-tokens":z,"data-has-reply":!!pe,"data-layout":this.props.layout,"data-self":O,"data-event-id":this.props.mxEvent.getId(),onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},[l.a.createElement("div",{className:"mx_EventTile_senderDetails",key:"mx_EventTile_senderDetails"},Y,J),l.a.createElement("div",{className:v,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),pe,Object(st.g)(R.a.Thread,Lt(Lt({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:u,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:()=>this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),Q,l.a.createElement("a",{href:W,onClick:this.onPermalinkClicked},te),me),ae]);case R.a.Notification:case R.a.ThreadsList:{const e=I.a.get().getRoom(this.props.mxEvent.getRoomId());return l.a.createElement(this.props.as||"li",{ref:this.ref,className:B,tabIndex:-1,"aria-live":V,"aria-atomic":"true","data-scroll-tokens":z,"data-layout":this.props.layout,"data-shape":this.context.timelineRenderingType,"data-self":O,"data-has-reply":!!pe,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1}),onClick:e=>{var t;const a=e.currentTarget;let n=-1;switch(a.parentElement&&(n=Array.from(a.parentElement.children).indexOf(a)),this.context.timelineRenderingType){case R.a.Notification:this.viewInRoom(e);break;case R.a.ThreadsList:E.a.dispatch({action:w.a.ShowThread,rootEvent:this.props.mxEvent,push:!0}),Ze.b.trackInteraction("WebThreadsPanelThreadItem",e,null!==(t=n)&&void 0!==t?t:-1)}}},l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_EventTile_details"},J,L&&e?l.a.createElement("span",{className:"mx_EventTile_truncated"}," ",Object(f.b)(" in <strong>%(room)s</strong>",{room:e.name},{strong:e=>l.a.createElement("strong",null,e)})):"",te),L&&e?l.a.createElement("div",{className:"mx_EventTile_avatar"},l.a.createElement(U.a,{room:e,width:28,height:28})):Y,l.a.createElement("div",{className:v,key:"mx_EventTile_line"},l.a.createElement("div",{className:"mx_EventTile_body"},this.props.mxEvent.isRedacted()?l.a.createElement(Xe.a,{mxEvent:this.props.mxEvent}):this.props.mxEvent.isDecryptionFailure()?l.a.createElement(M.a,{mxEvent:this.props.mxEvent}):Ye.a.instance.generatePreviewForEvent(this.props.mxEvent)),this.renderThreadPanelSummary()),this.context.timelineRenderingType===R.a.ThreadsList&&l.a.createElement(At,{viewInRoom:this.viewInRoom,copyLinkToThread:this.copyLinkToThread}),me,l.a.createElement(It,{room:e||void 0,threadId:this.props.mxEvent.getId()})))}case R.a.File:return l.a.createElement(this.props.as||"li",{className:B,"aria-live":V,"aria-atomic":!0,"data-scroll-tokens":z},[l.a.createElement("div",{className:v,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),Object(st.g)(R.a.File,Lt(Lt({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:u,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents)),l.a.createElement("a",{className:"mx_EventTile_senderDetailsLink",key:"mx_EventTile_senderDetailsLink",href:W,onClick:this.onPermalinkClicked},l.a.createElement("div",{className:"mx_EventTile_senderDetails",onContextMenu:this.onTimestampContextMenu},J,te))]);default:if(C){const e=r||o,t=[],a=["m.sticker"];let n=!1,i=!1,s=!1;const c=this.props.mxEvent.getContent(),m=this.props.mxEvent.getType(),h=c.msgtype;h&&-1!=t.indexOf(h)&&!pe&&(n=!0),m&&-1!=a.indexOf(m)&&!pe&&(n=!0,i=!0),h&&"m.notice"==h&&(s=!0);const p=d()("sc_EventTile_bubbleLine",{sc_EventTile_bubbleLine_info:e}),g=d()("sc_EventTile_bubbleArea",{sc_EventTile_bubbleArea_right:!e&&x,sc_EventTile_bubbleArea_left:!e&&j,sc_EventTile_bubbleArea_center:e,sc_EventTile_bubbleArea_info:e}),b=d()({sc_EventTile_bubble:!n,sc_EventTile_bubble_media:n,sc_EventTile_bubble_info:e,sc_EventTile_bubble_self:!e&&O,sc_EventTile_bubble_right:!e&&x,sc_EventTile_bubble_left:!e&&j,sc_EventTile_bubble_center:e,sc_EventTile_bubble_tail:!e&&!this.props.continuation,sc_EventTile_bubble_notice:s,sc_EventTile_bubble_sticker:i});return l.a.createElement(this.props.as||"li",{ref:this.ref,className:B,tabIndex:-1,"aria-live":V,"aria-atomic":"true","data-scroll-tokens":z,"data-layout":this.props.layout,"data-self":O,"data-event-id":this.props.mxEvent.getId(),"data-has-reply":!!pe,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:`${v} ${p}`,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),l.a.createElement("div",{className:g},l.a.createElement("div",{className:b},J,pe,e?Y:null,Object(st.g)(this.context.timelineRenderingType,Lt(Lt({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:u,timestamp:null,scBubble:!0,scBubbleActionBar:n?Q:null,scBubbleTimestamp:l.a.createElement(l.a.Fragment,null,ie,ne),highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),n?null:Q,ce),ae,this.renderThreadInfo())),e?null:Y,me))}return l.a.createElement(this.props.as||"li",{ref:this.ref,className:B,tabIndex:-1,"aria-live":V,"aria-atomic":"true","data-scroll-tokens":z,"data-layout":this.props.layout,"data-self":O,"data-event-id":this.props.mxEvent.getId(),"data-has-reply":!!pe,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},l.a.createElement(l.a.Fragment,null,re,J,de,Y,l.a.createElement("div",{className:v,key:"mx_EventTile_line",onContextMenu:this.onContextMenu},this.renderContextMenu(),oe,ce,pe,Object(st.g)(this.context.timelineRenderingType,Lt(Lt({},this.props),{},{ref:this.tile,isSeeingThroughMessageHiddenForModeration:u,timestamp:le,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator}),this.context.showHiddenEvents),Q,this.props.layout===P.a.IRC&&l.a.createElement(l.a.Fragment,null,ae,this.renderThreadInfo())),this.props.layout!==P.a.IRC&&l.a.createElement(l.a.Fragment,null,ae,this.renderThreadInfo()),me))}}}o()(Ft,"defaultProps",{onHeightChanged:function(){},forExport:!1,layout:P.a.Group}),o()(Ft,"contextType",R.b);const Bt=Object(r.forwardRef)(((e,t)=>l.a.createElement(l.a.Fragment,null,l.a.createElement(it,{mxEvent:e.mxEvent,layout:e.layout},l.a.createElement(Ft,i()({ref:t},e))))));t.b=Bt;function Vt(e){return l.a.createElement(qt,i()({title:Object(f.b)("Encrypted by an unverified session"),icon:Gt.Warning},e))}function Wt(e){return l.a.createElement(qt,i()({title:Object(f.b)("Unencrypted"),icon:Gt.Warning},e))}function zt(e){return l.a.createElement(qt,i()({title:Object(f.b)("Encrypted by a deleted session"),icon:Gt.Normal},e))}function Ht(e){return l.a.createElement(qt,i()({title:Object(f.b)("The authenticity of this encrypted message can't be guaranteed on this device."),icon:Gt.Normal},e))}function Kt(e){return l.a.createElement(qt,i()({title:Object(f.b)("This message could not be decrypted"),icon:Gt.DecryptionFailure},e))}var Gt=function(e){return e.Normal="normal",e.Warning="warning",e.DecryptionFailure="decryption_failure",e}(Gt||{});class qt extends l.a.Component{constructor(e){super(e),o()(this,"onHoverStart",(()=>{this.setState({hover:!0})})),o()(this,"onHoverEnd",(()=>{this.setState({hover:!1})})),this.state={hover:!1}}render(){let e;this.state.hover&&(e=l.a.createElement(V.b,{className:"mx_EventTile_e2eIcon_tooltip",label:this.props.title}));const t=`mx_EventTile_e2eIcon mx_EventTile_e2eIcon_${this.props.icon}`;return l.a.createElement("div",{className:t,onMouseEnter:this.onHoverStart,onMouseLeave:this.onHoverEnd},e)}}function $t(e){let{messageState:t}=e;const a=!t||"sent"===t,n="not_sent"===t,i=d()({mx_EventTile_receiptSent:a,mx_EventTile_receiptSending:!a&&!n});let s;n&&(s=l.a.createElement(z.a,{notification:W.a.RED_EXCLAMATION}));let o=Object(f.b)("Sending your message…");"encrypting"===t?o=Object(f.b)("Encrypting your message…"):a?o=Object(f.b)("Your message was sent"):n&&(o=Object(f.b)("Failed to send"));const[{showTooltip:r,hideTooltip:c},m]=Et({label:o,alignment:V.a.TopRight});return l.a.createElement("div",{className:"mx_EventTile_msgOption"},l.a.createElement("div",{className:"mx_ReadReceiptGroup"},l.a.createElement("div",{className:"mx_ReadReceiptGroup_button",onMouseOver:r,onMouseLeave:c,onFocus:r,onBlur:c},l.a.createElement("span",{className:"mx_ReadReceiptGroup_container"},l.a.createElement("span",{className:i},s))),m))}},419:function(e,t,a){"use strict";a.d(t,"a",(function(){return h}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(948),l=a(137),c=a(121),d=a(496);function m(e){return e===d.a.Done?a(1637).default:a(952).default}class h extends o.a.Component{constructor(e){super(e),i()(this,"store",void 0),i()(this,"onStoreUpdate",(()=>{this.setState({icon:m(this.store.phase)})})),this.store=d.b.sharedInstance(),this.state={icon:m(this.store.phase)}}componentDidMount(){this.store.on("update",this.onStoreUpdate)}componentWillUnmount(){this.store.removeListener("update",this.onStoreUpdate)}render(){return o.a.createElement(l.a,{headerImage:this.state.icon,onFinished:this.props.onFinished,title:Object(c.b)("Verify this session")},o.a.createElement(r.a,{onFinished:this.props.onFinished}))}}},421:function(e,t,a){"use strict";a.d(t,"a",(function(){return g}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(1),l=a(121),c=a(123),d=a(158),m=a(129),h=a(132),u=a(270),p=a(124);class g extends o.a.PureComponent{constructor(e){super(e),i()(this,"onClearCacheAndReload",(()=>{d.a.get()&&(c.a.get().stopClient(),c.a.get().store.deleteAllData().then((()=>{var e;null===(e=d.a.get())||void 0===e||e.reload()})))})),i()(this,"onBugReport",(()=>{m.b.createDialog(u.a,{label:"react-soft-crash",error:this.state.error})})),this.state={}}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e,t){let{componentStack:a}=t;r.a.error(e),r.a.error("The above error occurred while React was rendering the following components:",a)}render(){if(this.state.error){const e="https://github.com/SchildiChat/schildichat-desktop/issues/new/choose";let t,a;return h.b.get().bug_report_endpoint_url&&(t=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.b)("Please <newIssueLink>create a new issue</newIssueLink> on GitHub so that we can investigate this bug.",{},{newIssueLink:t=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:e},t)})),o.a.createElement("p",null,Object(l.b)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. "),Object(l.b)("Debug logs contain application usage data including your username, the IDs or aliases of the rooms you have visited, which UI elements you last interacted with, and the usernames of other users. They do not contain messages.")),o.a.createElement(p.a,{onClick:this.onBugReport,kind:"primary"},Object(l.b)("Submit debug logs")))),c.a.get()&&(a=o.a.createElement(p.a,{onClick:this.onClearCacheAndReload,kind:"danger"},Object(l.b)("Clear cache and reload"))),o.a.createElement("div",{className:"mx_ErrorBoundary"},o.a.createElement("div",{className:"mx_ErrorBoundary_body"},o.a.createElement("h1",null,Object(l.b)("Something went wrong!")),t,a))}return this.props.children}}},493:function(e,t,a){"use strict";(function(e){a.d(t,"h",(function(){return q})),a.d(t,"b",(function(){return $})),a.d(t,"a",(function(){return Y})),a.d(t,"d",(function(){return J})),a.d(t,"c",(function(){return Q})),a.d(t,"j",(function(){return ee})),a.d(t,"k",(function(){return te})),a.d(t,"e",(function(){return ae})),a.d(t,"i",(function(){return re})),a.d(t,"l",(function(){return le})),a.d(t,"g",(function(){return ce})),a.d(t,"f",(function(){return de})),a.d(t,"m",(function(){return pe}));var n=a(136),i=a(297),s=a(333),o=a(1),r=a(360),l=a(123),c=a(302),d=a(327),m=a(1015),h=a(281),u=a(662),p=a(1634),g=a(125),b=a(167),v=a(129),f=a(344),E=a(158),y=a(494),_=a(452),S=a(126),w=a(196),O=a(292),C=a(555),x=a(1746),j=a(586),k=a(358),R=a(956),I=a(192),T=a(186),N=a(1639),P=a(147),D=a(121),M=a(1640),A=a(1641),U=a(1642),L=a(1643),F=a(617),B=a(132),V=a(1744),W=a(128),z=a(552),H=a(154);const K="mx_hs_url",G="mx_is_url";async function q(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{let t=e.enableGuest||!1;const a=e.guestHsUrl,i=e.guestIsUrl,s=e.fragmentQueryParams||{},r=e.defaultDeviceDisplayName;if(t&&!a&&(o.a.warn("Cannot enable guest access: can't determine HS URL to use"),t=!1),t&&a&&s.guest_user_id&&s.guest_access_token)return o.a.log("Using guest access credentials"),ne({userId:s.guest_user_id,accessToken:s.guest_access_token,homeserverUrl:a,identityServerUrl:i,guest:!0},!0).then((()=>!0));return!!await ee({ignoreGuest:Boolean(e.ignoreGuest)})||!(!t||!a)&&function(e,t,a){o.a.log(`Doing guest login on ${e}`);return Object(n.createClient)({baseUrl:e}).registerGuest({body:{initial_device_display_name:a}}).then((a=>(o.a.log(`Registered as guest: ${a.user_id}`),ne({userId:a.user_id,deviceId:a.device_id,accessToken:a.access_token,homeserverUrl:e,identityServerUrl:t,guest:!0},!0).then((()=>!0)))),(e=>(o.a.error("Failed to register as guest",e),!1)))}(a,i,r)}catch(e){return!(e instanceof ie)&&async function(e){o.a.error("Unable to load session",e);const t=v.b.createDialog(U.a,{error:e}),[a]=await t.finished;if(a)return await ue(),!1;return q()}(e)}}async function $(){const{hsUrl:e,userId:t,hasAccessToken:a,isGuest:n}=await Q();return e&&t&&a?[t,n]:[null,null]}function Y(e,t,a){var i;if(!e.loginToken)return Promise.resolve(!1);const s=localStorage.getItem(k.a),l=null!==(i=localStorage.getItem(k.c))&&void 0!==i?i:void 0;return s?Object(y.b)(s,l,"m.login.token",{token:e.loginToken,initial_device_display_name:t}).then((function(e){return o.a.log("Logged in with token"),ue().then((async()=>(await se(e),sessionStorage.setItem("mx_fresh_login",String(!0)),!0)))})).catch((e=>(v.b.createDialog(P.a,{title:Object(D.b)("We couldn't log you in"),description:"ConnectionError"===e.name?Object(D.b)("Your homeserver was unreachable and was not able to log you in. Please try again. If this continues, please contact your homeserver administrator."):Object(D.b)("Your homeserver rejected your log in attempt. This could be due to things just taking too long. Please try again. If this continues, please contact your homeserver administrator."),button:Object(D.b)("Try again"),onFinished:e=>{if(e){var t;const e=Object(n.createClient)({baseUrl:s,idBaseUrl:l}),i=localStorage.getItem(k.b)||void 0;null===(t=E.a.get())||void 0===t||t.startSingleSignOn(e,"sso",a,i,r.c.LOGIN)}}}),o.a.error("Failed to log in with login token:"),o.a.error(e),!1))):(o.a.warn("Cannot log in with token: can't determine HS URL to use"),v.b.createDialog(P.a,{title:Object(D.b)("We couldn't log you in"),description:Object(D.b)("We asked the browser to remember which homeserver you use to let you sign in, but unfortunately your browser has forgotten it. Go to the sign in page and try again."),button:Object(D.b)("Try again")}),Promise.resolve(!1))}function J(e){if(e.reason===i.c.TOGGLED_LAZY_LOADING)return Promise.resolve().then((()=>{const t=e.value;return new Promise(t?e=>{v.b.createDialog(M.a,{onFinished:e})}:e=>{v.b.createDialog(A.a,{onFinished:e,host:window.location.host})})})).then((()=>l.a.get().store.deleteAllData())).then((()=>{var e;null===(e=E.a.get())||void 0===e||e.reload()}))}async function Q(){const e=localStorage.getItem(K),t=localStorage.getItem(G);let a;try{a=await _.c("account","mx_access_token")}catch(e){o.a.error("StorageManager.idbLoad failed for account:mx_access_token",e)}var n;if(!a&&(a=null!==(n=localStorage.getItem("mx_access_token"))&&void 0!==n?n:void 0,a))try{await _.d("account","mx_access_token",a),localStorage.removeItem("mx_access_token")}catch(e){o.a.error("migration of access token to IndexedDB failed",e)}const i="true"===localStorage.getItem("mx_has_access_token")||!!a,s=localStorage.getItem("mx_user_id"),r=localStorage.getItem("mx_device_id");let l;return l=null!==localStorage.getItem("mx_is_guest")?"true"===localStorage.getItem("mx_is_guest"):"true"===localStorage.getItem("matrix-is-guest"),{hsUrl:e,isUrl:t,hasAccessToken:i,accessToken:a,userId:s,deviceId:r,isGuest:l}}async function X(e){const t=new Uint8Array(e.length);for(let a=0;a<e.length;a++)t[a]=e.charCodeAt(a);const a=await window.crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await window.crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},a,256))}async function Z(){if(await async function(){const{finished:e}=v.b.createDialog(L.a),[t]=await e;return!!t}())throw await ue(),new ie("Aborting login in progress because of storage inconsistency")}async function ee(e){const t=null==e?void 0:e.ignoreGuest;if(!localStorage)return!1;const{hsUrl:a,isUrl:n,hasAccessToken:i,accessToken:r,userId:l,deviceId:c,isGuest:d}=await Q();if(i&&!r&&await Z(),r&&l&&a){var m;if(t&&d)return o.a.log("Ignoring stored guest account: "+l),!1;let e=r;const i=await(null===(m=E.a.get())||void 0===m?void 0:m.getPickleKey(l,c));if(i){if(o.a.log("Got pickle key"),"string"!=typeof r){const t=await X(i);e=await Object(s.b)(r,t,"access_token"),t.fill(0)}}else o.a.log("No pickle key available");const h="true"===sessionStorage.getItem("mx_fresh_login");return sessionStorage.removeItem("mx_fresh_login"),o.a.log(`Restoring session for ${l}`),await ne({userId:l,deviceId:c,accessToken:e,homeserverUrl:a,identityServerUrl:n,guest:d,pickleKey:null!=i?i:void 0,freshLogin:h},!1),!0}return o.a.log("No previous session found."),!1}async function te(e){var t;e.freshLogin=!0,pe();const a=e.userId&&e.deviceId?await(null===(t=E.a.get())||void 0===t?void 0:t.createPickleKey(e.userId,e.deviceId)):null;return a?o.a.log("Created pickle key"):o.a.log("Pickle key not created"),ne(Object.assign({},e,{pickleKey:a}),!0)}async function ae(e){const t=l.a.get().getUserId(),a=l.a.get().getDeviceId();pe(),localStorage.removeItem("mx_soft_logout"),oe=!1;const n=e.userId!==t||e.deviceId!==a;var i,s;(n&&o.a.warn("Clearing all data: Old session belongs to a different user/session"),e.pickleKey)||(o.a.info("Lifecycle#hydrateSession: Pickle key not provided - trying to get one"),e.pickleKey=null!==(i=await(null===(s=E.a.get())||void 0===s?void 0:s.getPickleKey(e.userId,e.deviceId)))&&void 0!==i?i:void 0);return ne(e,n)}async function ne(e,t){e.guest=Boolean(e.guest);const a=ce();o.a.log("setLoggedIn: mxid: "+e.userId+" deviceId: "+e.deviceId+" guest: "+e.guest+" hs: "+e.homeserverUrl+" softLogout: "+a," freshLogin: "+e.freshLogin),t&&await ue();const n=await _.a();n.dataInLocalStorage&&n.cryptoInited&&!n.dataInCryptoStore&&await Z(),l.a.replaceUsingCreds(e),Object(F.c)(e.userId),I.a.instance.isEnabled()&&I.a.instance.startListeningToSettingsChanges();const i=l.a.get();if(e.freshLogin&&S.b.getValue("feature_dehydration")){const t=await i.rehydrateDevice();t&&(e.deviceId=t),delete e.freshLogin}if(localStorage)try{await se(e),sessionStorage.removeItem("mx_fresh_login")}catch(e){o.a.warn("Error using local storage: can't persist session!",e)}else o.a.warn("No local storage available: can't persist session!");return g.a.fire(W.a.OnLoggedIn),await me(!a),i}g.a.register((e=>{if(e.action===W.a.TriggerLogout)he();else if(e.action===W.a.OverwriteLogin){ne(e.credentials,!0)}}));class ie extends Error{}async function se(e){var t;if(localStorage.setItem(K,e.homeserverUrl),e.identityServerUrl&&localStorage.setItem(G,e.identityServerUrl),localStorage.setItem("mx_user_id",e.userId),localStorage.setItem("mx_is_guest",JSON.stringify(e.guest)),e.accessToken?localStorage.setItem("mx_has_access_token","true"):localStorage.deleteItem("mx_has_access_token"),e.pickleKey){let t;try{const a=await X(e.pickleKey);t=await Object(s.c)(e.accessToken,a,"access_token"),a.fill(0)}catch(e){o.a.warn("Could not encrypt access token",e)}try{await _.d("account","mx_access_token",t||e.accessToken)}catch(t){localStorage.setItem("mx_access_token",e.accessToken)}localStorage.setItem("mx_has_pickle_key",String(!0))}else{try{await _.d("account","mx_access_token",e.accessToken)}catch(t){localStorage.setItem("mx_access_token",e.accessToken)}"true"===localStorage.getItem("mx_has_pickle_key")&&o.a.error("Expected a pickle key, but none provided.  Encryption may not work.")}e.deviceId&&localStorage.setItem("mx_device_id",e.deviceId),null===(t=c.a.persistCredentials)||void 0===t||t.call(c.a,e),o.a.log(`Session persisted for ${e.userId}`)}let oe=!1;function re(){var t;if(!l.a.get())return;if(I.a.instance.logout(),l.a.get().isGuest())return void e((()=>he()));oe=!0;const a=l.a.get();null===(t=E.a.get())||void 0===t||t.destroyPickleKey(a.getSafeUserId(),a.getDeviceId()),a.logout(!0).then(he,(e=>{o.a.warn("Failed to call logout API: token will not be invalidated",e),he()}))}function le(){l.a.get()&&(localStorage.setItem("mx_soft_logout","true"),o.a.log("Soft logout initiated"),oe=!0,g.a.dispatch({action:"on_client_not_viable"}),pe(!1))}function ce(){return"true"===localStorage.getItem("mx_soft_logout")}function de(){return oe}async function me(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];o.a.log("Lifecycle: Starting MatrixClient"),g.a.dispatch({action:"will_start_client"},!0),H.b.instance.typingStore.reset(),w.a.sharedInstance().reset(),V.a.instance.prepare(),h.default.start(),u.a.sharedInstance().start(),b.a.makeShared().start(),O.a.sharedInstance().startWatching(),f.b.instance.start(),T.b.instance.start(),C.a.sharedInstance().start(),e?(await d.a.init(),await l.a.start()):(o.a.warn("Caller requested only auxiliary services be started"),await l.a.assign()),S.b.runMigrations(),x.a.sharedInstance().start(),S.b.getValue("lowBandwidth")||p.a.start(),j.a.getInstance().start(),g.a.dispatch({action:"client_started"}),ce()&&le()}async function he(){var e,t;g.a.fire(W.a.OnLoggedOut,!0),pe(),await ue({deleteEverything:!0}),null===(e=N.a.onLoggedOutAndStorageCleared)||void 0===e||e.call(N.a),await(null===(t=E.a.get())||void 0===t?void 0:t.clearStorage()),B.b.get().logout_redirect_url&&(o.a.log("Redirecting to external provider to finish logout"),window.setTimeout((()=>{window.location.href=B.b.get().logout_redirect_url}),100)),oe=!1}async function ue(e){var t;if(window.localStorage){const t=R.a.instance.getWireInvites(),a=window.localStorage.getItem("mx_registration_time");window.localStorage.clear(),z.a.clear();try{await _.b("account","mx_access_token")}catch(e){o.a.error("idbDelete failed for account:mx_access_token",e)}null!=e&&e.deleteEverything||(t.forEach((e=>{const t=e.roomId;delete e.roomId,R.a.instance.storeInvite(t,e)})),a&&window.localStorage.setItem("mx_registration_time",a))}null===(t=window.sessionStorage)||void 0===t||t.clear();const a=Object(m.a)({baseUrl:""});await d.a.deleteEventIndex(),await a.clearStores()}function pe(){var e;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];h.default.stop(),T.b.instance.stop(),u.a.sharedInstance().stop(),H.b.instance.typingStore.reset(),p.a.stop(),f.b.instance.stop(),O.a.sharedInstance().stopWatching(),C.a.sharedInstance().stop(),x.a.sharedInstance().stop(),null===(e=b.a.shared())||void 0===e||e.stop(),d.a.stop();const a=l.a.get();a&&(a.stopClient(),a.removeAllListeners(),t&&(l.a.unset(),d.a.unset()))}window.mxLoginWithAccessToken=async(e,t)=>{const a=Object(n.createClient)({baseUrl:e,accessToken:t}),{user_id:i}=await a.whoami();await ne({homeserverUrl:e,accessToken:t,userId:i},!0)}}).call(this,a(54).setImmediate)},494:function(e,t,a){"use strict";a.d(t,"a",(function(){return c})),a.d(t,"b",(function(){return d}));var n=a(122),i=a.n(n),s=a(136),o=a(1),r=a(360),l=a(302);class c{constructor(e,t,a,n){this.hsUrl=e,this.isUrl=t,this.fallbackHsUrl=a,i()(this,"flows",[]),i()(this,"defaultDeviceDisplayName",void 0),i()(this,"tempClient",null),this.defaultDeviceDisplayName=n.defaultDeviceDisplayName}getHomeserverUrl(){return this.hsUrl}getIdentityServerUrl(){return this.isUrl}setHomeserverUrl(e){this.tempClient=null,this.hsUrl=e}setIdentityServerUrl(e){this.tempClient=null,this.isUrl=e}createTemporaryClient(){return this.tempClient||(this.tempClient=Object(s.createClient)({baseUrl:this.hsUrl,idBaseUrl:this.isUrl})),this.tempClient}async getFlows(){const e=this.createTemporaryClient(),{flows:t}=await e.loginFlows(),a=t.find((e=>"m.login.sso"===e.type&&r.a.findIn(e)));return this.flows=a?[a]:t,this.flows}loginViaPassword(e,t,a,n){const i=!!e&&e.indexOf("@")>0;let s;s=t&&a?{type:"m.id.phone",country:t,phone:a,number:a}:i?{type:"m.id.thirdparty",medium:"email",address:e}:{type:"m.id.user",user:e};const r={password:n,identifier:s,initial_device_display_name:this.defaultDeviceDisplayName},l=e=>d(this.fallbackHsUrl,this.isUrl,"m.login.password",r).catch((t=>{throw o.a.log("fallback HS login failed",t),e}));let c=null;return d(this.hsUrl,this.isUrl,"m.login.password",r).catch((e=>{if(c=e,403===e.httpStatus&&this.fallbackHsUrl)return l(c);throw c})).catch((e=>{throw o.a.log("Login failed",e),e}))}}async function d(e,t,a,n){var i;const r=Object(s.createClient)({baseUrl:e,idBaseUrl:t}),c=await r.login(a,n),d=c.well_known;var m,h;d&&(null!==(m=d["m.homeserver"])&&void 0!==m&&m.base_url&&(e=d["m.homeserver"].base_url,o.a.log(`Overrode homeserver setting with ${e} from login response`)),null!==(h=d["m.identity_server"])&&void 0!==h&&h.base_url&&(t=d["m.identity_server"].base_url,o.a.log(`Overrode IS setting with ${t} from login response`)));const u={homeserverUrl:e,identityServerUrl:t,userId:c.user_id,deviceId:c.device_id,accessToken:c.access_token};return null===(i=l.a.examineLoginResponse)||void 0===i||i.call(l.a,c,u),u}},495:function(e,t,a){"use strict";a.d(t,"a",(function(){return c}));var n=a(120),i=a.n(n),s=a(123),o=a(121),r=a(137),l=a(695);class c extends i.a.Component{constructor(e){var t;super(e),this.state={verificationRequest:this.props.verificationRequest},null===(t=this.props.verificationRequestPromise)||void 0===t||t.then((e=>{this.setState({verificationRequest:e})}))}render(){const e=this.state.verificationRequest,t=null==e?void 0:e.otherUserId,a=this.props.member||(t?s.a.get().getUser(t):null),n=null!=e&&e.isSelfVerification?Object(o.b)("Verify other device"):Object(o.b)("Verification Request");return i.a.createElement(r.a,{className:"mx_InfoDialog",onFinished:this.props.onFinished,contentId:"mx_Dialog_content",title:n,hasCancel:!0},i.a.createElement(l.a,{layout:"dialog",verificationRequest:this.props.verificationRequest,verificationRequestPromise:this.props.verificationRequestPromise,onClose:this.props.onFinished,member:a,isRoomEncrypted:!1}))}}},496:function(e,t,a){"use strict";a.d(t,"a",(function(){return b})),a.d(t,"b",(function(){return v}));var n=a(122),i=a.n(n),s=a(17),o=a.n(s),r=a(244),l=a(1),c=a(172),d=a(123),m=a(258),h=a(129),u=a(263),p=a(121),g=a(154);let b=function(e){return e[e.Loading=0]="Loading",e[e.Intro=1]="Intro",e[e.Busy=2]="Busy",e[e.Done=3]="Done",e[e.ConfirmSkip=4]="ConfirmSkip",e[e.Finished=5]="Finished",e[e.ConfirmReset=6]="ConfirmReset",e}({});class v extends o.a{constructor(){super(...arguments),i()(this,"started",void 0),i()(this,"phase",void 0),i()(this,"verificationRequest",null),i()(this,"backupInfo",null),i()(this,"keyId",null),i()(this,"keyInfo",null),i()(this,"hasDevicesToVerifyAgainst",void 0),i()(this,"onUserTrustStatusChanged",(e=>{if(e!==d.a.get().getUserId())return;d.a.get().getCrossSigningId()&&(this.phase=b.Done,this.emit("update"))})),i()(this,"onVerificationRequest",(e=>{this.setActiveVerificationRequest(e)})),i()(this,"onVerificationRequestChange",(()=>{var e,t;if(null!==(e=this.verificationRequest)&&void 0!==e&&e.cancelled)this.verificationRequest.off(r.l.Change,this.onVerificationRequestChange),this.verificationRequest=null,this.emit("update");else if((null===(t=this.verificationRequest)||void 0===t?void 0:t.phase)===r.b){this.verificationRequest.off(r.l.Change,this.onVerificationRequestChange),this.verificationRequest=null;const e=d.a.get().getCrossSigningId();this.phase=e?b.Done:b.Busy,this.emit("update")}}))}static sharedInstance(){return window.mxSetupEncryptionStore||(window.mxSetupEncryptionStore=new v),window.mxSetupEncryptionStore}start(){if(this.started)return;this.started=!0,this.phase=b.Loading;const e=d.a.get();e.on(c.b.VerificationRequest,this.onVerificationRequest),e.on(c.b.UserTrustStatusChanged,this.onUserTrustStatusChanged);const t=e.getVerificationRequestsToDeviceInProgress(e.getUserId());t.length&&this.setActiveVerificationRequest(t[t.length-1]),this.fetchKeyInfo()}stop(){var e;this.started&&(this.started=!1,null===(e=this.verificationRequest)||void 0===e||e.off(r.l.Change,this.onVerificationRequestChange),d.a.get()&&(d.a.get().removeListener(c.b.VerificationRequest,this.onVerificationRequest),d.a.get().removeListener(c.b.UserTrustStatusChanged,this.onUserTrustStatusChanged)))}async fetchKeyInfo(){if(!this.started)return;const e=d.a.get(),t=await e.isSecretStored("m.cross_signing.master");null===t||0===Object.keys(t).length?(this.keyId=null,this.keyInfo=null):(this.keyId=Object.keys(t)[0],this.keyInfo=t[this.keyId]);const a=await e.getDehydratedDevice(),n=e.getUserId(),i=e.getStoredCrossSigningForUser(n);this.hasDevicesToVerifyAgainst=e.getStoredDevicesForUser(n).some((e=>e.getIdentityKey()&&(!a||e.deviceId!=a.device_id)&&(null==i?void 0:i.checkDeviceTrust(i,e,!1,!0).isCrossSigningVerified()))),this.phase=b.Intro,this.emit("update")}async usePassPhrase(){this.phase=b.Busy,this.emit("update");const e=d.a.get();try{const t=await e.getKeyBackupVersion();this.backupInfo=t,this.emit("update"),await new Promise(((a,n)=>{Object(m.b)((async()=>{await e.checkOwnCrossSigningTrust(),a(),t&&await e.restoreKeyBackupWithSecretStorage(t)})).catch(n)})),e.getCrossSigningId()&&(this.phase=b.Done,this.emit("update"))}catch(e){e instanceof m.a||l.a.log(e),this.phase=b.Intro,this.emit("update")}}skip(){this.phase=b.ConfirmSkip,this.emit("update")}skipConfirm(){this.phase=b.Finished,this.emit("update")}returnAfterSkip(){this.phase=b.Intro,this.emit("update")}reset(){this.phase=b.ConfirmReset,this.emit("update")}async resetConfirm(){try{await Object(m.b)((async()=>{const e=d.a.get();await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const a=g.b.instance.accountPasswordStore.getPassword();if(a)return void await t({type:"m.login.password",identifier:{type:"m.id.user",user:e.getUserId()},user:e.getUserId(),password:a});const{finished:n}=h.b.createDialog(u.a,{title:Object(p.b)("Setting up keys"),matrixClient:e,makeRequest:t}),[i]=await n;if(!i)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:!0}),this.phase=b.Finished}),!0)}catch(e){l.a.error("Error resetting cross-signing",e),this.phase=b.Intro}this.emit("update")}returnAfterReset(){this.phase=b.Intro,this.emit("update")}done(){var e;this.phase=b.Finished,this.emit("update"),null===(e=d.a.get().crypto)||void 0===e||e.cancelAndResendAllOutgoingKeyRequests()}async setActiveVerificationRequest(e){this.started&&e.otherUserId===d.a.get().getUserId()&&(this.verificationRequest&&this.verificationRequest.off(r.l.Change,this.onVerificationRequestChange),this.verificationRequest=e,await e.accept(),e.on(r.l.Change,this.onVerificationRequestChange),this.emit("update"))}lostKeys(){return!this.hasDevicesToVerifyAgainst&&!this.keyInfo}}},497:function(e,t,a){"use strict";a.d(t,"a",(function(){return s})),a.d(t,"b",(function(){return r}));var n=a(1638),i=a.n(n);let s=function(e){return e.Desktop="Desktop",e.Mobile="Mobile",e.Web="Web",e.Unknown="Unknown",e}({});const o=(e,t)=>e&&[e,t].filter(Boolean).join(" "),r=e=>{if(!e)return{deviceType:s.Unknown};const t=new i.a(e),a=t.getBrowser(),n=t.getDevice(),r=t.getOS(),l=((e,t,a,n)=>{var i;return"Electron"===a.name?s.Desktop:a.name?s.Web:"mobile"===t.type||null!==(i=n.name)&&void 0!==i&&i.includes("Android")||e.indexOf("; iOS ")>-1?s.Mobile:s.Unknown})(e,n,a,r),c=l===s.Web||l===s.Desktop,d=o(r.name,c?void 0:r.version),m=o(n.vendor,n.model),h=o(a.name,a.version),{customDeviceModel:u,customDeviceOS:p}=l!==s.Unknown?(e=>{if(e.includes("Mozilla/"))return{};if(!e.includes("("))return{};const t=e.substring(e.indexOf("(")+1).split("; ");return{customDeviceModel:t[0]||void 0,customDeviceOS:t[1]||void 0}})(e):{};return{deviceType:l,deviceModel:m||u,deviceOperatingSystem:d||p,client:h}}},498:function(e,t,a){"use strict";a.d(t,"a",(function(){return o})),a.d(t,"b",(function(){return r}));var n=a(1),i=a(246),s=a(19);function o(e){const t=new s.a(e).get("embedded_pages");let a=t?new s.a(t).get("home_url"):null;var o;(a||(a=e.welcomePageUrl,a&&n.a.warn("You are using a deprecated config option: `welcomePageUrl`. Please use `embedded_pages.home_url` instead, per https://github.com/vector-im/element-web/issues/21428")),a)||(a=null===(o=Object(i.d)())||void 0===o?void 0:o.home_url);return a}function r(e){const t=new s.a(e).get("embedded_pages");return!!t&&!0===new s.a(t).get("login_for_welcome")}},499:function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));let n=function(e){return e.PersonalMessaging="PersonalMessaging",e.WorkMessaging="WorkMessaging",e.CommunityMessaging="CommunityMessaging",e.Skip="Skip",e}({})},500:function(e,t,a){"use strict";var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(141),l=a(121),c=a(204),d=a(337);class m extends s.PureComponent{constructor(){super(...arguments),i()(this,"validate",Object(c.a)({rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(l.b)(this.props.labelRequired)},{key:"email",test:e=>{let{value:t}=e;return!t||d.a(t)},invalid:()=>Object(l.b)(this.props.labelInvalid)}]})),i()(this,"onValidate",(async e=>{let t=this.validate;this.props.validationRules&&(t=this.props.validationRules);const a=await t(e);return this.props.onValidate&&this.props.onValidate(a),a}))}render(){return o.a.createElement(r.a,{id:this.props.id,ref:this.props.fieldRef,type:"text",label:Object(l.b)(this.props.label),value:this.props.value,autoFocus:this.props.autoFocus,onChange:this.props.onChange,onValidate:this.onValidate})}}i()(m,"defaultProps",{label:Object(l.d)("Email"),labelRequired:Object(l.d)("Enter email address"),labelInvalid:Object(l.d)("Doesn't look like a valid email address")}),t.a=m},501:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n=a(127),i=a.n(n),s=a(120),o=a.n(s);function r(e){let{flex:t,className:a,children:n}=e;return o.a.createElement("main",{className:i()("mx_AuthBody",a,{mx_AuthBody_flex:t})},n)}},509:function(e,t,a){"use strict";a.d(t,"b",(function(){return rt})),a.d(t,"a",(function(){return ct}));var n=a(120),i=a.n(n),s=a(136),o=a(123),r=a(142);var l=a(169),c=a(1),d=a(281),m=a(167);const h=5e3;function u(e,t){const[a,i]=Object(n.useState)(e),r=o.a.get(),l=function(e){const t=Object(n.useRef)(e);return t.current=e,Object(n.useCallback)((function(){return t.current(...arguments)}),[])}(t);return Object(n.useEffect)((()=>{if(a)return;let e=null,t=!0;const n=async()=>{null!==e&&(clearTimeout(e),e=null),i(await l(r)),t&&(e=window.setTimeout(n,h))};return n().catch((e=>c.a.warn("could not update user onboarding context",e))),r.on(s.ClientEvent.AccountData,n),()=>{t=!1,r.off(s.ClientEvent.AccountData,n),null!==e&&(clearTimeout(e),e=null)}}),[r,l,a]),a}var p,g,b,v,f,E,y,_,S,w,O,C,x,j,k,R,I,T,N,P,D,M,A,U,L,F,B,V=a(122),W=a.n(V);function z(){return z=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},z.apply(this,arguments)}function H(e){return n.createElement("svg",z({viewBox:"0 0 564 168",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0},e),p||(p=n.createElement("defs",null,n.createElement("radialGradient",{id:"f-droid_svg__a",cx:113,cy:-12.89,r:59.662,gradientTransform:"matrix(0 1.9611 -1.9778 0 5.51 -198.6)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#fff",stopOpacity:.098,offset:0}),n.createElement("stop",{stopColor:"#fff",stopOpacity:0,offset:1})))),g||(g=n.createElement("path",{d:"M22 2h520c11.08 0 20 8.92 20 20v124c0 11.08-8.92 20-20 20H22c-11.08 0-20-8.92-20-20V22C2 10.92 10.92 2 22 2z",stroke:"#a6a6a6",strokeWidth:4})),b||(b=n.createElement("path",{d:"M199.26 45.46v-6.682h-5.499v-2.766h8.831v10.681q-1.949 1.383-4.299 2.1-2.349.7-5.015.7-5.832 0-9.131-3.4-3.283-3.415-3.283-9.497 0-6.099 3.283-9.498 3.3-3.416 9.131-3.416 2.433 0 4.616.6 2.2.6 4.049 1.766v3.583q-1.867-1.583-3.966-2.383-2.1-.8-4.416-.8-4.565 0-6.865 2.55-2.283 2.549-2.283 7.598 0 5.032 2.283 7.581 2.3 2.55 6.865 2.55 1.783 0 3.183-.3 1.4-.317 2.516-.967zm9.48-21.33h15.729v2.833h-12.364v7.365h11.847v2.832h-11.847v9.015h12.664v2.832H208.74zm18.12 0h21.045v2.833h-8.831v22.045h-3.383V26.963h-8.83zm35.14 0h3.366v24.877H262zm6.61 0h21.045v2.833h-8.831v22.045h-3.383V26.963h-8.83zm45.24 2.28q-3.666 0-5.832 2.733-2.15 2.732-2.15 7.448 0 4.699 2.15 7.431 2.166 2.733 5.832 2.733t5.799-2.733q2.15-2.732 2.15-7.431 0-4.716-2.15-7.448-2.133-2.733-5.799-2.733zm0-2.733q5.232 0 8.365 3.516 3.132 3.5 3.132 9.398 0 5.882-3.132 9.397-3.133 3.5-8.365 3.5-5.249 0-8.398-3.5-3.132-3.499-3.132-9.397t3.132-9.398q3.15-3.516 8.398-3.516zm16.76.453h4.532l11.031 20.812V24.13h3.266v24.877h-4.532l-11.031-20.812v20.812h-3.266z",fill:"#fff","aria-label":"GET IT ON"})),v||(v=n.createElement("path",{d:"M180.81 136v-8.118l7.19-1.391V78.017l-7.19-1.392v-8.164h53.762v18.508h-10.391l-.603-8.071h-22.034v18.6h23.657v10.438h-23.657v18.555l7.236 1.391V136zm62.16-23.66v-10.437h26.162v10.437zM277.29 136v-8.118l7.283-1.53v-48.15l-7.283-1.577v-8.164h29.641q9.045 0 15.957 4.268 6.912 4.221 10.762 11.736 3.897 7.468 3.897 17.163v1.252q0 9.602-3.85 17.117-3.804 7.468-10.67 11.736-6.865 4.268-15.91 4.268zm20.828-10.344h8.303q5.613 0 9.51-2.922 3.896-2.97 5.937-8.118 2.087-5.149 2.087-11.736v-1.299q0-6.68-2.087-11.782-2.041-5.149-5.938-8.025-3.896-2.922-9.509-2.922h-8.303zM344.79 136v-8.118l6.494-1.391V95.366l-7.19-1.392V85.81h19.807l.51 6.216.093 1.113q1.856-4.082 4.593-6.17 2.736-2.087 6.54-2.087 1.206 0 2.644.232 1.438.186 2.551.51l-1.438 12.478-6.726-.37q-2.876-.14-4.685.974-1.763 1.113-3.154 3.2v24.585l6.494 1.392V136zm63.08.98q-7.422 0-12.756-3.247t-8.164-9q-2.83-5.797-2.83-13.312v-.974q0-7.469 2.83-13.22 2.83-5.799 8.118-9.046 5.334-3.293 12.71-3.293 7.468 0 12.756 3.293 5.288 3.247 8.117 9t2.83 13.266v.974q0 7.515-2.83 13.313-2.83 5.752-8.117 9-5.289 3.247-12.664 3.247zm0-10.391q3.525 0 5.752-1.902t3.293-5.288q1.067-3.433 1.067-7.979v-.974q0-4.453-1.067-7.839-1.066-3.433-3.34-5.335-2.226-1.948-5.798-1.948-3.479 0-5.752 1.948-2.273 1.902-3.34 5.335-1.02 3.386-1.02 7.84v.973q0 4.546 1.02 7.979 1.067 3.433 3.34 5.334 2.273 1.856 5.845 1.856zM437.1 136v-8.118l6.54-1.391V95.366l-7.236-1.392V85.81h20.781v40.681l6.494 1.392V136zm6.077-60.813v-11.55h14.009v11.55zm44.293 61.793q-5.984 0-10.298-3.062-4.268-3.107-6.54-8.627-2.273-5.567-2.273-12.988v-.975q0-7.932 2.273-13.87 2.319-5.937 6.586-9.23 4.268-3.34 10.205-3.34 4.129 0 7.237 1.67 3.108 1.623 5.38 4.638V73.198l-7.236-1.391v-8.164h20.781v62.854l6.494 1.391v8.118h-18.23l-1.02-6.123q-2.366 3.479-5.66 5.288-3.246 1.81-7.7 1.81zm4.036-10.53q2.83 0 4.963-1.206 2.134-1.206 3.572-3.479v-21.292q-1.392-2.412-3.526-3.71-2.133-1.346-4.917-1.346-3.386 0-5.566 2.04-2.134 1.995-3.154 5.567-.974 3.572-.974 8.303v.975q0 6.587 2.226 10.39 2.227 3.758 7.376 3.758z",fill:"#fff","aria-label":"F-Droid"})),f||(f=n.createElement("path",{d:"M146.34 25.898l-11.184 14.474",fill:"#8ab000",stroke:"#769616",strokeLinecap:"round",strokeWidth:6.579})),E||(E=n.createElement("path",{d:"M146.29 22.477c1.192.032 2.003.497 2.579 1.182-5.332 6.34-6.232 7.344-13.513 16.37-2.684 3.472-5.479 1.677-2.795-1.794l11.184-14.474a3.26 3.26 0 012.545-1.284z",color:"#000",fill:"#fff",fillOpacity:.298})),y||(y=n.createElement("path",{d:"M148.89 23.793a3.29 3.29 0 01.058 4.095l-11.184 14.474c-2.684 3.474-3.026-1.61-3.026-1.61s9.829-11.87 14.153-16.959z",color:"#000",fill:"#263238",fillOpacity:.2})),_||(_=n.createElement("path",{d:"M147 23.003c1.153 0 2.526.374 2.168 2.103-.27 1.318-12.263 15.984-12.263 15.984-2.684 3.47-6.563 1.779-3.879-1.693l11.142-14.4c.685-.763 1.603-1.957 2.832-1.994z",color:"#000",fill:"#8ab000"})),S||(S=n.createElement("path",{d:"M33.653 25.898l11.184 14.474",fill:"#8ab000",stroke:"#769616",strokeLinecap:"round",strokeWidth:6.579})),w||(w=n.createElement("path",{d:"M33.711 22.477c-1.192.032-2.003.497-2.579 1.182 5.332 6.34 6.232 7.344 13.513 16.37 2.684 3.472 5.479 1.677 2.795-1.794L36.256 23.76a3.26 3.26 0 00-2.545-1.284z",color:"#000",fill:"#fff",fillOpacity:.298})),O||(O=n.createElement("path",{d:"M31.108 23.793a3.29 3.29 0 00-.058 4.095l11.184 14.474c2.684 3.474 3.026-1.61 3.026-1.61s-9.829-11.87-14.153-16.959z",color:"#000",fill:"#263238",fillOpacity:.2})),C||(C=n.createElement("path",{d:"M32.993 23.003c-1.153 0-2.526.374-2.168 2.103.27 1.318 12.263 15.984 12.263 15.984 2.684 3.47 6.563 1.779 3.879-1.693l-11.142-14.4c-.685-.763-1.603-1.957-2.832-1.994z",color:"#000",fill:"#8ab000"})),x||(x=n.createElement("path",{d:"M47.893 35.109h84.211a7.878 7.878 0 017.895 7.894v18.211a7.878 7.878 0 01-7.895 7.895H47.893a7.878 7.878 0 01-7.895-7.895v-18.21a7.878 7.878 0 017.895-7.895z",fill:"#aeea00"})),j||(j=n.createElement("path",{d:"M47.893 42.74h84.211a7.878 7.878 0 017.895 7.895v10.526a7.878 7.878 0 01-7.895 7.895H47.893a7.878 7.878 0 01-7.895-7.895V50.635a7.878 7.878 0 017.895-7.895z",fill:"#263238",fillOpacity:.2})),k||(k=n.createElement("path",{d:"M47.893 35.109h84.211a7.878 7.878 0 017.895 7.894V53.53a7.878 7.878 0 01-7.895 7.895H47.893a7.878 7.878 0 01-7.895-7.895V43.003a7.878 7.878 0 017.895-7.894z",fill:"#fff",fillOpacity:.298})),R||(R=n.createElement("path",{d:"M47.893 38.003h84.211c4.374 0 7.895 2.883 7.895 6.462v15.079c0 3.58-3.521 6.462-7.895 6.462H47.893c-4.374 0-7.895-2.882-7.895-6.462V44.465c0-3.58 3.521-6.462 7.895-6.462z",fill:"#aeea00"})),I||(I=n.createElement("path",{d:"M47.893 71.944h84.211a7.878 7.878 0 017.895 7.895v52.211a7.878 7.878 0 01-7.895 7.895H47.893a7.878 7.878 0 01-7.895-7.895V79.839a7.878 7.878 0 017.895-7.895z",fill:"#1976d2"})),T||(T=n.createElement("path",{d:"M47.893 105.89h84.211a7.878 7.878 0 017.895 7.895v18.42a7.878 7.878 0 01-7.895 7.896H47.893a7.878 7.878 0 01-7.895-7.895v-18.421a7.878 7.878 0 017.895-7.895z",fill:"#263238",fillOpacity:.2})),N||(N=n.createElement("path",{d:"M47.893 71.681h84.211a7.878 7.878 0 017.895 7.895v18.421a7.878 7.878 0 01-7.895 7.895H47.893a7.878 7.878 0 01-7.895-7.895V79.576a7.878 7.878 0 017.895-7.895z",fill:"#fff",fillOpacity:.2})),P||(P=n.createElement("path",{d:"M47.893 75.102h84.211c4.374 0 7.895 3.19 7.895 7.154v47.693c0 3.963-3.521 7.153-7.895 7.153H47.893c-4.374 0-7.895-3.19-7.895-7.153V82.256c0-3.963 3.521-7.154 7.895-7.154z",fill:"#1976d2"})),D||(D=n.createElement("path",{d:"M89.998 89.714c-7.579 0-14 5.224-15.876 12.237h8.455a8.46 8.46 0 017.421-4.342 8.495 8.495 0 018.553 8.553 8.495 8.495 0 01-8.553 8.552 8.471 8.471 0 01-7.71-4.868h-8.3c1.69 7.279 8.242 12.763 16.01 12.763 9.038 0 16.449-7.41 16.449-16.448 0-9.037-7.41-16.448-16.448-16.448z",color:"#000",fill:"#0d47a1"})),M||(M=n.createElement("path",{d:"M115.13 106.16a25.132 25.132 0 01-25.132 25.132 25.132 25.132 0 01-25.131-25.132 25.132 25.132 0 0125.131-25.132 25.132 25.132 0 0125.132 25.132z",fill:"none",stroke:"#0d47a1",strokeLinecap:"round",strokeWidth:5})),A||(A=n.createElement("path",{d:"M73.55 52.477a8.882 10.197 0 01-8.88 10.198 8.882 10.197 0 01-8.882-10.198 8.882 10.197 0 018.881-10.197 8.882 10.197 0 018.882 10.197z",fill:"#263238",fillOpacity:.2})),U||(U=n.createElement("path",{d:"M73.55 53.793a8.882 8.882 0 01-8.88 8.882 8.882 8.882 0 01-8.882-8.882 8.882 8.882 0 018.881-8.882 8.882 8.882 0 018.882 8.882z",fill:"#fff"})),L||(L=n.createElement("path",{d:"M124.87 52.477a8.882 10.197 0 01-8.882 10.198 8.882 10.197 0 01-8.881-10.198 8.882 10.197 0 018.881-10.197 8.882 10.197 0 018.882 10.197z",fill:"#263238",fillOpacity:.2})),F||(F=n.createElement("path",{d:"M124.87 53.793a8.882 8.882 0 01-8.882 8.882 8.882 8.882 0 01-8.881-8.882 8.882 8.882 0 018.881-8.882 8.882 8.882 0 018.882 8.882z",fill:"#fff"})),B||(B=n.createElement("path",{d:"M33.71 22.47a3.29 3.29 0 00-2.662 5.336l9.474 12.262a7.894 7.894 0 00-.527 2.824v18.211a7.877 7.877 0 007.895 7.895h84.21a7.877 7.877 0 007.895-7.895v-18.21c0-1-.19-1.95-.525-2.827l9.472-12.26a3.29 3.29 0 00-2.433-5.334 3.29 3.29 0 00-2.772 1.31l-9.013 11.666a7.91 7.91 0 00-2.623-.45H47.89c-.922 0-1.8.163-2.621.45l-9.016-11.666a3.29 3.29 0 00-2.543-1.312zm14.18 49.527a7.877 7.877 0 00-7.894 7.894v52.211a7.877 7.877 0 007.894 7.895h84.211a7.877 7.877 0 007.894-7.895v-52.21a7.877 7.877 0 00-7.894-7.895z",color:"#000",fill:"url(#f-droid_svg__a)",fillRule:"evenodd"})))}var K,G,q,$,Y,J,Q,X,Z,ee,te,ae,ne,ie,se,oe,re,le,ce,de,me,he;function ue(){return ue=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},ue.apply(this,arguments)}function pe(e){return n.createElement("svg",ue({viewBox:"0 0 180 53.332",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0},e),K||(K=n.createElement("defs",null,n.createElement("linearGradient",{id:"google-play_svg__a",x2:1,gradientTransform:"scale(-31.64 31.64) rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#00a0ff",offset:0}),n.createElement("stop",{stopColor:"#00a1ff",offset:.007}),n.createElement("stop",{stopColor:"#00beff",offset:.26}),n.createElement("stop",{stopColor:"#00d2ff",offset:.512}),n.createElement("stop",{stopColor:"#00dfff",offset:.76}),n.createElement("stop",{stopColor:"#00e3ff",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__b",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#ffe000",offset:0}),n.createElement("stop",{stopColor:"#ffbd00",offset:.409}),n.createElement("stop",{stopColor:"orange",offset:.775}),n.createElement("stop",{stopColor:"#ff9c00",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__c",x2:1,gradientTransform:"scale(-42.903 42.903) rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#ff3a44",offset:0}),n.createElement("stop",{stopColor:"#c31162",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__d",x2:1,gradientTransform:"scale(19.156 -19.156) rotate(-44.998 .238 -.62)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#32a071",offset:0}),n.createElement("stop",{stopColor:"#2da771",offset:.069}),n.createElement("stop",{stopColor:"#15cf74",offset:.476}),n.createElement("stop",{stopColor:"#06e775",offset:.801}),n.createElement("stop",{stopColor:"#00f076",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__e",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#ccb300",offset:0}),n.createElement("stop",{stopColor:"#cc9700",offset:.409}),n.createElement("stop",{stopColor:"#cc8400",offset:.775}),n.createElement("stop",{stopColor:"#cc7d00",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__f",x2:1,gradientTransform:"scale(-42.903 42.903) rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#cc2e36",offset:0}),n.createElement("stop",{stopColor:"#9c0e4e",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__g",x2:1,gradientTransform:"scale(-31.64 31.64) rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#008de0",offset:0}),n.createElement("stop",{stopColor:"#008de0",offset:.007}),n.createElement("stop",{stopColor:"#00a7e0",offset:.26}),n.createElement("stop",{stopColor:"#00b8e0",offset:.512}),n.createElement("stop",{stopColor:"#00c4e0",offset:.76}),n.createElement("stop",{stopColor:"#00c7e0",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__h",x2:1,gradientTransform:"scale(-42.903 42.903) rotate(45 -1.222 -.585)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#e0333c",offset:0}),n.createElement("stop",{stopColor:"#ab0f56",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__i",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#e0c500",offset:0}),n.createElement("stop",{stopColor:"#e0a600",offset:.409}),n.createElement("stop",{stopColor:"#e09100",offset:.775}),n.createElement("stop",{stopColor:"#e08900",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__j",x2:1,gradientTransform:"matrix(-32.255 0 0 32.255 45.098 26.675)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#ffe840",offset:0}),n.createElement("stop",{stopColor:"#ffce40",offset:.409}),n.createElement("stop",{stopColor:"#ffbc40",offset:.775}),n.createElement("stop",{stopColor:"#ffb540",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__k",x2:1,gradientTransform:"scale(-31.64 31.64) rotate(45 -.903 -.925)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#40b8ff",offset:0}),n.createElement("stop",{stopColor:"#40b9ff",offset:.007}),n.createElement("stop",{stopColor:"#40ceff",offset:.26}),n.createElement("stop",{stopColor:"#40ddff",offset:.512}),n.createElement("stop",{stopColor:"#40e7ff",offset:.76}),n.createElement("stop",{stopColor:"#40eaff",offset:1})),n.createElement("linearGradient",{id:"google-play_svg__l",x2:1,gradientTransform:"scale(19.156 -19.156) rotate(-44.998 .238 -.62)",gradientUnits:"userSpaceOnUse"},n.createElement("stop",{stopColor:"#65b895",offset:0}),n.createElement("stop",{stopColor:"#62bd95",offset:.069}),n.createElement("stop",{stopColor:"#50db97",offset:.476}),n.createElement("stop",{stopColor:"#44ed98",offset:.801}),n.createElement("stop",{stopColor:"#40f498",offset:1})))),G||(G=n.createElement("path",{d:"M173.33 53.332H6.67c-3.667 0-6.667-3-6.667-6.667V6.668c0-3.667 3-6.667 6.667-6.667h166.66c3.667 0 6.667 3 6.667 6.667v39.997c0 3.666-3 6.666-6.667 6.666"})),q||(q=n.createElement("path",{d:"M101.93 17.465v-5.118l-.044-1.544-.202.074 4.107 6.588h1.28V9.199h-1.295v4.816l.044 1.544.202-.074-3.927-6.286h-1.458v8.266",fill:"#fff"})),$||($=n.createElement("path",{d:"M173.33 0H6.67C3.003 0 .003 3 .003 6.666v40c0 3.666 3 6.666 6.667 6.666h166.66c3.667 0 6.667-3 6.667-6.667V6.668c0-3.667-3-6.667-6.667-6.667m0 1.067c3.088 0 5.6 2.512 5.6 5.6v39.997c0 3.087-2.512 5.6-5.6 5.6H6.67a5.607 5.607 0 01-5.6-5.6v-40c0-3.087 2.512-5.6 5.6-5.6h166.66",fill:"#a6a6a6"})),Y||(Y=n.createElement("path",{d:"M63.356 13.657c0-.203-.02-.41-.058-.628l-.02-.11h-4.121v1.229h3.038v-.134l-.133-.011c-.058.67-.272 1.176-.632 1.537-.573.571-1.276.853-2.14.854-.81 0-1.499-.28-2.092-.85-.587-.568-.88-1.294-.881-2.212.001-.917.294-1.643.881-2.21.593-.571 1.281-.85 2.092-.851.902.002 1.582.3 2.088.901l.094.112.806-.807.086-.087-.079-.093c-.327-.39-.764-.7-1.3-.93a4.259 4.259 0 00-1.695-.347c-1.185-.001-2.208.416-3.038 1.24-.833.823-1.252 1.857-1.251 3.072-.001 1.215.418 2.25 1.252 3.073.829.824 1.852 1.24 3.037 1.24 1.234 0 2.258-.41 3.036-1.226l-.003.002c.691-.69 1.034-1.622 1.033-2.764M69.502 9.2h-4.937v8.265h4.937v-1.25h-3.643v-2.27h3.286v-1.227h-3.286v-2.27h3.643m4.335 0h2.234v-1.25h-5.764v1.25h2.235v7.017h1.295m7.239 0V9.199h-1.294v8.266m5.853-7.017h2.235v-1.25h-5.764v1.25h2.234v7.017h1.295m6.652-4.132c0-.903.284-1.627.85-2.203.57-.575 1.252-.858 2.078-.86.825.002 1.509.285 2.078.86.566.576.85 1.3.85 2.203s-.284 1.627-.85 2.202c-.57.576-1.253.858-2.078.86-.826-.002-1.508-.284-2.076-.86s-.852-1.3-.852-2.202zm5.957 3.058c.808-.83 1.217-1.86 1.216-3.058 0-1.193-.41-2.22-1.221-3.054-.813-.837-1.83-1.26-3.024-1.259-1.2-.001-2.221.42-3.028 1.254-.81.83-1.217 1.86-1.216 3.059-.001 1.199.406 2.228 1.214 3.06s1.83 1.253 3.03 1.251c1.2.002 2.22-.419 3.029-1.253m-7.387 12.612c-3.136 0-5.693 2.384-5.693 5.67 0 3.266 2.557 5.67 5.693 5.67s5.691-2.405 5.691-5.67c0-3.287-2.555-5.67-5.691-5.67zm0 2.232c1.719 0 3.2 1.397 3.2 3.438 0 2.019-1.481 3.435-3.2 3.435-1.718 0-3.201-1.416-3.201-3.435 0-2.041 1.483-3.438 3.201-3.438zm-12.422-2.232c-3.136 0-5.693 2.384-5.693 5.67 0 3.266 2.557 5.67 5.693 5.67s5.693-2.405 5.693-5.67c0-3.287-2.557-5.67-5.693-5.67zm0 2.232c1.718 0 3.201 1.397 3.201 3.438 0 2.019-1.483 3.435-3.201 3.435-1.719 0-3.2-1.416-3.2-3.435 0-2.041 1.481-3.438 3.2-3.438zm-14.772-.494v2.407h5.757c-.172 1.353-.623 2.34-1.31 3.028-.838.838-2.148 1.762-4.447 1.762-3.544 0-6.315-2.857-6.315-6.401s2.771-6.402 6.315-6.402c1.912 0 3.308.752 4.34 1.719l1.696-1.697c-1.439-1.375-3.35-2.427-6.036-2.427-4.854 0-8.935 3.952-8.935 8.807s4.08 8.806 8.935 8.806c2.621 0 4.597-.859 6.143-2.47 1.59-1.59 2.084-3.823 2.084-5.627 0-.56-.043-1.074-.129-1.504zm55.554-1.74c-2.921 0-5.348 2.3-5.348 5.672 0 3.179 2.405 5.67 5.627 5.67 2.6 0 4.105-1.59 4.727-2.514l-1.934-1.287c-.644.946-1.525 1.566-2.793 1.566-1.267 0-2.17-.578-2.75-1.716l7.582-3.137-.256-.645c-.472-1.268-1.912-3.609-4.855-3.609zm.086 2.191c.989 0 1.826.495 2.105 1.203l-5.068 2.106c-.065-2.191 1.696-3.309 2.963-3.309zm-9.126 8.807h2.493V23.332h-2.492zm-7.15-10.996c-2.835 0-5.434 2.49-5.434 5.691 0 3.18 2.599 5.65 5.434 5.65 1.353 0 2.428-.602 2.986-1.29h.086v.816c0 2.17-1.16 3.33-3.03 3.33-1.524 0-2.47-1.095-2.856-2.02l-2.17.903c.624 1.504 2.278 3.352 5.027 3.352 2.921 0 5.39-1.72 5.39-5.908v-10.18h-2.36v.921h-.087c-.558-.666-1.633-1.265-2.986-1.265zm.215 2.232c1.697 0 3.03 1.461 3.03 3.46 0 1.975-1.333 3.414-3.03 3.414-1.72 0-3.158-1.439-3.158-3.415 0-1.997 1.44-3.459 3.158-3.459zm26.545-7.904v16.668h2.486v-6.315h3.475c2.758 0 5.469-1.997 5.469-5.177s-2.711-5.176-5.47-5.176zm2.486 2.32h3.54c1.86 0 2.915 1.54 2.915 2.858 0 1.29-1.056 2.855-2.916 2.855h-3.539zm18.914 3.321c-1.8 0-3.667.792-4.44 2.55l2.21.923c.472-.922 1.349-1.223 2.273-1.223 1.286 0 2.594.773 2.615 2.144v.172c-.45-.257-1.414-.642-2.594-.642-2.38 0-4.804 1.308-4.804 3.752 0 2.23 1.951 3.668 4.138 3.668 1.673 0 2.596-.751 3.176-1.631h.084v1.287h2.402v-6.39c0-2.96-2.208-4.61-5.06-4.61zm.385 5.938c1.095 0 1.608.236 2.273.558-.193 1.544-1.52 2.639-2.957 2.639l-.002-.002c-.815 0-1.951-.405-1.951-1.414 0-1.286 1.416-1.781 2.637-1.781zm13.415-5.575l-2.852 7.227h-.085l-2.96-7.227h-2.68l4.438 10.1-2.53 5.619h2.596l6.84-15.719zm-22.4 10.664h2.488V23.331h-2.488z",fill:"#fff"})),J||(J=n.createElement("path",{d:"M14.007 43.191l-.099-.095c-.388-.41-.617-1.047-.617-1.873v.194V11.93v.203c0-.894.267-1.567.714-1.97l16.516 16.515-16.515 16.515m-.71-31.48v-.004.003m0-.01",fill:"url(#google-play_svg__a)"})),Q||(Q=n.createElement("path",{d:"M36.025 32.378l.126-.071 6.522-3.706c.622-.354 1.036-.782 1.243-1.236-.206.454-.621.883-1.243 1.236l-6.522 3.706-.126.071m.002-.195l-5.506-5.507 5.505-5.506 6.647 3.776c.844.48 1.318 1.098 1.397 1.73v.002c-.08.63-.553 1.248-1.397 1.728l-6.646 3.777",fill:"url(#google-play_svg__b)"})),X||(X=n.createElement("path",{d:"M15.184 43.819a1.723 1.723 0 00.002 0 2.515 2.515 0 00-.002 0m0-.195c-.46 0-.863-.15-1.177-.433l16.515-16.516 5.506 5.507L16.68 43.176c-.536.304-1.043.447-1.494.447m-1.182-.241a1.814 1.814 0 01-.086-.084l.086.084",fill:"url(#google-play_svg__c)"})),Z||(Z=n.createElement("path",{d:"M30.52 26.676L14.004 10.16a1.716 1.716 0 011.177-.433c.452 0 .96.145 1.496.449L36.025 21.17l-5.506 5.506m5.63-5.63L16.677 9.98c-.536-.304-1.044-.448-1.496-.448h-.005.007c.451 0 .959.144 1.494.448L36.15 21.045",fill:"url(#google-play_svg__d)"})),ee||(ee=n.createElement("path",{d:"M15.313 43.811c.42-.024.883-.168 1.371-.445l19.353-10.995-19.353 10.994c-.487.277-.952.42-1.371.445m-1.301-.43l-.004-.004a.038.038 0 01.004.004m-.09-.088l-.009-.008c.004.002.006.006.009.008"})),te||(te=n.createElement("path",{d:"M36.025 32.378l.126-.071-.126.071",fill:"url(#google-play_svg__e)"})),ae||(ae=n.createElement("path",{d:"M15.185 43.819c-.461 0-.864-.15-1.178-.434a.038.038 0 00-.005-.003l-.086-.084-.008-.008.099-.1c.314.284.716.434 1.177.434.451 0 .958-.144 1.494-.448l19.348-10.994.124.124-.126.072L16.677 43.37c-.488.276-.952.42-1.37.444a2.515 2.515 0 01-.123.004",fill:"url(#google-play_svg__f)"})),ne||(ne=n.createElement("path",{d:"M13.914 43.285c-.388-.411-.617-1.049-.617-1.874 0 .825.23 1.462.617 1.873"})),ie||(ie=n.createElement("path",{d:"M13.908 43.29c-.388-.41-.617-1.047-.617-1.873v-.194c0 .825.23 1.462.617 1.873l.099.095-.099.099",fill:"url(#google-play_svg__g)"})),se||(se=n.createElement("path",{d:"M13.908 43.29l.099-.1v.001l-.099.099",fill:"url(#google-play_svg__h)"})),oe||(oe=n.createElement("path",{d:"M36.151 32.307l-.124-.124 6.646-3.777c.844-.48 1.318-1.098 1.397-1.728 0 .231-.051.463-.154.688-.207.453-.62.882-1.243 1.235l-6.522 3.706",fill:"url(#google-play_svg__i)"})),re||(re=n.createElement("path",{d:"M44.083 26.667c0-.698-.467-1.395-1.398-1.924l-6.523-3.707 6.523 3.706c.932.53 1.399 1.228 1.398 1.925",fill:"#404040"})),le||(le=n.createElement("path",{d:"M44.07 26.675c-.08-.632-.553-1.25-1.397-1.73l-6.647-3.775.124-.124 6.523 3.706c.93.529 1.397 1.226 1.397 1.923",fill:"url(#google-play_svg__j)"})),ce||(ce=n.createElement("path",{d:"M13.297 11.917v-.002.002m.006-.217v-.003.003m0-.006v-.006.006m0-.008c.077-1.37.822-2.16 1.876-2.165a1.715 1.715 0 00-1.166.433l-.004.003c-.033.03-.064.061-.095.093-.35.37-.57.925-.61 1.636",fill:"#404040"})),de||(de=n.createElement("path",{d:"M13.291 12.132v-.204c0-.073.002-.145.006-.215V11.7c.04-.71.261-1.265.61-1.635l.098.097c-.447.404-.714 1.077-.714 1.97m.712-2.16l.003-.004-.003.003",fill:"url(#google-play_svg__k)"})),me||(me=n.createElement("path",{d:"M15.178 9.521h.004-.004",fill:"#404040"})),he||(he=n.createElement("path",{d:"M36.025 21.17L16.677 10.176c-.536-.304-1.044-.448-1.496-.448-.46 0-.863.15-1.177.432l-.097-.097a1.78 1.78 0 01.095-.094l.003-.003c.312-.28.71-.43 1.166-.433h.01c.452 0 .96.144 1.496.448l19.472 11.064-.125.125",fill:"url(#google-play_svg__l)"})))}var ge,be,ve;function fe(){return fe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},fe.apply(this,arguments)}function Ee(e){return n.createElement("svg",fe({viewBox:"0 0 159.55 53.333",xmlns:"http://www.w3.org/2000/svg",role:"presentation","aria-hidden":!0},e),ge||(ge=n.createElement("path",{d:"M146.84.001H12.71c-.489 0-.972 0-1.46.003-.407.002-.812.01-1.224.016-.888.023-1.786.077-2.672.236a8.876 8.876 0 00-2.535.836A8.58 8.58 0 001.09 4.825a8.782 8.782 0 00-.833 2.538c-.16.883-.216 1.776-.24 2.669-.012.409-.013.82-.02 1.228v30.818c.007.414.008.815.02 1.23.024.893.08 1.786.24 2.669.155.893.418 1.73.833 2.539a8.28 8.28 0 001.571 2.152 8.356 8.356 0 002.158 1.571 8.95 8.95 0 002.535.842c.886.158 1.784.21 2.672.235.412.01.817.015 1.225.015.488.002.97.002 1.46.002h134.13c.48 0 .966 0 1.445-.002.408 0 .824-.006 1.23-.015.894-.025 1.79-.077 2.667-.235a9.083 9.083 0 002.544-.842 8.417 8.417 0 002.157-1.57 8.556 8.556 0 001.573-2.153c.41-.809.676-1.646.826-2.54.165-.882.216-1.775.249-2.669.004-.414.004-.815.004-1.229.01-.484.01-.966.01-1.458V12.715c0-.488 0-.972-.01-1.455 0-.409 0-.82-.004-1.228-.033-.893-.084-1.786-.25-2.67a8.763 8.763 0 00-.825-2.537 8.626 8.626 0 00-1.573-2.162 8.641 8.641 0 00-2.157-1.57 9.02 9.02 0 00-2.544-.837c-.877-.159-1.773-.213-2.667-.236-.406-.006-.822-.014-1.23-.016C147.807 0 147.322 0 146.84 0",fill:"#b2b1b1"})),be||(be=n.createElement("path",{d:"M11.267 52.166c-.407 0-.803-.005-1.206-.014-.745-.021-1.63-.062-2.492-.217a7.847 7.847 0 01-2.21-.731 7.214 7.214 0 01-1.862-1.355 7.092 7.092 0 01-1.36-1.862 7.616 7.616 0 01-.724-2.21c-.163-.897-.205-1.807-.222-2.5-.01-.28-.02-1.217-.02-1.217v-30.8s.012-.922.02-1.193c.017-.698.059-1.607.22-2.495.143-.818.38-1.54.725-2.216.354-.7.808-1.325 1.353-1.864a7.423 7.423 0 011.87-1.363 7.762 7.762 0 012.204-.726c.898-.16 1.808-.2 2.5-.219l1.204-.016h137.02l1.217.017c.684.017 1.595.057 2.48.217.802.14 1.53.38 2.227.73.684.35 1.31.808 1.855 1.354a7.38 7.38 0 011.365 1.873c.344.681.577 1.403.715 2.198.153.841.2 1.705.23 2.517.004.377.004.783.004 1.187.012.5.012.975.012 1.455V40.62c0 .485 0 .957-.012 1.434 0 .434 0 .831-.005 1.24-.028.785-.076 1.648-.228 2.47a7.664 7.664 0 01-.72 2.228 7.297 7.297 0 01-1.353 1.847 7.268 7.268 0 01-1.866 1.363 7.855 7.855 0 01-2.225.733c-.853.155-1.737.197-2.492.218-.39.009-.8.014-1.197.014l-1.445.003-135.58-.003",fill:"#040403"})),ve||(ve=n.createElement("path",{d:"M33.032 27.068c-.034-3.668 3.002-5.452 3.141-5.536-1.72-2.507-4.385-2.85-5.321-2.877-2.239-.235-4.41 1.34-5.551 1.34-1.162 0-2.92-1.317-4.81-1.278-2.436.038-4.715 1.448-5.964 3.638-2.579 4.464-.656 11.026 1.814 14.633 1.236 1.769 2.68 3.742 4.57 3.672 1.85-.077 2.54-1.18 4.773-1.18 2.212 0 2.86 1.18 4.788 1.135 1.984-.032 3.235-1.775 4.427-3.559 1.428-2.026 2.002-4.02 2.024-4.123-.046-.016-3.854-1.469-3.891-5.865m-3.643-10.786c.994-1.244 1.675-2.936 1.486-4.654-1.44.064-3.24.995-4.276 2.213-.918 1.072-1.738 2.83-1.526 4.481 1.618.12 3.278-.816 4.316-2.04m21.362 17.839h5.002l-2.466-7.261h-.068zm5.658 2.066h-6.312l-1.515 4.475h-2.673l5.977-16.557h2.778l5.977 16.557h-2.718l-1.514-4.475m14.596-1.56c0-2.444-1.263-4.05-3.19-4.05-1.893 0-3.166 1.64-3.166 4.05 0 2.432 1.273 4.061 3.166 4.061 1.927 0 3.19-1.595 3.19-4.061zm2.547 0c0 3.751-2.008 6.161-5.038 6.161-1.72 0-3.086-.77-3.798-2.112h-.057v5.98h-2.478V28.591h2.398v2.007h.046c.689-1.295 2.157-2.134 3.844-2.134 3.063 0 5.083 2.422 5.083 6.162m10.738.001c0-2.444-1.263-4.05-3.19-4.05-1.893 0-3.166 1.64-3.166 4.05 0 2.432 1.273 4.061 3.166 4.061 1.927 0 3.19-1.595 3.19-4.061zm2.547 0c0 3.751-2.008 6.161-5.038 6.161-1.72 0-3.086-.77-3.798-2.112h-.057v5.98h-2.478V28.591h2.398v2.007h.046c.689-1.295 2.157-2.134 3.844-2.134 3.063 0 5.083 2.422 5.083 6.162m8.78 1.422c.184 1.642 1.78 2.72 3.96 2.72 2.088 0 3.59-1.078 3.59-2.558 0-1.285-.906-2.055-3.052-2.582l-2.146-.517c-3.04-.735-4.451-2.157-4.451-4.463 0-2.857 2.489-4.82 6.024-4.82 3.499 0 5.897 1.963 5.978 4.82h-2.501c-.15-1.653-1.516-2.65-3.512-2.65s-3.362 1.01-3.362 2.477c0 1.171.873 1.86 3.007 2.387l1.824.448c3.397.804 4.808 2.168 4.808 4.59 0 3.097-2.467 5.038-6.392 5.038-3.671 0-6.15-1.895-6.31-4.89h2.536m15.514-10.314v2.857h2.296v1.962h-2.296v6.655c0 1.034.46 1.515 1.469 1.515.253 0 .655-.035.815-.057v1.95c-.274.07-.826.115-1.376.115-2.444 0-3.397-.918-3.397-3.26v-6.918h-1.755V28.59h1.755v-2.857h2.49m12.551 8.894c0-2.605-1.194-4.143-3.202-4.143-2.007 0-3.2 1.55-3.2 4.143 0 2.616 1.193 4.142 3.2 4.142 2.008 0 3.202-1.526 3.202-4.142zm-8.927 0c0-3.798 2.237-6.184 5.725-6.184 3.5 0 5.727 2.386 5.727 6.184 0 3.809-2.215 6.185-5.727 6.185-3.51 0-5.725-2.376-5.725-6.185m13.495-6.036h2.363v2.055h.058c.378-1.367 1.48-2.182 2.903-2.182.356 0 .653.047.85.093v2.318c-.197-.082-.633-.15-1.114-.15-1.595 0-2.582 1.079-2.582 2.777v7.16h-2.478V28.591m9.218 4.922h6.035c-.058-1.847-1.239-3.064-2.96-3.064-1.71 0-2.948 1.24-3.075 3.064zm8.376 3.603c-.333 2.192-2.467 3.696-5.197 3.696-3.512 0-5.692-2.353-5.692-6.128 0-3.786 2.192-6.242 5.588-6.242 3.34 0 5.44 2.294 5.44 5.954v.85h-8.527v.15c0 2.064 1.298 3.418 3.248 3.418 1.376 0 2.456-.654 2.788-1.698h2.352M48.803 18.473h1.5c1.664 0 2.623-1.037 2.623-2.862 0-1.797-.975-2.845-2.623-2.845h-1.5zm1.638-6.831c2.36 0 3.744 1.45 3.744 3.953 0 2.542-1.374 4.003-3.744 4.003h-2.873v-7.956h2.873m9.583 4.951c0-1.301-.584-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.026 0 1.61-.76 1.61-2.067zm-4.443 0c0-1.936 1.08-3.115 2.833-3.115 1.748 0 2.829 1.18 2.829 3.115 0 1.946-1.076 3.12-2.83 3.12-1.758 0-2.832-1.174-2.832-3.12m13.188 3.005H67.54l-1.24-4.422h-.095l-1.235 4.422h-1.218l-1.654-6.004h1.201l1.076 4.581h.088l1.234-4.58h1.138l1.234 4.58h.094l1.07-4.58h1.185l-1.649 6.003m3.042-6.004h1.14v.954h.089c.291-.667.888-1.07 1.791-1.07 1.34 0 2.078.805 2.078 2.233v3.887h-1.184v-3.59c0-.965-.42-1.444-1.296-1.444s-1.434.585-1.434 1.522v3.512h-1.184v-6.004m6.986-2.344h1.185v8.347h-1.185V11.25m7.276 5.343c0-1.301-.585-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.025 0 1.61-.76 1.61-2.067zm-4.444 0c0-1.936 1.08-3.115 2.833-3.115 1.749 0 2.83 1.18 2.83 3.115 0 1.946-1.076 3.12-2.83 3.12-1.758 0-2.833-1.174-2.833-3.12m10.769.794v-.501l-1.466.093c-.827.056-1.202.337-1.202.866 0 .54.47.855 1.113.855.894 0 1.555-.569 1.555-1.313zm-3.86.513c0-1.08.805-1.703 2.234-1.792l1.626-.094v-.518c0-.634-.42-.992-1.23-.992-.66 0-1.119.243-1.25.667h-1.147c.12-1.031 1.09-1.693 2.453-1.693 1.505 0 2.354.75 2.354 2.018v4.102h-1.14v-.844h-.095c-.357.601-1.014.943-1.803.943-1.158 0-2.001-.7-2.001-1.797m7.82-1.307c0 1.273.6 2.04 1.604 2.04 1 0 1.617-.778 1.617-2.035 0-1.251-.624-2.04-1.617-2.04-.997 0-1.604.772-1.604 2.035zm-1.224 0c0-1.897.976-3.1 2.492-3.1.822 0 1.516.392 1.842 1.054h.088V11.25h1.185v8.347h-1.135v-.948h-.094c-.358.656-1.058 1.047-1.886 1.047-1.527 0-2.492-1.201-2.492-3.103m14.953 0c0-1.301-.584-2.062-1.61-2.062-1.03 0-1.61.76-1.61 2.062 0 1.312.58 2.067 1.61 2.067 1.026 0 1.61-.76 1.61-2.067zm-4.443 0c0-1.936 1.08-3.115 2.833-3.115 1.748 0 2.829 1.18 2.829 3.115 0 1.946-1.076 3.12-2.83 3.12-1.757 0-2.832-1.174-2.832-3.12m7.252-2.999h1.141v.954h.089c.291-.667.888-1.07 1.791-1.07 1.34 0 2.078.805 2.078 2.233v3.887h-1.184v-3.59c0-.965-.42-1.444-1.296-1.444s-1.434.585-1.434 1.522v3.512h-1.184v-6.004m11.793-1.494v1.521h1.3v.999h-1.3v3.087c0 .629.258.904.849.904.182 0 .286-.011.451-.027v.987c-.193.032-.414.06-.644.06-1.318 0-1.843-.464-1.843-1.621v-3.39h-.953v-.999h.953V12.1h1.187m2.919-.85h1.175v3.308h.094c.291-.673.925-1.075 1.83-1.075 1.279 0 2.068.81 2.068 2.238v3.876h-1.186v-3.583c0-.96-.447-1.445-1.284-1.445-.972 0-1.512.612-1.512 1.522v3.506h-1.185V11.25m7.914 4.792h3.033c-.028-.943-.601-1.555-1.479-1.555-.876 0-1.488.617-1.554 1.555zm4.168 1.935c-.27 1.075-1.23 1.737-2.602 1.737-1.72 0-2.773-1.18-2.773-3.1 0-1.918 1.076-3.136 2.768-3.136 1.67 0 2.679 1.142 2.679 3.026v.414h-4.24v.067c.04 1.052.652 1.72 1.598 1.72.719 0 1.21-.26 1.43-.728h1.14",fill:"#fff"})))}var ye=a(121),_e=a(132),Se=a(124),we=a(472),Oe=a(177),Ce=a(137);const xe="https://play.google.com/store/apps/details?id=im.vector.app",je=e=>{var t,a,n,s,o;let{onFinished:r}=e;const l=_e.b.get("brand"),c=_e.b.getObject("desktop_builds"),d=_e.b.getObject("mobile_builds"),m=null!==(t=null==d?void 0:d.get("ios"))&&void 0!==t?t:"https://apps.apple.com/app/vector/id1083446067",h=null!==(a=null!==(n=null==d?void 0:d.get("android"))&&void 0!==n?n:null==d?void 0:d.get("fdroid"))&&void 0!==a?a:xe,u=null!==(s=null==d?void 0:d.get("android"))&&void 0!==s?s:xe,p=null!==(o=null==d?void 0:d.get("fdroid"))&&void 0!==o?o:"https://f-droid.org/repository/browse/?fdid=im.vector.app";return i.a.createElement(Ce.a,{title:Object(ye.b)("Download %(brand)s",{brand:l}),className:"mx_AppDownloadDialog",fixedWidth:!0,onFinished:r},(null==c?void 0:c.get("available"))&&i.a.createElement("div",{className:"mx_AppDownloadDialog_desktop"},i.a.createElement(Oe.a,{size:"h3"},Object(ye.b)("Download %(brand)s Desktop",{brand:l})),i.a.createElement(Se.a,{kind:"primary",element:"a",href:null==c?void 0:c.get("url"),target:"_blank",onClick:()=>{}},Object(ye.b)("Download %(brand)s Desktop",{brand:l}))),i.a.createElement("div",{className:"mx_AppDownloadDialog_mobile"},i.a.createElement("div",{className:"mx_AppDownloadDialog_app"},i.a.createElement(Oe.a,{size:"h3"},Object(ye.b)("iOS")),i.a.createElement(we.a,{data:m,margin:0,width:172}),i.a.createElement("div",{className:"mx_AppDownloadDialog_info"},Object(ye.b)("%(qrCode)s or %(appLinks)s",{appLinks:"",qrCode:""})),i.a.createElement("div",{className:"mx_AppDownloadDialog_links"},i.a.createElement(Se.a,{element:"a",href:m,target:"_blank","aria-label":Object(ye.b)("Download on the App Store"),onClick:()=>{}},i.a.createElement(Ee,null)))),i.a.createElement("div",{className:"mx_AppDownloadDialog_app"},i.a.createElement(Oe.a,{size:"h3"},Object(ye.b)("Android")),i.a.createElement(we.a,{data:h,margin:0,width:172}),i.a.createElement("div",{className:"mx_AppDownloadDialog_info"},Object(ye.b)("%(qrCode)s or %(appLinks)s",{appLinks:"",qrCode:""})),i.a.createElement("div",{className:"mx_AppDownloadDialog_links"},i.a.createElement(Se.a,{element:"a",href:u,target:"_blank","aria-label":Object(ye.b)("Get it on Google Play"),onClick:()=>{}},i.a.createElement(pe,null)),i.a.createElement(Se.a,{element:"a",href:p,target:"_blank","aria-label":Object(ye.b)("Get it on F-Droid"),onClick:()=>{}},i.a.createElement(H,null))))),i.a.createElement("div",{className:"mx_AppDownloadDialog_legal"},i.a.createElement("p",null,Object(ye.b)("App Store® and the Apple logo® are trademarks of Apple Inc.")),i.a.createElement("p",null,Object(ye.b)("Google Play and the Google Play logo are trademarks of Google LLC."))))};var ke=a(220),Re=a(128),Ie=a(125),Te=a(129),Ne=a(163),Pe=a(499);function De(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function Me(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?De(Object(a),!0).forEach((function(t){W()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):De(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const Ae=e=>{Ne.b.trackInteraction("WebUserOnboardingTaskSendDm",e),Ie.a.dispatch({action:"view_create_chat"})},Ue=[{id:"create-account",title:Object(ye.b)("Create account"),description:Object(ye.b)("You made it!"),completed:()=>!0},{id:"find-friends",title:Object(ye.b)("Find and invite your friends"),description:Object(ye.b)("It’s what you’re here for, so lets get to it"),completed:e=>e.hasDmRooms,relevant:[Pe.a.PersonalMessaging,Pe.a.Skip],action:{label:Object(ye.b)("Find friends"),onClick:Ae}},{id:"find-coworkers",title:Object(ye.b)("Find and invite your co-workers"),description:Object(ye.b)("Get stuff done by finding your teammates"),completed:e=>e.hasDmRooms,relevant:[Pe.a.WorkMessaging],action:{label:Object(ye.b)("Find people"),onClick:Ae}},{id:"find-community-members",title:Object(ye.b)("Find and invite your community members"),description:Object(ye.b)("Get stuff done by finding your teammates"),completed:e=>e.hasDmRooms,relevant:[Pe.a.CommunityMessaging],action:{label:Object(ye.b)("Find people"),onClick:Ae}},{id:"download-apps",title:()=>Object(ye.b)("Download %(brand)s",{brand:_e.b.get("brand")}),description:()=>Object(ye.b)("Don’t miss a thing by taking %(brand)s with you",{brand:_e.b.get("brand")}),completed:e=>e.hasDevices,action:{label:Object(ye.b)("Download apps"),onClick:e=>{Ne.b.trackInteraction("WebUserOnboardingTaskDownloadApps",e),Te.b.createDialog(je,{},"mx_AppDownloadDialog_wrapper",!1,!0)}}},{id:"setup-profile",title:Object(ye.b)("Set up your profile"),description:Object(ye.b)("Make sure people know it’s really you"),completed:e=>e.hasAvatar,action:{label:Object(ye.b)("Your profile"),onClick:e=>{Ne.b.trackInteraction("WebUserOnboardingTaskSetupProfile",e),Ie.a.dispatch({action:Re.a.ViewUserSettings,initialTabId:ke.a.General})}}},{id:"permission-notifications",title:Object(ye.b)("Turn on notifications"),description:Object(ye.b)("Don’t miss a reply or important message"),completed:e=>e.hasNotificationsEnabled,action:{label:Object(ye.b)("Enable notifications"),onClick:e=>{Ne.b.trackInteraction("WebUserOnboardingTaskEnableNotifications",e),d.Notifier.setEnabled(!0)},hideOnComplete:!0}}];var Le=a(498),Fe=a(221),Be=a(675),Ve=a(195),We=a(273),ze=a(156),He=a(133),Ke=a(977);const Ge=e=>{Ne.b.trackInteraction("WebHomeCreateChatButton",e),Ie.a.dispatch({action:"view_create_chat"})},qe=e=>{Ne.b.trackInteraction("WebHomeExploreRoomsButton",e),Ie.a.fire(Re.a.ViewRoomDirectory)},$e=e=>{Ne.b.trackInteraction("WebHomeCreateRoomButton",e),Ie.a.dispatch({action:"view_create_room"})},Ye=e=>{var t;return{displayName:We.a.instance.displayName||e,avatarUrl:null!==(t=We.a.instance.getHttpAvatarUrl(Ke.a))&&void 0!==t?t:void 0}},Je=()=>{const e=Object(n.useContext)(He.a),t=e.getUserId(),[a,i]=Object(n.useState)(Ye(t));return Object(r.a)(We.a.instance,ze.b,(()=>{i(Ye(t))})),n.createElement("div",null,n.createElement(Ke.b,{hasAvatar:!!a.avatarUrl,hasAvatarLabel:Object(ye.c)("Great, that'll help people know it's you"),noAvatarLabel:Object(ye.c)("Add a photo so people know it's you."),setAvatarUrl:t=>e.setAvatarUrl(t),isUserAvatar:!0,onClick:e=>Ne.b.trackInteraction("WebHomeMiniAvatarUploadButton",e)},n.createElement(Ve.a,{idName:t,name:a.displayName,url:a.avatarUrl,width:Ke.a,height:Ke.a,resizeMethod:"crop"})),n.createElement("h1",null,Object(ye.c)("Welcome %(name)s",{name:a.displayName})),n.createElement("h2",null,Object(ye.c)("Now, let's help you get started")))};var Qe=e=>{let{justRegistered:t=!1}=e;const a=_e.b.get(),i=Object(Le.a)(a);if(i)return n.createElement(Be.a,{className:"mx_HomePage",url:i,scrollbar:!0});let s;if(t||!We.a.instance.getHttpAvatarUrl(Ke.a))s=n.createElement(Je,null);else{var o;const e=_e.b.getObject("branding"),t=null!==(o=null==e?void 0:e.get("auth_header_logo_url"))&&void 0!==o?o:"themes/element/img/logos/element-logo.svg";s=n.createElement(n.Fragment,null,n.createElement("img",{src:t,alt:a.brand}),n.createElement("h1",null,Object(ye.c)("Welcome to %(appName)s",{appName:a.brand})),n.createElement("h2",null,Object(ye.c)("Own your conversations.")))}return n.createElement(Fe.a,{className:"mx_HomePage mx_HomePage_default",element:"main"},n.createElement("div",{className:"mx_HomePage_default_wrapper"},s,n.createElement("div",{className:"mx_HomePage_default_buttons"},n.createElement(Se.a,{onClick:Ge,className:"mx_HomePage_button_sendDm"},Object(ye.c)("Send a Direct Message")),n.createElement(Se.a,{onClick:qe,className:"mx_HomePage_button_explore"},Object(ye.c)("Explore Public Rooms")),n.createElement(Se.a,{onClick:$e,className:"mx_HomePage_button_createGroup"},Object(ye.c)("Create a Group Chat")))))};const Xe=e=>{Ne.b.trackInteraction("WebUserOnboardingHeaderSendDm",e),Ie.a.dispatch({action:"view_create_chat"})};function Ze(e){let t,i,s,o,{useCase:r}=e;switch(r){case Pe.a.PersonalMessaging:t=Object(ye.b)("Secure messaging for friends and family"),i=Object(ye.b)("With free end-to-end encrypted messaging, and unlimited voice and video calls, %(brand)s is a great way to stay in touch.",{brand:_e.b.get("brand")}),s=a(978),o=Object(ye.b)("Start your first chat");break;case Pe.a.WorkMessaging:t=Object(ye.b)("Secure messaging for work"),i=Object(ye.b)("With free end-to-end encrypted messaging, and unlimited voice and video calls, %(brand)s is a great way to stay in touch.",{brand:_e.b.get("brand")}),s=a(1689),o=Object(ye.b)("Find your co-workers");break;case Pe.a.CommunityMessaging:t=Object(ye.b)("Community ownership"),i=Object(ye.b)("Keep ownership and control of community discussion.\nScale to support millions, with powerful moderation and interoperability."),s=a(1690),o=Object(ye.b)("Find your people");break;default:t=Object(ye.b)("Welcome to %(brand)s",{brand:_e.b.get("brand")}),i=Object(ye.b)("With free end-to-end encrypted messaging, and unlimited voice and video calls, %(brand)s is a great way to stay in touch.",{brand:_e.b.get("brand")}),s=a(978),o=Object(ye.b)("Start your first chat")}return n.createElement("div",{className:"mx_UserOnboardingHeader"},n.createElement("div",{className:"mx_UserOnboardingHeader_content"},n.createElement(Oe.a,{size:"h1"},t,n.createElement("span",{className:"mx_UserOnboardingHeader_dot"},".")),n.createElement("p",null,i),n.createElement(Se.a,{onClick:Xe,kind:"primary"},o)),n.createElement("img",{className:"mx_UserOnboardingHeader_image",src:s,alt:""}))}var et=a(514),tt=a(127),at=a.n(tt);function nt(e){var t;let{task:a,completed:i=!1}=e;const s="function"==typeof a.title?a.title():a.title,o="function"==typeof a.description?a.description():a.description;return n.createElement("li",{"data-testid":"user-onboarding-task",className:at()("mx_UserOnboardingTask",{mx_UserOnboardingTask_completed:i})},n.createElement("div",{className:"mx_UserOnboardingTask_number",role:"checkbox","aria-disabled":"true","aria-checked":i,"aria-labelledby":`mx_UserOnboardingTask_${a.id}`}),n.createElement("div",{id:`mx_UserOnboardingTask_${a.id}`,className:"mx_UserOnboardingTask_content"},n.createElement(Oe.a,{size:"h4",className:"mx_UserOnboardingTask_title"},s),n.createElement("div",{className:"mx_UserOnboardingTask_description"},o)),a.action&&(!a.action.hideOnComplete||!i)&&n.createElement(Se.a,{element:"a",className:"mx_UserOnboardingTask_action",kind:"primary_outline",href:a.action.href,target:"_blank",onClick:null!==(t=a.action.onClick)&&void 0!==t?t:null},a.action.label))}const it=e=>{const t=e.filter((e=>!0===e.completed)).length,a=e.filter((e=>!1===e.completed)).length;return{completed:t,waiting:a,total:t+a}};function st(e){let{tasks:t}=e;const{completed:a,waiting:i,total:s}=it(t);return n.createElement("div",{className:"mx_UserOnboardingList","data-testid":"user-onboarding-list"},n.createElement("div",{className:"mx_UserOnboardingList_header"},n.createElement(Oe.a,{size:"h3",className:"mx_UserOnboardingList_title"},i>0?Object(ye.b)("Only %(count)s steps to go",{count:i}):Object(ye.b)("You did it!")),n.createElement("div",{className:"mx_UserOnboardingList_hint"},Object(ye.b)("Complete these to get the most out of %(brand)s",{brand:_e.b.get("brand")}))),n.createElement("div",{className:"mx_UserOnboardingList_progress"},n.createElement(et.a,{value:a,max:s,animated:!0})),n.createElement("ol",{className:"mx_UserOnboardingList_list"},t.map((e=>n.createElement(nt,{key:e.id,completed:e.completed,task:e})))))}const ot=new Date(1656633600);function rt(e){return null!==e||o.a.userRegisteredAfter(ot)}const lt=2800;function ct(e){let{justRegistered:t=!1}=e;const a=_e.b.get(),i=Object(Le.a)(a),c=Object(l.b)("FTUE.useCaseSelection"),h=function(e){var t;const a=null!==(t=Object(l.b)("FTUE.useCaseSelection"))&&void 0!==t?t:Pe.a.Skip;return Object(n.useMemo)((()=>Ue.filter((e=>!e.relevant||e.relevant.includes(a))).map((t=>Me(Me({},t),{},{completed:t.completed(e)})))),[e,a])}(function(){const e=u(!1,(async e=>{const t=await e.getProfileInfo(e.getUserId());return Boolean(null==t?void 0:t.avatar_url)})),t=u(!1,(async e=>{const t=e.getDeviceId(),a=await e.getDevices();return Boolean(a.devices.find((e=>e.device_id!==t)))})),a=u(!1,(async()=>{var e;const t=null!==(e=m.a.shared().getUniqueRoomsWithIndividuals())&&void 0!==e?e:{};return Boolean(Object.keys(t).length)})),i=u(!1,(async()=>d.Notifier.isPossible()));return Object(n.useMemo)((()=>({hasAvatar:e,hasDevices:t,hasDmRooms:a,hasNotificationsEnabled:i})),[e,t,a,i])}()),p=function(){const e=o.a.get();return Object(r.b)(e,s.ClientEvent.Sync,(()=>e.isInitialSyncComplete()))}(),[g,b]=Object(n.useState)(!1);return Object(n.useEffect)((()=>{if(p){const e=window.setTimeout((()=>{b(!0)}),lt);return()=>{clearTimeout(e)}}b(!1)}),[p,b]),rt(c)?i?n.createElement(Be.a,{className:"mx_HomePage",url:i,scrollbar:!0}):n.createElement(Fe.a,{className:"mx_UserOnboardingPage"},n.createElement(Ze,{useCase:c}),g&&n.createElement(st,{tasks:h})):n.createElement(Qe,{justRegistered:t})}},510:function(e,t,a){"use strict";a.d(t,"a",(function(){return u})),a.d(t,"b",(function(){return p})),a.d(t,"c",(function(){return g})),a.d(t,"d",(function(){return b}));var n=a(13),i=a.n(n),s=a(10),o=a(149),r=a(431),l=a(1),c=a(16),d=function(e){return e.Start="m.login.start",e.Finish="m.login.finish",e.Progress="m.login.progress",e}(d||{}),m=function(e){return e.Success="success",e.Failure="failure",e.Verified="verified",e.Declined="declined",e.Unsupported="unsupported",e}(m||{});const h=new s.UnstableValue("login_token","org.matrix.msc3906.login_token");class u{constructor(e,t,a){this.channel=e,this.client=t,this.onFailure=a,i()(this,"newDeviceId",void 0),i()(this,"newDeviceKey",void 0),i()(this,"ourIntent",b.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE),i()(this,"_code",void 0)}get code(){return this._code}async generateCode(){this._code||(this._code=JSON.stringify(await this.channel.generateCode(this.ourIntent)))}async startAfterShowingCode(){const e=await this.channel.connect();l.a.info(`Connected to secure channel with checksum: ${e} our intent is ${this.ourIntent}`);const t=await this.client.getCapabilities(),a=await Object(r.c)(await this.client.getVersions()),n=o.h.findIn(t);if((null==n||!n.enabled)&&a.get(r.a.LoginTokenRequest)===r.b.Unsupported)return l.a.info("Server doesn't support MSC3882"),await this.send({type:d.Finish,outcome:m.Unsupported}),void await this.cancel(g.HomeserverLacksSupport);await this.send({type:d.Progress,protocols:[h.name]}),l.a.info("Waiting for other device to chose protocol");const{type:i,protocol:s,outcome:c}=await this.receive();if(i!==d.Finish)if(i===d.Progress){if(s&&h.matches(s))return e;await this.cancel(g.UnsupportedAlgorithm)}else await this.cancel(g.Unknown);else if("unsupported"===(null!=c?c:""))await this.cancel(g.UnsupportedAlgorithm);else await this.cancel(g.Unknown)}async receive(){return await this.channel.receive()}async send(e){await this.channel.send(e)}async declineLoginOnExistingDevice(){l.a.info("User declined sign in"),await this.send({type:d.Finish,outcome:m.Declined})}async approveLoginOnExistingDevice(e){await this.send({type:d.Progress,login_token:e,homeserver:this.client.baseUrl}),l.a.info("Waiting for outcome");const t=await this.receive();if(!t)return;const{outcome:a,device_id:n,device_key:i}=t;if("success"!==a)throw new Error("Linking failed");return this.newDeviceId=n,this.newDeviceKey=i,n}async verifyAndCrossSignDevice(e){if(!this.client.crypto)throw new Error("Crypto not available on client");if(!this.newDeviceId)throw new Error("No new device ID set");if(e.getFingerprint()!==this.newDeviceKey)throw new Error(`New device has different keys than expected: ${this.newDeviceKey} vs ${e.getFingerprint()}`);const t=this.client.getUserId();if(!t)throw new Error("No user ID set");l.a.info(`Marking device ${this.newDeviceId} as verified`);const a=await this.client.crypto.setDeviceVerification(t,this.newDeviceId,!0,!1,!0),n=this.client.crypto.crossSigningInfo.getId("master");return await this.send({type:d.Finish,outcome:m.Verified,verifying_device_id:this.client.getDeviceId(),verifying_device_key:this.client.getDeviceEd25519Key(),master_key:n}),a}async verifyNewDeviceOnExistingDevice(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4;if(!this.newDeviceId)throw new Error("No new device to sign");if(!this.newDeviceKey)return void l.a.info("No new device key to sign");if(!this.client.crypto)throw new Error("Crypto not available on client");const t=this.client.getUserId();if(!t)throw new Error("No user ID set");let a=this.client.crypto.getStoredDevice(t,this.newDeviceId);if(a||(l.a.info("Going to wait for new device to be online"),await Object(c.N)(e),a=this.client.crypto.getStoredDevice(t,this.newDeviceId)),a)return await this.verifyAndCrossSignDevice(a);throw new Error("Device not online within timeout")}async cancel(e){var t;null===(t=this.onFailure)||void 0===t||t.call(this,e),await this.channel.cancel(e)}async close(){await this.channel.close()}}class p extends Error{constructor(e,t){super(e),this.code=t}}let g=function(e){return e.UserDeclined="user_declined",e.OtherDeviceNotSignedIn="other_device_not_signed_in",e.OtherDeviceAlreadySignedIn="other_device_already_signed_in",e.Unknown="unknown",e.Expired="expired",e.UserCancelled="user_cancelled",e.InvalidCode="invalid_code",e.UnsupportedAlgorithm="unsupported_algorithm",e.DataMismatch="data_mismatch",e.UnsupportedTransport="unsupported_transport",e.HomeserverLacksSupport="homeserver_lacks_support",e}({}),b=function(e){return e.LOGIN_ON_NEW_DEVICE="login.start",e.RECIPROCATE_LOGIN_ON_EXISTING_DEVICE="login.reciprocate",e}({})},519:function(e,t,a){"use strict";a.d(t,"a",(function(){return l}));var n=a(120),i=a.n(n),s=a(132);class o extends n.PureComponent{render(){var e;const t=s.b.getObject("branding"),a=null!==(e=null==t?void 0:t.get("auth_header_logo_url"))&&void 0!==e?e:"themes/element/img/logos/element-logo.svg";return n.createElement("aside",{className:"mx_AuthHeaderLogo"},n.createElement("img",{src:a,alt:"SchildiChat"}))}}var r=a(993);class l extends i.a.Component{render(){return i.a.createElement("div",{className:"mx_AuthHeader"},i.a.createElement(o,null),i.a.createElement(r.a,{disabled:this.props.disableLanguageSelector}))}}},663:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M2 9.27V3.05L9 1l7 2.05v6.22C16 15.63 9 17 9 17s-7-1.37-7-7.73zM8.92 4.4c-.57.04-.99.54-.94 1.11l.32 4c.03.35.3.62.65.65h.06c.37 0 .68-.28.71-.65l.32-4v-.16a1.06 1.06 0 00-1.12-.95zm.96 7.72a.88.88 0 11-1.76 0 .88.88 0 011.76 0z",fill:"currentColor"})))}t.default="img/e2e/warning.d370b49.svg"},664:function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));const n=(e,t)=>{try{return e.checkDeviceTrust(e.getSafeUserId(),t).isCrossSigningVerified()}catch(e){return console.error("Error getting device cross-signing info",e),null}}},665:function(e,t,a){"use strict";a.d(t,"a",(function(){return s})),a.d(t,"c",(function(){return o})),a.d(t,"b",(function(){return l}));var n=a(361);const i=7776e6,s=90,o=e=>!!e.last_seen_ts&&e.last_seen_ts<Date.now()-i,r={[n.a.Verified]:e=>!!e.isVerified,[n.a.Unverified]:e=>!e.isVerified,[n.a.Inactive]:o},l=(e,t)=>{const a=t.map((e=>r[e]));return a.length?e.filter((e=>a.every((t=>t(e))))):e}},666:function(e,t,a){"use strict";a.d(t,"a",(function(){return u}));var n=a(130),i=a(189),s=a(207),o=a(126),r=a(243),l=a(123),c=a(184),d=a(206),m=a(197);const h=(e,t,a,o)=>!(a||o||e===n.b.RoomMessage||e===n.b.RoomMessageEncrypted||e===n.b.Sticker||e===n.b.RoomCreate||i.e.matches(e)||i.a.matches(e)||s.b.matches(e)||e===m.g&&(null==t?void 0:t.state)===m.h.Started);function u(e,t,a){const u=e.getContent(),p=u.msgtype,g=e.getType();let b=!1;if(o.b.getValue("feature_msc3531_hide_messages_pending_moderation"))switch(Object(c.h)(e)){case c.a.VISIBLE_FOR_ALL:case c.a.HIDDEN_TO_CURRENT_USER:break;case c.a.SEE_THROUGH_FOR_CURRENT_USER:b=!0}let v=Object(r.e)(e,l.a.get(),t),f=g.startsWith("m.key.verification")||g===n.b.RoomMessage&&(null==p?void 0:p.startsWith("m.key.verification"))||g===n.b.RoomCreate||g===n.b.RoomEncryption||v===r.b;const E=!f&&(g===n.b.CallInvite||d.d.CALL_EVENT_TYPE.matches(g));let y=h(g,u,f,E);const _=g===n.b.RoomMessage&&p===n.e.Emote||i.e.matches(g)||s.b.matches(g)||Object(c.l)(e)||g===m.g;return!a&&Object(r.c)(e,t)||(v=Object(r.e)(e,l.a.get(),t,!0),v===r.a&&(f=!1,y=!0)),{hasRenderer:!!v,isInfoMessage:y,isBubbleMessage:f,isLeftAlignedBubbleMessage:E,noBubbleEvent:_,isSeeingThroughMessageHiddenForModeration:b}}},667:function(e,t,a){"use strict";a.d(t,"a",(function(){return l}));var n,i,s,o=a(120);function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},r.apply(this,arguments)}function l(e){return o.createElement("svg",r({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),n||(n=o.createElement("circle",{cx:4.25,cy:9,r:1.25,fill:"currentColor"})),i||(i=o.createElement("circle",{cx:9,cy:9,r:1.25,fill:"currentColor"})),s||(s=o.createElement("circle",{cx:13.75,cy:9,r:1.25,fill:"currentColor"})))}},668:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return v}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(127),l=a.n(r),c=a(124),d=a(121),m=a(272),h=a(195),u=a(962);let p=function(e){return e.Admin="admin",e.Moderator="moderator",e}({});const g={[p.Admin]:Object(d.d)("Admin"),[p.Moderator]:Object(d.d)("Mod")},b={offline:"mx_EntityTile_offline",online:"mx_EntityTile_online",unavailable:"mx_EntityTile_unavailable"};class v extends o.a.PureComponent{constructor(e){super(e),this.state={hover:!1}}render(){const e={mx_EntityTile:!0,mx_EntityTile_noHover:!!this.props.suppressOnHover};this.props.className&&(e[this.props.className]=!0);var t,n;let i;e[(t=this.props.presenceState,n=this.props.presenceLastActiveAgo,!1===this.props.showPresence?"mx_EntityTile_online_beenactive":"offline"===t?n?b.offline+"_beenactive":b.offline+"_neveractive":t?b[t]:b.offline+"_neveractive")]=!0;const s=this.props.nameJSX||this.props.name;if(this.props.suppressOnHover)i=this.props.subtextLabel?o.a.createElement("div",{className:"mx_EntityTile_details"},o.a.createElement("div",{className:"mx_EntityTile_name"},s),o.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)):o.a.createElement("div",{className:"mx_EntityTile_name"},s);else{const e=this.props.presenceLastActiveAgo?Date.now()-(this.props.presenceLastTs-this.props.presenceLastActiveAgo):-1;let t;this.props.showPresence&&(t=o.a.createElement(u.a,{activeAgo:e,currentlyActive:this.props.presenceCurrentlyActive,presenceState:this.props.presenceState})),this.props.subtextLabel&&(t=o.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)),i=o.a.createElement("div",{className:"mx_EntityTile_details"},o.a.createElement("div",{className:"mx_EntityTile_name"},s),t)}let r,p;this.props.showInviteButton&&(r=o.a.createElement("div",{className:"mx_EntityTile_invite"},o.a.createElement("img",{alt:Object(d.b)("Invite"),src:a(1644).default,width:"16",height:"16"})));const v=this.props.powerStatus;if(v){const e=Object(d.b)(g[v]);p=o.a.createElement("div",{className:"mx_EntityTile_power"},e)}let f;const{e2eStatus:E}=this.props;E&&(f=o.a.createElement(m.b,{status:E,isUser:!0,bordered:!0}));const y=this.props.avatarJsx||o.a.createElement(h.a,{name:this.props.name,width:36,height:36,"aria-hidden":"true"});return o.a.createElement("div",null,o.a.createElement(c.a,{className:l()(e),title:this.props.title,onClick:this.props.onClick},o.a.createElement("div",{className:"mx_EntityTile_avatar"},y,f),i,p,r))}}i()(v,"defaultProps",{onClick:()=>{},presenceState:"offline",presenceLastActiveAgo:0,presenceLastTs:0,showInviteButton:!1,suppressOnHover:!1,showPresence:!0})},669:function(e,t,a){"use strict";a.d(t,"a",(function(){return l})),a.d(t,"b",(function(){return c}));var n=a(120),i=a(130),s=a(153),o=a(275),r=a(142);const l=e=>{var t,a;const n=null==e||null===(t=e.currentState)||void 0===t||null===(a=t.getStateEvents(i.b.RoomTopic,""))||void 0===a?void 0:a.getContent();return n?Object(o.parseTopicContent)(n):null};function c(e){const[t,a]=Object(n.useState)(l(e));return Object(r.c)(e.currentState,s.b.Events,(t=>{t.getType()===i.b.RoomTopic&&a(l(e))})),Object(n.useEffect)((()=>{a(l(e))}),[e]),t}},670:function(e,t,a){"use strict";a.d(t,"a",(function(){return i}));var n=a(120);const i=e=>{const t=Object(n.useRef)(null);return[Object(n.useCallback)((e=>{t.current=e}),[]),Object(n.useCallback)(((a,n)=>{t.current===a&&e(n)}),[e])]}},671:function(e,t,a){"use strict";var n=a(131),i=a.n(n),s=a(134),o=a.n(s),r=a(120),l=a.n(r),c=a(130),d=a(178),m=a(121),h=a(257),u=a(516),p=a(133),g=a(125),b=a(293),v=a(126),f=a(169),E=a(128),y=a(214),_=a(157),S=a(163);const w=["space","hideHeader","onFinished"];t.a=e=>{let{space:t,hideHeader:a,onFinished:n}=e,s=o()(e,w);const O=Object(r.useContext)(p.a).getUserId();let C=null;if("public"===t.getJoinRule()||t.canInvite(O)){const e=e=>{e.preventDefault(),e.stopPropagation(),Object(h.i)(t),n()};C=l.a.createElement(d.b,{"data-testid":"invite-option",className:"mx_SpacePanel_contextMenu_inviteButton",iconClassName:"mx_SpacePanel_iconInvite",label:Object(m.b)("Invite"),onClick:e})}let x=null,j=null;if(Object(h.d)(t)){const e=e=>{e.preventDefault(),e.stopPropagation(),Object(h.k)(t),n()};x=l.a.createElement(d.b,{"data-testid":"settings-option",iconClassName:"mx_SpacePanel_iconSettings",label:Object(m.b)("Settings"),onClick:e})}else{const e=e=>{e.preventDefault(),e.stopPropagation(),Object(u.b)(t),n()};j=l.a.createElement(d.b,{"data-testid":"leave-option",iconClassName:"mx_SpacePanel_iconLeave",className:"mx_IconizedContextMenu_option_red",label:Object(m.b)("Leave space"),onClick:e})}let k=null;if(v.b.getValue("developerMode")){const e=e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:E.a.ViewRoom,room_id:t.roomId,forceTimeline:!0,metricsTrigger:void 0}),n()};k=l.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconSettings",label:Object(m.b)("See room timeline (devtools)"),onClick:e})}const R=Object(f.a)("feature_video_rooms"),I=Object(f.a)("feature_element_call_video_rooms"),T=t.currentState.maySendStateEvent(c.b.SpaceChild,O),N=T&&Object(y.a)(_.a.CreateRooms),P=N&&R,D=T&&Object(y.a)(_.a.CreateSpaces);let M=null;if(N||D){const e=e=>{e.preventDefault(),e.stopPropagation(),S.b.trackInteraction("WebSpaceContextMenuNewRoomItem",e),Object(h.g)(t),n()},a=e=>{e.preventDefault(),e.stopPropagation(),Object(h.g)(t,I?c.j.UnstableCall:c.j.ElementVideo),n()},i=e=>{e.preventDefault(),e.stopPropagation(),Object(h.h)(t),n()};M=l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{"data-testid":"add-to-space-header",className:"mx_SpacePanel_contextMenu_separatorLabel"},Object(m.b)("Add")),N&&l.a.createElement(d.b,{"data-testid":"new-room-option",iconClassName:"mx_SpacePanel_iconPlus",label:Object(m.b)("Room"),onClick:e}),P&&l.a.createElement(d.b,{"data-testid":"new-video-room-option",iconClassName:"mx_SpacePanel_iconPlus",label:Object(m.b)("Video room"),onClick:a},l.a.createElement(b.a,null)),D&&l.a.createElement(d.b,{"data-testid":"new-subspace-option",iconClassName:"mx_SpacePanel_iconPlus",label:Object(m.b)("Space"),onClick:i},l.a.createElement(b.a,null)))}const A=e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:E.a.ViewRoom,room_id:t.roomId,metricsTrigger:void 0}),n()};return l.a.createElement(d.e,i()({},s,{onFinished:n,className:"mx_SpacePanel_contextMenu",compact:!0}),!a&&l.a.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},t.name),l.a.createElement(d.c,{first:!0},l.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconHome",label:Object(m.b)("Space home"),onClick:e=>{S.b.trackInteraction("WebSpaceContextMenuHomeItem",e),A(e)}}),C,l.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconExplore",label:N?Object(m.b)("Manage & explore rooms"):Object(m.b)("Explore rooms"),onClick:e=>{S.b.trackInteraction("WebSpaceContextMenuExploreRoomsItem",e),A(e)}}),l.a.createElement(d.b,{iconClassName:"mx_SpacePanel_iconPreferences",label:Object(m.b)("Preferences"),onClick:e=>{e.preventDefault(),e.stopPropagation(),Object(h.j)(t),n()}}),k,x,j,M))}},672:function(e,t,a){"use strict";a.d(t,"a",(function(){return v}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(1),l=a(129),c=a(125),d=a(121),m=a(123),h=a(383),u=a(159),p=a(137),g=a(135),b=a(148);class v extends o.a.Component{constructor(e){super(e),i()(this,"onExportE2eKeysClicked",(()=>{l.b.createDialogAsync(a.e(7).then(a.bind(null,1733)),{matrixClient:m.a.get()})})),i()(this,"onFinished",(e=>{e&&c.a.dispatch({action:"logout"}),this.props.onFinished(!!e)})),i()(this,"onSetRecoveryMethodClick",(()=>{this.state.backupInfo?l.b.createDialog(h.a,void 0,void 0,!1,!0):l.b.createDialogAsync(a.e(8).then(a.bind(null,997)),void 0,void 0,!1,!0),this.props.onFinished(!0)})),i()(this,"onLogoutConfirm",(()=>{c.a.dispatch({action:"logout"}),this.props.onFinished(!0)}));const t=m.a.get(),n=t.isCryptoEnabled()&&!t.getKeyBackupEnabled();this.state={shouldLoadBackupStatus:n,loading:n,backupInfo:null},n&&this.loadBackupStatus()}async loadBackupStatus(){try{const e=await m.a.get().getKeyBackupVersion();this.setState({loading:!1,backupInfo:e})}catch(e){r.a.log("Unable to fetch key backup status",e),this.setState({loading:!1,error:e})}}render(){if(this.state.shouldLoadBackupStatus){const e=o.a.createElement("div",null,o.a.createElement("p",null,Object(d.b)("Encrypted messages are secured with end-to-end encryption. Only you and the recipient(s) have the keys to read these messages.")),o.a.createElement("p",null,Object(d.b)("When you sign out, these keys will be deleted from this device, which means you won't be able to read encrypted messages unless you have the keys for them on your other devices, or backed them up to the server.")),o.a.createElement("p",null,Object(d.b)("Back up your keys before signing out to avoid losing them.")));let t;if(this.state.loading)t=o.a.createElement(g.a,null);else{let a;a=this.state.backupInfo?Object(d.b)("Connect this session to Key Backup"):Object(d.b)("Start using Key Backup"),t=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},e),o.a.createElement(b.a,{primaryButton:a,hasCancel:!1,onPrimaryButtonClick:this.onSetRecoveryMethodClick,focus:!0},o.a.createElement("button",{onClick:this.onLogoutConfirm},Object(d.b)("I don't want my encrypted messages"))),o.a.createElement("details",null,o.a.createElement("summary",null,Object(d.b)("Advanced")),o.a.createElement("p",null,o.a.createElement("button",{onClick:this.onExportE2eKeysClicked},Object(d.b)("Manually export keys")))))}return o.a.createElement(p.a,{title:Object(d.b)("You'll lose access to your encrypted messages"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this.onFinished},t)}return o.a.createElement(u.a,{hasCancelButton:!0,title:Object(d.b)("Sign out"),description:Object(d.b)("Are you sure you want to sign out?"),button:Object(d.b)("Sign out"),onFinished:this.onFinished})}}i()(v,"defaultProps",{onFinished:function(){}})},675:function(e,t,a){"use strict";a.d(t,"a",(function(){return v}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(460),l=a.n(r),c=a(127),d=a.n(c),m=a(1),h=a(121),u=a(125),p=a(123),g=a(133),b=a(221);class v extends o.a.PureComponent{constructor(e,t){super(e,t),i()(this,"unmounted",!1),i()(this,"dispatcherRef",null),i()(this,"onAction",(e=>{"client_started"===e.action&&this.forceUpdate()})),this.state={page:""}}translate(e){return l()(Object(h.b)(e))}async fetchEmbed(){let e;try{e=await fetch(this.props.url,{method:"GET"})}catch(e){if(this.unmounted)return;return m.a.warn(`Error loading page: ${e}`),void this.setState({page:Object(h.b)("Couldn't load page")})}if(this.unmounted)return;if(!e.ok)return m.a.warn(`Error loading page: ${e.status}`),void this.setState({page:Object(h.b)("Couldn't load page")});let t=(await e.text()).replace(/_t\(['"]([\s\S]*?)['"]\)/gm,((e,t)=>this.translate(t)));this.props.replaceMap&&Object.keys(this.props.replaceMap).forEach((e=>{t=t.split(e).join(this.props.replaceMap[e])})),this.setState({page:t})}componentDidMount(){this.unmounted=!1,this.props.url&&(this.fetchEmbed(),this.dispatcherRef=u.a.register(this.onAction))}componentWillUnmount(){this.unmounted=!0,null!==this.dispatcherRef&&u.a.unregister(this.dispatcherRef)}render(){const e=this.context||p.a.get(),t=!e||e.isGuest(),a=this.props.className,n=d()(a,{[`${a}_guest`]:t,[`${a}_loggedIn`]:!!e}),i=o.a.createElement("div",{className:`${a}_body`,dangerouslySetInnerHTML:{__html:this.state.page}});return this.props.scrollbar?o.a.createElement(b.a,{className:n},i):o.a.createElement("div",{className:n},i)}}i()(v,"contextType",g.a)},677:function(e,t,a){"use strict";a.d(t,"a",(function(){return f}));var n=a(122),i=a.n(n),s=a(181),o=a(420),r=a(1),l=a(1699),c=a.n(l),d=a(123),m=a(979),h=a(557),u=a(161),p=a(165),g=a(184),b=a(121),v=a(132);class f{constructor(e,t,a,n){if(this.room=e,this.exportType=t,this.exportOptions=a,this.setProgressText=n,i()(this,"files",[]),i()(this,"client",void 0),i()(this,"cancelled",!1),a.maxSize<1048576||a.maxSize>8388608e3||a.numberOfMessages&&a.numberOfMessages>10**8||t===m.b.LastNMessages&&!a.numberOfMessages)throw new Error("Invalid export options");this.client=d.a.get(),window.addEventListener("beforeunload",this.onBeforeUnload)}get destinationFileName(){return this.makeFileNameNoExtension(v.b.get().brand)+".zip"}onBeforeUnload(e){return e.preventDefault(),e.returnValue=Object(b.b)("Are you sure you want to exit during this export?")}updateProgress(e){let t=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&r.a.log(e),t&&this.setProgressText(e)}addFile(e,t){const a={name:e,blob:t};this.files.push(a)}makeFileNameNoExtension(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"matrix";const a=c()(null!==(e=this.room.name)&&void 0!==e?e:Object(b.b)("Unnamed Room")).trim()||"Unnamed Room",n=Object(p.f)(new Date).replace(/:/g,"-");return`${c()(t)} - ${a} - Chat Export - ${n}`}async downloadZIP(){const e=this.destinationFileName,t=e.substring(0,e.lastIndexOf(".")),{default:n}=await a.e(44).then(a.t.bind(null,1734,7)),i=new n;if(this.cancelled)return this.cleanUp();this.updateProgress(Object(b.b)("Generating a ZIP"));for(const e of this.files)i.file(t+"/"+e.name,e.blob);const s=await i.generateAsync({type:"blob"});Object(o.saveAs)(s,t+".zip")}cleanUp(){return r.a.log("Cleaning up..."),window.removeEventListener("beforeunload",this.onBeforeUnload),""}async cancelExport(){r.a.log("Cancelling export..."),this.cancelled=!0}downloadPlainText(e,t){const a=new Blob([t],{type:"text/plain"});Object(o.saveAs)(a,e)}setEventMetadata(e){var t;const a=null===(t=this.client.getRoom(this.room.roomId))||void 0===t?void 0:t.currentState,n=e.getSender();var i;(e.sender=!!n&&(null==a?void 0:a.getSentinelMember(n))||null,"m.room.member"===e.getType())&&(e.target=null!==(i=null==a?void 0:a.getSentinelMember(e.getStateKey()))&&void 0!==i?i:null);return e}getLimit(){let e;switch(this.exportType){case m.b.LastNMessages:e=this.exportOptions.numberOfMessages;break;case m.b.Timeline:e=40;break;default:e=10**8}return e}async getRequiredEvents(){const e=this.client.getEventMapper();let t=null,a=this.getLimit();const n=[];for(;a;){var i;const o=Math.min(a,1e3),r=await this.client.createMessagesRequest(this.room.roomId,t,o,s.a.Backward);if(this.cancelled)return this.cleanUp(),[];if(0===r.chunk.length)break;a-=r.chunk.length;const l=r.chunk.map(e);for(const e of l)n.push(e);this.exportType===m.b.LastNMessages?this.updateProgress(Object(b.b)("Fetched %(count)s events out of %(total)s",{count:n.length,total:this.exportOptions.numberOfMessages})):this.updateProgress(Object(b.b)("Fetched %(count)s events so far",{count:n.length})),t=null!==(i=r.end)&&void 0!==i?i:null}for(let e=0;e<Math.floor(n.length/2);e++)[n[e],n[n.length-e-1]]=[n[n.length-e-1],n[e]];const o=n.filter((e=>e.isEncrypted())).map((e=>this.client.decryptEventIfNeeded(e,{isRetry:!0,emit:!1})));await Promise.all(o);for(let e=0;e<n.length;e++)this.setEventMetadata(n[e]);return n}async getMediaBlob(e){let t;try{const a=e.isEncrypted(),n=e.getContent();if(a&&n.hasOwnProperty("file")&&"m.sticker"!==e.getType())t=await Object(h.c)(n.file);else{const e=Object(u.a)(n);if(!e.srcHttp)throw new Error("Cannot fetch without srcHttp");const a=await fetch(e.srcHttp);t=await a.blob()}}catch(e){r.a.log("Error decrypting media")}if(!t)throw new Error("Unable to fetch file");return t}splitFileName(e){const t=e.lastIndexOf(".");if(-1===t)return[e,""];return[e.slice(0,t),"."+e.slice(t+1)]}getFilePath(e){let t;switch(e.getContent().msgtype){case"m.image":t="images";break;case"m.video":t="videos";break;case"m.audio":t="audio";break;default:t="m.sticker"===e.getType()?"stickers":"files"}const a=Object(p.e)(new Date(e.getTs()));let[n,i]=this.splitFileName(e.getContent().body);return"m.sticker"===e.getType()&&(i=".png"),Object(g.m)(e)&&(i=".ogg"),t+"/"+n+"-"+a+i}isReply(e){const t=(e.isEncrypted()?e.event.content:e.getContent())["m.relates_to"];return!(!t||!t["m.in_reply_to"])}isAttachment(e){const t=["m.sticker","m.image","m.file","m.video","m.audio"];return e.getType()===t[0]||t.includes(e.getContent().msgtype)}}},678:function(e,t,a){"use strict";(function(e){var n=a(120),i=a.n(n),s=a(130),o=a(133),r=a(139),l=a(167),c=a(121),d=a(124),m=a(977),h=a(166),u=a(125),p=a(128),g=a(180),b=a(257),v=a(289),f=a(424),E=a(123),y=a(214),_=a(157),S=a(309),w=a(307),O=a(980);t.a=()=>{var t;const a=Object(n.useContext)(o.a),{room:C,roomId:x}=Object(n.useContext)(r.b);if(!C||!x)throw new Error("Unable to create a NewRoomIntro without room and roomId");const j=C instanceof w.b,k=j?null===(t=C.targets[0])||void 0===t?void 0:t.userId:l.a.shared().getUserIdForRoomId(x);let R;if(k){const{shouldEncrypt:e}=Object(O.a)(C),t=((e,t)=>e instanceof w.b?Object(c.d)("Send your first message to invite <displayName/> to chat"):t?Object(c.d)("Once everyone has joined, you’ll be able to chat"):Object(c.d)("This is the beginning of your direct message history with <displayName/>."))(C,e);let a;C instanceof w.b||e||C.getJoinedMemberCount()+C.getInvitedMemberCount()!==2||(a=Object(c.b)("Only the two of you are in this conversation, unless either of you invites anyone to join."));const n=null==C?void 0:C.getMember(k),s=(null==C?void 0:C.name)||(null==n?void 0:n.rawDisplayName)||k;R=i.a.createElement(i.a.Fragment,null,i.a.createElement(h.a,{room:C,width:m.a,height:m.a,onClick:()=>{u.a.dispatch({action:p.a.ViewUser,member:n||{userId:k}})}}),i.a.createElement("h2",null,C.name),i.a.createElement("p",null,Object(c.b)(t,{},{displayName:()=>i.a.createElement("b",null,s)})),a&&i.a.createElement("p",null,a))}else{var I,T,N,P,D,M,A;const t=C&&"join"===C.getMyMembership(),n=null===(I=C.currentState.getStateEvents(s.b.RoomTopic,""))||void 0===I||null===(T=I.getContent())||void 0===T?void 0:T.topic,o=t&&C.currentState.maySendStateEvent(s.b.RoomTopic,a.getSafeUserId()),r=()=>{u.a.dispatch({action:"open_room_settings",room_id:x},!0),e((()=>{var e;null===(e=window.document.getElementById("profileTopic"))||void 0===e||e.focus()}))};let l;o&&n?l=Object(c.b)("Topic: %(topic)s (<a>edit</a>)",{topic:n},{a:e=>i.a.createElement(d.a,{element:"a",kind:"link_inline",onClick:r},e)}):n?l=Object(c.b)("Topic: %(topic)s ",{topic:n}):o&&(l=Object(c.b)("<a>Add a topic</a> to help people know what it is about.",{},{a:e=>i.a.createElement(d.a,{element:"a",kind:"link_inline",onClick:r},e)}));const p=null===(N=C.currentState.getStateEvents(s.b.RoomCreate,""))||void 0===N?void 0:N.getSender(),v=p&&(null==C||null===(P=C.getMember(p))||void 0===P?void 0:P.rawDisplayName)||p;let f,E,S;f=p===a.getUserId()?Object(c.b)("You created this room."):Object(c.b)("%(displayName)s created this room.",{displayName:v}),null!==(D=g.a.instance.activeSpaceRoom)&&void 0!==D&&D.canInvite(a.getSafeUserId())&&g.a.instance.isRoomInSpace(g.a.instance.activeSpace,C.roomId)&&(E=g.a.instance.activeSpaceRoom),E&&Object(y.a)(_.a.InviteUsers)?S=i.a.createElement("div",{className:"mx_NewRoomIntro_buttons"},i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{Object(b.i)(E)}},Object(c.b)("Invite to %(spaceName)s",{spaceName:E.name})),C.canInvite(a.getSafeUserId())&&i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary_outline",onClick:()=>{u.a.dispatch({action:"view_invite",roomId:x})}},Object(c.b)("Invite to just this room"))):C.canInvite(a.getSafeUserId())&&Object(y.a)(_.a.InviteUsers)&&(S=i.a.createElement("div",{className:"mx_NewRoomIntro_buttons"},i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{u.a.dispatch({action:"view_invite",roomId:x})}},Object(c.b)("Invite to this room"))));const w=null===(M=C.currentState.getStateEvents(s.b.RoomAvatar,""))||void 0===M||null===(A=M.getContent())||void 0===A?void 0:A.url;let O=i.a.createElement(h.a,{room:C,width:m.a,height:m.a,viewAvatarOnClick:!!w});w||(O=i.a.createElement(m.b,{hasAvatar:!1,noAvatarLabel:Object(c.b)("Add a photo, so people can easily spot your room."),setAvatarUrl:e=>a.sendStateEvent(x,s.b.RoomAvatar,{url:e},"")},O)),R=i.a.createElement(i.a.Fragment,null,O,i.a.createElement("h2",null,C.name),i.a.createElement("p",null,f," ",Object(c.b)("This is the start of <roomName/>.",{},{roomName:()=>i.a.createElement("b",null,C.name)})),i.a.createElement("p",null,l),S)}const U=Object(c.b)("Your private messages are normally encrypted, but this room isn't. Usually this is due to an unsupported device or method being used, like email invites.");let L;C.currentState.mayClientSendStateEvent(s.b.RoomEncryption,E.a.get())&&!j&&(L=i.a.createElement(d.a,{kind:"link_inline",onClick:function(e){e.preventDefault(),u.a.dispatch({action:"open_room_settings",initial_tab_id:f.b})}},Object(c.b)("Enable encryption in settings.")));const F=i.a.createElement("span",null," ",U," ",L," ");return i.a.createElement("li",{className:"mx_NewRoomIntro"},!function(e,t){const a=e.isRoomEncrypted(t.roomId);return"public"===t.getJoinRule()||!Object(S.a)()||a}(a,C)&&i.a.createElement(v.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon_warning",title:Object(c.b)("End-to-end encryption isn't enabled"),subtitle:F}),R)}}).call(this,a(54).setImmediate)},680:function(e,t,a){"use strict";a.d(t,"a",(function(){return u}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(988),l=a(132),c=a(121),d=a(308);const m={};for(const e of r.a)m[e.iso2]=e;function h(e,t){return"+"===e[0]&&(e=e.slice(1)),0==t.name.toUpperCase().indexOf(e.toUpperCase())||(t.iso2==e.toUpperCase()||-1!==t.prefix.indexOf(e))}class u extends o.a.Component{constructor(e){var t;let a;super(e),i()(this,"onSearchChange",(e=>{this.setState({searchQuery:e})})),i()(this,"onOptionChange",(e=>{this.props.onOptionChange(m[e])})),i()(this,"getShortOption",(e=>{if(!this.props.isSmall)return;let t;return this.props.showPrefix&&(t="+"+m[e].prefix),o.a.createElement("span",{className:"mx_CountryDropdown_shortOption"},this.flagImgForIso2(e),t)}));const n=l.b.get("default_country_code");if(n){const e=r.a.find((e=>e.iso2===n.toUpperCase()));e&&(a=e)}if(!a)try{var s,c,d;const e=new Intl.Locale(null!==(s=navigator.language)&&void 0!==s?s:navigator.languages[0]),t=null!==(c=null!==(d=e.region)&&void 0!==d?d:e.language)&&void 0!==c?c:e.baseName,n=new Intl.DisplayNames(["en"],{type:"region"}).of(t).toUpperCase();a=r.a.find((e=>e.iso2===t.toUpperCase()||e.name.toUpperCase()===n))}catch(e){console.warn("Failed to detect default locale",e)}this.state={searchQuery:"",defaultCountry:null!==(t=a)&&void 0!==t?t:r.a[0]}}componentDidMount(){this.props.value||this.props.onOptionChange(this.state.defaultCountry)}flagImgForIso2(e){return o.a.createElement("div",{className:"mx_Dropdown_option_emoji"},Object(r.b)(e))}render(){let e;if(this.state.searchQuery){if(e=r.a.filter(h.bind(this,this.state.searchQuery)),2==this.state.searchQuery.length&&m[this.state.searchQuery.toUpperCase()]){const t=m[this.state.searchQuery.toUpperCase()];e=e.filter((e=>e.iso2!=t.iso2)),e.unshift(t)}}else e=r.a;const t=e.map((e=>o.a.createElement("div",{className:"mx_CountryDropdown_option",key:e.iso2},this.flagImgForIso2(e.iso2),Object(c.b)(e.name)," (+",e.prefix,")"))),a=this.props.value||this.state.defaultCountry.iso2;return o.a.createElement(d.a,{id:"mx_CountryDropdown",className:this.props.className+" mx_CountryDropdown",onOptionChange:this.onOptionChange,onSearchChange:this.onSearchChange,menuWidth:298,getShortOption:this.getShortOption,value:a,searchEnabled:!0,disabled:this.props.disabled,label:Object(c.b)("Country Dropdown")},t)}}},681:function(e,t,a){"use strict";a.d(t,"a",(function(){return c}));var n=a(120),i=a.n(n),s=a(145),o=a(208),r=a(121);const l=e=>{let{name:t,last:a}=e;const n=s.g[t],o=s.a[t];return i.a.createElement(i.a.Fragment,null,i.a.createElement("kbd",null," ",n||o&&Object(r.b)(o)||t," "),!a&&"+")},c=e=>{let{value:t,className:a="mx_KeyboardShortcut"}=e;if(!t)return null;const n=[];return t.ctrlOrCmdKey?n.push(i.a.createElement(l,{key:"ctrlOrCmdKey",name:o.a?o.b.META:o.b.CONTROL})):t.ctrlKey?n.push(i.a.createElement(l,{key:"ctrlKey",name:o.b.CONTROL})):t.metaKey&&n.push(i.a.createElement(l,{key:"metaKey",name:o.b.META})),t.altKey&&n.push(i.a.createElement(l,{key:"altKey",name:o.b.ALT})),t.shiftKey&&n.push(i.a.createElement(l,{key:"shiftKey",name:o.b.SHIFT})),i.a.createElement("div",{className:a},n,i.a.createElement(l,{name:t.key,last:!0}))}},682:function(e,t,a){"use strict";var n=a(131),i=a.n(n),s=a(134),o=a.n(s),r=a(120),l=a.n(r),c=a(150),d=a(127),m=a.n(d),h=a(360),u=a(158),p=a(124),g=a(121),b=a(151),v=a(161),f=a(192);const E=["matrixClient","loginType","fragmentAfterLogin","idp","primary","mini","action","flow"],y=e=>{let t,{matrixClient:n,loginType:s,fragmentAfterLogin:r,idp:c,primary:d,mini:y,action:_,flow:S}=e,w=o()(e,E);t=c?Object(g.b)("Continue with %(provider)s",{provider:c.name}):h.a.findIn(S)?Object(g.b)("Continue"):Object(g.b)("Sign in with single sign-on");const O=()=>{var e,t;const a=(e=>{switch(e){case h.b.Apple:return"Apple";case h.b.Facebook:return"Facebook";case h.b.Github:return"GitHub";case h.b.Gitlab:return"GitLab";case h.b.Google:return"Google";default:return"SSO"}})(null!==(e=null==c?void 0:c.brand)&&void 0!==e?e:"");f.a.instance.setAuthenticationType(a),null===(t=u.a.get())||void 0===t||t.startSingleSignOn(n,s,r,null==c?void 0:c.id,_)};let C,x;const j=null!=c&&c.brand?(e=>{switch(e){case h.b.Apple:return a(1723).default;case h.b.Facebook:return a(1724).default;case h.b.Github:return a(1725).default;case h.b.Gitlab:return a(1726).default;case h.b.Google:return a(1727).default;case h.b.Twitter:return a(1728).default;default:return null}})(c.brand):null;if(null!=c&&c.brand&&j){const e=c.brand.split(".").pop();x=`mx_SSOButton_brand_${e}`,C=l.a.createElement("img",{src:j,height:"24",width:"24",alt:e})}else if("string"==typeof(null==c?void 0:c.icon)&&c.icon.startsWith("mxc://")){var k;const e=null!==(k=Object(v.b)(c.icon,n).getSquareThumbnailHttp(24))&&void 0!==k?k:void 0;C=l.a.createElement("img",{src:e,height:"24",width:"24",alt:c.name})}const R=x?{[x]:x}:void 0,I=m()("mx_SSOButton",{mx_SSOButton_mini:y,mx_SSOButton_default:!c,mx_SSOButton_primary:d},R);return y?l.a.createElement(b.a,i()({},w,{title:t,className:I,onClick:O}),C):l.a.createElement(p.a,i()({},w,{className:I,onClick:O}),C,t)};t.a=e=>{let{matrixClient:t,flow:a,loginType:n,fragmentAfterLogin:i,primary:s,action:o}=e;const r=a.identity_providers||[];if(r.length<2)return l.a.createElement("div",{className:"mx_SSOButtons"},l.a.createElement(y,{matrixClient:t,loginType:n,fragmentAfterLogin:i,idp:r[0],primary:s,action:o,flow:a}));const d=Math.ceil(r.length/6),m=Math.ceil(r.length/d);return l.a.createElement("div",{className:"mx_SSOButtons"},Object(c.chunk)(r,m).map((e=>l.a.createElement("div",{key:e[0].id,className:"mx_SSOButtons_row"},e.map((e=>l.a.createElement(y,{key:e.id,matrixClient:t,loginType:n,fragmentAfterLogin:i,idp:e,mini:!0,primary:s,action:o,flow:a})))))))}},691:function(e,t,a){"use strict";a.d(t,"b",(function(){return ue})),a.d(t,"a",(function(){return pe}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(187),l=a.n(r),c=a(127),d=a.n(c),m=a(130),h=a(146),u=a(1),p=a(153),g=a(207),b=a(16),v=a(387),f=a(165),E=a(123),y=a(126),_=a(139),S=a(173),w=a(121),O=a(363),C=a(303);class x extends o.a.Component{constructor(e){super(e),i()(this,"onMouseDown",(e=>{this.setState({location:{currentX:e.clientX,currentY:e.clientY}}),document.addEventListener("mousemove",this.state.onMouseMove),document.addEventListener("mouseup",this.state.onMouseUp)})),i()(this,"onMouseUp",(e=>{document.removeEventListener("mousemove",this.state.onMouseMove),document.removeEventListener("mouseup",this.state.onMouseUp),this.props.onMouseUp(e)})),this.state={onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),location:{currentX:0,currentY:0}}}onMouseMove(e){const t=this.props.dragFunc(this.state.location,e);this.setState({location:t})}render(){return o.a.createElement("div",{className:this.props.className,onMouseDown:this.onMouseDown})}}var j=a(138);class k extends o.a.Component{constructor(e){super(e),i()(this,"dragFunc",((e,t)=>{const a=t.clientX-e.currentX,n=this.state.width+a;return n<this.props.minWidth||n>this.props.maxWidth?e:(this.setState({width:n}),this.updateCSSWidth.bind(this)(n),{currentX:t.clientX,currentY:e.currentY})})),i()(this,"onMoueUp",(()=>{this.props.roomId&&y.b.setValue("ircDisplayNameWidth",this.props.roomId,j.a.ROOM_DEVICE,this.state.width)})),this.state={width:y.b.getValue("ircDisplayNameWidth",this.props.roomId),IRCLayoutRoot:null}}componentDidMount(){this.setState({IRCLayoutRoot:document.querySelector(".mx_IRCLayout")},(()=>this.updateCSSWidth(this.state.width)))}updateCSSWidth(e){var t;null===(t=this.state.IRCLayoutRoot)||void 0===t||t.style.setProperty("--name-width",e+"px")}render(){return o.a.createElement(x,{className:"mx_ProfileResizer",dragFunc:this.dragFunc,onMouseUp:this.onMoueUp})}}var R=a(167),I=a(678),T=a(181),N=a(289);var P=()=>{var e;const{room:t}=Object(s.useContext)(_.b),a=null==t?void 0:t.getLiveTimeline().getState(T.b.BACKWARDS),n=null==a?void 0:a.getStateEvents("m.room.encryption")[0],i=null==a||null===(e=a.getStateEvents("m.room.history_visibility")[0])||void 0===e?void 0:e.getContent().history_visibility;let r;return"invited"==i?r=Object(w.b)("You don't have permission to view messages from before you were invited."):"joined"==i?r=Object(w.b)("You don't have permission to view messages from before you joined."):n&&(r=Object(w.b)("Encrypted messages before this point are unavailable.")),o.a.createElement(N.a,{className:"mx_HistoryTile",title:Object(w.b)("You can't see earlier messages"),subtitle:r})},D=a(125),M=a(143),A=a(188);function U(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const a=[],n=Object.keys(e.currentState.members);for(const i of n)e.currentState.members[i].typing&&-1===t.indexOf(i)&&a.push(e.currentState.members[i]);return a}var L=a(353),F=a(175);class B extends o.a.Component{constructor(){var e;super(...arguments),i()(this,"state",{usersTyping:(e=this.props.room,U(e,[E.a.get().getUserId()])),delayedStopTypingTimers:{}}),i()(this,"isVisible",(()=>B.isVisible(this.state))),i()(this,"onRoomTimeline",((e,t)=>{if((null==t?void 0:t.roomId)===this.props.room.roomId){const t=e.getSender(),a=this.state.usersTyping.filter((e=>e.userId!==t));a.length!==this.state.usersTyping.length&&this.setState({usersTyping:a}),this.abortUserTimer(t)}})),i()(this,"onRoomMemberTyping",(()=>{const e=function(e){return U(e,[E.a.get().getUserId()].concat(E.a.get().getIgnoredUsers()))}(this.props.room);this.setState({delayedStopTypingTimers:this.updateDelayedStopTypingTimers(e),usersTyping:e})}))}componentDidMount(){E.a.get().on(A.b.Typing,this.onRoomMemberTyping),E.a.get().on(M.d.Timeline,this.onRoomTimeline)}componentDidUpdate(e,t){const a=B.isVisible(t),n=B.isVisible(this.state);this.props.onShown&&!a&&n?this.props.onShown():this.props.onHidden&&a&&!n&&this.props.onHidden()}componentWillUnmount(){const e=E.a.get();e&&(e.removeListener(A.b.Typing,this.onRoomMemberTyping),e.removeListener(M.d.Timeline,this.onRoomTimeline)),Object.values(this.state.delayedStopTypingTimers).forEach((e=>e.abort()))}static isVisible(e){return 0!==e.usersTyping.length||0!==Object.keys(e.delayedStopTypingTimers).length}updateDelayedStopTypingTimers(e){const t=this.state.usersTyping.filter((t=>!e.some((e=>t.userId===e.userId)))),a=e.filter((e=>!this.state.usersTyping.some((t=>e.userId===t.userId))));a.forEach((e=>{const t=this.state.delayedStopTypingTimers[e.userId];t&&t.abort()}));let n=Object.assign({},this.state.delayedStopTypingTimers);return n=a.reduce(((e,t)=>(delete e[t.userId],e)),n),n=t.reduce(((e,t)=>{if(!e[t.userId]){const a=new L.a(5e3);e[t.userId]=a,a.start(),a.finished().then((()=>this.removeUserTimer(t.userId)),(()=>{}))}return e}),n),n}abortUserTimer(e){const t=this.state.delayedStopTypingTimers[e];t&&(t.abort(),this.removeUserTimer(e))}removeUserTimer(e){if(this.state.delayedStopTypingTimers[e]){const t=Object.assign({},this.state.delayedStopTypingTimers);delete t[e],this.setState({delayedStopTypingTimers:t})}}renderTypingIndicatorAvatars(e,t){let a=0;e.length>t&&(a=e.length-t+1,e=e.slice(0,t-1));const n=e.map((e=>o.a.createElement(F.b,{key:e.userId,member:e,width:24,height:24,resizeMethod:"crop",viewUserOnClick:!0,"aria-live":"off"})));return a>0&&n.push(o.a.createElement("span",{className:"mx_WhoIsTypingTile_remainingAvatarPlaceholder",key:"others"},"+",a)),n}render(){let e=this.state.usersTyping;const t=Object.keys(this.state.delayedStopTypingTimers).map((e=>this.props.room.getMember(e)));e=e.concat(t),e.sort(((e,t)=>Object(b.h)(e.name,t.name)));const a=function(e,t){let a=0;if(e.length>t&&(a=e.length-t+1),0===e.length)return"";if(1===e.length)return Object(w.b)("%(displayName)s is typing …",{displayName:e[0].name});const n=e.map((e=>e.name));if(a>=1)return Object(w.b)("%(names)s and %(count)s others are typing …",{names:n.slice(0,t-1).join(", "),count:a});{const e=n.pop();return Object(w.b)("%(names)s and %(lastPerson)s are typing …",{names:n.join(", "),lastPerson:e})}}(e,this.props.whoIsTypingLimit);return a?o.a.createElement("li",{className:"mx_WhoIsTypingTile","aria-atomic":"true"},o.a.createElement("div",{className:"mx_WhoIsTypingTile_avatars"},this.renderTypingIndicatorAvatars(e,this.props.whoIsTypingLimit)),o.a.createElement("div",{className:"mx_WhoIsTypingTile_label"},a)):null}}i()(B,"defaultProps",{whoIsTypingLimit:3});var V=a(414),W=a(150),z=a(415),H=a(124);var K=e=>{let{events:t,children:a,threshold:n=3,onToggle:i,startExpanded:r=!1,summaryMembers:l=[],summaryText:c,layout:d=S.a.Group,"data-testid":m}=e;const[h,p]=Object(z.a)(r);Object(s.useEffect)((()=>{i&&i()}),[h]);const g=t.map((e=>e.getId())).join(",");if(t.length<n)return o.a.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":g,"data-expanded":!0,"data-layout":d},o.a.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},a));let b;if(h)b=o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_GenericEventListSummary_spacer"}," "),o.a.createElement("ol",{className:"mx_GenericEventListSummary_unstyledList"},a));else{const e=Object(W.uniqBy)(l.filter((e=>!(null==e||!e.getMxcAvatarUrl)||(u.a.error("EventListSummary given null summaryMember, termites may be afoot eating event senders",l),!1))),(e=>e.getMxcAvatarUrl())).map((e=>o.a.createElement(F.b,{key:e.userId,member:e,width:14,height:14})));b=d===S.a.Bubble?o.a.createElement("div",{className:"mx_EventTile_line sc_EventTile_bubbleLine sc_EventTile_bubbleLine_info"},o.a.createElement("div",{className:"sc_EventTile_bubbleArea sc_EventTile_bubbleArea_center sc_EventTile_bubbleArea_info"},o.a.createElement("div",{className:"sc_EventTile_bubble sc_EventTile_bubble_info sc_EventTile_bubble_center"},o.a.createElement("span",{className:"mx_GenericEventListSummary_avatars",onClick:p},e),o.a.createElement("span",{className:"mx_TextualEvent mx_GenericEventListSummary_summary"},c)))):o.a.createElement("div",{className:"mx_EventTile_line"},o.a.createElement("div",{className:"mx_EventTile_info"},o.a.createElement("span",{className:"mx_GenericEventListSummary_avatars",onClick:p},e),o.a.createElement("span",{className:"mx_TextualEvent mx_GenericEventListSummary_summary"},c)))}return o.a.createElement("li",{className:"mx_GenericEventListSummary","data-scroll-tokens":g,"data-expanded":h+"","data-layout":d,"data-testid":m},o.a.createElement(H.a,{kind:"link_inline",className:"mx_GenericEventListSummary_toggle",onClick:p,"aria-expanded":h},h?Object(w.b)("collapse"):Object(w.b)("expand")),b)},G=a(218),q=a(236),$=a(185),Y=a(806),J=a(176);const Q=()=>{J.a.instance.setCard({phase:$.a.PinnedMessages},!1)},X=[m.b.RoomMember];var Z=function(e){return e.Joined="joined",e.Left="left",e.JoinedAndLeft="joined_and_left",e.LeftAndJoined="left_and_joined",e.InviteReject="invite_reject",e.InviteWithdrawal="invite_withdrawal",e.Invited="invited",e.Banned="banned",e.Unbanned="unbanned",e.Kicked="kicked",e.ChangedName="changed_name",e.ChangedAvatar="changed_avatar",e.NoChange="no_change",e.ServerAcl="server_acl",e.ChangedPins="pinned_messages",e.MessageRemoved="message_removed",e.HiddenEvent="hidden_event",e}(Z||{});class ee extends o.a.Component{constructor(){super(...arguments),i()(this,"context",void 0)}shouldComponentUpdate(e){return e.events.length!==this.props.events.length||e.events.length<this.props.threshold||e.layout!==this.props.layout}generateSummary(e,t){const a=t.map((t=>{const a=e[t],n=this.renderNameList(a),i=t.split(","),s=ee.getCanonicalTransitions(i),o=ee.coalesceRepeatedTransitions(s).map((e=>ee.getDescriptionForTransition(e.transitionType,a.length,e.repeats))),r=Object(G.b)(o);return Object(w.b)("%(nameList)s %(transitionList)s",{nameList:n,transitionList:r})}));return a?Object(Y.a)(a,", "):null}renderNameList(e){return Object(G.b)(e,this.props.summaryLength)}static getCanonicalTransitions(e){const t={[Z.Joined]:{after:Z.Left,newTransition:Z.JoinedAndLeft},[Z.Left]:{after:Z.Joined,newTransition:Z.LeftAndJoined}},a=[];for(let n=0;n<e.length;n++){const i=e[n],s=e[n+1];let o=i;n<e.length-1&&t[i]&&t[i].after===s&&(o=t[i].newTransition,n++),a.push(o)}return a}static coalesceRepeatedTransitions(e){const t=[];for(const a of e)t.length>0&&t[t.length-1].transitionType===a?t[t.length-1].repeats+=1:t.push({transitionType:a,repeats:1});return t}static getDescriptionForTransition(e,t,a){var n;let i;switch(e){case Z.Joined:i=t>1?Object(w.b)("%(severalUsers)sjoined %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)sjoined %(count)s times",{oneUser:"",count:a});break;case Z.Left:i=t>1?Object(w.b)("%(severalUsers)sleft %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)sleft %(count)s times",{oneUser:"",count:a});break;case Z.JoinedAndLeft:i=t>1?Object(w.b)("%(severalUsers)sjoined and left %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)sjoined and left %(count)s times",{oneUser:"",count:a});break;case Z.LeftAndJoined:i=t>1?Object(w.b)("%(severalUsers)sleft and rejoined %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)sleft and rejoined %(count)s times",{oneUser:"",count:a});break;case Z.InviteReject:i=t>1?Object(w.b)("%(severalUsers)srejected their invitations %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)srejected their invitation %(count)s times",{oneUser:"",count:a});break;case Z.InviteWithdrawal:i=t>1?Object(w.b)("%(severalUsers)shad their invitations withdrawn %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)shad their invitation withdrawn %(count)s times",{oneUser:"",count:a});break;case Z.Invited:i=t>1?Object(w.b)("were invited %(count)s times",{count:a}):Object(w.b)("was invited %(count)s times",{count:a});break;case Z.Banned:i=t>1?Object(w.b)("were banned %(count)s times",{count:a}):Object(w.b)("was banned %(count)s times",{count:a});break;case Z.Unbanned:i=t>1?Object(w.b)("were unbanned %(count)s times",{count:a}):Object(w.b)("was unbanned %(count)s times",{count:a});break;case Z.Kicked:i=t>1?Object(w.b)("were removed %(count)s times",{count:a}):Object(w.b)("was removed %(count)s times",{count:a});break;case Z.ChangedName:i=t>1?Object(w.b)("%(severalUsers)schanged their name %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)schanged their name %(count)s times",{oneUser:"",count:a});break;case Z.ChangedAvatar:i=t>1?Object(w.b)("%(severalUsers)schanged their avatar %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)schanged their avatar %(count)s times",{oneUser:"",count:a});break;case Z.NoChange:i=t>1?Object(w.b)("%(severalUsers)smade no changes %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)smade no changes %(count)s times",{oneUser:"",count:a});break;case Z.ServerAcl:i=t>1?Object(w.b)("%(severalUsers)schanged the server ACLs %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)schanged the server ACLs %(count)s times",{oneUser:"",count:a});break;case Z.ChangedPins:i=t>1?Object(w.b)("%(severalUsers)schanged the <a>pinned messages</a> for the room %(count)s times",{severalUsers:"",count:a},{a:e=>o.a.createElement(H.a,{kind:"link_inline",onClick:Q},e)}):Object(w.b)("%(oneUser)schanged the <a>pinned messages</a> for the room %(count)s times",{oneUser:"",count:a},{a:e=>o.a.createElement(H.a,{kind:"link_inline",onClick:Q},e)});break;case Z.MessageRemoved:i=t>1?Object(w.b)("%(severalUsers)sremoved a message %(count)s times",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)sremoved a message %(count)s times",{oneUser:"",count:a});break;case Z.HiddenEvent:i=t>1?Object(w.b)("%(severalUsers)ssent %(count)s hidden messages",{severalUsers:"",count:a}):Object(w.b)("%(oneUser)ssent %(count)s hidden messages",{oneUser:"",count:a})}return null!==(n=i)&&void 0!==n?n:null}static getTransitionSequence(e){return e.map(ee.getTransition)}static getTransition(e){if(e.mxEvent.isRedacted())return Z.MessageRemoved;switch(e.mxEvent.getType()){case m.b.RoomThirdPartyInvite:return Object(q.c)(e.mxEvent)?Z.Invited:Z.InviteWithdrawal;case m.b.RoomServerAcl:return Z.ServerAcl;case m.b.RoomPinnedEvents:return Z.ChangedPins;case m.b.RoomMember:switch(e.mxEvent.getContent().membership){case"invite":return Z.Invited;case"ban":return Z.Banned;case"join":return"join"===e.mxEvent.getPrevContent().membership?e.mxEvent.getContent().displayname!==e.mxEvent.getPrevContent().displayname?Z.ChangedName:e.mxEvent.getContent().avatar_url!==e.mxEvent.getPrevContent().avatar_url?Z.ChangedAvatar:Z.NoChange:Z.Joined;case"leave":if(e.mxEvent.getSender()===e.mxEvent.getStateKey())return"invite"===e.mxEvent.getPrevContent().membership?Z.InviteReject:Z.Left;switch(e.mxEvent.getPrevContent().membership){case"invite":return Z.InviteWithdrawal;case"ban":return Z.Unbanned;default:return Z.Kicked}default:return null}default:return Z.HiddenEvent}}getAggregate(e){const t={},a={};return Object.keys(e).forEach((n=>{const i=e[n][0],s=i.displayName,o=ee.getTransitionSequence(e[n]).join(",");t[o]||(t[o]=[],a[o]=-1),t[o].push(s),(-1===a[o]||i.index<a[o])&&(a[o]=i.index)})),{names:t,indices:a}}render(){const e=this.props.events,t=new Map,a={};e.forEach(((e,n)=>{var i;const s=e.getType();let o=e.getSender();e.isState()&&s===m.b.RoomThirdPartyInvite?o=e.getContent().display_name:e.isState()&&s===m.b.RoomMember?o=e.getStateKey():e.isRedacted()&&null!==(i=e.getUnsigned())&&void 0!==i&&i.redacted_because&&(o=e.getUnsigned().redacted_because.sender),a[o]||(a[o]=[]);let r=o;if(e.isRedacted()){var l,c;const e=null===(l=this.context)||void 0===l||null===(c=l.room)||void 0===c?void 0:c.getMember(o);e&&(r=e.name,t.set(o,e))}else e.target&&X.includes(s)?(r=e.target.name,t.set(o,e.target)):e.sender&&s!==m.b.RoomThirdPartyInvite&&(r=e.sender.name,t.set(o,e.sender));a[o].push({mxEvent:e,displayName:r,index:n})}));const n=this.getAggregate(a),i=Object.keys(n.names).sort(((e,t)=>n.indices[e]-n.indices[t]));return o.a.createElement(K,{"data-testid":this.props["data-testid"],events:this.props.events,threshold:this.props.threshold,onToggle:this.props.onToggle,startExpanded:this.props.startExpanded,children:this.props.children,summaryMembers:[...t.values()],layout:this.props.layout,summaryText:this.generateSummary(n.names,i)})}}i()(ee,"contextType",_.b),i()(ee,"defaultProps",{summaryLength:1,threshold:3,avatarsMaxLength:5,layout:S.a.Group});var te=a(522),ae=a(421),ne=a(135),ie=a(128),se=a(666),oe=a(243),re=a(906),le=a(184),ce=a(197);const de=3e5,me=[m.b.Sticker,m.b.RoomMessage],he=[m.b.RoomMember,m.b.RoomThirdPartyInvite,m.b.RoomServerAcl,m.b.RoomPinnedEvents];function ue(e,t,a,n){return n!==_.a.ThreadsList&&(!(null==e||!e.sender||!t.sender)&&(!(t.getTs()-e.getTs()>de)&&(t.isRedacted()===e.isRedacted()&&(!!(t.getType()===e.getType()||me.includes(t.getType())&&me.includes(e.getType()))&&(t.sender.userId===e.sender.userId&&t.sender.name===e.sender.name&&t.sender.getMxcAvatarUrl()===e.sender.getMxcAvatarUrl()&&((!Object(le.i)(t)&&!Object(le.i)(e)||n===_.a.Thread)&&!!Object(oe.c)(e,a)))))))}class pe extends o.a.Component{constructor(e,t){super(e,t),i()(this,"context",void 0),i()(this,"readReceiptMap",{}),i()(this,"readReceiptsByEvent",new Map),i()(this,"readReceiptsByUserId",new Map),i()(this,"_showHiddenEvents",void 0),i()(this,"isMounted",!1),i()(this,"readMarkerNode",Object(s.createRef)()),i()(this,"whoIsTyping",Object(s.createRef)()),i()(this,"scrollPanel",Object(s.createRef)()),i()(this,"showTypingNotificationsWatcherRef",void 0),i()(this,"eventTiles",{}),i()(this,"grouperKeyMap",new WeakMap),i()(this,"calculateRoomMembersCount",(()=>{this.setState({hideSender:this.shouldHideSender()})})),i()(this,"onShowTypingNotificationsChange",(()=>{this.setState({showTypingNotifications:y.b.getValue("showTypingNotifications")})})),i()(this,"isUnmounting",(()=>!this.isMounted)),i()(this,"collectGhostReadMarker",(e=>{e&&requestAnimationFrame((()=>{e.style.width="10%",e.style.opacity="0"}))})),i()(this,"onGhostTransitionEnd",(e=>{const t=e.target.dataset.eventid;this.setState({ghostReadMarkers:this.state.ghostReadMarkers.filter((e=>e!==t))})})),i()(this,"collectEventTile",((e,t)=>{this.eventTiles[e]=t})),i()(this,"onHeightChanged",(()=>{const e=this.scrollPanel.current;e&&e.checkScroll()})),i()(this,"onTypingShown",(()=>{const e=this.scrollPanel.current;null==e||e.checkScroll(),e&&e.getScrollState().stuckAtBottom&&e.preventShrinking()})),i()(this,"onTypingHidden",(()=>{const e=this.scrollPanel.current;e&&(e.updatePreventShrinking(),e.checkScroll())})),this.state={ghostReadMarkers:[],showTypingNotifications:y.b.getValue("showTypingNotifications"),hideSender:this.shouldHideSender()},this._showHiddenEvents=y.b.getValue("showHiddenEventsInTimeline"),this.showTypingNotificationsWatcherRef=y.b.watchSetting("showTypingNotifications",null,this.onShowTypingNotificationsChange)}componentDidMount(){var e;this.calculateRoomMembersCount(),null===(e=this.props.room)||void 0===e||e.currentState.on(p.b.Update,this.calculateRoomMembersCount),this.isMounted=!0}componentWillUnmount(){var e;this.isMounted=!1,null===(e=this.props.room)||void 0===e||e.currentState.off(p.b.Update,this.calculateRoomMembersCount),y.b.unwatchSetting(this.showTypingNotificationsWatcherRef)}componentDidUpdate(e,t){if(e.layout!==this.props.layout&&this.calculateRoomMembersCount(),e.readMarkerVisible&&this.props.readMarkerEventId!==e.readMarkerEventId){const t=this.state.ghostReadMarkers;t.push(e.readMarkerEventId),this.setState({ghostReadMarkers:t})}const a=this.pendingEditItem;if(!this.props.editState&&this.props.room&&a){const e=this.props.room.findEventById(a);D.a.dispatch({action:ie.a.EditEvent,event:null!=e&&e.isRedacted()?null:e,timelineRenderingType:this.context.timelineRenderingType})}}shouldHideSender(){return!!this.props.room&&this.props.room.getInvitedAndJoinedMemberCount()<=2&&this.props.layout===S.a.Bubble}getNodeForEventId(e){var t,a,n;if(this.eventTiles)return null!==(t=null===(a=this.eventTiles[e])||void 0===a||null===(n=a.ref)||void 0===n?void 0:n.current)&&void 0!==t?t:void 0}getTileForEventId(e){if(this.eventTiles&&e)return this.eventTiles[e]}isAtBottom(){var e;return null===(e=this.scrollPanel.current)||void 0===e?void 0:e.isAtBottom()}getScrollState(){var e,t;return null!==(e=null===(t=this.scrollPanel.current)||void 0===t?void 0:t.getScrollState())&&void 0!==e?e:null}getReadMarkerPosition(){const e=this.readMarkerNode.current,t=this.scrollPanel.current;if(!e||!t)return null;const a=l.a.findDOMNode(t).getBoundingClientRect(),n=e.getBoundingClientRect();return n.bottom+2<a.top?-1:n.top<a.bottom?0:1}scrollToTop(){var e;null===(e=this.scrollPanel.current)||void 0===e||e.scrollToTop()}scrollToBottom(){var e;null===(e=this.scrollPanel.current)||void 0===e||e.scrollToBottom()}handleScrollKey(e){var t;null===(t=this.scrollPanel.current)||void 0===t||t.handleScrollKey(e)}scrollToEvent(e,t,a){this.scrollPanel.current&&this.scrollPanel.current.scrollToToken(e,t,a)}scrollToEventIfNeeded(e){const t=this.getNodeForEventId(e);t&&t.scrollIntoView({block:"nearest",behavior:"instant"})}get showHiddenEvents(){var e,t;return null!==(e=null===(t=this.context)||void 0===t?void 0:t.showHiddenEvents)&&void 0!==e?e:this._showHiddenEvents}shouldShowEvent(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.props.hideThreadedMessages&&this.props.room){const{shouldLiveInRoom:t}=this.props.room.eventShouldLiveIn(e,this.props.events);if(!t)return!1}return!E.a.get().isUserIgnored(e.getSender())&&(!(!this.showHiddenEvents||t)||!!Object(oe.c)(e,this.showHiddenEvents)&&(this.props.highlightedEventId===e.getId()||!Object(v.a)(e,this.context)))}readMarkerForEvent(e,t){const a=!t&&this.props.readMarkerVisible;if(this.props.readMarkerEventId===e){let t;return a&&(t=o.a.createElement("hr",{className:"mx_RoomView_myReadMarker",style:{opacity:1,width:"99%"}})),o.a.createElement("li",{key:"readMarker_"+e,ref:this.readMarkerNode,className:"mx_RoomView_myReadMarker_container","data-scroll-tokens":e},t)}if(this.state.ghostReadMarkers.includes(e)){const t=o.a.createElement("hr",{className:"mx_RoomView_myReadMarker",ref:this.collectGhostReadMarker,onTransitionEnd:this.onGhostTransitionEnd,"data-eventid":e});return o.a.createElement("li",{key:"_readuptoghost_"+e,className:"mx_RoomView_myReadMarker_container"},t)}return null}getNextEventInfo(e,t){const a=t<e.length-1?e[t+1]:null,n=function(e,t){for(let a=e+1;a<t.length;a++){const{event:e,shouldShow:n}=t[a];if(n)return e}return null}(t,e);return{nextEventAndShouldShow:a,nextTile:n}}get pendingEditItem(){if(this.props.room)try{return localStorage.getItem(Object(re.a)(this.props.room.roomId,this.context.timelineRenderingType))}catch(e){return void u.a.error(e)}}getEventTiles(){let e;const t=this.props.events.map((e=>({event:e,shouldShow:this.shouldShowEvent(e)})));let a=-1;for(let n=t.length-1;n>=0;n--){const{event:i,shouldShow:s}=t[n];if(s&&(void 0===e&&(e=i),!i.status)){a=n;break}}const n=[];let i=null;this.readReceiptsByEvent=new Map,this.props.showReadReceipts&&(this.readReceiptsByEvent=this.getReadReceiptsByShownEvent(t));let s=null;for(let o=0;o<t.length;o++){const r=t[o],{event:l,shouldShow:c}=r,d=l.getId(),m=l===e,{nextEventAndShouldShow:h,nextTile:u}=this.getNextEventInfo(t,o);if(s){if(s.shouldGroup(r)){s.add(r);continue}n.push(...s.getTiles()),i=s.getNewPrevEvent(),s=null}for(const t of fe)if(t.canStartGroup(this,r)&&!this.props.disableGrouping){s=new t(this,r,i,e,h,u);break}if(!s){c&&(n.push(...this.getTilesForEvent(i,l,m,!1,h,u)),i=l);const e=this.readMarkerForEvent(d,o>=a);e&&n.push(e)}}return s&&n.push(...s.getTiles()),n}getTilesForEvent(e,t){var a,n;let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const c=[],d=(null===(a=this.props.editState)||void 0===a?void 0:a.getEvent().getId())===t.getId();let m=t.getTs(),u=t.getDate();t.status&&(u=new Date,m=u.getTime());const p=this.wantsDateSeparator(e,u);if(p&&!s&&this.props.room){const e=o.a.createElement("li",{key:m},o.a.createElement(te.a,{key:m,roomId:this.props.room.roomId,ts:m}));c.push(e)}let g=!0;if(l){const e=l;g=this.wantsDateSeparator(t,e.getDate()||new Date)||t.getSender()!==e.getSender()||Object(se.a)(e,this.showHiddenEvents).isInfoMessage||!ue(t,e,this.showHiddenEvents,this.context.timelineRenderingType)}const b=!p&&ue(e,t,this.showHiddenEvents,this.context.timelineRenderingType),v=t.getId(),f=v===this.props.highlightedEventId,y=this.readReceiptsByEvent.get(v);let _=!1;const S=e=>!e||e===h.a.SENT,w=S(t.getAssociatedStatus()),C=null==r?void 0:r.shouldShow;(!C&&w||C&&w&&!S(r.event.getAssociatedStatus()))&&(_=!0),l&&l!==(null==r?void 0:r.event)&&S(l.getAssociatedStatus())&&(_=!1),_=_&&t.getSender()===E.a.get().getUserId();const x=this.props.callEventGroupers.get(t.getContent().call_id);return c.push(o.a.createElement(O.b,{key:t.getTxnId()||v,as:"li",ref:this.collectEventTile.bind(this,v),alwaysShowTimestamps:this.props.alwaysShowTimestamps,mxEvent:t,continuation:b,isRedacted:t.isRedacted(),replacingEventId:t.replacingEventId(),editState:d?this.props.editState:void 0,onHeightChanged:this.onHeightChanged,readReceipts:y,readReceiptMap:this.readReceiptMap,showUrlPreview:this.props.showUrlPreview,checkUnmounting:this.isUnmounting,eventSendStatus:null!==(n=t.getAssociatedStatus())&&void 0!==n?n:void 0,isTwelveHour:this.props.isTwelveHour,permalinkCreator:this.props.permalinkCreator,last:i,lastInSection:g,lastSuccessful:_,isSelectedEvent:f,getRelationsForEvent:this.props.getRelationsForEvent,showReactions:this.props.showReactions,layout:this.props.layout,singleSideBubbles:this.props.singleSideBubbles,youtubeEmbedPlayer:this.props.youtubeEmbedPlayer,userNameColorMode:this.props.userNameColorMode,showReadReceipts:this.props.showReadReceipts,callEventGrouper:x,hideSender:this.state.hideSender})),c}wantsDateSeparator(e,t){return this.context.timelineRenderingType!==_.a.ThreadsList&&(null==e?!this.props.canBackPaginate:Object(f.p)(e.getDate()||void 0,t))}getReadReceiptsForEvent(e){const t=E.a.get().credentials.userId,{room:a}=this.props;if(!a)return null;const n=this.context.threadId?a.getThread(this.context.threadId):a,i=[];return n?(n.getReceiptsForEvent(e).forEach((e=>{if(!e.userId||!Object(b.w)(e.type)||e.userId===t)return;if(E.a.get().isUserIgnored(e.userId))return;const n=a.getMember(e.userId);i.push({userId:e.userId,roomMember:n,ts:e.data?e.data.ts:0})})),i):(u.a.debug("Discarding request, could not find the receiptDestination for event: "+this.context.threadId),i)}getReadReceiptsByShownEvent(e){const t=new Map,a=new Map;let n;for(const e of this.props.events){if(this.shouldShowEvent(e)&&(n=e.getId()),!n)continue;const i=t.get(n)||[],s=this.getReadReceiptsForEvent(e);t.set(n,i.concat(s));for(const e of s)a.set(e.userId,{lastShownEventId:n,receipt:e})}for(const e of this.readReceiptsByUserId.keys()){if(a.get(e))continue;const{lastShownEventId:n,receipt:i}=this.readReceiptsByUserId.get(e),s=t.get(n)||[];t.set(n,s.concat(i)),a.set(e,{lastShownEventId:n,receipt:i})}this.readReceiptsByUserId=a;for(const e of t.values())e.sort(((e,t)=>t.ts-e.ts));return t}updateTimelineMinHeight(){const e=this.scrollPanel.current;if(e){const t=e.isAtBottom(),a=this.whoIsTyping.current,n=a&&a.isVisible();t&&n&&e.preventShrinking()}}onTimelineReset(){const e=this.scrollPanel.current;e&&e.clearPreventShrinking()}render(){let e,t;this.props.backPaginating&&(e=o.a.createElement("li",{key:"_topSpinner"},o.a.createElement(ne.a,null))),this.props.forwardPaginating&&(t=o.a.createElement("li",{key:"_bottomSpinner"},o.a.createElement(ne.a,null)));const a=this.props.hidden?{display:"none"}:{};let n,i;var s,r;(this.props.room&&this.state.showTypingNotifications&&this.context.timelineRenderingType===_.a.Room&&(n=o.a.createElement(B,{room:this.props.room,onShown:this.onTypingShown,onHidden:this.onTypingHidden,ref:this.whoIsTyping})),this.props.layout==S.a.IRC)&&(i=o.a.createElement(k,{minWidth:20,maxWidth:600,roomId:null!==(s=null===(r=this.props.room)||void 0===r?void 0:r.roomId)&&void 0!==s?s:null}));const l=d()(this.props.className,{mx_MessagePanel_narrow:this.context.narrow});return o.a.createElement(ae.a,null,o.a.createElement(V.a,{ref:this.scrollPanel,className:l,onScroll:this.props.onScroll,onFillRequest:this.props.onFillRequest,onUnfillRequest:this.props.onUnfillRequest,style:a,stickyBottom:this.props.stickyBottom,resizeNotifier:this.props.resizeNotifier,fixedChildren:i},e,this.getEventTiles(),n,t))}}i()(pe,"contextType",_.b),i()(pe,"defaultProps",{disableGrouping:!1});class ge{constructor(e,t,a,n,s,o){this.panel=e,this.firstEventAndShouldShow=t,this.prevEvent=a,this.lastShownEvent=n,this.nextEvent=s,this.nextEventTile=o,i()(this,"events",[]),i()(this,"ejectedEvents",[]),i()(this,"readMarker",void 0),this.readMarker=e.readMarkerForEvent(t.event.getId(),t.event===n)}}i()(ge,"canStartGroup",((e,t)=>!0));class be extends ge{shouldGroup(e){let{event:t,shouldShow:a}=e;const n=this.panel,i=this.firstEventAndShouldShow.event;if(!a)return!0;if(n.wantsDateSeparator(this.firstEventAndShouldShow.event,t.getDate()))return!1;const s=t.getType();return(s!==m.b.RoomMember||t.getStateKey()===i.getSender()&&"join"===t.getContent().membership)&&(!g.b.matches(s)&&(ce.g!==s&&!(!t.isState()||t.getSender()!==i.getSender())))}add(e){let{event:t,shouldShow:a}=e;const n=this.panel;this.readMarker=this.readMarker||n.readMarkerForEvent(t.getId(),t===this.lastShownEvent),a&&(t.getType()===m.b.RoomEncryption?this.ejectedEvents.push(t):this.events.push(t))}getTiles(){var e,t;if(!this.events||!this.events.length)return[];const a=this.panel,n=[],i=this.firstEventAndShouldShow,s=this.lastShownEvent;if(a.wantsDateSeparator(this.prevEvent,i.event.getDate())){const e=i.event.getTs();n.push(o.a.createElement("li",{key:e+"~"},o.a.createElement(te.a,{roomId:i.event.getRoomId(),ts:e})))}i.shouldShow&&n.push(...a.getTilesForEvent(i.event,i.event));for(const e of this.ejectedEvents)n.push(...a.getTilesForEvent(i.event,e,i.event===s,true));const r=this.events.map((e=>a.getTilesForEvent(e,e,e===s,true))).reduce(((e,t)=>e.concat(t)),[]),l=this.events[this.events.length-1];let c;const d=l.getRoomId(),m=null!==(e=null===(t=l.sender)||void 0===t?void 0:t.name)&&void 0!==e?e:l.getSender();return c=d&&R.a.shared().getUserIdForRoomId(d)?Object(w.b)("%(creator)s created this DM.",{creator:m}):Object(w.b)("%(creator)s created and configured the room.",{creator:m}),n.push(o.a.createElement(I.a,{key:"newroomintro"})),n.push(o.a.createElement(K,{key:"roomcreationsummary",events:this.events,onToggle:a.onHeightChanged,summaryMembers:[l.sender],summaryText:c,layout:this.panel.props.layout},r)),this.readMarker&&n.push(this.readMarker),n}getNewPrevEvent(){return this.firstEventAndShouldShow.event}}i()(be,"canStartGroup",(function(e,t){let{event:a}=t;return a.getType()===m.b.RoomCreate}));class ve extends ge{constructor(e,t,a,n,i,s){super(e,t,a,n,i,s),this.panel=e,this.firstEventAndShouldShow=t,this.prevEvent=a,this.lastShownEvent=n,this.events=[t.event]}shouldGroup(e){let{event:t,shouldShow:a}=e;return!a||!this.panel.wantsDateSeparator(this.events[0],t.getDate())&&(!(!t.isState()||!he.includes(t.getType()))||(!!t.isRedacted()||!(!this.panel.showHiddenEvents||this.panel.shouldShowEvent(t,!0))))}add(e){let{event:t,shouldShow:a}=e;(t.getType()!==m.b.RoomMember||Object(C.a)(t,this.panel.showHiddenEvents))&&(this.readMarker=this.readMarker||this.panel.readMarkerForEvent(t.getId(),t===this.lastShownEvent),(this.panel.showHiddenEvents||a)&&this.events.push(t))}generateKey(){return"eventlistsummary-"+this.events[0].getId()}getTiles(){var e;if(null===(e=this.events)||void 0===e||!e.length)return[];const t=this.panel,a=this.lastShownEvent,n=[];if(t.wantsDateSeparator(this.prevEvent,this.events[0].getDate())){const e=this.events[0].getTs();n.push(o.a.createElement("li",{key:e+"~"},o.a.createElement(te.a,{roomId:this.events[0].getRoomId(),ts:e})))}const i=this.events.find((e=>this.panel.grouperKeyMap.get(e))),s=i&&this.panel.grouperKeyMap.has(i)?this.panel.grouperKeyMap.get(i):this.generateKey();i||this.panel.grouperKeyMap.set(this.events[0],s);let r=!1,l=this.events.map(((e,n)=>(e.getId()===t.props.highlightedEventId&&(r=!0),t.getTilesForEvent(0===n?this.prevEvent:this.events[n-1],e,e===a,true,this.nextEvent,this.nextEventTile)))).reduce(((e,t)=>e.concat(t)),[]);return 0===l.length&&(l=null),this.panel.props.canBackPaginate||this.prevEvent||n.push(o.a.createElement(P,{key:"historytile"})),n.push(o.a.createElement(ee,{key:s,"data-testid":s,events:this.events,onToggle:t.onHeightChanged,startExpanded:r,layout:this.panel.props.layout},l)),this.readMarker&&n.push(this.readMarker),n}getNewPrevEvent(){return this.events[this.events.length-1]}}i()(ve,"canStartGroup",(function(e,t){let{event:a,shouldShow:n}=t;return!!n&&(!(!a.isState()||!he.includes(a.getType()))||(!!a.isRedacted()||!(!e.showHiddenEvents||e.shouldShowEvent(a,!0))))}));const fe=[be,ve]},694:function(e,t,a){"use strict";a.d(t,"b",(function(){return v})),a.d(t,"c",(function(){return f})),a.d(t,"a",(function(){return E})),a.d(t,"d",(function(){return y}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(510),l=a(990),c=a(991),d=a(1),m=a(121),h=a(129),u=a(263);function p(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function g(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?p(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):p(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var b=a(1717);let v=function(e){return e.Show="show",e}({}),f=function(e){return e[e.Loading=0]="Loading",e[e.ShowingQR=1]="ShowingQR",e[e.Connecting=2]="Connecting",e[e.Connected=3]="Connected",e[e.WaitingForDevice=4]="WaitingForDevice",e[e.Verifying=5]="Verifying",e[e.Error=6]="Error",e}({}),E=function(e){return e[e.Cancel=0]="Cancel",e[e.Decline=1]="Decline",e[e.Approve=2]="Approve",e[e.TryAgain=3]="TryAgain",e[e.Back=4]="Back",e}({});class y extends o.a.Component{constructor(e){super(e),i()(this,"approveLogin",(async()=>{if(!this.state.rendezvous)throw new Error("Rendezvous not found");this.setState({phase:f.Loading});try{d.a.info("Requesting login token");const{login_token:a}=await(e=this.props.client.requestLoginToken,t={matrixClient:this.props.client,title:Object(m.b)("Sign in new device")},async function(){for(var a=arguments.length,n=new Array(a),i=0;i<a;i++)n[i]=arguments[i];return new Promise(((a,i)=>{const s=e.bind(t.matrixClient);s(void 0,...n).then((e=>a(e))).catch((e=>{var o;if(401!==e.httpStatus||null===(o=e.data)||void 0===o||!o.flows)return i(e);h.b.createDialog(u.a,g(g({},t),{},{authData:e.data,makeRequest:e=>s(e,...n),onFinished:(e,t)=>{e?a(t):i(t)}}))}))}))})();this.setState({phase:f.WaitingForDevice});if(!await this.state.rendezvous.approveLoginOnExistingDevice(a))return;if(!this.props.client.crypto)return void this.props.onFinished(!0);this.setState({phase:f.Verifying}),await this.state.rendezvous.verifyNewDeviceOnExistingDevice(),this.props.onFinished(!0)}catch(e){d.a.error("Error whilst approving sign in",e),this.setState({phase:f.Error,failureReason:r.c.Unknown})}var e,t})),i()(this,"generateCode",(async()=>{let e;try{const t=new l.a({onFailure:this.onFailure,client:this.props.client}),a=new c.a(t,void 0,this.onFailure);e=new r.a(a,this.props.client,this.onFailure),await e.generateCode(),this.setState({phase:f.ShowingQR,rendezvous:e,failureReason:void 0})}catch(e){return d.a.error("Error whilst generating QR code",e),void this.setState({phase:f.Error,failureReason:r.c.HomeserverLacksSupport})}try{const t=await e.startAfterShowingCode();this.setState({phase:f.Connected,confirmationDigits:t})}catch(e){d.a.error("Error whilst doing QR login",e),this.state.phase!==f.Error&&this.setState({phase:f.Error,failureReason:r.c.Unknown})}})),i()(this,"onFailure",(e=>{d.a.info(`Rendezvous failed: ${e}`),this.setState({phase:f.Error,failureReason:e})})),i()(this,"onClick",(async e=>{var t,a,n;switch(e){case E.Cancel:await(null===(t=this.state.rendezvous)||void 0===t?void 0:t.cancel(r.c.UserCancelled)),this.reset(),this.props.onFinished(!1);break;case E.Approve:await this.approveLogin();break;case E.Decline:await(null===(a=this.state.rendezvous)||void 0===a?void 0:a.declineLoginOnExistingDevice()),this.reset(),this.props.onFinished(!1);break;case E.TryAgain:this.reset(),await this.updateMode(this.props.mode);break;case E.Back:await(null===(n=this.state.rendezvous)||void 0===n?void 0:n.cancel(r.c.UserCancelled)),this.props.onFinished(!1)}})),this.state={phase:f.Loading}}componentDidMount(){this.updateMode(this.props.mode).then((()=>{}))}componentDidUpdate(e){e.mode!==this.props.mode&&this.updateMode(this.props.mode).then((()=>{}))}async updateMode(e){if(this.setState({phase:f.Loading}),this.state.rendezvous){const e=this.state.rendezvous;e.onFailure=void 0,await e.cancel(r.c.UserCancelled),this.setState({rendezvous:void 0})}e===v.Show&&await this.generateCode()}componentWillUnmount(){this.state.rendezvous&&(this.state.rendezvous.onFailure=void 0,this.state.rendezvous.cancel(r.c.UserCancelled).then((()=>{})))}reset(){this.setState({rendezvous:void 0,confirmationDigits:void 0,failureReason:void 0})}render(){var e;return o.a.createElement(b.a,{onClick:this.onClick,phase:this.state.phase,code:this.state.phase===f.ShowingQR?null===(e=this.state.rendezvous)||void 0===e?void 0:e.code:void 0,confirmationDigits:this.state.phase===f.Connected?this.state.confirmationDigits:void 0,failureReason:this.state.phase===f.Error?this.state.failureReason:void 0})}}},695:function(e,t,a){"use strict";var n=a(120),i=a.n(n),s=a(244),o=a(949),r=a(122),l=a.n(r),c=a(172),d=a(437),m=a(533),h=a(1),u=a(123),p=a(472);class g extends i.a.PureComponent{render(){return i.a.createElement(p.a,{data:[{data:this.props.qrCodeData.getBuffer(),mode:"byte"}],className:"mx_VerificationQRCode",width:196})}}var b=a(121),v=a(132),f=a(272),E=a(135),y=a(124),_=a(950);class S extends i.a.PureComponent{constructor(e){super(e),l()(this,"hasVerifier",void 0),l()(this,"onReciprocateYesClick",(()=>{var e;this.state.reciprocateQREvent&&(this.setState({reciprocateButtonClicked:!0}),null===(e=this.state.reciprocateQREvent)||void 0===e||e.confirm())})),l()(this,"onReciprocateNoClick",(()=>{var e;this.state.reciprocateQREvent&&(this.setState({reciprocateButtonClicked:!0}),null===(e=this.state.reciprocateQREvent)||void 0===e||e.cancel())})),l()(this,"startSAS",(async()=>{this.setState({emojiButtonClicked:!0});const e=this.props.request.beginKeyVerification(c.e.SAS);try{await e.verify()}catch(e){h.a.error(e)}})),l()(this,"onSasMatchesClick",(()=>{var e;null===(e=this.state.sasEvent)||void 0===e||e.confirm()})),l()(this,"onSasMismatchesClick",(()=>{var e;null===(e=this.state.sasEvent)||void 0===e||e.mismatch()})),l()(this,"updateVerifierState",(()=>{var e,t;const{request:a}=this.props,n=a.verifier.sasEvent,i=a.verifier.reciprocateQREvent;null===(e=a.verifier)||void 0===e||e.off(m.b.ShowSas,this.updateVerifierState),null===(t=a.verifier)||void 0===t||t.off(d.b.ShowReciprocateQr,this.updateVerifierState),this.setState({sasEvent:n,reciprocateQREvent:i})})),l()(this,"onRequestChange",(async()=>{const{request:e}=this.props,t=this.hasVerifier;if(this.hasVerifier=!!e.verifier,!t&&this.hasVerifier){var a,n;null===(a=e.verifier)||void 0===a||a.on(m.b.ShowSas,this.updateVerifierState),null===(n=e.verifier)||void 0===n||n.on(d.b.ShowReciprocateQr,this.updateVerifierState);try{var i;await(null===(i=e.verifier)||void 0===i?void 0:i.verify())}catch(e){h.a.error("error verify",e)}}})),this.state={},this.hasVerifier=!1}renderQRPhase(){const{member:e,request:t}=this.props,a=t.otherPartySupportsMethod(c.e.SAS),n=t.otherPartySupportsMethod(d.d),s=v.b.get().brand,o=a||n?null:i.a.createElement("p",null,Object(b.b)("The device you are trying to verify doesn't support scanning a QR code or emoji verification, which is what %(brand)s supports. Try with a different client.",{brand:s}));if("dialog"===this.props.layout){let e,s;n&&t.qrCodeData&&(e=i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},i.a.createElement("p",null,Object(b.b)("Scan this unique code")),i.a.createElement(g,{qrCodeData:t.qrCodeData}))),a&&(s=i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},i.a.createElement("p",null,Object(b.b)("Compare unique emoji")),i.a.createElement("span",{className:"mx_VerificationPanel_QRPhase_helpText"},Object(b.b)("Compare a unique set of emoji if you don't have a camera on either device")),i.a.createElement(y.a,{disabled:this.state.emojiButtonClicked,onClick:this.startSAS,kind:"primary"},Object(b.b)("Start"))));const r=e&&s?i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_betweenText"},Object(b.b)("%(qrCode)s or %(emojiCompare)s",{emojiCompare:"",qrCode:""})):null;return i.a.createElement("div",null,Object(b.b)("Verify this device by completing one of the following:"),i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOptions"},e,r,s,o))}let r,l;if(n&&t.qrCodeData&&(r=i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(b.b)("Verify by scanning")),i.a.createElement("p",null,Object(b.b)("Ask %(displayName)s to scan your code:",{displayName:e.displayName||e.name||e.userId})),i.a.createElement("div",{className:"mx_VerificationPanel_qrCode"},i.a.createElement(g,{qrCodeData:t.qrCodeData})))),a){const e=this.state.emojiButtonClicked,t=n?Object(b.b)("If you can't scan the code above, verify by comparing unique emoji."):Object(b.b)("Verify by comparing unique emoji.");l=i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(b.b)("Verify by emoji")),i.a.createElement("p",null,t),i.a.createElement(y.a,{disabled:e,kind:"primary",className:"mx_UserInfo_wideButton mx_VerificationPanel_verifyByEmojiButton",onClick:this.startSAS},Object(b.b)("Verify by emoji")))}const m=o?i.a.createElement("div",{className:"mx_UserInfo_container"},o):null;return i.a.createElement(i.a.Fragment,null,r,l,m)}getDevice(){const e=this.props.request&&this.props.request.channel.deviceId,t=u.a.get().getUserId();return e&&t?u.a.get().getStoredDevice(t,e):null}renderQRReciprocatePhase(){const{member:e,request:t}=this.props,a=t.isSelfVerification?Object(b.b)("Almost there! Is your other device showing the same shield?"):Object(b.b)("Almost there! Is %(displayName)s showing the same shield?",{displayName:e.displayName||e.name||e.userId});let n;return n=this.state.reciprocateQREvent?i.a.createElement(i.a.Fragment,null,i.a.createElement("p",null,a),i.a.createElement(f.b,{isUser:!0,status:f.a.Verified,size:128,hideTooltip:!0}),i.a.createElement("div",{className:"mx_VerificationPanel_reciprocateButtons"},i.a.createElement(y.a,{kind:"danger",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateNoClick},Object(b.b)("No")),i.a.createElement(y.a,{kind:"primary",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateYesClick},Object(b.b)("Yes")))):i.a.createElement("p",null,i.a.createElement(E.a,null)),i.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_reciprocate_section"},i.a.createElement("h3",null,Object(b.b)("Verify by scanning")),n)}renderVerifiedPhase(){const{member:e,request:t}=this.props;let a,n;if(t.isSelfVerification||(a=this.props.isRoomEncrypted?Object(b.b)("Verify all users in a room to ensure it's secure."):Object(b.b)("In encrypted rooms, verify all users to ensure it's secure.")),t.isSelfVerification){const e=this.getDevice();e?n=Object(b.b)("You've successfully verified %(deviceName)s (%(deviceId)s)!",{deviceName:e?e.getDisplayName():"",deviceId:this.props.request.channel.deviceId}):(h.a.warn("Verified device we don't know about: "+this.props.request.channel.deviceId),n=Object(b.b)("You've successfully verified your device!"))}else n=Object(b.b)("You've successfully verified %(displayName)s!",{displayName:e.displayName||e.name||e.userId});return i.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_verified_section"},i.a.createElement("p",null,n),i.a.createElement(f.b,{isUser:!0,status:f.a.Verified,size:128,hideTooltip:!0}),a?i.a.createElement("p",null,a):null,i.a.createElement(y.a,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(b.b)("Got it")))}renderCancelledPhase(){const{member:e,request:t}=this.props;let a,n;return a=t.isSelfVerification?Object(b.b)("Start verification again from the notification."):Object(b.b)("Start verification again from their profile."),"m.timeout"===t.cancellationCode?n=Object(b.b)("Verification timed out.")+` ${a}`:t.cancellingUserId===t.otherUserId?(n=t.isSelfVerification?Object(b.b)("You cancelled verification on your other device."):Object(b.b)("%(displayName)s cancelled verification.",{displayName:e.displayName||e.name||e.userId}),n=`${n} ${a}`):n=Object(b.b)("You cancelled verification.")+` ${a}`,i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(b.b)("Verification cancelled")),i.a.createElement("p",null,n),i.a.createElement(y.a,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(b.b)("Got it")))}render(){const{member:e,phase:t,request:a}=this.props,n=e.displayName||e.name||e.userId;switch(t){case s.g.Ready:return this.renderQRPhase();case s.g.Started:switch(a.chosenMethod){case c.e.RECIPROCATE_QR_CODE:return this.renderQRReciprocatePhase();case c.e.SAS:{var o;const e=this.state.sasEvent?i.a.createElement(_.a,{displayName:n,device:null!==(o=this.getDevice())&&void 0!==o?o:void 0,sas:this.state.sasEvent.sas,onCancel:this.onSasMismatchesClick,onDone:this.onSasMatchesClick,inDialog:this.props.inDialog,isSelf:a.isSelfVerification}):i.a.createElement(E.a,null);return i.a.createElement("div",{className:"mx_UserInfo_container"},e)}default:return null}case s.g.Done:return this.renderVerifiedPhase();case s.g.Cancelled:return this.renderCancelledPhase()}return h.a.error("VerificationPanel unhandled phase:",t),null}componentDidMount(){const{request:e}=this.props;if(e.on(s.l.Change,this.onRequestChange),e.verifier){const t=e.verifier.sasEvent,a=e.verifier.reciprocateQREvent;this.setState({sasEvent:t,reciprocateQREvent:a})}this.onRequestChange()}componentWillUnmount(){const{request:e}=this.props;e.verifier&&(e.verifier.off(m.b.ShowSas,this.updateVerifierState),e.verifier.off(d.b.ShowReciprocateQr,this.updateVerifierState)),e.off(s.l.Change,this.onRequestChange)}}var w=a(223),O=a(142),C=a(129),x=a(185),j=a(176),k=a(147);const R=["m.key_mismatch","m.user_error","m.mismatched_sas"];t.a=e=>{const{verificationRequest:t,verificationRequestPromise:r,member:l,onClose:c,layout:d,isRoomEncrypted:m}=e,[h,p]=Object(n.useState)(t),[g,v]=Object(n.useState)(!1),[f,E]=Object(n.useState)(null==h?void 0:h.phase);Object(n.useEffect)((()=>{p(t),t&&(v(!1),E(t.phase))}),[t]),Object(n.useEffect)((()=>{r&&async function(){v(!0);const e=await r;v(!1),p(e),E(null==e?void 0:e.phase)}()}),[r]);const y=Object(n.useCallback)((()=>{h&&h.cancelled&&R.includes(h.cancellationCode)?C.b.createDialog(k.a,{headerImage:a(952).default,title:Object(b.b)("Your messages are not secure"),description:i.a.createElement("div",null,Object(b.b)("One of the following may be compromised:"),i.a.createElement("ul",null,i.a.createElement("li",null,Object(b.b)("Your homeserver")),i.a.createElement("li",null,Object(b.b)("The homeserver the user you're verifying is connected to")),i.a.createElement("li",null,Object(b.b)("Yours, or the other users' internet connection")),i.a.createElement("li",null,Object(b.b)("Yours, or the other users' session")))),onFinished:c}):h&&E(h.phase)}),[c,h]);Object(O.c)(h,s.l.Change,y);const _=Object(n.useCallback)((async()=>{v(!0);const e=u.a.get();let t;try{const a=await Object(w.c)(e,l.userId);if(!a)throw new Error("Unable to create Room for verification");t=await e.requestVerificationDM(l.userId,a)}catch(e){return console.error("Error starting verification",e),v(!1),void C.b.createDialog(k.a,{headerImage:a(663).default,title:Object(b.b)("Error starting verification"),description:Object(b.b)("We were unable to start a chat with the other user.")})}p(t),E(t.phase),j.a.instance.currentCard.phase!=x.a.EncryptionPanel&&j.a.instance.pushCard({phase:x.a.EncryptionPanel,state:{member:l,verificationRequest:t}}),j.a.instance.isOpen||j.a.instance.togglePanel(null)}),[l]),I=!h&&g||!!h&&(f===s.d||f===s.f||void 0===f),T=h?h.isSelfVerification:l.userId===u.a.get().getUserId();if(!h||I){const e=!h&&g||!!h&&h.initiatedByMe;return i.a.createElement(o.b,{isRoomEncrypted:m,onStartVerification:_,member:l,isSelfVerification:T,waitingForOtherParty:I&&e,waitingForNetwork:I&&!e,inDialog:"dialog"===d})}return i.a.createElement(S,{isRoomEncrypted:m,layout:d,onClose:c,member:l,request:h,key:h.channel.transactionId,inDialog:"dialog"===d,phase:f})}},699:function(e,t,a){"use strict";a.d(t,"a",(function(){return g}));var n=a(122),i=a.n(n),s=a(134),o=a.n(s),r=a(120),l=a.n(r),c=a(180),d=a(121),m=a(167);const h=["room","component"];function u(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function p(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?u(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):u(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function g(e){let{room:t,component:a}=e,n=o()(e,h);const i=function(e){const t=m.a.shared().getUserIdForRoomId(e.roomId),a=e.getMembers().length>2;if(!e.isSpaceRoom()&&t&&!a)return{details:t};const[n,i,...s]=c.a.instance.getKnownParents(e.roomId);if(i&&(null==s||!s.length)){var o,r;const t=null===(o=e.client.getRoom(n))||void 0===o?void 0:o.name,a=null===(r=e.client.getRoom(i))||void 0===r?void 0:r.name;return{details:Object(d.b)("%(space1Name)s and %(space2Name)s",{space1Name:t,space2Name:a}),ariaLabel:Object(d.b)("In spaces %(space1Name)s and %(space2Name)s.",{space1Name:t,space2Name:a})}}if(n){var l;const t=null===(l=e.client.getRoom(n))||void 0===l?void 0:l.name,a=s.length;return{details:Object(d.b)("%(spaceName)s and %(count)s others",{spaceName:t,count:a}),ariaLabel:Object(d.b)("In %(spaceName)s and %(count)s other spaces.",{spaceName:t,count:a})}}return{details:e.getCanonicalAlias()}}(t);return i?l.a.createElement(null!=a?a:"div",p(p({},n),{},{"aria-label":i.ariaLabel}),[i.details]):l.a.createElement(l.a.Fragment,null)}},700:function(e,t,a){"use strict";a.d(t,"a",(function(){return N})),a.d(t,"b",(function(){return P}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(1),l=a(136),c=a(337),d=a(988),m=a(129),h=a(121),u=a(132),p=a(965),g=a(204),b=a(500),v=a(362),f=a(141),E=a(137),y=a(148);var _=e=>{let{onFinished:t}=e;const[a,n]=Object(s.useState)(""),i=Object(s.useRef)(null),o=async e=>{if(e.preventDefault(),i.current){if(a){if(!await i.current.validate({}))return i.current.focus(),void i.current.validate({focused:!0})}t(!0,a)}};return s.createElement(E.a,{title:Object(h.b)("Continuing without email"),className:"mx_RegistrationEmailPromptDialog",contentId:"mx_RegistrationEmailPromptDialog",onFinished:()=>t(!1),fixedWidth:!1},s.createElement("div",{className:"mx_Dialog_content",id:"mx_RegistrationEmailPromptDialog"},s.createElement("p",null,Object(h.b)("Just a heads up, if you don't add an email and forget your password, you could <b>permanently lose access to your account</b>.",{},{b:e=>s.createElement("b",null,e)})),s.createElement("form",{onSubmit:o},s.createElement(b.a,{fieldRef:i,autoFocus:!0,label:Object(h.d)("Email (optional)"),value:a,onChange:e=>{const t=e.target;n(t.value)}}))),s.createElement(y.a,{primaryButton:Object(h.b)("Continue"),onPrimaryButtonClick:o,hasCancel:!1}))},S=a(680),w=a(989),O=a(192);let C,x,j,k,R;var I=function(e){return e.Email="field_email",e.PhoneNumber="field_phone_number",e.Username="field_username",e.Password="field_password",e.PasswordConfirm="field_password_confirm",e}(I||{}),T=function(e){return e[e.Unknown=0]="Unknown",e[e.Available=1]="Available",e[e.Unavailable=2]="Unavailable",e[e.Error=3]="Error",e[e.Invalid=4]="Invalid",e}(T||{});const N=3;C=I.Email,x=I.Password,j=I.PasswordConfirm,k=I.Username,R=I.PhoneNumber;class P extends o.a.PureComponent{constructor(e){super(e),i()(this,C,void 0),i()(this,x,void 0),i()(this,j,void 0),i()(this,k,void 0),i()(this,R,void 0),i()(this,"onSubmit",(async e=>{if(e.preventDefault(),e.persist(),!this.props.canSubmit)return;if(await this.verifyFieldsBeforeSubmit())if(""===this.state.email){if(!this.showEmail())return void this.doSubmit(e);m.b.createDialog(_,{onFinished:async(t,a)=>{t&&void 0!==a&&this.setState({email:a},(()=>{this.doSubmit(e)}))}})}else this.doSubmit(e)})),i()(this,"onEmailChange",(e=>{this.setState({email:e.target.value.trim()})})),i()(this,"onEmailValidate",(e=>{this.markFieldValid(I.Email,!!e.valid)})),i()(this,"validateEmailRules",Object(g.a)({description:()=>Object(h.b)("Use an email address to recover your account"),hideDescriptionIfValid:!0,rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!this.authStepIsRequired("m.login.email.identity")||!!t},invalid:()=>Object(h.b)("Enter email address (required on this homeserver)")},{key:"email",test:e=>{let{value:t}=e;return!t||c.a(t)},invalid:()=>Object(h.b)("Doesn't look like a valid email address")}]})),i()(this,"onPasswordChange",(e=>{this.setState({password:e.target.value})})),i()(this,"onPasswordValidate",(e=>{this.markFieldValid(I.Password,!!e.valid)})),i()(this,"onPasswordConfirmChange",(e=>{this.setState({passwordConfirm:e.target.value})})),i()(this,"onPasswordConfirmValidate",(e=>{this.markFieldValid(I.PasswordConfirm,!!e.valid)})),i()(this,"onPhoneCountryChange",(e=>{this.setState({phoneCountry:e.iso2})})),i()(this,"onPhoneNumberChange",(e=>{this.setState({phoneNumber:e.target.value})})),i()(this,"onPhoneNumberValidate",(async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(I.PhoneNumber,!!t.valid),t})),i()(this,"validatePhoneNumberRules",Object(g.a)({description:()=>Object(h.b)("Other users can invite you to rooms using your contact details"),hideDescriptionIfValid:!0,rules:[{key:"required",test(e){let{value:t,allowEmpty:a}=e;return a||!this.authStepIsRequired("m.login.msisdn")||!!t},invalid:()=>Object(h.b)("Enter phone number (required on this homeserver)")},{key:"email",test:e=>{let{value:t}=e;return!t||Object(d.c)(t)},invalid:()=>Object(h.b)("That phone number doesn't look quite right, please check and try again")}]})),i()(this,"onUsernameChange",(e=>{this.setState({username:e.target.value})})),i()(this,"onUsernameValidate",(async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(I.Username,!!t.valid),t})),i()(this,"validateUsernameRules",Object(g.a)({description:(e,t)=>t.every((e=>{let{key:t,valid:a}=e;return"available"===t||a}))?null:Object(h.b)("Use lowercase letters, numbers, dashes and underscores only"),hideDescriptionIfValid:!0,async deriveData(e){let{value:t}=e;if(!t)return T.Unknown;try{return await this.props.matrixClient.isUsernameAvailable(t)?T.Available:T.Unavailable}catch(e){return e instanceof l.MatrixError&&"M_INVALID_USERNAME"===e.errcode?T.Invalid:T.Error}},rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(h.b)("Enter username")},{key:"safeLocalpart",test:(e,t)=>{let{value:a}=e;return(!a||p.a.test(a))&&t!==T.Invalid},invalid:()=>Object(h.b)("Some characters not allowed")},{key:"available",final:!0,test:async(e,t)=>{let{value:a}=e;return!a||t===T.Available},invalid:e=>e===T.Error?Object(h.b)("Unable to check if username has been taken. Try again later."):Object(h.b)("Someone already has that username. Try another or if it is you, sign in below.")}]})),this.state={fieldValid:{},phoneCountry:this.props.defaultPhoneCountry,username:this.props.defaultUsername||"",email:this.props.defaultEmail||"",phoneNumber:this.props.defaultPhoneNumber||"",password:this.props.defaultPassword||"",passwordConfirm:this.props.defaultPassword||""}}doSubmit(e){O.a.instance.setAuthenticationType("Password");const t=this.state.email.trim(),a=this.props.onRegisterClick({username:this.state.username.trim(),password:this.state.password.trim(),email:t,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber});a&&(e.target.disabled=!0,a.finally((function(){e.target.disabled=!1})))}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[I.Username,I.Password,I.PasswordConfirm,I.Email,I.PhoneNumber];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise((e=>this.setState({},e))),this.allFieldsValid())return!0;const a=this.findFirstInvalidField(t);return!a||(a.focus(),a.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){return Object.values(this.state.fieldValid).every(Boolean)}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:a}=this.state;a[e]=t,this.setState({fieldValid:a})}authStepIsRequired(e){return this.props.flows.every((t=>t.stages.includes(e)))}authStepIsUsed(e){return this.props.flows.some((t=>t.stages.includes(e)))}showEmail(){return!!this.authStepIsUsed("m.login.email.identity")}showPhoneNumber(){return!(u.b.get().disable_3pid_login||!this.authStepIsUsed("m.login.msisdn"))}renderEmail(){if(!this.showEmail())return null;const e=this.authStepIsRequired("m.login.email.identity")?Object(h.d)("Email"):Object(h.d)("Email (optional)");return o.a.createElement(b.a,{fieldRef:e=>this[I.Email]=e,label:e,value:this.state.email,validationRules:this.validateEmailRules.bind(this),onChange:this.onEmailChange,onValidate:this.onEmailValidate})}renderPassword(){return o.a.createElement(v.a,{id:"mx_RegistrationForm_password",fieldRef:e=>this[I.Password]=e,minScore:N,value:this.state.password,onChange:this.onPasswordChange,onValidate:this.onPasswordValidate})}renderPasswordConfirm(){return o.a.createElement(w.a,{id:"mx_RegistrationForm_passwordConfirm",fieldRef:e=>this[I.PasswordConfirm]=e,autoComplete:"new-password",value:this.state.passwordConfirm,password:this.state.password,onChange:this.onPasswordConfirmChange,onValidate:this.onPasswordConfirmValidate})}renderPhoneNumber(){if(!this.showPhoneNumber())return null;const e=this.authStepIsRequired("m.login.msisdn")?Object(h.b)("Phone"):Object(h.b)("Phone (optional)"),t=o.a.createElement(S.a,{value:this.state.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChange});return o.a.createElement(f.a,{ref:e=>this[I.PhoneNumber]=e,type:"text",label:e,value:this.state.phoneNumber,prefixComponent:t,onChange:this.onPhoneNumberChange,onValidate:this.onPhoneNumberValidate})}renderUsername(){return o.a.createElement(f.a,{id:"mx_RegistrationForm_username",ref:e=>this[I.Username]=e,type:"text",autoFocus:!0,label:Object(h.b)("Username"),placeholder:Object(h.b)("Username").toLocaleLowerCase(),value:this.state.username,onChange:this.onUsernameChange,onValidate:this.onUsernameValidate})}render(){const e=o.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(h.b)("Register"),disabled:!this.props.canSubmit});let t;return this.showEmail()&&(t=this.showPhoneNumber()?o.a.createElement("div",null,Object(h.b)("Add an email to be able to reset your password.")," ",Object(h.b)("Use email or phone to optionally be discoverable by existing contacts.")):o.a.createElement("div",null,Object(h.b)("Add an email to be able to reset your password.")," ",Object(h.b)("Use email to optionally be discoverable by existing contacts."))),o.a.createElement("div",null,o.a.createElement("form",{onSubmit:this.onSubmit},o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderUsername()),o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword(),this.renderPasswordConfirm()),o.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderEmail(),this.renderPhoneNumber()),t,e))}}i()(P,"defaultProps",{onValidationChange:r.a.error,canSubmit:!0})},948:function(e,t,a){"use strict";a.d(t,"a",(function(){return b}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(1),l=a(121),c=a(123),d=a(129),m=a(495),h=a(496),u=a(695),p=a(124),g=a(135);class b extends o.a.Component{constructor(e){super(e),i()(this,"onStoreUpdate",(()=>{const e=h.b.sharedInstance();e.phase!==h.a.Finished?this.setState({phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo,lostKeys:e.lostKeys()}):this.props.onFinished()})),i()(this,"onUsePassphraseClick",(async()=>{h.b.sharedInstance().usePassPhrase()})),i()(this,"onVerifyClick",(()=>{var e;const t=c.a.get(),a=t.getSafeUserId(),n=t.requestVerification(a);this.props.onFinished(),d.b.createDialog(m.a,{verificationRequestPromise:n,member:null!==(e=t.getUser(a))&&void 0!==e?e:void 0,onFinished:async()=>{(await n).cancel(),this.props.onFinished()}})})),i()(this,"onSkipConfirmClick",(()=>{h.b.sharedInstance().skipConfirm()})),i()(this,"onSkipBackClick",(()=>{h.b.sharedInstance().returnAfterSkip()})),i()(this,"onResetClick",(e=>{e.preventDefault();h.b.sharedInstance().reset()})),i()(this,"onResetConfirmClick",(()=>{this.props.onFinished();h.b.sharedInstance().resetConfirm()})),i()(this,"onResetBackClick",(()=>{h.b.sharedInstance().returnAfterReset()})),i()(this,"onDoneClick",(()=>{h.b.sharedInstance().done()})),i()(this,"onEncryptionPanelClose",(()=>{this.props.onFinished()}));const t=h.b.sharedInstance();t.on("update",this.onStoreUpdate),t.start(),this.state={phase:t.phase,verificationRequest:t.verificationRequest,backupInfo:t.backupInfo,lostKeys:t.lostKeys()}}componentWillUnmount(){const e=h.b.sharedInstance();e.off("update",this.onStoreUpdate),e.stop()}render(){const e=c.a.get(),{phase:t,lostKeys:a}=this.state;if(this.state.verificationRequest&&e.getUser(this.state.verificationRequest.otherUserId))return o.a.createElement(u.a,{layout:"dialog",verificationRequest:this.state.verificationRequest,onClose:this.onEncryptionPanelClose,member:e.getUser(this.state.verificationRequest.otherUserId),isRoomEncrypted:!1});if(t===h.a.Intro){if(a)return o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("It looks like you don't have a Security Key or any other devices you can verify against.  This device will not be able to access old encrypted messages. In order to verify your identity on this device, you'll need to reset your verification keys.")),o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.a.createElement(p.a,{kind:"primary",onClick:this.onResetConfirmClick},Object(l.b)("Proceed with reset"))));{const e=h.b.sharedInstance();let t,a,i;return e.keyInfo&&(n=e.keyInfo,Boolean(n.passphrase&&n.passphrase.salt&&n.passphrase.iterations))?t=Object(l.b)("Verify with Security Key or Phrase"):e.keyInfo&&(t=Object(l.b)("Verify with Security Key")),t&&(a=o.a.createElement(p.a,{kind:"primary",onClick:this.onUsePassphraseClick},t)),e.hasDevicesToVerifyAgainst&&(i=o.a.createElement(p.a,{kind:"primary",onClick:this.onVerifyClick},Object(l.b)("Verify with another device"))),o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("Verify your identity to access encrypted messages and prove your identity to others.")),o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},i,a),o.a.createElement("div",{className:"mx_SetupEncryptionBody_reset"},Object(l.b)("Forgotten or lost all recovery methods? <a>Reset all</a>",void 0,{a:e=>o.a.createElement(p.a,{kind:"link_inline",className:"mx_SetupEncryptionBody_reset_link",onClick:this.onResetClick},e)})))}}if(t===h.a.Done){let e;return e=this.state.backupInfo?o.a.createElement("p",null,Object(l.b)("Your new device is now verified. It has access to your encrypted messages, and other users will see it as trusted.")):o.a.createElement("p",null,Object(l.b)("Your new device is now verified. Other users will see it as trusted.")),o.a.createElement("div",null,o.a.createElement("div",{className:"mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"}),e,o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.a.createElement(p.a,{kind:"primary",onClick:this.onDoneClick},Object(l.b)("Done"))))}return t===h.a.ConfirmSkip?o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("Without verifying, you won't have access to all your messages and may appear as untrusted to others.")),o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.a.createElement(p.a,{kind:"danger_outline",onClick:this.onSkipConfirmClick},Object(l.b)("I'll verify later")),o.a.createElement(p.a,{kind:"primary",onClick:this.onSkipBackClick},Object(l.b)("Go Back")))):t===h.a.ConfirmReset?o.a.createElement("div",null,o.a.createElement("p",null,Object(l.b)("Resetting your verification keys cannot be undone. After resetting, you won't have access to old encrypted messages, and any friends who have previously verified you will see security warnings until you re-verify with them.")),o.a.createElement("p",null,Object(l.b)("Please only proceed if you're sure you've lost all of your other devices and your Security Key.")),o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.a.createElement(p.a,{kind:"danger_outline",onClick:this.onResetConfirmClick},Object(l.b)("Proceed with reset")),o.a.createElement(p.a,{kind:"primary",onClick:this.onResetBackClick},Object(l.b)("Go Back")))):t===h.a.Busy||t===h.a.Loading?o.a.createElement(g.a,null):void r.a.log(`SetupEncryptionBody: Unknown phase ${t}`);var n}}},949:function(e,t,a){"use strict";a.d(t,"a",(function(){return l}));var n=a(120),i=a.n(n),s=a(121),o=a(124),r=a(135);const l=e=>{let{text:t}=e;return i.a.createElement("div",{className:"mx_EncryptionInfo_spinner"},i.a.createElement(r.a,null),t)};t.b=e=>{let t,a,{waitingForOtherParty:n,waitingForNetwork:r,member:c,onStartVerification:d,isRoomEncrypted:m,inDialog:h,isSelfVerification:u}=e;if(n&&u)t=i.a.createElement("div",null,Object(s.b)("To proceed, please accept the verification request on your other device."));else if(n||r){let e;e=n?Object(s.b)("Waiting for %(displayName)s to accept…",{displayName:c.displayName||c.name||c.userId}):Object(s.b)("Accepting…"),t=i.a.createElement(l,{text:e})}else t=i.a.createElement(o.a,{kind:"primary",className:"mx_UserInfo_wideButton mx_UserInfo_startVerification",onClick:d},Object(s.b)("Start Verification"));return a=m?i.a.createElement("div",null,i.a.createElement("p",null,Object(s.b)("Messages in this room are end-to-end encrypted.")),i.a.createElement("p",null,Object(s.b)("Your messages are secured and only you and the recipient have the unique keys to unlock them."))):i.a.createElement("div",null,i.a.createElement("p",null,Object(s.b)("Messages in this room are not end-to-end encrypted.")),i.a.createElement("p",null,Object(s.b)("In encrypted rooms, your messages are secured and only you and the recipient have the unique keys to unlock them."))),h?t:i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{"data-testid":"encryption-info-description",className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(s.b)("Encryption")),a),i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(s.b)("Verify User")),i.a.createElement("div",null,i.a.createElement("p",null,Object(s.b)("For extra security, verify this user by checking a one-time code on both of your devices.")),i.a.createElement("p",null,Object(s.b)("To be secure, do this in person or use a trusted way to communicate.")),t)))}},950:function(e,t,a){"use strict";a.d(t,"a",(function(){return m}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(121),l=a(949),c=a(124),d=a(951);class m extends o.a.Component{constructor(e){super(e),i()(this,"onMatchClick",(()=>{this.setState({pending:!0}),this.props.onDone()})),i()(this,"onDontMatchClick",(()=>{this.setState({cancelling:!0}),this.props.onCancel()})),this.state={pending:!1}}componentWillMount(){Object(d.a)()}render(){let e,t,a;if(this.props.sas.emoji){const a=this.props.sas.emoji.map(((e,t)=>{return o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_block",key:t},o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_emoji"},e[0]),o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_label"},Object(r.b)((a=e[1]).charAt(0).toUpperCase()+a.slice(1))));var a}));e=o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas"},a.slice(0,4),o.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_break"}),a.slice(4)),t=this.props.isSelf?Object(r.b)("Confirm the emoji below are displayed on both devices, in the same order:"):Object(r.b)("Verify this user by confirming the following emoji appear on their screen.")}else{if(!this.props.sas.decimal)return o.a.createElement("div",null,Object(r.b)("Unable to find a supported verification method."),o.a.createElement(c.a,{kind:"primary",onClick:this.props.onCancel},Object(r.b)("Cancel")));{const a=this.props.sas.decimal.map(((e,t)=>o.a.createElement("span",{key:t},e)));e=o.a.createElement("div",{className:"mx_VerificationShowSas_decimalSas"},a),t=this.props.isSelf?Object(r.b)("Verify this device by confirming the following number appears on its screen."):Object(r.b)("Verify this user by confirming the following number appears on their screen.")}}if(this.state.pending&&this.props.isSelf){let e;e=this.props.device?Object(r.b)("Waiting for you to verify on your other device, %(deviceName)s (%(deviceId)s)…",{deviceName:this.props.device?this.props.device.getDisplayName():"",deviceId:this.props.device?this.props.device.deviceId:""}):Object(r.b)("Waiting for you to verify on your other device…"),a=o.a.createElement("p",null,e)}else if(this.state.pending||this.state.cancelling){let e;if(this.state.pending){const{displayName:t}=this.props;e=Object(r.b)("Waiting for %(displayName)s to verify…",{displayName:t})}else e=Object(r.b)("Cancelling…");a=o.a.createElement(l.a,{text:e})}else a=o.a.createElement("div",{className:"mx_VerificationShowSas_buttonRow"},o.a.createElement(c.a,{onClick:this.onDontMatchClick,kind:"danger"},Object(r.b)("They don't match")),o.a.createElement(c.a,{onClick:this.onMatchClick,kind:"primary"},Object(r.b)("They match")));return o.a.createElement("div",{className:"mx_VerificationShowSas"},o.a.createElement("p",null,t),e,o.a.createElement("p",null,this.props.isSelf?"":Object(r.b)("To be secure, do this in person or use a trusted way to communicate.")),a)}}Object(r.d)("Dog"),Object(r.d)("Cat"),Object(r.d)("Lion"),Object(r.d)("Horse"),Object(r.d)("Unicorn"),Object(r.d)("Pig"),Object(r.d)("Elephant"),Object(r.d)("Rabbit"),Object(r.d)("Panda"),Object(r.d)("Rooster"),Object(r.d)("Penguin"),Object(r.d)("Turtle"),Object(r.d)("Fish"),Object(r.d)("Octopus"),Object(r.d)("Butterfly"),Object(r.d)("Flower"),Object(r.d)("Tree"),Object(r.d)("Cactus"),Object(r.d)("Mushroom"),Object(r.d)("Globe"),Object(r.d)("Moon"),Object(r.d)("Cloud"),Object(r.d)("Fire"),Object(r.d)("Banana"),Object(r.d)("Apple"),Object(r.d)("Strawberry"),Object(r.d)("Corn"),Object(r.d)("Pizza"),Object(r.d)("Cake"),Object(r.d)("Heart"),Object(r.d)("Smiley"),Object(r.d)("Robot"),Object(r.d)("Hat"),Object(r.d)("Glasses"),Object(r.d)("Spanner"),Object(r.d)("Santa"),Object(r.d)("Thumbs up"),Object(r.d)("Umbrella"),Object(r.d)("Hourglass"),Object(r.d)("Clock"),Object(r.d)("Gift"),Object(r.d)("Light bulb"),Object(r.d)("Book"),Object(r.d)("Pencil"),Object(r.d)("Paperclip"),Object(r.d)("Scissors"),Object(r.d)("Lock"),Object(r.d)("Key"),Object(r.d)("Hammer"),Object(r.d)("Telephone"),Object(r.d)("Flag"),Object(r.d)("Train"),Object(r.d)("Bicycle"),Object(r.d)("Aeroplane"),Object(r.d)("Rocket"),Object(r.d)("Trophy"),Object(r.d)("Ball"),Object(r.d)("Guitar"),Object(r.d)("Trumpet"),Object(r.d)("Bell"),Object(r.d)("Anchor"),Object(r.d)("Headphones"),Object(r.d)("Folder"),Object(r.d)("Pin")},951:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n=a(1);async function i(){n.a.log("Checking for COLR support");const{userAgent:e}=navigator;if(e.includes("Firefox"))return n.a.log("Browser is Firefox - assuming COLR is supported"),!0;if(!e.includes("Chrome")&&e.includes("Safari"))return function(e){n.a.log("Browser is Safari - checking version for COLR support");try{const t=e.match(/Mac OS X ([\d|_]+).*Version\/([\d|.]+).*Safari/);if(t){const e=t[1],a=t[2],i=e.split("_").map((e=>parseInt(e,10))),s=a.split(".").map((e=>parseInt(e,10))),o=i[0]>=10&&i[1]>=14&&s[0]>=12;return n.a.log(`COLR support on Safari requires macOS 10.14 and Safari 12, detected Safari ${a} on macOS ${e}, COLR supported: ${o}`),o}}catch(e){n.a.error("Error in Safari COLR version check",e)}return n.a.warn("Couldn't determine Safari version to check COLR font support, assuming no."),!1}(e);try{const e=document.createElement("canvas"),t=e.getContext("2d"),a=new Image,i=`\n        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="100" style="background:#fff;fill:#000;">\n            <style type="text/css">\n                @font-face {\n                    font-family: "chromacheck-colr";\n                    src: url(data:application/x-font-woff;base64,${"d09GRgABAAAAAAKAAAwAAAAAAowAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABDT0xSAAACVAAAABYAAAAYAAIAJUNQQUwAAAJsAAAAEgAAABLJAAAQT1MvMgAAAYAAAAA6AAAAYBfxJ0pjbWFwAAABxAAAACcAAAAsAAzpM2dseWYAAAH0AAAAGgAAABoNIh0kaGVhZAAAARwAAAAvAAAANgxLumdoaGVhAAABTAAAABUAAAAkCAEEAmhtdHgAAAG8AAAABgAAAAYEAAAAbG9jYQAAAewAAAAGAAAABgANAABtYXhwAAABZAAAABsAAAAgAg4AHW5hbWUAAAIQAAAAOAAAAD4C5wsecG9zdAAAAkgAAAAMAAAAIAADAAB4AWNgZGAAYQ5+qdB4fpuvDNIsDCBwaQGTAIi+VlscBaJZGMDiHAxMIAoAtjIF/QB4AWNgZGBgYQACOAkUQQWMAAGRABAAAAB4AWNgZGBgYGJgAdMMUJILJMQgAWICAAH3AC4AeAFjYGFhYJzAwMrAwDST6QwDA0M/hGZ8zWDMyMmAChgFkDgKQMBw4CXDSwYWEBdIYgAFBgYA/8sIdAAABAAAAAAAAAB4AWNgYGBkYAZiBgYeBhYGBSDNAoRA/kuG//8hpDgjWJ4BAFVMBiYAAAAAAAANAAAAAQAAAAAEAAQAAAMAABEhESEEAPwABAD8AAAAeAEtxgUNgAAAAMHHIQTShTlOAty9/4bf7AARCwlBNhBw4L/43qXjYGUmf19TMuLcj/BJL3XfBg54AWNgZsALAAB9AAR4AWNgYGAEYj4gFgGygGwICQACOwAoAAAAAAABAAEAAQAAAA4AAAAAyP8AAA=="}) format("woff");\n                }\n            </style>\n            <text x="0" y="0" font-size="20">\n                <tspan font-family="chromacheck-colr" x="0" dy="20">&#xe900;</tspan>\n            </text>\n        </svg>`;e.width=20,e.height=100,a.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(i),n.a.log("Waiting for COLR SVG to load"),await new Promise((e=>a.onload=e)),n.a.log("Drawing canvas to detect COLR support"),t.drawImage(a,0,0);const s=200===t.getImageData(10,10,1,1).data[0];return n.a.log("Canvas check revealed COLR is supported? "+s),s}catch(e){return n.a.error("Couldn't load COLR font",e),!1}}let s=!1;async function o(){if(!s)if(s=!0,await i()){const e=`url('${a(1635)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:"600"})),document.fonts.add(new FontFace("Twemoji",e,{weight:"700"}))}else{const e=`url('${a(1636)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:"600"})),document.fonts.add(new FontFace("Twemoji",e,{weight:"700"}))}}},952:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M2 9.27V3.05L9 1l7 2.05v6.22C16 15.63 9 17 9 17s-7-1.37-7-7.73zM8.92 4.4c-.57.04-.99.54-.94 1.11l.32 4c.03.35.3.62.65.65h.06c.37 0 .68-.28.71-.65l.32-4v-.16a1.06 1.06 0 00-1.12-.95zm.96 7.72a.88.88 0 11-1.76 0 .88.88 0 011.76 0z",fill:"#020202"})))}t.default="img/e2e/warning-deprecated.6a3ebca.svg"},953:function(e,t,a){"use strict";a.d(t,"a",(function(){return m}));var n=a(120),i=a.n(n),s=a(954),o=a(665),r=a(165),l=a(121);const c=function(e){if(e+5184e5>=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:(new Date).getTime())){const t=new Date(e);return Object(r.a)(t)}return Object(r.l)(new Date(e))},d=e=>{let{value:t,id:a}=e;return t?i.a.createElement("span",{"data-testid":`device-metadata-${a}`},t):null},m=e=>{let{device:t}=e;const a=(e=>{if(Object(o.c)(e)&&e.last_seen_ts)return{id:"inactive",value:i.a.createElement(i.a.Fragment,null,i.a.createElement(s.a,{className:"mx_DeviceTile_inactiveIcon"}),Object(l.b)("Inactive for %(inactiveAgeDays)s+ days",{inactiveAgeDays:o.a})+` (${c(e.last_seen_ts)})`)}})(t),r=t.last_seen_ts&&`${Object(l.b)("Last activity")} ${c(t.last_seen_ts)}`,m=t.isVerified?Object(l.b)("Verified"):Object(l.b)("Unverified"),h=a?[a,{id:"lastSeenIp",value:t.last_seen_ip}]:[{id:"isVerified",value:m},{id:"lastActivity",value:r},{id:"lastSeenIp",value:t.last_seen_ip},{id:"deviceId",value:t.device_id}];return i.a.createElement(i.a.Fragment,null,h.map(((e,t)=>{let{id:a,value:s}=e;return s?i.a.createElement(n.Fragment,{key:a},!!t&&" · ",i.a.createElement(d,{id:a,value:s})):null})))}},954:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 8 14",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{d:"M1.333.333C.6.333 0 .933 0 1.666l.007 2.12c0 .354.14.687.386.94L2.667 7 .393 9.286a1.332 1.332 0 00-.386.94L0 12.333c0 .733.6 1.333 1.333 1.333h5.334c.733 0 1.333-.6 1.333-1.333v-2.107c0-.353-.14-.693-.387-.94L5.333 7l2.274-2.267C7.86 4.48 8 4.14 8 3.786v-2.12C8 .933 7.4.333 6.667.333H1.333zm5.334 9.94v1.393c0 .367-.3.667-.667.667H2a.669.669 0 01-.667-.667v-1.393c0-.18.074-.347.194-.473L4 7.333l2.473 2.473c.12.12.194.294.194.467z",fill:"currentColor"})))}},955:function(e,t,a){"use strict";a.d(t,"c",(function(){return s})),a.d(t,"b",(function(){return o})),a.d(t,"d",(function(){return r})),a.d(t,"a",(function(){return c}));const n="io.element.matrix_client_information.",i=e=>`${n}${e}`,s=async(e,t,a)=>{const n=e.getDeviceId(),{brand:s}=t,o=await(null==a?void 0:a.getAppVersion()),r=i(n),l=(()=>{if(window.electron)return;const e=new URL(window.location.href);return[e.host,e.pathname.replace(/\/$/,"")].join("")})();await e.setAccountData(r,{name:s,version:o,url:l})},o=(e,t)=>{Array.from(t.store.accountData.values()).forEach((a=>{if(!a.getType().startsWith(n))return;const[,i]=a.getType().split(n);i&&!e.includes(i)&&t.deleteAccountData(a.getType())}))},r=async e=>{const t=e.getDeviceId(),a=i(t),n=c(e,t);(n.name||n.version||n.url)&&await e.deleteAccountData(a)},l=e=>e&&"string"==typeof e?e:void 0,c=(e,t)=>{const a=e.getAccountData(i(t));if(!a)return{};const{name:n,version:s,url:o}=a.getContent();return{name:l(n),version:l(s),url:l(o)}}},956:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return d}));var n=a(122),i=a.n(n),s=a(17),o=a.n(s),r=a(801);function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}const c="mx_threepid_invite_";class d extends o.a{static get instance(){return d._instance||(d._instance=new d),d._instance}storeInvite(e,t){const a=function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({roomId:e},t),n=this.generateIdOf(a);return localStorage.setItem(`${c}${n}`,JSON.stringify(a)),this.translateInvite(a)}getWireInvites(){const e=[];for(let t=0;t<localStorage.length;t++){const a=localStorage.key(t);null!=a&&a.startsWith(c)&&e.push(JSON.parse(localStorage.getItem(a)))}return e}getInvites(){return this.getWireInvites().map((e=>this.translateInvite(e)))}pickBestInvite(){return this.getInvites()[0]}resolveInvite(e){localStorage.removeItem(`${c}${e.id}`)}generateIdOf(t){return r.base32.stringify(e.from(JSON.stringify(t)))}translateInvite(e){return{id:this.generateIdOf(e),roomId:e.roomId,toEmail:e.email,signUrl:e.signurl,roomName:e.room_name,roomAvatarUrl:e.room_avatar_url,inviterName:e.inviter_name}}translateToWireFormat(e){return{email:e.toEmail,signurl:e.signUrl,room_name:e.roomName,room_avatar_url:e.roomAvatarUrl,inviter_name:e.inviterName}}}i()(d,"_instance",void 0)}).call(this,a(53).Buffer)},957:function(e,t,a){"use strict";a.d(t,"a",(function(){return l}));var n=a(120),i=a.n(n),s=a(130),o=a(958),r=a(820);function l(e){var t;let{mxEvent:a,userNameColorMode:n,onClick:l,withTooltip:c}=e;const d=Object(r.a)({userId:a.getSender(),member:a.sender});return a.getContent().msgtype!==s.e.Emote?i.a.createElement(o.a,{fallbackName:null!==(t=a.getSender())&&void 0!==t?t:"",userNameColorMode:n,onClick:l,member:d,colored:!0,emphasizeDisplayName:!0,withTooltip:c}):i.a.createElement(i.a.Fragment,null)}},958:function(e,t,a){"use strict";a.d(t,"a",(function(){return m}));var n=a(120),i=a.n(n),s=a(127),o=a.n(s),r=a(121),l=a(218),c=a(267),d=a(123);class m extends i.a.Component{render(){const{fallbackName:e,userNameColorMode:t,member:a,colored:n,emphasizeDisplayName:s,withTooltip:m,onClick:h}=this.props,u=(null==a?void 0:a.rawDisplayName)||e,p=null==a?void 0:a.userId;let g,b,v;if(n&&(g=Object(l.f)(t,e,d.a.get().getRoom(null==a?void 0:a.roomId))),p){var f,E;const e=null!==(f=null===(E=c.a.getDisplayUserIdentifier)||void 0===E?void 0:E.call(c.a,p,{withDisplayName:!0,roomId:a.roomId}))&&void 0!==f?f:p;null!=a&&a.disambiguate&&(b=i.a.createElement("span",{className:"mx_DisambiguatedProfile_mxid"},e)),v=Object(r.b)("%(displayName)s (%(matrixId)s)",{displayName:u,matrixId:e})}const y=o()(g,{mx_DisambiguatedProfile_displayName:s});return i.a.createElement("div",{className:"mx_DisambiguatedProfile",title:m?v:void 0,onClick:h},i.a.createElement("span",{className:y,dir:"auto"},u),b)}}},959:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M20 1a1 1 0 00-1 1v2h-2a1 1 0 100 2h2v2a1 1 0 102 0V6h2a1 1 0 100-2h-2V2a1 1 0 00-1-1zM7 9.5C7 8.67 7.67 8 8.5 8s1.5.67 1.5 1.5S9.33 11 8.5 11 7 10.33 7 9.5zm8.5 1.5c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zM12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5zM4 12a8 8 0 019.774-7.803 1 1 0 10.442-1.95A10.03 10.03 0 0012 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10c0-.212-.007-.423-.02-.632a1 1 0 10-1.996.125A8 8 0 114 12z",fill:"currentColor"})))}},960:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n,i,s=a(120);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},o.apply(this,arguments)}function r(e){return s.createElement("svg",o({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 18",role:"presentation","aria-hidden":!0},e),n||(n=s.createElement("path",{d:"M10.066 14.25h1.57c1.858 0 3.364-1.567 3.364-3.5s-1.506-3.5-3.364-3.5H4.534",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round"})),i||(i=s.createElement("path",{d:"M6.524 3.75L3 7.286l3.524 3.535",stroke:"currentColor",strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})))}},961:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n=a(122),i=a.n(n),s=a(192);class o{constructor(e,t){this.failedEventId=e,this.errorCode=t,i()(this,"ts",void 0),this.ts=Date.now()}}class r{constructor(e,t){if(this.fn=e,this.errorCodeMapFn=t,i()(this,"failures",new Map),i()(this,"visibleEvents",new Set),i()(this,"visibleFailures",new Map),i()(this,"failureCounts",{}),i()(this,"trackedEvents",new Set),i()(this,"checkInterval",null),i()(this,"trackInterval",null),!e||"function"!=typeof e)throw new Error("DecryptionFailureTracker requires tracking function");if("function"!=typeof t)throw new Error("DecryptionFailureTracker second constructor argument should be a function")}static get instance(){return r.internalInstance}eventDecrypted(e,t){"m.megolm.v1.aes-sha2"==e.getWireContent().algorithm&&(t?this.addDecryptionFailure(new o(e.getId(),t.code)):this.removeDecryptionFailuresForEvent(e))}addVisibleEvent(e){const t=e.getId();this.trackedEvents.has(t)||(this.visibleEvents.add(t),this.failures.has(t)&&!this.visibleFailures.has(t)&&this.visibleFailures.set(t,this.failures.get(t)))}addDecryptionFailure(e){const t=e.failedEventId;this.trackedEvents.has(t)||(this.failures.set(t,e),this.visibleEvents.has(t)&&!this.visibleFailures.has(t)&&this.visibleFailures.set(t,e))}removeDecryptionFailuresForEvent(e){const t=e.getId();this.failures.delete(t),this.visibleFailures.delete(t)}start(){this.checkInterval=window.setInterval((()=>this.checkFailures(Date.now())),r.CHECK_INTERVAL_MS),this.trackInterval=window.setInterval((()=>this.trackFailures()),r.TRACK_INTERVAL_MS)}stop(){this.checkInterval&&clearInterval(this.checkInterval),this.trackInterval&&clearInterval(this.trackInterval),this.failures=new Map,this.visibleEvents=new Set,this.visibleFailures=new Map,this.failureCounts={}}checkFailures(e){const t=new Set,a=new Map;for(const[n,i]of this.visibleFailures)e>i.ts+r.GRACE_PERIOD_MS?(t.add(i),this.trackedEvents.add(n)):a.set(n,i);this.visibleFailures=a,this.aggregateFailures(t)}aggregateFailures(e){for(const t of e){const e=t.errorCode;this.failureCounts[e]=(this.failureCounts[e]||0)+1}}trackFailures(){for(const e of Object.keys(this.failureCounts))if(this.failureCounts[e]>0){const t=this.errorCodeMapFn(e);this.fn(this.failureCounts[e],t,e),this.failureCounts[e]=0}}}i()(r,"internalInstance",new r(((e,t,a)=>{for(let n=0;n<e;n++)s.a.instance.trackEvent({eventName:"Error",domain:"E2EE",name:t,context:`mxc_crypto_error_type_${a}`})}),(e=>{switch(e){case"MEGOLM_UNKNOWN_INBOUND_SESSION_ID":return"OlmKeysNotSentError";case"OLM_UNKNOWN_MESSAGE_INDEX":return"OlmIndexError";case void 0:return"OlmUnspecifiedError";default:return"UnknownError"}}))),i()(r,"TRACK_INTERVAL_MS",6e4),i()(r,"CHECK_INTERVAL_MS",5e3),i()(r,"GRACE_PERIOD_MS",4e3)},962:function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(15),l=a(121);const c=new r.c("busy","org.matrix.msc3026.busy");class d extends o.a.Component{getDuration(e){if(!e)return;const t=Math.round(e/1e3),a=t%60,n=Math.round(t/60)%60,i=Math.round(t/3600)%24,s=Math.round(t/86400);return t<60?t<0?Object(l.b)("%(duration)ss",{duration:0}):Object(l.b)("%(duration)ss",{duration:a}):t<3600?Object(l.b)("%(duration)sm",{duration:n}):t<86400?Object(l.b)("%(duration)sh",{duration:i}):Object(l.b)("%(duration)sd",{duration:s})}getPrettyPresence(e,t,a){if(e&&c.matches(e))return Object(l.b)("Busy");if(!a&&void 0!==t&&t>0){const a=this.getDuration(t);return"online"===e?Object(l.b)("Online for %(duration)s",{duration:a}):"unavailable"===e?Object(l.b)("Idle for %(duration)s",{duration:a}):"offline"===e?Object(l.b)("Offline for %(duration)s",{duration:a}):Object(l.b)("Unknown for %(duration)s",{duration:a})}return"online"===e?Object(l.b)("Online"):"unavailable"===e?Object(l.b)("Idle"):"offline"===e?Object(l.b)("Offline"):Object(l.b)("Unknown")}render(){return o.a.createElement("div",{className:"mx_PresenceLabel"},this.getPrettyPresence(this.props.presenceState,this.props.activeAgo,this.props.currentlyActive))}}i()(d,"defaultProps",{activeAgo:-1})},963:function(e,t,a){"use strict";a.r(t),a.d(t,"Icon",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("g",{fill:"none",fillRule:"evenodd"},i.createElement("path",{fill:"#ECECEC",d:"M0 0h24v24H0z"}),i.createElement("path",{d:"M7.338 13.154c.504 0 .826-.378.826-.882 0-.518-.322-.882-.826-.882-.49 0-.826.364-.826.882-.014.504.336.882.826.882zm4.662 0c.504 0 .84-.378.84-.882-.014-.518-.336-.882-.826-.882-.49 0-.84.364-.84.882-.014.504.336.882.826.882zm4.662 0c.518 0 .84-.378.84-.882 0-.518-.336-.882-.826-.882-.49 0-.84.364-.84.882 0 .504.336.882.826.882z",fill:"#424242"}))))}t.default="img/ellipsis.9575c34.svg"},964:function(e,t,a){"use strict";var n=a(120),i=a.n(n),s=a(182);t.a=e=>{let{value:t,label:a,byline:n,disabled:o,onChange:r}=e;return i.a.createElement("label",{className:"mx_LabelledCheckbox"},i.a.createElement(s.b,{disabled:o,checked:t,onChange:e=>r(e.target.checked)}),i.a.createElement("div",{className:"mx_LabelledCheckbox_labels"},i.a.createElement("span",{className:"mx_LabelledCheckbox_label"},a),n?i.a.createElement("span",{className:"mx_LabelledCheckbox_byline"},n):null))}},965:function(e,t,a){"use strict";a.d(t,"a",(function(){return h})),a.d(t,"b",(function(){return u}));var n=a(120),i=a.n(n),s=a(125),o=a(129),r=a(121),l=a(159),c=a(128),d=a(126),m=a(157);const h=/^[a-z0-9=_\-./]+$/;async function u(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=o.b.createDialog(l.a,{hasCancelButton:!0,quitOnly:!0,title:d.b.getValue(m.b.Registration)?Object(r.b)("Sign In or Create Account"):Object(r.b)("Sign In"),description:d.b.getValue(m.b.Registration)?Object(r.b)("Use your account or create a new one to continue."):Object(r.b)("Use your account to continue."),button:Object(r.b)("Sign In"),extraButtons:d.b.getValue(m.b.Registration)?[i.a.createElement("button",{key:"register",onClick:()=>{t.close(),s.a.dispatch({action:"start_registration",screenAfterLogin:e.screen_after})}},Object(r.b)("Create Account"))]:[],onFinished:t=>{t?s.a.dispatch({action:"start_login",screenAfterLogin:e.screen_after}):e.go_home_on_cancel?s.a.dispatch({action:c.a.ViewHomePage}):e.go_welcome_on_cancel&&s.a.dispatch({action:"view_welcome_page"})}})}},966:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return ue}));var n=a(131),i=a.n(n),s=a(127),o=a.n(s),r=a(150),l=a(136),c=a(16),d=a(120),m=a.n(d),h=a(460),u=a.n(h),p=a(145),g=a(170),b=a(161),v=a(128),f=a(125),E=a(1651),y=a(1652),_=a(1653),S=a(1654),w=a(1655),O=a(1656),C=a(155),x=a(121),j=a(123),k=a(192),R=a(413),I=a(236),T=a(138),N=a(126),P=a(418),D=a(222),M=a(456),A=a(154),U=a(212),L=a(180),F=a(425),B=a(167),V=a(168),W=a(748),z=a(230),H=a(195),K=a(328),G=a(929),q=a(1761),$=a(124),Y=a(964),J=a(135),Q=a(249),X=a(137),Z=a(1657),ee=a(1658),te=a(1659),ae=a(699),ne=a(1660),ie=a(224),se=a(166),oe=a(169),re=a(144);const le=50,ce=24;function de(e){var t,a;return!0===(null==e||null===(t=e.current)||void 0===t||null===(a=t.id)||void 0===a?void 0:a.startsWith("mx_SpotlightDialog_button_recentlyViewed_"))}function me(e,t){const a=new Set;return e&&a.add(null),t&&a.add(l.RoomType.Space),a}var he=function(e){return e[e.People=0]="People",e[e.Rooms=1]="Rooms",e[e.Spaces=2]="Spaces",e[e.Suggestions=3]="Suggestions",e[e.PublicRooms=4]="PublicRooms",e}(he||{});let ue=function(e){return e[e.People=0]="People",e[e.PublicRooms=1]="PublicRooms",e}({});function pe(e){switch(e){case ue.People:return Object(x.b)("People");case ue.PublicRooms:return Object(x.b)("Public rooms")}}const ge=e=>!(null==e||!e.room),be=e=>!(null==e||!e.publicRoom),ve=e=>!(null==e||!e.member),fe=e=>{var t,a,n,i,s;return{publicRoom:e,section:he.PublicRooms,filter:[ue.PublicRooms],query:Object(re.n)([e.room_id.toLowerCase(),null===(t=e.canonical_alias)||void 0===t?void 0:t.toLowerCase(),null===(a=e.name)||void 0===a?void 0:a.toLowerCase(),u()(null!==(n=null===(i=e.topic)||void 0===i?void 0:i.toLowerCase())&&void 0!==n?n:"",{allowedTags:[]}),...(null===(s=e.aliases)||void 0===s?void 0:s.map((e=>e.toLowerCase())))||[]])}},Ee=e=>{const t=j.a.get().getUserId();if(B.a.shared().getUserIdForRoomId(e.roomId)){const a=e.getMembers().filter((e=>e.userId!==t)),n=[...a.map((e=>e.name.toLowerCase())),...a.map((e=>e.userId.toLowerCase()))].filter(Boolean);return{room:e,section:he.People,filter:[ue.People],query:n}}return e.isSpaceRoom()?{room:e,section:he.Spaces,filter:[]}:{room:e,section:he.Rooms,filter:[]}},ye=e=>({member:e,section:he.Suggestions,filter:[ue.People],query:[e.userId.toLowerCase(),e.name.toLowerCase()].filter(Boolean)}),_e=new M.a,Se=(e,t)=>e.getVisibleRooms(t).filter((e=>!Object(ie.a)(e)&&("join"===e.getMyMembership()||"invite"==e.getMyMembership()))),we=function(e,t){let a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return Object.values(Se(e,t).filter((e=>!a||!B.a.shared().getUserIdForRoomId(e.roomId))).reduce(((e,t)=>{for(const a of t.getJoinedMembers())e[a.userId]=a;return e}),{})).filter((t=>t.userId!==e.getUserId()))},Oe=(e,t)=>t.hasMentions?Object(x.b)("%(count)s unread messages including mentions.",{count:t.count}):t.hasUnreadCount?Object(x.b)("%(count)s unread messages.",{count:t.count}):t.isUnread?Object(x.b)("Unread messages."):void 0,Ce=t=>{var a,n;let{initialText:s="",initialFilter:h=null,onFinished:u}=t;const M=Object(d.useRef)(null),ie=Object(d.useRef)(null),re=j.a.get(),Ce=Object(d.useContext)(g.c),[xe,je]=Object(d.useState)(s),[ke,Re]=Object(y.a)(),[Ie,Te]=Object(d.useState)(h),Ne=Object(d.useCallback)((e=>{var t,a,n;Te(e),null===(t=M.current)||void 0===t||t.focus(),null===(a=ie.current)||void 0===a||null===(n=a.scrollTo)||void 0===n||n.call(a,{top:0})}),[]),Pe=Object(d.useMemo)((()=>{const e=Object(W.a)(re),t=Object(W.b)(re);return Object(W.c)(e,t)}),[re]),De=Object(oe.a)("feature_dynamic_room_predecessors"),Me=Object(V.i)(re.getUserId()),[Ae,Ue]=Object(d.useState)(!1),Le=Object(d.useMemo)((()=>xe.trim()),[xe]),Fe=Object(oe.a)("feature_exploring_public_spaces"),{loading:Be,publicRooms:Ve,protocols:We,config:ze,setConfig:He,search:Ke}=Object(S.a)(),[Ge,qe]=Object(d.useState)(!0),[$e,Ye]=Object(d.useState)(!1),{loading:Je,users:Qe,search:Xe}=Object(O.a)(),{loading:Ze,profile:et,search:tt}=Object(_.a)(),at=Object(d.useMemo)((()=>[{query:Le,roomTypes:me(Ge,$e),limit:le}]),[Le,Ge,$e]);Object(E.a)(Ie===ue.PublicRooms,Ke,at),Object(E.a)(Ie===ue.People,Xe,at),Object(E.a)(Ie===ue.People,tt,at);const nt=Object(d.useMemo)((()=>{const e=[],t=Se(re,De).map(Ee),a=t.reduce(((e,t)=>{const a=B.a.shared().getUserIdForRoomId(t.room.roomId);return a?(t.room.getJoinedMemberCount()>2||e.add(a),e):e}),new Set);for(const t of[...we(re,De),...Qe])a.has(t.userId)||(a.add(t.userId),e.push(ye(t)));return[...L.a.instance.enabledMetaSpaces.map((e=>({section:he.Spaces,filter:[],avatar:m.a.createElement("div",{className:o()("mx_SpotlightDialog_metaspaceResult",`mx_SpotlightDialog_metaspaceResult_${e}`)}),name:Object(U.g)(e,L.a.instance.allRoomsInHome),onClick(){L.a.instance.setActiveSpace(e)}}))),...t,...e,...(et&&!a.has(et.user_id)?[new F.a(et)]:[]).map(ye),...Ve.map(fe)].filter((e=>null===Ie||e.filter.includes(Ie)))}),[re,Qe,et,Ve,Ie,De]),it=Object(d.useMemo)((()=>{const e={[he.People]:[],[he.Rooms]:[],[he.Spaces]:[],[he.Suggestions]:[],[he.PublicRooms]:[]};if(Le){const t=Le.toLowerCase(),a=Object(c.B)(Le);nt.forEach((n=>{var i,s,o;if(ge(n)){if(!(null!==(i=n.room.normalizedName)&&void 0!==i&&i.includes(a)||null!==(s=n.room.getCanonicalAlias())&&void 0!==s&&s.toLowerCase().includes(t)||null!==(o=n.query)&&void 0!==o&&o.some((e=>e.includes(t)))))return}else if(ve(n)){var r;if(null===(r=n.query)||void 0===r||!r.some((e=>e.includes(t))))return}else if(be(n)){var l;if(null===(l=n.query)||void 0===l||!l.some((e=>e.includes(t))))return}else{var c;if(!(n.name.toLowerCase().includes(t)||null!==(c=n.query)&&void 0!==c&&c.some((e=>e.includes(t)))))return}e[n.section].push(n)}))}else Ie===ue.PublicRooms?nt.forEach((t=>{be(t)&&e[t.section].push(t)})):Ie===ue.People&&nt.forEach((t=>{ve(t)&&e[t.section].push(t)}));const t=re.getSafeUserId();for(const a of Object.values(e))a.sort(((e,a)=>ge(e)||ge(a)?ge(a)&&ge(e)?_e.getLastTs(a.room,t)-_e.getLastTs(e.room,t):-1:ve(e)||ve(a)?ve(a)&&ve(e)?Pe(e.member,a.member):-1:0));return e}),[Le,Ie,re,nt,Pe]);((e,t,a)=>{Object(d.useEffect)((()=>{if(!t)return;const n=window.setTimeout((()=>{k.a.instance.trackEvent({eventName:"WebSearch",viaSpotlight:a,numResults:e,queryLength:t})}),1e3);return()=>{clearTimeout(n)}}),[e,t,a])})(Object(r.sum)(Object.values(it).map((e=>e.length))),xe.length,!0);const st=L.a.instance.activeSpaceRoom,[ot,rt]=Object(w.a)(null!=st?st:void 0,xe);Object(d.useEffect)((()=>{e((()=>{const e=Ce.state.refs[0];var t,a;e&&(Ce.dispatch({type:g.f.SetFocus,payload:{ref:e}}),null===(t=e.current)||void 0===t||null===(a=t.scrollIntoView)||void 0===a||a.call(t,{block:"nearest"}))}))}),[it,Ie]);const lt=function(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(arguments.length>1&&void 0!==arguments[1]&&arguments[1]){const t=new Set(N.b.getValue("SpotlightSearch.recentSearches",null).reverse());t.delete(e.roomId),t.add(e.roomId),N.b.setValue("SpotlightSearch.recentSearches",null,T.a.ACCOUNT,Array.from(t).reverse().slice(0,10))}f.a.dispatch({action:v.a.ViewRoom,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:t,room_id:e.roomId,room_alias:e.roomAlias,auto_join:e.autoJoin,should_peek:e.shouldPeek,via_servers:e.viaServers}),u()};let ct,dt;if((Le||Ie!==ue.PublicRooms)&&(ct=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_otherSearches"},m.a.createElement("h4",{id:"mx_SpotlightDialog_section_otherSearches"},Le?Object(x.b)('Use "%(query)s" to search',{query:xe}):Object(x.b)("Search for")),m.a.createElement("div",null,Ie!==ue.PublicRooms&&m.a.createElement(Z.a,{id:"mx_SpotlightDialog_button_explorePublicRooms",className:"mx_SpotlightDialog_explorePublicRooms",onClick:()=>Ne(ue.PublicRooms)},pe(ue.PublicRooms)),Ie!==ue.People&&m.a.createElement(Z.a,{id:"mx_SpotlightDialog_button_startChat",className:"mx_SpotlightDialog_startChat",onClick:()=>Ne(ue.People)},pe(ue.People))))),Le||null!==Ie){const e=e=>{var t;if(ge(e)){const t=D.a.instance.getRoomState(e.room),a=Oe(e.room,t),n={"aria-label":a?`${e.room.name} ${a}`:e.room.name,"aria-describedby":`mx_SpotlightDialog_button_result_${e.room.roomId}_details`};return m.a.createElement(Z.a,i()({id:`mx_SpotlightDialog_button_result_${e.room.roomId}`,key:`${he[e.section]}-${e.room.roomId}`,onClick:t=>{lt({roomId:e.room.roomId},!0,"click"!==(null==t?void 0:t.type))},endAdornment:m.a.createElement(te.a,{room:e.room})},n),m.a.createElement(K.a,{room:e.room,avatarSize:ce,tooltipProps:{tabIndex:-1}}),e.room.name,m.a.createElement(Q.a,{notification:t}),m.a.createElement(ae.a,{id:`mx_SpotlightDialog_button_result_${e.room.roomId}_details`,className:"mx_SpotlightDialog_result_details",room:e.room}))}if(ve(e))return m.a.createElement(Z.a,{id:`mx_SpotlightDialog_button_result_${e.member.userId}`,key:`${he[e.section]}-${e.member.userId}`,onClick:()=>{Object(F.e)(re,[e.member]),u()},"aria-label":e.member instanceof l.RoomMember?e.member.rawDisplayName:e.member.name,"aria-describedby":`mx_SpotlightDialog_button_result_${e.member.userId}_details`},m.a.createElement(G.a,{user:e.member,size:ce}),e.member instanceof l.RoomMember?e.member.rawDisplayName:e.member.name,m.a.createElement("div",{id:`mx_SpotlightDialog_button_result_${e.member.userId}_details`,className:"mx_SpotlightDialog_result_details"},e.member.userId));if(be(e)){const t=re.getRoom(e.publicRoom.room_id),a="join"===(null==t?void 0:t.getMyMembership())||e.publicRoom.world_readable||re.isGuest(),n=t=>{var a;t.stopPropagation();const{publicRoom:n}=e;lt({roomAlias:n.canonical_alias||(null===(a=n.aliases)||void 0===a?void 0:a[0]),roomId:n.room_id,autoJoin:!e.publicRoom.world_readable&&!re.isGuest(),shouldPeek:e.publicRoom.world_readable||re.isGuest(),viaServers:ze?[ze.roomServer]:void 0},!0,"click"!==t.type)};return m.a.createElement(Z.a,{id:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}`,className:"mx_SpotlightDialog_result_multiline",key:`${he[e.section]}-${e.publicRoom.room_id}`,onClick:n,endAdornment:m.a.createElement($.a,{kind:a?"primary_outline":"primary",onClick:n,tabIndex:-1},a?Object(x.b)("View"):Object(x.b)("Join")),"aria-labelledby":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_name`,"aria-describedby":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_alias`,"aria-details":`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_details`},m.a.createElement(se.a,{className:"mx_SearchResultAvatar",oobData:{roomId:e.publicRoom.room_id,name:e.publicRoom.name,avatarUrl:e.publicRoom.avatar_url,roomType:e.publicRoom.room_type},width:ce,height:ce}),m.a.createElement(ee.a,{room:e.publicRoom,labelId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_name`,descriptionId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_alias`,detailsId:`mx_SpotlightDialog_button_result_${e.publicRoom.room_id}_details`}))}return m.a.createElement(Z.a,{id:`mx_SpotlightDialog_button_result_${e.name}`,key:`${he[e.section]}-${e.name}`,onClick:null!==(t=e.onClick)&&void 0!==t?t:null},e.avatar,e.name,e.description)};let t,a,n,s,o,c,d,h,p,g;it[he.People].length&&(t=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_people"},m.a.createElement("h4",{id:"mx_SpotlightDialog_section_people"},Object(x.b)("Recent Conversations")),m.a.createElement("div",null,it[he.People].slice(0,le).map(e)))),it[he.Suggestions].length&&Ie===ue.People&&(a=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_suggestions"},m.a.createElement("h4",{id:"mx_SpotlightDialog_section_suggestions"},Object(x.b)("Suggestions")),m.a.createElement("div",null,it[he.Suggestions].slice(0,le).map(e)))),it[he.Rooms].length&&(n=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_rooms"},m.a.createElement("h4",{id:"mx_SpotlightDialog_section_rooms"},Object(x.b)("Rooms")),m.a.createElement("div",null,it[he.Rooms].slice(0,le).map(e)))),it[he.Spaces].length&&(s=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_spaces"},m.a.createElement("h4",{id:"mx_SpotlightDialog_section_spaces"},Object(x.b)("Spaces you're in")),m.a.createElement("div",null,it[he.Spaces].slice(0,le).map(e)))),Ie===ue.PublicRooms&&(o=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_publicRooms"},m.a.createElement("div",{className:"mx_SpotlightDialog_sectionHeader"},m.a.createElement("h4",{id:"mx_SpotlightDialog_section_publicRooms"},Object(x.b)("Suggestions")),m.a.createElement("div",{className:"mx_SpotlightDialog_options"},Fe&&m.a.createElement(m.a.Fragment,null,m.a.createElement(Y.a,{label:Object(x.b)("Show rooms"),value:Ge,onChange:qe}),m.a.createElement(Y.a,{label:Object(x.b)("Show spaces"),value:$e,onChange:Ye})),m.a.createElement(q.a,{protocols:We,config:null!=ze?ze:null,setConfig:He}))),m.a.createElement("div",null," ",Ge||$e?it[he.PublicRooms].slice(0,le).map(e):m.a.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},Object(x.b)("You cannot search for rooms that are neither a room nor a space"))," "))),ot.length&&st&&null===Ie&&(c=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_results",role:"group","aria-labelledby":"mx_SpotlightDialog_section_spaceRooms"},m.a.createElement("h4",{id:"mx_SpotlightDialog_section_spaceRooms"},Object(x.b)("Other rooms in %(spaceName)s",{spaceName:st.name})),m.a.createElement("div",null,ot.slice(0,le).map((e=>m.a.createElement(Z.a,{id:`mx_SpotlightDialog_button_result_${e.room_id}`,key:e.room_id,onClick:t=>{lt({roomId:e.room_id},!0,"click"!==(null==t?void 0:t.type))}},m.a.createElement(H.a,{name:e.name,idName:e.room_id,url:e.avatar_url?Object(b.b)(e.avatar_url).getSquareThumbnailHttp(ce):null,width:ce,height:ce}),e.name||e.canonical_alias,e.name&&e.canonical_alias&&m.a.createElement("div",{className:"mx_SpotlightDialog_result_details"},e.canonical_alias)))),rt&&m.a.createElement(J.a,null)))),!Le.startsWith("#")||!Le.includes(":")||Object(R.a)(Le)&&re.getRoom(Object(R.a)(Le))||(d=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group"},m.a.createElement("div",null,m.a.createElement(Z.a,{id:"mx_SpotlightDialog_button_joinRoomAlias",className:"mx_SpotlightDialog_joinRoomAlias",onClick:e=>{f.a.dispatch({action:v.a.ViewRoom,room_alias:Le,auto_join:!0,metricsTrigger:"WebUnifiedSearch",metricsViaKeyboard:"click"!==(null==e?void 0:e.type)}),u()}},Object(x.b)("Join %(roomAddress)s",{roomAddress:Le}))))),Ie===ue.People?h=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_hiddenResults",role:"group"},m.a.createElement("h4",null,Object(x.b)("Some results may be hidden for privacy")),m.a.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},Object(x.b)("If you can't see who you're looking for, send them your invite link.")),m.a.createElement(ne.a,{id:"mx_SpotlightDialog_button_inviteLink",className:"mx_SpotlightDialog_inviteLink",onClick:()=>{Ue(!0),Object(z.b)(Me)},onHideTooltip:()=>Ue(!1),title:Ae?Object(x.b)("Copied!"):Object(x.b)("Copy")},m.a.createElement("span",{className:"mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline"},Object(x.b)("Copy invite link")))):Le&&Ie===ue.PublicRooms&&(h=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_hiddenResults",role:"group"},m.a.createElement("h4",null,Object(x.b)("Some results may be hidden")),m.a.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},Object(x.b)("If you can't find the room you're looking for, ask for an invite or create a new room.")),m.a.createElement(Z.a,{id:"mx_SpotlightDialog_button_createNewRoom",className:"mx_SpotlightDialog_createRoom",onClick:()=>f.a.dispatch({action:"view_create_room",public:!0,defaultName:Object(r.capitalize)(Le)})},m.a.createElement("span",{className:"mx_AccessibleButton mx_AccessibleButton_hasKind mx_AccessibleButton_kind_primary_outline"},Object(x.b)("Create new room"))))),Ie===ue.People&&(p=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_groupChat"},m.a.createElement("h4",{id:"mx_SpotlightDialog_section_groupChat"},Object(x.b)("Other options")),m.a.createElement(Z.a,{id:"mx_SpotlightDialog_button_startGroupChat",className:"mx_SpotlightDialog_startGroupChat",onClick:()=>Object(I.f)(Le)},Object(x.b)("Start a group chat")))),null===Ie&&(g=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_otherSearches",role:"group","aria-labelledby":"mx_SpotlightDialog_section_messageSearch"},m.a.createElement("h4",{id:"mx_SpotlightDialog_section_messageSearch"},Object(x.b)("Other searches")),m.a.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchText"},Object(x.b)("To search messages, look for this icon at the top of a room <icon/>",{},{icon:()=>m.a.createElement("div",{className:"mx_SpotlightDialog_otherSearches_messageSearchIcon"})})))),dt=m.a.createElement(m.a.Fragment,null,t,a,n,s,c,o,d,h,ct,p,g)}else{let e;ke.length&&(e=m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentSearches",role:"group",tabIndex:-1,"aria-labelledby":"mx_SpotlightDialog_section_recentSearches"},m.a.createElement("h4",null,m.a.createElement("span",{id:"mx_SpotlightDialog_section_recentSearches"},Object(x.b)("Recent searches")),m.a.createElement($.a,{kind:"link",onClick:Re},Object(x.b)("Clear"))),m.a.createElement("div",null,ke.map((e=>{const t=D.a.instance.getRoomState(e),a=Oe(0,t),n={"aria-label":a?`${e.name} ${a}`:e.name,"aria-describedby":`mx_SpotlightDialog_button_recentSearch_${e.roomId}_details`};return m.a.createElement(Z.a,i()({id:`mx_SpotlightDialog_button_recentSearch_${e.roomId}`,key:e.roomId,onClick:t=>{lt({roomId:e.roomId},!0,"click"!==(null==t?void 0:t.type))},endAdornment:m.a.createElement(te.a,{room:e})},n),m.a.createElement(K.a,{room:e,avatarSize:ce,tooltipProps:{tabIndex:-1}}),e.name,m.a.createElement(Q.a,{notification:t}),m.a.createElement(ae.a,{id:`mx_SpotlightDialog_button_recentSearch_${e.roomId}_details`,className:"mx_SpotlightDialog_result_details",room:e}))}))))),dt=m.a.createElement(m.a.Fragment,null,m.a.createElement("div",{className:"mx_SpotlightDialog_section mx_SpotlightDialog_recentlyViewed",role:"group","aria-labelledby":"mx_SpotlightDialog_section_recentlyViewed"},m.a.createElement("h4",{id:"mx_SpotlightDialog_section_recentlyViewed"},Object(x.b)("Recently viewed")),m.a.createElement("div",null,P.a.instance.rooms.filter((e=>e.roomId!==A.b.instance.roomViewStore.getRoomId())).map((e=>m.a.createElement(ne.a,{id:`mx_SpotlightDialog_button_recentlyViewed_${e.roomId}`,title:e.name,key:e.roomId,onClick:t=>{lt({roomId:e.roomId},!1,"click"!==t.type)}},m.a.createElement(K.a,{room:e,avatarSize:32,tooltipProps:{tabIndex:-1}}),e.name))))),e,ct)}const mt=null===(a=Ce.state.activeRef)||void 0===a||null===(n=a.current)||void 0===n?void 0:n.id;return m.a.createElement(m.a.Fragment,null,m.a.createElement("div",{id:"mx_SpotlightDialog_keyboardPrompt"},Object(x.b)("Use <arrows/> to scroll",{},{arrows:()=>m.a.createElement(m.a.Fragment,null,m.a.createElement("kbd",null,"↓"),m.a.createElement("kbd",null,"↑"),null!==!Ie&&!xe&&m.a.createElement("kbd",null,"←"),null!==!Ie&&!xe&&m.a.createElement("kbd",null,"→"))})),m.a.createElement(X.a,{className:"mx_SpotlightDialog",onFinished:u,hasCancel:!1,onKeyDown:e=>{if(Object(C.a)().getNavigationAction(e)===p.h.FilterRooms)e.stopPropagation(),e.preventDefault(),u();let t;const a=Object(C.a)().getAccessibilityAction(e);switch(a){case p.h.Escape:e.stopPropagation(),e.preventDefault(),u();break;case p.h.ArrowUp:case p.h.ArrowDown:if(e.stopPropagation(),e.preventDefault(),Ce.state.refs.length>0){let e=Ce.state.refs;if(!xe&&null!==!Ie){const t=de(Ce.state.activeRef)?Ce.state.activeRef:e.find(de);e=e.filter((e=>e===t||!de(e)))}const n=e.indexOf(Ce.state.activeRef);t=Object(g.h)(e,n+(a===p.h.ArrowUp?-1:1))}break;case p.h.ArrowLeft:case p.h.ArrowRight:if(!xe&&null!==!Ie&&Ce.state.refs.length>0&&de(Ce.state.activeRef)){e.stopPropagation(),e.preventDefault();const n=Ce.state.refs.filter(de),i=n.indexOf(Ce.state.activeRef);t=Object(g.h)(n,i+(a===p.h.ArrowLeft?-1:1))}}var n;t&&(Ce.dispatch({type:g.f.SetFocus,payload:{ref:t}}),null===(n=t.current)||void 0===n||n.scrollIntoView({block:"nearest"}))},screenName:"UnifiedSearch","aria-label":Object(x.b)("Search Dialog")},m.a.createElement("div",{className:"mx_SpotlightDialog_searchBox mx_textinput"},null!==Ie&&m.a.createElement("div",{className:o()("mx_SpotlightDialog_filter",{mx_SpotlightDialog_filterPeople:Ie===ue.People,mx_SpotlightDialog_filterPublicRooms:Ie===ue.PublicRooms})},m.a.createElement("span",null,pe(Ie)),m.a.createElement($.a,{tabIndex:-1,alt:Object(x.b)("Remove search filter for %(filter)s",{filter:pe(Ie)}),className:"mx_SpotlightDialog_filter--close",onClick:()=>Ne(null)})),m.a.createElement("input",{ref:M,autoFocus:!0,type:"text",autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:"false",placeholder:Object(x.b)("Search"),value:xe,onChange:e=>{const t=e.currentTarget.value;je(t)},onKeyDown:e=>{var t,a;switch(Object(C.a)().getAccessibilityAction(e)){case p.h.Backspace:xe||null===Ie||(e.stopPropagation(),e.preventDefault(),Ne(null));break;case p.h.Enter:e.stopPropagation(),e.preventDefault(),null===(t=Ce.state.activeRef)||void 0===t||null===(a=t.current)||void 0===a||a.click()}},"aria-owns":"mx_SpotlightDialog_content","aria-activedescendant":mt,"aria-label":Object(x.b)("Search"),"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"}),(Be||Je||Ze)&&m.a.createElement(J.a,{w:24,h:24})),m.a.createElement("div",{ref:ie,id:"mx_SpotlightDialog_content",role:"listbox","aria-activedescendant":mt,"aria-describedby":"mx_SpotlightDialog_keyboardPrompt"},dt)))};t.b=e=>m.a.createElement(g.d,null,(()=>m.a.createElement(Ce,e)))}).call(this,a(54).setImmediate)},967:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n=a(13),i=a.n(n),s=a(130);class o{constructor(e,t,a){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.root=e,this.pageSize=t,this.maxDepth=a,this.suggestedOnly=n,i()(this,"viaMap",new Map),i()(this,"backRefs",new Map),i()(this,"roomMap",new Map),i()(this,"loadRequest",void 0),i()(this,"nextBatch",void 0),i()(this,"_rooms",void 0),i()(this,"serverSupportError",void 0)}get noSupport(){return!!this.serverSupportError}get canLoadMore(){return!!this.serverSupportError||!!this.nextBatch||!this._rooms}get loading(){return!!this.loadRequest}get rooms(){return this._rooms}async load(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.pageSize;if(this.loadRequest)return this.loadRequest.then((e=>e.rooms));this.loadRequest=this.root.client.getRoomHierarchy(this.root.roomId,t,this.maxDepth,this.suggestedOnly,this.nextBatch);try{({rooms:e,next_batch:this.nextBatch}=await this.loadRequest)}catch(e){if("M_UNRECOGNIZED"!==e.errcode)throw e;return this.serverSupportError=e,[]}finally{this.loadRequest=void 0}return this._rooms?this._rooms=this._rooms.concat(e):this._rooms=e,e.forEach((e=>{this.roomMap.set(e.room_id,e),e.children_state.forEach((t=>{if(t.type!==s.b.SpaceChild)return;const a=t.state_key;if(this.backRefs.has(a)||this.backRefs.set(a,[]),this.backRefs.get(a).push(e.room_id),Array.isArray(t.content.via)){this.viaMap.has(a)||this.viaMap.set(a,new Set);const e=this.viaMap.get(a);t.content.via.forEach((t=>e.add(t)))}}))})),e}getRelation(e,t){var a;return null===(a=this.roomMap.get(e))||void 0===a?void 0:a.children_state.find((e=>e.state_key===t))}isSuggested(e,t){var a;return null===(a=this.getRelation(e,t))||void 0===a?void 0:a.content.suggested}removeRelation(e,t){const a=this.backRefs.get(t);1===(null==a?void 0:a.length)?this.backRefs.delete(t):null!=a&&a.length&&this.backRefs.set(t,a.filter((t=>t!==e)));const n=this.roomMap.get(e);n&&(n.children_state=n.children_state.filter((e=>e.state_key!==t)))}}},968:function(e,t,a){"use strict";a.d(t,"b",(function(){return b}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(121),l=a(126),c=a(138),d=a(182),m=a(169),h=a(212),u=a(163);function p(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function g(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?p(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):p(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}const b=(e,t)=>a=>{const n=l.b.getValue("Spaces.enabledMetaSpaces");l.b.setValue("Spaces.enabledMetaSpaces",null,c.a.ACCOUNT,g(g({},n),{},{[e]:a.target.checked})),u.b.trackInteraction(t,a,[h.a.Home,null,h.a.Favourites,h.a.People,h.a.Orphans].indexOf(e))};t.a=()=>{const{[h.a.Home]:e,[h.a.Favourites]:t,[h.a.People]:a,[h.a.Orphans]:n}=Object(m.b)("Spaces.enabledMetaSpaces"),i=Object(m.b)("Spaces.allRoomsInHome");return o.a.createElement("div",{className:"mx_SettingsTab mx_SidebarUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(r.b)("Sidebar")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(r.b)("Spaces to show")),o.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(r.b)("Spaces are ways to group rooms and people. Alongside the spaces you're in, you can use some pre-built ones too.")),o.a.createElement(d.b,{checked:!!e,onChange:b(h.a.Home,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_homeCheckbox"},Object(r.b)("Home")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.b)("Home is useful for getting an overview of everything. Keep in mind that disabling it could leave you unable to see certain rooms.")),o.a.createElement(d.b,{checked:i,disabled:!e,onChange:e=>{l.b.setValue("Spaces.allRoomsInHome",null,c.a.ACCOUNT,e.target.checked),u.b.trackInteraction("WebSettingsSidebarTabSpacesCheckbox",e,1)},className:"mx_SidebarUserSettingsTab_homeAllRoomsCheckbox"},Object(r.b)("Show all rooms")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.b)("Show all your rooms in Home, even if they're in a space.")),o.a.createElement(d.b,{checked:!!t,onChange:b(h.a.Favourites,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_favouritesCheckbox"},Object(r.b)("Favourites")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.b)("Group all your favourite rooms and people in one place.")),o.a.createElement(d.b,{checked:!!a,onChange:b(h.a.People,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_peopleCheckbox"},Object(r.b)("People")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.b)("Group all your people in one place.")),o.a.createElement(d.b,{checked:!!n,onChange:b(h.a.Orphans,"WebSettingsSidebarTabSpacesCheckbox"),className:"mx_SidebarUserSettingsTab_orphansCheckbox"},Object(r.b)("Rooms outside of a space")),o.a.createElement("div",{className:"mx_SidebarUserSettingsTab_checkboxMicrocopy"},Object(r.b)("Group all your rooms that aren't part of a space in one place."))))}},977:function(e,t,a){"use strict";a.d(t,"a",(function(){return p}));var n=a(127),i=a.n(n),s=a(130),o=a(120),r=a.n(o),l=a(133),c=a(139),d=a(652),m=a(301),h=a(124),u=a(135);const p=52;t.b=e=>{var t;let{hasAvatar:a,hasAvatarLabel:n,noAvatarLabel:p,setAvatarUrl:g,isUserAvatar:b,children:v,onClick:f}=e;const E=Object(o.useContext)(l.a),[y,_]=Object(o.useState)(!1),[S,w]=Object(o.useState)(!1),[O,C]=Object(o.useState)(!1);Object(d.c)((()=>{C(!0)}),3e3),Object(d.c)((()=>{C(!1)}),13e3);const x=Object(o.useRef)(null),j=a||y?n:p,{room:k}=Object(o.useContext)(c.b);if(!(b||(null==k||null===(t=k.currentState)||void 0===t?void 0:t.maySendStateEvent(s.b.RoomAvatar,E.getSafeUserId()))))return r.a.createElement(r.a.Fragment,null,v);const R=!!j&&(S||O);return r.a.createElement(r.a.Fragment,null,r.a.createElement("input",{type:"file",ref:x,className:"mx_MiniAvatarUploader_input",onClick:e=>{Object(m.a)(e),null==f||f(e)},onChange:async e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;_(!0);const a=e.target.files[0],{content_uri:n}=await E.uploadContent(a);await g(n),_(!1)},accept:"image/*"}),r.a.createElement(h.a,{className:i()("mx_MiniAvatarUploader",{mx_MiniAvatarUploader_busy:y,mx_MiniAvatarUploader_hasAvatar:a}),disabled:y,onClick:()=>{var e;null===(e=x.current)||void 0===e||e.click()},onMouseOver:()=>w(!0),onMouseLeave:()=>w(!1)},v,r.a.createElement("div",{className:"mx_MiniAvatarUploader_indicator"},y?r.a.createElement(u.a,{w:20,h:20}):r.a.createElement("div",{className:"mx_MiniAvatarUploader_cameraIcon"})),r.a.createElement("div",{className:i()("mx_Tooltip",{mx_Tooltip_visible:R,mx_Tooltip_invisible:!R})},r.a.createElement("div",{className:"mx_Tooltip_chevron"}),j)))}},978:function(e,t){e.exports="img/user-onboarding/PersonalMessaging.b5ba3c4.png"},979:function(e,t,a){"use strict";a.d(t,"a",(function(){return i})),a.d(t,"b",(function(){return s})),a.d(t,"c",(function(){return o})),a.d(t,"d",(function(){return r}));var n=a(121);let i=function(e){return e.Html="Html",e.PlainText="PlainText",e.Json="Json",e}({}),s=function(e){return e.Timeline="Timeline",e.Beginning="Beginning",e.LastNMessages="LastNMessages",e}({});const o=e=>{switch(e){case i.Html:return Object(n.b)("HTML");case i.Json:return Object(n.b)("JSON");case i.PlainText:return Object(n.b)("Plain Text");default:throw new Error("Unknown format")}},r=e=>{switch(e){case s.Beginning:return Object(n.b)("From the beginning");case s.LastNMessages:return Object(n.b)("Specify a number of messages");case s.Timeline:return Object(n.b)("Current Timeline");default:throw new Error("Unknown type: "+e)}}},980:function(e,t,a){"use strict";a.d(t,"a",(function(){return s}));var n=a(167),i=a(309);const s=e=>{if(!Object(i.a)())return{shouldEncrypt:!1};if(!n.a.shared().getRoomIds().has(e.roomId))return{shouldEncrypt:!1};if(1!==e.getInvitedAndJoinedMemberCount())return{shouldEncrypt:!1};const t=e.currentState.getStateEvents("m.room.third_party_invite")||[];return 1===t.length?{shouldEncrypt:!0,inviteEvent:t[0]}:{shouldEncrypt:!1}}},983:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var n,i=a(120);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},s.apply(this,arguments)}function o(e){return i.createElement("svg",s({fill:"none",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 18 14",role:"presentation","aria-hidden":!0},e),n||(n=i.createElement("path",{d:"M17 7H1m0 0l6 6M1 7l6-6",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"})))}},984:function(e,t,a){"use strict";a.d(t,"b",(function(){return i})),a.d(t,"a",(function(){return s}));var n=a(298);const i=async(e,t,a,n)=>{n?(await e.setPushRuleActions("global",a,t,n),await e.setPushRuleEnabled("global",a,t,!0)):await e.setPushRuleEnabled("global",a,t,!1)},s=async(e,t,a)=>{const s=new n.a(e),o=null==t?void 0:t.map((e=>s.getPushRuleAndKindById(e))).filter((e=>Boolean(e)));if(null!=o&&o.length)for(const{kind:t,rule:n}of o)await i(e,n.rule_id,t,a)}},985:function(e,t,a){"use strict";a.d(t,"a",(function(){return E})),a.d(t,"c",(function(){return y})),a.d(t,"b",(function(){return _}));var n=a(120),i=a.n(n),s=a(121),o=a(132),r=a(125),l=a(124),c=a(231),d=a(196),m=a(986),h=a(128),u=a(126);const p=()=>{r.a.dispatch({action:h.a.PseudonymousAnalyticsAccept})},g=()=>{r.a.dispatch({action:h.a.PseudonymousAnalyticsReject})},b=()=>{Object(m.b)({onFinished:e=>{e===m.a.Primary&&p()},primaryButton:Object(s.b)("Enable")})},v=()=>{Object(m.b)({onFinished:e=>{e===m.a.Primary?p():e===m.a.Cancel&&g()},primaryButton:Object(s.b)("That's fine"),cancelButton:Object(s.b)("Stop")})},f="analytics";function E(){return o.b.get("privacy_policy_url")}const y=()=>{var e;const t=u.b.getValue("analyticsOptIn",null,!0);let a;if(t)a={description:Object(s.b)("You previously consented to share anonymous usage data with us. We're updating how that works."),acceptLabel:Object(s.b)("That's fine"),onAccept:p,rejectLabel:Object(s.b)("Learn more"),onReject:v};else{if(null!=t)return;{const e=e=>i.a.createElement(l.a,{kind:"link_inline",onClick:b},e);a={description:Object(s.b)("Share anonymous data to help us identify issues. Nothing personal. No third parties. <LearnMoreLink>Learn More</LearnMoreLink>",{},{LearnMoreLink:e}),acceptLabel:Object(s.b)("Yes"),onAccept:p,rejectLabel:Object(s.b)("No"),onReject:g}}}const n=null!==(e=o.b.get("analytics_owner"))&&void 0!==e?e:o.b.get().brand;d.a.sharedInstance().addOrReplaceToast({key:f,title:Object(s.b)("Help improve %(analyticsOwner)s",{analyticsOwner:n}),props:a,component:c.a,className:"mx_AnalyticsToast",priority:10})},_=()=>{d.a.sharedInstance().dismissToast(f)}},986:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return b}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(137),l=a(121),c=a(148),d=a(129),m=a(132),h=a(985);function u(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}let p=function(e){return e[e.Primary=0]="Primary",e[e.Cancel=1]="Cancel",e}({});const g=e=>{let{onFinished:t,analyticsOwner:a,privacyPolicyUrl:n,primaryButton:i,cancelButton:s,hasCancel:d}=e;const m=n?o.a.createElement("span",null,Object(l.b)("You can read all our terms <PrivacyPolicyUrl>here</PrivacyPolicyUrl>",{},{PrivacyPolicyUrl:e=>o.a.createElement("a",{href:n,rel:"norefferer noopener",target:"_blank"},e,o.a.createElement("span",{className:"mx_AnalyticsPolicyLink"}))})):"";return o.a.createElement(r.a,{className:"mx_AnalyticsLearnMoreDialog",contentId:"mx_AnalyticsLearnMore",title:Object(l.b)("Help improve %(analyticsOwner)s",{analyticsOwner:a}),onFinished:t},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_AnalyticsLearnMore_image_holder"}),o.a.createElement("div",{className:"mx_AnalyticsLearnMore_copy"},Object(l.b)("Help us identify issues and improve %(analyticsOwner)s by sharing anonymous usage data. To understand how people use multiple devices, we'll generate a random identifier, shared by your devices.",{analyticsOwner:a})),o.a.createElement("ul",{className:"mx_AnalyticsLearnMore_bullets"},o.a.createElement("li",null,Object(l.b)("We <Bold>don't</Bold> record or profile any account data",{},{Bold:e=>o.a.createElement("b",null,e)})),o.a.createElement("li",null,Object(l.b)("We <Bold>don't</Bold> share information with third parties",{},{Bold:e=>o.a.createElement("b",null,e)})),o.a.createElement("li",null,Object(l.b)("You can turn this off anytime in settings"))),m),o.a.createElement(c.a,{primaryButton:i,cancelButton:s,onPrimaryButtonClick:()=>null==t?void 0:t(p.Primary),onCancel:()=>null==t?void 0:t(p.Cancel),hasCancel:d}))},b=e=>{var t;const a=Object(h.a)(),n=null!==(t=m.b.get("analytics_owner"))&&void 0!==t?t:m.b.get("brand");d.b.createDialog(g,function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?u(Object(a),!0).forEach((function(t){i()(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):u(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({privacyPolicyUrl:a,analyticsOwner:n},e),"mx_AnalyticsLearnMoreDialog_wrapper")}},987:function(e,t,a){"use strict";a.d(t,"a",(function(){return m}));var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(121),l=a(126),c=a(135),d=a(308);class m extends o.a.Component{constructor(e){super(e),i()(this,"onSearchChange",(e=>{this.setState({searchQuery:e})})),this.state={searchQuery:"",langs:null}}componentDidMount(){if(r.e().then((e=>{e.sort((function(e,t){return e.label<t.label?-1:e.label>t.label?1:0})),this.setState({langs:e})})).catch((()=>{this.setState({langs:[{value:"en",label:"English"}]})})),!this.props.value){const e=r.i();this.props.onOptionChange(e)}}render(){if(null===this.state.langs)return o.a.createElement(c.a,null);let e;e=this.state.searchQuery?this.state.langs.filter((e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e))):this.state.langs;const t=e.map((e=>o.a.createElement("div",{key:e.value},e.label)));let a,n=l.b.getValue("language",null,!0);return n||(n=navigator.language||navigator.userLanguage),a=this.props.value||n,o.a.createElement(d.a,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this.onSearchChange,searchEnabled:!0,value:a,label:Object(r.b)("Language Dropdown"),disabled:this.props.disabled},t)}}},988:function(e,t,a){"use strict";a.d(t,"c",(function(){return s})),a.d(t,"b",(function(){return l})),a.d(t,"a",(function(){return c}));var n=a(121);const i=/^[0-9 -.]+$/;function s(e){return i.test(e)}const o=127462-"A".charCodeAt(0),r=/^[A-Z]{2}$/,l=e=>r.test(e)?String.fromCodePoint(...e.split("").map((e=>o+e.charCodeAt(0)))):"",c=[{iso2:"GB",name:Object(n.d)("United Kingdom"),prefix:"44"},{iso2:"US",name:Object(n.d)("United States"),prefix:"1"},{iso2:"AF",name:Object(n.d)("Afghanistan"),prefix:"93"},{iso2:"AX",name:Object(n.d)("Åland Islands"),prefix:"358"},{iso2:"AL",name:Object(n.d)("Albania"),prefix:"355"},{iso2:"DZ",name:Object(n.d)("Algeria"),prefix:"213"},{iso2:"AS",name:Object(n.d)("American Samoa"),prefix:"1"},{iso2:"AD",name:Object(n.d)("Andorra"),prefix:"376"},{iso2:"AO",name:Object(n.d)("Angola"),prefix:"244"},{iso2:"AI",name:Object(n.d)("Anguilla"),prefix:"1"},{iso2:"AQ",name:Object(n.d)("Antarctica"),prefix:"672"},{iso2:"AG",name:Object(n.d)("Antigua & Barbuda"),prefix:"1"},{iso2:"AR",name:Object(n.d)("Argentina"),prefix:"54"},{iso2:"AM",name:Object(n.d)("Armenia"),prefix:"374"},{iso2:"AW",name:Object(n.d)("Aruba"),prefix:"297"},{iso2:"AU",name:Object(n.d)("Australia"),prefix:"61"},{iso2:"AT",name:Object(n.d)("Austria"),prefix:"43"},{iso2:"AZ",name:Object(n.d)("Azerbaijan"),prefix:"994"},{iso2:"BS",name:Object(n.d)("Bahamas"),prefix:"1"},{iso2:"BH",name:Object(n.d)("Bahrain"),prefix:"973"},{iso2:"BD",name:Object(n.d)("Bangladesh"),prefix:"880"},{iso2:"BB",name:Object(n.d)("Barbados"),prefix:"1"},{iso2:"BY",name:Object(n.d)("Belarus"),prefix:"375"},{iso2:"BE",name:Object(n.d)("Belgium"),prefix:"32"},{iso2:"BZ",name:Object(n.d)("Belize"),prefix:"501"},{iso2:"BJ",name:Object(n.d)("Benin"),prefix:"229"},{iso2:"BM",name:Object(n.d)("Bermuda"),prefix:"1"},{iso2:"BT",name:Object(n.d)("Bhutan"),prefix:"975"},{iso2:"BO",name:Object(n.d)("Bolivia"),prefix:"591"},{iso2:"BA",name:Object(n.d)("Bosnia"),prefix:"387"},{iso2:"BW",name:Object(n.d)("Botswana"),prefix:"267"},{iso2:"BV",name:Object(n.d)("Bouvet Island"),prefix:"47"},{iso2:"BR",name:Object(n.d)("Brazil"),prefix:"55"},{iso2:"IO",name:Object(n.d)("British Indian Ocean Territory"),prefix:"246"},{iso2:"VG",name:Object(n.d)("British Virgin Islands"),prefix:"1"},{iso2:"BN",name:Object(n.d)("Brunei"),prefix:"673"},{iso2:"BG",name:Object(n.d)("Bulgaria"),prefix:"359"},{iso2:"BF",name:Object(n.d)("Burkina Faso"),prefix:"226"},{iso2:"BI",name:Object(n.d)("Burundi"),prefix:"257"},{iso2:"KH",name:Object(n.d)("Cambodia"),prefix:"855"},{iso2:"CM",name:Object(n.d)("Cameroon"),prefix:"237"},{iso2:"CA",name:Object(n.d)("Canada"),prefix:"1"},{iso2:"CV",name:Object(n.d)("Cape Verde"),prefix:"238"},{iso2:"BQ",name:Object(n.d)("Caribbean Netherlands"),prefix:"599"},{iso2:"KY",name:Object(n.d)("Cayman Islands"),prefix:"1"},{iso2:"CF",name:Object(n.d)("Central African Republic"),prefix:"236"},{iso2:"TD",name:Object(n.d)("Chad"),prefix:"235"},{iso2:"CL",name:Object(n.d)("Chile"),prefix:"56"},{iso2:"CN",name:Object(n.d)("China"),prefix:"86"},{iso2:"CX",name:Object(n.d)("Christmas Island"),prefix:"61"},{iso2:"CC",name:Object(n.d)("Cocos (Keeling) Islands"),prefix:"61"},{iso2:"CO",name:Object(n.d)("Colombia"),prefix:"57"},{iso2:"KM",name:Object(n.d)("Comoros"),prefix:"269"},{iso2:"CG",name:Object(n.d)("Congo - Brazzaville"),prefix:"242"},{iso2:"CD",name:Object(n.d)("Congo - Kinshasa"),prefix:"243"},{iso2:"CK",name:Object(n.d)("Cook Islands"),prefix:"682"},{iso2:"CR",name:Object(n.d)("Costa Rica"),prefix:"506"},{iso2:"HR",name:Object(n.d)("Croatia"),prefix:"385"},{iso2:"CU",name:Object(n.d)("Cuba"),prefix:"53"},{iso2:"CW",name:Object(n.d)("Curaçao"),prefix:"599"},{iso2:"CY",name:Object(n.d)("Cyprus"),prefix:"357"},{iso2:"CZ",name:Object(n.d)("Czech Republic"),prefix:"420"},{iso2:"CI",name:Object(n.d)("Côte d’Ivoire"),prefix:"225"},{iso2:"DK",name:Object(n.d)("Denmark"),prefix:"45"},{iso2:"DJ",name:Object(n.d)("Djibouti"),prefix:"253"},{iso2:"DM",name:Object(n.d)("Dominica"),prefix:"1"},{iso2:"DO",name:Object(n.d)("Dominican Republic"),prefix:"1"},{iso2:"EC",name:Object(n.d)("Ecuador"),prefix:"593"},{iso2:"EG",name:Object(n.d)("Egypt"),prefix:"20"},{iso2:"SV",name:Object(n.d)("El Salvador"),prefix:"503"},{iso2:"GQ",name:Object(n.d)("Equatorial Guinea"),prefix:"240"},{iso2:"ER",name:Object(n.d)("Eritrea"),prefix:"291"},{iso2:"EE",name:Object(n.d)("Estonia"),prefix:"372"},{iso2:"ET",name:Object(n.d)("Ethiopia"),prefix:"251"},{iso2:"FK",name:Object(n.d)("Falkland Islands"),prefix:"500"},{iso2:"FO",name:Object(n.d)("Faroe Islands"),prefix:"298"},{iso2:"FJ",name:Object(n.d)("Fiji"),prefix:"679"},{iso2:"FI",name:Object(n.d)("Finland"),prefix:"358"},{iso2:"FR",name:Object(n.d)("France"),prefix:"33"},{iso2:"GF",name:Object(n.d)("French Guiana"),prefix:"594"},{iso2:"PF",name:Object(n.d)("French Polynesia"),prefix:"689"},{iso2:"TF",name:Object(n.d)("French Southern Territories"),prefix:"262"},{iso2:"GA",name:Object(n.d)("Gabon"),prefix:"241"},{iso2:"GM",name:Object(n.d)("Gambia"),prefix:"220"},{iso2:"GE",name:Object(n.d)("Georgia"),prefix:"995"},{iso2:"DE",name:Object(n.d)("Germany"),prefix:"49"},{iso2:"GH",name:Object(n.d)("Ghana"),prefix:"233"},{iso2:"GI",name:Object(n.d)("Gibraltar"),prefix:"350"},{iso2:"GR",name:Object(n.d)("Greece"),prefix:"30"},{iso2:"GL",name:Object(n.d)("Greenland"),prefix:"299"},{iso2:"GD",name:Object(n.d)("Grenada"),prefix:"1"},{iso2:"GP",name:Object(n.d)("Guadeloupe"),prefix:"590"},{iso2:"GU",name:Object(n.d)("Guam"),prefix:"1"},{iso2:"GT",name:Object(n.d)("Guatemala"),prefix:"502"},{iso2:"GG",name:Object(n.d)("Guernsey"),prefix:"44"},{iso2:"GN",name:Object(n.d)("Guinea"),prefix:"224"},{iso2:"GW",name:Object(n.d)("Guinea-Bissau"),prefix:"245"},{iso2:"GY",name:Object(n.d)("Guyana"),prefix:"592"},{iso2:"HT",name:Object(n.d)("Haiti"),prefix:"509"},{iso2:"HM",name:Object(n.d)("Heard & McDonald Islands"),prefix:"672"},{iso2:"HN",name:Object(n.d)("Honduras"),prefix:"504"},{iso2:"HK",name:Object(n.d)("Hong Kong"),prefix:"852"},{iso2:"HU",name:Object(n.d)("Hungary"),prefix:"36"},{iso2:"IS",name:Object(n.d)("Iceland"),prefix:"354"},{iso2:"IN",name:Object(n.d)("India"),prefix:"91"},{iso2:"ID",name:Object(n.d)("Indonesia"),prefix:"62"},{iso2:"IR",name:Object(n.d)("Iran"),prefix:"98"},{iso2:"IQ",name:Object(n.d)("Iraq"),prefix:"964"},{iso2:"IE",name:Object(n.d)("Ireland"),prefix:"353"},{iso2:"IM",name:Object(n.d)("Isle of Man"),prefix:"44"},{iso2:"IL",name:Object(n.d)("Israel"),prefix:"972"},{iso2:"IT",name:Object(n.d)("Italy"),prefix:"39"},{iso2:"JM",name:Object(n.d)("Jamaica"),prefix:"1"},{iso2:"JP",name:Object(n.d)("Japan"),prefix:"81"},{iso2:"JE",name:Object(n.d)("Jersey"),prefix:"44"},{iso2:"JO",name:Object(n.d)("Jordan"),prefix:"962"},{iso2:"KZ",name:Object(n.d)("Kazakhstan"),prefix:"7"},{iso2:"KE",name:Object(n.d)("Kenya"),prefix:"254"},{iso2:"KI",name:Object(n.d)("Kiribati"),prefix:"686"},{iso2:"XK",name:Object(n.d)("Kosovo"),prefix:"383"},{iso2:"KW",name:Object(n.d)("Kuwait"),prefix:"965"},{iso2:"KG",name:Object(n.d)("Kyrgyzstan"),prefix:"996"},{iso2:"LA",name:Object(n.d)("Laos"),prefix:"856"},{iso2:"LV",name:Object(n.d)("Latvia"),prefix:"371"},{iso2:"LB",name:Object(n.d)("Lebanon"),prefix:"961"},{iso2:"LS",name:Object(n.d)("Lesotho"),prefix:"266"},{iso2:"LR",name:Object(n.d)("Liberia"),prefix:"231"},{iso2:"LY",name:Object(n.d)("Libya"),prefix:"218"},{iso2:"LI",name:Object(n.d)("Liechtenstein"),prefix:"423"},{iso2:"LT",name:Object(n.d)("Lithuania"),prefix:"370"},{iso2:"LU",name:Object(n.d)("Luxembourg"),prefix:"352"},{iso2:"MO",name:Object(n.d)("Macau"),prefix:"853"},{iso2:"MK",name:Object(n.d)("Macedonia"),prefix:"389"},{iso2:"MG",name:Object(n.d)("Madagascar"),prefix:"261"},{iso2:"MW",name:Object(n.d)("Malawi"),prefix:"265"},{iso2:"MY",name:Object(n.d)("Malaysia"),prefix:"60"},{iso2:"MV",name:Object(n.d)("Maldives"),prefix:"960"},{iso2:"ML",name:Object(n.d)("Mali"),prefix:"223"},{iso2:"MT",name:Object(n.d)("Malta"),prefix:"356"},{iso2:"MH",name:Object(n.d)("Marshall Islands"),prefix:"692"},{iso2:"MQ",name:Object(n.d)("Martinique"),prefix:"596"},{iso2:"MR",name:Object(n.d)("Mauritania"),prefix:"222"},{iso2:"MU",name:Object(n.d)("Mauritius"),prefix:"230"},{iso2:"YT",name:Object(n.d)("Mayotte"),prefix:"262"},{iso2:"MX",name:Object(n.d)("Mexico"),prefix:"52"},{iso2:"FM",name:Object(n.d)("Micronesia"),prefix:"691"},{iso2:"MD",name:Object(n.d)("Moldova"),prefix:"373"},{iso2:"MC",name:Object(n.d)("Monaco"),prefix:"377"},{iso2:"MN",name:Object(n.d)("Mongolia"),prefix:"976"},{iso2:"ME",name:Object(n.d)("Montenegro"),prefix:"382"},{iso2:"MS",name:Object(n.d)("Montserrat"),prefix:"1"},{iso2:"MA",name:Object(n.d)("Morocco"),prefix:"212"},{iso2:"MZ",name:Object(n.d)("Mozambique"),prefix:"258"},{iso2:"MM",name:Object(n.d)("Myanmar"),prefix:"95"},{iso2:"NA",name:Object(n.d)("Namibia"),prefix:"264"},{iso2:"NR",name:Object(n.d)("Nauru"),prefix:"674"},{iso2:"NP",name:Object(n.d)("Nepal"),prefix:"977"},{iso2:"NL",name:Object(n.d)("Netherlands"),prefix:"31"},{iso2:"NC",name:Object(n.d)("New Caledonia"),prefix:"687"},{iso2:"NZ",name:Object(n.d)("New Zealand"),prefix:"64"},{iso2:"NI",name:Object(n.d)("Nicaragua"),prefix:"505"},{iso2:"NE",name:Object(n.d)("Niger"),prefix:"227"},{iso2:"NG",name:Object(n.d)("Nigeria"),prefix:"234"},{iso2:"NU",name:Object(n.d)("Niue"),prefix:"683"},{iso2:"NF",name:Object(n.d)("Norfolk Island"),prefix:"672"},{iso2:"KP",name:Object(n.d)("North Korea"),prefix:"850"},{iso2:"MP",name:Object(n.d)("Northern Mariana Islands"),prefix:"1"},{iso2:"NO",name:Object(n.d)("Norway"),prefix:"47"},{iso2:"OM",name:Object(n.d)("Oman"),prefix:"968"},{iso2:"PK",name:Object(n.d)("Pakistan"),prefix:"92"},{iso2:"PW",name:Object(n.d)("Palau"),prefix:"680"},{iso2:"PS",name:Object(n.d)("Palestine"),prefix:"970"},{iso2:"PA",name:Object(n.d)("Panama"),prefix:"507"},{iso2:"PG",name:Object(n.d)("Papua New Guinea"),prefix:"675"},{iso2:"PY",name:Object(n.d)("Paraguay"),prefix:"595"},{iso2:"PE",name:Object(n.d)("Peru"),prefix:"51"},{iso2:"PH",name:Object(n.d)("Philippines"),prefix:"63"},{iso2:"PN",name:Object(n.d)("Pitcairn Islands"),prefix:"870"},{iso2:"PL",name:Object(n.d)("Poland"),prefix:"48"},{iso2:"PT",name:Object(n.d)("Portugal"),prefix:"351"},{iso2:"PR",name:Object(n.d)("Puerto Rico"),prefix:"1"},{iso2:"QA",name:Object(n.d)("Qatar"),prefix:"974"},{iso2:"RO",name:Object(n.d)("Romania"),prefix:"40"},{iso2:"RU",name:Object(n.d)("Russia"),prefix:"7"},{iso2:"RW",name:Object(n.d)("Rwanda"),prefix:"250"},{iso2:"RE",name:Object(n.d)("Réunion"),prefix:"262"},{iso2:"WS",name:Object(n.d)("Samoa"),prefix:"685"},{iso2:"SM",name:Object(n.d)("San Marino"),prefix:"378"},{iso2:"SA",name:Object(n.d)("Saudi Arabia"),prefix:"966"},{iso2:"SN",name:Object(n.d)("Senegal"),prefix:"221"},{iso2:"RS",name:Object(n.d)("Serbia"),prefix:"381 p"},{iso2:"SC",name:Object(n.d)("Seychelles"),prefix:"248"},{iso2:"SL",name:Object(n.d)("Sierra Leone"),prefix:"232"},{iso2:"SG",name:Object(n.d)("Singapore"),prefix:"65"},{iso2:"SX",name:Object(n.d)("Sint Maarten"),prefix:"1"},{iso2:"SK",name:Object(n.d)("Slovakia"),prefix:"421"},{iso2:"SI",name:Object(n.d)("Slovenia"),prefix:"386"},{iso2:"SB",name:Object(n.d)("Solomon Islands"),prefix:"677"},{iso2:"SO",name:Object(n.d)("Somalia"),prefix:"252"},{iso2:"ZA",name:Object(n.d)("South Africa"),prefix:"27"},{iso2:"GS",name:Object(n.d)("South Georgia & South Sandwich Islands"),prefix:"500"},{iso2:"KR",name:Object(n.d)("South Korea"),prefix:"82"},{iso2:"SS",name:Object(n.d)("South Sudan"),prefix:"211"},{iso2:"ES",name:Object(n.d)("Spain"),prefix:"34"},{iso2:"LK",name:Object(n.d)("Sri Lanka"),prefix:"94"},{iso2:"BL",name:Object(n.d)("St. Barthélemy"),prefix:"590"},{iso2:"SH",name:Object(n.d)("St. Helena"),prefix:"290 n"},{iso2:"KN",name:Object(n.d)("St. Kitts & Nevis"),prefix:"1"},{iso2:"LC",name:Object(n.d)("St. Lucia"),prefix:"1"},{iso2:"MF",name:Object(n.d)("St. Martin"),prefix:"590"},{iso2:"PM",name:Object(n.d)("St. Pierre & Miquelon"),prefix:"508"},{iso2:"VC",name:Object(n.d)("St. Vincent & Grenadines"),prefix:"1"},{iso2:"SD",name:Object(n.d)("Sudan"),prefix:"249"},{iso2:"SR",name:Object(n.d)("Suriname"),prefix:"597"},{iso2:"SJ",name:Object(n.d)("Svalbard & Jan Mayen"),prefix:"47"},{iso2:"SZ",name:Object(n.d)("Swaziland"),prefix:"268"},{iso2:"SE",name:Object(n.d)("Sweden"),prefix:"46"},{iso2:"CH",name:Object(n.d)("Switzerland"),prefix:"41"},{iso2:"SY",name:Object(n.d)("Syria"),prefix:"963"},{iso2:"ST",name:Object(n.d)("São Tomé & Príncipe"),prefix:"239"},{iso2:"TW",name:Object(n.d)("Taiwan"),prefix:"886"},{iso2:"TJ",name:Object(n.d)("Tajikistan"),prefix:"992"},{iso2:"TZ",name:Object(n.d)("Tanzania"),prefix:"255"},{iso2:"TH",name:Object(n.d)("Thailand"),prefix:"66"},{iso2:"TL",name:Object(n.d)("Timor-Leste"),prefix:"670"},{iso2:"TG",name:Object(n.d)("Togo"),prefix:"228"},{iso2:"TK",name:Object(n.d)("Tokelau"),prefix:"690"},{iso2:"TO",name:Object(n.d)("Tonga"),prefix:"676"},{iso2:"TT",name:Object(n.d)("Trinidad & Tobago"),prefix:"1"},{iso2:"TN",name:Object(n.d)("Tunisia"),prefix:"216"},{iso2:"TR",name:Object(n.d)("Turkey"),prefix:"90"},{iso2:"TM",name:Object(n.d)("Turkmenistan"),prefix:"993"},{iso2:"TC",name:Object(n.d)("Turks & Caicos Islands"),prefix:"1"},{iso2:"TV",name:Object(n.d)("Tuvalu"),prefix:"688"},{iso2:"VI",name:Object(n.d)("U.S. Virgin Islands"),prefix:"1"},{iso2:"UG",name:Object(n.d)("Uganda"),prefix:"256"},{iso2:"UA",name:Object(n.d)("Ukraine"),prefix:"380"},{iso2:"AE",name:Object(n.d)("United Arab Emirates"),prefix:"971"},{iso2:"UY",name:Object(n.d)("Uruguay"),prefix:"598"},{iso2:"UZ",name:Object(n.d)("Uzbekistan"),prefix:"998"},{iso2:"VU",name:Object(n.d)("Vanuatu"),prefix:"678"},{iso2:"VA",name:Object(n.d)("Vatican City"),prefix:"39"},{iso2:"VE",name:Object(n.d)("Venezuela"),prefix:"58"},{iso2:"VN",name:Object(n.d)("Vietnam"),prefix:"84"},{iso2:"WF",name:Object(n.d)("Wallis & Futuna"),prefix:"681"},{iso2:"EH",name:Object(n.d)("Western Sahara"),prefix:"212"},{iso2:"YE",name:Object(n.d)("Yemen"),prefix:"967"},{iso2:"ZM",name:Object(n.d)("Zambia"),prefix:"260"},{iso2:"ZW",name:Object(n.d)("Zimbabwe"),prefix:"263"}]},989:function(e,t,a){"use strict";var n=a(122),i=a.n(n),s=a(120),o=a.n(s),r=a(141),l=a(204),c=a(121);class d extends s.PureComponent{constructor(){super(...arguments),i()(this,"validate",Object(l.a)({rules:[{key:"required",test:e=>{let{value:t,allowEmpty:a}=e;return a||!!t},invalid:()=>Object(c.b)(this.props.labelRequired)},{key:"match",test:e=>{let{value:t}=e;return!t||t===this.props.password},invalid:()=>Object(c.b)(this.props.labelInvalid)}]})),i()(this,"onValidate",(async e=>{const t=await this.validate(e);return this.props.onValidate&&this.props.onValidate(t),t}))}render(){return o.a.createElement(r.a,{id:this.props.id,ref:this.props.fieldRef,type:"password",label:Object(c.b)(this.props.label),autoComplete:this.props.autoComplete,value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate})}}i()(d,"defaultProps",{label:Object(c.d)("Confirm password"),labelRequired:Object(c.d)("Confirm password"),labelInvalid:Object(c.d)("Passwords don't match")}),t.a=d},990:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return m}));var n=a(13),i=a.n(n),s=a(10),o=a(1),r=a(16),l=a(510),c=a(190);const d=new s.UnstableValue("http.v1","org.matrix.msc3886.http.v1");class m{constructor(e){let{onFailure:t,client:a,fallbackRzServer:n,fetchFn:s}=e;i()(this,"uri",void 0),i()(this,"etag",void 0),i()(this,"expiresAt",void 0),i()(this,"client",void 0),i()(this,"fallbackRzServer",void 0),i()(this,"fetchFn",void 0),i()(this,"cancelled",!1),i()(this,"_ready",!1),i()(this,"onFailure",void 0),this.fetchFn=s,this.onFailure=t,this.client=a,this.fallbackRzServer=n}get ready(){return this._ready}async details(){if(!this.uri)throw new Error("Rendezvous not set up");return{type:d.name,uri:this.uri}}fetch(t,a){return this.fetchFn?this.fetchFn(t,a):e.fetch(t,a)}async getPostEndpoint(){try{if(await this.client.doesServerSupportUnstableFeature("org.matrix.msc3886"))return`${this.client.baseUrl}${c.a.Unstable}/org.matrix.msc3886/rendezvous`}catch(e){o.a.warn("Failed to get unstable features",e)}return this.fallbackRzServer}async send(e){var t,a;if(this.cancelled)return;const n=this.uri?"PUT":"POST",i=null!==(t=this.uri)&&void 0!==t?t:await this.getPostEndpoint();if(!i)throw new Error("Invalid rendezvous URI");const s={"content-type":"application/json"};this.etag&&(s["if-match"]=this.etag);const o=await this.fetch(i,{method:n,headers:s,body:JSON.stringify(e)});if(404===o.status)return this.cancel(l.c.Unknown);if(this.etag=null!==(a=o.headers.get("etag"))&&void 0!==a?a:void 0,"POST"===n){var r;const e=o.headers.get("location");if(!e)throw new Error("No rendezvous URI given");const t=o.headers.get("expires");t&&(this.expiresAt=new Date(t));const a=null!==(r=o.url)&&void 0!==r?r:i;this.uri=new URL(e,`${a}${a.endsWith("/")?"":"/"}`).href,this._ready=!0}}async receive(){if(!this.uri)throw new Error("Rendezvous not set up");for(;;){if(this.cancelled)return;const a={};this.etag&&(a["if-none-match"]=this.etag);const n=await this.fetch(this.uri,{method:"GET",headers:a});if(404===n.status)return void this.cancel(l.c.Unknown);var e;if("application/json"!==n.headers.get("content-type"))this.etag=null!==(e=n.headers.get("etag"))&&void 0!==e?e:void 0;else if(200===n.status){var t;return this.etag=null!==(t=n.headers.get("etag"))&&void 0!==t?t:void 0,n.json()}await Object(r.N)(1e3)}}async cancel(e){var t;if(e===l.c.Unknown&&this.expiresAt&&this.expiresAt.getTime()<Date.now()&&(e=l.c.Expired),this.cancelled=!0,this._ready=!1,null===(t=this.onFailure)||void 0===t||t.call(this,e),this.uri&&e===l.c.UserDeclined)try{await this.fetch(this.uri,{method:"DELETE"})}catch(e){o.a.warn(e)}}}}).call(this,a(14))},991:function(e,t,a){"use strict";(function(e){a.d(t,"a",(function(){return d}));var n=a(13),i=a.n(n),s=a(510),o=a(200),r=a(436),l=a(714);const c=new(a(15).c)("m.rendezvous.v2.curve25519-aes-sha256","org.matrix.msc3903.rendezvous.v2.curve25519-aes-sha256");class d{constructor(t,a,n){this.transport=t,this.theirPublicKey=a,this.onFailure=n,i()(this,"olmSAS",void 0),i()(this,"ourPublicKey",void 0),i()(this,"aesKey",void 0),i()(this,"connected",!1),this.olmSAS=new e.Olm.SAS,this.ourPublicKey=Object(o.decodeBase64)(this.olmSAS.get_pubkey())}async generateCode(e){if(this.transport.ready)throw new Error("Code already generated");await this.transport.send({algorithm:c.name});return{rendezvous:{algorithm:c.name,key:Object(o.encodeUnpaddedBase64)(this.ourPublicKey),transport:await this.transport.details()},intent:e}}async connect(){if(this.connected)throw new Error("Channel already connected");if(!this.olmSAS)throw new Error("Channel closed");const e=!this.theirPublicKey;if(e){const e=await this.transport.receive();if(!e)throw new Error("No response from other device");const t=e,{key:a,algorithm:n}=t;if(!n||!c.matches(n)||!a)throw new s.b("Unsupported algorithm: "+n,s.c.UnsupportedAlgorithm);this.theirPublicKey=Object(o.decodeBase64)(a)}else await this.transport.send({algorithm:c.name,key:Object(o.encodeUnpaddedBase64)(this.ourPublicKey)});this.connected=!0,this.olmSAS.set_their_key(Object(o.encodeUnpaddedBase64)(this.theirPublicKey));const t=e?this.ourPublicKey:this.theirPublicKey,a=e?this.theirPublicKey:this.ourPublicKey;let n=c.name;n+=`|${Object(o.encodeUnpaddedBase64)(t)}`,n+=`|${Object(o.encodeUnpaddedBase64)(a)}`;const i=this.olmSAS.generate_bytes(n,32);this.aesKey=await async function(e){if(!r.c)throw new Error("Web Crypto is not available");return r.c.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"])}(i),i.fill(0);const d=this.olmSAS.generate_bytes(n,5);return Object(l.a)(Array.from(d)).join("-")}async encrypt(e){if(!r.c)throw new Error("Web Crypto is not available");const t=new Uint8Array(32);r.b.getRandomValues(t);const a=(new r.a).encode(JSON.stringify(e)),n=await r.c.encrypt({name:"AES-GCM",iv:t,tagLength:128},this.aesKey,a);return{iv:Object(o.encodeUnpaddedBase64)(t),ciphertext:Object(o.encodeUnpaddedBase64)(n)}}async send(e){if(!this.olmSAS)throw new Error("Channel closed");if(!this.aesKey)throw new Error("Shared secret not set up");return this.transport.send(await this.encrypt(e))}async decrypt(e){let{iv:t,ciphertext:a}=e;if(!a||!t)throw new Error("Missing ciphertext and/or iv");const n=Object(o.decodeBase64)(a);if(!r.c)throw new Error("Web Crypto is not available");const i=await r.c.decrypt({name:"AES-GCM",iv:Object(o.decodeBase64)(t),tagLength:128},this.aesKey,n);return JSON.parse((new TextDecoder).decode(new Uint8Array(i)))}async receive(){if(!this.olmSAS)throw new Error("Channel closed");if(!this.aesKey)throw new Error("Shared secret not set up");const e=await this.transport.receive();if(!e)return;const t=e;if(t.ciphertext&&t.iv)return this.decrypt(t);throw new Error("Data received but no ciphertext")}async close(){this.olmSAS&&(this.olmSAS.free(),this.olmSAS=void 0)}async cancel(e){try{await this.transport.cancel(e)}finally{await this.close()}}}}).call(this,a(14))},992:function(e,t,a){"use strict";a.d(t,"a",(function(){return s}));var n=a(120),i=a.n(n);class s extends i.a.PureComponent{render(){return i.a.createElement("div",{className:"mx_CompleteSecurityBody"},this.props.children)}}},993:function(e,t,a){"use strict";a.d(t,"a",(function(){return h}));var n=a(120),i=a.n(n),s=a(132),o=a(121),r=a(126),l=a(158),c=a(138),d=a(987);function m(e){var t;Object(o.f)()!==e&&(r.b.setValue("language",null,c.a.DEVICE,e),null===(t=l.a.get())||void 0===t||t.reload())}function h(e){let{disabled:t}=e;return s.b.get("disable_login_language_selector")?i.a.createElement("div",null):i.a.createElement(d.a,{className:"mx_AuthBody_language",onOptionChange:m,value:Object(o.f)(),disabled:t})}}}]);
//# sourceMappingURL=element-web-app.js.map